<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Fixed Issues</title>
    <link rel="stylesheet" href="src/content/content.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        textarea {
            width: 100%;
            height: 150px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Fixed Issues</h1>
    
    <div class="container">
        <h2>Test Scenarios</h2>
        <button onclick="testNoBackupConfirm()">Test No Backup Confirm</button>
        <button onclick="testAutoClose()">Test Auto Close</button>
        <button onclick="testPasteMermaid()">Test Paste New Mermaid</button>
        <button onclick="testSelectorDuplicates()">Test Selector Duplicates</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div class="container">
        <h2>Paste New Mermaid Here</h2>
        <textarea id="new-mermaid" placeholder="Paste your new Mermaid diagram here...">
graph TD
    X[New Start] --> Y[New Process]
    Y --> Z[New End]
        </textarea>
        <button onclick="addMermaidToEditor()">Add to Editor</button>
    </div>

    <div class="container">
        <h2>Test Results</h2>
        <div id="results"></div>
    </div>

    <script type="module">
        import { ConfluenceEditor } from './src/content/confluenceEditor.js';

        // Global editor instance
        window.editor = new ConfluenceEditor();

        // Test content
        const testContent = {
            id: 'test-fixed-issues',
            title: 'Test Fixed Issues',
            full_storage_format: `<h1>Test Content</h1>
<p>This content has 2 Mermaid diagrams initially.</p>

<h2>Diagram 1</h2>
<ac:structured-macro ac:name="mermaid">
    <ac:parameter ac:name="code">
        <![CDATA[
        flowchart TD
            A[Start] --> B[Process]
            B --> C[End]
        ]]>
    </ac:parameter>
</ac:structured-macro>

<h2>Diagram 2</h2>
<ac:structured-macro ac:name="mermaid">
    <ac:parameter ac:name="code">
        <![CDATA[
        erDiagram
            USER {
                int id PK
                string name
            }
        ]]>
    </ac:parameter>
</ac:structured-macro>

<p>End of content.</p>`
        };

        // Save callback
        const saveCallback = (content) => {
            console.log('üíæ Save callback called:', content);
            showResult('‚úÖ Save callback executed', 'success');
            return Promise.resolve(content);
        };

        // Test no backup confirm
        window.testNoBackupConfirm = function() {
            try {
                console.log('üß™ Testing no backup confirm...');
                
                // Create fake backup in localStorage
                const fakeBackup = {
                    content: { ...testContent },
                    timestamp: Date.now() - (10 * 60 * 1000) // 10 minutes ago
                };
                localStorage.setItem('confluence-editor-backup', JSON.stringify(fakeBackup));
                
                // Open editor - should auto-restore without confirm
                window.editor.setSaveCallback(saveCallback);
                window.editor.openEditor(testContent);
                
                showResult('‚úÖ Editor opened - check console for backup behavior', 'success');
                showResult('üìã Should see "Auto-restored content from backup" message', 'info');
                
            } catch (error) {
                console.error('‚ùå Error testing backup:', error);
                showResult(`‚ùå Error testing backup: ${error.message}`, 'error');
            }
        };

        // Test auto close
        window.testAutoClose = function() {
            if (!window.editor.isEditorOpen) {
                showResult('‚ùå Please open editor first!', 'error');
                return;
            }

            try {
                console.log('üß™ Testing auto close...');
                
                // Trigger save
                window.editor.saveChanges().then(() => {
                    showResult('‚úÖ Save completed - editor should auto-close in 1 second', 'success');
                    
                    // Check if editor closes
                    setTimeout(() => {
                        if (!window.editor.isEditorOpen) {
                            showResult('‚úÖ Editor auto-closed successfully', 'success');
                        } else {
                            showResult('‚ùå Editor did not auto-close', 'error');
                        }
                    }, 1500);
                    
                }).catch(error => {
                    showResult(`‚ùå Save failed: ${error.message}`, 'error');
                });
                
            } catch (error) {
                console.error('‚ùå Error testing auto close:', error);
                showResult(`‚ùå Error testing auto close: ${error.message}`, 'error');
            }
        };

        // Test paste new Mermaid
        window.testPasteMermaid = function() {
            if (!window.editor.isEditorOpen) {
                showResult('‚ùå Please open editor first!', 'error');
                return;
            }

            try {
                console.log('üß™ Testing paste new Mermaid...');
                
                // Get current content from raw editor
                const rawEditor = document.querySelector('#raw-content-editor');
                if (!rawEditor) {
                    showResult('‚ùå Raw editor not found', 'error');
                    return;
                }

                const newMermaid = document.getElementById('new-mermaid').value;
                if (!newMermaid.trim()) {
                    showResult('‚ùå Please enter new Mermaid code', 'error');
                    return;
                }

                // Add new Mermaid to content
                const newMermaidBlock = `
<h2>New Diagram</h2>
<ac:structured-macro ac:name="mermaid">
    <ac:parameter ac:name="code">
        <![CDATA[
        ${newMermaid.trim()}
        ]]>
    </ac:parameter>
</ac:structured-macro>
`;

                rawEditor.value = rawEditor.value + newMermaidBlock;
                rawEditor.dispatchEvent(new Event('input', { bubbles: true }));
                
                showResult('‚úÖ New Mermaid added to raw editor', 'success');
                showResult('üìã Now save to test if it syncs correctly', 'info');
                
            } catch (error) {
                console.error('‚ùå Error testing paste Mermaid:', error);
                showResult(`‚ùå Error testing paste Mermaid: ${error.message}`, 'error');
            }
        };

        // Add Mermaid to editor
        window.addMermaidToEditor = function() {
            window.testPasteMermaid();
        };

        // Test selector duplicates
        window.testSelectorDuplicates = function() {
            if (!window.editor.isEditorOpen) {
                showResult('‚ùå Please open editor first!', 'error');
                return;
            }

            try {
                console.log('üß™ Testing selector duplicates...');
                
                // Switch to Mermaid tab
                const mermaidTab = document.querySelector('#mermaid-tab');
                if (mermaidTab) {
                    mermaidTab.click();
                    
                    setTimeout(() => {
                        const selector = document.querySelector('#mermaid-selector');
                        if (selector) {
                            const beforeCount = selector.options.length - 1;
                            showResult(`üìä Before save: ${beforeCount} diagram options`, 'info');
                            
                            // Trigger save
                            window.editor.saveChanges().then(() => {
                                setTimeout(() => {
                                    const afterCount = selector.options.length - 1;
                                    showResult(`üìä After save: ${afterCount} diagram options`, 'info');
                                    
                                    if (beforeCount === afterCount) {
                                        showResult('‚úÖ No duplicate options created', 'success');
                                    } else {
                                        showResult(`‚ùå Options count changed: ${beforeCount} ‚Üí ${afterCount}`, 'error');
                                    }
                                    
                                    // List all options
                                    for (let i = 1; i < selector.options.length; i++) {
                                        showResult(`  ${i}. ${selector.options[i].textContent}`, 'info');
                                    }
                                }, 500);
                            });
                        }
                    }, 500);
                }
                
            } catch (error) {
                console.error('‚ùå Error testing selector duplicates:', error);
                showResult(`‚ùå Error testing selector duplicates: ${error.message}`, 'error');
            }
        };

        // Clear results
        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
        };

        // Show result
        function showResult(message, type) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
            
            console.log(message);
        }

        // Auto-run on page load
        window.addEventListener('load', () => {
            console.log('üöÄ Fixed issues test page loaded');
            showResult('üìã Page loaded - ready for testing', 'info');
            showResult('üîç Test scenarios:', 'info');
            showResult('1. Test No Backup Confirm - should auto-restore without popup', 'info');
            showResult('2. Test Auto Close - should close editor after save', 'info');
            showResult('3. Test Paste New Mermaid - add new diagram and save', 'info');
            showResult('4. Test Selector Duplicates - check for duplicate options', 'info');
        });
    </script>
</body>
</html>
