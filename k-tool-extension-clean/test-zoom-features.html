<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Zoom Features - Confluence Editor</title>
    <link rel="stylesheet" href="src/content/content.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-btn:hover {
            background: #0056b3;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background: #e9ecef;
        }
    </style>
</head>
<body>
    <h1>🧪 Test Zoom Features - Confluence Editor</h1>
    
    <div class="test-container">
        <h2>📊 Test Cases</h2>
        <button class="test-btn" onclick="testBasicEditor()">Test 1: Basic Editor</button>
        <button class="test-btn" onclick="testMermaidWithZoom()">Test 2: Mermaid với Zoom</button>
        <button class="test-btn" onclick="testSaveChanges()">Test 3: Save Changes Logic</button>
        <div class="status" id="status">Sẵn sàng để test...</div>
    </div>

    <div class="test-container">
        <h2>🎯 Expected Features</h2>
        <ul>
            <li>✅ Zoom controls trong Diagram Preview (+ - ⌂ và %)</li>
            <li>✅ Button "Lưu thay đổi" hiển thị * khi có thay đổi</li>
            <li>✅ Wheel zoom trong mermaid preview</li>
            <li>✅ Logic lưu thay đổi hoạt động đúng</li>
        </ul>
    </div>

    <!-- Sample content for testing -->
    <script>
        // Sample content with Mermaid diagrams
        const sampleContent = {
            full_storage_format: `<h1>Test Document</h1>
<p>This is a test document with Mermaid diagrams.</p>

<ac:structured-macro ac:name="mermaid">
  <ac:parameter ac:name="code">
graph TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Action 1]
    B -->|No| D[Action 2]
    C --> E[End]
    D --> E
  </ac:parameter>
</ac:structured-macro>

<p>Another paragraph with content.</p>

<ac:structured-macro ac:name="mermaid">
  <ac:parameter ac:name="code">
sequenceDiagram
    participant A as User
    participant B as System
    A->>B: Request
    B-->>A: Response
  </ac:parameter>
</ac:structured-macro>`,
            content: "Test content"
        };

        // Mock ConfluenceEditor for testing
        class MockConfluenceEditor {
            constructor() {
                this.isEditorOpen = false;
                this.currentContent = null;
                this.originalContent = null;
                this.mermaidDiagrams = [];
                this.editorContainer = null;
                this.isModified = false;
                this.currentZoom = 1;
                this.dragOffset = { x: 0, y: 0 };
                this.onSave = null;
            }

            openEditor(content, options = {}) {
                console.log("📝 Opening editor with content:", content);
                this.currentContent = content;
                this.originalContent = JSON.parse(JSON.stringify(content));
                this.isEditorOpen = true;
                
                // Create mock UI
                this.createMockUI();
                updateStatus("Editor opened successfully!");
            }

            createMockUI() {
                // Remove existing editor if any
                const existing = document.querySelector('.confluence-editor-overlay');
                if (existing) existing.remove();

                // Create mock editor UI
                const overlay = document.createElement('div');
                overlay.className = 'confluence-editor-overlay';
                overlay.innerHTML = `
                    <div class="confluence-editor-container">
                        <div class="confluence-editor-header">
                            <h2 class="confluence-editor-title">📝 Chỉnh sửa nội dung Confluence</h2>
                            <div class="confluence-editor-actions">
                                <button class="editor-btn editor-btn-primary" id="editor-save-btn">💾 Lưu thay đổi</button>
                                <button class="editor-btn editor-btn-secondary" id="editor-close-btn">✕ Đóng</button>
                            </div>
                        </div>
                        <div class="confluence-editor-tabs">
                            <button class="confluence-editor-tab active" id="content-tab">📝 Chỉnh sửa nội dung</button>
                            <button class="confluence-editor-tab" id="mermaid-tab">📊 Chỉnh sửa Mermaid</button>
                        </div>
                        <div class="confluence-editor-body">
                            <div class="tab-content active" id="content-tab-content">
                                <div class="content-editor-layout">
                                    <div class="content-editor-pane">
                                        <div class="content-editor-header">📝 Raw XHTML Content</div>
                                        <div class="content-editor-body">
                                            <textarea class="raw-content-editor" id="raw-content-editor">${this.currentContent.full_storage_format}</textarea>
                                        </div>
                                    </div>
                                    <div class="content-preview-pane">
                                        <div class="content-editor-header">👁️ Live Preview</div>
                                        <div class="content-editor-body">
                                            <div class="content-preview" id="content-preview">Preview will appear here...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-content" id="mermaid-tab-content">
                                <div class="mermaid-editor-layout">
                                    <div class="mermaid-code-pane">
                                        <div class="mermaid-editor-header">📊 Mermaid Code</div>
                                        <div class="mermaid-editor-body">
                                            <textarea class="mermaid-code-editor" id="mermaid-code-editor">graph TD\nA --> B</textarea>
                                        </div>
                                    </div>
                                    <div class="mermaid-preview-pane">
                                        <div class="mermaid-editor-header">
                                            📊 Diagram Preview
                                            <div class="mermaid-zoom-controls">
                                                <button class="zoom-btn" id="zoom-out" title="Zoom Out">−</button>
                                                <div class="zoom-level" id="zoom-level">100%</div>
                                                <button class="zoom-btn" id="zoom-in" title="Zoom In">+</button>
                                                <button class="zoom-btn" id="zoom-reset" title="Reset Zoom">⌂</button>
                                            </div>
                                        </div>
                                        <div class="mermaid-editor-body">
                                            <div class="mermaid-preview" id="mermaid-preview">
                                                <div style="transform: scale(1); transition: transform 0.2s ease;">
                                                    📊 Mermaid diagram will appear here
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mermaid-ai-pane">
                                        <div class="mermaid-editor-header">🤖 AI Assistant</div>
                                        <div class="mermaid-editor-body">AI chat here...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(overlay);
                this.editorContainer = overlay;
                this.bindMockEvents();
            }

            bindMockEvents() {
                // Close button
                this.editorContainer.querySelector('#editor-close-btn').addEventListener('click', () => {
                    this.closeEditor();
                });

                // Save button
                this.editorContainer.querySelector('#editor-save-btn').addEventListener('click', () => {
                    this.saveChanges();
                });

                // Tab switching
                this.editorContainer.querySelector('#content-tab').addEventListener('click', () => {
                    this.switchTab('content');
                });
                this.editorContainer.querySelector('#mermaid-tab').addEventListener('click', () => {
                    this.switchTab('mermaid');
                });

                // Content changes
                this.editorContainer.querySelector('#raw-content-editor').addEventListener('input', (e) => {
                    this.isModified = true;
                    this.updateSaveButtonState();
                    updateStatus("Content modified!");
                });

                // Zoom controls
                this.editorContainer.querySelector('#zoom-in').addEventListener('click', () => {
                    this.zoomIn();
                });
                this.editorContainer.querySelector('#zoom-out').addEventListener('click', () => {
                    this.zoomOut();
                });
                this.editorContainer.querySelector('#zoom-reset').addEventListener('click', () => {
                    this.resetZoom();
                });

                // Wheel zoom
                this.editorContainer.querySelector('#mermaid-preview').addEventListener('wheel', (e) => {
                    e.preventDefault();
                    if (e.deltaY < 0) {
                        this.zoomIn();
                    } else {
                        this.zoomOut();
                    }
                });
            }

            switchTab(tabName) {
                // Update tabs
                this.editorContainer.querySelectorAll('.confluence-editor-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                this.editorContainer.querySelector(`#${tabName}-tab`).classList.add('active');

                // Update content
                this.editorContainer.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                this.editorContainer.querySelector(`#${tabName}-tab-content`).classList.add('active');

                updateStatus(`Switched to ${tabName} tab`);
            }

            zoomIn() {
                this.currentZoom = Math.min(this.currentZoom * 1.2, 3);
                this.updateZoom();
            }

            zoomOut() {
                this.currentZoom = Math.max(this.currentZoom / 1.2, 0.3);
                this.updateZoom();
            }

            resetZoom() {
                this.currentZoom = 1;
                this.updateZoom();
            }

            updateZoom() {
                const preview = this.editorContainer.querySelector('#mermaid-preview > div');
                const zoomLevel = this.editorContainer.querySelector('#zoom-level');
                
                if (preview) {
                    preview.style.transform = `scale(${this.currentZoom})`;
                }
                if (zoomLevel) {
                    zoomLevel.textContent = `${Math.round(this.currentZoom * 100)}%`;
                }
                
                updateStatus(`Zoom: ${Math.round(this.currentZoom * 100)}%`);
            }

            updateSaveButtonState() {
                const saveBtn = this.editorContainer.querySelector('#editor-save-btn');
                if (this.isModified) {
                    saveBtn.innerHTML = '💾 Lưu thay đổi *';
                    saveBtn.style.background = '#28a745';
                } else {
                    saveBtn.innerHTML = '💾 Lưu thay đổi';
                    saveBtn.style.background = '#007bff';
                }
            }

            saveChanges() {
                if (this.onSave) {
                    this.onSave(this.currentContent);
                }
                this.isModified = false;
                this.updateSaveButtonState();
                updateStatus("Changes saved successfully!");
            }

            closeEditor() {
                if (this.editorContainer) {
                    this.editorContainer.remove();
                    this.editorContainer = null;
                }
                this.isEditorOpen = false;
                updateStatus("Editor closed");
            }

            setSaveCallback(callback) {
                this.onSave = callback;
            }
        }

        // Global editor instance
        let editor = new MockConfluenceEditor();

        // Test functions
        function testBasicEditor() {
            updateStatus("Testing basic editor...");
            editor.setSaveCallback((content) => {
                console.log("Save callback called:", content);
                updateStatus("Save callback executed!");
            });
            editor.openEditor(sampleContent);
        }

        function testMermaidWithZoom() {
            updateStatus("Testing Mermaid with zoom...");
            editor.setSaveCallback((content) => {
                console.log("Mermaid save callback:", content);
            });
            editor.openEditor(sampleContent);
            // Switch to mermaid tab after opening
            setTimeout(() => {
                if (editor.editorContainer) {
                    editor.switchTab('mermaid');
                    updateStatus("Switched to Mermaid tab - try zoom controls!");
                }
            }, 500);
        }

        function testSaveChanges() {
            updateStatus("Testing save changes logic...");
            let saveCount = 0;
            editor.setSaveCallback((content) => {
                saveCount++;
                updateStatus(`Save callback called ${saveCount} times`);
            });
            editor.openEditor(sampleContent);
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log("Status:", message);
        }
    </script>
</body>
</html>
