<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final Fixes</title>
    <link rel="stylesheet" href="src/content/content.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        textarea {
            width: 100%;
            height: 100px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>🧪 Test Final Fixes</h1>
    
    <div class="container">
        <h2>Test All Fixed Issues</h2>
        <button onclick="testAutoClose()">1. Test Auto Close</button>
        <button onclick="testNoDuplicates()">2. Test No Duplicates</button>
        <button onclick="testContentSync()">3. Test Content Sync</button>
        <button onclick="testNoConfirms()">4. Test No Confirms</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div class="container">
        <h2>Edit Content Here</h2>
        <textarea id="test-content" placeholder="Edit content here and test sync...">
<h1>Test Content</h1>
<p>Original content with diagram:</p>

<ac:structured-macro ac:name="mermaid">
    <ac:parameter ac:name="code">
        <![CDATA[
        flowchart TD
            A[Start] --> B[Process]
            B --> C[End]
        ]]>
    </ac:parameter>
</ac:structured-macro>

<p>Add your changes here...</p>
        </textarea>
        <button onclick="applyContentChanges()">Apply Changes to Editor</button>
    </div>

    <div class="container">
        <h2>Test Results</h2>
        <div id="results"></div>
    </div>

    <script type="module">
        import { ConfluenceEditor } from './src/content/confluenceEditor.js';

        // Global editor instance
        window.editor = new ConfluenceEditor();

        // Test content
        const testContent = {
            id: 'test-final-fixes',
            title: 'Test Final Fixes',
            full_storage_format: document.getElementById('test-content').value
        };

        // Save callback
        const saveCallback = (content) => {
            console.log('💾 Save callback called:', content);
            showResult('✅ Save callback executed', 'success');
            return Promise.resolve(content);
        };

        // Test 1: Auto close
        window.testAutoClose = function() {
            try {
                console.log('🧪 Testing auto close...');
                
                // Open editor
                window.editor.setSaveCallback(saveCallback);
                window.editor.openEditor(testContent);
                
                showResult('✅ Editor opened', 'success');
                
                // Wait a bit then save
                setTimeout(() => {
                    window.editor.saveChanges().then(() => {
                        showResult('✅ Save triggered - editor should close immediately', 'success');
                        
                        // Check if editor closed
                        setTimeout(() => {
                            if (!window.editor.isEditorOpen) {
                                showResult('✅ Editor auto-closed successfully', 'success');
                            } else {
                                showResult('❌ Editor did not auto-close', 'error');
                            }
                        }, 500);
                        
                    }).catch(error => {
                        showResult(`❌ Save failed: ${error.message}`, 'error');
                    });
                }, 1000);
                
            } catch (error) {
                console.error('❌ Error testing auto close:', error);
                showResult(`❌ Error testing auto close: ${error.message}`, 'error');
            }
        };

        // Test 2: No duplicates
        window.testNoDuplicates = function() {
            try {
                console.log('🧪 Testing no duplicates...');
                
                // Open editor
                window.editor.setSaveCallback(saveCallback);
                window.editor.openEditor(testContent);
                
                // Switch to Mermaid tab
                setTimeout(() => {
                    const mermaidTab = document.querySelector('#mermaid-tab');
                    if (mermaidTab) {
                        mermaidTab.click();
                        
                        setTimeout(() => {
                            const selector = document.querySelector('#mermaid-selector');
                            if (selector) {
                                const beforeCount = selector.options.length - 1;
                                showResult(`📊 Before: ${beforeCount} diagram options`, 'info');
                                
                                // Save multiple times to test duplicates
                                let saveCount = 0;
                                const testMultipleSaves = () => {
                                    if (saveCount < 3) {
                                        saveCount++;
                                        showResult(`💾 Save attempt ${saveCount}...`, 'info');
                                        
                                        // Re-open editor for next save
                                        window.editor.openEditor(testContent);
                                        
                                        setTimeout(() => {
                                            const mermaidTab2 = document.querySelector('#mermaid-tab');
                                            if (mermaidTab2) {
                                                mermaidTab2.click();
                                                
                                                setTimeout(() => {
                                                    const selector2 = document.querySelector('#mermaid-selector');
                                                    if (selector2) {
                                                        const currentCount = selector2.options.length - 1;
                                                        showResult(`📊 After save ${saveCount}: ${currentCount} options`, 'info');
                                                        
                                                        if (currentCount === beforeCount) {
                                                            showResult(`✅ Save ${saveCount}: No duplicates`, 'success');
                                                        } else {
                                                            showResult(`❌ Save ${saveCount}: Duplicates found (${beforeCount} → ${currentCount})`, 'error');
                                                        }
                                                        
                                                        window.editor.saveChanges().then(() => {
                                                            setTimeout(testMultipleSaves, 1000);
                                                        });
                                                    }
                                                }, 500);
                                            }
                                        }, 500);
                                    } else {
                                        showResult('✅ Multiple save test completed', 'success');
                                    }
                                };
                                
                                testMultipleSaves();
                            }
                        }, 500);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('❌ Error testing duplicates:', error);
                showResult(`❌ Error testing duplicates: ${error.message}`, 'error');
            }
        };

        // Test 3: Content sync
        window.testContentSync = function() {
            try {
                console.log('🧪 Testing content sync...');
                
                // Open editor
                window.editor.setSaveCallback(saveCallback);
                window.editor.openEditor(testContent);
                
                setTimeout(() => {
                    // Modify raw content
                    const rawEditor = document.querySelector('#raw-content-editor');
                    if (rawEditor) {
                        const originalContent = rawEditor.value;
                        const modifiedContent = originalContent + '\n<p>Added by test: ' + Date.now() + '</p>';
                        
                        rawEditor.value = modifiedContent;
                        rawEditor.dispatchEvent(new Event('input', { bubbles: true }));
                        
                        showResult('✅ Modified raw content', 'success');
                        showResult('📝 Added timestamp paragraph', 'info');
                        
                        // Save and check if changes persist
                        window.editor.saveChanges().then(() => {
                            showResult('✅ Content sync test completed', 'success');
                        });
                    } else {
                        showResult('❌ Raw editor not found', 'error');
                    }
                }, 1000);
                
            } catch (error) {
                console.error('❌ Error testing content sync:', error);
                showResult(`❌ Error testing content sync: ${error.message}`, 'error');
            }
        };

        // Test 4: No confirms
        window.testNoConfirms = function() {
            try {
                console.log('🧪 Testing no confirms...');
                
                // Create fake backup
                const fakeBackup = {
                    content: { ...testContent },
                    timestamp: Date.now() - (5 * 60 * 1000) // 5 minutes ago
                };
                localStorage.setItem('confluence-editor-backup', JSON.stringify(fakeBackup));
                
                // Open editor - should auto-restore without confirm
                window.editor.setSaveCallback(saveCallback);
                window.editor.openEditor(testContent);
                
                showResult('✅ Editor opened with backup - no confirm popup', 'success');
                showResult('📋 Check console for auto-restore message', 'info');
                
            } catch (error) {
                console.error('❌ Error testing no confirms:', error);
                showResult(`❌ Error testing no confirms: ${error.message}`, 'error');
            }
        };

        // Apply content changes
        window.applyContentChanges = function() {
            const newContent = document.getElementById('test-content').value;
            testContent.full_storage_format = newContent;
            showResult('✅ Content updated for next test', 'success');
        };

        // Clear results
        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
        };

        // Show result
        function showResult(message, type) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
            
            console.log(message);
        }

        // Auto-run on page load
        window.addEventListener('load', () => {
            console.log('🚀 Final fixes test page loaded');
            showResult('📋 Page loaded - ready for testing', 'info');
            showResult('🔍 Test all 4 fixes:', 'info');
            showResult('1. Auto Close - editor closes immediately after save', 'info');
            showResult('2. No Duplicates - selector options stay consistent', 'info');
            showResult('3. Content Sync - changes in raw editor are saved', 'info');
            showResult('4. No Confirms - no popup dialogs', 'info');
        });
    </script>
</body>
</html>
