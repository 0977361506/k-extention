const t="extensionSettings",e=("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||window.location.hostname.includes("localhost"),{apiKey:"",urlTemplate:"",customPrompt:"",documentUrl:"",databaseUrl:"",instructionUrl:"",isEnabled:!0,selectedModel:"sonar-pro"});class a{static STORAGE_KEYS={CONFLUENCE_CONTENT_BACKUP:"confluence_content_backup",CONFLUENCE_CONTENT_DRAFT:"confluence_content_draft",MERMAID_DIAGRAM_MAPPINGS:"mermaid_diagram_mappings",MERMAID_DIAGRAM_MAPPINGS_DRAFT:"mermaid_diagram_mappings_draft",MERMAID_AI_FILENAME:"mermaid-ai-filename",MERMAID_DIAGRAM_INFO:"mermaid_diagram_info",CONFLUENCE_EDITOR_BACKUP:"confluence_editor_backup"};constructor(){this.STORAGE_KEY=a.STORAGE_KEYS.CONFLUENCE_CONTENT_BACKUP,this.AUTO_SAVE_INTERVAL=3e4,this.autoSaveTimer=null}static async getSettings(){try{return(await chrome.storage.sync.get([t]))[t]||e}catch(t){return console.error("Error loading settings:",t),e}}static async saveSettings(e){try{return await chrome.storage.sync.set({[t]:e}),!0}catch(t){return console.error("Error saving settings:",t),!1}}static async updateSetting(t,e){try{const a={...await this.getSettings(),[t]:e};return await this.saveSettings(a)}catch(t){return console.error("Error updating setting:",t),!1}}static async resetSettings(){try{return await chrome.storage.sync.remove([t]),!0}catch(t){return console.error("Error resetting settings:",t),!1}}static validateSettings(t){var e,a,r,o;const s={};if(null!==(e=t.apiKey)&&void 0!==e&&e.trim()||(s.apiKey="API Key là bắt buộc"),null!==(a=t.urlTemplate)&&void 0!==a&&a.trim()){const e=this.validateConfluencePageLink(t.urlTemplate);e.valid||(s.urlTemplate=e.error||"URL Template không hợp lệ.")}else s.urlTemplate="URL Template là bắt buộc";return null!==(r=t.documentUrl)&&void 0!==r&&r.trim()?this.isValidUrl(t.documentUrl)||(s.documentUrl="URL không hợp lệ"):s.documentUrl="URL thư mục lưu tài liệu là bắt buộc",null!==(o=t.databaseUrl)&&void 0!==o&&o.trim()?this.isValidUrl(t.databaseUrl)||(s.databaseUrl="URL không hợp lệ"):s.databaseUrl="URL thư mục database là bắt buộc",{isValid:0===Object.keys(s).length,errors:s}}static getSettingKeys(){return Object.keys(e)}static async hasSettings(){try{return!!(await chrome.storage.sync.get([t]))[t]}catch(t){return console.error("Error checking settings existence:",t),!1}}static async getSetting(t){try{const a=await this.getSettings();return void 0!==a[t]?a[t]:e[t]}catch(a){return console.error(`Error getting setting ${t}:`,a),e[t]}}static async exportSettings(){try{const t=await this.getSettings();return JSON.stringify(t,null,2)}catch(t){throw console.error("Error exporting settings:",t),t}}static async importSettings(t){try{const e=JSON.parse(t),a=this.validateSettings(e);if(!a.isValid)throw new Error(a.message);return await this.saveSettings(e)}catch(t){return console.error("Error importing settings:",t),!1}}static async clearAllChromeStorage(){try{return await chrome.storage.sync.clear(),await chrome.storage.local.clear(),!0}catch(t){return console.error("Error clearing Chrome storage:",t),!1}}static isValidUrl(t){try{return new URL(t),!0}catch{return!1}}static validateConfluencePageLink(t){const e={valid:!1,error:null,pageId:null};if(!t||"string"!=typeof t||!t.trim())return e.error="URL là bắt buộc",e;let a;try{a=new URL(t.trim())}catch{return e.error="URL không hợp lệ",e}const r=a.searchParams.get("pageId");if(r&&/^\d+$/.test(r))return e.valid=!0,e.pageId=r,e;const o=a.pathname.split("/"),s=o.indexOf("pages");if(s>=0&&o.length>s+1){const t=o[s+1];if(/^\d+$/.test(t))return e.valid=!0,e.pageId=t,e}return e.error="Không tìm thấy pageId trong URL",e}async saveContent(t,e=null,a={}){const{enableLocalStorage:r=!0,enableCallback:o=!0,showNotification:s=!0}=a,n={localStorage:!1,callback:!1,errors:[]};if(r)try{this.saveToLocalStorage(t),n.localStorage=!0,console.log("✅ Content saved to localStorage")}catch(t){console.error("❌ Failed to save to localStorage:",t),n.errors.push(`localStorage: ${t.message}`)}if(o&&e)try{await this.callSaveCallback(e,t),n.callback=!0,console.log("✅ Content saved via callback")}catch(t){console.error("❌ Failed to save via callback:",t),n.errors.push(`callback: ${t.message}`)}return s&&this.showSaveNotification(n),n}saveToLocalStorage(t){const e={content:t,timestamp:Date.now(),version:"1.0"};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}loadFromLocalStorage(){try{const t=localStorage.getItem(this.STORAGE_KEY);if(!t)return null;const e=JSON.parse(t);return Date.now()-e.timestamp>864e5?(console.log("🗑️ Removing old localStorage backup"),localStorage.removeItem(this.STORAGE_KEY),null):(console.log("📦 Loaded content from localStorage backup"),e.content)}catch(t){return console.error("❌ Failed to load from localStorage:",t),null}}clearLocalStorage(){localStorage.removeItem(this.STORAGE_KEY),console.log("🗑️ Cleared localStorage backup")}createDraftFromBackup(){try{console.log("📝 Creating draft from backup content...");const t=this.loadFromLocalStorage();if(!t)return console.warn("⚠️ No backup content found to create draft from"),null;const e={content:JSON.parse(JSON.stringify(t)),timestamp:Date.now(),version:"1.0",isDraft:!0};return localStorage.setItem(a.STORAGE_KEYS.CONFLUENCE_CONTENT_DRAFT,JSON.stringify(e)),console.log("✅ Draft created from backup content:",{hasContent:!!e.content,timestamp:new Date(e.timestamp).toLocaleString()}),e.content}catch(t){return console.error("❌ Failed to create draft from backup:",t),null}}saveToDraft(t){try{const e={content:t,timestamp:Date.now(),version:"1.0",isDraft:!0};localStorage.setItem(a.STORAGE_KEYS.CONFLUENCE_CONTENT_DRAFT,JSON.stringify(e)),console.log("💾 Content saved to draft:",{hasContent:!!t,timestamp:new Date(e.timestamp).toLocaleString()})}catch(t){console.error("❌ Failed to save to draft:",t)}}loadFromDraft(){try{const t=localStorage.getItem(a.STORAGE_KEYS.CONFLUENCE_CONTENT_DRAFT);if(!t)return null;const e=JSON.parse(t);return console.log("📖 Loaded content from draft:",{hasContent:!!e.content,timestamp:new Date(e.timestamp).toLocaleString(),isDraft:e.isDraft}),e.content}catch(t){return console.error("❌ Failed to load from draft:",t),null}}commitDraftToBackup(){try{console.log("💾 Committing draft to backup...");const t=this.loadFromDraft();return t?(this.saveToLocalStorage(t),this.clearDraft(),console.log("✅ Draft committed to backup successfully"),!0):(console.warn("⚠️ No draft content found to commit"),!1)}catch(t){return console.error("❌ Failed to commit draft to backup:",t),!1}}clearDraft(){try{localStorage.removeItem(a.STORAGE_KEYS.CONFLUENCE_CONTENT_DRAFT),console.log("🗑️ Draft cleared")}catch(t){console.error("❌ Failed to clear draft:",t)}}hasDraft(){try{return!!localStorage.getItem(a.STORAGE_KEYS.CONFLUENCE_CONTENT_DRAFT)}catch(t){return console.error("❌ Failed to check draft existence:",t),!1}}createMermaidDiagramMappingsDraft(){try{const t=this.getMermaidDiagramMappings(),e={mappings:Array.from(t.entries()),timestamp:Date.now(),version:"1.0",isDraft:!0};return localStorage.setItem(a.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS_DRAFT,JSON.stringify(e)),console.log("📝 Created Mermaid diagram mappings draft"),t}catch(t){return console.error("❌ Error creating Mermaid diagram mappings draft:",t),new Map}}saveMermaidDiagramMappingsToDraft(t){try{const e={mappings:Array.from(t.entries()),timestamp:Date.now(),version:"1.0",isDraft:!0};localStorage.setItem(a.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS_DRAFT,JSON.stringify(e)),console.log("📝 Saved Mermaid diagram mappings to draft")}catch(t){console.error("❌ Error saving Mermaid diagram mappings to draft:",t)}}loadMermaidDiagramMappingsFromDraft(){try{var t;const e=localStorage.getItem(a.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS_DRAFT);if(console.log("🔍 DEBUG: Raw draft data from localStorage:",e?"exists":"null"),!e)return null;const r=JSON.parse(e);console.log("🔍 DEBUG: Parsed draft data:",{hasMappings:!!r.mappings,mappingsLength:(null===(t=r.mappings)||void 0===t?void 0:t.length)||0,timestamp:r.timestamp,isDraft:r.isDraft});const o=new Map(r.mappings);return console.log("📝 Loaded Mermaid diagram mappings from draft:",o.size,"diagrams"),console.log("🔍 DEBUG: Draft mappings keys:",Array.from(o.keys())),o}catch(t){return console.error("❌ Error loading Mermaid diagram mappings from draft:",t),null}}commitMermaidDiagramMappingsDraftToMain(){try{console.log("🔍 DEBUG: Starting commit process...");const t=this.loadMermaidDiagramMappingsFromDraft();if(!t)return console.warn("⚠️ No draft mappings to commit"),!1;console.log("🔍 DEBUG: Draft mappings to commit:",{size:t.size,keys:Array.from(t.keys()),firstEntry:t.size>0?Array.from(t.entries())[0]:null});const e=this.getMermaidDiagramMappings();console.log("🔍 DEBUG: Old main mappings before clear:",{size:e.size,keys:Array.from(e.keys())}),console.log("🗑️ Clearing old main Mermaid diagram mappings..."),localStorage.removeItem(a.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS);const r=localStorage.getItem(a.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS);console.log("🔍 DEBUG: Main mappings after clear:",r),console.log(`📝 Saving ${t.size} draft mappings as main mappings...`);const o=this.saveMermaidDiagramMappings(t);console.log("🔍 DEBUG: Save result:",o);const s=this.getMermaidDiagramMappings();return console.log("🔍 DEBUG: New main mappings after save:",{size:s.size,keys:Array.from(s.keys()),firstEntry:s.size>0?Array.from(s.entries())[0]:null}),this.clearMermaidDiagramMappingsDraft(),console.log("✅ Committed Mermaid diagram mappings draft to main"),!0}catch(t){return console.error("❌ Error committing Mermaid diagram mappings draft:",t),!1}}clearMermaidDiagramMappingsDraft(){try{localStorage.removeItem(a.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS_DRAFT),console.log("🗑️ Cleared Mermaid diagram mappings draft")}catch(t){console.error("❌ Error clearing Mermaid diagram mappings draft:",t)}}hasMermaidDiagramMappingsDraft(){return!!localStorage.getItem(a.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS_DRAFT)}getMermaidDiagramMappingsWithDraft(){const t=this.loadMermaidDiagramMappingsFromDraft();return t?(console.log("📝 Using Mermaid diagram mappings from draft"),t):(console.log("💾 Using Mermaid diagram mappings from main storage"),this.getMermaidDiagramMappings())}async callSaveCallback(t,e){if("function"!=typeof t)throw new Error("Save callback is not a function");const a=t(e);a&&"function"==typeof a.then&&await a}showSaveNotification(t){const{localStorage:e,callback:a,errors:r}=t;if(e&&a)this.showNotification("✅ Đã lưu thay đổi thành công","success");else if(e||a){const t=e?"localStorage":"callback";this.showNotification(`⚠️ Đã lưu qua ${t} (một phần)`,"warning")}else this.showNotification("❌ Không thể lưu thay đổi","error");r.length>0&&console.warn("Save errors:",r)}showNotification(t,e="info"){const a=document.createElement("div");a.className=`confluence-editor-notification ${e}`,a.style.cssText="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      padding: 12px 20px;\n      border-radius: 6px;\n      color: white;\n      font-family: Arial, sans-serif;\n      font-size: 14px;\n      z-index: 10001;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n      transition: all 0.3s ease;\n      max-width: 300px;\n    ";const r={success:"#28a745",warning:"#ffc107",error:"#dc3545",info:"#17a2b8"};a.style.background=r[e]||r.info,a.textContent=t,document.body.appendChild(a),setTimeout(()=>{a.parentNode&&(a.style.opacity="0",a.style.transform="translateX(100%)",setTimeout(()=>{a.remove()},300))},3e3)}startAutoSave(t){this.stopAutoSave(),this.autoSaveTimer=setInterval(()=>{try{t(),console.log("🔄 Auto-save completed")}catch(t){console.error("❌ Auto-save failed:",t)}},this.AUTO_SAVE_INTERVAL),console.log("⏰ Auto-save started (every 30 seconds)")}stopAutoSave(){this.autoSaveTimer&&(clearInterval(this.autoSaveTimer),this.autoSaveTimer=null,console.log("⏹️ Auto-save stopped"))}hasUnsavedChanges(t){const e=this.loadFromLocalStorage();if(!e)return!1;try{return JSON.stringify(t)!==JSON.stringify(e)}catch(t){return console.error("❌ Error comparing content:",t),!1}}getBackupInfo(){try{const t=localStorage.getItem(this.STORAGE_KEY);if(!t)return null;const e=JSON.parse(t);return{timestamp:e.timestamp,age:Date.now()-e.timestamp,version:e.version}}catch(t){return null}}async getItem(t){try{const e=localStorage.getItem(t);return e?JSON.parse(e):null}catch(e){return console.error(`❌ Error getting item from localStorage (${t}):`,e),null}}async setItem(t,e){try{localStorage.setItem(t,JSON.stringify(e))}catch(e){throw console.error(`❌ Error setting item to localStorage (${t}):`,e),e}}async removeItem(t){try{localStorage.removeItem(t)}catch(e){throw console.error(`❌ Error removing item from localStorage (${t}):`,e),e}}saveMermaidDiagramMappings(t){try{if(!t||0===t.size)return console.log("🗂️ No diagrams to save, clearing mappings"),localStorage.removeItem(a.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS),!0;const e={};return t.forEach((t,a)=>{e[a]={title:t.title,type:t.type,content:t.content,originCode:t.originCode,timestamp:Date.now()}}),localStorage.setItem(a.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS,JSON.stringify(e)),console.log(`✅ Saved ${t.size} Mermaid diagram mappings to localStorage`),!0}catch(t){return console.error("❌ Error saving Mermaid diagram mappings:",t),!1}}getMermaidDiagramMappings(){try{const t=localStorage.getItem(a.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS);if(!t)return console.log("📊 No stored Mermaid diagram mappings found"),new Map;const e=JSON.parse(t),r=new Map;return Object.entries(e).forEach(([t,e])=>{r.set(t,e)}),console.log(`📊 Loaded ${r.size} Mermaid diagram mappings from localStorage`),r}catch(t){return console.error("❌ Error loading Mermaid diagram mappings:",t),new Map}}async clearAllKToolData(){const t=Object.values(a.STORAGE_KEYS),e=[],r=[];for(const a of t)try{await this.removeItem(a),e.push(a)}catch(t){r.push({key:a,error:t.message})}return console.log("🧹 Cleared K-Tool localStorage keys:",e),r.length>0&&console.warn("⚠️ Failed to clear some keys:",r),{clearedKeys:e,failedKeys:r}}}class r{constructor(){this.isInitialLoad=!0,this.saveTimeout=null,this.elements={},this.init()}async init(){this.bindElements(),this.bindEvents(),await this.loadSettings(),this.isInitialLoad=!1}bindElements(){this.elements={enabledSwitch:document.getElementById("enabledSwitch"),statusText:document.getElementById("statusText"),apiKey:document.getElementById("apiKey"),selectedModel:document.getElementById("selectedModel"),urlTemplate:document.getElementById("urlTemplate"),documentUrl:document.getElementById("documentUrl"),databaseUrl:document.getElementById("databaseUrl"),instructionUrl:document.getElementById("instructionUrl"),customPrompt:document.getElementById("customPrompt"),charCount:document.getElementById("charCount"),saveStatus:document.getElementById("saveStatus"),saveIcon:document.getElementById("saveIcon"),saveText:document.getElementById("saveText"),resetBtn:document.getElementById("resetBtn")}}bindEvents(){this.elements.enabledSwitch.addEventListener("change",t=>{this.updateStatusText(t.target.checked),this.handleInputChange("isEnabled",t.target.checked)}),["apiKey","selectedModel","urlTemplate","documentUrl","databaseUrl","instructionUrl","customPrompt"].forEach(t=>{const e=this.elements[t];e&&e.addEventListener("input",e=>{this.handleInputChange(t,e.target.value),this.clearError(t),"customPrompt"===t&&this.updateCharCount(e.target.value)})}),this.elements.resetBtn.addEventListener("click",()=>{this.resetSettings()}),this.bindAutoSaveEvents()}bindAutoSaveEvents(){window.addEventListener("beforeunload",()=>{this.saveSettingsImmediately()}),window.addEventListener("blur",()=>{this.saveSettingsImmediately()}),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&this.saveSettingsImmediately()}),window.addEventListener("pagehide",()=>{this.saveSettingsImmediately()})}async loadSettings(){try{const t=await a.getSettings();this.elements.enabledSwitch.checked=t.isEnabled,this.elements.apiKey.value=t.apiKey||"",this.elements.selectedModel.value=t.selectedModel||"sonar-pro",this.elements.urlTemplate.value=t.urlTemplate||"",this.elements.documentUrl.value=t.documentUrl||"",this.elements.databaseUrl.value=t.databaseUrl||"",this.elements.instructionUrl.value=t.instructionUrl||"",this.elements.customPrompt.value=t.customPrompt||"",this.updateStatusText(t.isEnabled),this.updateCharCount(t.customPrompt||"")}catch(t){console.error("Error loading settings:",t),this.showSaveStatus("error","Lỗi tải cài đặt")}}handleInputChange(t,e){this.isInitialLoad||(this.saveTimeout&&clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(async()=>{await this.saveSettings()},1e3))}async saveSettings(){try{this.showSaveStatus("saving","Đang lưu...");const t={isEnabled:this.elements.enabledSwitch.checked,apiKey:this.elements.apiKey.value.trim(),selectedModel:this.elements.selectedModel.value,urlTemplate:this.elements.urlTemplate.value.trim(),documentUrl:this.elements.documentUrl.value.trim(),databaseUrl:this.elements.databaseUrl.value.trim(),instructionUrl:this.elements.instructionUrl.value.trim(),customPrompt:this.elements.customPrompt.value.trim()},e=a.validateSettings(t);if(!e.isValid)return this.showValidationErrors(e.errors),void this.showSaveStatus("error","Lỗi validation");await a.saveSettings(t)?(this.showSaveStatus("saved","Đã lưu"),this.clearAllErrors()):this.showSaveStatus("error","Lỗi lưu")}catch(t){console.error("Error saving settings:",t),this.showSaveStatus("error","Lỗi lưu")}}async saveSettingsImmediately(){try{this.saveTimeout&&(clearTimeout(this.saveTimeout),this.saveTimeout=null);const t={isEnabled:this.elements.enabledSwitch.checked,apiKey:this.elements.apiKey.value.trim(),selectedModel:this.elements.selectedModel.value,urlTemplate:this.elements.urlTemplate.value.trim(),documentUrl:this.elements.documentUrl.value.trim(),databaseUrl:this.elements.databaseUrl.value.trim(),instructionUrl:this.elements.instructionUrl.value.trim(),customPrompt:this.elements.customPrompt.value.trim()};await a.saveSettings(t)}catch(t){console.error("Error saving settings immediately:",t)}}async resetSettings(){if(confirm("Bạn có chắc muốn reset tất cả cài đặt về mặc định?"))try{await a.resetSettings(),await this.loadSettings(),this.showSaveStatus("saved","Đã reset")}catch(t){console.error("Error resetting settings:",t),this.showSaveStatus("error","Lỗi reset")}}updateStatusText(t){this.elements.statusText.textContent=t?"Bật":"Tắt",this.elements.statusText.style.color=t?"#28a745":"#6c757d"}updateCharCount(t){const e=t.length;this.elements.charCount.textContent=`${e} ký tự`,this.elements.charCount.style.color=e<10?"#dc3545":e<50?"#ffc107":"#28a745"}showSaveStatus(t,e){const a=this.elements.saveStatus,r=this.elements.saveIcon,o=this.elements.saveText;a.className="save-status",r.className="save-icon",a.classList.add(t),"saving"===t?(r.classList.add("spinning"),r.textContent="⏳"):"saved"===t?r.textContent="✅":"error"===t&&(r.textContent="❌"),o.textContent=e,a.style.display="flex","saving"!==t&&setTimeout(()=>{a.style.display="none"},3e3)}showValidationErrors(t){Object.keys(t).forEach(e=>{this.showError(e,t[e])})}showError(t,e){const a=this.elements[t],r=document.getElementById(`${t}Error`);a&&r&&(a.classList.add("error"),r.textContent=e,r.classList.add("show"))}clearError(t){const e=this.elements[t],a=document.getElementById(`${t}Error`);e&&a&&(e.classList.remove("error"),a.classList.remove("show"))}clearAllErrors(){const t=document.querySelectorAll(".error-message"),e=document.querySelectorAll(".form-input, .form-select, .form-textarea");t.forEach(t=>t.classList.remove("show")),e.forEach(t=>t.classList.remove("error"))}}document.addEventListener("DOMContentLoaded",()=>{new r});
//# sourceMappingURL=popup.js.map