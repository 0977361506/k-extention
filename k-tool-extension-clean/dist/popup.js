const e="extensionSettings",t={apiKey:"",urlTemplate:"",customPrompt:"",documentUrl:"",databaseUrl:"",instructionUrl:"",isEnabled:!0,selectedModel:"sonar-pro"};class s{static async getSettings(){try{return(await chrome.storage.sync.get([e]))[e]||t}catch(e){return console.error("Error loading settings:",e),t}}static async saveSettings(t){try{return await chrome.storage.sync.set({[e]:t}),!0}catch(e){return console.error("Error saving settings:",e),!1}}static async updateSetting(e,t){try{const s={...await this.getSettings(),[e]:t};return await this.saveSettings(s)}catch(e){return console.error("Error updating setting:",e),!1}}static async resetSettings(){try{return await chrome.storage.sync.remove([e]),!0}catch(e){return console.error("Error resetting settings:",e),!1}}static validateSettings(e){var t,s,a,n;const r={};if(null!==(t=e.apiKey)&&void 0!==t&&t.trim()||(r.apiKey="API Key là bắt buộc"),null!==(s=e.urlTemplate)&&void 0!==s&&s.trim()){const t=this.validateConfluencePageLink(e.urlTemplate);t.valid||(r.urlTemplate=t.error||"URL Template không hợp lệ.")}else r.urlTemplate="URL Template là bắt buộc";return null!==(a=e.documentUrl)&&void 0!==a&&a.trim()?this.isValidUrl(e.documentUrl)||(r.documentUrl="URL không hợp lệ"):r.documentUrl="URL thư mục lưu tài liệu là bắt buộc",null!==(n=e.databaseUrl)&&void 0!==n&&n.trim()?this.isValidUrl(e.databaseUrl)||(r.databaseUrl="URL không hợp lệ"):r.databaseUrl="URL thư mục database là bắt buộc",{isValid:0===Object.keys(r).length,errors:r}}static isValidUrl(e){try{return new URL(e),!0}catch{return!1}}static validateConfluencePageLink(e){const t={valid:!1,error:null,pageId:null};if(!e||"string"!=typeof e||!e.trim())return t.error="URL là bắt buộc",t;let s;try{s=new URL(e.trim())}catch{return t.error="URL không hợp lệ",t}const a=s.searchParams.get("pageId");if(a&&/^\d+$/.test(a))return t.valid=!0,t.pageId=a,t;const n=s.pathname.split("/"),r=n.indexOf("pages");if(r>=0&&n.length>r+1){const e=n[r+1];if(/^\d+$/.test(e))return t.valid=!0,t.pageId=e,t}return t.error="Không tìm thấy pageId trong URL",t}}class a{constructor(){this.isInitialLoad=!0,this.saveTimeout=null,this.elements={},this.init()}async init(){this.bindElements(),this.bindEvents(),await this.loadSettings(),this.isInitialLoad=!1}bindElements(){this.elements={enabledSwitch:document.getElementById("enabledSwitch"),statusText:document.getElementById("statusText"),apiKey:document.getElementById("apiKey"),selectedModel:document.getElementById("selectedModel"),urlTemplate:document.getElementById("urlTemplate"),documentUrl:document.getElementById("documentUrl"),databaseUrl:document.getElementById("databaseUrl"),instructionUrl:document.getElementById("instructionUrl"),customPrompt:document.getElementById("customPrompt"),charCount:document.getElementById("charCount"),saveStatus:document.getElementById("saveStatus"),saveIcon:document.getElementById("saveIcon"),saveText:document.getElementById("saveText"),resetBtn:document.getElementById("resetBtn")}}bindEvents(){this.elements.enabledSwitch.addEventListener("change",e=>{this.updateStatusText(e.target.checked),this.handleInputChange("isEnabled",e.target.checked)}),["apiKey","selectedModel","urlTemplate","documentUrl","databaseUrl","instructionUrl","customPrompt"].forEach(e=>{const t=this.elements[e];t&&t.addEventListener("input",t=>{this.handleInputChange(e,t.target.value),this.clearError(e),"customPrompt"===e&&this.updateCharCount(t.target.value)})}),this.elements.resetBtn.addEventListener("click",()=>{this.resetSettings()}),this.bindAutoSaveEvents()}bindAutoSaveEvents(){window.addEventListener("beforeunload",()=>{this.saveSettingsImmediately()}),window.addEventListener("blur",()=>{this.saveSettingsImmediately()}),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&this.saveSettingsImmediately()}),window.addEventListener("pagehide",()=>{this.saveSettingsImmediately()})}async loadSettings(){try{const e=await s.getSettings();this.elements.enabledSwitch.checked=e.isEnabled,this.elements.apiKey.value=e.apiKey||"",this.elements.selectedModel.value=e.selectedModel||"sonar-pro",this.elements.urlTemplate.value=e.urlTemplate||"",this.elements.documentUrl.value=e.documentUrl||"",this.elements.databaseUrl.value=e.databaseUrl||"",this.elements.instructionUrl.value=e.instructionUrl||"",this.elements.customPrompt.value=e.customPrompt||"",this.updateStatusText(e.isEnabled),this.updateCharCount(e.customPrompt||"")}catch(e){console.error("Error loading settings:",e),this.showSaveStatus("error","Lỗi tải cài đặt")}}handleInputChange(e,t){this.isInitialLoad||(this.saveTimeout&&clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(async()=>{await this.saveSettings()},1e3))}async saveSettings(){try{this.showSaveStatus("saving","Đang lưu...");const e={isEnabled:this.elements.enabledSwitch.checked,apiKey:this.elements.apiKey.value.trim(),selectedModel:this.elements.selectedModel.value,urlTemplate:this.elements.urlTemplate.value.trim(),documentUrl:this.elements.documentUrl.value.trim(),databaseUrl:this.elements.databaseUrl.value.trim(),instructionUrl:this.elements.instructionUrl.value.trim(),customPrompt:this.elements.customPrompt.value.trim()},t=s.validateSettings(e);if(!t.isValid)return this.showValidationErrors(t.errors),void this.showSaveStatus("error","Lỗi validation");await s.saveSettings(e)?(this.showSaveStatus("saved","Đã lưu"),this.clearAllErrors()):this.showSaveStatus("error","Lỗi lưu")}catch(e){console.error("Error saving settings:",e),this.showSaveStatus("error","Lỗi lưu")}}async saveSettingsImmediately(){try{this.saveTimeout&&(clearTimeout(this.saveTimeout),this.saveTimeout=null);const e={isEnabled:this.elements.enabledSwitch.checked,apiKey:this.elements.apiKey.value.trim(),selectedModel:this.elements.selectedModel.value,urlTemplate:this.elements.urlTemplate.value.trim(),documentUrl:this.elements.documentUrl.value.trim(),databaseUrl:this.elements.databaseUrl.value.trim(),instructionUrl:this.elements.instructionUrl.value.trim(),customPrompt:this.elements.customPrompt.value.trim()};await s.saveSettings(e)}catch(e){console.error("Error saving settings immediately:",e)}}async resetSettings(){if(confirm("Bạn có chắc muốn reset tất cả cài đặt về mặc định?"))try{await s.resetSettings(),await this.loadSettings(),this.showSaveStatus("saved","Đã reset")}catch(e){console.error("Error resetting settings:",e),this.showSaveStatus("error","Lỗi reset")}}updateStatusText(e){this.elements.statusText.textContent=e?"Bật":"Tắt",this.elements.statusText.style.color=e?"#28a745":"#6c757d"}updateCharCount(e){const t=e.length;this.elements.charCount.textContent=`${t} ký tự`,this.elements.charCount.style.color=t<10?"#dc3545":t<50?"#ffc107":"#28a745"}showSaveStatus(e,t){const s=this.elements.saveStatus,a=this.elements.saveIcon,n=this.elements.saveText;s.className="save-status",a.className="save-icon",s.classList.add(e),"saving"===e?(a.classList.add("spinning"),a.textContent="⏳"):"saved"===e?a.textContent="✅":"error"===e&&(a.textContent="❌"),n.textContent=t,s.style.display="flex","saving"!==e&&setTimeout(()=>{s.style.display="none"},3e3)}showValidationErrors(e){Object.keys(e).forEach(t=>{this.showError(t,e[t])})}showError(e,t){const s=this.elements[e],a=document.getElementById(`${e}Error`);s&&a&&(s.classList.add("error"),a.textContent=t,a.classList.add("show"))}clearError(e){const t=this.elements[e],s=document.getElementById(`${e}Error`);t&&s&&(t.classList.remove("error"),s.classList.remove("show"))}clearAllErrors(){const e=document.querySelectorAll(".error-message"),t=document.querySelectorAll(".form-input, .form-select, .form-textarea");e.forEach(e=>e.classList.remove("show")),t.forEach(e=>e.classList.remove("error"))}}document.addEventListener("DOMContentLoaded",()=>{new a});
//# sourceMappingURL=popup.js.map