{"version":3,"file":"content.js","mappings":"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","sources":["webpack://k-tool-extension-clean/./src/content/utils/mermaidRenderer.js","webpack://k-tool-extension-clean/webpack/bootstrap","webpack://k-tool-extension-clean/webpack/runtime/define property getters","webpack://k-tool-extension-clean/webpack/runtime/hasOwnProperty shorthand","webpack://k-tool-extension-clean/./src/shared/constants.js","webpack://k-tool-extension-clean/./src/shared/diagramUtils.js","webpack://k-tool-extension-clean/./src/shared/api.js","webpack://k-tool-extension-clean/./src/content/utils/xmlFormatter.js","webpack://k-tool-extension-clean/./src/content/utils/contentSynchronizer.js","webpack://k-tool-extension-clean/./src/content/utils/domHelpers.js","webpack://k-tool-extension-clean/./src/content/utils/htmlTemplates.js","webpack://k-tool-extension-clean/./src/content/utils/storageManager.js","webpack://k-tool-extension-clean/./src/content/liveEdit/LiveTextEditor.js","webpack://k-tool-extension-clean/./src/content/confluenceEditor.js","webpack://k-tool-extension-clean/./src/content/mermaidAI/MermaidPreview.js","webpack://k-tool-extension-clean/./src/content/mermaidAI/MermaidAIService.js","webpack://k-tool-extension-clean/./src/content/mermaidAI/MermaidApiClient.js","webpack://k-tool-extension-clean/./src/content/mermaidAI/mermaidAIChat.js","webpack://k-tool-extension-clean/./src/content/mermaidAI/textEditAI.js","webpack://k-tool-extension-clean/./src/content/content.js"],"sourcesContent":["// Mermaid Rendering Utilities\n// Handles Mermaid diagram loading, rendering and error handling\n\nexport class MermaidRenderer {\n  /**\n   * Load Mermaid script dynamically\n   * @returns {Promise<object>} Mermaid instance\n   */\n  static async loadMermaidScript() {\n    if (window.mermaid) {\n      console.log(\"⚡ Mermaid already loaded\");\n      return window.mermaid;\n    }\n\n    const res = await fetch(chrome.runtime.getURL(\"lib/mermaid.min.js\"));\n    const text = await res.text();\n    eval(text); // UMD will attach mermaid to window\n    console.log(\"✅ Mermaid loaded dynamically\");\n    return window.mermaid;\n  }\n\n  /**\n   * Initialize Mermaid with proper configuration\n   * @returns {Promise<void>}\n   */\n  static async initializeMermaid() {\n    await this.loadMermaidScript();\n\n    // Configure Mermaid with proper DOM context\n    window.mermaid.initialize({\n      startOnLoad: false,\n      theme: \"default\",\n      securityLevel: \"loose\",\n      fontFamily: \"Arial, sans-serif\",\n      // Ensure proper DOM context\n      htmlLabels: true,\n      flowchart: {\n        htmlLabels: true,\n      },\n      // Set the document context explicitly\n      deterministicIds: true,\n      deterministicIDSeed: \"mermaid-diagram-preview\",\n    });\n\n    // Ensure mermaid has access to document\n    if (window.mermaid.setConfig) {\n      window.mermaid.setConfig({\n        securityLevel: \"loose\",\n        theme: \"default\",\n      });\n    }\n  }\n\n  /**\n   * Render a single Mermaid diagram\n   * @param {string} diagramId - Unique ID for the diagram\n   * @param {string} mermaidCode - Mermaid diagram code\n   * @param {HTMLElement} container - Container element\n   * @returns {Promise<void>}\n   */\n  static async renderDiagram(diagramId, mermaidCode, container) {\n    try {\n      // 🧹 Làm sạch code trước\n      const cleanCode = this.cleanMermaidCode(mermaidCode);\n      console.log(\"🧹 Cleaned Mermaid code for rendering:\", cleanCode);\n\n      // 🧩 Kiểm tra hợp lệ\n      if (!this.validateMermaidCode(cleanCode)) {\n        throw new Error(\"Invalid Mermaid syntax after cleaning\");\n      }\n      if (!container || container.nodeType !== Node.ELEMENT_NODE) {\n        throw new Error(\"Invalid container for Mermaid diagram\");\n      }\n\n      // ⚙️ Đảm bảo Mermaid đã sẵn sàng\n      if (!window.mermaid || typeof window.mermaid.render !== \"function\") {\n        throw new Error(\"Mermaid render function not available\");\n      }\n\n      // 🚫 Ngăn chèn SVG lỗi vào body bằng container ảo\n      const tempContainer = document.createElement(\"div\");\n      tempContainer.style.position = \"absolute\";\n      tempContainer.style.left = \"-9999px\";\n      tempContainer.style.top = \"-9999px\";\n      tempContainer.style.visibility = \"hidden\";\n      document.body.appendChild(tempContainer);\n\n      try {\n        let svgCode;\n\n        // ⚡ API hiện đại (Promise-based)\n        const renderResult = await window.mermaid.render(\n          diagramId,\n          cleanCode,\n          tempContainer\n        );\n\n        // Xử lý các kiểu trả về khác nhau\n        if (typeof renderResult === \"string\") {\n          svgCode = renderResult;\n        } else if (renderResult && renderResult.svg) {\n          svgCode = renderResult.svg;\n        } else {\n          svgCode = tempContainer.innerHTML;\n        }\n\n        // ✅ Gán SVG vào container thực tế\n        container.innerHTML = svgCode;\n        console.log(\"✅ Mermaid diagram rendered successfully!\");\n      } catch (renderError) {\n        console.error(\"❌ Mermaid render error:\", renderError);\n        this.showMermaidError(container, mermaidCode, renderError);\n      } finally {\n        // 🧹 Dọn container ảo để tránh chèn SVG rác\n        if (tempContainer && tempContainer.parentNode) {\n          tempContainer.remove();\n        }\n      }\n    } catch (error) {\n      console.error(\"❌ Mermaid render error (outer):\", error);\n      this.showMermaidError(container, mermaidCode, error);\n    }\n  }\n\n  /**\n   * Show Mermaid error in a nice format\n   * @param {HTMLElement} container - Container element\n   * @param {string} text - Mermaid code that failed\n   * @param {Error} error - Error object\n   */\n  static showMermaidError(container, text, error) {\n    // Validate container before attempting to set innerHTML\n    if (\n      !container ||\n      !container.nodeType ||\n      container.nodeType !== Node.ELEMENT_NODE\n    ) {\n      console.error(\n        \"❌ Invalid container for Mermaid error display:\",\n        container\n      );\n      console.error(\"❌ Mermaid error details:\", {\n        message: error.message || \"Unknown error occurred\",\n        code: text ? text.substring(0, 100) + \"...\" : \"No code provided\",\n      });\n      return;\n    }\n\n    // Check if container is still in the DOM\n    if (!document.contains(container)) {\n      console.error(\"❌ Container is not in DOM, cannot display Mermaid error\");\n      console.error(\"❌ Mermaid error details:\", {\n        message: error.message || \"Unknown error occurred\",\n        code: text ? text.substring(0, 100) + \"...\" : \"No code provided\",\n      });\n      return;\n    }\n\n    try {\n      container.innerHTML = `\n        <div style=\"color: #dc3545; padding: 15px; background: #f8d7da; border-radius: 8px; border: 1px solid #f5c6cb; font-family: Arial, sans-serif;\">\n          <div style=\"font-weight: bold; margin-bottom: 8px; display: flex; align-items: center;\">\n            <span style=\"margin-right: 8px;\">⚠️</span>\n            Mermaid Render Error\n          </div>\n          <div style=\"font-size: 12px; color: #721c24; margin-bottom: 10px;\">\n            ${error.message || \"Unknown error occurred\"}\n          </div>\n          <details style=\"margin-top: 10px;\">\n            <summary style=\"cursor: pointer; font-size: 12px; color: #495057;\">Show diagram code</summary>\n            <pre style=\"margin: 8px 0 0 0; padding: 8px; background: #fff; border: 1px solid #dee2e6; border-radius: 4px; font-size: 11px; overflow-x: auto; white-space: pre-wrap;\">${\n              text || \"No code provided\"\n            }</pre>\n          </details>\n        </div>\n      `;\n    } catch (setInnerHTMLError) {\n      console.error(\n        \"❌ Failed to set error HTML in container:\",\n        setInnerHTMLError\n      );\n      console.error(\"❌ Original Mermaid error:\", {\n        message: error.message || \"Unknown error occurred\",\n        code: text ? text.substring(0, 100) + \"...\" : \"No code provided\",\n      });\n    }\n  }\n\n  /**\n   * Detect Mermaid diagram type from code\n   * @param {string} code - Mermaid diagram code\n   * @returns {string} Diagram type\n   */\n  static detectMermaidType(code) {\n    const firstLine = code.trim().split(\"\\n\")[0].toLowerCase();\n    if (firstLine.includes(\"graph\")) return \"graph\";\n    if (firstLine.includes(\"flowchart\")) return \"flowchart\";\n    if (firstLine.includes(\"sequencediagram\")) return \"sequence\";\n    if (firstLine.includes(\"classDiagram\")) return \"class\";\n    if (firstLine.includes(\"stateDiagram\")) return \"state\";\n    if (firstLine.includes(\"erDiagram\")) return \"er\";\n    if (firstLine.includes(\"gantt\")) return \"gantt\";\n    if (firstLine.includes(\"pie\")) return \"pie\";\n    return \"graph\";\n  }\n\n  /**\n   * Extract Mermaid diagrams from Confluence content\n   * @param {string} content - Confluence storage format content\n   * @returns {Array} Array of diagram objects\n   */\n  static extractMermaidDiagrams(content) {\n    const diagrams = [];\n    const diagramsMap = new Map();\n\n    if (!content) return { diagrams, diagramsMap };\n\n    // Regex to find all <ac:structured-macro ...> ... </ac:structured-macro>\n    const macroRegex =\n      /<ac:structured-macro[^>]*ac:name=\"(mermaid|code)\"[^>]*>([\\s\\S]*?)<\\/ac:structured-macro>/gi;\n\n    let match;\n    let index = 0;\n\n    while ((match = macroRegex.exec(content)) !== null) {\n      const macroName = match[1];\n      const macroContent = match[2];\n\n      // Check code parameter\n      const codeMatch = macroContent.match(\n        /<ac:parameter[^>]*ac:name=\"code\">([\\s\\S]*?)<\\/ac:parameter>/\n      );\n      if (!codeMatch) continue;\n\n      const code = codeMatch[1].trim();\n      if (!code) continue;\n\n      // If it's code macro, check language\n      if (macroName === \"code\") {\n        const langMatch = macroContent.match(\n          /<ac:parameter[^>]*ac:name=\"language\">([\\s\\S]*?)<\\/ac:parameter>/\n        );\n        if (!langMatch || langMatch[1].trim() !== \"mermaid\") continue;\n      }\n\n      const type = this.detectMermaidType(code);\n      const diagramId = `mermaid-diagram-${index}`;\n\n      const diagramRecord = {\n        id: diagramId,\n        code: code,\n        originalCode: code,\n        originalMatch: match[0],\n        index: index,\n        type: type,\n        title: `${type.charAt(0).toUpperCase() + type.slice(1)} Diagram ${\n          index + 1\n        }`,\n      };\n\n      diagrams.push(diagramRecord);\n      diagramsMap.set(diagramId, {\n        content: code,\n        originCode: match[0], // Store original code for reference\n        type: type,\n        index: index,\n        title: diagramRecord.title,\n      });\n\n      console.log(`✅ match[0] for diagram ${index}:`, match[0]);\n\n      index++;\n    }\n\n    console.log(\"🎨 Extracted Mermaid diagrams:\", diagrams);\n    return { diagrams, diagramsMap };\n  }\n\n  /**\n   * Clean Mermaid code - remove unwanted characters and normalize\n   * @param {string} code - Raw Mermaid code\n   * @returns {string} Cleaned code\n   */\n  static cleanMermaidCode(code) {\n    if (!code) return \"\";\n\n    // Remove HTML entities\n    let cleaned = code\n      .replace(/&lt;/g, \"<\")\n      .replace(/&gt;/g, \">\")\n      .replace(/&amp;/g, \"&\")\n      .replace(/&quot;/g, '\"')\n      .replace(/&#39;/g, \"'\");\n\n    // Remove CDATA sections\n    cleaned = cleaned.replace(/<!\\[CDATA\\[(.*?)\\]\\]>/gs, \"$1\");\n\n    // Remove HTML tags\n    cleaned = cleaned.replace(/<[^>]*>/g, \"\");\n\n    // Normalize whitespace\n    cleaned = cleaned.replace(/\\r\\n/g, \"\\n\").replace(/\\r/g, \"\\n\");\n\n    // Remove excessive whitespace but preserve structure\n    cleaned = cleaned.replace(/\\n\\s*\\n\\s*\\n/g, \"\\n\\n\");\n\n    // Trim\n    cleaned = cleaned.trim();\n\n    return cleaned;\n  }\n\n  /**\n   * Validate Mermaid code syntax\n   * @param {string} code - Mermaid code to validate\n   * @returns {boolean} True if valid\n   */\n  static validateMermaidCode(code) {\n    if (!code || !code.trim()) {\n      return false;\n    }\n\n    const trimmed = code.trim();\n\n    // Check for valid Mermaid diagram types\n    const validStarters = [\n      \"graph\",\n      \"flowchart\",\n      \"sequenceDiagram\",\n      \"classDiagram\",\n      \"stateDiagram\",\n      \"erDiagram\",\n      \"journey\",\n      \"gantt\",\n      \"pie\",\n      \"gitgraph\",\n      \"mindmap\",\n      \"timeline\",\n      \"sankey\",\n      \"requirement\",\n    ];\n\n    const hasValidStarter = validStarters.some((starter) =>\n      trimmed.toLowerCase().startsWith(starter.toLowerCase())\n    );\n\n    if (!hasValidStarter) {\n      return false;\n    }\n\n    // Check for common syntax issues\n    if (trimmed.includes(\"undefined\") || trimmed.includes(\"null\")) {\n      return false;\n    }\n\n    return true;\n  }\n}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// K-Tool Extension Constants\nexport const EXTENSION_SETTINGS_KEY = \"extensionSettings\";\n\n// API URLs\nconst isLocal =\n  window.location.hostname === \"localhost\" ||\n  window.location.hostname === \"127.0.0.1\" ||\n  window.location.hostname.includes(\"localhost\");\nconst rootUrl = isLocal\n  ? \"http://localhost:5001\"\n  : \"https://gendoc.thangnotes.dev\";\n\n// Confluence API URLs (always localhost:8090 for Confluence)\nconst confluenceBaseUrl = \"http://localhost:8090\";\n\nexport const API_URLS = {\n  GEN_DOC: `${rootUrl}/api/generate-full-confluence-doc`,\n  GEN_DOC_STATUS: `${rootUrl}/api/generate-status`,\n  GEN_DOC_RESULT: `${rootUrl}/api/generate-result`,\n  EDIT_DIAGRAM: `${rootUrl}/api/edit-diagram`,\n  EDIT_MERMAID: `${rootUrl}/api/edit-mermaid`,\n  EDIT_TEXT: `${rootUrl}/api/edit-text`,\n  EDIT_HTML_CONTENT: `${rootUrl}/api/edit-html-content`,\n  CONVERT_HTML_TO_XHTML: `${rootUrl}/api/html-to-xhtml`,\n};\n\nexport const CONFLUENCE_API_URLS = {\n  MERMAID_DIAGRAM: `${confluenceBaseUrl}/rest/mermaidrest/1.0/mermaid/diagram`,\n  MERMAID_SAVE: `${confluenceBaseUrl}/rest/mermaidrest/1.0/mermaid/save`,\n  MERMAID_UPDATE: `${confluenceBaseUrl}/rest/mermaidrest/1.0/mermaid`, // /{pageId}\n  MERMAID_EDIT_REFERER: `${confluenceBaseUrl}/plugins/mermaid-cloud/editMermaidDiagram.action`,\n  TINYMCE_PLACEHOLDER: `${confluenceBaseUrl}/rest/tinymce/1/macro/placeholder`,\n};\n\n// Default settings\nexport const DEFAULT_SETTINGS = {\n  apiKey: \"\",\n  urlTemplate: \"\",\n  customPrompt: \"\",\n  documentUrl: \"\",\n  databaseUrl: \"\",\n  instructionUrl: \"\",\n  isEnabled: true,\n  selectedModel: \"sonar-pro\",\n};\n\n// AI Models\nexport const AI_MODELS = {\n  \"sonar-pro\": {\n    name: \"Sonar Pro\",\n    provider: \"Perplexity\",\n    description: \"Perplexity AI Sonar Pro model\",\n  },\n  gemini: {\n    name: \"Gemini 2.0 Flash\",\n    provider: \"Google\",\n    description: \"Google Gemini 2.0 Flash model\",\n  },\n};\n\n// Progress steps for document generation\nexport const PROGRESS_STEPS = [\n  { id: \"fetch\", label: \"Fetch BA Content\", status: \"pending\" },\n  { id: \"clone\", label: \"Clone Template\", status: \"pending\" },\n  { id: \"analyze\", label: \"Analyze Placeholders\", status: \"pending\" },\n  { id: \"generate\", label: \"AI Generate Document\", status: \"pending\" },\n  { id: \"complete\", label: \"Complete\", status: \"pending\" },\n];\n\n// Validation patterns\nexport const VALIDATION = {\n  URL_PATTERN: /^https?:\\/\\/.+/,\n  PLACEHOLDER_PATTERN: /<<([^>]+)>>/g,\n  MIN_PROMPT_LENGTH: 10,\n};\n","/**\n * Diagram processing utilities for Confluence page creation\n * Ported from extension/src/api/api.ts and extension/src/utils/mermaidExporter.ts\n */\nimport { MermaidRenderer } from \"../content/utils/mermaidRenderer.js\";\n\n/**\n * DiagramData interface equivalent for JavaScript\n * @typedef {Object} DiagramData\n * @property {string} filename - The filename for the diagram\n * @property {string} macroId - The macro ID\n * @property {string} diagramCode - The mermaid diagram code\n * @property {string} [svg] - The SVG content\n * @property {string} [png] - The PNG base64 content\n */\n\n/**\n * Extract diagrams from Confluence storage format - EXACT copy from extension\n * @param {string} storage - The storage format content\n * @returns {DiagramData[]} Array of extracted diagrams\n */\nexport function getDiagramConfluenceStyles(storage) {\n  let macroCounter = 1;\n  const extractedDiagrams = [];\n\n  // Find all mermaid macros in storage content\n  const mermaidRegex =\n    /<ac:structured-macro[^>]*ac:name=\"mermaid\"[^>]*>[\\s\\S]*?<ac:parameter[^>]*ac:name=\"code\"[^>]*>(?:<!\\[CDATA\\[([\\s\\S]*?)\\]\\]>|([\\s\\S]*?))<\\/ac:parameter>[\\s\\S]*?<\\/ac:structured-macro>/g;\n\n  let match;\n  while ((match = mermaidRegex.exec(storage)) !== null) {\n    const code = (match[1] || match[2] || \"\").trim();\n\n    if (code) {\n      extractedDiagrams.push({\n        filename: `k-tool-diagram-${macroCounter}`,\n        macroId: (110 + macroCounter).toString(),\n        diagramCode: code,\n      });\n      macroCounter++;\n    }\n  }\n\n  return extractedDiagrams;\n}\n\n/**\n * Load mermaid script dynamically if not already loaded\n * @returns {Promise<void>}\n */\nasync function loadMermaidScript() {\n  if (typeof window !== \"undefined\" && window.mermaid) {\n    return; // Already loaded\n  }\n\n  if (!window.mermaid) {\n    console.log(\"📦 Loading Mermaid library...\");\n    await MermaidRenderer.loadMermaidScript();\n  }\n  // Initialize mermaid if needed\n  if (window.mermaid && !window.mermaid.mermaidAPI) {\n    window.mermaid.initialize({\n      startOnLoad: false,\n      securityLevel: \"loose\",\n      theme: \"default\",\n    });\n  }\n}\n\n/**\n * Convert diagram code to SVG and PNG using mermaid - EXACT copy from extension\n * @param {DiagramData} diagram - The diagram data\n * @returns {Promise<DiagramData>} The diagram with SVG and PNG data\n */\nexport async function convertDiagramToSvgPng(diagram) {\n  try {\n    console.log(`🎨 Converting diagram to SVG/PNG: ${diagram.filename}`);\n    console.log(`🎨 Converting diagram to SVG/PNG: ${diagram.diagramCode}`);\n\n    // Ensure mermaid is loaded\n    await loadMermaidScript();\n\n    // Use mermaid to render SVG\n    const svgResult = await window.mermaid.render(\n      `diagram-${diagram.macroId}`,\n      diagram.diagramCode\n    );\n\n    // Handle different return types from mermaid.render\n    let svgContent;\n    if (typeof svgResult === \"string\") {\n      svgContent = svgResult;\n    } else if (svgResult && typeof svgResult === \"object\" && svgResult.svg) {\n      svgContent = svgResult.svg;\n    } else {\n      throw new Error(\"Invalid SVG result from mermaid.render\");\n    }\n\n    diagram.svg = svgContent;\n\n    // Convert SVG to PNG using canvas\n    const canvas = document.createElement(\"canvas\");\n    const ctx = canvas.getContext(\"2d\");\n    const img = new Image();\n\n    await new Promise((resolve, reject) => {\n      img.onload = () => {\n        canvas.width = img.width || 800;\n        canvas.height = img.height || 600;\n\n        if (ctx) {\n          ctx.fillStyle = \"white\";\n          ctx.fillRect(0, 0, canvas.width, canvas.height);\n          ctx.drawImage(img, 0, 0);\n          diagram.png = canvas.toDataURL(\"image/png\").split(\",\")[1]; // Remove data:image/png;base64,\n        }\n        resolve(true);\n      };\n\n      img.onerror = reject;\n      img.src =\n        \"data:image/svg+xml;base64,\" +\n        btoa(unescape(encodeURIComponent(svgContent)));\n    });\n\n    console.log(`✅ Successfully converted ${diagram.filename} to SVG/PNG`);\n    return diagram;\n  } catch (error) {\n    console.error(`❌ Failed to convert diagram ${diagram.filename}:`, error);\n\n    // Create fallback PNG data\n    diagram.png =\n      \"iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==\";\n    return diagram;\n  }\n}\n\n/**\n * Save diagram to mermaid-cloud API - EXACT copy from extension\n * @param {DiagramData} diagram - The diagram data\n * @param {string} pageId - The page ID\n * @returns {Promise<boolean>} Success status\n */\nexport async function saveDiagramToAPI(diagram, pageId) {\n  try {\n    console.log(\n      `💾 Saving diagram ${diagram.filename} to API for page ${pageId}`\n    );\n\n    const payload = {\n      filename: diagram.filename,\n      data: diagram.diagramCode,\n      svg: diagram.svg || \"\",\n      png: diagram.png || \"\",\n    };\n\n    const response = await fetch(`/rest/mermaidrest/1.0/mermaid/${pageId}`, {\n      method: \"POST\",\n      headers: {\n        Accept: \"application/json, text/javascript, */*; q=0.01\",\n        \"Content-Type\": \"application/json; charset=UTF-8\",\n        \"X-Requested-With\": \"XMLHttpRequest\",\n      },\n      body: JSON.stringify(payload),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error(\n        `❌ Failed to save diagram ${diagram.filename}:`,\n        response.status,\n        errorText\n      );\n      return false;\n    }\n\n    console.log(`✅ Successfully saved diagram ${diagram.filename} to API`);\n    return true;\n  } catch (error) {\n    console.error(`❌ Error saving diagram ${diagram.filename}:`, error);\n    return false;\n  }\n}\n\n/**\n * Process all extracted diagrams and save them to API sequentially - EXACT copy from extension\n * @param {string} pageId - The page ID\n * @param {DiagramData[]} extractedDiagrams - Array of diagrams to process\n * @returns {Promise<{success: number, total: number, errors: string[]}>} Processing result\n */\nexport async function processAndSaveDiagrams(pageId, extractedDiagrams) {\n  if (extractedDiagrams.length === 0) {\n    console.log(\"ℹ️ No diagrams to process\");\n    return { success: 0, total: 0, errors: [] };\n  }\n\n  console.log(\n    `🔄 Processing ${extractedDiagrams.length} diagrams for page ${pageId}`\n  );\n\n  let successCount = 0;\n  const errors = [];\n  const totalDiagrams = extractedDiagrams.length;\n\n  try {\n    // Convert all diagrams to SVG/PNG first\n    console.log(\"🎨 Converting diagrams to SVG/PNG...\");\n    const processedDiagrams = await Promise.all(\n      extractedDiagrams.map((diagram) => convertDiagramToSvgPng(diagram))\n    );\n\n    // Save diagrams sequentially (one by one)\n    console.log(\"💾 Saving diagrams sequentially...\");\n    for (let i = 0; i < processedDiagrams.length; i++) {\n      const diagram = processedDiagrams[i];\n      console.log(\n        `📊 Saving diagram ${i + 1}/${processedDiagrams.length}: ${\n          diagram.filename\n        }`\n      );\n\n      try {\n        const success = await saveDiagramToAPI(diagram, pageId);\n        if (success) {\n          successCount++;\n          console.log(\n            `✅ Diagram ${i + 1}/${processedDiagrams.length} saved successfully`\n          );\n        } else {\n          errors.push(`Failed to save diagram: ${diagram.filename}`);\n          console.error(\n            `❌ Diagram ${i + 1}/${processedDiagrams.length} failed to save`\n          );\n        }\n      } catch (error) {\n        const errorMsg = `Error saving diagram ${diagram.filename}: ${\n          error instanceof Error ? error.message : \"Unknown error\"\n        }`;\n        errors.push(errorMsg);\n        console.error(\n          `❌ Diagram ${i + 1}/${processedDiagrams.length} error:`,\n          error\n        );\n      }\n\n      // Add small delay between saves to avoid overwhelming the API\n      if (i < processedDiagrams.length - 1) {\n        await new Promise((resolve) => setTimeout(resolve, 500));\n      }\n    }\n  } catch (error) {\n    console.error(\"❌ Error during diagram processing:\", error);\n    errors.push(\n      `Processing error: ${\n        error instanceof Error ? error.message : \"Unknown error\"\n      }`\n    );\n  }\n\n  const result = {\n    success: successCount,\n    total: totalDiagrams,\n    errors,\n  };\n\n  console.log(\n    `📊 Diagram processing complete: ${successCount}/${totalDiagrams} successful`\n  );\n  if (errors.length > 0) {\n    console.warn(\"⚠️ Diagram processing errors:\", errors);\n  }\n\n  return result;\n}\n","// API utilities for K-Tool Extension\nimport { API_URLS } from \"./constants.js\";\nimport {\n  getDiagramConfluenceStyles,\n  processAndSaveDiagrams,\n} from \"./diagramUtils.js\";\n\nexport class ApiClient {\n  /**\n   * Make HTTP request with error handling\n   * @param {string} url - Request URL\n   * @param {Object} options - Fetch options\n   * @returns {Promise<Object>} Response data\n   */\n  static async request(url, options = {}) {\n    try {\n      const response = await fetch(url, {\n        headers: {\n          \"Content-Type\": \"application/json\",\n          ...options.headers,\n        },\n        ...options,\n      });\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      return { success: true, data };\n    } catch (error) {\n      console.error(\"API request failed:\", error);\n      return { success: false, error: error.message };\n    }\n  }\n\n  /**\n   * Generate document from BA content\n   * @param {Object} payload - Generation payload\n   * @returns {Promise<Object>} Job response\n   */\n  static async generateDocument(payload) {\n    return await this.request(API_URLS.GEN_DOC, {\n      method: \"POST\",\n      body: JSON.stringify(payload),\n    });\n  }\n\n  /**\n   * Check generation status\n   * @param {string} jobId - Job ID to check\n   * @returns {Promise<Object>} Status response\n   */\n  static async checkStatus(jobId) {\n    return await this.request(`${API_URLS.GEN_DOC_STATUS}?job_id=${jobId}`);\n  }\n\n  /**\n   * Get generation result\n   * @param {string} jobId - Job ID to get result\n   * @returns {Promise<Object>} Result response\n   */\n  static async getResult(jobId) {\n    return await this.request(`${API_URLS.GEN_DOC_RESULT}?job_id=${jobId}`);\n  }\n\n  /**\n   * Edit text using AI\n   * @param {Object} payload - Edit payload\n   * @returns {Promise<Object>} Edit response\n   */\n  static async editText(payload) {\n    return await this.request(API_URLS.EDIT_TEXT, {\n      method: \"POST\",\n      body: JSON.stringify(payload),\n    });\n  }\n\n  /**\n   * Convert HTML to XHTML using BeautifulSoup\n   * @param {string} htmlContent - HTML content to convert\n   * @returns {Promise<Object>} Conversion response with XHTML content\n   */\n  static async convertHtmlToXhtml(htmlContent) {\n    console.log(\"🔄 Converting HTML to XHTML...\");\n    console.log(\"📄 HTML content length:\", htmlContent?.length || 0);\n    console.log(\"🔗 API URL:\", API_URLS.CONVERT_HTML_TO_XHTML);\n\n    try {\n      const result = await this.request(API_URLS.CONVERT_HTML_TO_XHTML, {\n        method: \"POST\",\n        body: JSON.stringify({\n          content: htmlContent,\n        }),\n      });\n\n      console.log(\"✅ HTML to XHTML conversion result:\", result);\n      return result;\n    } catch (error) {\n      console.error(\"❌ HTML to XHTML conversion error:\", error);\n      console.error(\"❌ Error details:\", {\n        name: error.name,\n        message: error.message,\n        stack: error.stack,\n      });\n\n      // Return error in expected format\n      return {\n        success: false,\n        error: error.message,\n      };\n    }\n  }\n}\n\n/**\n * Confluence API utilities\n */\nexport class ConfluenceApi {\n  /**\n   * Extract page ID from Confluence URL\n   * @param {string} url - Confluence page URL\n   * @returns {string|null} Page ID or null\n   */\n  static extractPageId(url) {\n    const patterns = [/\\/pages\\/(\\d+)/, /pageId=(\\d+)/, /\\/(\\d+)$/];\n\n    for (const pattern of patterns) {\n      const match = url.match(pattern);\n      if (match) return match[1];\n    }\n\n    return null;\n  }\n\n  /**\n   * Get current space key from page\n   * @returns {string|null} Space key or null\n   */\n  static getCurrentSpaceKey() {\n    // Try to get space key from various sources\n    const spaceKeyMeta = document.querySelector('meta[name=\"ajs-space-key\"]');\n    if (spaceKeyMeta) return spaceKeyMeta.content;\n\n    const spaceKeyElement = document.querySelector(\"[data-space-key]\");\n    if (spaceKeyElement) return spaceKeyElement.dataset.spaceKey;\n\n    // Try to extract from URL\n    const urlMatch = window.location.pathname.match(/\\/spaces\\/([^\\/]+)/);\n    if (urlMatch) return urlMatch[1];\n\n    return null;\n  }\n\n  /**\n   * Fetch page content from Confluence\n   * @param {string} pageId - Page ID to fetch\n   * @returns {Promise<Object>} Page content with title, content (view), and storageFormat\n   */\n  static async fetchPageContent(pageId) {\n    try {\n      console.log(\"🔍 Fetching Confluence content for pageId:\", pageId);\n\n      const apiUrl = `/rest/api/content/${pageId}?expand=body.storage,body.view`;\n\n      const response = await fetch(apiUrl, {\n        method: \"GET\",\n        headers: {\n          Accept: \"application/json\",\n          \"Content-Type\": \"application/json\",\n        },\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(\"❌ API Error:\", response.status, errorText);\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      console.log(\"📄 Content data received:\", {\n        id: data.id,\n        title: data.title,\n        hasStorage: !!data.body?.storage?.value,\n        hasView: !!data.body?.view?.value,\n      });\n\n      return {\n        title: data.title,\n        content: data.body?.view?.value || \"\",\n        storageFormat: data.body?.storage?.value || \"\",\n      };\n    } catch (error) {\n      console.error(\"❌ Error fetching Confluence content:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * Clone template from URL for document generation\n   * @param {string} url - Template URL\n   * @returns {Promise<Object>} Cloned template data\n   */\n  static async cloneTemplateForGeneration(url) {\n    try {\n      console.log(\"🔍 Cloning template from URL:\", url);\n\n      if (!url || !url.trim()) {\n        console.error(\"❌ Empty URL provided\");\n        throw new Error(\"URL template không được để trống\");\n      }\n\n      // Extract pageId from URL\n      const pageId = this.extractPageIdFromUrl(url);\n      if (!pageId) {\n        console.error(\"❌ No pageId found in URL\");\n        throw new Error(\n          \"URL không chứa pageId hợp lệ. Vui lòng kiểm tra lại URL template.\"\n        );\n      }\n\n      console.log(\"📋 Fetching template pageId:\", pageId);\n      const apiUrl = `/rest/api/content/${pageId}?expand=body.storage`;\n\n      const response = await fetch(apiUrl, {\n        method: \"GET\",\n        headers: {\n          Accept: \"application/json\",\n          \"Content-Type\": \"application/json\",\n        },\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(\"❌ API Error:\", response.status, errorText);\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      console.log(\"📄 Template data received:\", {\n        id: data.id,\n        title: data.title,\n        hasStorage: !!data.body?.storage?.value,\n      });\n\n      if (!data.body?.storage?.value) {\n        console.error(\"❌ No storage content found in response\");\n        throw new Error(\"Template không có nội dung storage format\");\n      }\n\n      const originalStorageFormat = data.body.storage.value;\n      console.log(\n        \"📄 Original storage format length:\",\n        originalStorageFormat.length\n      );\n\n      const { templateStructure, analysisInfo } = this.extractTemplateStructure(\n        originalStorageFormat\n      );\n\n      const result = {\n        title: data.title,\n        originalStorageFormat,\n        templateStructure,\n        analysisInfo,\n      };\n\n      console.log(\"✅ Template cloned successfully:\", {\n        title: result.title,\n        originalLength: originalStorageFormat.length,\n        structureLength: templateStructure.length,\n        analysis: analysisInfo,\n      });\n\n      return result;\n    } catch (error) {\n      console.error(\"❌ Error cloning template:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * Extract template structure and analyze placeholders\n   * @param {string} storageFormat - Original storage format\n   * @returns {Object} Template structure and analysis info\n   */\n  static extractTemplateStructure(storageFormat) {\n    let emptyParagraphs = 0;\n    let emptyTableCells = 0;\n    let placeholders = 0;\n\n    console.log(\"🔍 Extracting template structure...\");\n\n    const placeholderPatterns = [\n      /(<<.*?>>)/g,\n      /(\\{\\{.*?\\}\\})/g,\n      /(&lt;&lt;.*?&gt;&gt;)/g,\n      /(\\u003c\\u003c.*?\\u003e\\u003e)/g,\n    ];\n\n    let structure = storageFormat;\n\n    placeholderPatterns.forEach((regex, index) => {\n      const matches = [...structure.matchAll(regex)];\n      console.log(\n        `🎯 Placeholder pattern ${index + 1} found ${matches.length} matches`\n      );\n      placeholders += matches.length;\n    });\n\n    // Count empty paragraphs and table cells\n    emptyParagraphs = (storageFormat.match(/<p[^>]*>\\s*<\\/p>/g) || []).length;\n    emptyTableCells = (storageFormat.match(/<td[^>]*>\\s*<\\/td>/g) || []).length;\n\n    const analysisInfo = {\n      emptyParagraphs,\n      emptyTableCells,\n      placeholders,\n      totalLength: storageFormat.length,\n    };\n\n    return {\n      templateStructure: structure,\n      analysisInfo,\n    };\n  }\n\n  /**\n   * Extract pageId from various URL formats\n   * @param {string} url - URL to extract pageId from\n   * @returns {string|null} Page ID or null\n   */\n  static extractPageIdFromUrl(url) {\n    const patterns = [\n      /\\/pages\\/(\\d+)/,\n      /pageId=(\\d+)/,\n      /\\/(\\d+)$/,\n      /viewpage\\.action\\?pageId=(\\d+)/,\n    ];\n\n    for (const pattern of patterns) {\n      const match = url.match(pattern);\n      if (match) return match[1];\n    }\n\n    return null;\n  }\n\n  /**\n   * Extract placeholders from content (<<placeholder>> format)\n   * @param {string} content - Content to analyze\n   * @returns {Array} Array of placeholder strings\n   */\n  static extractPlaceholders(content) {\n    console.log(\"🔍 Analyzing content for placeholders...\");\n    console.log(\"📄 Content length:\", content.length);\n    console.log(\n      \"📄 Content preview (first 500 chars):\",\n      content.substring(0, 500)\n    );\n\n    // Helper function to decode HTML entities\n    const decodeHtmlEntities = (str) => {\n      return str\n        .replace(/&lt;/g, \"<\")\n        .replace(/&gt;/g, \">\")\n        .replace(/&amp;/g, \"&\")\n        .replace(/&quot;/g, '\"')\n        .replace(/&#39;/g, \"'\");\n    };\n\n    const decodedContent = decodeHtmlEntities(content);\n\n    // Patterns to find placeholders\n    const patterns = [\n      /<<([^>]+)>>/g, // Normal <<placeholder>>\n      /&lt;&lt;([^&]+)&gt;&gt;/g, // HTML encoded &lt;&lt;placeholder&gt;&gt;\n    ];\n\n    let allMatches = [];\n\n    // Test patterns on both original and decoded content\n    [content, decodedContent].forEach((testContent, contentIndex) => {\n      console.log(\n        `🔍 Testing on ${\n          contentIndex === 0 ? \"original\" : \"decoded\"\n        } content...`\n      );\n\n      patterns.forEach((regex, patternIndex) => {\n        const matches = [...testContent.matchAll(regex)];\n        console.log(\n          `🎯 Pattern ${patternIndex + 1} found ${matches.length} matches:`,\n          matches.map((m) => m[0])\n        );\n\n        if (patternIndex === 1) {\n          // For HTML encoded, decode back to normal format\n          allMatches.push(...matches.map((match) => `<<${match[1]}>>`));\n        } else {\n          allMatches.push(...matches.map((match) => match[0]));\n        }\n      });\n    });\n\n    // Remove duplicates\n    const uniquePlaceholders = [...new Set(allMatches)];\n    console.log(\"🎯 Unique placeholders found:\", uniquePlaceholders);\n\n    return uniquePlaceholders;\n  }\n\n  /**\n   * Extract images from HTML content and convert to base64\n   * @param {string} html - HTML content\n   * @returns {Promise<Array>} Array of image objects with base64 data\n   */\n  static async extractImagesFromHtml(html) {\n    const images = [];\n    try {\n      const parser = new DOMParser();\n      const doc = parser.parseFromString(html, \"text/html\");\n      const imgTags = doc.querySelectorAll(\"img\");\n\n      for (const img of Array.from(imgTags)) {\n        const src = img.getAttribute(\"src\");\n        let filename = undefined;\n\n        if (src) {\n          let base64src = src;\n\n          if (!src.startsWith(\"data:image\")) {\n            // Convert URL to base64 and get filename\n            const { base64, filename: fname } = await this.urlToBase64(src);\n            if (base64) {\n              base64src = base64;\n              filename = fname;\n            } else continue; // skip if failed\n          } else {\n            // If already base64, get name from alt or set default\n            filename = img.getAttribute(\"alt\")\n              ? img.getAttribute(\"alt\") + \".png\"\n              : `image_${Date.now()}.png`;\n          }\n\n          images.push({\n            src: base64src,\n            alt: img.getAttribute(\"alt\") || undefined,\n            filename,\n          });\n        }\n      }\n    } catch (e) {\n      console.warn(\"extractImagesFromHtml error:\", e);\n    }\n    return images;\n  }\n\n  /**\n   * Convert image URL to base64\n   * @param {string} url - Image URL\n   * @returns {Promise<Object>} Object with base64 data and filename\n   */\n  static async urlToBase64(url) {\n    try {\n      const response = await fetch(url);\n      if (!response.ok)\n        return { base64: null, filename: this.getFilenameFromUrl(url) };\n\n      const blob = await response.blob();\n      const filename = this.getFilenameFromUrl(url);\n\n      return await new Promise((resolve, reject) => {\n        const reader = new FileReader();\n        reader.onloadend = () => resolve({ base64: reader.result, filename });\n        reader.onerror = reject;\n        reader.readAsDataURL(blob);\n      });\n    } catch (e) {\n      console.warn(\"urlToBase64 error:\", e);\n      return { base64: null, filename: this.getFilenameFromUrl(url) };\n    }\n  }\n\n  /**\n   * Get filename from URL\n   * @param {string} url - URL to extract filename from\n   * @returns {string} Filename\n   */\n  static getFilenameFromUrl(url) {\n    try {\n      const urlObj = new URL(url);\n      const pathname = urlObj.pathname;\n      return (\n        pathname.substring(pathname.lastIndexOf(\"/\") + 1) ||\n        `image_${Date.now()}`\n      );\n    } catch {\n      return `image_${Date.now()}`;\n    }\n  }\n\n  /**\n   * Validate and clean page title to prevent font/encoding issues\n   */\n  static validateAndCleanTitle(title) {\n    return (\n      title\n        // Remove control characters and invalid XML characters\n        .replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, \"\")\n        // Fix common encoding issues\n        .replace(/â€™/g, \"'\")\n        .replace(/â€œ/g, '\"')\n        .replace(/â€/g, '\"')\n        .replace(/â€¦/g, \"...\")\n        // Clean up whitespace\n        .replace(/\\s+/g, \" \")\n        .trim() ||\n      // Ensure title is not empty and has reasonable length\n      `Generated Document - ${new Date().toLocaleDateString()}`\n    );\n  }\n\n  /**\n   * Ensure UTF-8 encoding for content\n   */\n  static ensureUtf8Encoding(content) {\n    try {\n      // Try to encode and decode to ensure proper UTF-8\n      const encoder = new TextEncoder();\n      const decoder = new TextDecoder(\"utf-8\", { fatal: false });\n      const encoded = encoder.encode(content);\n      return decoder.decode(encoded);\n    } catch (error) {\n      console.warn(\"UTF-8 encoding issue, using original content:\", error);\n      return content;\n    }\n  }\n\n  /**\n   * Basic content cleanup - EXACT copy from extension/src/api/api.ts\n   */\n  static basicContentCleanup(content) {\n    return (\n      content\n        // Remove code block prefixes\n        .replace(/^```\\w*\\s*/g, \"\")\n        .replace(/```\\s*$/g, \"\")\n        .trim()\n\n        // Enhanced character cleanup for Vietnamese and UTF-8\n        .replace(/^\\uFEFF/, \"\") // Remove BOM\n        .replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, \"\") // Remove control characters\n\n        // Fix common encoding issues\n        .replace(/â€™/g, \"'\") // Smart apostrophe\n        .replace(/â€œ/g, '\"') // Smart quote open\n        .replace(/â€/g, '\"') // Smart quote close\n        .replace(/â€¦/g, \"...\") // Ellipsis\n        .replace(/â€\"/g, \"–\") // En dash\n        .replace(/â€\"/g, \"—\") // Em dash\n\n        // Clean up line breaks and whitespace\n        .replace(/\\r\\n/g, \"\\n\")\n        .replace(/\\r/g, \"\\n\")\n        .replace(/\\n{3,}/g, \"\\n\\n\") // Max 2 consecutive line breaks\n        .replace(/[ \\t]+$/gm, \"\") // Remove trailing whitespace from lines\n        .replace(/^[ \\t]+/gm, \"\") // Remove leading whitespace from lines (but preserve structure)\n        .trim()\n    );\n  }\n\n  /**\n   * Advanced HTML sanitization - EXACT copy from extension/src/api/api.ts\n   */\n  static advancedHTMLSanitization(content) {\n    console.log(\"🔬 Starting advanced HTML sanitization...\");\n\n    // Step 1: Preprocess content to fix obvious issues\n    let processedContent = content\n      // Fix unclosed self-closing tags first\n      .replace(\n        /<(br|hr|img|input|meta|link|area|base|col|embed|source|track|wbr)([^>]*?)(?<!\\/)\\s*>/gi,\n        \"<$1$2/>\"\n      )\n      // Ensure proper quotes around attributes\n      .replace(/(\\w+)=([^\"\\s>]+)(\\s|>)/g, '$1=\"$2\"$3')\n      // Fix common encoding issues before processing\n      .replace(/&(?![a-zA-Z0-9#]+;)/g, \"&amp;\")\n      // Remove any null bytes or control characters\n      .replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, \"\")\n      // Fix common Vietnamese encoding issues\n      .replace(/â€™/g, \"'\")\n      .replace(/â€œ/g, '\"')\n      .replace(/â€/g, '\"');\n\n    // Step 2: Basic structure validation and cleanup\n    let finalHTML = processedContent\n      // Remove empty tags that could cause issues (but keep non-breaking spaces)\n      .replace(/<(\\w+)([^>]*?)>\\s*<\\/\\1>/g, (match, tagName) => {\n        // Keep paragraph and cell tags with nbsp\n        if ([\"p\", \"td\", \"th\", \"li\"].includes(tagName.toLowerCase())) {\n          return `<${tagName}>&nbsp;</${tagName}>`;\n        }\n        return \"\"; // Remove other empty tags\n      })\n      .replace(/>\\s+</g, \"><\") // Remove spaces between tags\n      .replace(/\\s+/g, \" \") // Normalize whitespace\n      .trim();\n\n    console.log(\"✅ Advanced HTML sanitization complete\");\n    console.log(\n      `📊 Original length: ${content.length}, Final length: ${finalHTML.length}`\n    );\n\n    return finalHTML;\n  }\n\n  /**\n   * Convert all macros to mermaid-cloud macros - EXACT copy from extension/src/api/api.ts\n   */\n  static convertToMermaidCloudMacros(content) {\n    console.log(\"🔄 Converting all macros to mermaid-cloud macros...\");\n    let macroCounter = 1;\n    let macroId = 111;\n\n    // Replace all structured macros (mermaid, code, etc.) with mermaid-cloud macros\n    const convertedContent = content.replace(\n      /<ac:structured-macro[^>]*>[\\s\\S]*?<\\/ac:structured-macro>/g,\n      (match) => {\n        const filename = `k-tool-diagram-${macroCounter}`;\n        const currentId = macroId.toString();\n        macroCounter++;\n        macroId++;\n\n        console.log(\n          `🔧 Converting macro ${\n            macroCounter - 1\n          } to mermaid-cloud: ${filename}`\n        );\n\n        return `<ac:structured-macro ac:name=\"mermaid-cloud\" ac:schema-version=\"1\" ac:macro-id=\"${currentId}\">\n<ac:parameter ac:name=\"toolbar\">bottom</ac:parameter>\n<ac:parameter ac:name=\"filename\">${filename}</ac:parameter>\n<ac:parameter ac:name=\"format\">svg</ac:parameter>\n<ac:parameter ac:name=\"zoom\">fit</ac:parameter>\n<ac:parameter ac:name=\"revision\">1</ac:parameter>\n</ac:structured-macro>`;\n      }\n    );\n\n    console.log(`✅ Converted ${macroCounter - 1} macros to mermaid-cloud`);\n    return convertedContent;\n  }\n\n  /**\n   * Validate and fix XML content specifically for Confluence storage format\n   */\n  static validateAndFixXML(content) {\n    let fixed = content;\n\n    console.log(\"🔍 Validating and fixing XML content...\");\n\n    // Fix the specific issue mentioned in error: spaces in tag names\n    fixed = fixed\n      // Remove spaces at the beginning of tag names\n      .replace(/<\\s+([a-zA-Z])/g, \"<$1\")\n      // Remove spaces at the end of tag names (before attributes or closing >)\n      .replace(/([a-zA-Z])\\s+([^>]*>)/g, \"$1 $2\")\n      // Fix spaces in closing tags\n      .replace(/<\\/\\s+([a-zA-Z][^>]*?)>/g, \"</$1>\")\n      // Fix malformed attributes with spaces\n      .replace(/([a-zA-Z-]+)\\s*=\\s*\"([^\"]*)\"/g, '$1=\"$2\"')\n      // Remove multiple consecutive spaces in content\n      .replace(/\\s{2,}/g, \" \")\n      // Fix line breaks that might cause parsing issues\n      .replace(/\\r\\n/g, \"\\n\")\n      .replace(/\\r/g, \"\\n\");\n\n    // Validate specific Confluence storage format requirements\n    fixed = fixed\n      // Ensure proper ac: namespace usage\n      .replace(/<ac:([^>]+)>/g, (match, content) => {\n        return `<ac:${content.trim()}>`;\n      })\n      // Fix structured macro formatting\n      .replace(/<ac:structured-macro\\s+([^>]+)>/g, (match, attrs) => {\n        const cleanAttrs = attrs.trim().replace(/\\s+/g, \" \");\n        return `<ac:structured-macro ${cleanAttrs}>`;\n      })\n      // Ensure CDATA sections are properly formatted\n      .replace(/<!\\[CDATA\\[\\s*([\\s\\S]*?)\\s*\\]\\]>/g, \"<![CDATA[$1]]>\");\n\n    console.log(\"✅ XML validation and fixing complete\");\n    return fixed;\n  }\n\n  /**\n   * Create new Confluence page - EXACT copy logic from createPageFromGeneratedContent\n   * @param {string} title - Page title\n   * @param {string} fullStorageFormat - Page content (storage format)\n   * @param {string} spaceKey - Space key\n   * @param {string} parentPageId - Parent page ID (optional)\n   * @returns {Promise<void>} No return value, same as createPageFromGeneratedContent\n   */\n  static async createPage(\n    title,\n    fullStorageFormat,\n    spaceKey,\n    parentPageId = null\n  ) {\n    try {\n      console.log(\"🔄 Creating page from generated content...\");\n\n      // Step 0: Validate and clean title\n      const cleanTitle = this.validateAndCleanTitle(title);\n      console.log(\"📋 Original title:\", title);\n      console.log(\"📋 Clean title:\", cleanTitle);\n      console.log(\"📋 Space:\", spaceKey);\n      console.log(\"📋 Content length:\", fullStorageFormat.length);\n\n      // Step 0.5: Ensure UTF-8 encoding\n      const utf8Content = this.ensureUtf8Encoding(fullStorageFormat);\n      console.log(\"🔤 UTF-8 validation complete\");\n\n      // Show content preview for debugging\n      console.log(\"📄 Content preview (first 200 chars):\");\n      console.log(utf8Content.substring(0, 200));\n\n      // Step 1: Enhanced content cleanup with Vietnamese support\n      console.log(\"🧹 Starting enhanced content cleanup...\");\n      let processedContent = this.basicContentCleanup(utf8Content);\n\n      // Step 2: Advanced HTML sanitization and validation\n      console.log(\"🔬 Performing advanced HTML sanitization...\");\n      processedContent = this.advancedHTMLSanitization(processedContent);\n\n      // Step 3: Convert all macros to mermaid-cloud macros\n      console.log(\"🔄 Converting macros to mermaid-cloud...\");\n      processedContent = this.convertToMermaidCloudMacros(processedContent);\n\n      const finalContent = processedContent;\n      console.log(\"✅ Content processing complete\");\n      console.log(\"📄 Final content length:\", finalContent.length);\n      console.log(\"📄 Final content preview (first 200 chars):\");\n      console.log(finalContent.substring(0, 200));\n\n      // Create the page payload with clean title\n      const createPayload = {\n        type: \"page\",\n        title: cleanTitle.trim() + \"-\" + Date.now(), // Use clean title with timestamp\n        space: { key: spaceKey },\n        body: {\n          storage: {\n            value: finalContent,\n            representation: \"storage\",\n          },\n        },\n      };\n\n      // Add parent page if specified\n      if (parentPageId) {\n        createPayload.ancestors = [{ id: parentPageId }];\n        console.log(\"📁 Setting parent page ID:\", parentPageId);\n      }\n\n      console.log(\"📤 Sending page creation request...\");\n      const response = await fetch(\"/rest/api/content\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json; charset=utf-8\",\n          Accept: \"application/json\",\n          \"X-Atlassian-Token\": \"no-check\",\n        },\n        body: JSON.stringify(createPayload),\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(\"❌ Page creation failed:\", errorText);\n\n        let errorMessage = `HTTP ${response.status}: ${response.statusText}`;\n\n        try {\n          const errorJson = JSON.parse(errorText);\n          if (errorJson.message) {\n            errorMessage = errorJson.message;\n          }\n\n          if (errorJson.errors && Array.isArray(errorJson.errors)) {\n            const detailedErrors = errorJson.errors\n              .map(\n                (err) =>\n                  `${err.field || \"Unknown field\"}: ${err.message || err}`\n              )\n              .join(\"\\n\");\n            errorMessage += `\\n\\nDetailed errors:\\n${detailedErrors}`;\n          }\n        } catch (parseError) {\n          console.warn(\"Could not parse error response as JSON\");\n          errorMessage += `\\n\\nRaw error: ${errorText}`;\n        }\n\n        throw new Error(errorMessage);\n      }\n\n      const result = await response.json();\n      console.log(\"✅ Page created successfully!\");\n      console.log(\"📄 Page ID:\", result.id);\n      console.log(\"🔗 Page URL:\", result._links?.webui);\n\n      let finalMessage = `✅ Tạo tài liệu thành công!\\n\\nTiêu đề: ${result.title}\\nPage ID: ${result.id}`;\n      const extractedDiagrams = getDiagramConfluenceStyles(fullStorageFormat);\n      console.log(\n        `📊 Extracted ${extractedDiagrams.length} diagrams from content`\n      );\n      // Process and save diagrams after page creation\n      if (extractedDiagrams.length > 0) {\n        console.log(\"🎨 Processing extracted diagrams...\");\n        const diagramResult = await processAndSaveDiagrams(\n          result.id,\n          extractedDiagrams\n        );\n\n        // Add diagram processing result to message\n        if (diagramResult.total > 0) {\n          finalMessage += `\\n\\n📊 Diagrams: ${diagramResult.success}/${diagramResult.total} saved successfully`;\n\n          if (diagramResult.errors.length > 0) {\n            finalMessage += `\\n⚠️ Diagram errors:\\n${diagramResult.errors.join(\n              \"\\n\"\n            )}`;\n          }\n        }\n      }\n\n      // Show final result after everything is complete\n      if (typeof window !== \"undefined\" && window[\"KToolNotificationUtils\"]) {\n        window[\"KToolNotificationUtils\"].success(\n          \"Trang đã được tạo thành công!\",\n          finalMessage.replace(/^✅\\s*/, \"\")\n        );\n      }\n\n      if (result._links?.webui) {\n        const fullUrl = `${window.location.origin}${result._links.webui}`;\n        window.open(fullUrl, \"_blank\");\n      }\n    } catch (error) {\n      console.error(\"❌ Error creating page:\", error);\n\n      let userMessage = \"Lỗi khi tạo trang Confluence.\";\n\n      if (error instanceof Error) {\n        if (error.message.includes(\"validation failed\")) {\n          userMessage = `❌ Nội dung không hợp lệ:\\n\\n${error.message}`;\n        } else if (error.message.includes(\"HTTP 400\")) {\n          userMessage =\n            \"❌ Dữ liệu không hợp lệ. Vui lòng kiểm tra lại nội dung.\";\n        } else if (error.message.includes(\"HTTP 401\")) {\n          userMessage = \"❌ Không có quyền truy cập. Vui lòng đăng nhập lại.\";\n        } else if (error.message.includes(\"HTTP 403\")) {\n          userMessage = \"❌ Không có quyền tạo trang trong space này.\";\n        } else {\n          userMessage = `❌ ${error.message}`;\n        }\n      }\n\n      if (typeof window !== \"undefined\" && window[\"KToolNotificationUtils\"]) {\n        window[\"KToolNotificationUtils\"].error(\n          \"Lỗi tạo trang\",\n          userMessage.replace(/^❌\\s*/, \"\")\n        );\n      }\n      throw error;\n    }\n  }\n}\n","// XML/XHTML Formatting Utilities\n// Handles XML parsing, formatting and validation\n\nexport class XMLFormatter {\n  /**\n   * Format XHTML for better readability with proper alignment\n   * @param {string} xmlString - Raw XML/XHTML string\n   * @param {string} indent - Indentation string (default: 4 spaces)\n   * @returns {string} Formatted XML/XHTML string\n   */\n  static formatXHTML(xmlString, indent = \"    \") {\n    console.log(\"🔍 XMLFormatter input:\", {\n      length: xmlString.length,\n      hasUL: xmlString.includes(\"<ul\"),\n      hasOL: xmlString.includes(\"<ol\"),\n      hasLI: xmlString.includes(\"<li\"),\n      preview: xmlString.substring(0, 300),\n    });\n    // 1. Parse string into DOM tree\n    const parser = new DOMParser();\n\n    // Wrap content with temporary root tag if it's just a fragment\n    const rootTag = \"xml-root-fragment\";\n    const wrappedXml = `<${rootTag}>${xmlString}</${rootTag}>`;\n\n    const doc = parser.parseFromString(wrappedXml, \"text/xml\");\n\n    // Check for parsing errors\n    const parseErrors = doc.getElementsByTagName(\"parsererror\");\n    if (parseErrors.length > 0) {\n      console.warn(\"XML/XHTML parsing error. Returning original string.\", {\n        error: parseErrors[0]?.textContent || \"Unknown parsing error\",\n        originalLength: xmlString.length,\n        sample: xmlString.substring(0, 100) + \"...\",\n      });\n      return xmlString;\n    }\n\n    let output = \"\";\n    let currentIndent = \"\";\n\n    // Get wrapped root element (only process its children)\n    const rootElement = doc.documentElement;\n\n    /**\n     * Recursive function to traverse and rebuild string\n     * @param {Node} node - Current node\n     * @param {string} level - Current indentation level\n     */\n    function processNode(node, level) {\n      switch (node.nodeType) {\n        case Node.ELEMENT_NODE: // 1: HTML/XML tags (e.g., <p>, <ac:structured-macro>)\n          const nodeName = node.nodeName;\n\n          // Start tag (e.g., <p data=\"...\">)\n          let startTag = `<${nodeName}`;\n\n          // Add attributes\n          if (node.attributes && node.attributes.length > 0) {\n            for (let attr of node.attributes) {\n              startTag += ` ${attr.name}=\"${attr.value}\"`;\n            }\n          }\n          startTag += \">\";\n\n          // Check if tag has children (excluding empty TextNodes)\n          const hasSignificantChildren = Array.from(node.childNodes).some(\n            (child) =>\n              child.nodeType !== Node.TEXT_NODE ||\n              child.textContent.trim().length > 0\n          );\n\n          if (!hasSignificantChildren) {\n            // Handle self-closing or empty tags (e.g., <br />)\n            // Note: In XHTML, <tag></tag> is more common than <tag />\n            // Here we use common logic: Open tag, close tag on same line\n            output += `${level}${startTag.replace(\">\", \"/>\")}\\n`;\n          } else {\n            // Open tag on new line\n            output += `${level}${startTag}\\n`;\n\n            // Increase indentation level and process children\n            const nextLevel = level + indent;\n            Array.from(node.childNodes).forEach((child) =>\n              processNode(child, nextLevel)\n            );\n\n            // Close tag on new line with old indentation level\n            output += `${level}</${nodeName}>\\n`;\n          }\n          break;\n\n        case Node.TEXT_NODE: // 3: Text content\n          const text = node.textContent.trim();\n          if (text.length > 0) {\n            // Handle plain text (e.g., content inside <p>)\n            // If it's plain text, add it to current line or new line\n            output += `${level}${text}\\n`;\n          }\n          break;\n\n        case Node.COMMENT_NODE: // 8: Comment (e.g., <!-- comment -->)\n          output += `${level}<!--${node.textContent}-->\\n`;\n          break;\n\n        case Node.CDATA_SECTION_NODE: // 4: CDATA Section (Safe for code in <ac:parameter>)\n          // This is the most important case for Mermaid content\n          output += `${level}<![CDATA[${node.textContent}]]>\\n`;\n          break;\n\n        // You can add other cases like DOCUMENT_TYPE_NODE, PROCESSING_INSTRUCTION_NODE if needed\n      }\n    }\n\n    // Start processing from children of temporary root tag\n    Array.from(rootElement.childNodes).forEach((node) =>\n      processNode(node, currentIndent)\n    );\n\n    const result = output.trim();\n\n    console.log(\"🔍 XMLFormatter output:\", {\n      length: result.length,\n      hasUL: result.includes(\"<ul\"),\n      hasOL: result.includes(\"<ol\"),\n      hasLI: result.includes(\"<li\"),\n      preview: result.substring(0, 300),\n      whitespaceCount: (result.match(/\\s/g) || []).length,\n    });\n\n    return result;\n  }\n\n  /**\n   * Check if a tag is self-closing\n   * @param {string} tag - HTML tag string\n   * @returns {boolean} True if self-closing\n   */\n  static isSelfClosingTag(tag) {\n    const selfClosing = [\n      \"br\",\n      \"hr\",\n      \"img\",\n      \"input\",\n      \"meta\",\n      \"link\",\n      \"source\",\n      \"track\",\n      \"wbr\",\n    ];\n    return selfClosing.some((t) => tag.startsWith(`<${t}`));\n  }\n\n  /**\n   * Clean up XML markers from content\n   * @param {string} content - Content with XML markers\n   * @returns {string} Cleaned content\n   */\n  static cleanXMLMarkers(content) {\n    if (!content) return \"\";\n\n    // Remove ```xml and ``` markers\n    let cleaned = content.replace(/^```xml\\s*\\n?/gm, \"\");\n    cleaned = cleaned.replace(/\\n?```\\s*$/gm, \"\");\n\n    return cleaned;\n  }\n\n  /**\n   * Convert XHTML to HTML for Live Editor\n   * @param {string} xhtmlContent - XHTML content\n   * @returns {string} HTML content\n   */\n  static convertXHTMLToHTML(xhtmlContent) {\n    if (!xhtmlContent) return \"\";\n\n    console.log(\"🔄 Converting XHTML to HTML:\", {\n      originalLength: xhtmlContent.length,\n      hasUL: xhtmlContent.includes(\"<ul\"),\n      hasOL: xhtmlContent.includes(\"<ol\"),\n      hasLI: xhtmlContent.includes(\"<li\"),\n      preview: xhtmlContent.substring(0, 300),\n    });\n\n    let htmlContent = xhtmlContent;\n\n    // 1. Clean data attributes that might confuse Quill\n    htmlContent = this.cleanDataAttributes(htmlContent);\n\n    // 2. Convert XHTML specific elements to HTML\n    htmlContent = htmlContent\n      // Convert self-closing tags to HTML format\n      .replace(/<br\\s*\\/>/g, \"<br>\")\n      .replace(/<hr\\s*\\/>/g, \"<hr>\")\n      .replace(/<img([^>]*)\\s*\\/>/g, \"<img$1>\")\n      // Remove XML namespaces that Quill doesn't understand\n      .replace(/\\s+xmlns[^=]*=\"[^\"]*\"/g, \"\")\n      // Convert XHTML entities\n      .replace(/&nbsp;/g, \" \")\n      // Normalize whitespace\n      .replace(/\\s+/g, \" \")\n      .replace(/>\\s+</g, \"><\")\n      .trim();\n\n    console.log(\"🔄 XHTML to HTML conversion result:\", {\n      length: htmlContent.length,\n      hasUL: htmlContent.includes(\"<ul\"),\n      hasOL: htmlContent.includes(\"<ol\"),\n      hasLI: htmlContent.includes(\"<li\"),\n      preview: htmlContent.substring(0, 300),\n      cleanedDataAttrs: !htmlContent.includes(\"data-start\"),\n    });\n\n    return htmlContent;\n  }\n\n  /**\n   * Format content for Live Editor (compact whitespace but preserve structure)\n   * @param {string} content - Content to format\n   * @returns {string} Formatted content\n   */\n  static formatForLiveEditor(content) {\n    if (!content) return \"\";\n\n    console.log(\"🔍 Formatting for Live Editor:\", {\n      originalLength: content.length,\n      hasUL: content.includes(\"<ul\"),\n      hasOL: content.includes(\"<ol\"),\n      hasLI: content.includes(\"<li\"),\n      preview: content.substring(0, 500),\n    });\n\n    // 1. Convert XHTML to HTML first\n    let formatted = this.convertXHTMLToHTML(content);\n\n    // 2. Process Mermaid diagrams and convert to img tags\n    formatted = this.processMermaidToImages(formatted);\n\n    // 3. Final formatting for Quill\n    formatted = formatted\n      // Ensure proper spacing around block elements\n      .replace(/>\\s*</g, \"><\")\n      // Add line breaks after block elements for readability\n      .replace(/(<\\/(?:p|div|ul|ol|li|h[1-6])>)/g, \"$1\\n\")\n      .replace(/(<(?:p|div|ul|ol|li|h[1-6])[^>]*>)/g, \"\\n$1\")\n      // Clean up multiple line breaks\n      .replace(/\\n{3,}/g, \"\\n\\n\")\n      .trim();\n\n    console.log(\"🔍 Live Editor formatted result:\", {\n      length: formatted.length,\n      hasUL: formatted.includes(\"<ul\"),\n      hasOL: formatted.includes(\"<ol\"),\n      hasLI: formatted.includes(\"<li\"),\n      hasImages: formatted.includes(\"<img\"),\n      preview: formatted.substring(0, 500),\n      cleanedDataAttrs: !formatted.includes(\"data-start\"),\n    });\n\n    return formatted;\n  }\n\n  /**\n   * Process Mermaid diagrams and convert to img tags\n   * @param {string} content - Content with Mermaid code blocks\n   * @returns {string} Content with Mermaid converted to img tags\n   */\n  static processMermaidToImages(content) {\n    if (!content) return \"\";\n\n    console.log(\"🎨 Processing Mermaid diagrams to images...\");\n\n    // Find Mermaid code blocks\n    const mermaidRegex = /```mermaid\\s*([\\s\\S]*?)```/g;\n    let processedContent = content;\n    let mermaidCount = 0;\n\n    let match;\n    while ((match = mermaidRegex.exec(content)) !== null) {\n      const mermaidCode = match[1].trim();\n      mermaidCount++;\n\n      console.log(\n        `🎨 Found Mermaid diagram ${mermaidCount}:`,\n        mermaidCode.substring(0, 100)\n      );\n\n      // Create placeholder img tag for Mermaid diagram\n      // We'll use a data attribute to store the Mermaid code for later processing\n      const imgTag = `<img src=\"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzMzMyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk1lcm1haWQgRGlhZ3JhbTwvdGV4dD48L3N2Zz4=\" alt=\"Mermaid Diagram\" data-mermaid-code=\"${encodeURIComponent(\n        mermaidCode\n      )}\" style=\"max-width: 100%; height: auto; border: 1px dashed #ccc;\" />`;\n\n      // Replace the code block with img tag\n      processedContent = processedContent.replace(match[0], imgTag);\n    }\n\n    console.log(\"🎨 Mermaid processing result:\", {\n      mermaidCount: mermaidCount,\n      hasImages: processedContent.includes(\"<img\"),\n      preview: processedContent.substring(0, 300),\n    });\n\n    return processedContent;\n  }\n\n  /**\n   * Clean data attributes that might confuse Quill editor\n   * @param {string} content - Content with data attributes\n   * @returns {string} Cleaned content\n   */\n  static cleanDataAttributes(content) {\n    if (!content) return \"\";\n\n    console.log(\"🧹 Cleaning data attributes...\");\n\n    // Remove common data attributes that Quill doesn't need\n    let cleaned = content\n      .replace(/\\s+data-start=\"[^\"]*\"/g, \"\")\n      .replace(/\\s+data-end=\"[^\"]*\"/g, \"\")\n      .replace(/\\s+data-uuid=\"[^\"]*\"/g, \"\")\n      .replace(/\\s+data-id=\"[^\"]*\"/g, \"\")\n      .replace(/\\s+data-type=\"[^\"]*\"/g, \"\");\n\n    console.log(\"🧹 Data attributes cleaned:\", {\n      originalLength: content.length,\n      cleanedLength: cleaned.length,\n      removedChars: content.length - cleaned.length,\n    });\n\n    return cleaned;\n  }\n\n  /**\n   * Escape regex special characters\n   * @param {string} string - String to escape\n   * @returns {string} Escaped string\n   */\n  static escapeRegex(string) {\n    return string.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\n  }\n}\n","/**\n * Content Synchronizer - Handles synchronization between different content sources\n * (Raw editor, Mermaid diagrams, etc.)\n */\nimport { XMLFormatter } from \"./xmlFormatter.js\";\n\nexport class ContentSynchronizer {\n  constructor() {\n    // Simplified - no change tracking needed\n    this.diagramChanges = new Map(); // Track diagram changes\n  }\n\n  /**\n   * Track diagram changes for synchronization\n   * @param {string} diagramId - Diagram ID\n   * @param {string} newCode - New diagram code\n   */\n  trackDiagramChange(diagramId, newCode) {\n    console.log(`📝 Tracking diagram change for ${diagramId}`);\n    this.diagramChanges.set(diagramId, {\n      code: newCode,\n      timestamp: Date.now(),\n    });\n  }\n\n  /**\n   * Get tracked diagram changes\n   * @returns {Map} Map of diagram changes\n   */\n  getTrackedChanges() {\n    return this.diagramChanges;\n  }\n\n  /**\n   * Clear tracked changes\n   */\n  clearTrackedChanges() {\n    this.diagramChanges.clear();\n  }\n\n  /**\n   * Sync all content sources to main content object\n   * @param {Object} currentContent - Main content object\n   * @param {HTMLElement} editorContainer - Editor container element\n   * @param {Array} mermaidDiagrams - Array of Mermaid diagrams\n   * @returns {Object} Updated content object\n   */\n  syncAllContent(currentContent, editorContainer, mermaidDiagrams = []) {\n    if (!currentContent) {\n      throw new Error(\"Current content is required\");\n    }\n\n    // 1. Sync from raw editor\n    const rawContent = this.syncFromRawEditor(currentContent, editorContainer);\n\n    // 2. Sync Mermaid changes\n    const finalContent = this.syncMermaidChanges(rawContent, mermaidDiagrams);\n\n    console.log(\"🔄 All content synchronized\");\n    return finalContent;\n  }\n\n  /**\n   * Sync content from raw editor\n   * @param {Object} currentContent - Current content object\n   * @param {HTMLElement} editorContainer - Editor container\n   * @returns {Object} Updated content object\n   */\n  syncFromRawEditor(currentContent, editorContainer) {\n    if (!editorContainer) return currentContent;\n\n    const rawEditor = editorContainer.querySelector(\"#raw-content-editor\");\n    if (!rawEditor || !rawEditor.value) return currentContent;\n\n    const updatedContent = { ...currentContent };\n    updatedContent.full_storage_format = rawEditor.value.trim();\n\n    // Also update content field if it exists\n    if (updatedContent.content !== undefined) {\n      updatedContent.content = rawEditor.value.trim();\n    }\n\n    console.log(\"📝 Synced content from raw editor\");\n    return updatedContent;\n  }\n\n  /**\n   * Sync Mermaid diagram changes back to content\n   * @param {Object} currentContent - Current content object\n   * @param {Array} mermaidDiagrams - Array of Mermaid diagrams\n   * @returns {Object} Updated content object\n   */\n  syncMermaidChanges(currentContent, mermaidDiagrams = []) {\n    console.log(\"🔄 Starting Mermaid sync...\", {\n      diagramsCount: mermaidDiagrams.length,\n      hasContent: !!currentContent,\n    });\n\n    if (!mermaidDiagrams || mermaidDiagrams.length === 0) {\n      console.log(\"⚠️ No Mermaid diagrams to sync\");\n      return currentContent;\n    }\n\n    let content =\n      currentContent.full_storage_format || currentContent.content || \"\";\n    console.log(\"📊 Processing all diagrams (no change check)...\");\n\n    // Process each diagram - always replace originalCode with code\n    mermaidDiagrams.forEach((diagram, index) => {\n      console.log(`� Processing diagram ${index}:`, {\n        id: diagram.id,\n        hasOriginalCode: !!diagram.originalCode,\n        hasCode: !!diagram.code,\n        originalLength: diagram.originalCode?.length || 0,\n        codeLength: diagram.code?.length || 0,\n      });\n\n      if (diagram.originalCode && diagram.code) {\n        console.log(`📝 Replacing code for diagram ${diagram.id || index}...`);\n        console.log(\n          `📋 Original code preview: \"${diagram.originalCode.substring(\n            0,\n            100\n          )}...\"`\n        );\n        console.log(\n          `📋 New code preview: \"${diagram.code.substring(0, 100)}...\"`\n        );\n\n        const updatedContent = this.updateDiagramInContent(\n          content,\n          diagram,\n          index\n        );\n        if (updatedContent !== content) {\n          content = updatedContent;\n          console.log(\n            `✅ Successfully replaced code for diagram ${diagram.id || index}`\n          );\n        } else {\n          console.warn(\n            `⚠️ Failed to replace code for diagram ${\n              diagram.id || index\n            } - no pattern matched`\n          );\n        }\n      } else {\n        console.log(\n          `⚠️ Skipping diagram ${\n            diagram.id || index\n          } - missing originalCode or code`\n        );\n      }\n    });\n\n    // Always return updated content\n    const updatedContent = { ...currentContent };\n    updatedContent.full_storage_format = content;\n\n    if (updatedContent.content !== undefined) {\n      updatedContent.content = content;\n    }\n\n    console.log(\"✅ Mermaid sync completed - all diagrams processed\");\n    return updatedContent;\n  }\n\n  /**\n   * Update a specific diagram in content string\n   * @param {string} content - Full content string\n   * @param {Object} diagram - Diagram object\n   * @param {number} index - Diagram index\n   * @returns {string} Updated content string\n   */\n  updateDiagramInContent(content, diagram, index) {\n    if (!content || !diagram) {\n      console.log(\"⚠️ updateDiagramInContent: Missing content or diagram\");\n      return content;\n    }\n\n    const originalCode = diagram.originalCode;\n    const newCode = diagram.code;\n\n    console.log(\"🔄 Updating diagram in content:\", {\n      index,\n      diagramId: diagram.id,\n      hasOriginalCode: !!originalCode,\n      hasNewCode: !!newCode,\n      originalLength: originalCode?.length || 0,\n      newLength: newCode?.length || 0,\n    });\n\n    if (!originalCode || !newCode) {\n      console.log(\"⚠️ Missing originalCode or newCode - skipping update\");\n      return content;\n    }\n\n    console.log(\"📋 Replacing originalCode with newCode (no equality check)\");\n    console.log(`📋 Original: \"${originalCode.substring(0, 50)}...\"`);\n    console.log(`📋 New: \"${newCode.substring(0, 50)}...\"`);\n\n    // Try multiple patterns to find and replace the diagram\n    const patterns = [\n      // Pattern 1: CDATA section in ac:parameter\n      {\n        pattern: new RegExp(\n          `(<ac:parameter[^>]*ac:name=\"code\"[^>]*>\\\\s*<\\\\!\\\\[CDATA\\\\[\\\\s*)(${XMLFormatter.escapeRegex(\n            originalCode\n          )})(\\\\s*\\\\]\\\\]>\\\\s*</ac:parameter>)`,\n          \"gs\"\n        ),\n        replacement: `$1${newCode}$3`,\n      },\n      // Pattern 2: Plain text in ac:parameter\n      {\n        pattern: new RegExp(\n          `(<ac:parameter[^>]*ac:name=\"code\"[^>]*>\\\\s*)(${XMLFormatter.escapeRegex(\n            originalCode\n          )})(\\\\s*</ac:parameter>)`,\n          \"gs\"\n        ),\n        replacement: `$1${newCode}$3`,\n      },\n      // Pattern 3: ac:plain-text-body with CDATA\n      {\n        pattern: new RegExp(\n          `(<ac:plain-text-body>\\\\s*<\\\\!\\\\[CDATA\\\\[\\\\s*)(${XMLFormatter.escapeRegex(\n            originalCode\n          )})(\\\\s*\\\\]\\\\]>\\\\s*</ac:plain-text-body>)`,\n          \"gs\"\n        ),\n        replacement: `$1${newCode}$3`,\n      },\n    ];\n\n    let updatedContent = content;\n    let patternMatched = false;\n\n    console.log(\"🔍 Trying patterns to match and replace...\");\n\n    for (let i = 0; i < patterns.length; i++) {\n      const { pattern, replacement } = patterns[i];\n\n      console.log(`🔍 Testing pattern ${i + 1}...`);\n\n      // Reset regex lastIndex to avoid issues with global flag\n      pattern.lastIndex = 0;\n\n      if (pattern.test(content)) {\n        console.log(`✅ Pattern ${i + 1} matched! Applying replacement...`);\n\n        // Reset again before replace\n        pattern.lastIndex = 0;\n        updatedContent = content.replace(pattern, replacement);\n        patternMatched = true;\n\n        console.log(`✅ Successfully updated diagram using pattern ${i + 1}`);\n        break;\n      } else {\n        console.log(`❌ Pattern ${i + 1} did not match`);\n      }\n    }\n\n    if (!patternMatched) {\n      console.warn(\n        `⚠️ Could not find pattern to update diagram ${diagram.id || index}`\n      );\n      console.log(\"🔍 Debug info:\");\n      console.log(\n        \"Original code preview:\",\n        originalCode.substring(0, 100) + \"...\"\n      );\n      console.log(\"New code preview:\", newCode.substring(0, 100) + \"...\");\n      console.log(\"Content sample:\", content.substring(0, 500) + \"...\");\n\n      // Try to find the original code manually for debugging\n      const simpleSearch = content.includes(originalCode.trim());\n      console.log(\"Simple string search found original code:\", simpleSearch);\n    } else {\n      console.log(\"✅ Pattern matching successful, content updated\");\n    }\n\n    return updatedContent;\n  }\n\n  /**\n   * Validate content structure\n   * @param {Object} content - Content to validate\n   * @returns {Object} Validation result\n   */\n  validateContent(content) {\n    const result = {\n      isValid: true,\n      errors: [],\n      warnings: [],\n    };\n\n    if (!content) {\n      result.isValid = false;\n      result.errors.push(\"Content is null or undefined\");\n      return result;\n    }\n\n    // Check required fields\n    if (!content.full_storage_format && !content.content) {\n      result.isValid = false;\n      result.errors.push(\"Missing full_storage_format or content field\");\n    }\n\n    // Check for XML validity\n    const xmlContent = content.full_storage_format || content.content;\n    if (xmlContent) {\n      try {\n        const parser = new DOMParser();\n        const doc = parser.parseFromString(\n          `<root>${xmlContent}</root>`,\n          \"text/xml\"\n        );\n        const errors = doc.getElementsByTagName(\"parsererror\");\n\n        if (errors.length > 0) {\n          result.warnings.push(\"Content may contain XML parsing issues\");\n        }\n      } catch (error) {\n        result.warnings.push(`XML validation warning: ${error.message}`);\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * Create content backup\n   * @param {Object} content - Content to backup\n   * @returns {Object} Content backup\n   */\n  createBackup(content) {\n    return {\n      content: JSON.parse(JSON.stringify(content)),\n      timestamp: Date.now(),\n    };\n  }\n\n  /**\n   * Restore from backup\n   * @param {Object} backup - Backup to restore\n   * @returns {Object} Restored content\n   */\n  restoreFromBackup(backup) {\n    if (!backup || !backup.content) {\n      throw new Error(\"Invalid backup data\");\n    }\n\n    console.log(\"🔄 Restored content from backup\");\n    return backup.content;\n  }\n}\n","// DOM Manipulation Helpers\n// Utility functions for DOM operations and event handling\n\nexport class DOMHelpers {\n  /**\n   * Safely query selector with error handling\n   * @param {HTMLElement} container - Container element\n   * @param {string} selector - CSS selector\n   * @returns {HTMLElement|null} Found element or null\n   */\n  static querySelector(container, selector) {\n    try {\n      return container.querySelector(selector);\n    } catch (error) {\n      console.error(`Error querying selector \"${selector}\":`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Safely query all selectors with error handling\n   * @param {HTMLElement} container - Container element\n   * @param {string} selector - CSS selector\n   * @returns {NodeList} Found elements\n   */\n  static querySelectorAll(container, selector) {\n    try {\n      return container.querySelectorAll(selector);\n    } catch (error) {\n      console.error(`Error querying selector \"${selector}\":`, error);\n      return [];\n    }\n  }\n\n  /**\n   * Add event listener with error handling\n   * @param {HTMLElement} element - Target element\n   * @param {string} event - Event type\n   * @param {Function} handler - Event handler\n   * @param {object} options - Event options\n   */\n  static addEventListener(element, event, handler, options = {}) {\n    if (!element) {\n      console.warn(`Cannot add event listener: element is null`);\n      return;\n    }\n\n    try {\n      element.addEventListener(event, handler, options);\n    } catch (error) {\n      console.error(`Error adding event listener for \"${event}\":`, error);\n    }\n  }\n\n  /**\n   * Remove event listener with error handling\n   * @param {HTMLElement} element - Target element\n   * @param {string} event - Event type\n   * @param {Function} handler - Event handler\n   */\n  static removeEventListener(element, event, handler) {\n    if (!element) {\n      console.warn(`Cannot remove event listener: element is null`);\n      return;\n    }\n\n    try {\n      element.removeEventListener(event, handler);\n    } catch (error) {\n      console.error(`Error removing event listener for \"${event}\":`, error);\n    }\n  }\n\n  /**\n   * Toggle class on element\n   * @param {HTMLElement} element - Target element\n   * @param {string} className - Class name to toggle\n   * @param {boolean} force - Force add/remove\n   */\n  static toggleClass(element, className, force = undefined) {\n    if (!element) {\n      console.warn(`Cannot toggle class: element is null`);\n      return;\n    }\n\n    try {\n      if (force !== undefined) {\n        element.classList.toggle(className, force);\n      } else {\n        element.classList.toggle(className);\n      }\n    } catch (error) {\n      console.error(`Error toggling class \"${className}\":`, error);\n    }\n  }\n\n  /**\n   * Add class to element\n   * @param {HTMLElement} element - Target element\n   * @param {string} className - Class name to add\n   */\n  static addClass(element, className) {\n    if (!element) {\n      console.warn(`Cannot add class: element is null`);\n      return;\n    }\n\n    try {\n      element.classList.add(className);\n    } catch (error) {\n      console.error(`Error adding class \"${className}\":`, error);\n    }\n  }\n\n  /**\n   * Remove class from element\n   * @param {HTMLElement} element - Target element\n   * @param {string} className - Class name to remove\n   */\n  static removeClass(element, className) {\n    if (!element) {\n      console.warn(`Cannot remove class: element is null`);\n      return;\n    }\n\n    try {\n      element.classList.remove(className);\n    } catch (error) {\n      console.error(`Error removing class \"${className}\":`, error);\n    }\n  }\n\n  /**\n   * Set element content safely\n   * @param {HTMLElement} element - Target element\n   * @param {string} content - Content to set\n   * @param {boolean} isHTML - Whether content is HTML (default: false)\n   */\n  static setContent(element, content, isHTML = false) {\n    if (!element) {\n      console.warn(`Cannot set content: element is null`);\n      return;\n    }\n\n    try {\n      // Handle form elements specially\n      if (\n        element.tagName === \"INPUT\" ||\n        element.tagName === \"TEXTAREA\" ||\n        element.tagName === \"SELECT\"\n      ) {\n        element.value = content || \"\";\n        return;\n      }\n\n      if (isHTML) {\n        element.innerHTML = content;\n      } else {\n        element.textContent = content;\n      }\n    } catch (error) {\n      console.error(`Error setting content:`, error);\n    }\n  }\n\n  /**\n   * Get element content safely\n   * @param {HTMLElement} element - Target element\n   * @param {boolean} isHTML - Whether to get HTML content (default: false)\n   * @returns {string} Element content\n   */\n  static getContent(element, isHTML = false) {\n    if (!element) {\n      console.warn(`Cannot get content: element is null`);\n      return \"\";\n    }\n\n    try {\n      // Handle form elements specially\n      if (\n        element.tagName === \"INPUT\" ||\n        element.tagName === \"TEXTAREA\" ||\n        element.tagName === \"SELECT\"\n      ) {\n        return element.value || \"\";\n      }\n\n      return isHTML ? element.innerHTML : element.textContent;\n    } catch (error) {\n      console.error(`Error getting content:`, error);\n      return \"\";\n    }\n  }\n\n  /**\n   * Create element with attributes and content\n   * @param {string} tagName - HTML tag name\n   * @param {object} attributes - Element attributes\n   * @param {string} content - Element content\n   * @param {boolean} isHTML - Whether content is HTML\n   * @returns {HTMLElement} Created element\n   */\n  static createElement(tagName, attributes = {}, content = \"\", isHTML = false) {\n    try {\n      const element = document.createElement(tagName);\n\n      // Set attributes\n      Object.entries(attributes).forEach(([key, value]) => {\n        if (key === \"className\") {\n          element.className = value;\n        } else if (key === \"style\" && typeof value === \"object\") {\n          Object.assign(element.style, value);\n        } else {\n          element.setAttribute(key, value);\n        }\n      });\n\n      // Set content\n      if (content) {\n        this.setContent(element, content, isHTML);\n      }\n\n      return element;\n    } catch (error) {\n      console.error(`Error creating element \"${tagName}\":`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Remove element safely\n   * @param {HTMLElement} element - Element to remove\n   */\n  static removeElement(element) {\n    if (!element) {\n      console.warn(`Cannot remove element: element is null`);\n      return;\n    }\n\n    try {\n      if (element.parentNode) {\n        element.parentNode.removeChild(element);\n      } else {\n        element.remove();\n      }\n    } catch (error) {\n      console.error(`Error removing element:`, error);\n    }\n  }\n\n  /**\n   * Check if element exists in DOM\n   * @param {HTMLElement} element - Element to check\n   * @returns {boolean} True if element exists in DOM\n   */\n  static isInDOM(element) {\n    if (!element) return false;\n    return document.body.contains(element);\n  }\n\n  /**\n   * Scroll element into view smoothly\n   * @param {HTMLElement} element - Element to scroll to\n   * @param {object} options - Scroll options\n   */\n  static scrollIntoView(\n    element,\n    options = { behavior: \"smooth\", block: \"center\" }\n  ) {\n    if (!element) {\n      console.warn(`Cannot scroll: element is null`);\n      return;\n    }\n\n    try {\n      element.scrollIntoView(options);\n    } catch (error) {\n      console.error(`Error scrolling element into view:`, error);\n    }\n  }\n\n  /**\n   * Get element dimensions\n   * @param {HTMLElement} element - Target element\n   * @returns {object} Element dimensions\n   */\n  static getDimensions(element) {\n    if (!element) {\n      console.warn(`Cannot get dimensions: element is null`);\n      return { width: 0, height: 0, top: 0, left: 0 };\n    }\n\n    try {\n      const rect = element.getBoundingClientRect();\n      return {\n        width: rect.width,\n        height: rect.height,\n        top: rect.top,\n        left: rect.left,\n        right: rect.right,\n        bottom: rect.bottom,\n      };\n    } catch (error) {\n      console.error(`Error getting element dimensions:`, error);\n      return { width: 0, height: 0, top: 0, left: 0 };\n    }\n  }\n\n  /**\n   * Deep clone element\n   * @param {HTMLElement} element - Element to clone\n   * @param {boolean} deep - Whether to deep clone (default: true)\n   * @returns {HTMLElement} Cloned element\n   */\n  static cloneElement(element, deep = true) {\n    if (!element) {\n      console.warn(`Cannot clone element: element is null`);\n      return null;\n    }\n\n    try {\n      return element.cloneNode(deep);\n    } catch (error) {\n      console.error(`Error cloning element:`, error);\n      return null;\n    }\n  }\n}\n","// HTML Templates for Confluence Editor\n// Contains all HTML template strings and styling utilities\n\nexport class HTMLTemplates {\n  /**\n   * Get the main editor HTML template\n   * @returns {string} HTML template string\n   */\n  static getEditorTemplate() {\n    return `\n      <div class=\"confluence-editor-container\">\n        <div class=\"confluence-editor-header\">\n          <h2 class=\"confluence-editor-title\">\n            📝 Edit Confluence Content\n          </h2>\n          <div class=\"confluence-editor-actions\">\n            <button class=\"editor-btn editor-btn-primary\" id=\"editor-save-btn\">\n              💾 Save\n            </button>\n            <button class=\"editor-btn editor-btn-secondary\" id=\"editor-close-btn\">\n              ✕ Close\n            </button>\n          </div>\n        </div>\n\n        <div class=\"confluence-editor-tabs\">\n          <button class=\"confluence-editor-tab active\" id=\"content-tab\">\n            📝 Edit Content\n          </button>\n          <button class=\"confluence-editor-tab\" id=\"live-edit-tab\">\n            ✨ Live Edit\n          </button>\n          <button class=\"confluence-editor-tab\" id=\"rich-text-tab\">\n            🎨 Rich Text\n          </button>\n          <button class=\"confluence-editor-tab\" id=\"mermaid-tab\">\n            📊 Edit Mermaid Code\n          </button>\n        </div>\n\n        <div class=\"confluence-editor-body\">\n          ${this.getContentTabTemplate()}\n          ${this.getLiveEditTabTemplate()}\n          ${this.getRichTextTabTemplate()}\n          ${this.getMermaidTabTemplate()}\n        </div>\n      </div>\n    `;\n  }\n\n  /**\n   * Get content tab template\n   * @returns {string} Content tab HTML\n   */\n  static getContentTabTemplate() {\n    return `\n      <!-- Content Tab -->\n      <div class=\"tab-content active\" id=\"content-tab-content\">\n        <div class=\"content-editor-layout\">\n          <!-- Raw XHTML Editor (Left) -->\n          <div class=\"content-editor-pane\">\n            <div class=\"content-editor-header\">\n              <span>📝 Raw XHTML Content</span>\n              <div class=\"editor-header-actions\" style=\"display: none;\">\n                <button class=\"editor-toggle-btn\" id=\"toggle-raw-view\" title=\"Toggle Rich Text Editor\">\n                  ✨ Rich\n                </button>\n              </div>\n            </div>\n            <div class=\"content-editor-body\">\n              <div class=\"rich-text-editor-container\" id=\"rich-text-editor-container\" style=\"display: none;\"></div>\n              <textarea class=\"raw-content-editor\" id=\"raw-content-editor\" placeholder=\"Raw XHTML content will appear here...\"></textarea>\n            </div>\n          </div>\n\n          <!-- Preview Pane (Right) -->\n          <div class=\"content-preview-pane\">\n            <div class=\"content-editor-header\">\n              👁️ Live Preview\n            </div>\n            <div class=\"content-editor-body\">\n              <div class=\"content-preview\" id=\"content-preview\">\n                <!-- Preview content will be rendered here -->\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n  }\n\n  /**\n   * Get live edit tab template\n   * @returns {string} Live edit tab HTML\n   */\n  static getLiveEditTabTemplate() {\n    return `\n      <!-- Live Edit Tab -->\n      <div class=\"tab-content\" id=\"live-edit-tab-content\">\n        <div class=\"live-edit-layout-full\">\n          <!-- Full Width Text Editor -->\n          <div class=\"live-edit-editor-pane-full\">\n            <div class=\"content-editor-header\">\n              <span>✨ Live Text Editor</span>\n            </div>\n            <div class=\"content-editor-body\">\n              <div class=\"live-edit-editor-container\" id=\"live-edit-editor-container\"></div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n  }\n\n  /**\n   * Get rich text tab template\n   * @returns {string} Rich text tab HTML\n   */\n  static getRichTextTabTemplate() {\n    return `\n      <!-- Rich Text Tab -->\n      <div class=\"tab-content\" id=\"rich-text-tab-content\">\n        <div class=\"tiptap-layout-full\">\n          <!-- Full Width TipTap Rich Text Editor -->\n          <div class=\"tiptap-editor-pane-full\">\n            <div class=\"tiptap-editor-header\">\n              <span>🎨 TipTap Rich Text Editor</span>\n            </div>\n            <div class=\"tiptap-editor-body\">\n              <div class=\"tiptap-editor-container\" id=\"tiptap-editor-container\"></div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n  }\n\n  /**\n   * Get mermaid tab template\n   * @returns {string} Mermaid tab HTML\n   */\n  static getMermaidTabTemplate() {\n    return `\n      <!-- Mermaid Tab -->\n      <div class=\"tab-content\" id=\"mermaid-tab-content\">\n        <div class=\"mermaid-editor-layout\">\n          <!-- Mermaid Code Editor (Left) -->\n          <div class=\"mermaid-code-pane\">\n            <div class=\"mermaid-editor-header\">\n              📊 Mermaid Code\n              <select id=\"mermaid-selector\" class=\"mermaid-selector\">\n                <option value=\"\">Select diagram...</option>\n              </select>\n            </div>\n            <div class=\"mermaid-editor-body\">\n              <textarea class=\"mermaid-code-editor\" id=\"mermaid-code-editor\" placeholder=\"Select a Mermaid diagram to edit...\"></textarea>\n            </div>\n          </div>\n\n          <!-- Mermaid Preview (Center) -->\n          <div class=\"mermaid-preview-pane\">\n            <div class=\"mermaid-editor-header\">\n              <span class=\"preview-title\">📊 Diagram Preview</span>\n              ${this.getZoomControlsTemplate()}\n            </div>\n            <div class=\"mermaid-editor-body\">\n              <div class=\"mermaid-preview\" id=\"mermaid-preview\">\n                <div class=\"mermaid-placeholder\">\n                  Select a diagram to preview\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <!-- AI Chat (Right) -->\n          <div class=\"mermaid-ai-pane\">\n            <div class=\"mermaid-editor-header\">\n              🤖 AI Assistant\n            </div>\n            <div class=\"mermaid-editor-body\">\n              ${this.getAIChatTemplate()}\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n  }\n\n  /**\n   * Get zoom controls template\n   * @returns {string} Zoom controls HTML\n   */\n  static getZoomControlsTemplate() {\n    return `\n      <div class=\"mermaid-zoom-controls\">\n        <button class=\"zoom-btn\" id=\"zoom-out\" title=\"Zoom Out\">−</button>\n        <div class=\"zoom-level\" id=\"zoom-level\">100%</div>\n        <button class=\"zoom-btn\" id=\"zoom-in\" title=\"Zoom In\">+</button>\n        <button class=\"zoom-btn\" id=\"zoom-reset\" title=\"Reset Zoom\">⌂</button>\n      </div>\n    `;\n  }\n\n  /**\n   * Get AI chat template - Enhanced version similar to extension\n   * @returns {string} AI chat HTML\n   */\n  static getAIChatTemplate() {\n    return `\n      <div class=\"ai-chat-container\">\n        <div class=\"ai-chat-header\">\n          <div class=\"ai-header-title\">\n            <span class=\"ai-icon\">🤖</span>\n            <span>AI Diagram Assistant</span>\n          </div>\n          <div class=\"ai-header-status\">Ready</div>\n        </div>\n        <div class=\"ai-chat-messages\" id=\"ai-chat-messages\">\n          <div class=\"ai-message\">\n            <div class=\"ai-avatar\">🤖</div>\n            <div class=\"ai-text\">\n              <strong>Hi! I'm your AI Diagram Assistant.</strong><br/><br/>\n              I can help you modify Mermaid diagrams with natural language commands:<br/>\n              • \"Add a new node called 'Database'\"<br/>\n              • \"Change the color of node A to blue\"<br/>\n              • \"Add an arrow from A to B\"<br/>\n              • \"Make this flowchart more detailed\"<br/><br/>\n              <em>Select a diagram above and describe what you want to change!</em>\n            </div>\n          </div>\n        </div>\n        <div class=\"ai-chat-input\">\n          <div class=\"ai-input-container\">\n            <textarea\n              id=\"ai-prompt-input\"\n              placeholder=\"Describe how you want to modify the diagram...\"\n              rows=\"2\"\n            ></textarea>\n            <button id=\"ai-send-btn\" class=\"ai-send-btn\" title=\"Send message (Enter)\">\n              <span class=\"send-icon\">📤</span>\n            </button>\n          </div>\n          <div class=\"ai-input-tips\">\n            💡 <strong>Tips:</strong> Be specific about changes you want. Press Enter to send.\n          </div>\n        </div>\n      </div>\n    `;\n  }\n\n  /**\n   * Apply inline styles to HTML content for preview\n   * @param {string} content - Raw HTML content\n   * @returns {string} Styled HTML content\n   */\n  static applyPreviewStyles(content) {\n    return content\n      .replace(\n        /<h1>/g,\n        \"<h1 style='color: #333; margin: 24px 0 16px 0; font-size: 1.8rem; border-bottom: 2px solid #e1e5e9; padding-bottom: 8px;'>\"\n      )\n      .replace(\n        /<h2>/g,\n        \"<h2 style='color: #555; margin: 20px 0 12px 0; font-size: 1.4rem;'>\"\n      )\n      .replace(\n        /<h3>/g,\n        \"<h3 style='color: #666; margin: 16px 0 8px 0; font-size: 1.2rem;'>\"\n      )\n      .replace(\n        /<p>/g,\n        \"<p style='margin: 12px 0; line-height: 1.6; color: #333;'>\"\n      )\n      .replace(/<ul>/g, \"<ul style='margin: 12px 0; padding-left: 24px;'>\")\n      .replace(/<li>/g, \"<li style='margin: 4px 0; line-height: 1.5;'>\")\n      .replace(\n        /<table>/g,\n        \"<table style='border-collapse: collapse; width: 100%; margin: 20px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1);'>\"\n      )\n      .replace(\n        /<th>/g,\n        \"<th style='border: 1px solid #ddd; padding: 12px; background: #f8f9fa; font-weight: 600; text-align: left;'>\"\n      )\n      .replace(\n        /<td>/g,\n        \"<td style='border: 1px solid #ddd; padding: 12px; vertical-align: top;'>\"\n      )\n      .replace(/<strong>/g, \"<strong style='color: #2c3e50;'>\")\n      .replace(\n        /<code>/g,\n        \"<code style='background: #f1f3f4; padding: 2px 4px; border-radius: 3px; font-family: monospace; font-size: 0.9em;'>\"\n      );\n  }\n\n  /**\n   * Create AI message HTML\n   * @param {string} type - Message type ('user' or 'ai')\n   * @param {string} text - Message text\n   * @returns {string} AI message HTML\n   */\n  static createAIMessage(type, text) {\n    const avatar = type === \"user\" ? \"👤\" : \"🤖\";\n    const bgColor = type === \"user\" ? \"#e5e7eb\" : \"#3b82f6\";\n\n    return `\n      <div class=\"ai-message\">\n        <div class=\"ai-avatar\" style=\"background: ${bgColor};\">${avatar}</div>\n        <div class=\"ai-text\">${text}</div>\n      </div>\n    `;\n  }\n\n  /**\n   * Create mermaid diagram container with styling\n   * @param {number} index - Diagram index\n   * @returns {HTMLElement} Mermaid container element\n   */\n  static createMermaidContainer(index) {\n    const mermaidDiv = document.createElement(\"div\");\n    mermaidDiv.className = \"mermaid-diagram\";\n    mermaidDiv.id = `preview-mermaid-${index}`;\n    mermaidDiv.style.cssText =\n      \"margin: 20px 0; text-align: center; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;\";\n    return mermaidDiv;\n  }\n}\n","/**\n * Unified Storage Manager - Handles all storage operations\n * Supports Chrome storage, localStorage, content backup, and settings\n */\n\n// Import constants from shared\nimport {\n  DEFAULT_SETTINGS,\n  EXTENSION_SETTINGS_KEY,\n} from \"../../shared/constants.js\";\n\nexport class StorageManager {\n  // Storage keys constants\n  static STORAGE_KEYS = {\n    CONFLUENCE_CONTENT_BACKUP: \"confluence_content_backup\",\n    MERMAID_DIAGRAM_MAPPINGS: \"mermaid_diagram_mappings\",\n    MERMAID_AI_FILENAME: \"mermaid-ai-filename\",\n    MERMAID_DIAGRAM_INFO: \"mermaid_diagram_info\",\n    CONFLUENCE_EDITOR_BACKUP: \"confluence_editor_backup\",\n  };\n\n  constructor() {\n    this.STORAGE_KEY = StorageManager.STORAGE_KEYS.CONFLUENCE_CONTENT_BACKUP;\n    this.AUTO_SAVE_INTERVAL = 30000; // 30 seconds\n    this.autoSaveTimer = null;\n  }\n\n  // ========== CHROME STORAGE METHODS (from shared/storage.js) ==========\n\n  /**\n   * Load settings from Chrome storage\n   * @returns {Promise<Object>} Settings object\n   */\n  static async getSettings() {\n    try {\n      const result = await chrome.storage.sync.get([EXTENSION_SETTINGS_KEY]);\n      return result[EXTENSION_SETTINGS_KEY] || DEFAULT_SETTINGS;\n    } catch (error) {\n      console.error(\"Error loading settings:\", error);\n      return DEFAULT_SETTINGS;\n    }\n  }\n\n  /**\n   * Save settings to Chrome storage\n   * @param {Object} settings - Settings object to save\n   * @returns {Promise<boolean>} Success status\n   */\n  static async saveSettings(settings) {\n    try {\n      await chrome.storage.sync.set({ [EXTENSION_SETTINGS_KEY]: settings });\n      return true;\n    } catch (error) {\n      console.error(\"Error saving settings:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Update specific setting field\n   * @param {string} field - Field name to update\n   * @param {any} value - New value\n   * @returns {Promise<boolean>} Success status\n   */\n  static async updateSetting(field, value) {\n    try {\n      const currentSettings = await this.getSettings();\n      const updatedSettings = { ...currentSettings, [field]: value };\n      return await this.saveSettings(updatedSettings);\n    } catch (error) {\n      console.error(\"Error updating setting:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Reset settings to default\n   * @returns {Promise<boolean>} Success status\n   */\n  static async resetSettings() {\n    try {\n      await chrome.storage.sync.remove([EXTENSION_SETTINGS_KEY]);\n      return true;\n    } catch (error) {\n      console.error(\"Error resetting settings:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Validate settings object\n   * @param {Object} settings - Settings to validate\n   * @returns {Object} Validation result with errors\n   */\n  static validateSettings(settings) {\n    const errors = {};\n\n    if (!settings.apiKey?.trim()) {\n      errors.apiKey = \"API Key là bắt buộc\";\n    }\n\n    if (!settings.urlTemplate?.trim()) {\n      errors.urlTemplate = \"URL Template là bắt buộc\";\n    } else {\n      const validationResult = this.validateConfluencePageLink(\n        settings.urlTemplate\n      );\n\n      if (!validationResult.valid) {\n        errors.urlTemplate =\n          validationResult.error || \"URL Template không hợp lệ.\";\n      }\n    }\n    if (!settings.documentUrl?.trim()) {\n      errors.documentUrl = \"URL thư mục lưu tài liệu là bắt buộc\";\n    } else if (!this.isValidUrl(settings.documentUrl)) {\n      errors.documentUrl = \"URL không hợp lệ\";\n    }\n\n    if (!settings.databaseUrl?.trim()) {\n      errors.databaseUrl = \"URL thư mục database là bắt buộc\";\n    } else if (!this.isValidUrl(settings.databaseUrl)) {\n      errors.databaseUrl = \"URL không hợp lệ\";\n    }\n\n    // if (!settings.customPrompt?.trim()) {\n    //   errors.customPrompt = \"Custom Prompt là bắt buộc\";\n    // } else if (settings.customPrompt.trim().length < 10) {\n    //   errors.customPrompt = \"Custom Prompt phải có ít nhất 10 ký tự\";\n    // }\n\n    return {\n      isValid: Object.keys(errors).length === 0,\n      errors,\n    };\n  }\n\n  /**\n   * Get all settings keys\n   * @returns {Array<string>} Array of setting keys\n   */\n  static getSettingKeys() {\n    return Object.keys(DEFAULT_SETTINGS);\n  }\n\n  /**\n   * Check if settings exist\n   * @returns {Promise<boolean>} True if settings exist\n   */\n  static async hasSettings() {\n    try {\n      const result = await chrome.storage.sync.get([EXTENSION_SETTINGS_KEY]);\n      return !!result[EXTENSION_SETTINGS_KEY];\n    } catch (error) {\n      console.error(\"Error checking settings existence:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Get specific setting value\n   * @param {string} key - Setting key\n   * @returns {Promise<any>} Setting value or default\n   */\n  static async getSetting(key) {\n    try {\n      const settings = await this.getSettings();\n      return settings[key] !== undefined\n        ? settings[key]\n        : DEFAULT_SETTINGS[key];\n    } catch (error) {\n      console.error(`Error getting setting ${key}:`, error);\n      return DEFAULT_SETTINGS[key];\n    }\n  }\n\n  /**\n   * Export settings to JSON\n   * @returns {Promise<string>} JSON string of settings\n   */\n  static async exportSettings() {\n    try {\n      const settings = await this.getSettings();\n      return JSON.stringify(settings, null, 2);\n    } catch (error) {\n      console.error(\"Error exporting settings:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * Import settings from JSON\n   * @param {string} jsonString - JSON string of settings\n   * @returns {Promise<boolean>} Success status\n   */\n  static async importSettings(jsonString) {\n    try {\n      const settings = JSON.parse(jsonString);\n      const validation = this.validateSettings(settings);\n\n      if (!validation.isValid) {\n        throw new Error(validation.message);\n      }\n\n      return await this.saveSettings(settings);\n    } catch (error) {\n      console.error(\"Error importing settings:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Clear all extension data from Chrome storage\n   * @returns {Promise<boolean>} Success status\n   */\n  static async clearAllChromeStorage() {\n    try {\n      await chrome.storage.sync.clear();\n      await chrome.storage.local.clear();\n      return true;\n    } catch (error) {\n      console.error(\"Error clearing Chrome storage:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Check if URL is valid\n   * @param {string} url - URL to validate\n   * @returns {boolean} Is valid URL\n   */\n  static isValidUrl(url) {\n    try {\n      new URL(url);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * Validate Confluence page link (có pageId)\n   * @param {string} link - Link Confluence để kiểm tra\n   * @returns {Object} { valid: boolean, error?: string, pageId?: string }\n   */\n  static validateConfluencePageLink(link) {\n    const out = { valid: false, error: null, pageId: null };\n\n    if (!link || typeof link !== \"string\" || !link.trim()) {\n      out.error = \"URL là bắt buộc\";\n      return out;\n    }\n\n    let u;\n    try {\n      u = new URL(link.trim());\n    } catch {\n      out.error = \"URL không hợp lệ\";\n      return out;\n    }\n\n    // check pageId in query param\n    const pageIdParam = u.searchParams.get(\"pageId\");\n    if (pageIdParam && /^\\d+$/.test(pageIdParam)) {\n      out.valid = true;\n      out.pageId = pageIdParam;\n      return out;\n    }\n\n    // check pageId in path (/pages/{id})\n    const pathParts = u.pathname.split(\"/\");\n    const pagesIndex = pathParts.indexOf(\"pages\");\n    if (pagesIndex >= 0 && pathParts.length > pagesIndex + 1) {\n      const candidate = pathParts[pagesIndex + 1];\n      if (/^\\d+$/.test(candidate)) {\n        out.valid = true;\n        out.pageId = candidate;\n        return out;\n      }\n    }\n\n    out.error = \"Không tìm thấy pageId trong URL\";\n    return out;\n  }\n\n  // ========== CONTENT STORAGE METHODS (original) ==========\n\n  /**\n   * Save content with multiple strategies\n   * @param {Object} content - Content to save\n   * @param {Function} saveCallback - Optional callback for external save\n   * @param {Object} options - Save options\n   */\n  async saveContent(content, saveCallback = null, options = {}) {\n    const {\n      enableLocalStorage = true,\n      enableCallback = true,\n      showNotification = true,\n    } = options;\n\n    const results = {\n      localStorage: false,\n      callback: false,\n      errors: [],\n    };\n\n    // 1. Save to localStorage as backup\n    if (enableLocalStorage) {\n      try {\n        this.saveToLocalStorage(content);\n        results.localStorage = true;\n        console.log(\"✅ Content saved to localStorage\");\n      } catch (error) {\n        console.error(\"❌ Failed to save to localStorage:\", error);\n        results.errors.push(`localStorage: ${error.message}`);\n      }\n    }\n\n    // 2. Call external save callback\n    if (enableCallback && saveCallback) {\n      try {\n        await this.callSaveCallback(saveCallback, content);\n        results.callback = true;\n        console.log(\"✅ Content saved via callback\");\n      } catch (error) {\n        console.error(\"❌ Failed to save via callback:\", error);\n        results.errors.push(`callback: ${error.message}`);\n      }\n    }\n\n    // 3. Show notification\n    if (showNotification) {\n      this.showSaveNotification(results);\n    }\n\n    return results;\n  }\n\n  /**\n   * Save content to localStorage\n   * @param {Object} content - Content to save\n   */\n  saveToLocalStorage(content) {\n    const backupData = {\n      content: content,\n      timestamp: Date.now(),\n      version: \"1.0\",\n    };\n\n    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(backupData));\n  }\n\n  /**\n   * Load content from localStorage\n   * @returns {Object|null} Saved content or null\n   */\n  loadFromLocalStorage() {\n    try {\n      const saved = localStorage.getItem(this.STORAGE_KEY);\n      if (!saved) return null;\n\n      const backupData = JSON.parse(saved);\n\n      // Check if backup is recent (within 24 hours)\n      const age = Date.now() - backupData.timestamp;\n      const maxAge = 24 * 60 * 60 * 1000; // 24 hours\n\n      if (age > maxAge) {\n        console.log(\"🗑️ Removing old localStorage backup\");\n        localStorage.removeItem(this.STORAGE_KEY);\n        return null;\n      }\n\n      console.log(\"📦 Loaded content from localStorage backup\");\n      return backupData.content;\n    } catch (error) {\n      console.error(\"❌ Failed to load from localStorage:\", error);\n      return null;\n    }\n  }\n\n  /**\n   * Clear localStorage backup\n   */\n  clearLocalStorage() {\n    localStorage.removeItem(this.STORAGE_KEY);\n    console.log(\"🗑️ Cleared localStorage backup\");\n  }\n\n  /**\n   * Call external save callback\n   * @param {Function} callback - Save callback function\n   * @param {Object} content - Content to save\n   */\n  async callSaveCallback(callback, content) {\n    if (typeof callback !== \"function\") {\n      throw new Error(\"Save callback is not a function\");\n    }\n\n    // Handle both sync and async callbacks\n    const result = callback(content);\n    if (result && typeof result.then === \"function\") {\n      await result;\n    }\n  }\n\n  /**\n   * Show save notification\n   * @param {Object} results - Save results\n   */\n  showSaveNotification(results) {\n    const { localStorage, callback, errors } = results;\n\n    if (localStorage && callback) {\n      this.showNotification(\"✅ Đã lưu thay đổi thành công\", \"success\");\n    } else if (localStorage || callback) {\n      const method = localStorage ? \"localStorage\" : \"callback\";\n      this.showNotification(`⚠️ Đã lưu qua ${method} (một phần)`, \"warning\");\n    } else {\n      this.showNotification(\"❌ Không thể lưu thay đổi\", \"error\");\n    }\n\n    if (errors.length > 0) {\n      console.warn(\"Save errors:\", errors);\n    }\n  }\n\n  /**\n   * Show notification to user\n   * @param {string} message - Notification message\n   * @param {string} type - Notification type (success, warning, error)\n   */\n  showNotification(message, type = \"info\") {\n    // Create notification element\n    const notification = document.createElement(\"div\");\n    notification.className = `confluence-editor-notification ${type}`;\n    notification.style.cssText = `\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      padding: 12px 20px;\n      border-radius: 6px;\n      color: white;\n      font-family: Arial, sans-serif;\n      font-size: 14px;\n      z-index: 10001;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n      transition: all 0.3s ease;\n      max-width: 300px;\n    `;\n\n    // Set background color based on type\n    const colors = {\n      success: \"#28a745\",\n      warning: \"#ffc107\",\n      error: \"#dc3545\",\n      info: \"#17a2b8\",\n    };\n    notification.style.background = colors[type] || colors.info;\n\n    notification.textContent = message;\n    document.body.appendChild(notification);\n\n    // Auto remove after 3 seconds\n    setTimeout(() => {\n      if (notification.parentNode) {\n        notification.style.opacity = \"0\";\n        notification.style.transform = \"translateX(100%)\";\n        setTimeout(() => {\n          notification.remove();\n        }, 300);\n      }\n    }, 3000);\n  }\n\n  /**\n   * Start auto-save timer\n   * @param {Function} saveFunction - Function to call for auto-save\n   */\n  startAutoSave(saveFunction) {\n    this.stopAutoSave();\n\n    this.autoSaveTimer = setInterval(() => {\n      try {\n        saveFunction();\n        console.log(\"🔄 Auto-save completed\");\n      } catch (error) {\n        console.error(\"❌ Auto-save failed:\", error);\n      }\n    }, this.AUTO_SAVE_INTERVAL);\n\n    console.log(\"⏰ Auto-save started (every 30 seconds)\");\n  }\n\n  /**\n   * Stop auto-save timer\n   */\n  stopAutoSave() {\n    if (this.autoSaveTimer) {\n      clearInterval(this.autoSaveTimer);\n      this.autoSaveTimer = null;\n      console.log(\"⏹️ Auto-save stopped\");\n    }\n  }\n\n  /**\n   * Check if there are unsaved changes in localStorage\n   * @param {Object} currentContent - Current content to compare\n   * @returns {boolean} True if there are unsaved changes\n   */\n  hasUnsavedChanges(currentContent) {\n    const saved = this.loadFromLocalStorage();\n    if (!saved) return false;\n\n    try {\n      const currentStr = JSON.stringify(currentContent);\n      const savedStr = JSON.stringify(saved);\n      return currentStr !== savedStr;\n    } catch (error) {\n      console.error(\"❌ Error comparing content:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Get backup info\n   * @returns {Object|null} Backup information\n   */\n  getBackupInfo() {\n    try {\n      const saved = localStorage.getItem(this.STORAGE_KEY);\n      if (!saved) return null;\n\n      const backupData = JSON.parse(saved);\n      return {\n        timestamp: backupData.timestamp,\n        age: Date.now() - backupData.timestamp,\n        version: backupData.version,\n      };\n    } catch (error) {\n      return null;\n    }\n  }\n\n  /**\n   * Get item from localStorage\n   * @param {string} key - Storage key\n   * @returns {Promise<any>} Stored value or null\n   */\n  async getItem(key) {\n    try {\n      const item = localStorage.getItem(key);\n      return item ? JSON.parse(item) : null;\n    } catch (error) {\n      console.error(`❌ Error getting item from localStorage (${key}):`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Set item to localStorage\n   * @param {string} key - Storage key\n   * @param {any} value - Value to store\n   * @returns {Promise<void>}\n   */\n  async setItem(key, value) {\n    try {\n      localStorage.setItem(key, JSON.stringify(value));\n    } catch (error) {\n      console.error(`❌ Error setting item to localStorage (${key}):`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Remove item from localStorage\n   * @param {string} key - Storage key\n   * @returns {Promise<void>}\n   */\n  async removeItem(key) {\n    try {\n      localStorage.removeItem(key);\n    } catch (error) {\n      console.error(\n        `❌ Error removing item from localStorage (${key}):`,\n        error\n      );\n      throw error;\n    }\n  }\n\n  /**\n   * Save Mermaid diagram mappings to localStorage\n   * @param {Map} diagramsMap - Map of diagram ID to diagram data\n   * @returns {boolean} Success status\n   */\n  saveMermaidDiagramMappings(diagramsMap) {\n    try {\n      if (!diagramsMap || diagramsMap.size === 0) {\n        console.log(\"🗂️ No diagrams to save, clearing mappings\");\n        localStorage.removeItem(\n          StorageManager.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS\n        );\n        return true;\n      }\n\n      // Convert Map to plain object for storage\n      const mappingsObject = {};\n      diagramsMap.forEach((diagramData, diagramId) => {\n        mappingsObject[diagramId] = {\n          title: diagramData.title,\n          type: diagramData.type,\n          content: diagramData.content,\n          originCode: diagramData.originCode, // Store the original match[0] exactly as is\n          timestamp: Date.now(),\n        };\n      });\n\n      localStorage.setItem(\n        StorageManager.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS,\n        JSON.stringify(mappingsObject)\n      );\n\n      console.log(\n        `✅ Saved ${diagramsMap.size} Mermaid diagram mappings to localStorage`\n      );\n      return true;\n    } catch (error) {\n      console.error(\"❌ Error saving Mermaid diagram mappings:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Load Mermaid diagram mappings from localStorage\n   * @returns {Map} Map of diagram ID to diagram data\n   */\n  getMermaidDiagramMappings() {\n    try {\n      const stored = localStorage.getItem(\n        StorageManager.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS\n      );\n      if (!stored) {\n        console.log(\"📊 No stored Mermaid diagram mappings found\");\n        return new Map();\n      }\n\n      const mappingsObject = JSON.parse(stored);\n      const diagramsMap = new Map();\n\n      // Convert plain object back to Map\n      Object.entries(mappingsObject).forEach(([diagramId, diagramData]) => {\n        diagramsMap.set(diagramId, diagramData);\n      });\n\n      console.log(\n        `📊 Loaded ${diagramsMap.size} Mermaid diagram mappings from localStorage`\n      );\n      return diagramsMap;\n    } catch (error) {\n      console.error(\"❌ Error loading Mermaid diagram mappings:\", error);\n      return new Map();\n    }\n  }\n\n  /**\n   * Clear all K-Tool related localStorage keys\n   * @returns {Promise<Object>} Result with cleared and failed keys\n   */\n  async clearAllKToolData() {\n    const keysToRemove = Object.values(StorageManager.STORAGE_KEYS);\n    const clearedKeys = [];\n    const failedKeys = [];\n\n    for (const key of keysToRemove) {\n      try {\n        await this.removeItem(key);\n        clearedKeys.push(key);\n      } catch (error) {\n        failedKeys.push({ key, error: error.message });\n      }\n    }\n\n    console.log(\"🧹 Cleared K-Tool localStorage keys:\", clearedKeys);\n    if (failedKeys.length > 0) {\n      console.warn(\"⚠️ Failed to clear some keys:\", failedKeys);\n    }\n\n    return { clearedKeys, failedKeys };\n  }\n}\n","/**\n * Live Text Editor using Quill.js\n * Professional text editor for Live Edit tab\n */\n\nexport class LiveTextEditor {\n  constructor(container, options = {}) {\n    this.container = container;\n    this.quill = null;\n    this.isInitialized = false;\n\n    // Store original options for reference\n    this.originalOptions = options;\n\n    this.init();\n  }\n\n  /**\n   * Initialize the Live Text Editor\n   */\n  async init() {\n    try {\n      console.log(\"🎨 Initializing Live Text Editor...\");\n\n      // Load Quill.js (should already be loaded via content_scripts)\n      await this.loadQuill();\n\n      // Create editor container\n      this.createEditorContainer();\n\n      // Initialize Quill\n      this.initializeQuill();\n\n      // Setup event listeners\n      this.setupEventListeners();\n\n      this.isInitialized = true;\n      console.log(\"✅ Live Text Editor initialized successfully\");\n    } catch (error) {\n      console.error(\"❌ Failed to initialize Live Text Editor:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * Load Quill.js - should already be loaded via content_scripts\n   */\n  async loadQuill() {\n    try {\n      // Log all available libraries\n      console.log(\"🔍 Checking available libraries:\");\n      console.log(\"- Quill:\", window.Quill ? \"✅ Available\" : \"❌ Not found\");\n      console.log(\n        \"- Mermaid:\",\n        window.mermaid ? \"✅ Available\" : \"❌ Not found\"\n      );\n\n      // Check if Quill is already loaded via content_scripts\n      if (window.Quill && typeof window.Quill === \"function\") {\n        console.log(\"✅ Quill already loaded via content_scripts\");\n        return;\n      }\n\n      // If not loaded, wait a bit and check again\n      console.log(\"🔄 Waiting for Quill to load...\");\n      await this.waitForQuill();\n\n      if (window.Quill && typeof window.Quill === \"function\") {\n        console.log(\"✅ Quill loaded successfully\");\n        return;\n      }\n\n      throw new Error(\"Quill not found after waiting\");\n    } catch (error) {\n      console.error(\"❌ Failed to load Quill:\", error);\n      throw new Error(`Failed to load Quill.js: ${error.message}`);\n    }\n  }\n\n  /**\n   * Get basic Quill options without Better Table\n   */\n  getBasicOptions() {\n    const options = {\n      theme: \"snow\",\n      modules: {\n        table: true, // enable default table module\n        toolbar: [\n          [{ header: [1, 2, 3, 4, 5, 6, false] }],\n          [{ font: [] }, { size: [\"small\", false, \"large\", \"huge\"] }],\n          [\"bold\", \"italic\", \"underline\", \"strike\"],\n          [{ color: [] }, { background: [] }],\n          [{ script: \"sub\" }, { script: \"super\" }],\n          [{ list: \"ordered\" }, { list: \"bullet\" }],\n          [{ indent: \"-1\" }, { indent: \"+1\" }],\n          [{ align: [] }],\n          [\"blockquote\", \"code-block\"],\n          [\"link\", \"image\"],\n          [\"clean\"],\n        ],\n        // Add clipboard module to preserve HTML\n        // clipboard: {\n        //   matchVisual: false,\n        //   matchers: [\n        //     // Custom matcher to preserve HTML tags\n        //     [\n        //       \"ul\",\n        //       (node, delta) => {\n        //         console.log(\"🔍 Processing UL node:\", node);\n        //         return delta;\n        //       },\n        //     ],\n        //     [\n        //       \"ol\",\n        //       (node, delta) => {\n        //         console.log(\"🔍 Processing OL node:\", node);\n        //         return delta;\n        //       },\n        //     ],\n        //     [\n        //       \"li\",\n        //       (node, delta) => {\n        //         console.log(\"🔍 Processing LI node:\", node);\n        //         return delta;\n        //       },\n        //     ],\n        //     [\n        //       \"strong\",\n        //       (node, delta) => {\n        //         console.log(\"🔍 Processing STRONG node:\", node);\n        //         return delta;\n        //       },\n        //     ],\n        //   ],\n        // },\n      },\n      formats: [\n        \"header\",\n        \"font\",\n        \"size\",\n        \"bold\",\n        \"italic\",\n        \"underline\",\n        \"strike\",\n        \"color\",\n        \"background\",\n        \"script\",\n        \"list\",\n        \"bullet\",\n        \"indent\",\n        \"align\",\n        \"blockquote\",\n        \"code-block\",\n        \"link\",\n        \"image\",\n        // Add HTML tag formats\n        \"ul\",\n        \"ol\",\n        \"li\",\n        \"p\",\n        \"div\",\n        \"span\",\n        \"strong\",\n        \"em\",\n        \"br\",\n        \"hr\",\n      ],\n    };\n\n    // Note: Using default Quill table module instead of Better Table\n    // to avoid width calculation errors\n\n    return options;\n  }\n\n  /**\n   * Wait for Quill to be loaded by content_scripts\n   */\n  async waitForQuill() {\n    const maxWait = 5000; // 5 seconds\n    const checkInterval = 100; // 100ms\n    let waited = 0;\n\n    while (!window.Quill && waited < maxWait) {\n      await new Promise((resolve) => setTimeout(resolve, checkInterval));\n      waited += checkInterval;\n    }\n\n    if (!window.Quill) {\n      throw new Error(\"Quill failed to load within timeout\");\n    }\n  }\n\n  /**\n   * Ensure container has proper dimensions for Better Table\n   */\n  ensureContainerDimensions() {\n    if (!this.editorElement) return;\n\n    // Force container to have explicit dimensions\n    const containerStyle = this.editorElement.style;\n    const computedStyle = window.getComputedStyle(this.editorElement);\n\n    // Set minimum width if not set\n    if (!containerStyle.width && computedStyle.width === \"auto\") {\n      containerStyle.width = \"100%\";\n    }\n\n    // Set minimum height if not set\n    if (!containerStyle.height && computedStyle.height === \"auto\") {\n      containerStyle.minHeight = \"400px\";\n    }\n\n    // Force layout recalculation\n    this.editorElement.offsetHeight;\n\n    console.log(\"📐 Container dimensions:\", {\n      width: this.editorElement.offsetWidth,\n      height: this.editorElement.offsetHeight,\n      computedWidth: computedStyle.width,\n      computedHeight: computedStyle.height,\n    });\n  }\n\n  /**\n   * Create editor container\n   */\n  createEditorContainer() {\n    // Clear existing content\n    this.container.innerHTML = \"\";\n\n    // Create Quill container\n    const editorDiv = document.createElement(\"div\");\n    editorDiv.className = \"live-text-editor-quill\";\n    editorDiv.style.cssText = `\n      height: 100%;\n      display: flex;\n      flex-direction: column;\n      background: white;\n      border-radius: 8px;\n      overflow: hidden;\n    `;\n\n    this.container.appendChild(editorDiv);\n    this.editorElement = editorDiv;\n  }\n\n  /**\n   * Initialize Quill editor\n   */\n  initializeQuill() {\n    if (!window.Quill) {\n      throw new Error(\"Quill is not loaded\");\n    }\n\n    try {\n      // Ensure container has proper dimensions before initializing\n      this.ensureContainerDimensions();\n\n      // Register plugins if available\n      this.registerQuillPlugins();\n\n      // Create Quill with basic options first\n      this.quill = new window.Quill(this.editorElement, this.getBasicOptions());\n\n      // Default Quill table module is already enabled\n\n      // Set initial focus\n      setTimeout(() => {\n        if (this.quill) {\n          this.quill.focus();\n        }\n      }, 100);\n\n      console.log(\"✅ Quill editor initialized\");\n    } catch (error) {\n      console.error(\"❌ Failed to initialize Quill:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * Register Quill plugins\n   */\n  registerQuillPlugins() {\n    try {\n      console.log(\"🔍 Registering custom HTML formats for Quill...\");\n\n      // Register custom HTML formats\n      this.registerCustomFormats();\n\n      console.log(\"✅ Plugin registration completed\");\n    } catch (error) {\n      console.warn(\"⚠️ Plugin registration failed:\", error);\n    }\n  }\n\n  /**\n   * Register custom HTML formats that Quill should preserve\n   */\n  registerCustomFormats() {\n    if (!window.Quill) return;\n\n    const Inline = window.Quill.import(\"blots/inline\");\n    const Block = window.Quill.import(\"blots/block\");\n    const Container = window.Quill.import(\"blots/container\");\n\n    // Custom UL format\n    class ULFormat extends Container {\n      static create() {\n        const node = super.create();\n        node.setAttribute(\"tagName\", \"UL\");\n        return node;\n      }\n\n      static formats() {\n        return true;\n      }\n    }\n    ULFormat.blotName = \"ul\";\n    ULFormat.tagName = \"UL\";\n\n    // Custom OL format\n    class OLFormat extends Container {\n      static create() {\n        const node = super.create();\n        node.setAttribute(\"tagName\", \"OL\");\n        return node;\n      }\n\n      static formats() {\n        return true;\n      }\n    }\n    OLFormat.blotName = \"ol\";\n    OLFormat.tagName = \"OL\";\n\n    // Custom LI format\n    class LIFormat extends Block {\n      static create() {\n        const node = super.create();\n        node.setAttribute(\"tagName\", \"LI\");\n        return node;\n      }\n\n      static formats() {\n        return true;\n      }\n    }\n    LIFormat.blotName = \"li\";\n    LIFormat.tagName = \"LI\";\n\n    // Custom STRONG format\n    class StrongFormat extends Inline {\n      static create() {\n        return super.create();\n      }\n\n      static formats() {\n        return true;\n      }\n    }\n    StrongFormat.blotName = \"strong\";\n    StrongFormat.tagName = \"STRONG\";\n\n    try {\n      // Register the custom formats\n      window.Quill.register(ULFormat, true);\n      window.Quill.register(OLFormat, true);\n      window.Quill.register(LIFormat, true);\n      window.Quill.register(StrongFormat, true);\n\n      console.log(\"✅ Custom HTML formats registered:\", [\n        \"ul\",\n        \"ol\",\n        \"li\",\n        \"strong\",\n      ]);\n    } catch (error) {\n      console.warn(\"⚠️ Failed to register custom formats:\", error);\n    }\n  }\n\n  /**\n   * Add table support if Better Table plugin is available\n   */\n  addTableSupport() {\n    try {\n      if (window.quillBetterTable && this.quill) {\n        console.log(\"🔄 Adding Better Table support...\");\n\n        // Better Table should already be configured in options\n        // Just add the table button to toolbar\n        this.addTableButton();\n\n        // Check if Better Table module is working\n        const tableModule = this.quill.getModule(\"better-table\");\n        if (tableModule) {\n          console.log(\"✅ Better Table module is active\");\n        } else {\n          console.warn(\"⚠️ Better Table module not found in Quill instance\");\n        }\n      } else {\n        console.warn(\"⚠️ Better Table not available\");\n      }\n    } catch (error) {\n      console.warn(\"⚠️ Failed to add table support:\", error);\n    }\n  }\n\n  addTableButton() {\n    try {\n      // Create table button\n      const tableButton = document.createElement(\"button\");\n      tableButton.innerHTML = \"📋\";\n      tableButton.title = \"Insert Table (3x3)\";\n      tableButton.type = \"button\";\n      tableButton.className = \"ql-table\";\n\n      tableButton.addEventListener(\"click\", () => {\n        try {\n          // Try to get Better Table module\n          const tableModule = this.quill.getModule(\"better-table\");\n          if (tableModule && tableModule.insertTable) {\n            tableModule.insertTable(3, 3);\n            console.log(\"✅ Table inserted via Better Table\");\n          } else {\n            // Fallback: insert simple HTML table\n            const range = this.quill.getSelection();\n            if (range) {\n              const tableHTML = `\n                <table>\n                  <tr><td>Cell 1</td><td>Cell 2</td><td>Cell 3</td></tr>\n                  <tr><td>Cell 4</td><td>Cell 5</td><td>Cell 6</td></tr>\n                  <tr><td>Cell 7</td><td>Cell 8</td><td>Cell 9</td></tr>\n                </table>\n              `;\n              this.quill.clipboard.dangerouslyPasteHTML(range.index, tableHTML);\n              console.log(\"✅ Table inserted via HTML fallback\");\n            }\n          }\n        } catch (insertError) {\n          console.warn(\"⚠️ Table insertion failed:\", insertError);\n        }\n      });\n\n      // Add to toolbar\n      const toolbarContainer =\n        this.quill.container.querySelector(\".ql-toolbar\");\n      if (toolbarContainer) {\n        // Add after the last group\n        const lastGroup = toolbarContainer.querySelector(\n          \".ql-formats:last-child\"\n        );\n        if (lastGroup) {\n          lastGroup.appendChild(tableButton);\n        } else {\n          toolbarContainer.appendChild(tableButton);\n        }\n        console.log(\"✅ Table button added to toolbar\");\n      }\n    } catch (error) {\n      console.warn(\"⚠️ Failed to add table button:\", error);\n    }\n  }\n\n  /**\n   * Setup event listeners with error handling\n   */\n  setupEventListeners() {\n    if (!this.quill) return;\n\n    try {\n      // Text change event with validation\n      this.quill.on(\"text-change\", (delta, oldDelta, source) => {\n        try {\n          if (source === \"user\") {\n            this.onTextChange(delta, oldDelta);\n          }\n        } catch (error) {\n          console.error(\"❌ Error in text-change handler:\", error);\n        }\n      });\n\n      // Selection change event with validation\n      this.quill.on(\"selection-change\", (range, oldRange, source) => {\n        try {\n          this.onSelectionChange(range, oldRange, source);\n        } catch (error) {\n          console.error(\"❌ Error in selection-change handler:\", error);\n        }\n      });\n\n      console.log(\"✅ Live Text Editor event listeners setup\");\n    } catch (error) {\n      console.error(\"❌ Error setting up event listeners:\", error);\n    }\n  }\n\n  /**\n   * Handle text change\n   */\n  onTextChange(delta, oldDelta) {\n    try {\n      // Validate delta objects\n      if (!delta || typeof delta !== \"object\") {\n        console.warn(\"⚠️ Invalid delta object:\", delta);\n        return;\n      }\n\n      if (!oldDelta || typeof oldDelta !== \"object\") {\n        console.warn(\"⚠️ Invalid oldDelta object:\", oldDelta);\n        return;\n      }\n\n      // Ensure delta has ops array\n      if (!delta.ops || !Array.isArray(delta.ops)) {\n        console.warn(\"⚠️ Delta missing ops array:\", delta);\n        return;\n      }\n\n      if (!oldDelta.ops || !Array.isArray(oldDelta.ops)) {\n        console.warn(\"⚠️ OldDelta missing ops array:\", oldDelta);\n        return;\n      }\n\n      const event = new CustomEvent(\"liveTextChange\", {\n        detail: {\n          html: this.getHTML(),\n          text: this.getText(),\n          delta: this.getContents(),\n          changeDelta: delta,\n          oldDelta: oldDelta,\n        },\n      });\n      this.container.dispatchEvent(event);\n    } catch (error) {\n      console.error(\"❌ Error in onTextChange:\", error);\n    }\n  }\n\n  /**\n   * Handle selection change\n   */\n  onSelectionChange(range, oldRange, source) {\n    const event = new CustomEvent(\"liveTextSelectionChange\", {\n      detail: { range, oldRange, source },\n    });\n    this.container.dispatchEvent(event);\n  }\n\n  /**\n   * Get editor content as HTML\n   */\n  getHTML() {\n    return this.quill ? this.quill.root.innerHTML : \"\";\n  }\n\n  /**\n   * Get editor content as plain text\n   */\n  getText() {\n    return this.quill ? this.quill.getText() : \"\";\n  }\n\n  /**\n   * Get Quill instance\n   */\n  getQuill() {\n    return this.quill;\n  }\n\n  /**\n   * Get editor content as Delta\n   */\n  getContents() {\n    return this.quill ? this.quill.getContents() : null;\n  }\n\n  /**\n   * Set editor content from HTML (preserve all HTML tags)\n   */\n  setHTML(html) {\n    if (!this.quill || !html) {\n      console.warn(\"⚠️ setHTML called with invalid parameters:\", {\n        quill: !!this.quill,\n        html: !!html,\n      });\n      return;\n    }\n\n    console.log(\"🔍 Setting HTML content:\", html.substring(0, 200));\n\n    try {\n      // Method 1: Try dangerouslyPasteHTML with position parameter\n      try {\n        // Clear editor first\n        this.quill.setText(\"\");\n\n        // Use position 0 to avoid index errors\n        this.quill.clipboard.dangerouslyPasteHTML(0, html);\n        console.log(\"✅ HTML set using dangerouslyPasteHTML with position\");\n\n        return;\n      } catch (pasteError) {\n        console.warn(\n          \"⚠️ dangerouslyPasteHTML with position failed:\",\n          pasteError\n        );\n      }\n\n      // Method 2: Fallback to direct innerHTML\n      this.quill.root.innerHTML = html;\n      console.log(\"✅ HTML set using root.innerHTML fallback\");\n    } catch (error) {\n      console.error(\"❌ Error setting HTML content:\", error);\n    }\n  }\n\n  /**\n   * Set editor content from text\n   */\n  setText(text) {\n    if (this.quill) {\n      this.quill.setText(text);\n    }\n  }\n\n  /**\n   * Clear editor content\n   */\n  clear() {\n    if (this.quill) {\n      this.quill.setText(\"\");\n    }\n  }\n\n  /**\n   * Focus the editor\n   */\n  focus() {\n    if (this.quill) {\n      this.quill.focus();\n    }\n  }\n\n  /**\n   * Check if editor is ready\n   */\n  isReady() {\n    return this.isInitialized && this.quill !== null;\n  }\n\n  /**\n   * Destroy the editor\n   */\n  destroy() {\n    if (this.quill) {\n      // Remove event listeners\n      this.quill.off(\"text-change\");\n      this.quill.off(\"selection-change\");\n\n      // Clear container\n      if (this.container) {\n        this.container.innerHTML = \"\";\n      }\n\n      this.quill = null;\n    }\n\n    this.isInitialized = false;\n    console.log(\"🗑️ Live Text Editor destroyed\");\n  }\n}\n","// Confluence Content Editor with Rich Text Editing\r\n// Handles editing interface when Confluence content is returned from API\r\n\r\nimport { API_URLS } from \"../shared/constants.js\";\r\nimport { ContentSynchronizer } from \"./utils/contentSynchronizer.js\";\r\nimport { DOMHelpers } from \"./utils/domHelpers.js\";\r\nimport { HTMLTemplates } from \"./utils/htmlTemplates.js\";\r\nimport { MermaidRenderer } from \"./utils/mermaidRenderer.js\";\r\nimport { StorageManager } from \"./utils/storageManager.js\";\r\nimport { XMLFormatter } from \"./utils/xmlFormatter.js\";\r\n// import { XHTMLEditor } from \"./richTextEditor/XHTMLEditor.js\"; // Temporarily disabled\r\nimport { LiveTextEditor } from \"./liveEdit/LiveTextEditor.js\";\r\n// TipTapEditor is loaded from global scope via tiptap.js\r\n\r\nclass ConfluenceEditor {\r\n  constructor() {\r\n    this.isEditorOpen = false;\r\n    this.currentContent = null;\r\n    this.originalContent = null;\r\n    this.onSave = null;\r\n    this.mermaidDiagrams = [];\r\n    this.mermaidDiagramsMap = new Map();\r\n    this.currentSelectedDiagram = null;\r\n    this.currentSelectedDiagramId = null;\r\n    this.editorContainer = null;\r\n    this.textEditor = null; // CodeMirror instance\r\n    this.richTextEditor = null; // Rich Text Editor instance\r\n    this.liveTextEditor = null; // Live Text Editor instance\r\n    this.tipTapEditor = null; // TipTap Rich Text Editor instance\r\n    this.previewContainer = null;\r\n    this.isPreviewMode = false;\r\n    this.autoSaveTimer = null;\r\n    this.isModified = false;\r\n\r\n    // Zoom controls\r\n    this.currentZoom = 1;\r\n    this.dragOffset = { x: 0, y: 0 };\r\n\r\n    // ✅ Anti-flicker properties\r\n    this.isZooming = false;\r\n    this.zoomStep = 0.25;\r\n    this.minZoom = 0.25;\r\n    this.maxZoom = 3.0;\r\n\r\n    // ✅ Debouncing for preview updates\r\n    this.previewUpdateTimeout = null;\r\n    this.isUpdatingPreview = false; // Prevent concurrent updates\r\n\r\n    // Initialize utility classes\r\n    this.storageManager = new StorageManager();\r\n    this.contentSynchronizer = new ContentSynchronizer();\r\n  }\r\n\r\n  openEditor(content, options = {}) {\r\n    if (this.isEditorOpen) {\r\n      this.closeEditor();\r\n    }\r\n\r\n    console.log(\"📝 Opening Confluence Editor with content:\", content);\r\n\r\n    // 💾 ALWAYS use localStorage backup as source of truth (if available)\r\n    const backup = this.storageManager.loadFromLocalStorage();\r\n    if (backup && options.allowBackupRestore !== false) {\r\n      this.currentContent = backup;\r\n      console.log(\"💾 Using localStorage backup as source of truth\");\r\n      console.log(\r\n        \"💾 Backup content length:\",\r\n        backup.full_storage_format?.length || 0\r\n      );\r\n    } else {\r\n      // No backup found - use provided content and save it as backup\r\n      this.currentContent = content;\r\n      console.log(\r\n        \"💾 No backup found, using provided content and saving as backup\"\r\n      );\r\n\r\n      // Save provided content as initial backup\r\n      if (content) {\r\n        this.storageManager.saveToLocalStorage(content);\r\n        console.log(\"� Initial content saved to localStorage backup\");\r\n      }\r\n    }\r\n\r\n    this.originalContent = JSON.parse(JSON.stringify(content)); // Deep copy of original\r\n    this.isEditorOpen = true;\r\n\r\n    // Extract Mermaid diagrams from content\r\n    this.extractMermaidDiagrams();\r\n\r\n    // Create editor UI\r\n    this.createEditorUI(options);\r\n\r\n    // Initialize content tab (default)\r\n    this.initializeContentTab();\r\n  }\r\n\r\n  createEditorUI() {\r\n    const overlay = DOMHelpers.createElement(\"div\", {\r\n      className: \"confluence-editor-overlay\",\r\n    });\r\n\r\n    DOMHelpers.setContent(overlay, HTMLTemplates.getEditorTemplate(), true);\r\n    document.body.appendChild(overlay);\r\n    this.editorContainer = overlay;\r\n\r\n    // Bind events\r\n    this.bindEditorEvents();\r\n  }\r\n\r\n  bindEditorEvents() {\r\n    if (!this.editorContainer) return;\r\n\r\n    // Close button\r\n    const closeBtn = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#editor-close-btn\"\r\n    );\r\n    console.log(\"🔍 Close button found:\", !!closeBtn);\r\n    if (closeBtn) {\r\n      DOMHelpers.addEventListener(closeBtn, \"click\", () => {\r\n        console.log(\"🔄 Close button clicked\");\r\n        this.closeEditor();\r\n      });\r\n    } else {\r\n      console.error(\"❌ Close button not found!\");\r\n    }\r\n\r\n    // Save button\r\n    const saveBtn = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#editor-save-btn\"\r\n    );\r\n    console.log(\"🔍 Save button found:\", !!saveBtn);\r\n    if (saveBtn) {\r\n      DOMHelpers.addEventListener(saveBtn, \"click\", () => {\r\n        console.log(\"💾 Save button clicked\");\r\n        this.saveChanges();\r\n      });\r\n    } else {\r\n      console.error(\"❌ Save button not found!\");\r\n    }\r\n\r\n    // Tab buttons\r\n    const contentTab = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#content-tab\"\r\n    );\r\n    const liveEditTab = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#live-edit-tab\"\r\n    );\r\n    const richTextTab = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#rich-text-tab\"\r\n    );\r\n    const mermaidTab = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#mermaid-tab\"\r\n    );\r\n\r\n    DOMHelpers.addEventListener(contentTab, \"click\", () =>\r\n      this.switchTab(\"content\")\r\n    );\r\n    DOMHelpers.addEventListener(liveEditTab, \"click\", () =>\r\n      this.switchTab(\"live-edit\")\r\n    );\r\n    DOMHelpers.addEventListener(richTextTab, \"click\", () =>\r\n      this.switchTab(\"rich-text\")\r\n    );\r\n    DOMHelpers.addEventListener(mermaidTab, \"click\", () =>\r\n      this.switchTab(\"mermaid\")\r\n    );\r\n\r\n    // Content tab elements - Raw editor event listener (for fallback mode)\r\n    const rawEditor = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#raw-content-editor\"\r\n    );\r\n    if (rawEditor) {\r\n      DOMHelpers.addEventListener(rawEditor, \"input\", () => {\r\n        // Only update preview if raw editor is visible (not hidden)\r\n        if (!rawEditor.classList.contains(\"hidden\")) {\r\n          this.updateContentPreview();\r\n          this.isModified = true;\r\n          this.storageManager.startAutoSave(() => this.saveToLocalStorage());\r\n        }\r\n      });\r\n    }\r\n\r\n    // Mermaid tab elements\r\n    const mermaidSelector = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#mermaid-selector\"\r\n    );\r\n    const mermaidCodeEditor = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#mermaid-code-editor\"\r\n    );\r\n    const aiSendBtn = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#ai-send-btn\"\r\n    );\r\n    const aiPromptInput = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#ai-prompt-input\"\r\n    );\r\n\r\n    DOMHelpers.addEventListener(mermaidSelector, \"change\", (e) =>\r\n      this.selectMermaidDiagram(e.target.value)\r\n    );\r\n\r\n    DOMHelpers.addEventListener(mermaidCodeEditor, \"input\", () => {\r\n      this.debouncedUpdateMermaidPreview();\r\n    });\r\n\r\n    DOMHelpers.addEventListener(aiSendBtn, \"click\", () => this.sendAIPrompt());\r\n\r\n    DOMHelpers.addEventListener(aiPromptInput, \"keypress\", (e) => {\r\n      if (e.key === \"Enter\" && !e.shiftKey) {\r\n        e.preventDefault();\r\n        this.sendAIPrompt();\r\n      }\r\n    });\r\n\r\n    // Zoom controls\r\n    const zoomInBtn = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#zoom-in\"\r\n    );\r\n    const zoomOutBtn = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#zoom-out\"\r\n    );\r\n    const zoomResetBtn = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#zoom-reset\"\r\n    );\r\n\r\n    DOMHelpers.addEventListener(zoomInBtn, \"click\", () => this.zoomIn());\r\n    DOMHelpers.addEventListener(zoomOutBtn, \"click\", () => this.zoomOut());\r\n    DOMHelpers.addEventListener(zoomResetBtn, \"click\", () => this.resetZoom());\r\n\r\n    // Add wheel zoom to mermaid preview\r\n    const mermaidPreview = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#mermaid-preview\"\r\n    );\r\n    DOMHelpers.addEventListener(mermaidPreview, \"wheel\", (e) =>\r\n      this.handleWheel(e)\r\n    );\r\n\r\n    // Close on overlay click\r\n    DOMHelpers.addEventListener(this.editorContainer, \"click\", (e) => {\r\n      if (e.target === this.editorContainer) {\r\n        this.closeEditor();\r\n      }\r\n    });\r\n\r\n    // ESC key to close\r\n    const handleEsc = (e) => {\r\n      if (e.key === \"Escape\") {\r\n        this.closeEditor();\r\n        DOMHelpers.removeEventListener(document, \"keydown\", handleEsc);\r\n      }\r\n    };\r\n    DOMHelpers.addEventListener(document, \"keydown\", handleEsc);\r\n  }\r\n\r\n  // Switch between tabs\r\n  switchTab(tabName) {\r\n    // Update tab buttons\r\n    const tabs = DOMHelpers.querySelectorAll(\r\n      this.editorContainer,\r\n      \".confluence-editor-tab\"\r\n    );\r\n    tabs.forEach((tab) => DOMHelpers.removeClass(tab, \"active\"));\r\n\r\n    const activeTab = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      `#${tabName}-tab`\r\n    );\r\n    DOMHelpers.addClass(activeTab, \"active\");\r\n\r\n    // Update tab content\r\n    const tabContents = DOMHelpers.querySelectorAll(\r\n      this.editorContainer,\r\n      \".tab-content\"\r\n    );\r\n    tabContents.forEach((content) => DOMHelpers.removeClass(content, \"active\"));\r\n\r\n    const activeContent = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      `#${tabName}-tab-content`\r\n    );\r\n    DOMHelpers.addClass(activeContent, \"active\");\r\n\r\n    // Initialize tab-specific content\r\n    if (tabName === \"content\") {\r\n      this.initializeContentTab();\r\n      this.initializeMermaidTab();\r\n    } else if (tabName === \"live-edit\") {\r\n      this.initializeLiveEditTab();\r\n      this.initializeMermaidTab();\r\n    } else if (tabName === \"rich-text\") {\r\n      this.initializeRichTextTab();\r\n      this.initializeMermaidTab();\r\n    } else if (tabName === \"mermaid\") {\r\n      this.initializeMermaidTab();\r\n    }\r\n\r\n    console.log(`Switched to ${tabName} tab`);\r\n  }\r\n\r\n  // Initialize content tab\r\n  async initializeContentTab() {\r\n    const richTextContainer = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#tiptap-editor-container\"\r\n    );\r\n    const rawEditor = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#raw-content-editor\"\r\n    );\r\n\r\n    console.log(\"🔍 Initializing content tab...\");\r\n    console.log(\"Rich text container found:\", !!richTextContainer);\r\n    console.log(\"Raw editor found:\", !!rawEditor);\r\n\r\n    // 💾 ALWAYS load content from localStorage backup (source of truth)\r\n    console.log(\r\n      \"💾 Loading content from localStorage backup for Content tab...\"\r\n    );\r\n    const backupContent = this.storageManager.loadFromLocalStorage();\r\n\r\n    if (richTextContainer && backupContent) {\r\n      try {\r\n        // Update currentContent to match localStorage\r\n        this.currentContent = backupContent;\r\n\r\n        // Get raw content and clean up ```xml markers\r\n        let rawContent =\r\n          backupContent.full_storage_format || backupContent.content || \"\";\r\n\r\n        console.log(\"Raw content length:\", rawContent.length);\r\n\r\n        // Clean XML markers and format for better readability\r\n        rawContent = XMLFormatter.cleanXMLMarkers(rawContent);\r\n        // rawContent = XMLFormatter.formatXHTML(rawContent);\r\n\r\n        console.log(\"Formatted content length:\", rawContent.length);\r\n\r\n        // Hide TipTap container, show raw editor for content tab\r\n        richTextContainer.style.display = \"none\";\r\n        if (rawEditor) {\r\n          rawEditor.classList.remove(\"hidden\");\r\n          rawEditor.value = rawContent;\r\n          DOMHelpers.setContent(rawEditor, rawContent);\r\n        }\r\n\r\n        console.log(\"✅ Raw editor initialized successfully\");\r\n        this.updateContentPreview();\r\n      } catch (error) {\r\n        console.error(\"❌ Failed to initialize Rich Text Editor:\", error);\r\n\r\n        // Fallback to raw editor\r\n        if (rawEditor) {\r\n          console.log(\"🔄 Falling back to raw editor...\");\r\n          let rawContent =\r\n            this.currentContent.full_storage_format ||\r\n            this.currentContent.content ||\r\n            \"\";\r\n          rawContent = XMLFormatter.cleanXMLMarkers(rawContent);\r\n          // rawContent = XMLFormatter.formatXHTML(rawContent);\r\n\r\n          rawEditor.value = rawContent;\r\n          DOMHelpers.setContent(rawEditor, rawContent);\r\n\r\n          // Show raw editor, hide rich text container (fallback mode)\r\n          richTextContainer.style.display = \"none\";\r\n          rawEditor.classList.remove(\"hidden\");\r\n\r\n          this.updateContentPreview();\r\n        }\r\n      }\r\n    } else {\r\n      console.warn(\r\n        \"⚠️ Cannot initialize content tab - missing container or currentContent\"\r\n      );\r\n    }\r\n  }\r\n\r\n  // Setup Rich Text Editor event listeners (temporarily disabled)\r\n  setupRichTextEditorEvents() {\r\n    console.log(\"⚠️ Rich Text Editor events disabled\");\r\n    return;\r\n  }\r\n\r\n  // Setup toggle between Rich Text and Raw view (temporarily disabled)\r\n  setupToggleRawView() {\r\n    const toggleBtn = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#toggle-raw-view\"\r\n    );\r\n\r\n    if (toggleBtn) {\r\n      // Hide toggle button since Rich Text Editor is disabled\r\n      toggleBtn.style.display = \"none\";\r\n    }\r\n\r\n    console.log(\"⚠️ Toggle Raw View disabled\");\r\n  }\r\n\r\n  // Get current content from active editor\r\n  getCurrentEditorContent() {\r\n    console.log(\"🔍 Getting current editor content...\");\r\n\r\n    // Check which tab is currently active\r\n    const activeTab = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \".confluence-editor-tab.active\"\r\n    );\r\n\r\n    console.log(\"🔍 Active tab:\", activeTab ? activeTab.id : \"none\");\r\n\r\n    if (activeTab && activeTab.id === \"live-edit-tab\") {\r\n      console.log(\"📝 Live Edit tab is active\");\r\n\r\n      // Live Edit tab is active\r\n      if (this.liveTextEditor && this.liveTextEditor.isReady()) {\r\n        // Get content from Quill editor\r\n        const content = this.liveTextEditor.getHTML() || \"\";\r\n        console.log(\"📝 Got content from Quill editor:\", {\r\n          length: content.length,\r\n          preview: content.substring(0, 200),\r\n          hasContent: content.length > 0,\r\n        });\r\n        return content;\r\n      } else {\r\n        console.log(\"⚠️ Live Text Editor not ready, trying fallback\");\r\n\r\n        // Get content from fallback textarea\r\n        const fallbackEditor = DOMHelpers.querySelector(\r\n          this.editorContainer,\r\n          \"#live-edit-editor-fallback\"\r\n        );\r\n        if (fallbackEditor) {\r\n          const content = fallbackEditor.value || \"\";\r\n          console.log(\r\n            \"📝 Got content from fallback editor:\",\r\n            content.length,\r\n            \"characters\"\r\n          );\r\n          return content;\r\n        }\r\n      }\r\n    } else if (activeTab && activeTab.id === \"rich-text-tab\") {\r\n      console.log(\"🎨 Rich Text tab is active\");\r\n\r\n      // Rich Text tab is active\r\n      if (this.tipTapEditor && this.tipTapEditor.isReady()) {\r\n        // Get content from TipTap editor\r\n        const content = this.tipTapEditor.getHTML() || \"\";\r\n        console.log(\"🎨 Got content from TipTap editor:\", {\r\n          length: content.length,\r\n          preview: content.substring(0, 200),\r\n          hasContent: content.length > 0,\r\n        });\r\n        return content;\r\n      } else {\r\n        console.log(\"⚠️ TipTap Editor not ready, trying fallback\");\r\n\r\n        // Get content from fallback textarea\r\n        const fallbackEditor = DOMHelpers.querySelector(\r\n          this.editorContainer,\r\n          \"#rich-text-editor-fallback\"\r\n        );\r\n        if (fallbackEditor) {\r\n          const content = fallbackEditor.value || \"\";\r\n          console.log(\r\n            \"🎨 Got content from Rich Text fallback editor:\",\r\n            content.length,\r\n            \"characters\"\r\n          );\r\n          return content;\r\n        }\r\n      }\r\n    }\r\n\r\n    console.log(\"📝 Using raw editor content\");\r\n\r\n    // Default to raw editor\r\n    const rawEditor = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#raw-content-editor\"\r\n    );\r\n    if (rawEditor) {\r\n      const content = rawEditor.value || \"\";\r\n      console.log(\r\n        \"📝 Got content from raw editor:\",\r\n        content.length,\r\n        \"characters\"\r\n      );\r\n      return content;\r\n    }\r\n\r\n    console.warn(\"⚠️ No editor content found\");\r\n    return \"\";\r\n  }\r\n\r\n  // Initialize Live Edit tab\r\n  async initializeLiveEditTab() {\r\n    console.log(\"🔍 Initializing Live Edit tab...\");\r\n\r\n    const liveEditEditorContainer = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#live-edit-editor-container\"\r\n    );\r\n    if (!liveEditEditorContainer) {\r\n      console.warn(\"⚠️ Live Edit editor container not found\");\r\n      return;\r\n    }\r\n\r\n    // Hide TipTap container, show raw editor for Live Edit tab\r\n    const richTextContainer = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#tiptap-editor-container\"\r\n    );\r\n    if (richTextContainer) {\r\n      richTextContainer.style.display = \"none\";\r\n    }\r\n    const rawEditor = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#raw-content-editor\"\r\n    );\r\n    if (rawEditor) {\r\n      rawEditor.classList.add(\"hidden\");\r\n    }\r\n    console.log(\"✅ TipTap container hidden for Live Edit tab\");\r\n\r\n    try {\r\n      // Initialize Live Text Editor with Quill.js\r\n      console.log(\"🎨 Initializing Live Text Editor with Quill.js...\");\r\n      this.liveTextEditor = new LiveTextEditor(liveEditEditorContainer, {\r\n        theme: \"snow\",\r\n      });\r\n\r\n      // Wait for editor to be ready\r\n      await this.waitForLiveTextEditor();\r\n\r\n      // 💾 ALWAYS load content from localStorage backup (source of truth)\r\n      console.log(\r\n        \"💾 Loading content from localStorage backup for Live Edit tab...\"\r\n      );\r\n      const backupContent = this.storageManager.loadFromLocalStorage();\r\n\r\n      if (backupContent) {\r\n        // Update currentContent to match localStorage\r\n        this.currentContent = backupContent;\r\n\r\n        let content =\r\n          backupContent.full_storage_format || backupContent.content || \"\";\r\n        // Clean and format content for editing\r\n        content = XMLFormatter.cleanXMLMarkers(content);\r\n\r\n        // Process Mermaid diagrams immediately after cleaning\r\n        content = await this.processMermaidInContentSync(content);\r\n\r\n        // Format and clean XHTML content\r\n        content = this.normalizeHtmlString(content);\r\n        console.log(\"🎨Final content :\", content);\r\n\r\n        // Set content to Live Text Editor\r\n        this.liveTextEditor.setHTML(content);\r\n        console.log(\"✅ Live Edit content loaded from localStorage backup\");\r\n      } else {\r\n        console.log(\"🔍 No backup content found for Live Edit tab\");\r\n      }\r\n\r\n      // Setup event listeners\r\n      this.setupLiveEditEventListeners();\r\n\r\n      console.log(\"✅ Live Edit tab initialized successfully\");\r\n    } catch (error) {\r\n      console.error(\"❌ Failed to initialize Live Text Editor:\", error);\r\n\r\n      // Fallback to simple textarea\r\n      this.createFallbackTextEditor(liveEditEditorContainer);\r\n    }\r\n  }\r\n\r\n  // Wait for Live Text Editor to be ready\r\n  async waitForLiveTextEditor() {\r\n    const maxWait = 5000; // 5 seconds\r\n    const checkInterval = 100; // 100ms\r\n    let waited = 0;\r\n\r\n    while (!this.liveTextEditor.isReady() && waited < maxWait) {\r\n      await new Promise((resolve) => setTimeout(resolve, checkInterval));\r\n      waited += checkInterval;\r\n    }\r\n\r\n    if (!this.liveTextEditor.isReady()) {\r\n      throw new Error(\"Live Text Editor failed to initialize within timeout\");\r\n    }\r\n  }\r\n\r\n  // Initialize Rich Text tab\r\n  async initializeRichTextTab() {\r\n    console.log(\"🎨 Initializing Rich Text tab...\");\r\n    console.log(\"🎨 Current content:\", this.currentContent);\r\n\r\n    const richTextEditorContainer = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#tiptap-editor-container\"\r\n    );\r\n    if (!richTextEditorContainer) {\r\n      console.warn(\"⚠️ Rich Text editor container not found\");\r\n      return;\r\n    }\r\n\r\n    console.log(\"🎨 Rich Text container found:\", richTextEditorContainer);\r\n    console.log(\r\n      \"🎨 Container innerHTML before:\",\r\n      richTextEditorContainer.innerHTML\r\n    );\r\n\r\n    // Show TipTap container, hide raw editor for Rich Text tab\r\n    richTextEditorContainer.style.display = \"block\";\r\n    const rawEditor = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#raw-content-editor\"\r\n    );\r\n    if (rawEditor) {\r\n      rawEditor.classList.add(\"hidden\");\r\n    }\r\n    console.log(\r\n      \"✅ TipTap container shown, raw editor hidden for Rich Text tab\"\r\n    );\r\n\r\n    try {\r\n      // Check if TipTapEditor is available in global scope\r\n      if (!window.TipTapEditor) {\r\n        throw new Error(\r\n          \"TipTapEditor not found in global scope. Make sure tiptap.js is loaded.\"\r\n        );\r\n      }\r\n\r\n      // Only initialize TipTap editor if it doesn't exist or isn't ready\r\n      if (!this.tipTapEditor || !this.tipTapEditor.isReady()) {\r\n        console.log(\"🎨 Initializing TipTap Rich Text Editor...\");\r\n        this.tipTapEditor = new window.TipTapEditor(richTextEditorContainer, {\r\n          placeholder: \"Start writing your rich content...\",\r\n        });\r\n\r\n        // Wait for editor to be ready\r\n        await this.waitForTipTapEditor();\r\n\r\n        console.log(\"✅ TipTap editor created and ready\");\r\n        console.log(\r\n          \"🎨 Container innerHTML after editor creation:\",\r\n          richTextEditorContainer.innerHTML\r\n        );\r\n      } else {\r\n        console.log(\r\n          \"🔍 TipTap editor already exists and is ready, reusing existing instance\"\r\n        );\r\n        console.log(\r\n          \"🎨 Container innerHTML (existing):\",\r\n          richTextEditorContainer.innerHTML\r\n        );\r\n      }\r\n\r\n      // 💾 ALWAYS load content from localStorage backup (source of truth)\r\n      console.log(\"💾 Loading content from localStorage backup...\");\r\n      const backupContent = this.storageManager.loadFromLocalStorage();\r\n\r\n      if (backupContent) {\r\n        console.log(\"💾 Found backup content, loading into Rich Text editor\");\r\n        let content =\r\n          backupContent.full_storage_format || backupContent.content || \"\";\r\n        content = XMLFormatter.cleanXMLMarkers(content);\r\n\r\n        // Process Mermaid diagrams immediately after cleaning\r\n        content = await this.processMermaidInContentSync(content);\r\n\r\n        // content = XMLFormatter.formatXHTML(content);\r\n\r\n        // Always set content from localStorage backup\r\n        await this.tipTapEditor.setHTML(content);\r\n        console.log(\"✅ Rich Text content loaded from localStorage backup\");\r\n\r\n        // Update currentContent to match localStorage\r\n        this.currentContent = backupContent;\r\n      } else {\r\n        console.log(\r\n          \"🔍 Editor already has content, preserving existing content:\",\r\n          currentEditorContent.substring(0, 100)\r\n        );\r\n      }\r\n\r\n      // Setup Rich Text event listeners\r\n      this.setupRichTextEventListeners();\r\n\r\n      console.log(\"✅ Rich Text tab initialized successfully\");\r\n    } catch (error) {\r\n      console.error(\"❌ Failed to initialize Rich Text tab:\", error);\r\n      this.createFallbackRichTextEditor(richTextEditorContainer);\r\n    }\r\n  }\r\n\r\n  // Wait for TipTap Editor to be ready\r\n  async waitForTipTapEditor() {\r\n    const maxWait = 5000; // 5 seconds\r\n    const checkInterval = 100; // 100ms\r\n    let waited = 0;\r\n\r\n    while (!this.tipTapEditor.isReady() && waited < maxWait) {\r\n      await new Promise((resolve) => setTimeout(resolve, checkInterval));\r\n      waited += checkInterval;\r\n    }\r\n\r\n    if (!this.tipTapEditor.isReady()) {\r\n      throw new Error(\"TipTap Editor failed to initialize within timeout\");\r\n    }\r\n  }\r\n\r\n  // Create fallback rich text editor\r\n  createFallbackRichTextEditor(container) {\r\n    console.log(\"🔄 Creating fallback rich text editor...\");\r\n\r\n    container.innerHTML = `\r\n      <div class=\"rich-text-fallback\">\r\n        <div class=\"fallback-notice\">\r\n          ⚠️ TipTap editor failed to load. Using fallback editor.\r\n        </div>\r\n        <textarea\r\n          class=\"rich-text-editor-fallback\"\r\n          id=\"rich-text-editor-fallback\"\r\n          placeholder=\"Enter your rich content here... (HTML supported)\"\r\n        ></textarea>\r\n      </div>\r\n    `;\r\n\r\n    const textarea = container.querySelector(\"#rich-text-editor-fallback\");\r\n\r\n    // Set initial content\r\n    if (this.currentContent) {\r\n      let content =\r\n        this.currentContent.full_storage_format ||\r\n        this.currentContent.content ||\r\n        \"\";\r\n      content = XMLFormatter.cleanXMLMarkers(content);\r\n      // content = XMLFormatter.formatXHTML(content);\r\n      textarea.value = content;\r\n    }\r\n\r\n    // Setup fallback event listeners\r\n    this.setupRichTextFallbackEventListeners(textarea);\r\n  }\r\n\r\n  // Setup Rich Text event listeners\r\n  setupRichTextEventListeners() {\r\n    if (this.tipTapEditor && this.tipTapEditor.isReady()) {\r\n      console.log(\"🔗 Setting up Rich Text event listeners...\");\r\n\r\n      // Listen for content changes\r\n      const container = this.tipTapEditor.container;\r\n      container.addEventListener(\"tipTapTextChange\", (event) => {\r\n        console.log(\"📝 Rich Text content changed\");\r\n        this.isModified = true;\r\n        this.storageManager.startAutoSave(() => this.saveToLocalStorage());\r\n      });\r\n\r\n      // No sync/clear buttons - removed per user request\r\n\r\n      console.log(\"✅ Rich Text event listeners setup complete\");\r\n    } else {\r\n      console.warn(\r\n        \"⚠️ Cannot setup Rich Text event listeners - editor not ready\"\r\n      );\r\n    }\r\n  }\r\n\r\n  // Setup Rich Text fallback event listeners\r\n  setupRichTextFallbackEventListeners(textarea) {\r\n    textarea.addEventListener(\"input\", () => {\r\n      this.isModified = true;\r\n      this.storageManager.startAutoSave(() => this.saveToLocalStorage());\r\n    });\r\n  }\r\n\r\n  // Sync Rich Text content to Raw Editor (for Save functionality)\r\n  syncRichTextToRawEditor() {\r\n    if (this.tipTapEditor && this.tipTapEditor.isReady()) {\r\n      const htmlContent = this.tipTapEditor.getHTML();\r\n      console.log(\r\n        \"🔄 Syncing Rich Text content to Raw Editor:\",\r\n        htmlContent.substring(0, 200)\r\n      );\r\n\r\n      // Update raw editor with Rich Text content\r\n      const rawEditor = DOMHelpers.querySelector(\r\n        this.editorContainer,\r\n        \"#raw-content-editor\"\r\n      );\r\n      if (rawEditor) {\r\n        rawEditor.value = htmlContent;\r\n        console.log(\"✅ Raw editor updated with Rich Text content\");\r\n      }\r\n\r\n      // Update current content\r\n      if (this.currentContent) {\r\n        this.currentContent.full_storage_format = htmlContent;\r\n        this.currentContent.content = htmlContent;\r\n      }\r\n\r\n      console.log(\"✅ Rich Text content synced to all tabs\");\r\n    }\r\n  }\r\n\r\n  // Create fallback textarea editor\r\n  createFallbackTextEditor(container) {\r\n    console.log(\"🔄 Creating fallback textarea editor...\");\r\n\r\n    container.innerHTML = `\r\n      <textarea\r\n        class=\"live-edit-editor\"\r\n        id=\"live-edit-editor-fallback\"\r\n        placeholder=\"Enter your content here... Mermaid diagrams will be automatically rendered in the preview.\"\r\n      ></textarea>\r\n    `;\r\n\r\n    const textarea = container.querySelector(\"#live-edit-editor-fallback\");\r\n\r\n    // Set initial content\r\n    if (this.currentContent) {\r\n      let content =\r\n        this.currentContent.full_storage_format ||\r\n        this.currentContent.content ||\r\n        \"\";\r\n      content = XMLFormatter.cleanXMLMarkers(content);\r\n      // content = XMLFormatter.formatXHTML(content);\r\n      textarea.value = content;\r\n    }\r\n\r\n    // Setup fallback event listeners\r\n    this.setupFallbackEventListeners(textarea);\r\n  }\r\n\r\n  // Setup Live Edit event listeners\r\n  setupLiveEditEventListeners() {\r\n    if (this.liveTextEditor && this.liveTextEditor.isReady()) {\r\n      // Setup Quill.js event listeners\r\n      const editorContainer = DOMHelpers.querySelector(\r\n        this.editorContainer,\r\n        \"#live-edit-editor-container\"\r\n      );\r\n\r\n      if (editorContainer) {\r\n        // Debounced auto-save\r\n        const debouncedUpdate = this.debounce(() => {\r\n          this.isModified = true;\r\n          this.storageManager.startAutoSave(() => this.saveToLocalStorage());\r\n        }, 500);\r\n\r\n        // Listen to custom events from LiveTextEditor\r\n        DOMHelpers.addEventListener(\r\n          editorContainer,\r\n          \"liveTextChange\",\r\n          debouncedUpdate\r\n        );\r\n\r\n        console.log(\"✅ Live Edit event listeners setup for Quill.js\");\r\n      }\r\n    }\r\n  }\r\n\r\n  // Setup fallback event listeners for textarea\r\n  setupFallbackEventListeners(textarea) {\r\n    if (!textarea) return;\r\n\r\n    // Debounced auto-save\r\n    const debouncedUpdate = this.debounce(() => {\r\n      this.isModified = true;\r\n      this.storageManager.startAutoSave(() => this.saveToLocalStorage());\r\n    }, 500);\r\n\r\n    // Real-time preview update\r\n    DOMHelpers.addEventListener(textarea, \"input\", debouncedUpdate);\r\n    DOMHelpers.addEventListener(textarea, \"paste\", () => {\r\n      setTimeout(debouncedUpdate, 100); // Delay for paste content to be processed\r\n    });\r\n\r\n    console.log(\"✅ Fallback Live Edit event listeners setup\");\r\n  }\r\n\r\n  // Initialize mermaid tab\r\n  initializeMermaidTab() {\r\n    console.log(\"🔍 Initializing mermaid tab...\");\r\n\r\n    // Sync content from active editor first before extracting diagrams\r\n    console.log(\"📊 Syncing content from active editor before extraction...\");\r\n    const currentEditorContent = this.getCurrentEditorContent();\r\n    if (this.currentContent && currentEditorContent) {\r\n      console.log(\"📊 Updating currentContent with latest editor content:\", {\r\n        oldLength: this.currentContent.full_storage_format?.length || 0,\r\n        newLength: currentEditorContent.length,\r\n        contentChanged:\r\n          this.currentContent.full_storage_format !== currentEditorContent,\r\n      });\r\n      this.currentContent.full_storage_format = currentEditorContent;\r\n    }\r\n\r\n    // Always extract diagrams to ensure sync with current content\r\n    console.log(\"📊 Extracting diagrams from current content...\");\r\n    this.extractMermaidDiagrams();\r\n\r\n    // Merge with stored diagrams from localStorage to ensure all diagrams are available\r\n    console.log(\"📊 Merging with stored diagrams from localStorage...\");\r\n    const storedDiagrams = this.storageManager.getMermaidDiagramMappings();\r\n    if (storedDiagrams && storedDiagrams.size > 0) {\r\n      storedDiagrams.forEach((storedData, diagramId) => {\r\n        // Only add if not already in current content\r\n        if (!this.mermaidDiagramsMap.has(diagramId)) {\r\n          this.mermaidDiagramsMap.set(diagramId, storedData);\r\n          console.log(\r\n            `📊 Added stored diagram: ${storedData.title} (${storedData.type})`\r\n          );\r\n        }\r\n      });\r\n    }\r\n\r\n    console.log(\"Diagrams available:\", this.mermaidDiagrams.length);\r\n    console.log(\r\n      \"DiagramsMap size (after merge):\",\r\n      this.mermaidDiagramsMap.size\r\n    );\r\n    this.populateMermaidSelector();\r\n  }\r\n\r\n  // Update Live Edit preview\r\n  async updateLiveEditPreview() {\r\n    const liveEditPreview = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#live-edit-preview\"\r\n    );\r\n\r\n    if (!liveEditPreview) return;\r\n\r\n    // Get content from either Quill editor or fallback textarea\r\n    let content = \"\";\r\n\r\n    if (this.liveTextEditor && this.liveTextEditor.isReady()) {\r\n      // Get content from Quill editor\r\n      content = this.liveTextEditor.getHTML();\r\n    } else {\r\n      // Get content from fallback textarea\r\n      const fallbackEditor = DOMHelpers.querySelector(\r\n        this.editorContainer,\r\n        \"#live-edit-editor-fallback\"\r\n      );\r\n      if (fallbackEditor) {\r\n        content = fallbackEditor.value;\r\n      }\r\n    }\r\n\r\n    // Show loading state\r\n    liveEditPreview.classList.add(\"loading\");\r\n\r\n    try {\r\n      // Process content and render Mermaid diagrams\r\n      const processedContent = await this.processLiveEditContent(content);\r\n\r\n      // Set processed content\r\n      DOMHelpers.setContent(liveEditPreview, processedContent, true);\r\n\r\n      // Render Mermaid diagrams\r\n      await this.renderMermaidInLivePreview();\r\n\r\n      console.log(\"✅ Live Edit preview updated\");\r\n    } catch (error) {\r\n      console.error(\"❌ Failed to update Live Edit preview:\", error);\r\n      DOMHelpers.setContent(\r\n        liveEditPreview,\r\n        `<p style=\"color: red;\">❌ Preview Error: ${error.message}</p>`,\r\n        true\r\n      );\r\n    } finally {\r\n      // Remove loading state\r\n      liveEditPreview.classList.remove(\"loading\");\r\n    }\r\n  }\r\n\r\n  // Process Live Edit content for preview\r\n  async processLiveEditContent(content) {\r\n    if (!content) {\r\n      return '<div class=\"preview-placeholder\"><p>📝 Start typing to see live preview...</p></div>';\r\n    }\r\n\r\n    // Convert basic markdown-like syntax to HTML\r\n    let processedContent = content;\r\n\r\n    // Convert headers\r\n    processedContent = processedContent.replace(/^### (.*$)/gim, \"<h3>$1</h3>\");\r\n    processedContent = processedContent.replace(/^## (.*$)/gim, \"<h2>$1</h2>\");\r\n    processedContent = processedContent.replace(/^# (.*$)/gim, \"<h1>$1</h1>\");\r\n\r\n    // Convert paragraphs\r\n    processedContent = processedContent.replace(/\\n\\n/g, \"</p><p>\");\r\n    processedContent = \"<p>\" + processedContent + \"</p>\";\r\n\r\n    // Convert line breaks\r\n    processedContent = processedContent.replace(/\\n/g, \"<br>\");\r\n\r\n    // Clean up empty paragraphs\r\n    processedContent = processedContent.replace(/<p><\\/p>/g, \"\");\r\n    processedContent = processedContent.replace(/<p>\\s*<\\/p>/g, \"\");\r\n\r\n    return processedContent;\r\n  }\r\n\r\n  // Render Mermaid diagrams in Live Edit preview\r\n  async renderMermaidInLivePreview() {\r\n    const liveEditPreview = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#live-edit-preview\"\r\n    );\r\n\r\n    if (!liveEditPreview) return;\r\n\r\n    // Find all mermaid code blocks\r\n    const mermaidBlocks = liveEditPreview.querySelectorAll(\"code\");\r\n\r\n    for (const block of mermaidBlocks) {\r\n      const content = block.textContent.trim();\r\n\r\n      // Check if it's a mermaid diagram\r\n      if (this.isMermaidDiagram(content)) {\r\n        try {\r\n          console.log(\"🎨 Rendering Mermaid diagram in Live Edit preview\");\r\n\r\n          // Load Mermaid if not already loaded\r\n          await MermaidRenderer.loadMermaidScript();\r\n\r\n          // Create mermaid container\r\n          const mermaidContainer = document.createElement(\"div\");\r\n          mermaidContainer.className = \"mermaid\";\r\n          mermaidContainer.textContent = content;\r\n\r\n          // Replace code block with mermaid container\r\n          block.parentNode.replaceChild(mermaidContainer, block);\r\n\r\n          // Initialize mermaid\r\n          if (window.mermaid) {\r\n            window.mermaid.initialize({\r\n              startOnLoad: false,\r\n              securityLevel: \"loose\",\r\n              theme: \"default\",\r\n            });\r\n\r\n            // Render the diagram\r\n            await window.mermaid.init(undefined, mermaidContainer);\r\n          }\r\n        } catch (error) {\r\n          console.error(\"❌ Failed to render Mermaid diagram:\", error);\r\n          // Show error in place of diagram\r\n          const errorDiv = document.createElement(\"div\");\r\n          errorDiv.style.cssText =\r\n            \"color: red; padding: 10px; border: 1px solid red; border-radius: 4px; margin: 10px 0;\";\r\n          errorDiv.textContent = `❌ Mermaid Error: ${error.message}`;\r\n          block.parentNode.replaceChild(errorDiv, block);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // Check if content is a Mermaid diagram\r\n  isMermaidDiagram(content) {\r\n    const mermaidKeywords = [\r\n      \"graph\",\r\n      \"flowchart\",\r\n      \"sequenceDiagram\",\r\n      \"classDiagram\",\r\n      \"stateDiagram\",\r\n      \"erDiagram\",\r\n      \"journey\",\r\n      \"gantt\",\r\n      \"pie\",\r\n      \"gitgraph\",\r\n      \"mindmap\",\r\n      \"timeline\",\r\n    ];\r\n\r\n    const firstLine = content.split(\"\\n\")[0].trim().toLowerCase();\r\n    return mermaidKeywords.some((keyword) => firstLine.includes(keyword));\r\n  }\r\n\r\n  // Format Live Edit content\r\n  formatLiveEditContent() {\r\n    try {\r\n      if (this.liveTextEditor && this.liveTextEditor.isReady()) {\r\n        // Format content in Quill editor\r\n        let content = this.liveTextEditor.getHTML();\r\n        // content = XMLFormatter.formatXHTML(content);\r\n        this.liveTextEditor.setHTML(content);\r\n      } else {\r\n        // Format content in fallback textarea\r\n        const fallbackEditor = DOMHelpers.querySelector(\r\n          this.editorContainer,\r\n          \"#live-edit-editor-fallback\"\r\n        );\r\n        if (fallbackEditor) {\r\n          let content = fallbackEditor.value;\r\n          // content = XMLFormatter.formatXHTML(content);\r\n          fallbackEditor.value = content;\r\n        }\r\n      }\r\n\r\n      this.updateLiveEditPreview();\r\n      console.log(\"✅ Live Edit content formatted\");\r\n    } catch (error) {\r\n      console.error(\"❌ Failed to format Live Edit content:\", error);\r\n    }\r\n  }\r\n\r\n  // Sync Live Edit with Raw Content\r\n  syncLiveEditWithRawContent() {\r\n    const rawEditor = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#raw-content-editor\"\r\n    );\r\n\r\n    if (!rawEditor) return;\r\n\r\n    try {\r\n      // Get content from raw editor\r\n      const rawContent = rawEditor.value;\r\n\r\n      // Set to live edit editor\r\n      if (this.liveTextEditor && this.liveTextEditor.isReady()) {\r\n        // Set content to Quill editor\r\n        this.liveTextEditor.setHTML(rawContent);\r\n      } else {\r\n        // Set content to fallback textarea\r\n        const fallbackEditor = DOMHelpers.querySelector(\r\n          this.editorContainer,\r\n          \"#live-edit-editor-fallback\"\r\n        );\r\n        if (fallbackEditor) {\r\n          fallbackEditor.value = rawContent;\r\n        }\r\n      }\r\n\r\n      // Update preview\r\n      this.updateLiveEditPreview();\r\n\r\n      console.log(\"✅ Live Edit synced with Raw Content\");\r\n    } catch (error) {\r\n      console.error(\"❌ Failed to sync Live Edit with Raw Content:\", error);\r\n    }\r\n  }\r\n\r\n  // Toggle Live Edit fullscreen\r\n  toggleLiveEditFullscreen() {\r\n    const liveEditPreview = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#live-edit-preview\"\r\n    );\r\n\r\n    if (!liveEditPreview) return;\r\n\r\n    if (liveEditPreview.classList.contains(\"fullscreen\")) {\r\n      liveEditPreview.classList.remove(\"fullscreen\");\r\n      liveEditPreview.style.cssText = \"\";\r\n    } else {\r\n      liveEditPreview.classList.add(\"fullscreen\");\r\n      liveEditPreview.style.cssText = `\r\n        position: fixed;\r\n        top: 0;\r\n        left: 0;\r\n        width: 100vw;\r\n        height: 100vh;\r\n        z-index: 10001;\r\n        background: white;\r\n        padding: 20px;\r\n        overflow-y: auto;\r\n      `;\r\n    }\r\n  }\r\n\r\n  // Debounce utility function\r\n  debounce(func, wait) {\r\n    let timeout;\r\n    return function executedFunction(...args) {\r\n      const later = () => {\r\n        clearTimeout(timeout);\r\n        func(...args);\r\n      };\r\n      clearTimeout(timeout);\r\n      timeout = setTimeout(later, wait);\r\n    };\r\n  }\r\n\r\n  // Update content preview\r\n  updateContentPreview() {\r\n    const preview = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#content-preview\"\r\n    );\r\n\r\n    if (!preview) return;\r\n\r\n    // Get content from the currently active editor\r\n    const content = this.getCurrentEditorContent();\r\n\r\n    // Update current content\r\n    if (this.currentContent) {\r\n      this.currentContent.full_storage_format = content;\r\n      // Mark as modified if content changed\r\n      if (\r\n        this.originalContent &&\r\n        content !== this.originalContent.full_storage_format\r\n      ) {\r\n        this.isModified = true;\r\n        this.updateSaveButtonState();\r\n      }\r\n    }\r\n\r\n    // Render preview\r\n    this.renderContentPreview(content, preview);\r\n  }\r\n\r\n  // Render content preview\r\n  renderContentPreview(content, previewElement) {\r\n    // Apply inline styles for preview\r\n    const processedContent = HTMLTemplates.applyPreviewStyles(content);\r\n\r\n    // Set the processed content to preview element\r\n    DOMHelpers.setContent(previewElement, processedContent, true);\r\n\r\n    // Render Mermaid diagrams\r\n    this.renderMermaidDiagramsInPreview();\r\n  }\r\n\r\n  // Render Mermaid diagrams in preview\r\n  renderMermaidDiagramsInPreview() {\r\n    // Use the new comprehensive Mermaid initialization\r\n    setTimeout(() => {\r\n      this.initializeMermaidInPreview();\r\n    }, 100);\r\n  }\r\n\r\n  // Initialize Mermaid diagrams in preview\r\n  async initializeMermaidInPreview() {\r\n    try {\r\n      // Initialize Mermaid\r\n      await MermaidRenderer.initializeMermaid();\r\n\r\n      console.log(\"🎨 Initializing Mermaid diagrams in preview...\");\r\n\r\n      // Find all mermaid code blocks in the preview\r\n      const previewDiv = DOMHelpers.querySelector(\r\n        this.editorContainer,\r\n        \"#content-preview\"\r\n      );\r\n      if (!previewDiv) return;\r\n\r\n      // Look for Confluence Mermaid structured macros\r\n      const mermaidElements = DOMHelpers.querySelectorAll(\r\n        previewDiv,\r\n        'ac\\\\:structured-macro[ac\\\\:name=\"mermaid\"]'\r\n      );\r\n\r\n      mermaidElements.forEach(async (element, index) => {\r\n        // Get the code parameter from Confluence structured macro\r\n        const codeParam = DOMHelpers.querySelector(\r\n          element,\r\n          'ac\\\\:parameter[ac\\\\:name=\"code\"]'\r\n        );\r\n        if (!codeParam) {\r\n          console.warn(\"⚠️ Mermaid macro found but no code parameter\");\r\n          return;\r\n        }\r\n\r\n        const mermaidCode = DOMHelpers.getContent(codeParam).trim();\r\n        console.log(\r\n          \"🔍 Found Confluence Mermaid diagram:\",\r\n          mermaidCode.substring(0, 50) + \"...\"\r\n        );\r\n\r\n        // Always process Confluence mermaid macros\r\n        if (mermaidCode) {\r\n          // Create a new div for the mermaid diagram\r\n          const mermaidDiv = HTMLTemplates.createMermaidContainer(index);\r\n\r\n          // Validate parent node before replacing\r\n          if (!element.parentNode) {\r\n            console.error(\r\n              \"❌ Cannot replace Mermaid element in preview: no parent node\"\r\n            );\r\n            console.error(\r\n              \"❌ Mermaid code:\",\r\n              mermaidCode.substring(0, 100) + \"...\"\r\n            );\r\n            return;\r\n          }\r\n\r\n          // Replace the original element\r\n          try {\r\n            element.parentNode.replaceChild(mermaidDiv, element);\r\n          } catch (replaceError) {\r\n            console.error(\r\n              \"❌ Failed to replace Mermaid element in preview:\",\r\n              replaceError\r\n            );\r\n            console.error(\r\n              \"❌ Mermaid code:\",\r\n              mermaidCode.substring(0, 100) + \"...\"\r\n            );\r\n            return;\r\n          }\r\n\r\n          // Render the diagram\r\n          const diagramId = `preview-mermaid-svg-${index}`;\r\n          await MermaidRenderer.renderDiagram(\r\n            diagramId,\r\n            mermaidCode,\r\n            mermaidDiv\r\n          );\r\n        }\r\n      });\r\n    } catch (error) {\r\n      console.error(\"❌ Failed to initialize Mermaid in preview:\", error);\r\n    }\r\n  }\r\n\r\n  // Populate mermaid selector using Map\r\n  populateMermaidSelector() {\r\n    const selector = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#mermaid-selector\"\r\n    );\r\n    if (!selector) {\r\n      console.error(\"❌ Mermaid selector not found\");\r\n      return;\r\n    }\r\n\r\n    console.log(\"🔄 Populating Mermaid selector...\");\r\n    console.log(`📊 DiagramsMap size: ${this.mermaidDiagramsMap?.size || 0}`);\r\n    console.log(`📊 Current options count: ${selector.options.length}`);\r\n\r\n    // Clear ALL existing options completely\r\n    selector.innerHTML = \"\";\r\n\r\n    // Add default option\r\n    const defaultOption = document.createElement(\"option\");\r\n    defaultOption.value = \"\";\r\n    defaultOption.textContent = \"📊 Select diagram to edit...\";\r\n    selector.appendChild(defaultOption);\r\n\r\n    console.log(`📊 After clear, options count: ${selector.options.length}`);\r\n\r\n    // Try to get diagrams from current content first, then fallback to localStorage\r\n    let diagramsToUse = this.mermaidDiagramsMap;\r\n\r\n    // If no diagrams in current content, try to load from localStorage\r\n    if (!diagramsToUse || diagramsToUse.size === 0) {\r\n      console.log(\"📊 No diagrams in current content, trying localStorage...\");\r\n      const storedDiagrams = this.storageManager.getMermaidDiagramMappings();\r\n      if (storedDiagrams && storedDiagrams.size > 0) {\r\n        diagramsToUse = storedDiagrams;\r\n        console.log(\r\n          `📊 Using ${storedDiagrams.size} diagrams from localStorage`\r\n        );\r\n      }\r\n    }\r\n\r\n    // Only add diagrams that actually exist\r\n    if (diagramsToUse && diagramsToUse.size > 0) {\r\n      let addedCount = 0;\r\n\r\n      // Create a Set to track added diagram IDs to prevent duplicates\r\n      const addedDiagrams = new Set();\r\n\r\n      diagramsToUse.forEach((diagramData, diagramId) => {\r\n        // Only add if not already added and has valid content\r\n        if (\r\n          !addedDiagrams.has(diagramId) &&\r\n          diagramData.content &&\r\n          diagramData.content.trim()\r\n        ) {\r\n          const option = document.createElement(\"option\");\r\n          option.value = diagramId;\r\n          option.textContent = `${diagramData.title} (${diagramData.type})`;\r\n          selector.appendChild(option);\r\n          addedDiagrams.add(diagramId);\r\n          addedCount++;\r\n          console.log(\r\n            `📊 Added option ${addedCount}: ${diagramData.title} (${diagramData.type})`\r\n          );\r\n        }\r\n      });\r\n\r\n      console.log(\r\n        `✅ Added ${addedCount} unique diagrams to selector (total options: ${selector.options.length})`\r\n      );\r\n    } else {\r\n      console.warn(\"⚠️ No Mermaid diagrams found to populate selector\");\r\n    }\r\n\r\n    // Remove existing event listener to prevent duplicates\r\n    if (this.handleMermaidSelectorChange) {\r\n      selector.removeEventListener(\"change\", this.handleMermaidSelectorChange);\r\n    }\r\n\r\n    // Add fresh event listener\r\n    this.handleMermaidSelectorChange = (e) => {\r\n      const selectedId = e.target.value;\r\n      console.log(`🎯 Selected diagram: ${selectedId}`);\r\n      this.selectMermaidDiagram(selectedId);\r\n    };\r\n    selector.addEventListener(\"change\", this.handleMermaidSelectorChange);\r\n\r\n    console.log(\r\n      `✅ Populated ${this.mermaidDiagramsMap?.size || 0} diagrams in selector`\r\n    );\r\n  }\r\n\r\n  // Select mermaid diagram\r\n  selectMermaidDiagram(diagramId) {\r\n    if (!diagramId) {\r\n      this.clearMermaidEditor();\r\n      return;\r\n    }\r\n\r\n    // Get diagram from current Map first\r\n    let diagramData = this.mermaidDiagramsMap.get(diagramId);\r\n    let diagram = this.mermaidDiagrams.find((d) => d.id === diagramId);\r\n\r\n    // If found in current content, ensure originCode is set\r\n    if (diagramData && diagram) {\r\n      // Ensure diagram has originCode (use originalCode from extraction or current code)\r\n      if (!diagram.originCode) {\r\n        diagram.originCode = diagram.originalCode || diagram.code;\r\n      }\r\n    }\r\n\r\n    // If not found in current content, try localStorage\r\n    if (!diagramData) {\r\n      console.log(\r\n        `📊 Diagram ${diagramId} not found in current content, checking localStorage...`\r\n      );\r\n      const storedDiagrams = this.storageManager.getMermaidDiagramMappings();\r\n      diagramData = storedDiagrams.get(diagramId);\r\n\r\n      if (diagramData) {\r\n        console.log(`📊 Found diagram ${diagramId} in localStorage`);\r\n        // Create a temporary diagram object for editing\r\n        diagram = {\r\n          id: diagramId,\r\n          title: diagramData.title,\r\n          type: diagramData.type,\r\n          code: diagramData.content,\r\n          originCode: diagramData.originCode, // Use the stored originCode (match[0])\r\n        };\r\n      } else {\r\n        console.error(\r\n          `❌ Diagram not found in current content or localStorage: ${diagramId}`\r\n        );\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Update code editor\r\n    const codeEditor = this.editorContainer.querySelector(\r\n      \"#mermaid-code-editor\"\r\n    );\r\n    if (codeEditor) {\r\n      codeEditor.value = diagramData.content;\r\n      this.currentSelectedDiagram = diagram;\r\n      this.currentSelectedDiagramId = diagramId;\r\n      this.updateMermaidPreview().catch((error) => {\r\n        console.error(\"❌ Error updating Mermaid preview:\", error);\r\n      });\r\n\r\n      // Add event listener for code changes\r\n      codeEditor.removeEventListener(\"input\", this.handleMermaidCodeChange);\r\n      this.handleMermaidCodeChange = () => {\r\n        if (this.currentSelectedDiagram && this.currentSelectedDiagramId) {\r\n          const newCode = codeEditor.value;\r\n          console.log(\"new code\", newCode);\r\n\r\n          // Update diagram code in memory (both array and map)\r\n          this.currentSelectedDiagram.code = newCode;\r\n\r\n          // Update in current content map if exists\r\n          const currentDiagramData = this.mermaidDiagramsMap.get(\r\n            this.currentSelectedDiagramId\r\n          );\r\n          if (currentDiagramData) {\r\n            currentDiagramData.content = newCode;\r\n            // Keep originCode unchanged (it should be the original match[0])\r\n          } else {\r\n            // If not in current content, add it to the map\r\n            this.mermaidDiagramsMap.set(this.currentSelectedDiagramId, {\r\n              title: this.currentSelectedDiagram.title,\r\n              type: this.currentSelectedDiagram.type,\r\n              content: newCode,\r\n              originCode: this.currentSelectedDiagram.originCode, // Use the original match[0]\r\n            });\r\n          }\r\n\r\n          // Note: MERMAID_DIAGRAM_MAPPINGS should only be created when generating document\r\n          // Individual diagram edits should not affect the original mappings\r\n          // The mappings are used for replacing images back to original code when creating pages\r\n\r\n          // Track the change for synchronization\r\n          this.contentSynchronizer.trackDiagramChange(\r\n            this.currentSelectedDiagramId,\r\n            newCode\r\n          );\r\n\r\n          // Update preview with debouncing\r\n          this.debouncedUpdateMermaidPreview();\r\n\r\n          // Mark as modified\r\n          this.isModified = true;\r\n          this.updateSaveButtonState();\r\n\r\n          console.log(\r\n            `📝 Updated diagram ${this.currentSelectedDiagramId} in memory and localStorage`\r\n          );\r\n        }\r\n      };\r\n      codeEditor.addEventListener(\"input\", this.handleMermaidCodeChange);\r\n    }\r\n\r\n    console.log(`✅ Selected diagram: ${diagramId} (${diagramData.type})`);\r\n  }\r\n\r\n  // Clear mermaid editor\r\n  clearMermaidEditor() {\r\n    const codeEditor = this.editorContainer.querySelector(\r\n      \"#mermaid-code-editor\"\r\n    );\r\n    const preview = this.editorContainer.querySelector(\"#mermaid-preview\");\r\n\r\n    if (codeEditor) codeEditor.value = \"\";\r\n    if (preview) {\r\n      preview.innerHTML =\r\n        '<div class=\"mermaid-placeholder\">Select a diagram to preview</div>';\r\n    }\r\n\r\n    this.currentSelectedDiagram = null;\r\n  }\r\n\r\n  // ✅ Simple debounced update - no anti-flicker interference\r\n  debouncedUpdateMermaidPreview() {\r\n    // Only skip if actively zooming (not if just updated recently)\r\n    if (this.isZooming) {\r\n      return;\r\n    }\r\n\r\n    // Clear existing timeout\r\n    if (this.previewUpdateTimeout) {\r\n      clearTimeout(this.previewUpdateTimeout);\r\n    }\r\n\r\n    // Set new timeout\r\n    this.previewUpdateTimeout = setTimeout(() => {\r\n      if (!this.isZooming && !this.isUpdatingPreview) {\r\n        this.updateMermaidPreview().catch((error) => {\r\n          console.error(\"❌ Error updating Mermaid preview:\", error);\r\n        });\r\n      }\r\n    }, 300); // Increased debounce for stability\r\n  }\r\n\r\n  // Update mermaid preview\r\n  async updateMermaidPreview() {\r\n    // ✅ Skip update if currently zooming to prevent flicker\r\n    if (this.isZooming) {\r\n      return;\r\n    }\r\n\r\n    // ✅ Skip if already updating to prevent concurrent updates\r\n    if (this.isUpdatingPreview) {\r\n      return;\r\n    }\r\n\r\n    // ✅ Set updating flag\r\n    this.isUpdatingPreview = true;\r\n\r\n    const codeEditor = this.editorContainer.querySelector(\r\n      \"#mermaid-code-editor\"\r\n    );\r\n    const preview = this.editorContainer.querySelector(\"#mermaid-preview\");\r\n\r\n    if (!codeEditor || !preview) return;\r\n\r\n    const code = codeEditor.value.trim();\r\n    if (!code) {\r\n      preview.innerHTML =\r\n        '<div class=\"mermaid-placeholder\">Enter Mermaid code to preview</div>';\r\n      return;\r\n    }\r\n\r\n    // ✅ Store current zoom level\r\n    const currentZoom = this.currentZoom;\r\n\r\n    // Update current diagram\r\n    if (this.currentSelectedDiagram) {\r\n      this.currentSelectedDiagram.code = code;\r\n    }\r\n\r\n    // Render mermaid using MermaidRenderer to avoid SVG error appending\r\n    try {\r\n      // Clear preview first\r\n      preview.innerHTML =\r\n        '<div class=\"mermaid-placeholder\">Rendering diagram...</div>';\r\n\r\n      // Create unique diagram ID\r\n      const diagramId = `mermaid-editor-preview-${Date.now()}`;\r\n\r\n      // Use MermaidRenderer to safely render the diagram\r\n      await MermaidRenderer.renderDiagram(diagramId, code, preview);\r\n\r\n      // ✅ Reapply zoom after rendering to maintain zoom level\r\n      setTimeout(() => {\r\n        if (currentZoom !== 1) {\r\n          this.currentZoom = currentZoom;\r\n        }\r\n        this.updateZoom();\r\n      }, 100);\r\n    } catch (error) {\r\n      console.error(\"❌ Error rendering Mermaid in editor preview:\", error);\r\n      preview.innerHTML = `\r\n        <div class=\"mermaid-placeholder\" style=\"color: #dc3545;\">\r\n          ❌ Error rendering diagram:<br>\r\n          <small>${error.message}</small>\r\n        </div>\r\n      `;\r\n    } finally {\r\n      // ✅ Always reset updating flag\r\n      this.isUpdatingPreview = false;\r\n    }\r\n  }\r\n\r\n  // Send AI prompt - EXACT copy from extension logic\r\n  async sendAIPrompt() {\r\n    const promptInput = this.editorContainer.querySelector(\"#ai-prompt-input\");\r\n    const messagesContainer =\r\n      this.editorContainer.querySelector(\"#ai-chat-messages\");\r\n\r\n    if (!promptInput || !messagesContainer) return;\r\n\r\n    const prompt = promptInput.value.trim();\r\n    if (!prompt) return;\r\n\r\n    // Check if a diagram is selected and validate it\r\n    if (!this.currentSelectedDiagram || !this.currentSelectedDiagramId) {\r\n      this.addAIMessage(\r\n        \"ai\",\r\n        \"⚠️ Please select a Mermaid diagram first to edit it.\"\r\n      );\r\n      return;\r\n    }\r\n\r\n    // Double-check the selected diagram exists in the map\r\n    const diagramInMap = this.mermaidDiagramsMap.get(\r\n      this.currentSelectedDiagramId\r\n    );\r\n    if (!diagramInMap) {\r\n      this.addAIMessage(\r\n        \"ai\",\r\n        \"❌ Selected diagram not found. Please select a valid diagram.\"\r\n      );\r\n      return;\r\n    }\r\n\r\n    console.log(`🎯 AI editing diagram: ${this.currentSelectedDiagramId}`, {\r\n      title: diagramInMap.title,\r\n      type: diagramInMap.type,\r\n      currentCode: this.currentSelectedDiagram.code?.substring(0, 50) + \"...\",\r\n    });\r\n\r\n    // Add user message\r\n    this.addAIMessage(\"user\", prompt);\r\n\r\n    // Clear input and show loading\r\n    promptInput.value = \"\";\r\n    this.addAIMessage(\"ai\", \"🤖 Processing your request...\");\r\n\r\n    try {\r\n      // Get current settings for AI model\r\n      const settings = await StorageManager.getSettings();\r\n\r\n      // Prepare request payload similar to extension\r\n      const requestBody = {\r\n        content: this.currentContent?.full_storage_format || \"\",\r\n        diagram_code: this.currentSelectedDiagram.code,\r\n        user_request: prompt,\r\n        selectedModel: settings.selectedModel || \"sonar-pro\",\r\n      };\r\n\r\n      console.log(\"🤖 Sending AI request:\", requestBody);\r\n\r\n      // Call AI API (same endpoint as extension)\r\n      const response = await fetch(API_URLS.EDIT_DIAGRAM, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify(requestBody),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorData = await response.json();\r\n        throw new Error(\r\n          errorData.error || `HTTP ${response.status}: ${response.statusText}`\r\n        );\r\n      }\r\n\r\n      const data = await response.json();\r\n\r\n      if (data.success && data.edited_diagram) {\r\n        // Clean and validate the AI response\r\n        const cleanedDiagram = this.cleanAIResponse(data.edited_diagram);\r\n\r\n        if (cleanedDiagram && cleanedDiagram.trim()) {\r\n          // Validate we're still editing the same diagram\r\n          const currentDiagramInMap = this.mermaidDiagramsMap.get(\r\n            this.currentSelectedDiagramId\r\n          );\r\n          if (!currentDiagramInMap) {\r\n            throw new Error(\"Selected diagram no longer exists\");\r\n          }\r\n\r\n          console.log(`🔄 Updating diagram ${this.currentSelectedDiagramId}:`, {\r\n            oldCode: this.currentSelectedDiagram.code?.substring(0, 30) + \"...\",\r\n            newCode: cleanedDiagram.substring(0, 30) + \"...\",\r\n          });\r\n\r\n          // Update ONLY the selected diagram\r\n          this.currentSelectedDiagram.code = cleanedDiagram;\r\n          currentDiagramInMap.content = cleanedDiagram;\r\n\r\n          // Update the code editor to reflect the change\r\n          const codeEditor = this.editorContainer.querySelector(\r\n            \"#mermaid-code-editor\"\r\n          );\r\n          if (codeEditor) {\r\n            codeEditor.value = cleanedDiagram;\r\n            console.log(\"✅ Code editor updated with AI response\");\r\n          }\r\n\r\n          // Update preview for this specific diagram\r\n          this.updateMermaidPreview().catch((error) => {\r\n            console.error(\"❌ Error updating Mermaid preview:\", error);\r\n          });\r\n\r\n          // Mark content as modified for synchronization\r\n          console.log(\r\n            `🔄 Diagram ${this.currentSelectedDiagramId} updated by AI`\r\n          );\r\n\r\n          // Update the content will be handled by syncAllContent when saving\r\n\r\n          // Remove loading message and add success message\r\n          this.removeLastAIMessage();\r\n          this.addAIMessage(\"ai\", `✅ Updated diagram: ${prompt}`);\r\n\r\n          // Show success notification\r\n          if (\r\n            typeof window !== \"undefined\" &&\r\n            window[\"KToolNotificationUtils\"]\r\n          ) {\r\n            window[\"KToolNotificationUtils\"].success(\r\n              \"AI Assistant\",\r\n              \"Diagram updated successfully!\"\r\n            );\r\n          }\r\n        } else {\r\n          throw new Error(\"Invalid Mermaid syntax in AI response\");\r\n        }\r\n      } else {\r\n        throw new Error(\"Invalid response format or missing edited_diagram\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"❌ AI API Error:\", error);\r\n\r\n      // Remove loading message and add error message\r\n      this.removeLastAIMessage();\r\n      this.addAIMessage(\r\n        \"ai\",\r\n        `❌ Error: ${error.message}\\n\\n🔄 Please try again or adjust your request.`\r\n      );\r\n\r\n      // Show error notification\r\n      if (typeof window !== \"undefined\" && window[\"KToolNotificationUtils\"]) {\r\n        window[\"KToolNotificationUtils\"].error(\r\n          \"AI Assistant\",\r\n          `Error: ${error.message}`\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  // Clean AI response - enhanced validation\r\n  cleanAIResponse(response) {\r\n    if (!response) return \"\";\r\n\r\n    console.log(\"🧹 Cleaning AI response:\", response.substring(0, 100) + \"...\");\r\n\r\n    // Remove markdown code blocks and common AI response patterns\r\n    let cleaned = response\r\n      .replace(/```mermaid\\n?/gi, \"\")\r\n      .replace(/```\\n?/g, \"\")\r\n      .replace(/^Here's the updated.*?:\\s*/i, \"\")\r\n      .replace(/^Updated diagram.*?:\\s*/i, \"\")\r\n      .replace(/^The modified.*?:\\s*/i, \"\");\r\n\r\n    // Remove extra whitespace and newlines at start/end\r\n    cleaned = cleaned.trim();\r\n\r\n    // Split by lines and remove empty lines at start/end\r\n    const lines = cleaned.split(\"\\n\");\r\n    const nonEmptyStart = lines.findIndex((line) => line.trim() !== \"\");\r\n    const nonEmptyEnd = lines\r\n      .slice()\r\n      .reverse()\r\n      .findIndex((line) => line.trim() !== \"\");\r\n\r\n    if (nonEmptyStart !== -1 && nonEmptyEnd !== -1) {\r\n      cleaned = lines\r\n        .slice(nonEmptyStart, lines.length - nonEmptyEnd)\r\n        .join(\"\\n\");\r\n    }\r\n\r\n    // Basic validation - should start with a mermaid diagram type\r\n    const validStarts = [\r\n      \"graph\",\r\n      \"flowchart\",\r\n      \"sequenceDiagram\",\r\n      \"classDiagram\",\r\n      \"stateDiagram\",\r\n      \"erDiagram\",\r\n      \"journey\",\r\n      \"gantt\",\r\n      \"pie\",\r\n      \"gitgraph\",\r\n      \"mindmap\",\r\n      \"timeline\",\r\n    ];\r\n\r\n    const firstLine = cleaned.split(\"\\n\")[0].trim().toLowerCase();\r\n    const hasValidStart = validStarts.some((start) =>\r\n      firstLine.startsWith(start.toLowerCase())\r\n    );\r\n\r\n    if (!hasValidStart) {\r\n      console.warn(\r\n        \"⚠️ AI response may not be valid Mermaid syntax:\",\r\n        firstLine\r\n      );\r\n      console.warn(\"Expected to start with one of:\", validStarts.join(\", \"));\r\n    }\r\n\r\n    console.log(\"✅ Cleaned AI response:\", cleaned.substring(0, 100) + \"...\");\r\n    return cleaned;\r\n  }\r\n\r\n  // Remove last AI message (for loading states)\r\n  removeLastAIMessage() {\r\n    const messagesContainer =\r\n      this.editorContainer.querySelector(\"#ai-chat-messages\");\r\n    if (!messagesContainer) return;\r\n\r\n    const messages = messagesContainer.querySelectorAll(\".ai-message\");\r\n    if (messages.length > 0) {\r\n      const lastMessage = messages[messages.length - 1];\r\n      if (\r\n        lastMessage.querySelector(\".ai-text\").textContent.includes(\"Processing\")\r\n      ) {\r\n        lastMessage.remove();\r\n      }\r\n    }\r\n  }\r\n\r\n  // Add AI message\r\n  addAIMessage(type, text) {\r\n    const messagesContainer = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#ai-chat-messages\"\r\n    );\r\n    if (!messagesContainer) return;\r\n\r\n    const messageHTML = HTMLTemplates.createAIMessage(type, text);\r\n    DOMHelpers.setContent(\r\n      messagesContainer,\r\n      DOMHelpers.getContent(messagesContainer) + messageHTML,\r\n      true\r\n    );\r\n    messagesContainer.scrollTop = messagesContainer.scrollHeight;\r\n  }\r\n\r\n  extractMermaidDiagrams() {\r\n    console.log(\"🔍 Extracting Mermaid diagrams...\");\r\n\r\n    if (!this.currentContent?.full_storage_format) {\r\n      console.warn(\"⚠️ No content to extract diagrams from:\", {\r\n        hasCurrentContent: !!this.currentContent,\r\n        hasFullStorageFormat: !!this.currentContent?.full_storage_format,\r\n        contentLength: this.currentContent?.full_storage_format?.length || 0,\r\n      });\r\n      this.mermaidDiagrams = [];\r\n      this.mermaidDiagramsMap = new Map();\r\n      return;\r\n    }\r\n\r\n    console.log(\"📊 Extracting from content:\", {\r\n      contentLength: this.currentContent.full_storage_format.length,\r\n      contentPreview: this.currentContent.full_storage_format.substring(0, 300),\r\n      hasMermaidKeyword:\r\n        this.currentContent.full_storage_format.includes(\"mermaid\"),\r\n    });\r\n\r\n    const { diagrams, diagramsMap } = MermaidRenderer.extractMermaidDiagrams(\r\n      this.currentContent.full_storage_format\r\n    );\r\n\r\n    console.log(\"📊 Extraction results:\", {\r\n      diagramsCount: diagrams.length,\r\n      diagramsMapSize: diagramsMap.size,\r\n      diagramTitles: diagrams.map((d) => d.title),\r\n    });\r\n\r\n    this.mermaidDiagrams = diagrams;\r\n    this.mermaidDiagramsMap = diagramsMap;\r\n  }\r\n\r\n  updateStatus(message) {\r\n    const status = this.editorContainer?.querySelector(\"#editor-status\");\r\n    if (status) {\r\n      status.textContent = message;\r\n      setTimeout(() => {\r\n        status.textContent = \"Sẵn sàng\";\r\n      }, 3000);\r\n    }\r\n  }\r\n\r\n  // Save current content to localStorage (for auto-save)\r\n  saveToLocalStorage() {\r\n    console.log(\"💾 Auto-saving to localStorage...\");\r\n\r\n    try {\r\n      // Get current content from active editor\r\n      const currentEditorContent = this.getCurrentEditorContent();\r\n\r\n      if (currentEditorContent) {\r\n        // Load existing backup or create new one\r\n        let backupContent =\r\n          this.storageManager.loadFromLocalStorage() ||\r\n          this.currentContent ||\r\n          {};\r\n\r\n        // Update backup with latest editor content\r\n        backupContent.full_storage_format = currentEditorContent;\r\n        backupContent.content = currentEditorContent;\r\n\r\n        // Save updated content to localStorage\r\n        this.storageManager.saveToLocalStorage(backupContent);\r\n\r\n        // Update currentContent to match localStorage\r\n        this.currentContent = backupContent;\r\n\r\n        console.log(\"✅ Content auto-saved to localStorage:\", {\r\n          contentLength: currentEditorContent.length,\r\n          timestamp: new Date().toLocaleTimeString(),\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.error(\"❌ Failed to auto-save to localStorage:\", error);\r\n    }\r\n  }\r\n\r\n  async saveChanges() {\r\n    console.log(\"💾 Saving changes...\");\r\n\r\n    try {\r\n      // Get current content from active editor (Rich Text or Raw)\r\n      const currentEditorContent = this.getCurrentEditorContent();\r\n\r\n      console.log(\"💾 Save process - Current editor content:\", {\r\n        length: currentEditorContent.length,\r\n        hasContent: currentEditorContent.length > 0,\r\n        preview: currentEditorContent.substring(0, 300),\r\n      });\r\n\r\n      // Update current content with editor content\r\n      if (this.currentContent && currentEditorContent) {\r\n        console.log(\"💾 Before update - currentContent.full_storage_format:\", {\r\n          length: this.currentContent.full_storage_format?.length || 0,\r\n          preview:\r\n            this.currentContent.full_storage_format?.substring(0, 200) ||\r\n            \"empty\",\r\n        });\r\n\r\n        this.currentContent.full_storage_format = currentEditorContent;\r\n\r\n        console.log(\"💾 After update - currentContent.full_storage_format:\", {\r\n          length: this.currentContent.full_storage_format?.length || 0,\r\n          preview:\r\n            this.currentContent.full_storage_format?.substring(0, 200) ||\r\n            \"empty\",\r\n        });\r\n\r\n        console.log(\r\n          \"📝 Updated content from editor:\",\r\n          currentEditorContent.length,\r\n          \"characters\"\r\n        );\r\n      } else {\r\n        console.warn(\"⚠️ Cannot update content:\", {\r\n          hasCurrentContent: !!this.currentContent,\r\n          hasEditorContent: !!currentEditorContent,\r\n        });\r\n      }\r\n\r\n      // Check which tab is active to decide sync strategy\r\n      const activeTab = DOMHelpers.querySelector(\r\n        this.editorContainer,\r\n        \".confluence-editor-tab.active\"\r\n      );\r\n\r\n      if (activeTab && activeTab.id === \"live-edit-tab\") {\r\n        console.log(\r\n          \"💾 Live Edit tab active - skipping syncAllContent to preserve editor content\"\r\n        );\r\n        // Don't sync from raw editor when Live Edit is active\r\n        // Content was already updated from Live Text Editor above\r\n      } else if (activeTab && activeTab.id === \"rich-text-tab\") {\r\n        console.log(\"💾 Rich Text tab active - syncing content to other tabs\");\r\n        // Rich Text tab is active - sync content to raw editor\r\n        this.syncRichTextToRawEditor();\r\n\r\n        // Then sync all content sources\r\n        this.currentContent = this.contentSynchronizer.syncAllContent(\r\n          this.currentContent,\r\n          this.editorContainer,\r\n          this.mermaidDiagrams\r\n        );\r\n      } else {\r\n        console.log(\"💾 Raw/other tab active - syncing all content sources\");\r\n        // Sync all content sources (includes raw editor sync)\r\n        this.currentContent = this.contentSynchronizer.syncAllContent(\r\n          this.currentContent,\r\n          this.editorContainer,\r\n          this.mermaidDiagrams\r\n        );\r\n      }\r\n\r\n      // Validate content before saving\r\n      const validation = this.contentSynchronizer.validateContent(\r\n        this.currentContent\r\n      );\r\n      if (!validation.isValid) {\r\n        throw new Error(\r\n          `Content validation failed: ${validation.errors.join(\", \")}`\r\n        );\r\n      }\r\n\r\n      // Save using storage manager (supports both callback and localStorage)\r\n      console.log(\"💾 Saving content with localStorage backup enabled\");\r\n      console.log(\"💾 Final content being saved:\", {\r\n        length: this.currentContent.full_storage_format?.length || 0,\r\n        preview:\r\n          this.currentContent.full_storage_format?.substring(0, 200) || \"empty\",\r\n      });\r\n\r\n      const saveResults = await this.storageManager.saveContent(\r\n        this.currentContent,\r\n        this.onSave,\r\n        {\r\n          enableLocalStorage: true,\r\n          enableCallback: true,\r\n          showNotification: true,\r\n        }\r\n      );\r\n\r\n      console.log(\"💾 Save results:\", saveResults);\r\n\r\n      // Note: MERMAID_DIAGRAM_MAPPINGS is only created when generating document\r\n      // Save operations should not affect these mappings\r\n\r\n      // Reset modified state and update button\r\n      this.isModified = false;\r\n      this.updateSaveButtonState();\r\n\r\n      // Update original content to new saved state\r\n      this.originalContent = JSON.parse(JSON.stringify(this.currentContent));\r\n\r\n      // Don't re-extract diagrams after save to avoid duplicates\r\n      console.log(\"✅ Skipping diagram re-extraction to prevent duplicates\");\r\n\r\n      console.log(\"✅ Changes saved successfully\", saveResults);\r\n\r\n      // Save completed - auto close editor immediately\r\n      console.log(\"💾 Save completed - closing editor...\");\r\n      this.closeEditor();\r\n    } catch (error) {\r\n      console.error(\"❌ Error saving changes:\", error);\r\n      this.storageManager.showNotification(\r\n        `❌ Lỗi khi lưu: ${error.message}`,\r\n        \"error\"\r\n      );\r\n    }\r\n  }\r\n\r\n  // Update save button state based on modifications\r\n  updateSaveButtonState() {\r\n    const saveBtn = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#editor-save-btn\"\r\n    );\r\n    if (!saveBtn) return;\r\n\r\n    if (this.isModified) {\r\n      DOMHelpers.setContent(saveBtn, \"💾 Save *\");\r\n      saveBtn.style.background = \"#28a745\";\r\n      saveBtn.title = \"Có thay đổi chưa lưu\";\r\n    } else {\r\n      DOMHelpers.setContent(saveBtn, \"💾 Save\");\r\n      saveBtn.style.background = \"#007bff\";\r\n      saveBtn.title = \"Save\";\r\n    }\r\n  }\r\n\r\n  // ✅ Stop all preview updates for zoom\r\n  stopAllPreviewUpdates() {\r\n    // Clear timeout\r\n    if (this.previewUpdateTimeout) {\r\n      clearTimeout(this.previewUpdateTimeout);\r\n      this.previewUpdateTimeout = null;\r\n    }\r\n\r\n    // Set flags\r\n    this.isZooming = true;\r\n    this.isUpdatingPreview = false;\r\n  }\r\n\r\n  // Zoom controls methods\r\n  zoomIn() {\r\n    if (this.currentZoom < this.maxZoom) {\r\n      this.stopAllPreviewUpdates(); // ✅ Stop updates first\r\n      this.currentZoom = Math.min(\r\n        this.currentZoom + this.zoomStep,\r\n        this.maxZoom\r\n      );\r\n      this.applyZoom();\r\n    }\r\n  }\r\n\r\n  zoomOut() {\r\n    if (this.currentZoom > this.minZoom) {\r\n      this.stopAllPreviewUpdates(); // ✅ Stop updates first\r\n      this.currentZoom = Math.max(\r\n        this.currentZoom - this.zoomStep,\r\n        this.minZoom\r\n      );\r\n      this.applyZoom();\r\n    }\r\n  }\r\n\r\n  resetZoom() {\r\n    this.stopAllPreviewUpdates(); // ✅ Stop updates first\r\n    this.currentZoom = 1;\r\n    this.dragOffset = { x: 0, y: 0 };\r\n    this.applyZoom();\r\n  }\r\n\r\n  // ✅ Apply zoom with anti-flicker\r\n  applyZoom() {\r\n    // Set zoom flag to prevent flicker\r\n    this.isZooming = true;\r\n\r\n    // Clear any pending preview updates\r\n    if (this.previewUpdateTimeout) {\r\n      clearTimeout(this.previewUpdateTimeout);\r\n      this.previewUpdateTimeout = null;\r\n    }\r\n\r\n    // Apply zoom\r\n    this.updateZoom();\r\n\r\n    // Reset zoom flag\r\n    setTimeout(() => {\r\n      this.isZooming = false;\r\n    }, 100);\r\n  }\r\n\r\n  updateZoom() {\r\n    const preview = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#mermaid-preview\"\r\n    );\r\n    const zoomLevel = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#zoom-level\"\r\n    );\r\n\r\n    if (preview) {\r\n      const mermaidContent = DOMHelpers.querySelector(preview, \".mermaid, svg\");\r\n      if (mermaidContent) {\r\n        mermaidContent.style.transform = `scale(${this.currentZoom}) translate(${this.dragOffset.x}px, ${this.dragOffset.y}px)`;\r\n        mermaidContent.style.transformOrigin = \"center center\";\r\n        mermaidContent.style.transition = \"transform 0.2s ease\";\r\n      }\r\n    }\r\n\r\n    if (zoomLevel) {\r\n      DOMHelpers.setContent(\r\n        zoomLevel,\r\n        `${Math.round(this.currentZoom * 100)}%`\r\n      );\r\n    }\r\n  }\r\n\r\n  handleWheel(e) {\r\n    e.preventDefault();\r\n    if (e.deltaY < 0) {\r\n      this.zoomIn();\r\n    } else {\r\n      this.zoomOut();\r\n    }\r\n  }\r\n\r\n  closeEditor() {\r\n    console.log(\"🔄 Closing editor...\");\r\n\r\n    // Stop auto-save\r\n    this.storageManager.stopAutoSave();\r\n\r\n    // Destroy TipTap Rich Text Editor\r\n    if (this.tipTapEditor) {\r\n      console.log(\"🗑️ Destroying TipTap Rich Text Editor...\");\r\n      if (this.tipTapEditor.destroy) {\r\n        this.tipTapEditor.destroy();\r\n      }\r\n      this.tipTapEditor = null;\r\n    }\r\n\r\n    // Legacy Rich Text Editor (if exists)\r\n    if (this.richTextEditor) {\r\n      console.log(\"🗑️ Destroying Legacy Rich Text Editor...\");\r\n      this.richTextEditor.destroy();\r\n      this.richTextEditor = null;\r\n    }\r\n\r\n    // Destroy Live Text Editor\r\n    if (this.liveTextEditor) {\r\n      console.log(\"🗑️ Destroying Live Text Editor...\");\r\n      this.liveTextEditor.destroy();\r\n      this.liveTextEditor = null;\r\n    }\r\n\r\n    if (this.editorContainer) {\r\n      DOMHelpers.removeElement(this.editorContainer);\r\n      this.editorContainer = null;\r\n    }\r\n\r\n    this.isEditorOpen = false;\r\n    // DON'T clear currentContent and originalContent - keep them for next edit session\r\n    // this.currentContent = null;\r\n    // this.originalContent = null;\r\n    this.mermaidDiagrams = [];\r\n    this.mermaidDiagramsMap = new Map();\r\n    this.currentSelectedDiagram = null;\r\n    this.currentSelectedDiagramId = null;\r\n    this.isModified = false;\r\n\r\n    console.log(\"🔍 Content preserved after close:\", {\r\n      hasCurrentContent: !!this.currentContent,\r\n      hasOriginalContent: !!this.originalContent,\r\n      currentContentLength:\r\n        this.currentContent?.full_storage_format?.length || 0,\r\n    });\r\n\r\n    // Reset zoom state\r\n    this.currentZoom = 1;\r\n    this.dragOffset = { x: 0, y: 0 };\r\n\r\n    console.log(\"✅ Editor closed\");\r\n  }\r\n\r\n  // Public method to set save callback\r\n  setSaveCallback(callback) {\r\n    this.onSave = callback;\r\n  }\r\n\r\n  // Check if editor is currently open\r\n  isOpen() {\r\n    return this.isEditorOpen;\r\n  }\r\n\r\n  /**\r\n   * Format and clean XHTML content (remove whitespace, normalize structure)\r\n   */\r\n  normalizeHtmlString(html) {\r\n    if (!html || typeof html !== \"string\") {\r\n      return html;\r\n    }\r\n\r\n    // 1. Loại bỏ các dòng trống đầu/cuối chuỗi\r\n    let cleanedHtml = html.trim();\r\n\r\n    // 2. Thay thế tất cả các khoảng trắng, tab, và dòng mới liên tiếp (ví dụ: \\n\\t  )\r\n    // bên trong các thẻ HTML hoặc giữa các thẻ\r\n    // thành MỘT khoảng trắng duy nhất.\r\n    // [ \\t\\n\\r]+ là regex bắt tất cả các loại khoảng trắng\r\n    cleanedHtml = cleanedHtml.replace(/[ \\t\\n\\r]+/g, \" \");\r\n\r\n    // 3. Xóa khoảng trắng ngay trước và sau các thẻ HTML\r\n    // (Điều này thường loại bỏ khoảng trắng giữa các thẻ block như </div> <div>)\r\n    cleanedHtml = cleanedHtml.replace(/> </g, \"><\");\r\n\r\n    // 4. (Tùy chọn) Thêm lại các dấu xuống dòng hợp lí sau các thẻ BLOCK\r\n    // Ví dụ: sau </div> hoặc </p> để giữ cấu trúc dễ đọc.\r\n    // Nếu không cần cấu trúc block, bạn có thể bỏ qua bước này.\r\n    // cleanedHtml = cleanedHtml.replace(/></g, '>\\n<');\r\n\r\n    return cleanedHtml;\r\n  }\r\n\r\n  /**\r\n   * Process Mermaid diagrams in content synchronously (convert to img tags)\r\n   */\r\n  async processMermaidInContentSync(content) {\r\n    try {\r\n      console.log(\"🔍 Processing Mermaid diagrams in content (sync)...\");\r\n\r\n      // Use extractMermaidDiagrams to find all Mermaid content\r\n      const { diagrams } = MermaidRenderer.extractMermaidDiagrams(content);\r\n\r\n      if (diagrams.length === 0) {\r\n        console.log(\"ℹ️ No Mermaid diagrams found in content\");\r\n        return content;\r\n      }\r\n\r\n      let processedContent = content;\r\n      console.log(`🎨 Found ${diagrams.length} Mermaid diagrams to process`);\r\n\r\n      // Prepare diagram mapping for storage\r\n      const diagramMappings = {};\r\n\r\n      // Process each diagram\r\n      for (let i = 0; i < diagrams.length; i++) {\r\n        const diagram = diagrams[i];\r\n        console.log(\r\n          `🎨 Processing Mermaid diagram ${i + 1}/${diagrams.length}:`,\r\n          diagram.code.substring(0, 100)\r\n        );\r\n\r\n        try {\r\n          // Generate real Mermaid diagram as base64 image\r\n          const imageBase64 = await this.generateMermaidImage(diagram.code);\r\n\r\n          if (imageBase64) {\r\n            // Create image with diagram ID for later replacement\r\n            const imageHtml = `<img id=\"${diagram.id}\" src=\"${imageBase64}\" alt=\"Mermaid Diagram\" style=\"max-width: 100%; height: auto;\" data-mermaid-id=\"${diagram.id}\" />`;\r\n            console.log(\r\n              `🎨 Generated image HTML for diagram ${diagram.id}:`,\r\n              imageHtml\r\n            );\r\n            processedContent = processedContent.replace(\r\n              diagram.originalMatch,\r\n              imageHtml\r\n            );\r\n\r\n            // Store diagram mapping for later use\r\n            diagramMappings[diagram.id] = {\r\n              originalCode: diagram.originalMatch,\r\n              imageId: diagram.id,\r\n              code: diagram.code,\r\n              type: diagram.type,\r\n            };\r\n\r\n            console.log(\r\n              `✅ Mermaid diagram ${i + 1} converted to real image with ID: ${\r\n                diagram.id\r\n              }`\r\n            );\r\n          } else {\r\n            // Fallback to placeholder if generation fails\r\n            const placeholderImg = `<img id=\"${diagram.id}\" src=\"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzMzMyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk1lcm1haWQgRGlhZ3JhbTwvdGV4dD48L3N2Zz4=\" alt=\"Mermaid Diagram (Placeholder)\" style=\"max-width: 100%; height: auto; border: 1px dashed #ccc;\" data-mermaid-id=\"${diagram.id}\" />`;\r\n            processedContent = processedContent.replace(\r\n              diagram.originalMatch,\r\n              placeholderImg\r\n            );\r\n\r\n            // Store diagram mapping even for placeholder\r\n            diagramMappings[diagram.id] = {\r\n              originalCode: diagram.originalMatch,\r\n              imageId: diagram.id,\r\n              code: diagram.code,\r\n              type: diagram.type,\r\n            };\r\n\r\n            console.log(\r\n              `⚠️ Mermaid diagram ${i + 1} replaced with placeholder with ID: ${\r\n                diagram.id\r\n              }`\r\n            );\r\n          }\r\n        } catch (error) {\r\n          console.warn(`⚠️ Failed to process Mermaid diagram ${i + 1}:`, error);\r\n          // Keep original macro if conversion fails\r\n        }\r\n      }\r\n\r\n      // Note: This method only converts diagrams to images for display\r\n      // MERMAID_DIAGRAM_MAPPINGS should only be created when generating document\r\n\r\n      console.log(\r\n        `🎨 Processed ${diagrams.length} Mermaid diagrams in content`,\r\n        processedContent\r\n      );\r\n      return processedContent;\r\n    } catch (error) {\r\n      console.error(\"❌ Error processing Mermaid in content:\", error);\r\n      return content; // Return original content if processing fails\r\n    }\r\n  }\r\n  /**\r\n   * Generate Mermaid diagram as base64 image\r\n   */\r\n  async generateMermaidImage(mermaidCode) {\r\n    try {\r\n      if (!window.mermaid) {\r\n        console.warn(\"⚠️ Mermaid not available\");\r\n        return null;\r\n      }\r\n\r\n      // Create temporary container\r\n      const tempContainer = document.createElement(\"div\");\r\n      tempContainer.style.position = \"absolute\";\r\n      tempContainer.style.left = \"-9999px\";\r\n      tempContainer.style.top = \"-9999px\";\r\n      tempContainer.style.width = \"800px\";\r\n      tempContainer.style.height = \"600px\";\r\n      document.body.appendChild(tempContainer);\r\n\r\n      try {\r\n        // Generate unique ID\r\n        const diagramId = `mermaid-temp-${Date.now()}`;\r\n\r\n        // Render Mermaid diagram\r\n        const { svg } = await window.mermaid.render(diagramId, mermaidCode);\r\n\r\n        // Convert SVG to base64\r\n        const base64 =\r\n          \"data:image/svg+xml;base64,\" +\r\n          btoa(\r\n            encodeURIComponent(svg).replace(/%([0-9A-F]{2})/g, (_, p1) =>\r\n              String.fromCharCode(parseInt(p1, 16))\r\n            )\r\n          );\r\n\r\n        return base64;\r\n      } finally {\r\n        // Clean up temporary container\r\n        document.body.removeChild(tempContainer);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"❌ Failed to generate Mermaid image:\", error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // Get current content\r\n  getCurrentContent() {\r\n    if (this.textEditor) {\r\n      // Update content from editor\r\n      const editorContent = this.textEditor.getValue();\r\n      if (this.currentContent) {\r\n        this.currentContent.full_storage_format = editorContent;\r\n      }\r\n    }\r\n    return this.currentContent;\r\n  }\r\n}\r\n\r\n// Export for use in content.js\r\nexport { ConfluenceEditor };\r\n","/**\n * Mermaid Preview Handler\n * Handles rendering and updating of Mermaid diagram previews\n */\nimport { MermaidRenderer } from \"../utils/mermaidRenderer.js\";\n\nexport class MermaidPreview {\n  constructor() {\n    this.previewContainer = null;\n  }\n\n  /**\n   * Initialize preview container\n   */\n  initialize() {\n    this.previewContainer = document.getElementById(\n      \"mermaid-preview-container\"\n    );\n    if (!this.previewContainer) {\n      console.error(\"❌ Preview container not found\");\n      return false;\n    }\n    return true;\n  }\n\n  /**\n   * Update Mermaid preview from code\n   * @param {string} code - Mermaid diagram code\n   */\n  async updatePreview(code) {\n    if (!this.previewContainer) {\n      console.error(\"❌ Preview container not initialized\");\n      return;\n    }\n\n    if (!code || !code.trim()) {\n      this.showPlaceholder(\"Enter Mermaid code to preview\");\n      return;\n    }\n\n    try {\n      // Clean and validate code\n      const cleanCode = this.cleanMermaidCode(code);\n      console.log(\"🧹 Cleaned Mermaid code:\", cleanCode);\n\n      // Validate code\n      const validation = this.validateMermaidCode(cleanCode);\n      if (!validation.isValid) {\n        this.showError(`Invalid Mermaid syntax: ${validation.error}`);\n        return;\n      }\n\n      // Initialize Mermaid if needed\n      await MermaidRenderer.initializeMermaid();\n\n      // Create unique diagram ID\n      const diagramId = `mermaid-ai-chat-preview-${Date.now()}`;\n\n      // Show loading\n      this.showPlaceholder(\"Rendering diagram...\");\n\n      // Render diagram\n      await MermaidRenderer.renderDiagram(\n        diagramId,\n        cleanCode,\n        this.previewContainer\n      );\n\n      console.log(\"✅ Mermaid preview updated successfully\");\n    } catch (error) {\n      console.error(\"❌ Error updating Mermaid preview:\", error);\n      this.showError(error.message);\n    }\n  }\n\n  /**\n   * Show placeholder message\n   * @param {string} message - Placeholder message\n   */\n  showPlaceholder(message) {\n    if (\n      this.previewContainer &&\n      this.previewContainer.nodeType === Node.ELEMENT_NODE &&\n      document.contains(this.previewContainer)\n    ) {\n      this.previewContainer.innerHTML = `\n        <div class=\"mermaid-preview-placeholder\">\n          ${message}\n        </div>\n      `;\n    } else {\n      console.error(\"❌ Invalid or detached preview container for placeholder\");\n    }\n  }\n\n  /**\n   * Show error message\n   * @param {string} errorMessage - Error message to display\n   */\n  showError(errorMessage) {\n    if (\n      this.previewContainer &&\n      this.previewContainer.nodeType === Node.ELEMENT_NODE &&\n      document.contains(this.previewContainer)\n    ) {\n      this.previewContainer.innerHTML = `\n        <div class=\"mermaid-preview-placeholder\" style=\"color: #dc3545;\">\n          ❌ Error rendering diagram:<br>\n          <small>${errorMessage}</small>\n        </div>\n      `;\n    } else {\n      console.error(\n        \"❌ Invalid or detached preview container for error display\"\n      );\n      console.error(\"❌ Error message:\", errorMessage);\n    }\n  }\n\n  /**\n   * Clear preview\n   */\n  clear() {\n    this.showPlaceholder(\"Click on a Mermaid diagram to start editing\");\n  }\n\n  /**\n   * Get current preview content\n   * @returns {string} Current preview HTML content\n   */\n  getCurrentContent() {\n    return this.previewContainer ? this.previewContainer.innerHTML : \"\";\n  }\n\n  /**\n   * Clean Mermaid code - remove unwanted characters and normalize\n   * @param {string} code - Raw Mermaid code\n   * @returns {string} Cleaned code\n   */\n  cleanMermaidCode(code) {\n    if (!code) return \"\";\n\n    // Remove HTML entities\n    let cleaned = code\n      .replace(/&lt;/g, \"<\")\n      .replace(/&gt;/g, \">\")\n      .replace(/&amp;/g, \"&\")\n      .replace(/&quot;/g, '\"')\n      .replace(/&#39;/g, \"'\");\n\n    // Remove CDATA sections\n    cleaned = cleaned.replace(/<!\\[CDATA\\[(.*?)\\]\\]>/gs, \"$1\");\n\n    // Remove HTML tags\n    cleaned = cleaned.replace(/<[^>]*>/g, \"\");\n\n    // Normalize whitespace\n    cleaned = cleaned.replace(/\\r\\n/g, \"\\n\").replace(/\\r/g, \"\\n\");\n\n    // Remove excessive whitespace but preserve structure\n    cleaned = cleaned.replace(/\\n\\s*\\n\\s*\\n/g, \"\\n\\n\");\n\n    // Trim\n    cleaned = cleaned.trim();\n\n    return cleaned;\n  }\n\n  /**\n   * Validate Mermaid code syntax\n   * @param {string} code - Mermaid code to validate\n   * @returns {Object} Validation result\n   */\n  validateMermaidCode(code) {\n    if (!code || !code.trim()) {\n      return {\n        isValid: false,\n        error: \"Code is empty\",\n      };\n    }\n\n    const trimmed = code.trim();\n\n    // Check for valid Mermaid diagram types\n    const validStarters = [\n      \"graph\",\n      \"flowchart\",\n      \"sequenceDiagram\",\n      \"classDiagram\",\n      \"stateDiagram\",\n      \"erDiagram\",\n      \"journey\",\n      \"gantt\",\n      \"pie\",\n      \"gitgraph\",\n      \"mindmap\",\n      \"timeline\",\n      \"sankey\",\n      \"requirement\",\n    ];\n\n    const hasValidStarter = validStarters.some((starter) =>\n      trimmed.toLowerCase().startsWith(starter.toLowerCase())\n    );\n\n    if (!hasValidStarter) {\n      return {\n        isValid: false,\n        error: `Must start with a valid diagram type: ${validStarters.join(\n          \", \"\n        )}`,\n      };\n    }\n\n    // Check for common syntax issues\n    if (trimmed.includes(\"undefined\") || trimmed.includes(\"null\")) {\n      return {\n        isValid: false,\n        error: \"Contains undefined or null values\",\n      };\n    }\n\n    // Check for unbalanced brackets\n    const openBrackets = (trimmed.match(/\\[/g) || []).length;\n    const closeBrackets = (trimmed.match(/\\]/g) || []).length;\n    if (openBrackets !== closeBrackets) {\n      return {\n        isValid: false,\n        error: \"Unbalanced square brackets\",\n      };\n    }\n\n    return {\n      isValid: true,\n      error: null,\n    };\n  }\n}\n","/**\n * Mermaid AI Service\n * Handles AI API calls for Mermaid diagram modifications\n */\nimport { ApiClient, ConfluenceApi } from \"../../shared/api.js\";\nimport { API_URLS } from \"../../shared/constants.js\";\n\nexport class MermaidAIService {\n  constructor() {\n    this.apiClient = new ApiClient();\n  }\n\n  /**\n   * Send prompt to AI for diagram modification\n   * @param {string} diagramContent - Current Mermaid diagram code\n   * @param {string} userPrompt - User's modification request\n   * @returns {Promise<Object>} AI response with modified diagram\n   */\n  async modifyDiagram(diagramContent, userPrompt) {\n    console.log(\"🤖 Sending AI request for diagram modification...\");\n\n    // Validate inputs\n    const promptValidation = this.validateUserPrompt(userPrompt);\n    if (!promptValidation.isValid) {\n      throw new Error(promptValidation.error);\n    }\n\n    const diagramValidation = this.validateDiagramContent(diagramContent);\n    if (!diagramValidation.isValid) {\n      throw new Error(diagramValidation.error);\n    }\n\n    // Get current page content (raw HTML) from API\n    const pageContent = await this.getCurrentPageContent();\n\n    // Prepare payload for new API\n    const payload = {\n      diagram_code: diagramContent,\n      prompt: userPrompt,\n      content: pageContent,\n    };\n\n    console.log(\"📤 Sending AI request:\", payload);\n\n    try {\n      // Call new AI API using constants\n      const response = await fetch(API_URLS.EDIT_MERMAID, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(payload),\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        throw new Error(\n          errorText || `HTTP ${response.status}: ${response.statusText}`\n        );\n      }\n\n      // API returns plain text mermaid code\n      const newMermaidCode = await response.text();\n\n      if (!newMermaidCode || !newMermaidCode.trim()) {\n        throw new Error(\"Empty response from AI API\");\n      }\n\n      console.log(\"✅ AI response received successfully\");\n\n      // Return in expected format for compatibility\n      return {\n        success: true,\n        edited_diagram: newMermaidCode.trim(),\n      };\n    } catch (error) {\n      console.error(\"❌ AI API error:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get current page content using Confluence API\n   * @returns {Promise<string>} Raw HTML content of the current page\n   */\n  async getCurrentPageContent() {\n    try {\n      // Extract page ID from current URL\n      const pageId = this.extractPageId();\n\n      if (!pageId) {\n        console.warn(\n          \"⚠️ Could not extract page ID, falling back to DOM content\"\n        );\n        return this.getFallbackContent();\n      }\n\n      console.log(\"🔍 Fetching page content from API for pageId:\", pageId);\n\n      // Use existing ConfluenceApi to fetch page content\n      const pageData = await ConfluenceApi.fetchPageContent(pageId);\n\n      if (pageData && pageData.content) {\n        console.log(\n          \"📄 Page content fetched from API:\",\n          pageData.content.substring(0, 100) + \"...\"\n        );\n        return pageData.content; // This is the HTML view content\n      }\n\n      // Fallback to storage format if view content not available\n      if (pageData && pageData.storageFormat) {\n        console.log(\n          \"📄 Using storage format as fallback:\",\n          pageData.storageFormat.substring(0, 100) + \"...\"\n        );\n        return pageData.storageFormat;\n      }\n\n      console.warn(\"⚠️ No content found from API, falling back to DOM\");\n      return this.getFallbackContent();\n    } catch (error) {\n      console.error(\"❌ Error fetching page content from API:\", error);\n      console.log(\"🔄 Falling back to DOM content extraction\");\n      return this.getFallbackContent();\n    }\n  }\n\n  /**\n   * Extract page ID from current URL\n   * @returns {string|null} Page ID or null if not found\n   */\n  extractPageId() {\n    try {\n      // Method 1: From URL params like /pages/viewpage.action?pageId=1933328\n      const urlParams = new URLSearchParams(window.location.search);\n      const pageId = urlParams.get(\"pageId\");\n      if (pageId) {\n        return pageId;\n      }\n\n      // Method 2: From URL path patterns\n      const pathMatches = [\n        window.location.pathname.match(/\\/pages\\/(\\d+)/),\n        window.location.pathname.match(/\\/display\\/[^\\/]+\\/(\\d+)/),\n        window.location.href.match(/pageId=(\\d+)/),\n        window.location.href.match(/\\/(\\d+)(?:[?#]|$)/),\n      ];\n\n      for (const match of pathMatches) {\n        if (match && match[1]) {\n          return match[1];\n        }\n      }\n\n      // Method 3: From meta tags\n      const metaSelectors = [\n        'meta[name=\"ajs-page-id\"]',\n        'meta[name=\"confluence-page-id\"]',\n        'meta[property=\"confluence:page-id\"]',\n      ];\n\n      for (const selector of metaSelectors) {\n        const metaTag = document.querySelector(selector);\n        if (metaTag && metaTag.content) {\n          return metaTag.content;\n        }\n      }\n\n      // Method 4: From AJS context if available\n      if (window.AJS && window.AJS.params && window.AJS.params.pageId) {\n        return window.AJS.params.pageId;\n      }\n\n      return null;\n    } catch (error) {\n      console.error(\"❌ Error extracting page ID:\", error);\n      return null;\n    }\n  }\n\n  /**\n   * Fallback method to get content from DOM\n   * @returns {string} HTML content from DOM\n   */\n  getFallbackContent() {\n    try {\n      const contentSelectors = [\n        \"#main-content .wiki-content\",\n        \".wiki-content\",\n        \"#content .page-content\",\n        \".page-content\",\n        \"#main-content\",\n        \".main-content\",\n      ];\n\n      for (const selector of contentSelectors) {\n        const element = document.querySelector(selector);\n        if (element) {\n          const content = element.innerHTML;\n          if (content && content.trim().length > 0) {\n            console.log(\n              `📄 Found fallback content from selector \"${selector}\"`\n            );\n            return content;\n          }\n        }\n      }\n\n      // Last resort: body content\n      return document.body.innerHTML;\n    } catch (error) {\n      console.error(\"❌ Error getting fallback content:\", error);\n      return \"\";\n    }\n  }\n\n  /**\n   * Call AI API\n   * @param {Object} payload - Request payload\n   * @returns {Promise<Object>} AI response\n   */\n  async callAI(payload) {\n    try {\n      const response = await fetch(\"/api/ai/mermaid-edit\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(payload),\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(\n          errorData.error || `HTTP ${response.status}: ${response.statusText}`\n        );\n      }\n\n      const data = await response.json();\n      console.log(\"📥 AI API response:\", data);\n\n      return data;\n    } catch (error) {\n      console.error(\"❌ AI API call failed:\", error);\n\n      // Return mock response for development/testing\n      if (error.message.includes(\"fetch\")) {\n        console.log(\"🔧 Using mock AI response for development\");\n        return this.getMockResponse(payload);\n      }\n\n      throw error;\n    }\n  }\n\n  /**\n   * Get mock AI response for development\n   * @param {Object} payload - Original request payload\n   * @returns {Object} Mock response\n   */\n  getMockResponse(payload) {\n    // Simple mock: add a comment to the diagram\n    const originalDiagram = payload.diagram_content;\n    const modifiedDiagram = `%% Modified by AI: ${payload.user_prompt}\\n${originalDiagram}`;\n\n    return {\n      success: true,\n      edited_diagram: modifiedDiagram,\n      explanation: `I've added a comment to your diagram based on your request: \"${payload.user_prompt}\"`,\n    };\n  }\n\n  /**\n   * Validate user prompt\n   * @param {string} prompt - User prompt to validate\n   * @returns {Object} Validation result\n   */\n  validateUserPrompt(prompt) {\n    if (!prompt || !prompt.trim()) {\n      return {\n        isValid: false,\n        error:\n          \"Please enter a prompt describing how you want to modify the diagram\",\n      };\n    }\n\n    if (prompt.trim().length < 3) {\n      return {\n        isValid: false,\n        error: \"Prompt is too short. Please provide more details.\",\n      };\n    }\n\n    if (prompt.length > 1000) {\n      return {\n        isValid: false,\n        error: \"Prompt is too long. Please keep it under 1000 characters.\",\n      };\n    }\n\n    return {\n      isValid: true,\n      error: null,\n    };\n  }\n\n  /**\n   * Validate diagram content\n   * @param {string} content - Diagram content to validate\n   * @returns {Object} Validation result\n   */\n  validateDiagramContent(content) {\n    if (!content || !content.trim()) {\n      return {\n        isValid: false,\n        error:\n          \"No diagram content found. Please select a Mermaid diagram first.\",\n      };\n    }\n\n    // Basic Mermaid syntax validation\n    const trimmed = content.trim();\n    const validStarters = [\n      \"graph\",\n      \"flowchart\",\n      \"sequenceDiagram\",\n      \"classDiagram\",\n      \"stateDiagram\",\n      \"erDiagram\",\n      \"journey\",\n      \"gantt\",\n      \"pie\",\n    ];\n\n    const hasValidStarter = validStarters.some((starter) =>\n      trimmed.toLowerCase().startsWith(starter.toLowerCase())\n    );\n\n    if (!hasValidStarter) {\n      return {\n        isValid: false,\n        error:\n          \"Invalid Mermaid diagram format. Please ensure it starts with a valid diagram type.\",\n      };\n    }\n\n    return {\n      isValid: true,\n      error: null,\n    };\n  }\n\n  /**\n   * Get user-friendly error message\n   * @param {Error} error - Error object\n   * @returns {string} User-friendly error message\n   */\n  getErrorMessage(error) {\n    if (error.message.includes(\"fetch\")) {\n      return \"Unable to connect to AI service. Please check your internet connection.\";\n    }\n\n    if (error.message.includes(\"HTTP 429\")) {\n      return \"Too many requests. Please wait a moment and try again.\";\n    }\n\n    if (error.message.includes(\"HTTP 500\")) {\n      return \"AI service is temporarily unavailable. Please try again later.\";\n    }\n\n    return error.message || \"An unexpected error occurred. Please try again.\";\n  }\n}\n","/**\n * Mermaid API Client\n * Handles API calls to fetch Mermaid diagram code from Confluence\n */\nimport { CONFLUENCE_API_URLS } from \"../../shared/constants.js\";\nexport class MermaidApiClient {\n  /**\n   * Extract page ID from current URL\n   * @returns {string|null} Page ID or null if not found\n   */\n  static extractPageId() {\n    try {\n      console.log(\"🔍 Extracting page ID from current page...\");\n      console.log(\"🔍 Current URL:\", window.location.href);\n      console.log(\"🔍 Current pathname:\", window.location.pathname);\n      console.log(\"🔍 Current search:\", window.location.search);\n\n      // Method 1: From URL params like /pages/viewpage.action?pageId=1933328\n      const urlParams = new URLSearchParams(window.location.search);\n      const pageId = urlParams.get(\"pageId\");\n      if (pageId) {\n        console.log(\"📄 Page ID extracted from URL params:\", pageId);\n        return pageId;\n      }\n\n      // Method 2: From URL path like /pages/(\\d+) or /display/SPACE/(\\d+)\n      const pathMatches = [\n        window.location.pathname.match(/\\/pages\\/(\\d+)/),\n        window.location.pathname.match(/\\/display\\/[^\\/]+\\/(\\d+)/),\n        window.location.href.match(/pageId=(\\d+)/),\n        window.location.href.match(/\\/(\\d+)(?:[?#]|$)/),\n      ];\n\n      for (const match of pathMatches) {\n        if (match && match[1]) {\n          console.log(\"📄 Page ID extracted from path/URL:\", match[1]);\n          return match[1];\n        }\n      }\n\n      // Method 3: From meta tags\n      const metaSelectors = [\n        'meta[name=\"ajs-page-id\"]',\n        'meta[name=\"confluence-page-id\"]',\n        'meta[property=\"confluence:page-id\"]',\n      ];\n\n      for (const selector of metaSelectors) {\n        const metaTag = document.querySelector(selector);\n        if (metaTag && metaTag.content) {\n          console.log(\n            `📄 Page ID extracted from meta tag (${selector}):`,\n            metaTag.content\n          );\n          return metaTag.content;\n        }\n      }\n\n      // Method 4: From AJS context if available\n      if (window.AJS && window.AJS.params && window.AJS.params.pageId) {\n        console.log(\"📄 Page ID extracted from AJS:\", window.AJS.params.pageId);\n        return window.AJS.params.pageId;\n      }\n\n      // Method 5: From Confluence context\n      if (window.Confluence && window.Confluence.getContentId) {\n        const contentId = window.Confluence.getContentId();\n        if (contentId) {\n          console.log(\n            \"📄 Page ID extracted from Confluence context:\",\n            contentId\n          );\n          return contentId;\n        }\n      }\n\n      // Method 6: From data attributes on body or html\n      const bodyPageId =\n        document.body.getAttribute(\"data-page-id\") ||\n        document.documentElement.getAttribute(\"data-page-id\");\n      if (bodyPageId) {\n        console.log(\n          \"📄 Page ID extracted from body data attribute:\",\n          bodyPageId\n        );\n        return bodyPageId;\n      }\n\n      console.warn(\"⚠️ Could not extract page ID from current page\");\n      console.warn(\n        \"⚠️ Available methods tried: URL params, path patterns, meta tags, AJS context, Confluence context, data attributes\"\n      );\n      return null;\n    } catch (error) {\n      console.error(\"❌ Error extracting page ID:\", error);\n      return null;\n    }\n  }\n\n  /**\n   * Extract filename from image src URL\n   * @param {string} src - Image src URL\n   * @returns {string|null} Filename without extension or null if not found\n   */\n  static extractFilename(src) {\n    try {\n      if (!src) return null;\n\n      console.log(\"🔍 Extracting filename from src:\", src);\n\n      // Parse URL to get pathname\n      const url = new URL(src, window.location.origin);\n      const pathname = url.pathname;\n\n      // Extract filename from path like /download/attachments/1933328/Diagram.png\n      const pathParts = pathname.split(\"/\");\n      const filenameWithExt = pathParts[pathParts.length - 1];\n\n      if (!filenameWithExt) return null;\n\n      // Remove extension (.png, .jpg, .svg, etc.)\n      const filename = filenameWithExt.split(\".\")[0];\n\n      console.log(\"✅ Extracted filename:\", filename);\n      return filename;\n    } catch (error) {\n      console.error(\"❌ Error extracting filename:\", error);\n      return null;\n    }\n  }\n\n  /**\n   * Save filename to localStorage for later use\n   * @param {string} filename - Filename to save\n   */\n  static saveFilename(filename) {\n    try {\n      if (!filename) return;\n\n      localStorage.setItem(\"mermaid-ai-filename\", filename);\n      console.log(\"💾 Filename saved to localStorage:\", filename);\n    } catch (error) {\n      console.error(\"❌ Error saving filename to localStorage:\", error);\n    }\n  }\n\n  /**\n   * Get saved filename from localStorage\n   * @returns {string|null} Saved filename or null if not found\n   */\n  static getSavedFilename() {\n    try {\n      const filename = localStorage.getItem(\"mermaid-ai-filename\");\n      console.log(\"📂 Retrieved filename from localStorage:\", filename);\n      return filename;\n    } catch (error) {\n      console.error(\"❌ Error retrieving filename from localStorage:\", error);\n      return null;\n    }\n  }\n\n  /**\n   * Fetch Mermaid diagram code from Confluence API\n   * @param {string} pageId - Confluence page ID (ceoId)\n   * @param {string} filename - Diagram filename\n   * @returns {Promise<string>} Mermaid diagram code\n   */\n  static async fetchMermaidCode(pageId, filename) {\n    try {\n      console.log(\"🌐 Fetching Mermaid code from API...\", { pageId, filename });\n\n      const apiUrl = `${CONFLUENCE_API_URLS.MERMAID_DIAGRAM}?ceoId=${pageId}&filename=${filename}`;\n\n      console.log(\"📡 API URL:\", apiUrl);\n\n      const response = await fetch(apiUrl, {\n        method: \"GET\",\n        headers: {\n          Accept: \"*/*\",\n          \"Accept-Language\": \"en-US,en;q=0.9,vi;q=0.8\",\n          \"Cache-Control\": \"no-cache\",\n          Connection: \"keep-alive\",\n          \"Content-Type\": \"application/json; charset=utf-8\",\n          Pragma: \"no-cache\",\n          Referer: CONFLUENCE_API_URLS.MERMAID_EDIT_REFERER,\n          \"Sec-Fetch-Dest\": \"empty\",\n          \"Sec-Fetch-Mode\": \"cors\",\n          \"Sec-Fetch-Site\": \"same-origin\",\n          \"User-Agent\": navigator.userAgent,\n          \"X-Requested-With\": \"XMLHttpRequest\",\n          \"sec-ch-ua\":\n            '\"Chromium\";v=\"140\", \"Not=A?Brand\";v=\"24\", \"Google Chrome\";v=\"140\"',\n          \"sec-ch-ua-mobile\": \"?0\",\n          \"sec-ch-ua-platform\": '\"Windows\"',\n        },\n        credentials: \"include\", // Include cookies for authentication\n      });\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const data = await response.json(); // Assuming API returns plain text Mermaid code\n\n      return data;\n    } catch (error) {\n      console.error(\"❌ Error fetching Mermaid code:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * Fetch Mermaid code using saved filename and current page ID\n   * @returns {Promise<string>} Mermaid diagram code\n   */\n  static async fetchMermaidCodeFromSaved() {\n    const pageId = this.extractPageId();\n    const filename = this.getSavedFilename();\n\n    if (!pageId) {\n      throw new Error(\"Could not extract page ID from current page\");\n    }\n\n    if (!filename) {\n      throw new Error(\n        \"No filename found in localStorage. Please click on a Mermaid diagram first.\"\n      );\n    }\n\n    return await this.fetchMermaidCode(pageId, filename);\n  }\n}\n","// Mermaid AI Chat Service for K-Tool Extension\nimport { MermaidExtractor } from \"./MermaidExtractor.js\";\nimport { MermaidPreview } from \"./MermaidPreview.js\";\nimport { MermaidAIService } from \"./MermaidAIService.js\";\nimport { MermaidApiClient } from \"./MermaidApiClient.js\";\nimport { CONFLUENCE_API_URLS } from \"../../shared/constants.js\";\nimport { MermaidRenderer } from \"../utils/mermaidRenderer.js\";\n\nexport class MermaidAIChat {\n  constructor($) {\n    this.$ = $ || window.jQuery || window.$; // jQuery instance từ AJS hoặc fallback\n    this.isPopupOpen = false;\n    this.currentMermaidContent = \"\";\n\n    // Initialize components\n    this.preview = new MermaidPreview();\n    this.aiService = new MermaidAIService();\n\n    // ✅ Replace MermaidDetector with internal properties\n    this.lastClickedElement = null;\n    this.lastClickPosition = { x: 0, y: 0 };\n\n    // ✅ Zoom functionality\n    this.currentZoom = 1.0; // 100%\n    this.minZoom = 0.25; // 25%\n    this.maxZoom = 3.0; // 300%\n    this.zoomStep = 0.25; // 25% per step\n    this.isZooming = false; // Flag to prevent flicker during zoom\n\n    console.log(\"🚀 Mermaid AI Chat initializing with AJS/jQuery:\", !!this.$);\n    this.init();\n  }\n\n  async init() {\n    console.log(\"🚀 AJS: Mermaid AI Chat initializing...\");\n\n    // Check if already injected\n    if (document.getElementById(\"mermaid-ai-chat-root\")) {\n      console.log(\"🔍 AJS: Mermaid AI Chat already injected, skipping...\");\n      return;\n    }\n\n    // Create popup UI first\n    this.createPopupUI();\n\n    // Initialize preview component\n    this.preview.initialize();\n\n    // ✅ Setup detection without MermaidDetector\n    this.setupMermaidDetection();\n    this.setupConfluencePageChangeDetection();\n\n    // Setup ConfluenceEditor monitoring to avoid conflicts\n    this.setupConfluenceEditorMonitoring();\n\n    console.log(\"✅ AJS: Mermaid AI Chat ready\");\n  }\n\n  /**\n   * Handle Mermaid diagram click\n   * @param {HTMLElement} element - Clicked element\n   * @param {Object} position - Click position {x, y}\n   */\n  handleMermaidClick(element, position) {\n    console.log(\"🎯 Mermaid diagram clicked:\", element, position);\n\n    // Extract content from clicked element\n    // this.currentMermaidContent = MermaidExtractor.extractFromElement(element);\n\n    // Show popup at click position\n    this.showChatPopup(position.x, position.y);\n  }\n\n  setupMermaidDetection() {\n    console.log(\"🔍 SIMPLE: Setting up iframe click detection...\");\n\n    // ✅ Sử dụng lại logic từ MermaidDetector thay vì duplicate code\n    // Chỉ setup iframe event listeners với logic đơn giản\n    this.setupIframeEventListeners();\n\n    // Setup MutationObserver để detect iframe mới (chỉ observe DOM cha)\n    this.setupMutationObserver();\n\n    console.log(\"✅ SIMPLE: Setup completed\");\n  }\n\n  setupIframeEventListeners() {\n    console.log(\"🔍 IFRAME: Setting up iframe event listeners...\");\n    this.refreshIframeListeners();\n  }\n\n  refreshIframeListeners() {\n    // Tìm tất cả iframes hiện tại\n    const iframes = document.querySelectorAll(\"iframe\");\n    console.log(\"🔍 IFRAME REFRESH: Found\", iframes.length, \"iframes\");\n\n    if (iframes.length === 0) {\n      console.log(\"⚠️ IFRAME REFRESH: No iframes found on page\");\n      console.log(\n        \"⚠️ IFRAME REFRESH: Document ready state:\",\n        document.readyState\n      );\n\n      // Try again after a delay\n      setTimeout(() => {\n        console.log(\"🔍 IFRAME REFRESH: Retrying iframe search after delay...\");\n        const retryIframes = document.querySelectorAll(\"iframe\");\n        console.log(\n          \"🔍 IFRAME REFRESH: Retry found\",\n          retryIframes.length,\n          \"iframes\"\n        );\n        if (retryIframes.length > 0) {\n          retryIframes.forEach((iframe, index) => {\n            console.log(\n              `🔍 IFRAME REFRESH RETRY ${index}: Processing iframe:`,\n              iframe.src || iframe.id || \"no-src\"\n            );\n            this.attachIframeListeners(iframe, `refresh-retry-${index}`);\n          });\n        }\n      }, 1000);\n    } else {\n      iframes.forEach((iframe, index) => {\n        console.log(\n          `🔍 IFRAME REFRESH ${index}: Processing iframe:`,\n          iframe.src || iframe.id || \"no-src\"\n        );\n        this.attachIframeListeners(iframe, `refresh-${index}`);\n      });\n    }\n  }\n\n  attachIframeListeners(iframe, index) {\n    try {\n      // Kiểm tra nếu iframe đã có listener để tránh duplicate\n      if (iframe.dataset.mermaidListenerAttached === \"true\") {\n        console.log(\n          `⚠️ IFRAME ${index}: Listener already attached, skipping...`\n        );\n        return;\n      }\n\n      // Đánh dấu iframe đã có listener\n      iframe.dataset.mermaidListenerAttached = \"true\";\n\n      // Đợi iframe load xong\n      const loadHandler = () => {\n        console.log(\n          `🔍 IFRAME ${index}: Iframe loaded, attaching listeners...`\n        );\n        try {\n          const iframeDoc =\n            iframe.contentDocument || iframe.contentWindow.document;\n\n          if (!iframeDoc) {\n            console.log(\n              `⚠️ IFRAME ${index}: Cannot access iframe document (cross-origin?)`\n            );\n            return;\n          }\n\n          console.log(\n            `✅ IFRAME ${index}: Iframe document accessible, adding click listeners...`\n          );\n\n          // Click handler: Lưu element và tọa độ nếu là ảnh\n          const clickHandler = (event) => {\n            console.log(`🖱️ IFRAME ${index} CLICK: Element clicked:`, {\n              tag: event.target.tagName,\n              classes: event.target.className,\n              id: event.target.id,\n              src: event.target.src || \"N/A\",\n              alt: event.target.alt || \"N/A\",\n              element: event.target,\n            });\n\n            console.log(\n              `🔍 IFRAME ${index} CLICK: Checking if Mermaid element...`\n            );\n            console.log(\n              `🔍 IFRAME ${index} CLICK: isMermaidElement result:`,\n              this.isMermaidElement(event.target)\n            );\n\n            // ✅ Handle click directly without MermaidDetector\n            if (this.isMermaidElement(event.target)) {\n              console.log(\"🎯 Mermaid element clicked:\", event.target);\n\n              // Extract and save comprehensive diagram info\n              if (event.target.src) {\n                const filename = MermaidApiClient.extractFilename(\n                  event.target.src\n                );\n\n                // Extract macro parameters from data attribute\n                const macroParams = event.target.getAttribute(\n                  \"data-macro-parameters\"\n                );\n\n                // Save comprehensive diagram info\n                const diagramInfo = {\n                  filename: filename,\n                  src: event.target.src,\n                  macroParameters: macroParams,\n                  element: {\n                    tagName: event.target.tagName,\n                    className: event.target.className,\n                    id: event.target.id,\n                  },\n                };\n\n                // Parse macro parameters if available\n                if (macroParams) {\n                  try {\n                    const params = this.parseMacroParameters(macroParams);\n                    diagramInfo.parsedParams = params;\n                    console.log(`📋 Parsed macro parameters:`, params);\n                  } catch (error) {\n                    console.warn(\n                      \"⚠️ Could not parse macro parameters:\",\n                      macroParams\n                    );\n                  }\n                }\n\n                if (filename) {\n                  MermaidApiClient.saveFilename(filename);\n                  // Save full diagram info\n                  localStorage.setItem(\n                    \"mermaid_diagram_info\",\n                    JSON.stringify(diagramInfo)\n                  );\n                  console.log(`💾 Diagram info saved:`, diagramInfo);\n                } else {\n                  console.warn(\n                    \"⚠️ Could not extract filename from src:\",\n                    event.target.src\n                  );\n                }\n              }\n\n              // Save click info\n              this.lastClickedElement = event.target;\n              this.lastClickPosition = {\n                x: event.clientX + iframe.offsetLeft,\n                y: event.clientY + iframe.offsetTop,\n              };\n\n              // Trigger callback\n              this.handleMermaidClick(event.target, this.lastClickPosition);\n            }\n          };\n\n          // Remove existing listener nếu có\n          if (iframeDoc.mermaidClickHandler) {\n            iframeDoc.removeEventListener(\n              \"click\",\n              iframeDoc.mermaidClickHandler,\n              true\n            );\n          }\n\n          // Add new listener\n          const boundClickHandler = clickHandler.bind(this);\n          iframeDoc.addEventListener(\"click\", boundClickHandler, true);\n\n          // Store reference để có thể remove sau này\n          iframeDoc.mermaidClickHandler = boundClickHandler;\n        } catch (e) {\n          console.log(\n            `❌ IFRAME ${index}: Error accessing iframe content:`,\n            e.message\n          );\n        }\n      };\n\n      // Remove existing load listener nếu có\n      if (iframe.mermaidLoadHandler) {\n        iframe.removeEventListener(\"load\", iframe.mermaidLoadHandler);\n      }\n\n      // Add load listener\n      iframe.addEventListener(\"load\", loadHandler);\n      iframe.mermaidLoadHandler = loadHandler;\n\n      // Nếu iframe đã load rồi thì gọi handler ngay\n      if (\n        iframe.contentDocument &&\n        iframe.contentDocument.readyState === \"complete\"\n      ) {\n        loadHandler();\n      }\n    } catch (e) {\n      console.log(\n        `❌ IFRAME ${index}: Error setting up iframe listener:`,\n        e.message\n      );\n    }\n  }\n\n  setupMutationObserver() {\n    console.log(\n      \"🔍 MUTATION: Setting up observer to track ALL DOM changes in parent...\"\n    );\n\n    const observer = new MutationObserver((mutations) => {\n      mutations.forEach((mutation, mutationIndex) => {\n        console.log(`🔍 MUTATION ${mutationIndex}: Type: ${mutation.type}`);\n        if (mutation.type === \"childList\") {\n          // Log ADDED nodes\n          if (mutation.addedNodes.length > 0) {\n            console.log(\n              `➕ MUTATION ${mutationIndex}: ${mutation.addedNodes.length} nodes ADDED:`\n            );\n            mutation.addedNodes.forEach((node, nodeIndex) => {\n              if (node.nodeType === Node.ELEMENT_NODE) {\n                console.log(`➕ Added ${nodeIndex}: ${node.tagName}`, {\n                  tag: node.tagName,\n                  classes: node.className || \"N/A\",\n                  id: node.id || \"N/A\",\n                  textContent: node.textContent?.substring(0, 50) || \"N/A\",\n                  element: node,\n                });\n\n                // Nếu là iframe thì attach listeners\n                if (node.tagName === \"IFRAME\") {\n                  console.log(\n                    \"🎯 MUTATION: IFRAME detected, attaching listeners...\"\n                  );\n                  this.attachIframeListeners(node, \"new\");\n                }\n\n                this.injectAIButton();\n              } else if (node.nodeType === Node.TEXT_NODE) {\n                console.log(`➕ Added ${nodeIndex}: TEXT_NODE`, {\n                  content: node.textContent?.substring(0, 50) || \"N/A\",\n                });\n              }\n            });\n          }\n        }\n      });\n    });\n\n    // Observe DOM cha với tất cả types\n    observer.observe(document.body, {\n      childList: true,\n      subtree: false,\n    });\n  }\n\n  setupConfluencePageChangeDetection() {\n    console.log(\n      \"🔍 PAGE CHANGE: Setting up Confluence page change detection...\"\n    );\n\n    // Method 1: Listen for Confluence-specific events\n    if (window.AJS && AJS.bind) {\n      // Editor events\n      AJS.bind(\"init.rte\", () => {\n        console.log(\n          \"🔄 PAGE CHANGE: Confluence RTE initialized - re-setting up iframe listeners\"\n        );\n        setTimeout(() => this.setupIframeEventListeners(), 1000);\n      });\n\n      AJS.bind(\"rte-ready\", () => {\n        console.log(\n          \"🔄 PAGE CHANGE: Confluence RTE ready - re-setting up iframe listeners\"\n        );\n        setTimeout(() => this.setupIframeEventListeners(), 1000);\n      });\n\n      // Page events\n      AJS.bind(\"page.edit.ready\", () => {\n        console.log(\n          \"🔄 PAGE CHANGE: Page edit ready - re-setting up iframe listeners\"\n        );\n        setTimeout(() => this.setupIframeEventListeners(), 1500);\n      });\n\n      AJS.bind(\"page.view.ready\", () => {\n        console.log(\n          \"🔄 PAGE CHANGE: Page view ready - re-setting up iframe listeners\"\n        );\n        setTimeout(() => this.setupIframeEventListeners(), 1000);\n      });\n    }\n\n    // Method 2: Watch for URL changes (SPA navigation)\n    let currentUrl = window.location.href;\n    const checkUrlChange = () => {\n      if (window.location.href !== currentUrl) {\n        console.log(\n          \"🔄 PAGE CHANGE: URL changed from\",\n          currentUrl,\n          \"to\",\n          window.location.href\n        );\n        currentUrl = window.location.href;\n\n        // Re-setup after URL change\n        setTimeout(() => {\n          console.log(\n            \"🔄 PAGE CHANGE: Re-setting up iframe listeners after URL change\"\n          );\n          this.setupIframeEventListeners();\n        }, 2000);\n      }\n    };\n\n    setInterval(checkUrlChange, 1000);\n\n    console.log(\n      \"✅ PAGE CHANGE: Confluence page change detection setup completed\"\n    );\n  }\n\n  injectAIButton() {\n    // ✅ Skip if ConfluenceEditor popup is open to avoid conflict\n    if (document.querySelector(\".confluence-editor-overlay\")) {\n      console.log(\n        \"🚫 ConfluenceEditor popup is open, skipping AI button injection\"\n      );\n      return;\n    }\n\n    var panel = document.getElementById(\"property-panel\");\n    if (!panel) return;\n\n    var buttonContainer = panel.querySelector(\".panel-buttons\");\n    if (!buttonContainer) return;\n\n    // Kiểm tra nếu nút AI đã có\n    if (\n      buttonContainer.querySelector(\n        \".macro-placeholder-property-panel-ai-button\"\n      )\n    )\n      return;\n\n    console.log(\"✨ Thêm nút AI vào property panel...\");\n\n    // Tạo thẻ <a> mới\n    var aiButton = document.createElement(\"a\");\n    aiButton.href = \"#\";\n    aiButton.className =\n      \"aui-button macro-placeholder-property-panel-ai-button\";\n    aiButton.setAttribute(\"tabindex\", \"0\");\n    aiButton.setAttribute(\"role\", \"button\");\n    aiButton.setAttribute(\"aria-label\", \"AI\");\n    aiButton.style.marginRight = \"4px\";\n\n    // Icon + Text\n    aiButton.innerHTML = `<span class=\"icon\"></span><span class=\"panel-button-text\">AI</span>`;\n\n    // Thêm sự kiện click\n    aiButton.addEventListener(\"click\", async (e) => {\n      e.preventDefault();\n\n      // ✅ Skip if ConfluenceEditor popup is open to avoid conflict\n      if (document.querySelector(\".confluence-editor-overlay\")) {\n        console.log(\n          \"🚫 ConfluenceEditor popup is open, ignoring AI button click\"\n        );\n        return;\n      }\n\n      console.log(\"🤖 AI Button clicked - fetching Mermaid code...\");\n\n      // Get last clicked element and position\n      const lastClickedElement = this.lastClickedElement;\n      const lastClickPosition = this.lastClickPosition;\n\n      console.log(\n        \"🔍 DEBUG AI BUTTON: this.lastClickedElement:\",\n        this.lastClickedElement\n      );\n      console.log(\n        \"🔍 DEBUG AI BUTTON: this.lastClickPosition:\",\n        this.lastClickPosition\n      );\n      console.log(\n        \"🔍 DEBUG AI BUTTON: lastClickedElement:\",\n        lastClickedElement\n      );\n      console.log(\"🔍 DEBUG AI BUTTON: lastClickPosition:\", lastClickPosition);\n      console.log(\n        \"🔍 DEBUG AI BUTTON: Position check:\",\n        lastClickPosition &&\n          (lastClickPosition.x !== 0 || lastClickPosition.y !== 0)\n      );\n\n      if (\n        lastClickedElement &&\n        lastClickPosition &&\n        (lastClickPosition.x !== 0 || lastClickPosition.y !== 0)\n      ) {\n        console.log(\n          \"🤖 Found saved element - fetching Mermaid code from API...\"\n        );\n\n        try {\n          // Show loading state\n          const loadingMessage = \"🔄 Fetching Mermaid diagram code...\";\n          console.log(loadingMessage);\n\n          // Fetch Mermaid code from API using saved filename and page ID\n          const mermaidCodeResponse =\n            await MermaidApiClient.fetchMermaidCodeFromSaved();\n          const mermaidCode = mermaidCodeResponse.data;\n          console.log(\"✅ Mermaid code fetched successfully:\", mermaidCode);\n\n          // Update current content with fetched code\n          this.currentMermaidContent = mermaidCode;\n\n          // Show chat popup with fetched content\n          this.showChatPopup(lastClickPosition.x, lastClickPosition.y);\n        } catch (error) {\n          console.error(\"❌ Error fetching Mermaid code:\", error);\n          alert(`❌ Error fetching Mermaid code: ${error.message}`);\n        }\n      } else {\n        console.log(\n          \"⚠️ No saved element found - please click on an image first\"\n        );\n        alert(\"⚠️ Vui lòng click vào một hình ảnh trước khi sử dụng AI Chat!\");\n      }\n    });\n\n    // Chèn vào trước nút Remove\n    var removeButton = buttonContainer.querySelector(\n      \".macro-placeholder-property-panel-remove-button\"\n    );\n    if (removeButton) {\n      buttonContainer.insertBefore(aiButton, removeButton);\n    } else {\n      buttonContainer.appendChild(aiButton);\n    }\n\n    console.log(\"✅ Đã chèn nút AI thành công.\");\n  }\n\n  /**\n   * Remove AI button when ConfluenceEditor is open\n   */\n  removeAIButton() {\n    const aiButton = document.querySelector(\n      \".macro-placeholder-property-panel-ai-button\"\n    );\n    if (aiButton) {\n      aiButton.remove();\n      console.log(\"🗑️ AI button removed due to ConfluenceEditor popup\");\n    }\n  }\n\n  /**\n   * Monitor ConfluenceEditor popup state and manage AI button accordingly\n   */\n  setupConfluenceEditorMonitoring() {\n    // Monitor for ConfluenceEditor popup open/close\n    const observer = new MutationObserver((mutations) => {\n      mutations.forEach((mutation) => {\n        if (mutation.type === \"childList\") {\n          mutation.addedNodes.forEach((node) => {\n            if (\n              node.nodeType === Node.ELEMENT_NODE &&\n              node.classList &&\n              node.classList.contains(\"confluence-editor-overlay\")\n            ) {\n              console.log(\n                \"🔍 ConfluenceEditor popup opened, removing AI button\"\n              );\n              this.removeAIButton();\n            }\n          });\n\n          mutation.removedNodes.forEach((node) => {\n            if (\n              node.nodeType === Node.ELEMENT_NODE &&\n              node.classList &&\n              node.classList.contains(\"confluence-editor-overlay\")\n            ) {\n              console.log(\n                \"🔍 ConfluenceEditor popup closed, re-injecting AI button\"\n              );\n              // Delay to ensure DOM is ready\n              setTimeout(() => {\n                this.injectAIButton();\n              }, 100);\n            }\n          });\n        }\n      });\n    });\n\n    observer.observe(document.body, {\n      childList: true,\n      subtree: false, // Only observe direct children of body\n    });\n\n    console.log(\"✅ ConfluenceEditor monitoring setup completed\");\n  }\n\n  /**\n   * Parse macro parameters string\n   * @param {string} macroParams - Macro parameters string like \"filename=e3e32|format=svg|revision=5\"\n   * @returns {Object} Parsed parameters object\n   */\n  parseMacroParameters(macroParams) {\n    const params = {};\n    if (!macroParams) return params;\n\n    const pairs = macroParams.split(\"|\");\n    pairs.forEach((pair) => {\n      const [key, value] = pair.split(\"=\");\n      if (key && value) {\n        params[key.trim()] = value.trim();\n      }\n    });\n\n    return params;\n  }\n\n  /**\n   * Check if element is a Mermaid diagram\n   * @param {HTMLElement} element - Element to check\n   * @returns {boolean} True if element is Mermaid-related\n   */\n  isMermaidElement(element) {\n    if (\n      !element ||\n      !element.nodeType ||\n      element.nodeType !== Node.ELEMENT_NODE\n    ) {\n      return false;\n    }\n\n    console.log(\"🔍 isMermaidElement: Checking element:\", {\n      tag: element.tagName,\n      src: element.src || \"N/A\",\n      className: element.className || \"N/A\",\n      id: element.id || \"N/A\",\n    });\n\n    // Check for various Mermaid indicators\n    const checks = [\n      // Image with mermaid in src\n      element.tagName === \"IMG\" &&\n        element.src &&\n        element.src.includes(\"mermaid\"),\n      // SVG with mermaid in id\n      element.tagName === \"SVG\" && element.id && element.id.includes(\"mermaid\"),\n      // Element with mermaid class\n      element.classList && element.classList.contains(\"mermaid\"),\n      // Element with mermaid data attribute\n      element.getAttribute &&\n        element.getAttribute(\"data-macro-name\") === \"mermaid\",\n      // Confluence structured macro\n      element.tagName === \"AC:STRUCTURED-MACRO\" &&\n        element.getAttribute(\"ac:name\") === \"mermaid\",\n      // Any image (for broader detection)\n      element.tagName === \"IMG\" && element.src,\n      // Any SVG\n      element.tagName === \"SVG\",\n    ];\n\n    const result = checks.some((check) => check);\n    console.log(\"🔍 isMermaidElement: Result:\", result);\n\n    return result;\n  }\n\n  /**\n   * Bind zoom control events\n   */\n  bindZoomControls() {\n    const zoomInBtn = document.getElementById(\"zoom-in-btn\");\n    const zoomOutBtn = document.getElementById(\"zoom-out-btn\");\n    const zoomResetBtn = document.getElementById(\"zoom-reset-btn\");\n    const previewContainer = document.getElementById(\n      \"mermaid-preview-container\"\n    );\n\n    if (!zoomInBtn || !zoomOutBtn || !zoomResetBtn || !previewContainer) {\n      console.warn(\"⚠️ Zoom controls not found\");\n      return;\n    }\n\n    // Zoom In\n    zoomInBtn.addEventListener(\"click\", () => {\n      this.zoomIn();\n    });\n\n    // Zoom Out\n    zoomOutBtn.addEventListener(\"click\", () => {\n      this.zoomOut();\n    });\n\n    // Reset Zoom\n    zoomResetBtn.addEventListener(\"click\", () => {\n      this.resetZoom();\n    });\n\n    // Keyboard shortcuts\n    document.addEventListener(\"keydown\", (e) => {\n      // Only work when popup is open and not typing in input fields\n      if (\n        !this.isPopupOpen ||\n        e.target.tagName === \"INPUT\" ||\n        e.target.tagName === \"TEXTAREA\"\n      ) {\n        return;\n      }\n\n      if (e.key === \"+\" || e.key === \"=\") {\n        e.preventDefault();\n        this.zoomIn();\n      } else if (e.key === \"-\") {\n        e.preventDefault();\n        this.zoomOut();\n      } else if (e.key === \"0\") {\n        e.preventDefault();\n        this.resetZoom();\n      }\n    });\n\n    // Mouse wheel zoom (Ctrl + wheel)\n    previewContainer.addEventListener(\"wheel\", (e) => {\n      if (e.ctrlKey) {\n        e.preventDefault();\n        if (e.deltaY < 0) {\n          this.zoomIn();\n        } else {\n          this.zoomOut();\n        }\n      }\n    });\n\n    console.log(\"✅ Zoom controls bound successfully\");\n  }\n\n  /**\n   * Zoom in\n   */\n  zoomIn() {\n    if (this.currentZoom < this.maxZoom) {\n      this.currentZoom = Math.min(\n        this.currentZoom + this.zoomStep,\n        this.maxZoom\n      );\n      this.applyZoom();\n    }\n  }\n\n  /**\n   * Zoom out\n   */\n  zoomOut() {\n    if (this.currentZoom > this.minZoom) {\n      this.currentZoom = Math.max(\n        this.currentZoom - this.zoomStep,\n        this.minZoom\n      );\n      this.applyZoom();\n    }\n  }\n\n  /**\n   * Reset zoom to 100%\n   */\n  resetZoom() {\n    this.currentZoom = 1.0;\n    this.applyZoom();\n  }\n\n  /**\n   * Apply zoom to preview container\n   */\n  applyZoom() {\n    const previewContainer = document.getElementById(\n      \"mermaid-preview-container\"\n    );\n    const zoomDisplay = document.getElementById(\"zoom-level-display\");\n\n    if (!previewContainer) return;\n\n    // Set zoom flag to prevent flicker\n    this.isZooming = true;\n\n    // Apply transform\n    previewContainer.style.transform = `scale(${this.currentZoom})`;\n    previewContainer.style.transformOrigin = \"center center\";\n\n    // Update zoom display\n    if (zoomDisplay) {\n      zoomDisplay.textContent = `${Math.round(this.currentZoom * 100)}%`;\n    }\n\n    // Update button states\n    this.updateZoomButtonStates();\n\n    console.log(`🔍 Zoom applied: ${Math.round(this.currentZoom * 100)}%`);\n\n    // Reset zoom flag after a short delay\n    setTimeout(() => {\n      this.isZooming = false;\n    }, 100);\n  }\n\n  /**\n   * Update zoom button states (enable/disable)\n   */\n  updateZoomButtonStates() {\n    const zoomInBtn = document.getElementById(\"zoom-in-btn\");\n    const zoomOutBtn = document.getElementById(\"zoom-out-btn\");\n\n    if (zoomInBtn) {\n      zoomInBtn.disabled = this.currentZoom >= this.maxZoom;\n      zoomInBtn.style.opacity = this.currentZoom >= this.maxZoom ? \"0.5\" : \"1\";\n    }\n\n    if (zoomOutBtn) {\n      zoomOutBtn.disabled = this.currentZoom <= this.minZoom;\n      zoomOutBtn.style.opacity = this.currentZoom <= this.minZoom ? \"0.5\" : \"1\";\n    }\n  }\n\n  createPopupUI() {\n    const root = document.createElement(\"div\");\n    root.id = \"mermaid-ai-chat-root\";\n    root.innerHTML = `\n      <style>\n        .mermaid-preview-header {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          padding: 8px 12px;\n          background: #f5f5f5;\n          border-bottom: 1px solid #ddd;\n          font-weight: bold;\n        }\n\n        .zoom-controls {\n          display: flex;\n          align-items: center;\n          gap: 8px;\n        }\n\n        .zoom-btn {\n          background: #fff;\n          border: 1px solid #ccc;\n          border-radius: 4px;\n          padding: 4px 8px;\n          cursor: pointer;\n          font-size: 12px;\n          transition: all 0.2s;\n        }\n\n        .zoom-btn:hover:not(:disabled) {\n          background: #e6f3ff;\n          border-color: #0066cc;\n        }\n\n        .zoom-btn:disabled {\n          cursor: not-allowed;\n          opacity: 0.5;\n        }\n\n        .zoom-level {\n          font-size: 12px;\n          font-weight: bold;\n          color: #666;\n          min-width: 40px;\n          text-align: center;\n        }\n\n        .zoom-icon {\n          font-size: 10px;\n        }\n\n        #mermaid-preview-container {\n          transition: transform 0.2s ease;\n          overflow: auto;\n        }\n\n        .mermaid-chat-buttons {\n          display: flex;\n          gap: 8px;\n          align-items: center;\n        }\n\n        .mermaid-chat-save {\n          background: #28a745;\n          color: white;\n          border: none;\n          border-radius: 4px;\n          padding: 8px 16px;\n          cursor: pointer;\n          font-size: 14px;\n          transition: background-color 0.2s;\n        }\n\n        .mermaid-chat-save:hover:not(:disabled) {\n          background: #218838;\n        }\n\n        .mermaid-chat-save:disabled {\n          background: #6c757d;\n          cursor: not-allowed;\n        }\n      </style>\n      <div id=\"mermaid-ai-chat-popup\" class=\"mermaid-ai-chat-popup\" style=\"display: none;\">\n        <div class=\"mermaid-ai-chat-header\">\n          <h3>🤖 Mermaid AI Chat Editor</h3>\n          <button class=\"mermaid-ai-chat-close\">&times;</button>\n        </div>\n        <div class=\"mermaid-ai-chat-body\">\n          <!-- Left Pane: Code Editor + Chat Input -->\n          <div class=\"mermaid-ai-chat-left-pane\">\n            <!-- Code Editor Section -->\n            <div class=\"mermaid-code-section\">\n              <div class=\"mermaid-code-header\">\n                📝 Mermaid Code\n              </div>\n              <textarea\n                id=\"mermaid-code-editor\"\n                class=\"mermaid-code-editor\"\n                placeholder=\"Mermaid diagram code will appear here...\"\n              ></textarea>\n            </div>\n\n            <!-- Chat Input Section -->\n            <div class=\"mermaid-chat-section\">\n              <div class=\"mermaid-chat-input-area\">\n                <textarea\n                  id=\"mermaid-ai-chat-input\"\n                  class=\"mermaid-chat-input\"\n                  placeholder=\"💬 Describe how you want to modify the diagram...\"\n                  rows=\"2\"\n                ></textarea>\n                <div class=\"mermaid-chat-buttons\">\n                  <button id=\"mermaid-ai-chat-save\" class=\"mermaid-chat-save\">\n                    💾 Save\n                  </button>\n                  <button id=\"mermaid-ai-chat-send\" class=\"mermaid-chat-send\">\n                    Send\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <!-- Right Pane: Mermaid Preview -->\n          <div class=\"mermaid-ai-chat-right-pane\">\n            <div class=\"mermaid-preview-section\">\n              <div class=\"mermaid-preview-header\">\n                <span class=\"preview-title\">📊 Diagram Preview</span>\n                <div class=\"zoom-controls\">\n                  <button id=\"zoom-out-btn\" class=\"zoom-btn\" title=\"Zoom Out (-)\">\n                    <span class=\"zoom-icon\">➖</span>\n                  </button>\n                  <span id=\"zoom-level-display\" class=\"zoom-level\">100%</span>\n                  <button id=\"zoom-in-btn\" class=\"zoom-btn\" title=\"Zoom In (+)\">\n                    <span class=\"zoom-icon\">➕</span>\n                  </button>\n                  <button id=\"zoom-reset-btn\" class=\"zoom-btn\" title=\"Reset Zoom (0)\">\n                    <span class=\"zoom-icon\">🔄</span>\n                  </button>\n                </div>\n              </div>\n              <div class=\"mermaid-preview-body\">\n                <div id=\"mermaid-preview-container\" class=\"mermaid-preview-container\">\n                  <div class=\"mermaid-preview-placeholder\">\n                    Click on a Mermaid diagram to start editing\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n\n    document.body.appendChild(root);\n    this.bindPopupEvents();\n  }\n\n  bindPopupEvents() {\n    const popup = document.getElementById(\"mermaid-ai-chat-popup\");\n    const header = popup.querySelector(\".mermaid-ai-chat-header\");\n    const closeBtn = popup.querySelector(\".mermaid-ai-chat-close\");\n    const sendBtn = document.getElementById(\"mermaid-ai-chat-send\");\n    const saveBtn = document.getElementById(\"mermaid-ai-chat-save\");\n    const input = document.getElementById(\"mermaid-ai-chat-input\");\n    const codeEditor = document.getElementById(\"mermaid-code-editor\");\n\n    // Make popup draggable\n    this.makeDraggable(popup, header);\n\n    // Close popup\n    closeBtn.addEventListener(\"click\", () => {\n      this.hideChatPopup();\n    });\n\n    // Send message\n    sendBtn.addEventListener(\"click\", () => {\n      this.sendMessage();\n    });\n\n    // Save diagram\n    saveBtn.addEventListener(\"click\", () => {\n      this.saveDiagram();\n    });\n\n    // Send on Enter (Ctrl+Enter for new line)\n    input.addEventListener(\"keydown\", (e) => {\n      if (e.key === \"Enter\" && !e.ctrlKey && !e.shiftKey) {\n        e.preventDefault();\n        this.sendMessage();\n      }\n    });\n\n    // Code editor change event - update preview\n    codeEditor.addEventListener(\"input\", () => {\n      this.updateMermaidPreview();\n    });\n\n    // ✅ Zoom controls\n    this.bindZoomControls();\n\n    // Click outside to close - with proper event handling\n    setTimeout(() => {\n      const handleClickOutside = (e) => {\n        // Skip if popup is not open\n        if (!this.isPopupOpen) return;\n\n        // Skip if clicking on AI button (to prevent immediate close)\n        if (e.target.closest(\".macro-placeholder-property-panel-ai-button\")) {\n          return;\n        }\n\n        // ✅ Skip if clicking on AI button in ConfluenceEditor popup\n        if (\n          e.target.closest(\"#ai-send-btn\") &&\n          document.querySelector(\".confluence-editor-overlay\")\n        ) {\n          return;\n        }\n\n        // Skip if clicking inside popup\n        if (popup.contains(e.target)) {\n          return;\n        }\n\n        console.log(\"🖱️ Click outside popup detected, closing...\");\n        this.hideChatPopup();\n      };\n\n      document.addEventListener(\"click\", handleClickOutside, true);\n    }, 300); // Delay to prevent immediate close after opening\n  }\n\n  makeDraggable(popup, dragHandle) {\n    let isDragging = false;\n    let dragStartX = 0;\n    let dragStartY = 0;\n    let popupStartX = 0;\n    let popupStartY = 0;\n\n    console.log(\"🎯 DRAG: Setting up draggable popup...\");\n\n    // Style the drag handle\n    dragHandle.style.cursor = \"move\";\n    dragHandle.style.userSelect = \"none\";\n\n    const startDrag = (e) => {\n      // Don't drag if clicking on close button\n      if (e.target.classList.contains(\"mermaid-ai-chat-close\")) {\n        return;\n      }\n\n      e.preventDefault();\n      e.stopPropagation(); // Prevent event bubbling\n\n      isDragging = true;\n\n      // Get mouse position\n      dragStartX = e.clientX;\n      dragStartY = e.clientY;\n\n      // Get popup current position (from style, not getBoundingClientRect)\n      popupStartX = parseInt(popup.style.left) || 0;\n      popupStartY = parseInt(popup.style.top) || 0;\n\n      console.log(\"🎯 DRAG: Started\", {\n        mouseX: dragStartX,\n        mouseY: dragStartY,\n        popupX: popupStartX,\n        popupY: popupStartY,\n      });\n\n      // Add global event listeners\n      document.addEventListener(\"mousemove\", onDrag, true);\n      document.addEventListener(\"mouseup\", stopDrag, true);\n\n      // Prevent text selection during drag\n      document.body.style.userSelect = \"none\";\n    };\n\n    const onDrag = (e) => {\n      if (!isDragging) return;\n\n      e.preventDefault();\n      e.stopPropagation();\n\n      // Calculate mouse movement\n      const deltaX = e.clientX - dragStartX;\n      const deltaY = e.clientY - dragStartY;\n\n      // Calculate new popup position\n      let newX = popupStartX + deltaX;\n      let newY = popupStartY + deltaY;\n\n      // Constrain to viewport (with some padding)\n      const padding = 10;\n      const maxX = window.innerWidth - 400 - padding; // 400 is popup width\n      const maxY = window.innerHeight - 300 - padding; // estimated popup height\n\n      newX = Math.max(padding, Math.min(newX, maxX));\n      newY = Math.max(padding, Math.min(newY, maxY));\n\n      // Apply position\n      popup.style.left = newX + \"px\";\n      popup.style.top = newY + \"px\";\n    };\n\n    const stopDrag = (e) => {\n      if (!isDragging) return;\n\n      console.log(\"🎯 DRAG: Stopped\");\n      isDragging = false;\n\n      // Remove global event listeners\n      document.removeEventListener(\"mousemove\", onDrag, true);\n      document.removeEventListener(\"mouseup\", stopDrag, true);\n\n      // Restore text selection\n      document.body.style.userSelect = \"\";\n\n      e.stopPropagation(); // Prevent click outside from firing\n    };\n\n    // Attach drag to header\n    dragHandle.addEventListener(\"mousedown\", startDrag);\n\n    console.log(\"✅ DRAG: Setup completed\");\n  }\n\n  showChatPopup(x, y) {\n    console.log(\"🎉 STEP 8: showChatPopup called with coordinates:\", { x, y });\n    const popup = document.getElementById(\"mermaid-ai-chat-popup\");\n    console.log(\"🎉 STEP 8.1: Found popup element:\", popup);\n\n    if (!popup) {\n      console.error(\"❌ STEP 8.1: Popup element not found!\");\n      return;\n    }\n\n    // Populate code editor with current content\n    const codeEditor = document.getElementById(\"mermaid-code-editor\");\n    if (codeEditor && this.currentMermaidContent) {\n      codeEditor.value = this.currentMermaidContent;\n      // Trigger preview update\n      this.updateMermaidPreview();\n    }\n\n    const leftPos = Math.min(x, window.innerWidth - 400);\n    const topPos = Math.min(y, window.innerHeight - 300);\n\n    console.log(\"🎉 STEP 8.2: Setting popup position:\", { leftPos, topPos });\n    console.log(\"🎉 STEP 8.2: Window dimensions:\", {\n      width: window.innerWidth,\n      height: window.innerHeight,\n    });\n\n    popup.style.display = \"block\";\n    popup.style.left = leftPos + \"px\";\n    popup.style.top = topPos + \"px\";\n\n    console.log(\"🎉 STEP 8.3: Popup styles applied:\", {\n      display: popup.style.display,\n      left: popup.style.left,\n      top: popup.style.top,\n    });\n\n    this.isPopupOpen = true;\n    console.log(\"🎉 STEP 8.4: isPopupOpen set to:\", this.isPopupOpen);\n\n    // Focus input\n    setTimeout(() => {\n      const input = document.getElementById(\"mermaid-ai-chat-input\");\n      console.log(\"🎉 STEP 8.5: Focusing input element:\", input);\n      if (input) {\n        input.focus();\n        console.log(\"✅ STEP 8.5: Input focused successfully\");\n      } else {\n        console.error(\"❌ STEP 8.5: Input element not found!\");\n      }\n    }, 100);\n\n    console.log(\"✅ STEP 8: showChatPopup completed\");\n  }\n\n  /**\n   * Update Mermaid preview from code editor\n   */\n  async updateMermaidPreview() {\n    const codeEditor = document.getElementById(\"mermaid-code-editor\");\n    if (!codeEditor) return;\n\n    // ✅ Skip update if currently zooming to prevent flicker\n    if (this.isZooming) {\n      console.log(\"🔍 Skipping preview update during zoom to prevent flicker\");\n      return;\n    }\n\n    const code = codeEditor.value.trim();\n\n    // Update current content\n    this.currentMermaidContent = code;\n\n    // Store current zoom level\n    const currentZoom = this.currentZoom;\n\n    // Use preview component to update\n    await this.preview.updatePreview(code);\n\n    // ✅ Reapply zoom after preview update to maintain zoom level\n    if (currentZoom !== 1.0) {\n      setTimeout(() => {\n        this.currentZoom = currentZoom;\n        this.applyZoom();\n      }, 50); // Small delay to ensure DOM is updated\n    }\n  }\n\n  hideChatPopup() {\n    const popup = document.getElementById(\"mermaid-ai-chat-popup\");\n    const messagesContainer = document.getElementById(\n      \"mermaid-ai-chat-messages\"\n    );\n    const input = document.getElementById(\"mermaid-ai-chat-input\");\n\n    // 🧱 Kiểm tra popup tồn tại trước khi ẩn\n    if (popup) {\n      popup.style.display = \"none\";\n      this.isPopupOpen = false;\n    } else {\n      console.warn(\"⚠️ Không tìm thấy phần tử popup (mermaid-ai-chat-popup)\");\n    }\n\n    // 🧹 Xóa tin nhắn, giữ lại system message\n    if (messagesContainer) {\n      const systemMessage = messagesContainer.querySelector(\".system\");\n\n      // Chỉ reset khi container tồn tại\n      messagesContainer.innerHTML = \"\";\n      if (systemMessage) {\n        messagesContainer.appendChild(systemMessage);\n      } else {\n        console.warn(\"⚠️ Không tìm thấy system message trong chat container\");\n      }\n    } else {\n      console.warn(\n        \"⚠️ Không tìm thấy phần tử messages container (mermaid-ai-chat-messages)\"\n      );\n    }\n\n    // 🧽 Xóa input nếu có\n    if (input) {\n      input.value = \"\";\n    } else {\n      console.warn(\"⚠️ Không tìm thấy input (mermaid-ai-chat-input)\");\n    }\n\n    console.log(\"✅ Chat popup closed (đã kiểm tra đầy đủ phần tử)\");\n  }\n\n  async sendMessage() {\n    const input = document.getElementById(\"mermaid-ai-chat-input\");\n    const codeEditor = document.getElementById(\"mermaid-code-editor\");\n    const sendBtn = document.getElementById(\"mermaid-ai-chat-send\");\n    const message = input.value.trim();\n\n    if (!message) return;\n\n    // Get current code from editor\n    const currentCode = codeEditor.value.trim();\n    if (!currentCode) {\n      alert(\"⚠️ Please enter some Mermaid code first\");\n      return;\n    }\n\n    // Update current content\n    this.currentMermaidContent = currentCode;\n\n    // Disable send button and show loading\n    sendBtn.disabled = true;\n    sendBtn.textContent = \"🤔 Thinking...\";\n    input.disabled = true;\n\n    try {\n      // Call AI service\n      const response = await this.aiService.modifyDiagram(\n        this.currentMermaidContent,\n        message\n      );\n\n      // Update code editor with new diagram\n      codeEditor.value = response.edited_diagram;\n      this.currentMermaidContent = response.edited_diagram;\n\n      // Update preview\n      await this.updateMermaidPreview();\n\n      // Clear input\n      input.value = \"\";\n\n      console.log(\"✅ Diagram updated successfully by AI\");\n    } catch (error) {\n      console.error(\"❌ AI API error:\", error);\n\n      // Get user-friendly error message\n      const errorMessage = this.aiService.getErrorMessage(error);\n      alert(`❌ ${errorMessage}`);\n    } finally {\n      // Re-enable controls\n      sendBtn.disabled = false;\n      sendBtn.textContent = \"Send\";\n      input.disabled = false;\n      input.focus();\n    }\n  }\n\n  /**\n   * Save the current diagram back to Confluence\n   */\n  async saveDiagram() {\n    const codeEditor = document.getElementById(\"mermaid-code-editor\");\n    const saveBtn = document.getElementById(\"mermaid-ai-chat-save\");\n\n    if (!codeEditor) {\n      alert(\"❌ Code editor not found\");\n      return;\n    }\n\n    const currentCode = codeEditor.value.trim();\n    if (!currentCode) {\n      alert(\"⚠️ Please enter some Mermaid code first\");\n      return;\n    }\n\n    // Update current content\n    this.currentMermaidContent = currentCode;\n\n    // Disable save button and show loading\n    saveBtn.disabled = true;\n    saveBtn.textContent = \"💾 Saving...\";\n\n    try {\n      // Get saved diagram info from localStorage\n      const diagramInfoStr = localStorage.getItem(\"mermaid_diagram_info\");\n      if (!diagramInfoStr) {\n        throw new Error(\n          \"No diagram info found. Please click on a Mermaid image first.\"\n        );\n      }\n\n      const diagramInfo = JSON.parse(diagramInfoStr);\n      const pageId = MermaidApiClient.extractPageId();\n\n      if (!pageId) {\n        throw new Error(\"Could not extract page ID from current page.\");\n      }\n\n      console.log(`💾 Saving diagram with info:`, diagramInfo);\n\n      // Step 1: Update the Mermaid diagram with full data\n      const updateData = await this.updateMermaidDiagram(\n        diagramInfo.filename,\n        pageId,\n        currentCode,\n        diagramInfo.parsedParams\n      );\n      const reversionNew = updateData?.revision ? updateData.revision : 1;\n      // Step 2: Generate new placeholder image\n      const newImageHtml = await this.generatePlaceholderImage(\n        pageId,\n        diagramInfo.parsedParams,\n        reversionNew\n      );\n\n      // Step 3: Replace old image with new image in DOM\n      await this.replaceImageInDOM(\n        diagramInfo.parsedParams?.filename,\n        newImageHtml\n      );\n\n      // Show success message\n      alert(\"✅ Diagram saved and updated successfully!\");\n\n      // Close the popup after successful save\n      this.hideChatPopup();\n    } catch (error) {\n      console.error(\"❌ Error saving diagram:\", error);\n      alert(`❌ Error saving diagram: ${error.message}`);\n    } finally {\n      // Re-enable save button\n      saveBtn.disabled = false;\n      saveBtn.textContent = \"💾 Save\";\n    }\n  }\n\n  /**\n   * Update Mermaid diagram with full data (filename, data, svg, png)\n   */\n  async updateMermaidDiagram(filename, pageId, mermaidCode, parsedParams) {\n    console.log(`🔄 Updating Mermaid diagram: ${filename} on page ${pageId}`);\n\n    // Generate SVG and PNG from Mermaid code\n    const { svg, png } = await this.generateMermaidAssets(mermaidCode);\n\n    // Get current revision and increment it\n    const currentRevision = parseInt(parsedParams?.revision || \"1\");\n\n    const updateData = {\n      filename: filename,\n      data: mermaidCode,\n      revision: currentRevision + 1,\n      svg: svg,\n      png: png,\n    };\n\n    console.log(\"📤 Sending diagram update:\", {\n      filename,\n      revision: currentRevision + 1,\n      dataLength: mermaidCode.length,\n      svgLength: svg.length,\n      pngLength: png.length,\n    });\n\n    const response = await fetch(\n      `${CONFLUENCE_API_URLS.MERMAID_UPDATE}/${pageId}`,\n      {\n        method: \"PUT\",\n        headers: {\n          Accept: \"*/*\",\n          \"Accept-Language\": \"en-US,en;q=0.9,vi;q=0.8\",\n          \"Cache-Control\": \"no-cache\",\n          Connection: \"keep-alive\",\n          \"Content-Type\": \"application/json; charset=utf-8\",\n          Pragma: \"no-cache\",\n          Referer: CONFLUENCE_API_URLS.MERMAID_EDIT_REFERER,\n          \"Sec-Fetch-Dest\": \"empty\",\n          \"Sec-Fetch-Mode\": \"cors\",\n          \"Sec-Fetch-Site\": \"same-origin\",\n          \"User-Agent\": navigator.userAgent,\n          \"X-Requested-With\": \"XMLHttpRequest\",\n          \"X-Atlassian-Token\": \"no-check\",\n          \"sec-ch-ua\":\n            '\"Chromium\";v=\"140\", \"Not=A?Brand\";v=\"24\", \"Google Chrome\";v=\"140\"',\n          \"sec-ch-ua-mobile\": \"?0\",\n          \"sec-ch-ua-platform\": '\"Windows\"',\n        },\n        body: JSON.stringify(updateData),\n      }\n    );\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(\n        `Mermaid Update API Error: ${response.status} - ${errorText}`\n      );\n    }\n\n    const result = await response.json();\n    console.log(\"✅ Mermaid diagram updated successfully:\", result);\n    return result;\n  }\n\n  /**\n   * Generate SVG and PNG assets from Mermaid code\n   */\n  async generateMermaidAssets(mermaidCode) {\n    try {\n      // Import Mermaid dynamically if not already available\n      if (!window.mermaid) {\n        console.log(\"📦 Loading Mermaid library...\");\n        await MermaidRenderer.loadMermaidScript();\n      }\n\n      // Initialize Mermaid if needed\n      if (!window.mermaid.mermaidAPI) {\n        window.mermaid.initialize({ startOnLoad: false });\n      }\n\n      console.log(\"🎨 Generating SVG from Mermaid code...\");\n\n      // Generate SVG\n      const { svg } = await window.mermaid.render(\"temp-diagram\", mermaidCode);\n\n      console.log(\"✅ SVG generated successfully\", svg);\n\n      // Generate PNG from SVG using new method\n      const pngDataUrl = await this.convertSvgToPngDataUrl(svg);\n\n      if (!pngDataUrl) {\n        throw new Error(\"Failed to convert SVG to PNG\");\n      }\n\n      // Extract base64 part from data URL (remove \"data:image/png;base64,\" prefix)\n      const pngBase64 = pngDataUrl.split(\",\")[1];\n\n      console.log(\"✅ PNG generated successfully\");\n\n      return {\n        svg: svg,\n        png: pngBase64,\n      };\n    } catch (error) {\n      console.error(\"❌ Error generating Mermaid assets:\", error);\n      throw new Error(`Failed to generate Mermaid assets: ${error.message}`);\n    }\n  }\n\n  /**\n   * Encode SVG for API\n   */\n  encodeSvg(svg) {\n    // Encode SVG to base64\n    return btoa(\n      new TextEncoder()\n        .encode(svg)\n        .reduce((data, byte) => data + String.fromCharCode(byte), \"\")\n    );\n  }\n\n  /**\n   * Chuyển đổi chuỗi SVG thành chuỗi Data URL của định dạng PNG.\n   * @param {string} svgString Chuỗi XML của SVG (ví dụ: <svg>...</svg>).\n   * @param {number} scale Hệ số phóng đại (ví dụ: 2 để tăng gấp đôi độ phân giải).\n   * @returns {Promise<string|null>} Promise trả về chuỗi Data URL (data:image/png;base64,...)\n   */\n  async convertSvgToPngDataUrl(svgString, scale = 2) {\n    return new Promise((resolve) => {\n      if (!svgString) {\n        console.error(\"Lỗi: Chuỗi SVG đầu vào rỗng.\");\n        return resolve(null);\n      }\n\n      // 1. Mã hóa chuỗi SVG thành Data URL\n      // Cần đảm bảo chuỗi không có ký tự đặc biệt gây lỗi.\n      const svgUrl =\n        \"data:image/svg+xml;base64,\" +\n        btoa(\n          new TextEncoder()\n            .encode(svgString)\n            .reduce((data, byte) => data + String.fromCharCode(byte), \"\")\n        );\n\n      const canvas = document.createElement(\"canvas\");\n      const ctx = canvas.getContext(\"2d\");\n      const img = new Image();\n\n      img.onload = function () {\n        // Lấy kích thước gốc của SVG\n        const originalWidth = img.width;\n        const originalHeight = img.height;\n\n        console.log(`🖼️ SVG original size: ${originalWidth}x${originalHeight}`);\n\n        // Tính kích thước canvas với scale\n        const canvasWidth = originalWidth * scale;\n        const canvasHeight = originalHeight * scale;\n\n        // Đặt kích thước Canvas\n        canvas.width = canvasWidth;\n        canvas.height = canvasHeight;\n\n        console.log(\n          `🖼️ Canvas size: ${canvasWidth}x${canvasHeight} (scale: ${scale})`\n        );\n\n        // Đặt nền trắng cho toàn bộ canvas\n        ctx.fillStyle = \"white\";\n        ctx.fillRect(0, 0, canvasWidth, canvasHeight);\n\n        // Vẽ ảnh SVG lên Canvas với kích thước đã scale\n        // Không dùng ctx.scale() để tránh confusion, thay vào đó scale trực tiếp trong drawImage\n        ctx.drawImage(img, 0, 0, canvasWidth, canvasHeight);\n\n        console.log(\"✅ SVG drawn to canvas successfully\");\n\n        // 3. Xuất ra chuỗi Data URL định dạng PNG\n        const pngDataUrl = canvas.toDataURL(\"image/png\");\n\n        // Dọn dẹp\n        canvas.remove();\n\n        resolve(pngDataUrl);\n      };\n\n      img.onerror = function (err) {\n        console.error(\"Lỗi khi tải SVG vào Image object:\", err);\n        // Dọn dẹp\n        canvas.remove();\n        resolve(null);\n      };\n\n      // Bắt đầu tải ảnh SVG đã mã hóa\n      img.src = svgUrl;\n    });\n  }\n\n  /**\n   * Convert SVG to PNG base64 (legacy method)\n   */\n  async svgToPng(svg) {\n    return new Promise((resolve, reject) => {\n      const canvas = document.createElement(\"canvas\");\n      const ctx = canvas.getContext(\"2d\");\n      const img = new Image();\n\n      img.onload = () => {\n        canvas.width = img.width;\n        canvas.height = img.height;\n        ctx.drawImage(img, 0, 0);\n\n        // Get base64 PNG (remove data:image/png;base64, prefix)\n        const pngBase64 = canvas.toDataURL(\"image/png\").split(\",\")[1];\n        resolve(pngBase64);\n      };\n\n      img.onerror = (error) => {\n        reject(new Error(`Failed to convert SVG to PNG: ${error}`));\n      };\n\n      // Create blob URL for SVG\n      const svgBlob = new Blob([svg], { type: \"image/svg+xml\" });\n      const url = URL.createObjectURL(svgBlob);\n      img.src = url;\n    });\n  }\n\n  /**\n   * Save Mermaid code to Confluence (legacy method - kept for compatibility)\n   */\n  async saveMermaidCode(filename, pageId, mermaidCode) {\n    const response = await fetch(CONFLUENCE_API_URLS.MERMAID_SAVE, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Accept: \"application/json\",\n        \"X-Atlassian-Token\": \"no-check\",\n      },\n      body: JSON.stringify({\n        pageId: pageId,\n        filename: filename,\n        mermaidCode: mermaidCode,\n      }),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(\n        `Mermaid Save API Error: ${response.status} - ${errorText}`\n      );\n    }\n\n    const result = await response.json();\n    console.log(\"✅ Mermaid code saved successfully:\", result);\n    return result;\n  }\n\n  /**\n   * Generate new placeholder image using TinyMCE API\n   */\n  async generatePlaceholderImage(pageId, parsedParams, reversionNew) {\n    const macroData = {\n      contentId: pageId,\n      macro: {\n        name: \"mermaid-cloud\",\n        params: {\n          filename: parsedParams?.filename || \"Diagram\",\n          revision: reversionNew, // Increment revision\n          zoom: parsedParams?.zoom || \"fit\",\n          toolbar: parsedParams?.toolbar || \"bottom\",\n          format: parsedParams?.format || \"svg\",\n        },\n      },\n    };\n\n    console.log(\"🖼️ Generating placeholder with data:\", macroData);\n\n    const response = await fetch(CONFLUENCE_API_URLS.TINYMCE_PLACEHOLDER, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json; charset=UTF-8\",\n        Accept: \"text/plain, */*; q=0.01\",\n        \"X-Requested-With\": \"XMLHttpRequest\",\n        \"X-Atlassian-Token\": \"no-check\",\n      },\n      body: JSON.stringify(macroData),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(\n        `TinyMCE Placeholder API Error: ${response.status} - ${errorText}`\n      );\n    }\n\n    const newImageHtml = await response.text();\n    console.log(\"✅ New placeholder image generated:\", newImageHtml);\n\n    return newImageHtml;\n  }\n\n  /**\n   * Replace old image with new image in DOM by filename\n   */\n  async replaceImageInDOM(filename, newImageHtml) {\n    if (!filename || !newImageHtml) {\n      console.error(\"❌ Missing filename or newImageHtml\");\n      return;\n    }\n\n    console.log(`🔄 Looking for images with filename: ${filename}`);\n\n    // Create temporary element to parse new image HTML\n    const tempDiv = document.createElement(\"div\");\n    tempDiv.innerHTML = newImageHtml;\n    const newImg = tempDiv.querySelector(\"img\");\n\n    if (!newImg) {\n      throw new Error(\"Could not parse new image from HTML\");\n    }\n\n    console.log(\"🆕 New image element:\", newImg);\n\n    // Find images by filename in data-macro-parameters\n    const foundImages = this.findImagesByFilename(filename);\n\n    console.log(`🔍 Found ${foundImages.length} images to replace`);\n\n    foundImages.forEach((oldImg, index) => {\n      console.log(`🔄 Replacing image ${index + 1}:`, oldImg);\n\n      // Replace all attributes from new image to old image\n      this.replaceImageAttributes(oldImg, newImg);\n\n      console.log(\"✅ Image replaced successfully:\", oldImg);\n    });\n  }\n\n  /**\n   * Find images by filename in data-macro-parameters\n   */\n  findImagesByFilename(filename) {\n    const foundImages = [];\n\n    // Search in main document\n    const mainImages = document.querySelectorAll(\"img[data-macro-parameters]\");\n    mainImages.forEach((img) => {\n      const macroParams = img.getAttribute(\"data-macro-parameters\");\n      if (macroParams && macroParams.includes(`filename=${filename}`)) {\n        foundImages.push(img);\n      }\n    });\n\n    // Search in iframes (Confluence editor)\n    const iframes = document.querySelectorAll(\"iframe\");\n    iframes.forEach((iframe) => {\n      try {\n        const iframeDoc =\n          iframe.contentDocument || iframe.contentWindow.document;\n        const iframeImages = iframeDoc.querySelectorAll(\n          \"img[data-macro-parameters]\"\n        );\n\n        iframeImages.forEach((img) => {\n          const macroParams = img.getAttribute(\"data-macro-parameters\");\n          if (macroParams && macroParams.includes(`filename=${filename}`)) {\n            foundImages.push(img);\n          }\n        });\n      } catch (error) {\n        console.warn(\"Could not access iframe content:\", error);\n      }\n    });\n\n    return foundImages;\n  }\n\n  /**\n   * Replace all attributes from new image to old image\n   */\n  replaceImageAttributes(oldImg, newImg) {\n    // Get all attributes from new image\n    const newAttributes = newImg.attributes;\n\n    // Remove all old attributes except those we want to keep\n    const attributesToKeep = [\"id\", \"class\"]; // Keep these if you want\n    const oldAttributes = Array.from(oldImg.attributes);\n\n    oldAttributes.forEach((attr) => {\n      if (!attributesToKeep.includes(attr.name)) {\n        oldImg.removeAttribute(attr.name);\n      }\n    });\n\n    // Copy all attributes from new image\n    Array.from(newAttributes).forEach((attr) => {\n      oldImg.setAttribute(attr.name, attr.value);\n    });\n\n    console.log(\"🔄 Attributes replaced:\", {\n      old: oldAttributes.map((a) => `${a.name}=\"${a.value}\"`),\n      new: Array.from(newAttributes).map((a) => `${a.name}=\"${a.value}\"`),\n    });\n  }\n\n  addMessage(type, content) {\n    const messagesContainer = document.getElementById(\n      \"mermaid-ai-chat-messages\"\n    );\n    const messageId = \"msg-\" + Date.now();\n\n    const messageDiv = document.createElement(\"div\");\n    messageDiv.className = `mermaid-ai-chat-message ${type}`;\n    messageDiv.id = messageId;\n    messageDiv.innerHTML = `\n      <div class=\"message-content\">\n        <p>${content}</p>\n      </div>\n    `;\n\n    messagesContainer.appendChild(messageDiv);\n    messagesContainer.scrollTop = messagesContainer.scrollHeight;\n\n    return messageId;\n  }\n\n  removeMessage(messageId) {\n    const message = document.getElementById(messageId);\n    if (message) {\n      message.remove();\n    }\n  }\n}\n\n// Export for use as service in K-Tool Extension\n// Initialization will be handled by the main content.js\n","// Text Edit AI Service for K-Tool Extension\nimport { API_URLS } from \"../../shared/constants.js\";\n\nexport class TextEditAI {\n  constructor() {\n    this.isPopupOpen = false;\n    this.selectedText = \"\";\n    this.selectedElement = null;\n    this.selectedDocument = document; // Track which document the selection came from\n    this.editButton = null;\n\n    console.log(\"🚀 TextEditAI initializing...\");\n    this.init();\n  }\n\n  async init() {\n    console.log(\"🚀 TextEditAI initializing...\");\n\n    // Check if already injected\n    if (document.getElementById(\"text-edit-ai-root\")) {\n      console.log(\"🔍 TextEditAI already injected, skipping...\");\n      return;\n    }\n\n    // Load CSS\n    this.loadCSS();\n\n    // Create popup UI\n    this.createPopupUI();\n\n    // Setup text selection detection\n    this.setupTextSelectionDetection();\n\n    console.log(\"✅ TextEditAI ready\");\n  }\n\n  loadCSS() {\n    // Skip external CSS loading - we use inline CSS now\n    console.log(\"📄 CSS: Using inline CSS instead of external file\");\n  }\n\n  setupTextSelectionDetection() {\n    console.log(\"🔍 Setting up text selection detection...\");\n\n    // Listen for text selection events on main document\n    this.attachSelectionListeners(document);\n\n    // Also listen for iframe events\n    this.setupIframeSelectionListeners();\n\n    // Global click handler for hiding edit button only\n    document.addEventListener(\"click\", (e) => {\n      // Hide edit button when clicking elsewhere (but not on popup)\n      if (\n        !e.target.closest(\".text-edit-button\") &&\n        !e.target.closest(\"#text-edit-ai-popup\")\n      ) {\n        this.hideEditButton();\n      }\n    });\n  }\n\n  attachSelectionListeners(doc) {\n    const docType = doc === document ? \"main document\" : \"iframe document\";\n    console.log(`🎯 LISTENERS: Attaching selection listeners to ${docType}`);\n    console.log(`🎯 LISTENERS: Document title:`, doc.title || \"no title\");\n    console.log(`🎯 LISTENERS: Document URL:`, doc.URL || \"no URL\");\n\n    // Remove existing listeners if any (prevent duplicates)\n    if (doc._textEditListenersAttached) {\n      console.log(`⚠️ LISTENERS: ${docType} already has listeners, skipping`);\n      return;\n    }\n\n    const mouseupHandler = (e) => {\n      console.log(`🖱️ MOUSEUP: Event fired in ${docType}`);\n      this.handleTextSelection(e, doc);\n    };\n\n    const keyupHandler = (e) => {\n      // Handle keyboard selection (Shift + Arrow keys, Ctrl+A, etc.)\n      if (e.shiftKey || e.ctrlKey) {\n        console.log(`⌨️ KEYUP: Selection event fired in ${docType}`, e.key);\n        this.handleTextSelection(e, doc);\n      }\n    };\n\n    // Use capture=true for better event handling (like mermaidAIChat)\n    doc.addEventListener(\"mouseup\", mouseupHandler, true);\n    doc.addEventListener(\"keyup\", keyupHandler, true);\n\n    // Mark as attached to prevent duplicates\n    doc._textEditListenersAttached = true;\n    doc._textEditMouseupHandler = mouseupHandler;\n    doc._textEditKeyupHandler = keyupHandler;\n\n    console.log(`✅ LISTENERS: Selection listeners attached to ${docType}`);\n  }\n\n  setupIframeSelectionListeners() {\n    console.log(\"🔍 Setting up iframe selection listeners...\");\n\n    // Find existing iframes\n    this.refreshIframeListeners();\n\n    // Setup Confluence page change detection like mermaidAIChat\n    this.setupConfluencePageChangeDetection();\n\n    // Watch for new iframes\n    const observer = new MutationObserver((mutations) => {\n      mutations.forEach((mutation) => {\n        mutation.addedNodes.forEach((node) => {\n          if (node.nodeType === Node.ELEMENT_NODE) {\n            if (node.tagName === \"IFRAME\") {\n              this.attachToIframe(node);\n            }\n            // Also check for iframes inside added nodes\n            const iframes =\n              node.querySelectorAll && node.querySelectorAll(\"iframe\");\n            if (iframes) {\n              iframes.forEach((iframe) => this.attachToIframe(iframe));\n            }\n          }\n        });\n      });\n    });\n\n    observer.observe(document.body, {\n      childList: true,\n      subtree: true,\n    });\n  }\n\n  setupConfluencePageChangeDetection() {\n    console.log(\n      \"🔍 PAGE CHANGE: Setting up Confluence page change detection...\"\n    );\n\n    // Method 1: Listen for Confluence-specific events\n    if (window.AJS && AJS.bind) {\n      // Editor events\n      AJS.bind(\"init.rte\", () => {\n        console.log(\n          \"🔄 PAGE CHANGE: Confluence RTE initialized - re-setting up iframe listeners\"\n        );\n        setTimeout(() => this.refreshIframeListeners(), 1000);\n      });\n\n      AJS.bind(\"rte-ready\", () => {\n        console.log(\n          \"🔄 PAGE CHANGE: Confluence RTE ready - re-setting up iframe listeners\"\n        );\n        setTimeout(() => this.refreshIframeListeners(), 1000);\n      });\n\n      // Page events\n      AJS.bind(\"page.edit.ready\", () => {\n        console.log(\n          \"🔄 PAGE CHANGE: Page edit ready - re-setting up iframe listeners\"\n        );\n        setTimeout(() => this.refreshIframeListeners(), 1500);\n      });\n\n      AJS.bind(\"page.view.ready\", () => {\n        console.log(\n          \"🔄 PAGE CHANGE: Page view ready - re-setting up iframe listeners\"\n        );\n        setTimeout(() => this.refreshIframeListeners(), 1000);\n      });\n    }\n\n    // Method 2: Watch for URL changes (SPA navigation)\n    let currentUrl = window.location.href;\n    const checkUrlChange = () => {\n      if (window.location.href !== currentUrl) {\n        console.log(\n          \"🔄 PAGE CHANGE: URL changed from\",\n          currentUrl,\n          \"to\",\n          window.location.href\n        );\n        currentUrl = window.location.href;\n\n        // Re-setup after URL change\n        setTimeout(() => {\n          console.log(\n            \"🔄 PAGE CHANGE: Re-setting up iframe listeners after URL change\"\n          );\n          this.refreshIframeListeners();\n        }, 2000);\n      }\n    };\n\n    setInterval(checkUrlChange, 1000);\n\n    console.log(\n      \"✅ PAGE CHANGE: Confluence page change detection setup completed\"\n    );\n  }\n\n  refreshIframeListeners() {\n    // Tìm tất cả iframes hiện tại\n    const iframes = document.querySelectorAll(\"iframe\");\n    console.log(\"🔍 IFRAME REFRESH: Found\", iframes.length, \"iframes\");\n\n    if (iframes.length === 0) {\n      console.log(\"⚠️ IFRAME REFRESH: No iframes found on page\");\n      console.log(\n        \"⚠️ IFRAME REFRESH: Document ready state:\",\n        document.readyState\n      );\n\n      // Try again after a delay\n      setTimeout(() => {\n        console.log(\"🔍 IFRAME REFRESH: Retrying iframe search after delay...\");\n        const retryIframes = document.querySelectorAll(\"iframe\");\n        console.log(\n          \"🔍 IFRAME REFRESH: Retry found\",\n          retryIframes.length,\n          \"iframes\"\n        );\n        if (retryIframes.length > 0) {\n          retryIframes.forEach((iframe, index) => {\n            console.log(\n              `🔍 IFRAME REFRESH RETRY ${index}: Processing iframe:`,\n              iframe.src || iframe.id || \"no-src\"\n            );\n            this.attachToIframe(iframe, `refresh-retry-${index}`);\n          });\n        }\n      }, 1000);\n    } else {\n      iframes.forEach((iframe, index) => {\n        console.log(\n          `🔍 IFRAME REFRESH ${index}: Processing iframe:`,\n          iframe.src || iframe.id || \"no-src\"\n        );\n        this.attachToIframe(iframe, `refresh-${index}`);\n      });\n    }\n  }\n\n  attachToExistingIframes() {\n    // This method is now replaced by refreshIframeListeners\n    // Keep for backward compatibility but delegate to the new method\n    this.refreshIframeListeners();\n  }\n\n  attachToIframe(iframe, id = \"new\") {\n    try {\n      // Skip if already attached\n      if (iframe.dataset.textEditListenerAttached === \"true\") {\n        console.log(`⏭️ Iframe ${id} already has listeners attached`);\n        return;\n      }\n\n      console.log(\n        `🔍 IFRAME ${id}: Attaching to iframe:`,\n        iframe.src || iframe.id || iframe.className || \"no-identifier\"\n      );\n\n      const attachListeners = () => {\n        try {\n          const iframeDoc =\n            iframe.contentDocument || iframe.contentWindow?.document;\n\n          if (!iframeDoc) {\n            console.log(\n              `⚠️ IFRAME ${id}: Cannot access iframe document (cross-origin or not loaded)`\n            );\n            return false;\n          }\n\n          console.log(\n            `✅ IFRAME ${id}: Document accessible, ready state:`,\n            iframeDoc.readyState\n          );\n          console.log(`✅ IFRAME ${id}: Document URL:`, iframeDoc.URL);\n          console.log(`✅ IFRAME ${id}: Document body:`, !!iframeDoc.body);\n\n          // Wait for body to be available\n          if (!iframeDoc.body) {\n            console.log(`⏳ IFRAME ${id}: Body not ready, waiting...`);\n            setTimeout(() => attachListeners(), 100);\n            return false;\n          }\n\n          console.log(\n            `🎯 IFRAME ${id}: Attaching selection listeners to iframe document`\n          );\n\n          // Selection handlers: Handle text selection events in iframe\n          const mouseupHandler = (event) => {\n            console.log(`🖱️ IFRAME ${id} MOUSEUP: Event fired in iframe`);\n            this.handleTextSelection(event, iframeDoc);\n          };\n\n          const keyupHandler = (event) => {\n            // Handle keyboard selection (Shift + Arrow keys, Ctrl+A, etc.)\n            if (event.shiftKey || event.ctrlKey) {\n              console.log(\n                `⌨️ IFRAME ${id} KEYUP: Selection event fired in iframe`,\n                event.key\n              );\n              this.handleTextSelection(event, iframeDoc);\n            }\n          };\n\n          // Remove existing listeners if any\n          if (iframeDoc.textEditMouseupHandler) {\n            iframeDoc.removeEventListener(\n              \"mouseup\",\n              iframeDoc.textEditMouseupHandler,\n              true\n            );\n          }\n          if (iframeDoc.textEditKeyupHandler) {\n            iframeDoc.removeEventListener(\n              \"keyup\",\n              iframeDoc.textEditKeyupHandler,\n              true\n            );\n          }\n\n          // Add new listeners with capture=true to catch events early\n          iframeDoc.addEventListener(\"mouseup\", mouseupHandler, true);\n          iframeDoc.addEventListener(\"keyup\", keyupHandler, true);\n\n          // Store references to remove later if needed\n          iframeDoc.textEditMouseupHandler = mouseupHandler;\n          iframeDoc.textEditKeyupHandler = keyupHandler;\n          iframeDoc._textEditListenersAttached = true;\n\n          // Mark iframe as attached\n          iframe.dataset.textEditListenerAttached = \"true\";\n          console.log(\n            `✅ IFRAME ${id}: Selection listeners attached successfully`\n          );\n          return true;\n        } catch (e) {\n          console.log(\n            `❌ IFRAME ${id}: Error accessing iframe content:`,\n            e.message\n          );\n          return false;\n        }\n      };\n\n      // Remove existing load listener if any (like mermaidAIChat)\n      if (iframe.textEditLoadHandler) {\n        iframe.removeEventListener(\"load\", iframe.textEditLoadHandler);\n      }\n\n      // Create load handler\n      const loadHandler = () => {\n        console.log(`🔍 IFRAME ${id}: Iframe loaded, attaching listeners...`);\n        setTimeout(attachListeners, 100); // Small delay to ensure DOM is ready\n      };\n\n      // Add load listener\n      iframe.addEventListener(\"load\", loadHandler);\n      iframe.textEditLoadHandler = loadHandler;\n\n      // If iframe is already loaded, call handler immediately\n      if (\n        iframe.contentDocument &&\n        iframe.contentDocument.readyState === \"complete\"\n      ) {\n        console.log(`� IFRAME ${id}: Already loaded, attaching immediately`);\n        loadHandler();\n      } else {\n        console.log(`⏳ IFRAME ${id}: Waiting for iframe to load...`);\n      }\n    } catch (error) {\n      console.log(\n        `❌ IFRAME ${id}: Error setting up iframe listener:`,\n        error.message\n      );\n    }\n  }\n\n  handleTextSelection(_e, doc = document) {\n    const docType = doc === document ? \"main document\" : \"iframe document\";\n    console.log(`🔍 SELECTION: Handling text selection in ${docType}`);\n\n    // Small delay to ensure selection is complete\n    setTimeout(() => {\n      try {\n        // Get selection from the appropriate document/window\n        const selection =\n          doc === document ? window.getSelection() : doc.getSelection();\n\n        if (!selection) {\n          console.log(`⚠️ SELECTION: No selection API available in ${docType}`);\n          return;\n        }\n\n        const selectedText = selection.toString().trim();\n        console.log(\n          `📝 SELECTION: Selected text length: ${selectedText.length} in ${docType}`\n        );\n\n        if (selectedText.length > 0) {\n          console.log(\n            `📝 SELECTION: Text selected: \"${selectedText.substring(0, 50)}${\n              selectedText.length > 50 ? \"...\" : \"\"\n            }\"`\n          );\n\n          // Check if we're in Confluence edit mode\n          const isEditMode = this.isInConfluenceEditMode();\n          console.log(`📝 SELECTION: Edit mode check result:`, isEditMode);\n\n          if (isEditMode) {\n            console.log(\n              `✅ SELECTION: In edit mode, showing button for ${docType} selection`\n            );\n\n            this.selectedText = selectedText;\n            this.selectedElement = selection.getRangeAt(0);\n            this.selectedDocument = doc; // Store which document the selection came from\n            this.showEditButton();\n          } else {\n            console.log(`❌ SELECTION: Not in edit mode, hiding button`);\n            this.hideEditButton();\n          }\n        } else {\n          console.log(\n            `📝 SELECTION: No text selected in ${docType}, hiding button`\n          );\n          this.hideEditButton();\n        }\n      } catch (error) {\n        console.error(\n          `❌ SELECTION: Error handling selection in ${docType}:`,\n          error\n        );\n      }\n    }, 100);\n  }\n\n  isInConfluenceEditMode() {\n    // Check various indicators that we're in Confluence edit mode\n    const editIndicators = [\n      // Confluence editor iframe\n      document.querySelector('iframe[id*=\"editor\"]'),\n      // Edit mode class on body\n      document.body.classList.contains(\"edit-mode\"),\n      // Confluence editor toolbar\n      document.querySelector(\".confluence-editor-toolbar\"),\n      // Edit page URL pattern\n      window.location.href.includes(\"/pages/editpage.action\"),\n      window.location.href.includes(\"/pages/resumedraft.action\"),\n      window.location.href.includes(\"mode=edit\"),\n      // TinyMCE editor\n      document.querySelector(\".mce-tinymce\"),\n      // Modern Confluence editor\n      document.querySelector('[data-testid=\"editor\"]'),\n      // Confluence content editable areas\n      document.querySelector('[contenteditable=\"true\"]'),\n      // Atlassian editor\n      document.querySelector(\".ak-editor-content-area\"),\n      // Legacy Confluence editor\n      document.querySelector(\"#wysiwygTextarea_ifr\"),\n      // Check if we're inside an iframe that might be an editor\n      window.parent !== window &&\n        window.frameElement &&\n        (window.frameElement.id.includes(\"editor\") ||\n          window.frameElement.src.includes(\"editor\")),\n    ];\n\n    const isEditMode = editIndicators.some((indicator) => indicator);\n    console.log(\"🔍 Confluence edit mode check:\", isEditMode);\n    return isEditMode;\n  }\n\n  showEditButton() {\n    // Remove existing button\n    this.hideEditButton();\n\n    // Create edit button\n    this.editButton = document.createElement(\"button\");\n    this.editButton.className = \"text-edit-button\";\n    this.editButton.innerHTML = \"✏️ Edit with AI\";\n    this.editButton.style.cssText = `\n      position: absolute;\n      background: #0066cc;\n      color: white;\n      border: none;\n      border-radius: 4px;\n      padding: 6px 12px;\n      font-size: 12px;\n      cursor: pointer;\n      z-index: 10000;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n      transition: all 0.2s;\n    `;\n\n    // Position button near the selection - get selection range for better positioning\n    try {\n      const doc = this.selectedDocument || document;\n      const selection =\n        doc === document ? window.getSelection() : doc.getSelection();\n\n      if (selection.rangeCount > 0) {\n        const range = selection.getRangeAt(0);\n        const rect = range.getBoundingClientRect();\n\n        // Calculate position relative to viewport\n        let left = rect.left + rect.width / 2 - 60; // Center button on selection\n        let top = rect.bottom + 5; // Position below selection\n\n        // Adjust if button would go off screen\n        const buttonWidth = 120;\n        const buttonHeight = 32;\n\n        if (left + buttonWidth > window.innerWidth) {\n          left = window.innerWidth - buttonWidth - 10;\n        }\n        if (left < 10) {\n          left = 10;\n        }\n\n        if (top + buttonHeight > window.innerHeight) {\n          top = rect.top - buttonHeight - 5; // Position above selection\n        }\n\n        this.editButton.style.left = left + \"px\";\n        this.editButton.style.top = top + \"px\";\n\n        console.log(\"📍 Button positioned at:\", { left, top, rect });\n      }\n    } catch (error) {\n      console.error(\"❌ Error positioning button:\", error);\n      // Fallback positioning\n      this.editButton.style.left = \"50px\";\n      this.editButton.style.top = \"50px\";\n    }\n\n    // Add hover effect\n    this.editButton.addEventListener(\"mouseenter\", () => {\n      this.editButton.style.background = \"#0052a3\";\n      this.editButton.style.transform = \"scale(1.05)\";\n    });\n\n    this.editButton.addEventListener(\"mouseleave\", () => {\n      this.editButton.style.background = \"#0066cc\";\n      this.editButton.style.transform = \"scale(1)\";\n    });\n\n    // Add click handler\n    this.editButton.addEventListener(\"click\", (e) => {\n      e.preventDefault();\n      e.stopPropagation();\n      this.showEditPopup();\n    });\n\n    document.body.appendChild(this.editButton);\n  }\n\n  hideEditButton() {\n    if (this.editButton) {\n      this.editButton.remove();\n      this.editButton = null;\n    }\n  }\n\n  showEditPopup() {\n    console.log(\"🔓 SHOW: Attempting to show popup...\");\n\n    // Ensure popup exists\n    let popup = document.getElementById(\"text-edit-ai-popup\");\n    if (!popup) {\n      console.log(\"🔧 SHOW: Popup not found, creating...\");\n      this.createPopupUI();\n      popup = document.getElementById(\"text-edit-ai-popup\");\n      if (!popup) {\n        console.error(\"❌ SHOW: Failed to create popup!\");\n        return;\n      }\n    }\n\n    // Populate the selected text in the popup\n    const selectedTextDisplay = document.getElementById(\n      \"selected-text-display\"\n    );\n    if (selectedTextDisplay) {\n      selectedTextDisplay.textContent = this.selectedText;\n    }\n\n    // Clear previous input\n    const promptInput = document.getElementById(\"edit-prompt-input\");\n    if (promptInput) {\n      promptInput.value = \"\";\n    }\n\n    // Position popup in center of screen\n    popup.style.display = \"flex\";\n    popup.style.visibility = \"visible\";\n    popup.style.left = \"50%\";\n    popup.style.top = \"50%\";\n    popup.style.transform = \"translate(-50%, -50%)\";\n\n    this.isPopupOpen = true;\n    console.log(\"✅ SHOW: Popup shown successfully\");\n    console.log(\"🔍 SHOW: isPopupOpen =\", this.isPopupOpen);\n\n    // Focus on input\n    setTimeout(() => {\n      if (promptInput) {\n        promptInput.focus();\n      }\n    }, 100);\n\n    // Hide edit button\n    this.hideEditButton();\n  }\n\n  hideEditPopup() {\n    console.log(\"🔒 HIDE: Attempting to hide popup...\");\n    const popup = document.getElementById(\"text-edit-ai-popup\");\n\n    if (popup) {\n      popup.style.display = \"none\";\n      this.isPopupOpen = false;\n      console.log(\"✅ HIDE: Popup hidden successfully\");\n    } else {\n      console.error(\"❌ HIDE: Popup element not found!\");\n    }\n\n    console.log(\"🔍 HIDE: isPopupOpen =\", this.isPopupOpen);\n  }\n\n  // Force close popup - emergency method\n  forceClosePopup() {\n    console.log(\"🚨 FORCE CLOSE: Emergency popup close...\");\n    const root = document.getElementById(\"text-edit-ai-root\");\n    if (root) {\n      root.remove();\n      console.log(\"🗑️ FORCE CLOSE: Root element removed\");\n    }\n    this.isPopupOpen = false;\n    console.log(\"✅ FORCE CLOSE: Popup force closed\");\n  }\n\n  createPopupUI() {\n    // Check if popup already exists\n    const existingRoot = document.getElementById(\"text-edit-ai-root\");\n    if (existingRoot) {\n      console.log(\"✅ Popup already exists, skipping creation\");\n      return;\n    }\n\n    console.log(\"🔧 Creating popup UI...\");\n    const root = document.createElement(\"div\");\n    root.id = \"text-edit-ai-root\";\n    root.innerHTML = `\n      <style>\n        .text-edit-ai-popup {\n          position: fixed;\n          top: 50%;\n          left: 50%;\n          transform: translate(-50%, -50%);\n          width: 600px;\n          max-width: 90vw;\n          background: white;\n          border-radius: 12px;\n          box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);\n          z-index: 10000;\n          font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif;\n          overflow: hidden;\n          border: none;\n          display: flex;\n          flex-direction: column;\n        }\n\n        .text-edit-ai-header {\n          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n          color: white;\n          padding: 16px 20px;\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          cursor: move;\n          user-select: none;\n        }\n\n        .text-edit-ai-header h3 {\n          margin: 0;\n          font-size: 16px;\n          font-weight: 600;\n          color: white;\n        }\n\n        .text-edit-ai-close {\n          background: none;\n          border: none;\n          color: white;\n          font-size: 24px;\n          cursor: pointer;\n          padding: 0;\n          width: 30px;\n          height: 30px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          border-radius: 50%;\n          transition: background-color 0.2s;\n        }\n\n        .text-edit-ai-close:hover {\n          background-color: rgba(255, 255, 255, 0.2);\n        }\n        .text-edit-ai-body {\n          flex: 1;\n          padding: 20px;\n          overflow-y: auto;\n          max-height: 70vh;\n        }\n\n        .selected-text-section {\n          margin-bottom: 20px;\n        }\n\n        .selected-text-display {\n          background: #f8f9fa;\n          border: 1px solid #e9ecef;\n          border-radius: 8px;\n          padding: 12px;\n          font-size: 14px;\n          line-height: 1.5;\n          color: #495057;\n          max-height: 120px;\n          overflow-y: auto;\n          white-space: pre-wrap;\n        }\n\n        .prompt-section {\n          margin-bottom: 20px;\n        }\n\n        .prompt-section label {\n          display: block;\n          margin-bottom: 8px;\n          font-weight: 600;\n          color: #495057;\n          font-size: 14px;\n        }\n        .edit-prompt-input {\n          width: 100%;\n          padding: 12px;\n          border: 2px solid #e9ecef;\n          border-radius: 8px;\n          font-size: 14px;\n          font-family: inherit;\n          resize: vertical;\n          min-height: 80px;\n          transition: border-color 0.2s;\n          box-sizing: border-box;\n        }\n\n        .edit-prompt-input:focus {\n          outline: none;\n          border-color: #667eea;\n          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);\n        }\n\n        .quick-actions {\n          display: flex;\n          flex-wrap: wrap;\n          gap: 8px;\n          margin-bottom: 20px;\n        }\n\n        .quick-action-btn {\n          background: #f8f9fa;\n          border: 1px solid #e9ecef;\n          border-radius: 6px;\n          padding: 6px 12px;\n          font-size: 12px;\n          cursor: pointer;\n          transition: all 0.2s;\n          color: #495057;\n        }\n\n        .quick-action-btn:hover {\n          background: #e9ecef;\n          border-color: #667eea;\n          color: #667eea;\n        }\n\n        .edit-actions {\n          display: flex;\n          justify-content: flex-end;\n          gap: 12px;\n          padding-top: 20px;\n          border-top: 1px solid #e9ecef;\n        }\n\n        .edit-cancel-btn {\n          background: #6c757d;\n          color: white;\n          border: none;\n          border-radius: 6px;\n          padding: 10px 20px;\n          cursor: pointer;\n          font-size: 14px;\n          transition: background-color 0.2s;\n        }\n\n        .edit-cancel-btn:hover {\n          background: #5a6268;\n        }\n\n        .edit-send-btn {\n          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n          color: white;\n          border: none;\n          border-radius: 6px;\n          padding: 10px 20px;\n          cursor: pointer;\n          font-size: 14px;\n          font-weight: 600;\n          transition: all 0.2s;\n        }\n\n        .edit-send-btn:hover:not(:disabled) {\n          transform: translateY(-1px);\n          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);\n        }\n\n        .edit-send-btn:disabled {\n          background: #6c757d;\n          cursor: not-allowed;\n          transform: none;\n        }\n      </style>\n\n      <div id=\"text-edit-ai-popup\" class=\"text-edit-ai-popup\" style=\"display: none;\">\n        <div class=\"text-edit-ai-header\">\n          <h3>✏️ Edit Text with AI</h3>\n          <button class=\"text-edit-ai-close\">&times;</button>\n        </div>\n        <div class=\"text-edit-ai-body\">\n          <div class=\"selected-text-section\">\n            <div id=\"selected-text-display\" class=\"selected-text-display\"></div>\n          </div>\n\n          <div class=\"prompt-section\">\n            <label for=\"edit-prompt-input\">How would you like to edit this text?</label>\n            <textarea\n              id=\"edit-prompt-input\"\n              class=\"edit-prompt-input\"\n              placeholder=\"Enter your editing instructions...\"\n              rows=\"3\"\n            ></textarea>\n          </div>\n\n          <div class=\"edit-actions\">\n            <button id=\"edit-cancel-btn\" class=\"edit-cancel-btn\">Cancel</button>\n            <button id=\"edit-send-btn\" class=\"edit-send-btn\">Send</button>\n          </div>\n        </div>\n      </div>\n    `;\n\n    document.body.appendChild(root);\n    this.bindPopupEvents();\n  }\n\n  bindPopupEvents() {\n    const popup = document.getElementById(\"text-edit-ai-popup\");\n    const header = popup.querySelector(\".text-edit-ai-header\");\n    const closeBtn = popup.querySelector(\".text-edit-ai-close\");\n    const cancelBtn = document.getElementById(\"edit-cancel-btn\");\n    const sendBtn = document.getElementById(\"edit-send-btn\");\n    const promptInput = document.getElementById(\"edit-prompt-input\");\n\n    // Check if events already bound\n    if (popup._textEditEventsBound) {\n      console.log(\"🔗 BIND: Events already bound, skipping...\");\n      return;\n    }\n\n    console.log(\"🔗 BIND: Binding popup events...\");\n    console.log(\"🔗 BIND: Elements found:\", {\n      popup: !!popup,\n      header: !!header,\n      closeBtn: !!closeBtn,\n      cancelBtn: !!cancelBtn,\n      sendBtn: !!sendBtn,\n      promptInput: !!promptInput,\n    });\n\n    // Make popup draggable\n    this.makeDraggable(popup, header);\n\n    // Close popup events with logging\n    closeBtn.addEventListener(\"click\", (e) => {\n      console.log(\"❌ CLOSE: Close button clicked\");\n      e.preventDefault();\n      e.stopPropagation();\n      this.hideEditPopup();\n    });\n\n    cancelBtn.addEventListener(\"click\", (e) => {\n      console.log(\"❌ CANCEL: Cancel button clicked\");\n      e.preventDefault();\n      e.stopPropagation();\n      this.hideEditPopup();\n    });\n\n    // Send button\n    sendBtn.addEventListener(\"click\", () => {\n      this.handleSendEdit();\n    });\n\n    // Enter to send (Ctrl+Enter for new line)\n    promptInput.addEventListener(\"keydown\", (e) => {\n      if (e.key === \"Enter\" && !e.ctrlKey && !e.shiftKey) {\n        e.preventDefault();\n        this.handleSendEdit();\n      }\n    });\n\n    // ESC to close popup\n    document.addEventListener(\"keydown\", (e) => {\n      if (e.key === \"Escape\" && this.isPopupOpen) {\n        console.log(\"⌨️ ESC: Escape key pressed, closing popup\");\n        e.preventDefault();\n        e.stopPropagation();\n        this.hideEditPopup();\n      }\n    });\n\n    // Click outside to close - with proper event handling (like mermaidAIChat.js)\n    setTimeout(() => {\n      const handleClickOutside = (e) => {\n        // Skip if popup is not open\n        if (!this.isPopupOpen) return;\n\n        // Skip if clicking on edit button (to prevent immediate close)\n        if (e.target.closest(\".text-edit-button\")) {\n          return;\n        }\n\n        // Skip if clicking inside popup\n        if (popup.contains(e.target)) {\n          return;\n        }\n\n        console.log(\"🖱️ Click outside popup detected, closing...\");\n        this.hideEditPopup();\n      };\n\n      document.addEventListener(\"click\", handleClickOutside, true);\n    }, 300); // Delay to prevent immediate close after opening\n\n    // Mark events as bound\n    popup._textEditEventsBound = true;\n    console.log(\"✅ BIND: All events bound successfully\");\n  }\n\n  async handleSendEdit() {\n    const promptInput = document.getElementById(\"edit-prompt-input\");\n    const sendBtn = document.getElementById(\"edit-send-btn\");\n    const prompt = promptInput.value.trim();\n\n    if (!prompt) {\n      alert(\"Please enter your editing instructions!\");\n      return;\n    }\n\n    // Disable send button and show loading\n    sendBtn.disabled = true;\n    sendBtn.textContent = \"🤔 Processing...\";\n\n    try {\n      // Get HTML content containing the selected text\n      const htmlContent = this.getSelectedHtmlContent();\n\n      // Call the edit API\n      const editedHtml = await this.callEditAPI(\n        htmlContent,\n        this.selectedText,\n        prompt\n      );\n\n      // Replace the HTML content with edited version\n      this.replaceSelectedHtmlContent(editedHtml);\n\n      // Show success message\n      this.showNotification(\"Text edited successfully!\", \"success\");\n\n      // Close popup\n      this.hideEditPopup();\n    } catch (error) {\n      console.error(\"❌ Edit API error:\", error);\n      alert(`❌ Error editing text: ${error.message}`);\n    } finally {\n      // Re-enable send button\n      sendBtn.disabled = false;\n      sendBtn.textContent = \"Send\";\n    }\n  }\n\n  async callEditAPI(htmlContent, selectedText, prompt) {\n    console.log(\"🤖 Calling Text Edit API...\", {\n      htmlContent,\n      selectedText,\n      prompt,\n    });\n\n    try {\n      const response = await fetch(API_URLS.EDIT_HTML_CONTENT, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({\n          html_content: htmlContent,\n          selected_text: selectedText,\n          prompt: prompt,\n        }),\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(\n          errorData.error || `HTTP ${response.status}: ${response.statusText}`\n        );\n      }\n\n      const editedHtml = await response.text();\n\n      return editedHtml;\n    } catch (error) {\n      console.error(\"❌ Text Edit API error:\", error);\n      throw new Error(`Failed to process text edit request: ${error.message}`);\n    }\n  }\n\n  getSelectedHtmlContent() {\n    try {\n      const doc = this.selectedDocument || document;\n      const selection =\n        doc === document ? window.getSelection() : doc.getSelection();\n\n      if (selection.rangeCount > 0) {\n        const range = selection.getRangeAt(0);\n        const container = range.commonAncestorContainer;\n\n        // Get the parent element that contains the selection\n        let parentElement =\n          container.nodeType === Node.TEXT_NODE\n            ? container.parentElement\n            : container;\n\n        // If the parent is too generic (like body), try to find a more specific container\n        while (\n          parentElement &&\n          (parentElement.tagName === \"BODY\" ||\n            parentElement.tagName === \"HTML\" ||\n            (parentElement.tagName === \"DIV\" && !parentElement.className))\n        ) {\n          if (parentElement.children.length === 1) {\n            parentElement = parentElement.children[0];\n          } else {\n            break;\n          }\n        }\n\n        const htmlContent = parentElement\n          ? parentElement.outerHTML\n          : range.toString();\n        console.log(\"📄 Selected HTML content:\", htmlContent);\n        return htmlContent;\n      }\n\n      return this.selectedText;\n    } catch (error) {\n      console.error(\"❌ Error getting HTML content:\", error);\n      return this.selectedText;\n    }\n  }\n\n  replaceSelectedHtmlContent(newHtmlContent) {\n    try {\n      const doc = this.selectedDocument || document;\n      const selection =\n        doc === document ? window.getSelection() : doc.getSelection();\n\n      console.log(\n        \"🔄 Replacing HTML content in:\",\n        doc === document ? \"main document\" : \"iframe document\"\n      );\n      console.log(\"🔄 New HTML content:\", newHtmlContent);\n\n      if (selection.rangeCount > 0) {\n        const range = selection.getRangeAt(0);\n        const container = range.commonAncestorContainer;\n\n        // Get the parent element that contains the selection\n        let parentElement =\n          container.nodeType === Node.TEXT_NODE\n            ? container.parentElement\n            : container;\n\n        // Find the element that should be replaced\n        while (\n          parentElement &&\n          (parentElement.tagName === \"BODY\" ||\n            parentElement.tagName === \"HTML\" ||\n            (parentElement.tagName === \"DIV\" && !parentElement.className))\n        ) {\n          if (parentElement.children.length === 1) {\n            parentElement = parentElement.children[0];\n          } else {\n            break;\n          }\n        }\n\n        if (parentElement && parentElement !== doc.body) {\n          // Replace the entire parent element with new HTML\n          const tempDiv = doc.createElement(\"div\");\n          tempDiv.innerHTML = newHtmlContent;\n\n          // Replace the parent element with the new content\n          if (tempDiv.children.length === 1) {\n            parentElement.parentNode.replaceChild(\n              tempDiv.firstElementChild,\n              parentElement\n            );\n          } else {\n            // If multiple elements, replace with a fragment\n            const fragment = doc.createDocumentFragment();\n            while (tempDiv.firstChild) {\n              fragment.appendChild(tempDiv.firstChild);\n            }\n            parentElement.parentNode.replaceChild(fragment, parentElement);\n          }\n        } else {\n          // Fallback to replacing just the selected text\n          this.replaceSelectedText(newHtmlContent);\n          return;\n        }\n\n        // Clear selection\n        selection.removeAllRanges();\n        console.log(\"✅ HTML content replaced successfully\");\n      } else {\n        throw new Error(\"No selection range found\");\n      }\n    } catch (error) {\n      console.error(\"❌ Error replacing HTML content:\", error);\n      // Fallback to text replacement\n      this.replaceSelectedText(newHtmlContent);\n    }\n  }\n\n  replaceSelectedText(newContent) {\n    try {\n      // Use the stored selection and document\n      const doc = this.selectedDocument || document;\n      const selection =\n        doc === document ? window.getSelection() : doc.getSelection();\n\n      console.log(\n        \"🔄 Replacing content in:\",\n        doc === document ? \"main document\" : \"iframe document\"\n      );\n      console.log(\n        \"🔄 New content type:\",\n        this.isHTML(newContent) ? \"HTML\" : \"Text\"\n      );\n\n      if (selection.rangeCount > 0) {\n        const range = selection.getRangeAt(0);\n        range.deleteContents();\n\n        // Check if newContent is HTML or plain text\n        if (this.isHTML(newContent)) {\n          console.log(\"📝 Inserting HTML content\");\n          // Create a temporary container to parse HTML\n          const tempDiv = doc.createElement(\"div\");\n          tempDiv.innerHTML = newContent;\n\n          // Insert all child nodes from the temp container\n          const fragment = doc.createDocumentFragment();\n          while (tempDiv.firstChild) {\n            fragment.appendChild(tempDiv.firstChild);\n          }\n          range.insertNode(fragment);\n        } else {\n          console.log(\"📝 Inserting plain text content\");\n          // Insert as plain text\n          range.insertNode(doc.createTextNode(newContent));\n        }\n\n        // Clear selection\n        selection.removeAllRanges();\n\n        console.log(\"✅ Content replaced successfully\");\n      } else {\n        throw new Error(\"No selection range found\");\n      }\n    } catch (error) {\n      console.error(\"❌ Error replacing content:\", error);\n      // Fallback: copy to clipboard\n      navigator.clipboard\n        .writeText(newContent)\n        .then(() => {\n          alert(\n            \"Could not replace content directly. The edited content has been copied to clipboard.\"\n          );\n        })\n        .catch(() => {\n          // If clipboard also fails, show the content in an alert\n          alert(\n            `Could not replace content or copy to clipboard. Here's the edited content:\\n\\n${newContent}`\n          );\n        });\n    }\n  }\n\n  // Helper method to detect if content is HTML\n  isHTML(str) {\n    // Simple HTML detection - check for HTML tags\n    const htmlRegex = /<[^>]*>/;\n    return htmlRegex.test(str);\n  }\n\n  showNotification(message, type = \"info\") {\n    const notification = document.createElement(\"div\");\n    notification.style.cssText = `\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: ${\n        type === \"success\"\n          ? \"#28a745\"\n          : type === \"error\"\n          ? \"#dc3545\"\n          : \"#007bff\"\n      };\n      color: white;\n      padding: 12px 20px;\n      border-radius: 8px;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);\n      z-index: 10002;\n      font-size: 14px;\n      max-width: 300px;\n      opacity: 0;\n      transform: translateX(100%);\n      transition: all 0.3s;\n    `;\n\n    notification.textContent = message;\n    document.body.appendChild(notification);\n\n    // Animate in\n    setTimeout(() => {\n      notification.style.opacity = \"1\";\n      notification.style.transform = \"translateX(0)\";\n    }, 100);\n\n    // Auto remove\n    setTimeout(() => {\n      notification.style.opacity = \"0\";\n      notification.style.transform = \"translateX(100%)\";\n      setTimeout(() => {\n        if (notification.parentNode) {\n          notification.parentNode.removeChild(notification);\n        }\n      }, 300);\n    }, 3000);\n  }\n\n  makeDraggable(element, dragHandle) {\n    let isDragging = false;\n    let dragStartX = 0;\n    let dragStartY = 0;\n    let elementStartX = 0;\n    let elementStartY = 0;\n\n    console.log(\"🎯 DRAG: Setting up draggable element...\");\n\n    // Style the drag handle\n    dragHandle.style.cursor = \"move\";\n    dragHandle.style.userSelect = \"none\";\n\n    const startDrag = (e) => {\n      // Don't drag if clicking on close button\n      if (e.target.classList.contains(\"text-edit-ai-close\")) {\n        return;\n      }\n\n      e.preventDefault();\n      e.stopPropagation();\n\n      isDragging = true;\n\n      // Get mouse position\n      dragStartX = e.clientX;\n      dragStartY = e.clientY;\n\n      // Get element current position\n      elementStartX = parseInt(element.style.left) || 0;\n      elementStartY = parseInt(element.style.top) || 0;\n\n      console.log(\"🎯 DRAG: Started\", {\n        mouseX: dragStartX,\n        mouseY: dragStartY,\n        elementX: elementStartX,\n        elementY: elementStartY,\n      });\n\n      // Add global event listeners\n      document.addEventListener(\"mousemove\", onDrag, true);\n      document.addEventListener(\"mouseup\", stopDrag, true);\n\n      // Prevent text selection during drag\n      document.body.style.userSelect = \"none\";\n    };\n\n    const onDrag = (e) => {\n      if (!isDragging) return;\n\n      e.preventDefault();\n      e.stopPropagation();\n\n      // Calculate mouse movement\n      const deltaX = e.clientX - dragStartX;\n      const deltaY = e.clientY - dragStartY;\n\n      // Calculate new position\n      const newX = elementStartX + deltaX;\n      const newY = elementStartY + deltaY;\n\n      // Keep element within viewport bounds\n      const elementRect = element.getBoundingClientRect();\n      const maxX = window.innerWidth - elementRect.width;\n      const maxY = window.innerHeight - elementRect.height;\n\n      const boundedX = Math.max(0, Math.min(newX, maxX));\n      const boundedY = Math.max(0, Math.min(newY, maxY));\n\n      // Update element position\n      element.style.left = boundedX + \"px\";\n      element.style.top = boundedY + \"px\";\n      element.style.transform = \"none\"; // Remove center transform when dragging\n    };\n\n    const stopDrag = (e) => {\n      if (!isDragging) return;\n\n      e.preventDefault();\n      e.stopPropagation();\n\n      isDragging = false;\n\n      console.log(\"🎯 DRAG: Stopped\");\n\n      // Remove global event listeners\n      document.removeEventListener(\"mousemove\", onDrag, true);\n      document.removeEventListener(\"mouseup\", stopDrag, true);\n\n      // Restore text selection\n      document.body.style.userSelect = \"\";\n\n      // Prevent click outside from firing (like mermaidAIChat.js)\n      e.stopPropagation();\n    };\n\n    // Bind drag events\n    dragHandle.addEventListener(\"mousedown\", startDrag);\n\n    console.log(\"✅ DRAG: Setup completed\");\n  }\n}\n","// K-Tool Extension Content Script\r\nimport { ApiClient, ConfluenceApi } from \"../shared/api.js\";\r\nimport { PROGRESS_STEPS } from \"../shared/constants.js\";\r\nimport { ConfluenceEditor } from \"./confluenceEditor.js\";\r\nimport { MermaidAIChat } from \"./mermaidAI/mermaidAIChat.js\";\r\nimport { TextEditAI } from \"./mermaidAI/textEditAI.js\";\r\nimport { MermaidRenderer } from \"./utils/mermaidRenderer.js\";\r\nimport { StorageManager } from \"./utils/storageManager.js\";\r\nimport { XMLFormatter } from \"./utils/xmlFormatter.js\";\r\n\r\nclass KToolContent {\r\n  constructor() {\r\n    this.settings = {};\r\n    this.isModalOpen = false;\r\n    this.currentTab = \"generate\";\r\n    this.generationJob = null;\r\n    this.progressSteps = [...PROGRESS_STEPS];\r\n    this.confluenceEditor = null;\r\n    this.mermaidAIChat = null;\r\n    this.textEditAI = null;\r\n    this.storageManager = new StorageManager();\r\n    this.init();\r\n  }\r\n\r\n  async init() {\r\n    console.log(\"🚀 K-Tool Content Script initializing...\");\r\n\r\n    // Check if already injected\r\n    if (document.getElementById(\"ktool-root\")) {\r\n      console.log(\"🔍 K-Tool already injected, skipping...\");\r\n      return;\r\n    }\r\n\r\n    // Load settings\r\n    await this.loadSettings();\r\n\r\n    // Inject UI\r\n    this.injectUI();\r\n\r\n    // Bind events\r\n    this.bindEvents();\r\n\r\n    // Initialize Confluence Editor\r\n    try {\r\n      console.log(\"🔧 Initializing ConfluenceEditor...\");\r\n      this.confluenceEditor = new ConfluenceEditor();\r\n      console.log(\"✅ ConfluenceEditor initialized:\", this.confluenceEditor);\r\n    } catch (error) {\r\n      console.error(\"❌ Error initializing ConfluenceEditor:\", error);\r\n      this.confluenceEditor = null;\r\n    }\r\n\r\n    // Initialize Mermaid AI Chat\r\n    try {\r\n      console.log(\"🎨 Initializing MermaidAIChat...\");\r\n      const $ = window.jQuery || window.$ || null;\r\n      this.mermaidAIChat = new MermaidAIChat($);\r\n      console.log(\"✅ MermaidAIChat initialized:\", this.mermaidAIChat);\r\n    } catch (error) {\r\n      console.error(\"❌ Error initializing MermaidAIChat:\", error);\r\n      this.mermaidAIChat = null;\r\n    }\r\n\r\n    // Initialize Text Edit AI\r\n    try {\r\n      console.log(\"✏️ Initializing TextEditAI...\");\r\n      this.textEditAI = new TextEditAI();\r\n      console.log(\"✅ TextEditAI initialized:\", this.textEditAI);\r\n    } catch (error) {\r\n      console.error(\"❌ Error initializing TextEditAI:\", error);\r\n      this.textEditAI = null;\r\n    }\r\n\r\n    // Make available globally for debugging\r\n    window.ktoolContent = this;\r\n\r\n    console.log(\"✅ K-Tool Content Script ready\");\r\n  }\r\n\r\n  async loadSettings() {\r\n    try {\r\n      this.settings = await StorageManager.getSettings();\r\n      console.log(\"⚙️ Settings loaded:\", this.settings);\r\n    } catch (error) {\r\n      console.error(\"❌ Error loading settings:\", error);\r\n    }\r\n  }\r\n\r\n  injectUI() {\r\n    // Create root container\r\n    const root = document.createElement(\"div\");\r\n    root.id = \"ktool-root\";\r\n    document.body.appendChild(root);\r\n\r\n    // Create bubble button\r\n    const bubble = this.createBubble();\r\n    root.appendChild(bubble);\r\n\r\n    // Create modal (initially hidden)\r\n    const modal = this.createModal();\r\n    root.appendChild(modal);\r\n  }\r\n\r\n  createBubble() {\r\n    const bubble = document.createElement(\"div\");\r\n    bubble.className = `ktool-bubble ${\r\n      !this.settings.isEnabled ? \"disabled\" : \"\"\r\n    }`;\r\n\r\n    bubble.innerHTML = `\r\n      <div class=\"ktool-bubble-icon\">K</div>\r\n      <div class=\"ktool-tooltip\">\r\n        ${\r\n          this.settings.isEnabled\r\n            ? \"🚀 K-Tool Document Generator<br/>Click to open document generation tool\"\r\n            : \"⚠️ K-Tool is disabled<br/>Please enable in settings\"\r\n        }\r\n      </div>\r\n    `;\r\n\r\n    bubble.addEventListener(\"click\", () => {\r\n      if (this.settings.isEnabled) {\r\n        this.openModal();\r\n      } else {\r\n        this.showNotification(\r\n          \"K-Tool is disabled. Please enable in extension settings.\",\r\n          \"warning\"\r\n        );\r\n      }\r\n    });\r\n\r\n    return bubble;\r\n  }\r\n\r\n  createModal() {\r\n    const overlay = document.createElement(\"div\");\r\n    overlay.className = \"ktool-modal-overlay\";\r\n\r\n    overlay.innerHTML = `\r\n      <div class=\"ktool-modal\">\r\n        <div class=\"ktool-modal-header\">\r\n          <h2 class=\"ktool-modal-title\">K-Tool Document Generator</h2>\r\n          <button class=\"ktool-modal-close\" type=\"button\">&times;</button>\r\n        </div>\r\n        <div class=\"ktool-modal-body\">\r\n          <div class=\"ktool-tabs\">\r\n            <button class=\"ktool-tab active\" data-tab=\"generate\">📄 Generate Document</button>\r\n            <button class=\"ktool-tab\" data-tab=\"preview\">👁️ Preview</button>\r\n            <button class=\"ktool-tab\" data-tab=\"settings\">⚙️ Settings</button>\r\n          </div>\r\n          \r\n          <!-- Generate Tab -->\r\n          <div class=\"ktool-tab-content active\" data-tab=\"generate\">\r\n            ${this.createGenerateTab()}\r\n          </div>\r\n          \r\n          <!-- Preview Tab -->\r\n          <div class=\"ktool-tab-content\" data-tab=\"preview\" id=\"previewTab\">\r\n            ${this.createPreviewTab()}\r\n          </div>\r\n          \r\n          <!-- Settings Tab -->\r\n          <div class=\"ktool-tab-content\" data-tab=\"settings\">\r\n            ${this.createSettingsTab()}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    return overlay;\r\n  }\r\n\r\n  createGenerateTab() {\r\n    return `\r\n      <div class=\"ktool-form\">\r\n        <div class=\"ktool-form-group\">\r\n          <label class=\"ktool-form-label\">BA Document URL *</label>\r\n          <input\r\n            type=\"url\"\r\n            class=\"ktool-form-input\"\r\n            id=\"baDocUrl\"\r\n            placeholder=\"https://confluence.com/pages/123456\"\r\n            value=\"${window.location.href}\"\r\n          >\r\n        </div>\r\n\r\n        <div class=\"ktool-form-group\">\r\n          <label class=\"ktool-form-label\">Additional Notes (Optional)</label>\r\n          <textarea\r\n            class=\"ktool-form-textarea\"\r\n            id=\"additionalNotes\"\r\n            placeholder=\"Add notes or special requirements...\"\r\n            rows=\"3\"\r\n          ></textarea>\r\n        </div>\r\n\r\n        <div style=\"display: flex; gap: 12px; margin-top: 20px;\">\r\n          <button class=\"ktool-btn ktool-btn-primary\" id=\"generateBtn\">\r\n            🔧 Generate Document\r\n          </button>\r\n          <button class=\"ktool-btn ktool-btn-secondary\" id=\"resetBtn\">\r\n            🔄 Reset\r\n          </button>\r\n        </div>\r\n      </div>\r\n      \r\n      <!-- Progress Section -->\r\n      <div class=\"ktool-progress\" id=\"progressSection\" style=\"display: none;\">\r\n        <h3 style=\"margin: 0 0 16px 0; font-size: 16px;\">Document Generation Progress:</h3>\r\n        <div id=\"progressSteps\"></div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  createPreviewTab() {\r\n    return `\r\n      <div class=\"ktool-form\">\r\n        <div style=\"text-align: center; padding: 40px; color: #6c757d;\">\r\n          <div style=\"font-size: 48px; margin-bottom: 16px;\">📄</div>\r\n          <h3 style=\"margin: 0 0 8px 0;\">No content available for preview</h3>\r\n          <p style=\"margin: 0;\">Please generate document first to preview.</p>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  createSettingsTab() {\r\n    return `\r\n      <div class=\"ktool-form\">\r\n        <div style=\"text-align: center; padding: 40px; color: #6c757d;\">\r\n          <div style=\"font-size: 48px; margin-bottom: 16px;\">⚙️</div>\r\n          <h3 style=\"margin: 0 0 8px 0;\">Extension Settings</h3>\r\n          <p style=\"margin: 0 0 16px 0;\">Click the button below to open settings popup.</p>\r\n          <button class=\"ktool-btn ktool-btn-primary\" id=\"openSettingsBtn\">\r\n            🔧 Open Settings\r\n          </button>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  bindEvents() {\r\n    const modal = document.querySelector(\".ktool-modal-overlay\");\r\n\r\n    // Close modal events\r\n    modal.querySelector(\".ktool-modal-close\").addEventListener(\"click\", () => {\r\n      this.closeModal();\r\n    });\r\n\r\n    modal.addEventListener(\"click\", (e) => {\r\n      if (e.target === modal) {\r\n        this.closeModal();\r\n      }\r\n    });\r\n\r\n    // Tab switching\r\n    const tabs = modal.querySelectorAll(\".ktool-tab\");\r\n    tabs.forEach((tab) => {\r\n      tab.addEventListener(\"click\", () => {\r\n        this.switchTab(tab.dataset.tab);\r\n      });\r\n    });\r\n\r\n    // Generate button\r\n    const generateBtn = modal.querySelector(\"#generateBtn\");\r\n    generateBtn.addEventListener(\"click\", () => {\r\n      this.handleGenerate();\r\n    });\r\n\r\n    // Reset button\r\n    const resetBtn = modal.querySelector(\"#resetBtn\");\r\n    resetBtn.addEventListener(\"click\", () => {\r\n      this.handleReset();\r\n    });\r\n\r\n    // Add settings button listener\r\n    this.addSettingsButtonListener();\r\n\r\n    // Listen for settings changes from background\r\n    chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {\r\n      if (request.action === \"settingsChanged\") {\r\n        this.settings = request.settings;\r\n        this.updateBubbleState();\r\n      }\r\n    });\r\n\r\n    // Keyboard shortcuts\r\n    document.addEventListener(\"keydown\", (e) => {\r\n      // Escape to close modal\r\n      if (e.key === \"Escape\" && this.isModalOpen) {\r\n        this.closeModal();\r\n      }\r\n\r\n      // Ctrl/Cmd + K to open modal\r\n      if ((e.ctrlKey || e.metaKey) && e.key === \"k\" && !this.isModalOpen) {\r\n        e.preventDefault();\r\n        if (this.settings.isEnabled) {\r\n          this.openModal();\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  openModal() {\r\n    const modal = document.querySelector(\".ktool-modal-overlay\");\r\n    modal.classList.add(\"show\");\r\n    this.isModalOpen = true;\r\n\r\n    // Focus first input\r\n    setTimeout(() => {\r\n      const firstInput = modal.querySelector(\".ktool-form-input\");\r\n      if (firstInput) firstInput.focus();\r\n    }, 300);\r\n  }\r\n\r\n  closeModal() {\r\n    const modal = document.querySelector(\".ktool-modal-overlay\");\r\n    modal.classList.remove(\"show\");\r\n    this.isModalOpen = false;\r\n  }\r\n\r\n  addSettingsButtonListener() {\r\n    // Add listener for settings button after modal is created\r\n    setTimeout(() => {\r\n      const settingsBtn = document.querySelector(\"#openSettingsBtn\");\r\n      if (settingsBtn) {\r\n        settingsBtn.addEventListener(\"click\", () => {\r\n          this.openSettingsPopup();\r\n        });\r\n      }\r\n    }, 100);\r\n  }\r\n\r\n  openSettingsPopup() {\r\n    // Open extension popup in navbar\r\n    if (chrome.runtime && chrome.runtime.openOptionsPage) {\r\n      chrome.runtime.openOptionsPage();\r\n    } else {\r\n      // Fallback: try to open popup\r\n      chrome.action?.openPopup?.() ||\r\n        chrome.browserAction?.openPopup?.() ||\r\n        alert(\r\n          \"Please click the K-Tool icon in the browser toolbar to open settings.\"\r\n        );\r\n    }\r\n  }\r\n\r\n  switchTab(tabName) {\r\n    // Update tab buttons\r\n    const tabs = document.querySelectorAll(\".ktool-tab\");\r\n    tabs.forEach((tab) => {\r\n      tab.classList.toggle(\"active\", tab.dataset.tab === tabName);\r\n    });\r\n\r\n    // Update tab content\r\n    const contents = document.querySelectorAll(\".ktool-tab-content\");\r\n    contents.forEach((content) => {\r\n      content.classList.toggle(\"active\", content.dataset.tab === tabName);\r\n    });\r\n\r\n    this.currentTab = tabName;\r\n  }\r\n\r\n  updateBubbleState() {\r\n    const bubble = document.querySelector(\".ktool-bubble\");\r\n    const tooltip = bubble.querySelector(\".ktool-tooltip\");\r\n\r\n    if (this.settings.isEnabled) {\r\n      bubble.classList.remove(\"disabled\");\r\n      tooltip.innerHTML =\r\n        \"🚀 K-Tool Document Generator<br/>Click to open document generation tool\";\r\n    } else {\r\n      bubble.classList.add(\"disabled\");\r\n      tooltip.innerHTML = \"⚠️ K-Tool is disabled<br/>Please enable in settings\";\r\n    }\r\n  }\r\n\r\n  async handleGenerate() {\r\n    console.log(\"🔄 Starting new document generation...\");\r\n\r\n    // Clear all localStorage to avoid conflicts with previous data\r\n    try {\r\n      const result = await this.storageManager.clearAllKToolData();\r\n      console.log(\r\n        \"🧹 Cleared all previous localStorage data:\",\r\n        result.clearedKeys\r\n      );\r\n\r\n      if (result.failedKeys.length > 0) {\r\n        console.warn(\"⚠️ Some keys failed to clear:\", result.failedKeys);\r\n      }\r\n    } catch (clearError) {\r\n      console.warn(\r\n        \"⚠️ Failed to clear previous localStorage data:\",\r\n        clearError\r\n      );\r\n    }\r\n\r\n    const baDocUrl = document.getElementById(\"baDocUrl\").value.trim();\r\n    const additionalNotes = document\r\n      .getElementById(\"additionalNotes\")\r\n      .value.trim();\r\n\r\n    if (!baDocUrl) {\r\n      this.showNotification(\"Please enter BA document URL!\", \"error\");\r\n      return;\r\n    }\r\n\r\n    // Validate settings\r\n    const validation = StorageManager.validateSettings(this.settings);\r\n    if (!validation.isValid) {\r\n      this.showNotification(\r\n        \"Please configure all settings before generating document!\",\r\n        \"error\"\r\n      );\r\n      this.switchTab(\"settings\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Show progress\r\n      this.showProgress();\r\n      this.updateProgress(0, \"active\");\r\n\r\n      // Step 1: Extract page ID and fetch BA content\r\n      const pageId = ConfluenceApi.extractPageId(baDocUrl);\r\n      if (!pageId) {\r\n        throw new Error(\r\n          \"❌ Invalid URL! Please check the Confluence page URL.\"\r\n        );\r\n      }\r\n\r\n      console.log(\"🔍 Fetching content for pageId:\", pageId);\r\n      const baDocument = await ConfluenceApi.fetchPageContent(pageId);\r\n      if (!baDocument) {\r\n        throw new Error(\"❌ Cannot fetch BA document content!\");\r\n      }\r\n\r\n      // Extract images from BA content (HTML) and convert all to base64\r\n      const images = await ConfluenceApi.extractImagesFromHtml(\r\n        baDocument.content\r\n      );\r\n      console.log(\"🖼️ Extracted images (all base64):\", images);\r\n\r\n      this.updateProgress(0, \"completed\");\r\n      this.updateProgress(1, \"active\");\r\n\r\n      // Step 2: Clone template structure\r\n      if (!this.settings.urlTemplate) {\r\n        throw new Error(\"⚠️ Please configure document template in settings!\");\r\n      }\r\n\r\n      console.log(\"🔄 Cloning template from:\", this.settings.urlTemplate);\r\n      const clonedTemplate = await ConfluenceApi.cloneTemplateForGeneration(\r\n        this.settings.urlTemplate\r\n      );\r\n\r\n      if (!clonedTemplate) {\r\n        throw new Error(\r\n          \"❌ Cannot clone template! Please check template URL in Settings.\"\r\n        );\r\n      }\r\n\r\n      console.log(\"✅ Template cloned successfully:\", clonedTemplate.title);\r\n      this.updateProgress(1, \"completed\");\r\n      this.updateProgress(2, \"active\");\r\n\r\n      // Step 3: Analyze placeholders with << >>\r\n      const placeholders = ConfluenceApi.extractPlaceholders(\r\n        clonedTemplate.originalStorageFormat\r\n      );\r\n      console.log(\"🔍 Found placeholders <<>>:\", placeholders);\r\n\r\n      if (placeholders.length === 0) {\r\n        throw new Error(\r\n          \"⚠️ No placeholders found in format <<Name>>. Please check template!\"\r\n        );\r\n      }\r\n\r\n      this.updateProgress(2, \"completed\");\r\n      this.updateProgress(3, \"active\");\r\n\r\n      // Get instructions if available\r\n      let instructions = \"\";\r\n      if (this.settings.instructionUrl) {\r\n        const instructionPageId = ConfluenceApi.extractPageId(\r\n          this.settings.instructionUrl\r\n        );\r\n        if (instructionPageId) {\r\n          console.log(\r\n            \"🔍 Fetching instruction content for pageId:\",\r\n            instructionPageId\r\n          );\r\n          const instructionDoc = await ConfluenceApi.fetchPageContent(\r\n            instructionPageId\r\n          );\r\n          instructions = instructionDoc?.content || \"\";\r\n        } else {\r\n          console.warn(\r\n            \"⚠️ Invalid instruction URL:\",\r\n            this.settings.instructionUrl\r\n          );\r\n        }\r\n      }\r\n\r\n      // Step 4: AI Fill Placeholders (Send request and get job_id)\r\n      const payload = {\r\n        ba_content: baDocument.content,\r\n        template_structure: clonedTemplate.templateStructure,\r\n        original_storage_format: clonedTemplate.originalStorageFormat,\r\n        instructions: instructions,\r\n        additional_prompt: this.settings.customPrompt || \"\",\r\n        placeholders: placeholders,\r\n        selectedModel: this.settings.selectedModel,\r\n        images,\r\n        additional_notes: additionalNotes,\r\n      };\r\n\r\n      console.log(\"📤 Sending payload for placeholder filling:\", {\r\n        ba_content_length: payload.ba_content.length,\r\n        template_structure_length: payload.template_structure.length,\r\n        original_format_length: payload.original_storage_format.length,\r\n        placeholders_found: placeholders.length,\r\n        placeholders_list: placeholders,\r\n      });\r\n\r\n      // Send request and get job_id\r\n      const jobResponse = await ApiClient.generateDocument(payload);\r\n      const jobId = jobResponse.data.job_id;\r\n      if (!jobId) {\r\n        throw new Error(jobResponse.error || \"No job_id received from server!\");\r\n      }\r\n\r\n      this.currentJobId = jobId;\r\n\r\n      // Start polling for result\r\n      await this.pollGenerationResult(jobId, payload);\r\n    } catch (error) {\r\n      console.error(\"❌ Generation error:\", error);\r\n      this.showNotification(\r\n        `Document generation error: ${error.message}`,\r\n        \"error\"\r\n      );\r\n      this.hideProgress();\r\n    }\r\n  }\r\n\r\n  // These methods are now handled by ConfluenceApi class\r\n  // Keeping them for backward compatibility if needed\r\n\r\n  async pollGenerationResult(jobId, payload) {\r\n    const maxAttempts = 40; // 10 minutes max (60 * 10 seconds)\r\n    let attempts = 0;\r\n\r\n    const poll = async () => {\r\n      attempts++;\r\n\r\n      try {\r\n        console.log(\r\n          `🔄 Polling attempt ${attempts}/${maxAttempts} for job ${jobId}`\r\n        );\r\n\r\n        const statusResult = await ApiClient.checkStatus(jobId);\r\n        console.log(`statusResult: ${statusResult}`);\r\n\r\n        if (!statusResult.success) {\r\n          throw new Error(\"Error checking job status\");\r\n        }\r\n\r\n        const status = statusResult.data.status;\r\n\r\n        if (status === \"done\") {\r\n          console.log(\"✅ Generation completed!\");\r\n\r\n          const result = await ApiClient.getResult(jobId);\r\n          const resultString = JSON.stringify(result, null, 2);\r\n\r\n          console.log(`Document generate:\\n${resultString}`);\r\n          if (result.success) {\r\n            this.handleGenerationComplete(result.data.result);\r\n            return;\r\n          } else {\r\n            throw new Error(\"Error getting document generation result\");\r\n          }\r\n        } else if (status === \"error\") {\r\n          throw new Error(\"Document generation job failed on server\");\r\n        } else if (attempts >= maxAttempts) {\r\n          throw new Error(\r\n            \"⏰ Timeout: Document generation is taking too long. Please try again.\"\r\n          );\r\n        } else {\r\n          // Update progress message if available\r\n          if (statusResult.data.progress_message) {\r\n            console.log(`📝 Progress: ${statusResult.data.progress_message}`);\r\n          }\r\n\r\n          // Continue polling\r\n          setTimeout(poll, 10000); // Poll every 10 seconds\r\n        }\r\n      } catch (error) {\r\n        console.error(\"❌ Polling error:\", error);\r\n        this.showNotification(\r\n          `Error during document generation: ${error.message}`,\r\n          \"error\"\r\n        );\r\n        this.hideProgress();\r\n        this.currentJobId = null;\r\n        throw error;\r\n      }\r\n    };\r\n\r\n    await poll();\r\n  }\r\n\r\n  async handleGenerationComplete(result) {\r\n    this.updateProgress(3, \"completed\");\r\n    this.updateProgress(4, \"completed\");\r\n    const content = XMLFormatter.cleanXMLMarkers(\r\n      result.full_storage_format ?? \"\"\r\n    );\r\n    // Store result for preview\r\n    this.generatedContent = result;\r\n    console.log(\"✅ Generated content:\", result);\r\n\r\n    // 💾 IMPORTANT: Save generated content to localStorage backup\r\n    try {\r\n      this.storageManager.saveToLocalStorage(result);\r\n      console.log(\"💾 Generated content saved to localStorage backup\");\r\n    } catch (error) {\r\n      console.error(\"❌ Failed to save generated content to backup:\", error);\r\n    }\r\n\r\n    // 🎨 IMPORTANT: Process Mermaid diagrams and save mappings for later replacement\r\n    try {\r\n      console.log(\"🎨 Processing Mermaid diagrams in generated content...\");\r\n      await this.initializeMermaidDiagramMappings(result);\r\n    } catch (error) {\r\n      console.error(\"❌ Failed to process Mermaid diagrams:\", error);\r\n    }\r\n\r\n    // Switch to preview tab\r\n    this.switchTab(\"preview\");\r\n    this.updatePreviewTab(result);\r\n\r\n    this.showNotification(\"Document generated successfully!\", \"success\");\r\n    this.hideProgress();\r\n  }\r\n\r\n  updatePreviewTab(content) {\r\n    const previewTab = document.getElementById(\"previewTab\");\r\n    previewTab.innerHTML = `\r\n      <div class=\"ktool-form\">\r\n        <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;\">\r\n          <h3 style=\"margin: 0;\">Document Preview</h3>\r\n          <div style=\"display: flex; gap: 12px;\">\r\n            <button class=\"ktool-btn ktool-btn-secondary\" id=\"editContentBtn\">\r\n              ✏️ Edit Content\r\n            </button>\r\n            <button class=\"ktool-btn ktool-btn-primary\" id=\"createPageBtn\">\r\n              📄 Create Confluence Page\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        <div id=\"documentPreview\" style=\"border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; background: #f8f9fa; max-height: 400px; overflow-y: auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6;\">\r\n          ${content.full_storage_format || \"<p>No content available</p>\"}\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    // Bind preview buttons\r\n    const editContentBtn = previewTab.querySelector(\"#editContentBtn\");\r\n\r\n    editContentBtn.addEventListener(\"click\", () =>\r\n      this.handleEditContent(content)\r\n    );\r\n    createPageBtn.addEventListener(\"click\", () => this.handleCreatePage());\r\n\r\n    // Initialize Mermaid diagrams after content is loaded\r\n    setTimeout(() => {\r\n      this.initializeMermaid();\r\n    }, 100);\r\n  }\r\n  /**\r\n   * Chuẩn hóa chuỗi HTML: Sửa lỗi cú pháp bảng nghiêm ngặt (colgroup)\r\n   * và dọn dẹp các tag/khoảng trắng thừa.\r\n   * * @param {string} htmlString Chuỗi HTML cần chuẩn hóa.\r\n   * @returns {string} Chuỗi HTML đã được làm sạch và sửa lỗi cấu trúc bảng.\r\n   */\r\n  normalizeConfluenceHtml(htmlString) {\r\n    if (!htmlString || typeof htmlString !== \"string\") {\r\n      return \"\";\r\n    }\r\n\r\n    let cleanedHtml = htmlString;\r\n\r\n    // 1. Loại bỏ tất cả các thẻ <colgroup> và nội dung của nó.\r\n    // Bắt đầu từ <colgroup> (có hoặc không có thuộc tính) và kết thúc bằng </colgroup>.\r\n    // [\\s\\S]*? dùng để bắt mọi thứ (kể cả dòng ngắt) không tham lam.\r\n    cleanedHtml = cleanedHtml.replace(\r\n      /<colgroup[^>]*>[\\s\\S]*?<\\/colgroup>/gi,\r\n      \"\"\r\n    );\r\n\r\n    // 2. Loại bỏ dạng thẻ <colgroup/> tự đóng (Self-closing)\r\n    cleanedHtml = cleanedHtml.replace(/<colgroup[^>]*\\/>/gi, \"\");\r\n\r\n    // 3. Loại bỏ thẻ <col> riêng lẻ (dạng tự đóng <col/>) nếu chúng bị sót lại.\r\n    cleanedHtml = cleanedHtml.replace(/<col[^>]*\\/>/gi, \"\");\r\n\r\n    return cleanedHtml.trim();\r\n  }\r\n  async handleCreatePage() {\r\n    const createBtn = document.querySelector(\"#createPageBtn\");\r\n    if (!createBtn) return;\r\n\r\n    // Save original button state\r\n    const originalText = createBtn.innerHTML;\r\n    const originalDisabled = createBtn.disabled;\r\n\r\n    try {\r\n      // Set loading state\r\n      createBtn.innerHTML = \"⏳ Creating Page...\";\r\n      createBtn.disabled = true;\r\n      createBtn.style.opacity = \"0.7\";\r\n\r\n      const spaceKey = ConfluenceApi.getCurrentSpaceKey();\r\n      if (!spaceKey) {\r\n        throw new Error(\"Cannot determine space key of current page\");\r\n      }\r\n\r\n      const title = `K-Tool Generated Document - ${new Date().toLocaleDateString()}`;\r\n      let content =\r\n        this.generatedContent.full_storage_format ||\r\n        this.generatedContent.content;\r\n\r\n      console.log(\"📄 Creating page with content:\", {\r\n        generatedContentLength:\r\n          this.generatedContent?.full_storage_format?.length || 0,\r\n        contentLength: content?.length || 0,\r\n        preview: content?.substring(0, 300) || \"empty\",\r\n      });\r\n\r\n      // Replace Mermaid images with original code before sending to API\r\n      content = await this.replaceMermaidImagesWithOriginalCode(content);\r\n      console.warn(\"Content after replace:\", content?.substring(0, 500));\r\n\r\n      // 🔄 Convert HTML to XHTML using BeautifulSoup API before creating page\r\n      console.log(\r\n        \"🔄 Converting HTML to XHTML before creating Confluence page...\"\r\n      );\r\n      createBtn.innerHTML = \"🔄 Converting to XHTML...\";\r\n      content = this.normalizeConfluenceHtml(content);\r\n      // Extract parent page ID from settings if available\r\n      let parentId = null;\r\n      if (this.settings.documentUrl) {\r\n        parentId = ConfluenceApi.extractPageId(this.settings.documentUrl);\r\n      }\r\n\r\n      createBtn.innerHTML = \"📄 Creating Confluence Page...\";\r\n      await ConfluenceApi.createPage(title, content, spaceKey, parentId);\r\n\r\n      // Success state\r\n      createBtn.innerHTML = \"✅ Page Created Successfully!\";\r\n      createBtn.style.background = \"#28a745\";\r\n\r\n      this.showNotification(\"Confluence page created successfully!\", \"success\");\r\n\r\n      // Delay 1s before restore button\r\n      setTimeout(() => {\r\n        // Restore button state\r\n        createBtn.innerHTML = originalText;\r\n        createBtn.disabled = originalDisabled;\r\n        createBtn.style.opacity = \"1\";\r\n        createBtn.style.background = \"\";\r\n      }, 1000);\r\n    } catch (error) {\r\n      console.error(\"❌ Create page error:\", error);\r\n\r\n      // Error state\r\n      createBtn.innerHTML = \"❌ Creation Failed\";\r\n      createBtn.style.background = \"#dc3545\";\r\n\r\n      this.showNotification(`Error creating page: ${error.message}`, \"error\");\r\n\r\n      // Restore button after 2s\r\n      setTimeout(() => {\r\n        createBtn.innerHTML = originalText;\r\n        createBtn.disabled = originalDisabled;\r\n        createBtn.style.opacity = \"1\";\r\n        createBtn.style.background = \"\";\r\n      }, 2000);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize Mermaid diagram mappings from generated content\r\n   * @param {Object} generatedContent - Generated content object\r\n   */\r\n  async initializeMermaidDiagramMappings(generatedContent) {\r\n    try {\r\n      console.log(\"🎨 Initializing Mermaid diagram mappings...\");\r\n\r\n      const content =\r\n        generatedContent.full_storage_format || generatedContent.content || \"\";\r\n      if (!content) {\r\n        console.log(\"ℹ️ No content to process\");\r\n        return;\r\n      }\r\n\r\n      console.log(\"🔍 Content to process:\", {\r\n        length: content.length,\r\n        preview: content.substring(0, 1000),\r\n        hasMermaidKeyword: content.includes(\"mermaid\"),\r\n        hasAcMacro: content.includes('ac:name=\"mermaid'),\r\n        hasCodeBlock: content.includes(\"```mermaid\"),\r\n        hasStructuredMacro: content.includes(\"<ac:structured-macro\"),\r\n        mermaidOccurrences: (content.match(/mermaid/gi) || []).length,\r\n      });\r\n\r\n      // Also log a larger sample if content is long\r\n      if (content.length > 1000) {\r\n        console.log(\"🔍 Extended content preview:\", content.substring(0, 2000));\r\n      }\r\n\r\n      console.log(\"✅ Using imported MermaidRenderer, extracting diagrams...\");\r\n\r\n      // Use imported MermaidRenderer to extract diagrams\r\n      const { diagrams } = MermaidRenderer.extractMermaidDiagrams(content);\r\n      console.warn(\"🔍 Extracted diagrams:\", diagrams);\r\n      console.log(\"📊 Diagrams details:\", {\r\n        count: diagrams?.length || 0,\r\n        diagrams: diagrams?.map((d) => ({\r\n          id: d.id,\r\n          type: d.type,\r\n          codeLength: d.code?.length || 0,\r\n          originalMatchLength: d.originalMatch?.length || 0,\r\n        })),\r\n      });\r\n      if (diagrams.length === 0) {\r\n        console.log(\"ℹ️ No Mermaid diagrams found in generated content\");\r\n        // Initialize empty mappings\r\n        this.storageManager.saveMermaidDiagramMappings(new Map());\r\n        return;\r\n      }\r\n\r\n      console.log(\r\n        `📊 Found ${diagrams.length} Mermaid diagrams in generated content`\r\n      );\r\n\r\n      // Create diagram mappings Map for saveMermaidDiagramMappings\r\n      const diagramMappings = new Map();\r\n\r\n      for (const diagram of diagrams) {\r\n        diagramMappings.set(diagram.id, {\r\n          title: `Diagram ${diagram.id}`,\r\n          type: diagram.type,\r\n          content: diagram.code, // Just the mermaid code\r\n          originCode: diagram.originalMatch, // The full macro/code block for replacement\r\n          timestamp: Date.now(),\r\n        });\r\n\r\n        console.log(`📋 Created mapping for diagram ${diagram.id}:`, {\r\n          codeLength: diagram.code.length,\r\n          originalLength: diagram.originalMatch.length,\r\n        });\r\n      }\r\n\r\n      // Save mappings using existing method\r\n      const saveSuccess =\r\n        this.storageManager.saveMermaidDiagramMappings(diagramMappings);\r\n      if (saveSuccess) {\r\n        console.log(\r\n          `💾 Successfully saved ${diagramMappings.size} diagram mappings`\r\n        );\r\n      } else {\r\n        console.warn(\"⚠️ Failed to save diagram mappings\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"❌ Error initializing Mermaid diagram mappings:\", error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Replace Mermaid images with original code before sending to Confluence API\r\n   * @param {string} content - Content with Mermaid images\r\n   * @returns {Promise<string>} Content with original Mermaid macros\r\n   */\r\n  async replaceMermaidImagesWithOriginalCode(content) {\r\n    try {\r\n      console.log(\"🔄 Replacing Mermaid images with original code...\");\r\n\r\n      // Get diagram mappings from storage\r\n      const diagramMappings = await this.storageManager.getItem(\r\n        this.storageManager.constructor.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS\r\n      );\r\n\r\n      if (!diagramMappings || Object.keys(diagramMappings).length === 0) {\r\n        console.log(\r\n          \"ℹ️ No diagram mappings found in storage, returning content as-is\"\r\n        );\r\n        return content;\r\n      }\r\n\r\n      console.log(\r\n        `📊 Found ${\r\n          Object.keys(diagramMappings).length\r\n        } diagram mappings in storage`\r\n      );\r\n\r\n      let processedContent = content;\r\n      let replacementCount = 0;\r\n\r\n      // Replace each image with its original code using string replacement\r\n      for (const [diagramId, mapping] of Object.entries(diagramMappings)) {\r\n        console.log(`🔄 Processing diagram ${diagramId}`);\r\n        console.log(\"📋 Mapping data:\", {\r\n          hasOriginCode: !!mapping.originCode,\r\n          hasOriginalCode: !!mapping.originalCode,\r\n          hasContent: !!mapping.content,\r\n          originCodeLength: mapping.originCode?.length || 0,\r\n          originalCodeLength: mapping.originalCode?.length || 0,\r\n          contentLength: mapping.content?.length || 0,\r\n        });\r\n\r\n        // Use originCode first, then fallback to originalCode\r\n        const replacementCode =\r\n          mapping.originCode || mapping.originalCode || mapping.content;\r\n        console.log(\r\n          \"🔄 Using replacement code:\",\r\n          replacementCode?.substring(0, 100)\r\n        );\r\n\r\n        // Create regex patterns to find img tags with this diagram ID\r\n        const imgPatterns = [\r\n          // Pattern for id attribute\r\n          new RegExp(`<img[^>]*\\\\sid=\"${diagramId}\"[^>]*>`, \"gi\"),\r\n          // Pattern for data-mermaid-id attribute\r\n          new RegExp(`<img[^>]*\\\\sdata-mermaid-id=\"${diagramId}\"[^>]*>`, \"gi\"),\r\n          // Pattern for both attributes (more flexible)\r\n          new RegExp(\r\n            `<img[^>]*(?:id=\"${diagramId}\"|data-mermaid-id=\"${diagramId}\")[^>]*>`,\r\n            \"gi\"\r\n          ),\r\n        ];\r\n\r\n        let foundMatch = false;\r\n\r\n        // Try each pattern\r\n        for (const pattern of imgPatterns) {\r\n          const matches = processedContent.match(pattern);\r\n          if (matches && matches.length > 0) {\r\n            console.log(\r\n              `🔍 Found ${matches.length} image(s) for diagram ${diagramId} with pattern`\r\n            );\r\n\r\n            // Replace all matches with original content\r\n            processedContent = processedContent.replace(\r\n              pattern,\r\n              replacementCode\r\n            );\r\n            replacementCount += matches.length;\r\n            foundMatch = true;\r\n\r\n            console.log(\r\n              `✅ Replaced ${matches.length} image(s) for diagram ${diagramId} with original Mermaid code`\r\n            );\r\n            break; // Stop after first successful pattern\r\n          }\r\n        }\r\n\r\n        if (!foundMatch) {\r\n          console.log(`ℹ️ No images found for diagram ${diagramId}`);\r\n        }\r\n      }\r\n\r\n      console.log(\r\n        `🎨 Completed Mermaid image replacement: ${replacementCount} images replaced`\r\n      );\r\n\r\n      // Clean up storage after successful replacement\r\n      // try {\r\n      //   await this.storageManager.removeItem(\r\n      //     this.storageManager.constructor.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS\r\n      //   );\r\n      //   console.log(\"🧹 Cleaned up diagram mappings from storage\");\r\n      // } catch (cleanupError) {\r\n      //   console.warn(\"⚠️ Failed to clean up diagram mappings:\", cleanupError);\r\n      // }\r\n\r\n      return processedContent;\r\n    } catch (error) {\r\n      console.error(\"❌ Error replacing Mermaid images:\", error);\r\n      // Return original content if replacement fails\r\n      return content;\r\n    }\r\n  }\r\n\r\n  handleEditContent(content) {\r\n    console.log(\"✏️ Opening content editor...\");\r\n    console.log(\"🔍 Content to edit:\", content);\r\n    console.log(\"🔍 ConfluenceEditor instance:\", this.confluenceEditor);\r\n\r\n    if (!this.confluenceEditor) {\r\n      console.error(\"❌ ConfluenceEditor is null or undefined\");\r\n      this.showNotification(\"Confluence Editor not initialized!\", \"error\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Set up save callback to update the generated content\r\n      this.confluenceEditor.setSaveCallback((updatedContent) => {\r\n        console.log(\"💾 Save callback received content:\", {\r\n          length: updatedContent?.full_storage_format?.length || 0,\r\n          preview:\r\n            updatedContent?.full_storage_format?.substring(0, 200) || \"empty\",\r\n          hasContent: !!updatedContent?.full_storage_format,\r\n        });\r\n\r\n        // Update the stored generated content\r\n        this.generatedContent = updatedContent;\r\n\r\n        console.log(\"💾 Updated this.generatedContent:\", {\r\n          length: this.generatedContent?.full_storage_format?.length || 0,\r\n          preview:\r\n            this.generatedContent?.full_storage_format?.substring(0, 200) ||\r\n            \"empty\",\r\n        });\r\n\r\n        // Refresh the preview tab with updated content\r\n        this.updatePreviewTab(updatedContent);\r\n\r\n        this.showNotification(\"Content has been updated!\", \"success\");\r\n      });\r\n\r\n      // Open the editor with current content\r\n      console.log(\"🚀 Opening ConfluenceEditor...\");\r\n      this.confluenceEditor.openEditor(content, {\r\n        title: \"Edit Generated Document\",\r\n        showMermaidTools: true,\r\n      });\r\n      console.log(\"✅ ConfluenceEditor opened successfully\");\r\n    } catch (error) {\r\n      console.error(\"❌ Error opening ConfluenceEditor:\", error);\r\n      this.showNotification(`Error opening editor: ${error.message}`, \"error\");\r\n    }\r\n  }\r\n\r\n  handleReset() {\r\n    // Auto reset form without confirm\r\n    console.log(\"🔄 Auto-resetting form...\");\r\n    document.getElementById(\"baDocUrl\").value = window.location.href;\r\n    document.getElementById(\"additionalNotes\").value = \"\";\r\n    this.hideProgress();\r\n    this.switchTab(\"generate\");\r\n  }\r\n\r\n  showProgress() {\r\n    const progressSection = document.getElementById(\"progressSection\");\r\n    const progressSteps = document.getElementById(\"progressSteps\");\r\n\r\n    progressSteps.innerHTML = this.progressSteps\r\n      .map(\r\n        (step, index) => `\r\n      <div class=\"ktool-progress-step ${step.status}\" data-step=\"${index}\">\r\n        <div class=\"ktool-progress-icon\">${index + 1}</div>\r\n        <span>${step.label}</span>\r\n      </div>\r\n    `\r\n      )\r\n      .join(\"\");\r\n\r\n    progressSection.style.display = \"block\";\r\n  }\r\n\r\n  hideProgress() {\r\n    const progressSection = document.getElementById(\"progressSection\");\r\n    progressSection.style.display = \"none\";\r\n\r\n    // Reset progress steps\r\n    this.progressSteps = this.progressSteps.map((step) => ({\r\n      ...step,\r\n      status: \"pending\",\r\n    }));\r\n  }\r\n\r\n  updateProgress(stepIndex, status) {\r\n    this.progressSteps[stepIndex].status = status;\r\n\r\n    const stepElement = document.querySelector(`[data-step=\"${stepIndex}\"]`);\r\n    if (stepElement) {\r\n      stepElement.className = `ktool-progress-step ${status}`;\r\n\r\n      const icon = stepElement.querySelector(\".ktool-progress-icon\");\r\n      if (status === \"completed\") {\r\n        icon.textContent = \"✓\";\r\n      } else if (status === \"error\") {\r\n        icon.textContent = \"✗\";\r\n      } else if (status === \"active\") {\r\n        icon.innerHTML = '<div class=\"ktool-spinning\">⏳</div>';\r\n      }\r\n    }\r\n  }\r\n\r\n  showNotification(message, type = \"info\") {\r\n    // Create notification element\r\n    const notification = document.createElement(\"div\");\r\n    notification.style.cssText = `\r\n      position: fixed;\r\n      top: 20px;\r\n      right: 20px;\r\n      background: ${\r\n        type === \"success\"\r\n          ? \"#28a745\"\r\n          : type === \"error\"\r\n          ? \"#dc3545\"\r\n          : \"#007bff\"\r\n      };\r\n      color: white;\r\n      padding: 12px 20px;\r\n      border-radius: 8px;\r\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);\r\n      z-index: 1000002;\r\n      font-size: 14px;\r\n      max-width: 300px;\r\n      word-wrap: break-word;\r\n      opacity: 0;\r\n      transform: translateX(100%);\r\n      transition: all 0.3s;\r\n    `;\r\n\r\n    notification.textContent = message;\r\n    document.body.appendChild(notification);\r\n\r\n    // Animate in\r\n    setTimeout(() => {\r\n      notification.style.opacity = \"1\";\r\n      notification.style.transform = \"translateX(0)\";\r\n    }, 100);\r\n\r\n    // Auto remove\r\n    setTimeout(() => {\r\n      notification.style.opacity = \"0\";\r\n      notification.style.transform = \"translateX(100%)\";\r\n      setTimeout(() => {\r\n        if (notification.parentNode) {\r\n          notification.parentNode.removeChild(notification);\r\n        }\r\n      }, 300);\r\n    }, 5000);\r\n  }\r\n\r\n  // Initialize Mermaid diagrams\r\n  async initializeMermaid() {\r\n    try {\r\n      console.log(\"🎨 Initializing Mermaid diagrams...\");\r\n\r\n      // Find all mermaid code blocks in the preview\r\n      const previewDiv = document.getElementById(\"documentPreview\");\r\n      if (!previewDiv) return;\r\n\r\n      // Look for Confluence Mermaid structured macros\r\n      const mermaidElements = previewDiv.querySelectorAll(\r\n        'ac\\\\:structured-macro[ac\\\\:name=\"mermaid\"]'\r\n      );\r\n\r\n      for (let index = 0; index < mermaidElements.length; index++) {\r\n        const element = mermaidElements[index];\r\n        // Get the code parameter from Confluence structured macro\r\n        const codeParam = element.querySelector(\r\n          'ac\\\\:parameter[ac\\\\:name=\"code\"]'\r\n        );\r\n        if (!codeParam) {\r\n          console.warn(\"⚠️ Mermaid macro found but no code parameter\");\r\n          return;\r\n        }\r\n\r\n        const mermaidCode = (\r\n          codeParam.textContent || codeParam.innerText\r\n        ).trim();\r\n        console.log(\r\n          \"🔍 Found Confluence Mermaid diagram:\",\r\n          mermaidCode.substring(0, 50) + \"...\"\r\n        );\r\n\r\n        // Always process Confluence mermaid macros (no need to check syntax)\r\n        if (mermaidCode) {\r\n          // Create a new div for the mermaid diagram\r\n          const mermaidDiv = document.createElement(\"div\");\r\n          mermaidDiv.className = \"mermaid-diagram\";\r\n          mermaidDiv.id = `mermaid-${index}`;\r\n          mermaidDiv.style.cssText =\r\n            \"margin: 20px 0; text-align: center; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;\";\r\n\r\n          // Validate parent node before replacing\r\n          if (!element.parentNode) {\r\n            console.error(\"❌ Cannot replace Mermaid element: no parent node\");\r\n            console.error(\r\n              \"❌ Mermaid code:\",\r\n              mermaidCode.substring(0, 100) + \"...\"\r\n            );\r\n            return;\r\n          }\r\n\r\n          // Replace the original element\r\n          try {\r\n            element.parentNode.replaceChild(mermaidDiv, element);\r\n          } catch (replaceError) {\r\n            console.error(\r\n              \"❌ Failed to replace Mermaid element:\",\r\n              replaceError\r\n            );\r\n            console.error(\r\n              \"❌ Mermaid code:\",\r\n              mermaidCode.substring(0, 100) + \"...\"\r\n            );\r\n            return;\r\n          }\r\n\r\n          // Initialize Mermaid and render the diagram using MermaidRenderer\r\n          await MermaidRenderer.initializeMermaid();\r\n          const diagramId = `mermaid-svg-${index}`;\r\n          await MermaidRenderer.renderDiagram(\r\n            diagramId,\r\n            mermaidCode,\r\n            mermaidDiv\r\n          );\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"❌ Failed to initialize Mermaid:\", error);\r\n    }\r\n  }\r\n\r\n  // Show Mermaid error in a nice format\r\n  showMermaidError(container, text, error) {\r\n    // Validate container before attempting to set innerHTML\r\n    if (\r\n      !container ||\r\n      !container.nodeType ||\r\n      container.nodeType !== Node.ELEMENT_NODE\r\n    ) {\r\n      console.error(\r\n        \"❌ Invalid container for Mermaid error display:\",\r\n        container\r\n      );\r\n      console.error(\"❌ Mermaid error details:\", {\r\n        message: error.message || \"Unknown error occurred\",\r\n        code: text ? text.substring(0, 100) + \"...\" : \"No code provided\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Check if container is still in the DOM\r\n    if (!document.contains(container)) {\r\n      console.error(\"❌ Container is not in DOM, cannot display Mermaid error\");\r\n      console.error(\"❌ Mermaid error details:\", {\r\n        message: error.message || \"Unknown error occurred\",\r\n        code: text ? text.substring(0, 100) + \"...\" : \"No code provided\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    try {\r\n      container.innerHTML = `\r\n        <div style=\"color: #dc3545; padding: 15px; background: #f8d7da; border-radius: 8px; border: 1px solid #f5c6cb; font-family: Arial, sans-serif;\">\r\n          <div style=\"font-weight: bold; margin-bottom: 8px; display: flex; align-items: center;\">\r\n            <span style=\"margin-right: 8px;\">⚠️</span>\r\n            Mermaid Render Error\r\n          </div>\r\n          <div style=\"font-size: 12px; color: #721c24; margin-bottom: 10px;\">\r\n            ${error.message || \"Unknown error occurred\"}\r\n          </div>\r\n          <details style=\"margin-top: 10px;\">\r\n            <summary style=\"cursor: pointer; font-size: 12px; color: #495057;\">Show diagram code</summary>\r\n            <pre style=\"margin: 8px 0 0 0; padding: 8px; background: #fff; border: 1px solid #dee2e6; border-radius: 4px; font-size: 11px; overflow-x: auto; white-space: pre-wrap;\">${\r\n              text || \"No code provided\"\r\n            }</pre>\r\n          </details>\r\n        </div>\r\n      `;\r\n    } catch (setInnerHTMLError) {\r\n      console.error(\r\n        \"❌ Failed to set error HTML in container:\",\r\n        setInnerHTMLError\r\n      );\r\n      console.error(\"❌ Original Mermaid error:\", {\r\n        message: error.message || \"Unknown error occurred\",\r\n        code: text ? text.substring(0, 100) + \"...\" : \"No code provided\",\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\n// Initialize when DOM is ready\r\nif (document.readyState === \"loading\") {\r\n  document.addEventListener(\"DOMContentLoaded\", () => {\r\n    new KToolContent();\r\n  });\r\n} else {\r\n  new KToolContent();\r\n}\r\n"],"names":["MermaidRenderer","loadMermaidScript","window","mermaid","console","log","res","fetch","chrome","runtime","getURL","text","eval","initializeMermaid","this","initialize","startOnLoad","theme","securityLevel","fontFamily","htmlLabels","flowchart","deterministicIds","deterministicIDSeed","setConfig","renderDiagram","diagramId","mermaidCode","container","cleanCode","cleanMermaidCode","validateMermaidCode","Error","nodeType","Node","ELEMENT_NODE","render","tempContainer","document","createElement","style","position","left","top","visibility","body","appendChild","svgCode","renderResult","svg","innerHTML","renderError","error","showMermaidError","parentNode","remove","message","code","substring","contains","setInnerHTMLError","detectMermaidType","firstLine","trim","split","toLowerCase","includes","extractMermaidDiagrams","content","diagrams","diagramsMap","Map","macroRegex","match","index","exec","macroName","macroContent","codeMatch","langMatch","type","diagramRecord","id","originalCode","originalMatch","title","charAt","toUpperCase","slice","push","set","originCode","cleaned","replace","trimmed","some","starter","startsWith","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","exports","module","__webpack_modules__","d","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","EXTENSION_SETTINGS_KEY","isLocal","location","hostname","rootUrl","confluenceBaseUrl","API_URLS","GEN_DOC","GEN_DOC_STATUS","GEN_DOC_RESULT","EDIT_DIAGRAM","EDIT_MERMAID","EDIT_TEXT","EDIT_HTML_CONTENT","CONVERT_HTML_TO_XHTML","CONFLUENCE_API_URLS","MERMAID_DIAGRAM","MERMAID_SAVE","MERMAID_UPDATE","MERMAID_EDIT_REFERER","TINYMCE_PLACEHOLDER","DEFAULT_SETTINGS","apiKey","urlTemplate","customPrompt","documentUrl","databaseUrl","instructionUrl","isEnabled","selectedModel","AI_MODELS","name","provider","description","gemini","PROGRESS_STEPS","label","status","VALIDATION","URL_PATTERN","PLACEHOLDER_PATTERN","MIN_PROMPT_LENGTH","getDiagramConfluenceStyles","storage","macroCounter","extractedDiagrams","mermaidRegex","filename","macroId","toString","diagramCode","async","mermaidAPI","convertDiagramToSvgPng","diagram","svgResult","svgContent","canvas","ctx","getContext","img","Image","Promise","resolve","reject","onload","width","height","fillStyle","fillRect","drawImage","png","toDataURL","onerror","src","btoa","unescape","encodeURIComponent","saveDiagramToAPI","pageId","payload","data","response","method","headers","Accept","JSON","stringify","ok","errorText","processAndSaveDiagrams","length","success","total","errors","successCount","totalDiagrams","processedDiagrams","all","map","i","errorMsg","setTimeout","result","warn","ApiClient","request","url","options","statusText","json","generateDocument","checkStatus","jobId","getResult","editText","convertHtmlToXhtml","htmlContent","stack","ConfluenceApi","extractPageId","patterns","pattern","getCurrentSpaceKey","spaceKeyMeta","querySelector","spaceKeyElement","dataset","spaceKey","urlMatch","pathname","fetchPageContent","_data$body","_data$body2","_data$body3","_data$body4","apiUrl","hasStorage","value","hasView","view","storageFormat","cloneTemplateForGeneration","_data$body5","_data$body6","extractPageIdFromUrl","originalStorageFormat","templateStructure","analysisInfo","extractTemplateStructure","originalLength","structureLength","analysis","emptyParagraphs","emptyTableCells","placeholders","structure","forEach","regex","matches","matchAll","totalLength","extractPlaceholders","decodedContent","allMatches","testContent","contentIndex","patternIndex","m","uniquePlaceholders","Set","extractImagesFromHtml","html","images","imgTags","DOMParser","parseFromString","querySelectorAll","Array","from","getAttribute","base64src","Date","now","base64","fname","urlToBase64","alt","e","getFilenameFromUrl","blob","reader","FileReader","onloadend","readAsDataURL","URL","lastIndexOf","validateAndCleanTitle","toLocaleDateString","ensureUtf8Encoding","encoder","TextEncoder","decoder","TextDecoder","fatal","encoded","encode","decode","basicContentCleanup","advancedHTMLSanitization","finalHTML","tagName","convertToMermaidCloudMacros","convertedContent","currentId","validateAndFixXML","fixed","attrs","createPage","fullStorageFormat","parentPageId","_result$_links","_result$_links2","cleanTitle","utf8Content","processedContent","finalContent","createPayload","space","representation","ancestors","errorMessage","errorJson","parse","isArray","err","field","join","parseError","_links","webui","finalMessage","diagramResult","fullUrl","origin","open","userMessage","XMLFormatter","formatXHTML","xmlString","indent","hasUL","hasOL","hasLI","preview","rootTag","wrappedXml","doc","parseErrors","getElementsByTagName","_parseErrors$","textContent","sample","output","rootElement","documentElement","processNode","node","level","nodeName","startTag","attributes","attr","childNodes","child","TEXT_NODE","nextLevel","COMMENT_NODE","CDATA_SECTION_NODE","whitespaceCount","isSelfClosingTag","tag","t","cleanXMLMarkers","convertXHTMLToHTML","xhtmlContent","cleanDataAttributes","cleanedDataAttrs","formatForLiveEditor","formatted","processMermaidToImages","hasImages","mermaidCount","imgTag","cleanedLength","removedChars","escapeRegex","string","ContentSynchronizer","constructor","diagramChanges","trackDiagramChange","newCode","timestamp","getTrackedChanges","clearTrackedChanges","clear","syncAllContent","currentContent","editorContainer","mermaidDiagrams","rawContent","syncFromRawEditor","syncMermaidChanges","rawEditor","updatedContent","full_storage_format","diagramsCount","hasContent","_diagram$originalCode","_diagram$code","hasOriginalCode","hasCode","codeLength","updateDiagramInContent","hasNewCode","newLength","RegExp","replacement","patternMatched","lastIndex","test","simpleSearch","validateContent","isValid","warnings","xmlContent","createBackup","restoreFromBackup","backup","DOMHelpers","selector","addEventListener","element","event","handler","removeEventListener","toggleClass","className","force","classList","toggle","addClass","add","removeClass","setContent","isHTML","getContent","entries","assign","setAttribute","removeElement","removeChild","isInDOM","scrollIntoView","behavior","block","getDimensions","rect","getBoundingClientRect","right","bottom","cloneElement","deep","cloneNode","HTMLTemplates","getEditorTemplate","getContentTabTemplate","getLiveEditTabTemplate","getRichTextTabTemplate","getMermaidTabTemplate","getZoomControlsTemplate","getAIChatTemplate","applyPreviewStyles","createAIMessage","createMermaidContainer","mermaidDiv","cssText","StorageManager","static","CONFLUENCE_CONTENT_BACKUP","MERMAID_DIAGRAM_MAPPINGS","MERMAID_AI_FILENAME","MERMAID_DIAGRAM_INFO","CONFLUENCE_EDITOR_BACKUP","STORAGE_KEY","STORAGE_KEYS","AUTO_SAVE_INTERVAL","autoSaveTimer","getSettings","sync","saveSettings","settings","updateSetting","updatedSettings","resetSettings","validateSettings","_settings$apiKey","_settings$urlTemplate","_settings$documentUrl","_settings$databaseUrl","validationResult","validateConfluencePageLink","valid","isValidUrl","keys","getSettingKeys","hasSettings","getSetting","exportSettings","importSettings","jsonString","validation","clearAllChromeStorage","local","link","out","u","pageIdParam","searchParams","pathParts","pagesIndex","indexOf","candidate","saveContent","saveCallback","enableLocalStorage","enableCallback","showNotification","results","localStorage","callback","saveToLocalStorage","callSaveCallback","showSaveNotification","backupData","version","setItem","loadFromLocalStorage","saved","getItem","removeItem","clearLocalStorage","then","notification","colors","warning","info","background","opacity","transform","startAutoSave","saveFunction","stopAutoSave","setInterval","clearInterval","hasUnsavedChanges","getBackupInfo","age","item","saveMermaidDiagramMappings","size","mappingsObject","diagramData","getMermaidDiagramMappings","stored","clearAllKToolData","keysToRemove","values","clearedKeys","failedKeys","LiveTextEditor","quill","isInitialized","originalOptions","init","loadQuill","createEditorContainer","initializeQuill","setupEventListeners","Quill","waitForQuill","getBasicOptions","modules","table","toolbar","header","font","color","script","list","align","formats","waited","ensureContainerDimensions","editorElement","containerStyle","computedStyle","getComputedStyle","minHeight","offsetHeight","offsetWidth","computedWidth","computedHeight","editorDiv","registerQuillPlugins","focus","registerCustomFormats","Inline","import","Block","Container","ULFormat","create","super","blotName","OLFormat","LIFormat","StrongFormat","register","addTableSupport","quillBetterTable","addTableButton","getModule","tableButton","tableModule","insertTable","range","getSelection","tableHTML","clipboard","dangerouslyPasteHTML","insertError","toolbarContainer","lastGroup","on","delta","oldDelta","source","onTextChange","oldRange","onSelectionChange","ops","CustomEvent","detail","getHTML","getText","getContents","changeDelta","dispatchEvent","root","getQuill","setHTML","setText","pasteError","isReady","destroy","off","ConfluenceEditor","isEditorOpen","originalContent","onSave","mermaidDiagramsMap","currentSelectedDiagram","currentSelectedDiagramId","textEditor","richTextEditor","liveTextEditor","tipTapEditor","previewContainer","isPreviewMode","isModified","currentZoom","dragOffset","x","y","isZooming","zoomStep","minZoom","maxZoom","previewUpdateTimeout","isUpdatingPreview","storageManager","contentSynchronizer","openEditor","closeEditor","_backup$full_storage_","allowBackupRestore","createEditorUI","initializeContentTab","overlay","bindEditorEvents","closeBtn","saveBtn","saveChanges","contentTab","liveEditTab","richTextTab","mermaidTab","switchTab","updateContentPreview","mermaidSelector","mermaidCodeEditor","aiSendBtn","aiPromptInput","selectMermaidDiagram","target","debouncedUpdateMermaidPreview","sendAIPrompt","shiftKey","preventDefault","zoomInBtn","zoomOutBtn","zoomResetBtn","zoomIn","zoomOut","resetZoom","mermaidPreview","handleWheel","handleEsc","tabName","tab","activeTab","activeContent","initializeMermaidTab","initializeLiveEditTab","initializeRichTextTab","richTextContainer","backupContent","display","setupRichTextEditorEvents","setupToggleRawView","toggleBtn","getCurrentEditorContent","fallbackEditor","liveEditEditorContainer","waitForLiveTextEditor","processMermaidInContentSync","normalizeHtmlString","setupLiveEditEventListeners","createFallbackTextEditor","richTextEditorContainer","TipTapEditor","placeholder","waitForTipTapEditor","currentEditorContent","setupRichTextEventListeners","createFallbackRichTextEditor","textarea","setupRichTextFallbackEventListeners","syncRichTextToRawEditor","setupFallbackEventListeners","debouncedUpdate","debounce","_this$currentContent$","oldLength","contentChanged","storedDiagrams","storedData","has","populateMermaidSelector","updateLiveEditPreview","liveEditPreview","processLiveEditContent","renderMermaidInLivePreview","mermaidBlocks","isMermaidDiagram","mermaidContainer","replaceChild","errorDiv","keyword","formatLiveEditContent","syncLiveEditWithRawContent","toggleLiveEditFullscreen","func","wait","timeout","args","clearTimeout","later","updateSaveButtonState","renderContentPreview","previewElement","renderMermaidDiagramsInPreview","initializeMermaidInPreview","previewDiv","codeParam","replaceError","_this$mermaidDiagrams","_this$mermaidDiagrams2","defaultOption","diagramsToUse","addedCount","addedDiagrams","option","handleMermaidSelectorChange","selectedId","clearMermaidEditor","find","codeEditor","updateMermaidPreview","catch","handleMermaidCodeChange","currentDiagramData","updateZoom","_this$currentSelected","promptInput","messagesContainer","prompt","addAIMessage","diagramInMap","currentCode","_this$currentContent","requestBody","diagram_code","user_request","errorData","edited_diagram","cleanedDiagram","cleanAIResponse","_this$currentSelected2","currentDiagramInMap","oldCode","removeLastAIMessage","lines","nonEmptyStart","findIndex","line","nonEmptyEnd","reverse","validStarts","start","messages","lastMessage","messageHTML","scrollTop","scrollHeight","_this$currentContent2","_this$currentContent3","_this$currentContent4","hasCurrentContent","hasFullStorageFormat","contentLength","contentPreview","hasMermaidKeyword","diagramsMapSize","diagramTitles","updateStatus","_this$editorContainer","toLocaleTimeString","_this$currentContent$6","_this$currentContent$7","_this$currentContent$2","_this$currentContent$3","_this$currentContent$4","_this$currentContent$5","hasEditorContent","saveResults","stopAllPreviewUpdates","Math","min","applyZoom","max","zoomLevel","mermaidContent","transformOrigin","transition","round","deltaY","_this$currentContent5","hasOriginalContent","currentContentLength","setSaveCallback","isOpen","cleanedHtml","diagramMappings","imageBase64","generateMermaidImage","imageHtml","imageId","placeholderImg","_","p1","String","fromCharCode","parseInt","getCurrentContent","editorContent","getValue","MermaidPreview","getElementById","updatePreview","showError","showPlaceholder","validStarters","MermaidAIService","apiClient","modifyDiagram","diagramContent","userPrompt","promptValidation","validateUserPrompt","diagramValidation","validateDiagramContent","getCurrentPageContent","newMermaidCode","getFallbackContent","pageData","URLSearchParams","search","pathMatches","href","metaSelectors","metaTag","AJS","params","contentSelectors","callAI","getMockResponse","originalDiagram","diagram_content","user_prompt","explanation","getErrorMessage","MermaidApiClient","Confluence","getContentId","contentId","bodyPageId","extractFilename","filenameWithExt","saveFilename","getSavedFilename","fetchMermaidCode","Connection","Pragma","Referer","navigator","userAgent","credentials","fetchMermaidCodeFromSaved","MermaidAIChat","$","jQuery","isPopupOpen","currentMermaidContent","aiService","lastClickedElement","lastClickPosition","createPopupUI","setupMermaidDetection","setupConfluencePageChangeDetection","setupConfluenceEditorMonitoring","handleMermaidClick","showChatPopup","setupIframeEventListeners","setupMutationObserver","refreshIframeListeners","iframes","readyState","retryIframes","iframe","attachIframeListeners","mermaidListenerAttached","loadHandler","iframeDoc","contentDocument","contentWindow","clickHandler","classes","isMermaidElement","macroParams","diagramInfo","macroParameters","parseMacroParameters","parsedParams","clientX","offsetLeft","clientY","offsetTop","mermaidClickHandler","boundClickHandler","bind","mermaidLoadHandler","MutationObserver","mutations","mutation","mutationIndex","addedNodes","nodeIndex","_node$textContent","injectAIButton","_node$textContent2","observe","childList","subtree","currentUrl","checkUrlChange","panel","buttonContainer","aiButton","marginRight","loadingMessage","alert","removeButton","insertBefore","removeAIButton","removedNodes","pair","check","bindZoomControls","ctrlKey","zoomDisplay","updateZoomButtonStates","disabled","bindPopupEvents","popup","sendBtn","input","makeDraggable","hideChatPopup","sendMessage","saveDiagram","closest","dragHandle","isDragging","dragStartX","dragStartY","popupStartX","popupStartY","cursor","userSelect","onDrag","stopPropagation","deltaX","newX","newY","maxX","innerWidth","maxY","innerHeight","stopDrag","mouseX","mouseY","popupX","popupY","leftPos","topPos","systemMessage","_diagramInfo$parsedPa","diagramInfoStr","updateData","updateMermaidDiagram","reversionNew","revision","newImageHtml","generatePlaceholderImage","replaceImageInDOM","generateMermaidAssets","currentRevision","dataLength","svgLength","pngLength","pngDataUrl","convertSvgToPngDataUrl","pngBase64","encodeSvg","reduce","byte","svgString","scale","svgUrl","originalWidth","originalHeight","canvasWidth","canvasHeight","svgToPng","svgBlob","Blob","createObjectURL","saveMermaidCode","macroData","macro","zoom","format","tempDiv","newImg","foundImages","findImagesByFilename","oldImg","replaceImageAttributes","newAttributes","attributesToKeep","oldAttributes","removeAttribute","old","a","new","addMessage","messageId","messageDiv","removeMessage","TextEditAI","selectedText","selectedElement","selectedDocument","editButton","loadCSS","setupTextSelectionDetection","attachSelectionListeners","setupIframeSelectionListeners","hideEditButton","docType","_textEditListenersAttached","mouseupHandler","handleTextSelection","keyupHandler","_textEditMouseupHandler","_textEditKeyupHandler","attachToIframe","attachToExistingIframes","textEditListenerAttached","attachListeners","_iframe$contentWindow","textEditMouseupHandler","textEditKeyupHandler","textEditLoadHandler","_e","selection","isEditMode","isInConfluenceEditMode","getRangeAt","showEditButton","parent","frameElement","indicator","rangeCount","buttonWidth","buttonHeight","showEditPopup","selectedTextDisplay","hideEditPopup","forceClosePopup","cancelBtn","_textEditEventsBound","handleSendEdit","getSelectedHtmlContent","editedHtml","callEditAPI","replaceSelectedHtmlContent","html_content","selected_text","commonAncestorContainer","parentElement","children","outerHTML","newHtmlContent","replaceSelectedText","firstElementChild","fragment","createDocumentFragment","firstChild","removeAllRanges","newContent","deleteContents","insertNode","createTextNode","writeText","str","elementStartX","elementStartY","elementRect","boundedX","boundedY","elementX","elementY","KToolContent","isModalOpen","currentTab","generationJob","progressSteps","confluenceEditor","mermaidAIChat","textEditAI","loadSettings","injectUI","bindEvents","ktoolContent","bubble","createBubble","modal","createModal","openModal","createGenerateTab","createPreviewTab","createSettingsTab","closeModal","handleGenerate","handleReset","addSettingsButtonListener","onMessage","addListener","sender","sendResponse","action","updateBubbleState","metaKey","firstInput","settingsBtn","openSettingsPopup","_chrome$action","_chrome$action$openPo","_chrome$browserAction","_chrome$browserAction2","openOptionsPage","openPopup","browserAction","tooltip","clearError","baDocUrl","additionalNotes","showProgress","updateProgress","baDocument","clonedTemplate","instructions","instructionPageId","instructionDoc","ba_content","template_structure","original_storage_format","additional_prompt","additional_notes","ba_content_length","template_structure_length","original_format_length","placeholders_found","placeholders_list","jobResponse","job_id","currentJobId","pollGenerationResult","hideProgress","attempts","poll","statusResult","resultString","handleGenerationComplete","progress_message","generatedContent","initializeMermaidDiagramMappings","updatePreviewTab","previewTab","handleEditContent","createPageBtn","handleCreatePage","normalizeConfluenceHtml","htmlString","createBtn","originalText","originalDisabled","_this$generatedConten","_content","_content2","_content3","generatedContentLength","replaceMermaidImagesWithOriginalCode","parentId","hasAcMacro","hasCodeBlock","hasStructuredMacro","mermaidOccurrences","count","_d$code","_d$originalMatch","originalMatchLength","replacementCount","mapping","_mapping$originCode","_mapping$originalCode","_mapping$content","hasOriginCode","originCodeLength","originalCodeLength","replacementCode","imgPatterns","foundMatch","_updatedContent$full_","_updatedContent$full_2","_this$generatedConten2","_this$generatedConten3","showMermaidTools","progressSection","step","stepIndex","stepElement","icon","mermaidElements","innerText"],"sourceRoot":""}