{"version":3,"file":"content.js","mappings":"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","sources":["webpack://k-tool-extension-clean/./src/shared/api.js","webpack://k-tool-extension-clean/./src/content/confluenceEditor.js","webpack://k-tool-extension-clean/./src/shared/storage.js","webpack://k-tool-extension-clean/./src/shared/constants.js","webpack://k-tool-extension-clean/webpack/bootstrap","webpack://k-tool-extension-clean/webpack/runtime/define property getters","webpack://k-tool-extension-clean/webpack/runtime/hasOwnProperty shorthand","webpack://k-tool-extension-clean/./src/content/content.js"],"sourcesContent":["// API utilities for K-Tool Extension\nimport { API_URLS } from \"./constants.js\";\n\nexport class ApiClient {\n  /**\n   * Make HTTP request with error handling\n   * @param {string} url - Request URL\n   * @param {Object} options - Fetch options\n   * @returns {Promise<Object>} Response data\n   */\n  static async request(url, options = {}) {\n    try {\n      const response = await fetch(url, {\n        headers: {\n          \"Content-Type\": \"application/json\",\n          ...options.headers,\n        },\n        ...options,\n      });\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      return { success: true, data };\n    } catch (error) {\n      console.error(\"API request failed:\", error);\n      return { success: false, error: error.message };\n    }\n  }\n\n  /**\n   * Generate document from BA content\n   * @param {Object} payload - Generation payload\n   * @returns {Promise<Object>} Job response\n   */\n  static async generateDocument(payload) {\n    return await this.request(API_URLS.GEN_DOC, {\n      method: \"POST\",\n      body: JSON.stringify(payload),\n    });\n  }\n\n  /**\n   * Check generation status\n   * @param {string} jobId - Job ID to check\n   * @returns {Promise<Object>} Status response\n   */\n  static async checkStatus(jobId) {\n    return await this.request(`${API_URLS.GEN_DOC_STATUS}?job_id=${jobId}`);\n  }\n\n  /**\n   * Get generation result\n   * @param {string} jobId - Job ID to get result\n   * @returns {Promise<Object>} Result response\n   */\n  static async getResult(jobId) {\n    return await this.request(`${API_URLS.GEN_DOC_RESULT}?job_id=${jobId}`);\n  }\n\n  /**\n   * Edit text using AI\n   * @param {Object} payload - Edit payload\n   * @returns {Promise<Object>} Edit response\n   */\n  static async editText(payload) {\n    return await this.request(API_URLS.EDIT_TEXT, {\n      method: \"POST\",\n      body: JSON.stringify(payload),\n    });\n  }\n}\n\n/**\n * Confluence API utilities\n */\nexport class ConfluenceApi {\n  /**\n   * Extract page ID from Confluence URL\n   * @param {string} url - Confluence page URL\n   * @returns {string|null} Page ID or null\n   */\n  static extractPageId(url) {\n    const patterns = [/\\/pages\\/(\\d+)/, /pageId=(\\d+)/, /\\/(\\d+)$/];\n\n    for (const pattern of patterns) {\n      const match = url.match(pattern);\n      if (match) return match[1];\n    }\n\n    return null;\n  }\n\n  /**\n   * Get current space key from page\n   * @returns {string|null} Space key or null\n   */\n  static getCurrentSpaceKey() {\n    // Try to get space key from various sources\n    const spaceKeyMeta = document.querySelector('meta[name=\"ajs-space-key\"]');\n    if (spaceKeyMeta) return spaceKeyMeta.content;\n\n    const spaceKeyElement = document.querySelector(\"[data-space-key]\");\n    if (spaceKeyElement) return spaceKeyElement.dataset.spaceKey;\n\n    // Try to extract from URL\n    const urlMatch = window.location.pathname.match(/\\/spaces\\/([^\\/]+)/);\n    if (urlMatch) return urlMatch[1];\n\n    return null;\n  }\n\n  /**\n   * Fetch page content from Confluence\n   * @param {string} pageId - Page ID to fetch\n   * @returns {Promise<Object>} Page content with title, content (view), and storageFormat\n   */\n  static async fetchPageContent(pageId) {\n    try {\n      console.log(\"🔍 Fetching Confluence content for pageId:\", pageId);\n\n      const apiUrl = `/rest/api/content/${pageId}?expand=body.storage,body.view`;\n\n      const response = await fetch(apiUrl, {\n        method: \"GET\",\n        headers: {\n          Accept: \"application/json\",\n          \"Content-Type\": \"application/json\",\n        },\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(\"❌ API Error:\", response.status, errorText);\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      console.log(\"📄 Content data received:\", {\n        id: data.id,\n        title: data.title,\n        hasStorage: !!data.body?.storage?.value,\n        hasView: !!data.body?.view?.value,\n      });\n\n      return {\n        title: data.title,\n        content: data.body?.view?.value || \"\",\n        storageFormat: data.body?.storage?.value || \"\",\n      };\n    } catch (error) {\n      console.error(\"❌ Error fetching Confluence content:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * Clone template from URL for document generation\n   * @param {string} url - Template URL\n   * @returns {Promise<Object>} Cloned template data\n   */\n  static async cloneTemplateForGeneration(url) {\n    try {\n      console.log(\"🔍 Cloning template from URL:\", url);\n\n      if (!url || !url.trim()) {\n        console.error(\"❌ Empty URL provided\");\n        throw new Error(\"URL template không được để trống\");\n      }\n\n      // Extract pageId from URL\n      const pageId = this.extractPageIdFromUrl(url);\n      if (!pageId) {\n        console.error(\"❌ No pageId found in URL\");\n        throw new Error(\n          \"URL không chứa pageId hợp lệ. Vui lòng kiểm tra lại URL template.\"\n        );\n      }\n\n      console.log(\"📋 Fetching template pageId:\", pageId);\n      const apiUrl = `/rest/api/content/${pageId}?expand=body.storage`;\n\n      const response = await fetch(apiUrl, {\n        method: \"GET\",\n        headers: {\n          Accept: \"application/json\",\n          \"Content-Type\": \"application/json\",\n        },\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(\"❌ API Error:\", response.status, errorText);\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      console.log(\"📄 Template data received:\", {\n        id: data.id,\n        title: data.title,\n        hasStorage: !!data.body?.storage?.value,\n      });\n\n      if (!data.body?.storage?.value) {\n        console.error(\"❌ No storage content found in response\");\n        throw new Error(\"Template không có nội dung storage format\");\n      }\n\n      const originalStorageFormat = data.body.storage.value;\n      console.log(\n        \"📄 Original storage format length:\",\n        originalStorageFormat.length\n      );\n\n      const { templateStructure, analysisInfo } = this.extractTemplateStructure(\n        originalStorageFormat\n      );\n\n      const result = {\n        title: data.title,\n        originalStorageFormat,\n        templateStructure,\n        analysisInfo,\n      };\n\n      console.log(\"✅ Template cloned successfully:\", {\n        title: result.title,\n        originalLength: originalStorageFormat.length,\n        structureLength: templateStructure.length,\n        analysis: analysisInfo,\n      });\n\n      return result;\n    } catch (error) {\n      console.error(\"❌ Error cloning template:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * Extract template structure and analyze placeholders\n   * @param {string} storageFormat - Original storage format\n   * @returns {Object} Template structure and analysis info\n   */\n  static extractTemplateStructure(storageFormat) {\n    let emptyParagraphs = 0;\n    let emptyTableCells = 0;\n    let placeholders = 0;\n\n    console.log(\"🔍 Extracting template structure...\");\n\n    const placeholderPatterns = [\n      /(<<.*?>>)/g,\n      /(\\{\\{.*?\\}\\})/g,\n      /(&lt;&lt;.*?&gt;&gt;)/g,\n      /(\\u003c\\u003c.*?\\u003e\\u003e)/g,\n    ];\n\n    let structure = storageFormat;\n\n    placeholderPatterns.forEach((regex, index) => {\n      const matches = [...structure.matchAll(regex)];\n      console.log(\n        `🎯 Placeholder pattern ${index + 1} found ${matches.length} matches`\n      );\n      placeholders += matches.length;\n    });\n\n    // Count empty paragraphs and table cells\n    emptyParagraphs = (storageFormat.match(/<p[^>]*>\\s*<\\/p>/g) || []).length;\n    emptyTableCells = (storageFormat.match(/<td[^>]*>\\s*<\\/td>/g) || []).length;\n\n    const analysisInfo = {\n      emptyParagraphs,\n      emptyTableCells,\n      placeholders,\n      totalLength: storageFormat.length,\n    };\n\n    return {\n      templateStructure: structure,\n      analysisInfo,\n    };\n  }\n\n  /**\n   * Extract pageId from various URL formats\n   * @param {string} url - URL to extract pageId from\n   * @returns {string|null} Page ID or null\n   */\n  static extractPageIdFromUrl(url) {\n    const patterns = [\n      /\\/pages\\/(\\d+)/,\n      /pageId=(\\d+)/,\n      /\\/(\\d+)$/,\n      /viewpage\\.action\\?pageId=(\\d+)/,\n    ];\n\n    for (const pattern of patterns) {\n      const match = url.match(pattern);\n      if (match) return match[1];\n    }\n\n    return null;\n  }\n\n  /**\n   * Extract placeholders from content (<<placeholder>> format)\n   * @param {string} content - Content to analyze\n   * @returns {Array} Array of placeholder strings\n   */\n  static extractPlaceholders(content) {\n    console.log(\"🔍 Analyzing content for placeholders...\");\n    console.log(\"📄 Content length:\", content.length);\n    console.log(\n      \"📄 Content preview (first 500 chars):\",\n      content.substring(0, 500)\n    );\n\n    // Helper function to decode HTML entities\n    const decodeHtmlEntities = (str) => {\n      return str\n        .replace(/&lt;/g, \"<\")\n        .replace(/&gt;/g, \">\")\n        .replace(/&amp;/g, \"&\")\n        .replace(/&quot;/g, '\"')\n        .replace(/&#39;/g, \"'\");\n    };\n\n    const decodedContent = decodeHtmlEntities(content);\n\n    // Patterns to find placeholders\n    const patterns = [\n      /<<([^>]+)>>/g, // Normal <<placeholder>>\n      /&lt;&lt;([^&]+)&gt;&gt;/g, // HTML encoded &lt;&lt;placeholder&gt;&gt;\n    ];\n\n    let allMatches = [];\n\n    // Test patterns on both original and decoded content\n    [content, decodedContent].forEach((testContent, contentIndex) => {\n      console.log(\n        `🔍 Testing on ${\n          contentIndex === 0 ? \"original\" : \"decoded\"\n        } content...`\n      );\n\n      patterns.forEach((regex, patternIndex) => {\n        const matches = [...testContent.matchAll(regex)];\n        console.log(\n          `🎯 Pattern ${patternIndex + 1} found ${matches.length} matches:`,\n          matches.map((m) => m[0])\n        );\n\n        if (patternIndex === 1) {\n          // For HTML encoded, decode back to normal format\n          allMatches.push(...matches.map((match) => `<<${match[1]}>>`));\n        } else {\n          allMatches.push(...matches.map((match) => match[0]));\n        }\n      });\n    });\n\n    // Remove duplicates\n    const uniquePlaceholders = [...new Set(allMatches)];\n    console.log(\"🎯 Unique placeholders found:\", uniquePlaceholders);\n\n    return uniquePlaceholders;\n  }\n\n  /**\n   * Extract images from HTML content and convert to base64\n   * @param {string} html - HTML content\n   * @returns {Promise<Array>} Array of image objects with base64 data\n   */\n  static async extractImagesFromHtml(html) {\n    const images = [];\n    try {\n      const parser = new DOMParser();\n      const doc = parser.parseFromString(html, \"text/html\");\n      const imgTags = doc.querySelectorAll(\"img\");\n\n      for (const img of Array.from(imgTags)) {\n        const src = img.getAttribute(\"src\");\n        let filename = undefined;\n\n        if (src) {\n          let base64src = src;\n\n          if (!src.startsWith(\"data:image\")) {\n            // Convert URL to base64 and get filename\n            const { base64, filename: fname } = await this.urlToBase64(src);\n            if (base64) {\n              base64src = base64;\n              filename = fname;\n            } else continue; // skip if failed\n          } else {\n            // If already base64, get name from alt or set default\n            filename = img.getAttribute(\"alt\")\n              ? img.getAttribute(\"alt\") + \".png\"\n              : `image_${Date.now()}.png`;\n          }\n\n          images.push({\n            src: base64src,\n            alt: img.getAttribute(\"alt\") || undefined,\n            filename,\n          });\n        }\n      }\n    } catch (e) {\n      console.warn(\"extractImagesFromHtml error:\", e);\n    }\n    return images;\n  }\n\n  /**\n   * Convert image URL to base64\n   * @param {string} url - Image URL\n   * @returns {Promise<Object>} Object with base64 data and filename\n   */\n  static async urlToBase64(url) {\n    try {\n      const response = await fetch(url);\n      if (!response.ok)\n        return { base64: null, filename: this.getFilenameFromUrl(url) };\n\n      const blob = await response.blob();\n      const filename = this.getFilenameFromUrl(url);\n\n      return await new Promise((resolve, reject) => {\n        const reader = new FileReader();\n        reader.onloadend = () => resolve({ base64: reader.result, filename });\n        reader.onerror = reject;\n        reader.readAsDataURL(blob);\n      });\n    } catch (e) {\n      console.warn(\"urlToBase64 error:\", e);\n      return { base64: null, filename: this.getFilenameFromUrl(url) };\n    }\n  }\n\n  /**\n   * Get filename from URL\n   * @param {string} url - URL to extract filename from\n   * @returns {string} Filename\n   */\n  static getFilenameFromUrl(url) {\n    try {\n      const urlObj = new URL(url);\n      const pathname = urlObj.pathname;\n      return (\n        pathname.substring(pathname.lastIndexOf(\"/\") + 1) ||\n        `image_${Date.now()}`\n      );\n    } catch {\n      return `image_${Date.now()}`;\n    }\n  }\n\n  /**\n   * Create new Confluence page\n   * @param {string} title - Page title\n   * @param {string} content - Page content (storage format)\n   * @param {string} spaceKey - Space key\n   * @param {string} parentId - Parent page ID (optional)\n   * @returns {Promise<Object>} Created page response\n   */\n  static async createPage(title, content, spaceKey, parentId = null) {\n    try {\n      const payload = {\n        type: \"page\",\n        title,\n        space: { key: spaceKey },\n        body: {\n          storage: {\n            value: content,\n            representation: \"storage\",\n          },\n        },\n      };\n\n      if (parentId) {\n        payload.ancestors = [{ id: parentId }];\n      }\n\n      const response = await fetch(\"/rest/api/content\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(payload),\n      });\n\n      if (!response.ok) {\n        throw new Error(`Failed to create page: ${response.statusText}`);\n      }\n\n      return await response.json();\n    } catch (error) {\n      console.error(\"Error creating page:\", error);\n      throw error;\n    }\n  }\n}\n","// Confluence Content Editor with Rich Text Editing\n// Handles editing interface when Confluence content is returned from API\n\nclass ConfluenceEditor {\n  constructor() {\n    this.isEditorOpen = false;\n    this.currentContent = null;\n    this.originalContent = null;\n    this.mermaidDiagrams = [];\n    this.editorContainer = null;\n    this.textEditor = null; // CodeMirror instance\n    this.previewContainer = null;\n    this.isPreviewMode = false;\n    this.autoSaveTimer = null;\n  }\n\n  openEditor(content, options = {}) {\n    if (this.isEditorOpen) {\n      this.closeEditor();\n    }\n\n    console.log(\"📝 Opening Confluence Editor with content:\", content);\n\n    this.currentContent = content;\n    this.originalContent = JSON.parse(JSON.stringify(content)); // Deep copy\n    this.isEditorOpen = true;\n\n    // Extract Mermaid diagrams from content\n    this.extractMermaidDiagrams();\n\n    // Create editor UI\n    this.createEditorUI(options);\n\n    // Initialize content tab (default)\n    this.initializeContentTab();\n  }\n\n  createEditorUI(options = {}) {\n    const overlay = document.createElement(\"div\");\n    overlay.className = \"confluence-editor-overlay\";\n\n    overlay.innerHTML = `\n      <div class=\"confluence-editor-container\">\n        <div class=\"confluence-editor-header\">\n          <h2 class=\"confluence-editor-title\">\n            📝 Chỉnh sửa nội dung Confluence\n          </h2>\n          <div class=\"confluence-editor-actions\">\n            <button class=\"editor-btn editor-btn-primary\" id=\"editor-save-btn\">\n              � Lưu thay đổi\n            </button>\n            <button class=\"editor-btn editor-btn-secondary\" id=\"editor-close-btn\">\n              ✕ Đóng\n            </button>\n          </div>\n        </div>\n\n        <div class=\"confluence-editor-tabs\">\n          <button class=\"confluence-editor-tab active\" id=\"content-tab\">\n            📝 Chỉnh sửa nội dung\n          </button>\n          <button class=\"confluence-editor-tab\" id=\"mermaid-tab\">\n            📊 Chỉnh sửa Mermaid\n          </button>\n        </div>\n\n        <div class=\"confluence-editor-body\">\n          <!-- Content Tab -->\n          <div class=\"tab-content active\" id=\"content-tab-content\">\n            <div class=\"content-editor-layout\">\n              <!-- Raw XHTML Editor (Left) -->\n              <div class=\"content-editor-pane\">\n                <div class=\"content-editor-header\">\n                  📝 Raw XHTML Content\n                </div>\n                <div class=\"content-editor-body\">\n                  <textarea class=\"raw-content-editor\" id=\"raw-content-editor\" placeholder=\"Raw XHTML content will appear here...\"></textarea>\n                </div>\n              </div>\n\n              <!-- Preview Pane (Right) -->\n              <div class=\"content-preview-pane\">\n                <div class=\"content-editor-header\">\n                  👁️ Live Preview\n                </div>\n                <div class=\"content-editor-body\">\n                  <div class=\"content-preview\" id=\"content-preview\">\n                    <!-- Preview content will be rendered here -->\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <!-- Mermaid Tab -->\n          <div class=\"tab-content\" id=\"mermaid-tab-content\">\n            <div class=\"mermaid-editor-layout\">\n              <!-- Mermaid Code Editor (Left) -->\n              <div class=\"mermaid-code-pane\">\n                <div class=\"mermaid-editor-header\">\n                  � Mermaid Code\n                  <select id=\"mermaid-selector\" class=\"mermaid-selector\">\n                    <option value=\"\">Select diagram...</option>\n                  </select>\n                </div>\n                <div class=\"mermaid-editor-body\">\n                  <textarea class=\"mermaid-code-editor\" id=\"mermaid-code-editor\" placeholder=\"Select a Mermaid diagram to edit...\"></textarea>\n                </div>\n              </div>\n\n              <!-- Mermaid Preview (Center) -->\n              <div class=\"mermaid-preview-pane\">\n                <div class=\"mermaid-editor-header\">\n                  📊 Diagram Preview\n                </div>\n                <div class=\"mermaid-editor-body\">\n                  <div class=\"mermaid-preview\" id=\"mermaid-preview\">\n                    <div class=\"mermaid-placeholder\">\n                      Select a diagram to preview\n                    </div>\n                  </div>\n                </div>\n              </div>\n\n              <!-- AI Chat (Right) -->\n              <div class=\"mermaid-ai-pane\">\n                <div class=\"mermaid-editor-header\">\n                  🤖 AI Assistant\n                </div>\n                <div class=\"mermaid-editor-body\">\n                  <div class=\"ai-chat-container\">\n                    <div class=\"ai-chat-messages\" id=\"ai-chat-messages\">\n                      <div class=\"ai-message\">\n                        <div class=\"ai-avatar\">🤖</div>\n                        <div class=\"ai-text\">Hi! I can help you edit Mermaid diagrams. Select a diagram and ask me to modify it.</div>\n                      </div>\n                    </div>\n                    <div class=\"ai-chat-input\">\n                      <input type=\"text\" id=\"ai-prompt-input\" placeholder=\"Describe how you want to modify the diagram...\" />\n                      <button id=\"ai-send-btn\" class=\"ai-send-btn\">Send</button>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n\n    document.body.appendChild(overlay);\n    this.editorContainer = overlay;\n\n    // Bind events\n    this.bindEditorEvents();\n  }\n\n  bindEditorEvents() {\n    if (!this.editorContainer) return;\n\n    // Close button\n    const closeBtn = this.editorContainer.querySelector(\"#editor-close-btn\");\n    closeBtn.addEventListener(\"click\", () => this.closeEditor());\n\n    // Save button\n    const saveBtn = this.editorContainer.querySelector(\"#editor-save-btn\");\n    saveBtn.addEventListener(\"click\", () => this.saveChanges());\n\n    // Tab buttons\n    const contentTab = this.editorContainer.querySelector(\"#content-tab\");\n    const mermaidTab = this.editorContainer.querySelector(\"#mermaid-tab\");\n\n    if (contentTab)\n      contentTab.addEventListener(\"click\", () => this.switchTab(\"content\"));\n    if (mermaidTab)\n      mermaidTab.addEventListener(\"click\", () => this.switchTab(\"mermaid\"));\n\n    // Content tab elements\n    const rawEditor = this.editorContainer.querySelector(\"#raw-content-editor\");\n    if (rawEditor) {\n      rawEditor.addEventListener(\"input\", () => this.updateContentPreview());\n    }\n\n    // Mermaid tab elements\n    const mermaidSelector =\n      this.editorContainer.querySelector(\"#mermaid-selector\");\n    const mermaidCodeEditor = this.editorContainer.querySelector(\n      \"#mermaid-code-editor\"\n    );\n    const aiSendBtn = this.editorContainer.querySelector(\"#ai-send-btn\");\n    const aiPromptInput =\n      this.editorContainer.querySelector(\"#ai-prompt-input\");\n\n    if (mermaidSelector) {\n      mermaidSelector.addEventListener(\"change\", (e) =>\n        this.selectMermaidDiagram(e.target.value)\n      );\n    }\n\n    if (mermaidCodeEditor) {\n      mermaidCodeEditor.addEventListener(\"input\", () =>\n        this.updateMermaidPreview()\n      );\n    }\n\n    if (aiSendBtn) {\n      aiSendBtn.addEventListener(\"click\", () => this.sendAIPrompt());\n    }\n\n    if (aiPromptInput) {\n      aiPromptInput.addEventListener(\"keypress\", (e) => {\n        if (e.key === \"Enter\") this.sendAIPrompt();\n      });\n    }\n\n    // Close on overlay click\n    this.editorContainer.addEventListener(\"click\", (e) => {\n      if (e.target === this.editorContainer) {\n        this.closeEditor();\n      }\n    });\n\n    // ESC key to close\n    const handleEsc = (e) => {\n      if (e.key === \"Escape\") {\n        this.closeEditor();\n        document.removeEventListener(\"keydown\", handleEsc);\n      }\n    };\n    document.addEventListener(\"keydown\", handleEsc);\n  }\n\n  // Switch between tabs\n  switchTab(tabName) {\n    // Update tab buttons\n    const tabs = this.editorContainer.querySelectorAll(\n      \".confluence-editor-tab\"\n    );\n    tabs.forEach((tab) => tab.classList.remove(\"active\"));\n\n    const activeTab = this.editorContainer.querySelector(`#${tabName}-tab`);\n    if (activeTab) activeTab.classList.add(\"active\");\n\n    // Update tab content\n    const tabContents = this.editorContainer.querySelectorAll(\".tab-content\");\n    tabContents.forEach((content) => content.classList.remove(\"active\"));\n\n    const activeContent = this.editorContainer.querySelector(\n      `#${tabName}-tab-content`\n    );\n    if (activeContent) activeContent.classList.add(\"active\");\n\n    // Initialize tab-specific content\n    if (tabName === \"content\") {\n      this.initializeContentTab();\n    } else if (tabName === \"mermaid\") {\n      this.initializeMermaidTab();\n    }\n\n    console.log(`Switched to ${tabName} tab`);\n  }\n\n  // Initialize content tab\n  initializeContentTab() {\n    const rawEditor = this.editorContainer.querySelector(\"#raw-content-editor\");\n    if (rawEditor && this.currentContent) {\n      // Get raw content and clean up ```xml markers\n      let rawContent =\n        this.currentContent.full_storage_format ||\n        this.currentContent.content ||\n        \"\";\n\n      // Remove ```xml and ``` markers\n      rawContent = rawContent.replace(/^```xml\\s*\\n?/gm, \"\");\n      rawContent = rawContent.replace(/\\n?```\\s*$/gm, \"\");\n\n      // Format for better readability\n      rawContent = this.formatXHTML(rawContent);\n\n      rawEditor.value = rawContent;\n      this.updateContentPreview();\n    }\n  }\n\n  // Initialize mermaid tab\n  initializeMermaidTab() {\n    this.extractMermaidDiagrams();\n    this.populateMermaidSelector();\n  }\n\n  // Format XHTML for better readability with proper alignment\n\n  formatXHTML(xmlString, indent = \"    \") {\n    // 1. Phân tích cú pháp chuỗi thành một cây DOM\n    const parser = new DOMParser();\n\n    // Bọc nội dung bằng một thẻ root tạm thời nếu nó chỉ là một fragment\n    const rootTag = \"xml-root-fragment\";\n    const wrappedXml = `<${rootTag}>${xmlString}</${rootTag}>`;\n\n    const doc = parser.parseFromString(wrappedXml, \"text/xml\");\n\n    // Kiểm tra lỗi phân tích cú pháp\n    if (doc.getElementsByTagName(\"parsererror\").length > 0) {\n      console.error(\"Lỗi phân tích cú pháp XML/XHTML. Trả về chuỗi gốc.\");\n      return xmlString;\n    }\n\n    let output = \"\";\n    let currentIndent = \"\";\n\n    // Lấy thẻ root bọc ngoài (chỉ xử lý con của nó)\n    const rootElement = doc.documentElement;\n\n    /**\n     * Hàm đệ quy để duyệt và xây dựng lại chuỗi\n     * @param {Node} node - Node hiện tại\n     * @param {string} level - Mức thụt lề hiện tại\n     */\n    function processNode(node, level) {\n      switch (node.nodeType) {\n        case Node.ELEMENT_NODE: // 1: Thẻ HTML/XML (ví dụ: <p>, <ac:structured-macro>)\n          const nodeName = node.nodeName;\n\n          // Bắt đầu thẻ (ví dụ: <p data=\"...\">)\n          let startTag = `<${nodeName}`;\n\n          // Thêm thuộc tính\n          if (node.attributes && node.attributes.length > 0) {\n            for (let attr of node.attributes) {\n              startTag += ` ${attr.name}=\"${attr.value}\"`;\n            }\n          }\n          startTag += \">\";\n\n          // Kiểm tra xem thẻ có con (trừ TextNode rỗng) hay không\n          const hasSignificantChildren = Array.from(node.childNodes).some(\n            (child) =>\n              child.nodeType !== Node.TEXT_NODE ||\n              child.textContent.trim().length > 0\n          );\n\n          if (!hasSignificantChildren) {\n            // Xử lý thẻ tự đóng hoặc thẻ rỗng (ví dụ: <br />)\n            // Lưu ý: Trong XHTML, thẻ <tag></tag> là phổ biến hơn <tag />\n            // Ở đây ta sử dụng logic thông thường: Thẻ mở, thẻ đóng trên cùng dòng\n            output += `${level}${startTag.replace(\">\", \"/>\")}\\n`;\n          } else {\n            // Thẻ mở trên dòng mới\n            output += `${level}${startTag}\\n`;\n\n            // Tăng mức thụt lề và xử lý con\n            const nextLevel = level + indent;\n            Array.from(node.childNodes).forEach((child) =>\n              processNode(child, nextLevel)\n            );\n\n            // Thẻ đóng trên dòng mới với mức thụt lề cũ\n            output += `${level}</${nodeName}>\\n`;\n          }\n          break;\n\n        case Node.TEXT_NODE: // 3: Nội dung văn bản\n          const text = node.textContent.trim();\n          if (text.length > 0) {\n            // Xử lý văn bản thuần túy (ví dụ: nội dung bên trong <p>)\n            // Nếu nó là văn bản thuần túy, ta thêm nó vào dòng hiện tại hoặc trên dòng mới\n            output += `${level}${text}\\n`;\n          }\n          break;\n\n        case Node.COMMENT_NODE: // 8: Comment (ví dụ: )\n          output += `${level}\\n`;\n          break;\n\n        case Node.CDATA_SECTION_NODE: // 4: CDATA Section (An toàn cho code trong <ac:parameter>)\n          // Đây là trường hợp quan trọng nhất cho nội dung Mermaid\n          output += `${level}<![CDATA[${node.textContent}]]>\\n`;\n          break;\n\n        // Bạn có thể thêm các case khác như DOCUMENT_TYPE_NODE, PROCESSING_INSTRUCTION_NODE nếu cần\n      }\n    }\n\n    // Bắt đầu xử lý từ các con của thẻ root tạm thời\n    Array.from(rootElement.childNodes).forEach((node) =>\n      processNode(node, currentIndent)\n    );\n\n    return output.trim();\n  }\n\n  isSelfClosingTag(tag) {\n    const selfClosing = [\n      \"br\",\n      \"hr\",\n      \"img\",\n      \"input\",\n      \"meta\",\n      \"link\",\n      \"source\",\n      \"track\",\n      \"wbr\",\n    ];\n    return selfClosing.some((t) => tag.startsWith(`<${t}`));\n  }\n\n  // Update content preview\n  updateContentPreview() {\n    const rawEditor = this.editorContainer.querySelector(\"#raw-content-editor\");\n    const preview = this.editorContainer.querySelector(\"#content-preview\");\n\n    if (!rawEditor || !preview) return;\n\n    const content = rawEditor.value;\n\n    // Update current content\n    if (this.currentContent) {\n      this.currentContent.full_storage_format = content;\n    }\n\n    // Render preview (similar to existing preview logic)\n    this.renderContentPreview(content, preview);\n  }\n\n  // Render content preview\n  renderContentPreview(content, previewElement) {\n    // Convert basic HTML with better styling first\n    let processedContent = content\n      .replace(\n        /<h1>/g,\n        \"<h1 style='color: #333; margin: 24px 0 16px 0; font-size: 1.8rem; border-bottom: 2px solid #e1e5e9; padding-bottom: 8px;'>\"\n      )\n      .replace(\n        /<h2>/g,\n        \"<h2 style='color: #555; margin: 20px 0 12px 0; font-size: 1.4rem;'>\"\n      )\n      .replace(\n        /<h3>/g,\n        \"<h3 style='color: #666; margin: 16px 0 8px 0; font-size: 1.2rem;'>\"\n      )\n      .replace(\n        /<p>/g,\n        \"<p style='margin: 12px 0; line-height: 1.6; color: #333;'>\"\n      )\n      .replace(/<ul>/g, \"<ul style='margin: 12px 0; padding-left: 24px;'>\")\n      .replace(/<li>/g, \"<li style='margin: 4px 0; line-height: 1.5;'>\")\n      .replace(\n        /<table>/g,\n        \"<table style='border-collapse: collapse; width: 100%; margin: 20px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1);'>\"\n      )\n      .replace(\n        /<th>/g,\n        \"<th style='border: 1px solid #ddd; padding: 12px; background: #f8f9fa; font-weight: 600; text-align: left;'>\"\n      )\n      .replace(\n        /<td>/g,\n        \"<td style='border: 1px solid #ddd; padding: 12px; vertical-align: top;'>\"\n      )\n      .replace(/<strong>/g, \"<strong style='color: #2c3e50;'>\")\n      .replace(\n        /<code>/g,\n        \"<code style='background: #f1f3f4; padding: 2px 4px; border-radius: 3px; font-family: monospace; font-size: 0.9em;'>\"\n      );\n\n    // Set the processed content to preview element\n    previewElement.innerHTML = processedContent;\n\n    // Render Mermaid diagrams using the comprehensive logic from content.js\n    this.renderMermaidDiagramsInPreview();\n  }\n\n  // Load Mermaid script dynamically (copied from content.js)\n  async loadMermaidScript() {\n    if (window.mermaid) {\n      console.log(\"⚡ Mermaid already loaded\");\n      return window.mermaid;\n    }\n\n    const res = await fetch(chrome.runtime.getURL(\"lib/mermaid.min.js\"));\n    const text = await res.text();\n    eval(text); // UMD sẽ gắn mermaid vào window\n    console.log(\"✅ Mermaid loaded dynamically\");\n    return window.mermaid;\n  }\n\n  // Initialize Mermaid diagrams (copied from content.js logic)\n  async initializeMermaidInPreview() {\n    try {\n      // Load Mermaid if not already loaded\n      await this.loadMermaidScript();\n\n      console.log(\"🎨 Initializing Mermaid diagrams in preview...\");\n\n      // Configure Mermaid with proper DOM context\n      window.mermaid.initialize({\n        startOnLoad: false,\n        theme: \"default\",\n        securityLevel: \"loose\",\n        fontFamily: \"Arial, sans-serif\",\n        // Ensure proper DOM context\n        htmlLabels: true,\n        flowchart: {\n          htmlLabels: true,\n        },\n        // Set the document context explicitly\n        deterministicIds: true,\n        deterministicIDSeed: \"mermaid-diagram-preview\",\n      });\n\n      // Ensure mermaid has access to document\n      if (window.mermaid.setConfig) {\n        window.mermaid.setConfig({\n          securityLevel: \"loose\",\n          theme: \"default\",\n        });\n      }\n\n      // Find all mermaid code blocks in the preview\n      const previewDiv = this.editorContainer.querySelector(\"#content-preview\");\n      if (!previewDiv) return;\n\n      // Look for Confluence Mermaid structured macros\n      const mermaidElements = previewDiv.querySelectorAll(\n        'ac\\\\:structured-macro[ac\\\\:name=\"mermaid\"]'\n      );\n\n      mermaidElements.forEach((element, index) => {\n        // Get the code parameter from Confluence structured macro\n        const codeParam = element.querySelector(\n          'ac\\\\:parameter[ac\\\\:name=\"code\"]'\n        );\n        if (!codeParam) {\n          console.warn(\"⚠️ Mermaid macro found but no code parameter\");\n          return;\n        }\n\n        const mermaidCode = (\n          codeParam.textContent || codeParam.innerText\n        ).trim();\n        console.log(\n          \"🔍 Found Confluence Mermaid diagram:\",\n          mermaidCode.substring(0, 50) + \"...\"\n        );\n\n        // Always process Confluence mermaid macros (no need to check syntax)\n        if (mermaidCode) {\n          // Create a new div for the mermaid diagram\n          const mermaidDiv = document.createElement(\"div\");\n          mermaidDiv.className = \"mermaid-diagram\";\n          mermaidDiv.id = `preview-mermaid-${index}`;\n          mermaidDiv.style.cssText =\n            \"margin: 20px 0; text-align: center; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;\";\n\n          // Replace the original element\n          element.parentNode.replaceChild(mermaidDiv, element);\n\n          // Render the diagram with proper DOM context\n          try {\n            const diagramId = `preview-mermaid-svg-${index}`;\n\n            // Create a temporary container in the document to ensure proper DOM context\n            const tempContainer = document.createElement(\"div\");\n            tempContainer.style.position = \"absolute\";\n            tempContainer.style.left = \"-9999px\";\n            tempContainer.style.top = \"-9999px\";\n            document.body.appendChild(tempContainer);\n\n            // Modern mermaid.render returns a promise\n            if (\n              window.mermaid.render &&\n              typeof window.mermaid.render === \"function\"\n            ) {\n              try {\n                // Try modern API first\n                const renderResult = window.mermaid.render(\n                  diagramId,\n                  mermaidCode\n                );\n\n                if (renderResult && typeof renderResult.then === \"function\") {\n                  // Promise-based API\n                  renderResult\n                    .then((result) => {\n                      // Clean up temp container\n                      if (document.body.contains(tempContainer)) {\n                        document.body.removeChild(tempContainer);\n                      }\n\n                      // Handle different return formats\n                      let svgCode;\n                      if (typeof result === \"string\") {\n                        svgCode = result;\n                      } else if (result && result.svg) {\n                        svgCode = result.svg;\n                      } else {\n                        svgCode = String(result);\n                      }\n\n                      mermaidDiv.innerHTML = svgCode;\n                      console.log(\n                        \"✅ Preview Mermaid diagram rendered successfully (promise API)\"\n                      );\n                    })\n                    .catch((error) => {\n                      // Clean up temp container\n                      if (document.body.contains(tempContainer)) {\n                        document.body.removeChild(tempContainer);\n                      }\n                      console.error(\n                        \"❌ Preview Mermaid render error (promise API):\",\n                        error\n                      );\n                      this.showMermaidError(mermaidDiv, mermaidCode, error);\n                    });\n                } else {\n                  // Synchronous return or callback-based API\n                  if (typeof renderResult === \"string\") {\n                    // Clean up temp container\n                    if (document.body.contains(tempContainer)) {\n                      document.body.removeChild(tempContainer);\n                    }\n                    mermaidDiv.innerHTML = renderResult;\n                    console.log(\n                      \"✅ Preview Mermaid diagram rendered successfully (sync API)\"\n                    );\n                  } else {\n                    // Try callback-based API\n                    window.mermaid.render(diagramId, mermaidCode, (svgCode) => {\n                      // Clean up temp container\n                      if (document.body.contains(tempContainer)) {\n                        document.body.removeChild(tempContainer);\n                      }\n                      mermaidDiv.innerHTML = svgCode;\n                      console.log(\n                        \"✅ Preview Mermaid diagram rendered successfully (callback API)\"\n                      );\n                    });\n                  }\n                }\n              } catch (renderError) {\n                // Clean up temp container\n                if (document.body.contains(tempContainer)) {\n                  document.body.removeChild(tempContainer);\n                }\n                throw renderError;\n              }\n            } else {\n              throw new Error(\"Mermaid render function not available\");\n            }\n          } catch (error) {\n            console.error(\"❌ Preview Mermaid render error:\", error);\n            this.showMermaidError(mermaidDiv, mermaidCode, error);\n          }\n        }\n      });\n    } catch (error) {\n      console.error(\"❌ Failed to initialize Mermaid in preview:\", error);\n    }\n  }\n\n  // Show Mermaid error in a nice format (copied from content.js)\n  showMermaidError(container, text, error) {\n    container.innerHTML = `\n      <div style=\"color: #dc3545; padding: 15px; background: #f8d7da; border-radius: 8px; border: 1px solid #f5c6cb; font-family: Arial, sans-serif;\">\n        <div style=\"font-weight: bold; margin-bottom: 8px; display: flex; align-items: center;\">\n          <span style=\"margin-right: 8px;\">⚠️</span>\n          Mermaid Render Error\n        </div>\n        <div style=\"font-size: 12px; color: #721c24; margin-bottom: 10px;\">\n          ${error.message || \"Unknown error occurred\"}\n        </div>\n        <details style=\"margin-top: 10px;\">\n          <summary style=\"cursor: pointer; font-size: 12px; color: #495057;\">Show diagram code</summary>\n          <pre style=\"margin: 8px 0 0 0; padding: 8px; background: #fff; border: 1px solid #dee2e6; border-radius: 4px; font-size: 11px; overflow-x: auto; white-space: pre-wrap;\">${text}</pre>\n        </details>\n      </div>\n    `;\n  }\n\n  // Render Mermaid diagrams in preview (updated to use new logic)\n  renderMermaidDiagramsInPreview() {\n    // Use the new comprehensive Mermaid initialization\n    setTimeout(() => {\n      this.initializeMermaidInPreview();\n    }, 100);\n  }\n\n  // Populate mermaid selector using Map\n  populateMermaidSelector() {\n    const selector = this.editorContainer.querySelector(\"#mermaid-selector\");\n    if (!selector) {\n      console.error(\"❌ Mermaid selector not found\");\n      return;\n    }\n\n    // Clear existing options\n    selector.innerHTML =\n      '<option value=\"\">📊 Select diagram to edit...</option>';\n\n    // Add diagram options from Map\n    if (this.mermaidDiagramsMap && this.mermaidDiagramsMap.size > 0) {\n      this.mermaidDiagramsMap.forEach((diagramData, diagramId) => {\n        const option = document.createElement(\"option\");\n        option.value = diagramId;\n        option.textContent = `${diagramData.title} (${diagramData.type})`;\n        selector.appendChild(option);\n      });\n    }\n\n    // Add event listener for selector change\n    selector.removeEventListener(\"change\", this.handleMermaidSelectorChange);\n    this.handleMermaidSelectorChange = (e) => {\n      const selectedId = e.target.value;\n      console.log(`🎯 Selected diagram: ${selectedId}`);\n      this.selectMermaidDiagram(selectedId);\n    };\n    selector.addEventListener(\"change\", this.handleMermaidSelectorChange);\n\n    console.log(\n      `✅ Populated ${this.mermaidDiagramsMap?.size || 0} diagrams in selector`\n    );\n  }\n\n  // Select mermaid diagram\n  selectMermaidDiagram(diagramId) {\n    if (!diagramId) {\n      this.clearMermaidEditor();\n      return;\n    }\n\n    // Get diagram from Map\n    const diagramData = this.mermaidDiagramsMap.get(diagramId);\n    if (!diagramData) {\n      console.error(`❌ Diagram not found in map: ${diagramId}`);\n      return;\n    }\n\n    // Find full diagram record from array\n    const diagram = this.mermaidDiagrams.find((d) => d.id === diagramId);\n    if (!diagram) {\n      console.error(`❌ Diagram not found in array: ${diagramId}`);\n      return;\n    }\n\n    // Update code editor\n    const codeEditor = this.editorContainer.querySelector(\n      \"#mermaid-code-editor\"\n    );\n    if (codeEditor) {\n      codeEditor.value = diagramData.content;\n      this.currentSelectedDiagram = diagram;\n      this.currentSelectedDiagramId = diagramId;\n      this.updateMermaidPreview();\n\n      // Add event listener for code changes\n      codeEditor.removeEventListener(\"input\", this.handleMermaidCodeChange);\n      this.handleMermaidCodeChange = () => {\n        if (this.currentSelectedDiagram && this.currentSelectedDiagramId) {\n          // Update diagram code in memory (both array and map)\n          this.currentSelectedDiagram.code = codeEditor.value;\n          this.mermaidDiagramsMap.get(this.currentSelectedDiagramId).content =\n            codeEditor.value;\n          // Update preview\n          this.updateMermaidPreview();\n          // Mark as modified\n          this.isModified = true;\n          console.log(`📝 Updated diagram ${this.currentSelectedDiagramId}`);\n        }\n      };\n      codeEditor.addEventListener(\"input\", this.handleMermaidCodeChange);\n    }\n\n    console.log(`✅ Selected diagram: ${diagramId} (${diagramData.type})`);\n  }\n\n  // Clear mermaid editor\n  clearMermaidEditor() {\n    const codeEditor = this.editorContainer.querySelector(\n      \"#mermaid-code-editor\"\n    );\n    const preview = this.editorContainer.querySelector(\"#mermaid-preview\");\n\n    if (codeEditor) codeEditor.value = \"\";\n    if (preview) {\n      preview.innerHTML =\n        '<div class=\"mermaid-placeholder\">Select a diagram to preview</div>';\n    }\n\n    this.currentSelectedDiagram = null;\n  }\n\n  // Update mermaid preview\n  updateMermaidPreview() {\n    const codeEditor = this.editorContainer.querySelector(\n      \"#mermaid-code-editor\"\n    );\n    const preview = this.editorContainer.querySelector(\"#mermaid-preview\");\n\n    if (!codeEditor || !preview) return;\n\n    const code = codeEditor.value.trim();\n    if (!code) {\n      preview.innerHTML =\n        '<div class=\"mermaid-placeholder\">Enter Mermaid code to preview</div>';\n      return;\n    }\n\n    // Update current diagram\n    if (this.currentSelectedDiagram) {\n      this.currentSelectedDiagram.code = code;\n    }\n\n    // Render mermaid\n    preview.innerHTML = `<div class=\"mermaid\">${code}</div>`;\n\n    // Initialize mermaid rendering\n    if (window.mermaid) {\n      window.mermaid.init(undefined, preview.querySelector(\".mermaid\"));\n    }\n  }\n\n  // Send AI prompt\n  sendAIPrompt() {\n    const promptInput = this.editorContainer.querySelector(\"#ai-prompt-input\");\n    const messagesContainer =\n      this.editorContainer.querySelector(\"#ai-chat-messages\");\n\n    if (!promptInput || !messagesContainer) return;\n\n    const prompt = promptInput.value.trim();\n    if (!prompt) return;\n\n    // Add user message\n    this.addAIMessage(\"user\", prompt);\n\n    // Clear input\n    promptInput.value = \"\";\n\n    // TODO: Integrate with AI API\n    // For now, show a placeholder response\n    setTimeout(() => {\n      this.addAIMessage(\n        \"ai\",\n        \"AI integration coming soon! I will help you modify Mermaid diagrams based on your prompts.\"\n      );\n    }, 1000);\n  }\n\n  // Add AI message\n  addAIMessage(type, text) {\n    const messagesContainer =\n      this.editorContainer.querySelector(\"#ai-chat-messages\");\n    if (!messagesContainer) return;\n\n    const messageDiv = document.createElement(\"div\");\n    messageDiv.className = \"ai-message\";\n\n    const avatar = type === \"user\" ? \"👤\" : \"🤖\";\n    const bgColor = type === \"user\" ? \"#e5e7eb\" : \"#3b82f6\";\n\n    messageDiv.innerHTML = `\n      <div class=\"ai-avatar\" style=\"background: ${bgColor};\">${avatar}</div>\n      <div class=\"ai-text\">${text}</div>\n    `;\n\n    messagesContainer.appendChild(messageDiv);\n    messagesContainer.scrollTop = messagesContainer.scrollHeight;\n  }\n\n  extractMermaidDiagrams() {\n    this.mermaidDiagrams = [];\n    this.mermaidDiagramsMap = new Map();\n\n    if (!this.currentContent?.full_storage_format) return;\n\n    const content = this.currentContent.full_storage_format;\n\n    // Regex để tìm tất cả <ac:structured-macro ...> ... </ac:structured-macro>\n    const macroRegex =\n      /<ac:structured-macro[^>]*ac:name=\"(mermaid|code)\"[^>]*>([\\s\\S]*?)<\\/ac:structured-macro>/gi;\n\n    let match;\n    let index = 0;\n\n    while ((match = macroRegex.exec(content)) !== null) {\n      const macroName = match[1];\n      const macroContent = match[2];\n\n      // Kiểm tra code parameter\n      const codeMatch = macroContent.match(\n        /<ac:parameter[^>]*ac:name=\"code\">([\\s\\S]*?)<\\/ac:parameter>/\n      );\n      if (!codeMatch) continue;\n\n      const code = codeMatch[1].trim();\n      if (!code) continue;\n\n      // Nếu là code macro, check language\n      if (macroName === \"code\") {\n        const langMatch = macroContent.match(\n          /<ac:parameter[^>]*ac:name=\"language\">([\\s\\S]*?)<\\/ac:parameter>/\n        );\n        if (!langMatch || langMatch[1].trim() !== \"mermaid\") continue;\n      }\n\n      const type = this.detectMermaidType\n        ? this.detectMermaidType(code)\n        : \"graph\";\n      const diagramId = `mermaid-diagram-${index}`;\n\n      const diagramRecord = {\n        id: diagramId,\n        code: code,\n        originalCode: code,\n        originalMatch: match[0],\n        index: index,\n        type: type,\n        title: `${type.charAt(0).toUpperCase() + type.slice(1)} Diagram ${\n          index + 1\n        }`,\n      };\n\n      this.mermaidDiagrams.push(diagramRecord);\n      this.mermaidDiagramsMap.set(diagramId, {\n        content: code,\n        type: type,\n        index: index,\n        title: diagramRecord.title,\n      });\n\n      console.log(`✅ Extracted diagram ${index}:`, {\n        type,\n        code: code.substring(0, 50) + \"...\",\n      });\n\n      index++;\n    }\n\n    console.log(\"🎨 Extracted Mermaid diagrams:\", this.mermaidDiagrams);\n  }\n\n  // Detect Mermaid diagram type\n  detectMermaidType(code) {\n    const firstLine = code.trim().split(\"\\n\")[0].toLowerCase();\n    if (firstLine.includes(\"graph\")) return \"graph\";\n    if (firstLine.includes(\"flowchart\")) return \"flowchart\";\n    if (firstLine.includes(\"sequencediagram\")) return \"sequence\";\n    if (firstLine.includes(\"classDiagram\")) return \"class\";\n    if (firstLine.includes(\"stateDiagram\")) return \"state\";\n    if (firstLine.includes(\"erDiagram\")) return \"er\";\n    if (firstLine.includes(\"gantt\")) return \"gantt\";\n    if (firstLine.includes(\"pie\")) return \"pie\";\n    return \"graph\";\n  }\n\n  editMermaidDiagram(diagramId) {\n    const diagram = this.mermaidDiagrams.find((d) => d.id === diagramId);\n    if (!diagram) return;\n\n    console.log(\"✏️ Editing Mermaid diagram:\", diagramId);\n\n    // TODO: Open Mermaid editor popup\n    // This could integrate with the ImageAIEditor for AI-powered editing\n    const newCode = prompt(\"Edit Mermaid code:\", diagram.code);\n    if (newCode && newCode !== diagram.code) {\n      diagram.code = newCode;\n      // Update the content directly\n      this.currentContent.full_storage_format =\n        this.currentContent.full_storage_format.replace(\n          diagram.originalMatch,\n          diagram.originalMatch.replace(diagram.originalCode, newCode)\n        );\n      this.updateStatus(\"Đã cập nhật diagram\");\n    }\n  }\n\n  updateStatus(message) {\n    const status = this.editorContainer?.querySelector(\"#editor-status\");\n    if (status) {\n      status.textContent = message;\n      setTimeout(() => {\n        status.textContent = \"Sẵn sàng\";\n      }, 3000);\n    }\n  }\n\n  saveChanges() {\n    console.log(\"💾 Saving changes...\");\n\n    try {\n      // Sync content from raw editor\n      this.syncContentFromRawEditor();\n\n      // Sync Mermaid changes back to content\n      this.syncMermaidChangesToContent();\n\n      // Call save callback with updated content\n      if (this.onSave) {\n        this.onSave(this.currentContent);\n      }\n\n      this.updateStatus(\"Đã lưu thay đổi\");\n      console.log(\"✅ Changes saved successfully\");\n\n      // Optionally close editor after save\n      setTimeout(() => {\n        this.closeEditor();\n      }, 1000);\n    } catch (error) {\n      console.error(\"❌ Error saving changes:\", error);\n      this.updateStatus(\"Lỗi khi lưu thay đổi\");\n    }\n  }\n\n  // Sync content from raw editor\n  syncContentFromRawEditor() {\n    const rawEditor = this.editorContainer.querySelector(\"#raw-content-editor\");\n    if (rawEditor && rawEditor.value) {\n      // Update full_storage_format with raw editor content\n      this.currentContent.full_storage_format = rawEditor.value;\n      console.log(\"📝 Synced content from raw editor\");\n    }\n  }\n\n  // Sync Mermaid changes back to content\n  syncMermaidChangesToContent() {\n    if (!this.mermaidDiagrams || this.mermaidDiagrams.length === 0) return;\n\n    let content =\n      this.currentContent.full_storage_format ||\n      this.currentContent.content ||\n      \"\";\n\n    // Update each modified diagram in the content\n    this.mermaidDiagrams.forEach((diagram) => {\n      if (diagram.originalCode !== diagram.code) {\n        // Find and replace the diagram code in content\n        const oldPattern = new RegExp(\n          `(<ac:plain-text-body><\\\\!\\\\[CDATA\\\\[\\\\s*)(${this.escapeRegex(\n            diagram.originalCode\n          )})(\\\\s*\\\\]\\\\]></ac:plain-text-body>)`,\n          \"g\"\n        );\n\n        content = content.replace(oldPattern, `$1${diagram.code}$3`);\n        console.log(`📊 Updated diagram ${diagram.id} in content`);\n      }\n    });\n\n    // Update the content\n    this.currentContent.full_storage_format = content;\n    if (this.currentContent.content) {\n      this.currentContent.content = content;\n    }\n\n    console.log(\"📊 Synced all Mermaid changes to content\");\n  }\n\n  // Escape regex special characters\n  escapeRegex(string) {\n    return string.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\n  }\n\n  closeEditor() {\n    if (this.editorContainer) {\n      this.editorContainer.remove();\n      this.editorContainer = null;\n    }\n\n    this.isEditorOpen = false;\n    this.currentContent = null;\n    this.originalContent = null;\n    this.mermaidDiagrams = [];\n\n    console.log(\"📝 Confluence Editor closed\");\n  }\n\n  // Public method to set save callback\n  setSaveCallback(callback) {\n    this.onSave = callback;\n  }\n\n  // Check if editor is currently open\n  isOpen() {\n    return this.isEditorOpen;\n  }\n\n  // Get current content\n  getCurrentContent() {\n    if (this.textEditor) {\n      // Update content from editor\n      const editorContent = this.textEditor.getValue();\n      if (this.currentContent) {\n        this.currentContent.full_storage_format = editorContent;\n      }\n    }\n    return this.currentContent;\n  }\n}\n\n// Export for use in content.js\nexport { ConfluenceEditor };\n","// Chrome Storage Management\nimport { DEFAULT_SETTINGS, EXTENSION_SETTINGS_KEY } from \"./constants.js\";\n\nexport class StorageManager {\n  /**\n   * Load settings from Chrome storage\n   * @returns {Promise<Object>} Settings object\n   */\n  static async getSettings() {\n    try {\n      const result = await chrome.storage.sync.get([EXTENSION_SETTINGS_KEY]);\n      return result[EXTENSION_SETTINGS_KEY] || DEFAULT_SETTINGS;\n    } catch (error) {\n      console.error(\"Error loading settings:\", error);\n      return DEFAULT_SETTINGS;\n    }\n  }\n\n  /**\n   * Save settings to Chrome storage\n   * @param {Object} settings - Settings object to save\n   * @returns {Promise<boolean>} Success status\n   */\n  static async saveSettings(settings) {\n    try {\n      await chrome.storage.sync.set({ [EXTENSION_SETTINGS_KEY]: settings });\n      return true;\n    } catch (error) {\n      console.error(\"Error saving settings:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Update specific setting field\n   * @param {string} field - Field name to update\n   * @param {any} value - New value\n   * @returns {Promise<boolean>} Success status\n   */\n  static async updateSetting(field, value) {\n    try {\n      const currentSettings = await this.getSettings();\n      const updatedSettings = { ...currentSettings, [field]: value };\n      return await this.saveSettings(updatedSettings);\n    } catch (error) {\n      console.error(\"Error updating setting:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Reset settings to default\n   * @returns {Promise<boolean>} Success status\n   */\n  static async resetSettings() {\n    try {\n      await chrome.storage.sync.remove([EXTENSION_SETTINGS_KEY]);\n      return true;\n    } catch (error) {\n      console.error(\"Error resetting settings:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Validate settings object\n   * @param {Object} settings - Settings to validate\n   * @returns {Object} Validation result with errors\n   */\n  static validateSettings(settings) {\n    const errors = {};\n\n    if (!settings.apiKey?.trim()) {\n      errors.apiKey = \"API Key là bắt buộc\";\n    }\n\n    if (!settings.urlTemplate?.trim()) {\n      errors.urlTemplate = \"URL Template là bắt buộc\";\n    } else {\n      const validationResult = this.validateConfluencePageLink(\n        settings.urlTemplate\n      );\n\n      if (!validationResult.valid) {\n        errors.urlTemplate =\n          validationResult.error || \"URL Template không hợp lệ.\";\n      }\n    }\n    if (!settings.documentUrl?.trim()) {\n      errors.documentUrl = \"URL thư mục lưu tài liệu là bắt buộc\";\n    } else if (!this.isValidUrl(settings.documentUrl)) {\n      errors.documentUrl = \"URL không hợp lệ\";\n    }\n\n    if (!settings.databaseUrl?.trim()) {\n      errors.databaseUrl = \"URL thư mục database là bắt buộc\";\n    } else if (!this.isValidUrl(settings.databaseUrl)) {\n      errors.databaseUrl = \"URL không hợp lệ\";\n    }\n\n    // if (!settings.customPrompt?.trim()) {\n    //   errors.customPrompt = \"Custom Prompt là bắt buộc\";\n    // } else if (settings.customPrompt.trim().length < 10) {\n    //   errors.customPrompt = \"Custom Prompt phải có ít nhất 10 ký tự\";\n    // }\n\n    return {\n      isValid: Object.keys(errors).length === 0,\n      errors,\n    };\n  }\n\n  /**\n   * Check if URL is valid\n   * @param {string} url - URL to validate\n   * @returns {boolean} Is valid URL\n   */\n  static isValidUrl(url) {\n    try {\n      new URL(url);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * Validate Confluence page link (có pageId)\n   * @param {string} link - Link Confluence để kiểm tra\n   * @returns {Object} { valid: boolean, error?: string, pageId?: string }\n   */\n  static validateConfluencePageLink(link) {\n    const out = { valid: false, error: null, pageId: null };\n\n    if (!link || typeof link !== \"string\" || !link.trim()) {\n      out.error = \"URL là bắt buộc\";\n      return out;\n    }\n\n    let u;\n    try {\n      u = new URL(link.trim());\n    } catch {\n      out.error = \"URL không hợp lệ\";\n      return out;\n    }\n\n    // check pageId in query param\n    const pageIdParam = u.searchParams.get(\"pageId\");\n    if (pageIdParam && /^\\d+$/.test(pageIdParam)) {\n      out.valid = true;\n      out.pageId = pageIdParam;\n      return out;\n    }\n\n    // check pageId in path (/pages/{id})\n    const pathParts = u.pathname.split(\"/\");\n    const pagesIndex = pathParts.indexOf(\"pages\");\n    if (pagesIndex >= 0 && pathParts.length > pagesIndex + 1) {\n      const candidate = pathParts[pagesIndex + 1];\n      if (/^\\d+$/.test(candidate)) {\n        out.valid = true;\n        out.pageId = candidate;\n        return out;\n      }\n    }\n\n    out.error = \"Không tìm thấy pageId trong URL\";\n    return out;\n  }\n}\n","// K-Tool Extension Constants\nexport const EXTENSION_SETTINGS_KEY = 'extensionSettings';\n\n// API URLs\nconst isLocal = true;\nconst rootUrl = isLocal ? 'http://localhost:5001' : 'https://gendoc.thangnotes.dev';\n\nexport const API_URLS = {\n  GEN_DOC: `${rootUrl}/api/generate-full-confluence-doc`,\n  GEN_DOC_STATUS: `${rootUrl}/api/generate-status`,\n  GEN_DOC_RESULT: `${rootUrl}/api/generate-result`,\n  EDIT_DIAGRAM: `${rootUrl}/api/edit-diagram`,\n  EDIT_TEXT: `${rootUrl}/api/edit-text`\n};\n\n// Default settings\nexport const DEFAULT_SETTINGS = {\n  apiKey: '',\n  urlTemplate: '',\n  customPrompt: '',\n  documentUrl: '',\n  databaseUrl: '',\n  instructionUrl: '',\n  isEnabled: true,\n  selectedModel: 'sonar-pro'\n};\n\n// AI Models\nexport const AI_MODELS = {\n  'sonar-pro': {\n    name: 'Sonar Pro',\n    provider: 'Perplexity',\n    description: 'Perplexity AI Sonar Pro model'\n  },\n  'gemini': {\n    name: 'Gemini 2.0 Flash',\n    provider: 'Google',\n    description: 'Google Gemini 2.0 Flash model'\n  }\n};\n\n// Progress steps for document generation\nexport const PROGRESS_STEPS = [\n  { id: 'fetch', label: 'Lấy nội dung BA', status: 'pending' },\n  { id: 'clone', label: 'Clone template', status: 'pending' },\n  { id: 'analyze', label: 'Phân tích placeholders', status: 'pending' },\n  { id: 'generate', label: 'AI sinh tài liệu', status: 'pending' },\n  { id: 'complete', label: 'Hoàn thành', status: 'pending' }\n];\n\n// Validation patterns\nexport const VALIDATION = {\n  URL_PATTERN: /^https?:\\/\\/.+/,\n  PLACEHOLDER_PATTERN: /<<([^>]+)>>/g,\n  MIN_PROMPT_LENGTH: 10\n};\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// K-Tool Extension Content Script\r\nimport { ApiClient, ConfluenceApi } from \"../shared/api.js\";\r\nimport { PROGRESS_STEPS } from \"../shared/constants.js\";\r\nimport { StorageManager } from \"../shared/storage.js\";\r\nimport { ConfluenceEditor } from \"./confluenceEditor.js\";\r\n\r\nclass KToolContent {\r\n  constructor() {\r\n    this.settings = {};\r\n    this.isModalOpen = false;\r\n    this.currentTab = \"generate\";\r\n    this.generationJob = null;\r\n    this.progressSteps = [...PROGRESS_STEPS];\r\n    this.confluenceEditor = null;\r\n    this.init();\r\n  }\r\n\r\n  async init() {\r\n    console.log(\"🚀 K-Tool Content Script initializing...\");\r\n\r\n    // Check if already injected\r\n    if (document.getElementById(\"ktool-root\")) {\r\n      console.log(\"🔍 K-Tool already injected, skipping...\");\r\n      return;\r\n    }\r\n\r\n    // Load settings\r\n    await this.loadSettings();\r\n\r\n    // Inject UI\r\n    this.injectUI();\r\n\r\n    // Bind events\r\n    this.bindEvents();\r\n\r\n    // Initialize Confluence Editor\r\n    try {\r\n      console.log(\"🔧 Initializing ConfluenceEditor...\");\r\n      this.confluenceEditor = new ConfluenceEditor();\r\n      console.log(\"✅ ConfluenceEditor initialized:\", this.confluenceEditor);\r\n    } catch (error) {\r\n      console.error(\"❌ Error initializing ConfluenceEditor:\", error);\r\n      this.confluenceEditor = null;\r\n    }\r\n\r\n    // Make available globally for debugging\r\n    window.ktoolContent = this;\r\n\r\n    console.log(\"✅ K-Tool Content Script ready\");\r\n  }\r\n\r\n  async loadSettings() {\r\n    try {\r\n      this.settings = await StorageManager.getSettings();\r\n      console.log(\"⚙️ Settings loaded:\", this.settings);\r\n    } catch (error) {\r\n      console.error(\"❌ Error loading settings:\", error);\r\n    }\r\n  }\r\n\r\n  injectUI() {\r\n    // Create root container\r\n    const root = document.createElement(\"div\");\r\n    root.id = \"ktool-root\";\r\n    document.body.appendChild(root);\r\n\r\n    // Create bubble button\r\n    const bubble = this.createBubble();\r\n    root.appendChild(bubble);\r\n\r\n    // Create modal (initially hidden)\r\n    const modal = this.createModal();\r\n    root.appendChild(modal);\r\n  }\r\n\r\n  createBubble() {\r\n    const bubble = document.createElement(\"div\");\r\n    bubble.className = `ktool-bubble ${\r\n      !this.settings.isEnabled ? \"disabled\" : \"\"\r\n    }`;\r\n\r\n    bubble.innerHTML = `\r\n      <div class=\"ktool-bubble-icon\">K</div>\r\n      <div class=\"ktool-tooltip\">\r\n        ${\r\n          this.settings.isEnabled\r\n            ? \"🚀 K-Tool Document Generator<br/>Click để mở công cụ sinh tài liệu\"\r\n            : \"⚠️ K-Tool đã tắt<br/>Vui lòng bật trong settings\"\r\n        }\r\n      </div>\r\n    `;\r\n\r\n    bubble.addEventListener(\"click\", () => {\r\n      if (this.settings.isEnabled) {\r\n        this.openModal();\r\n      } else {\r\n        this.showNotification(\r\n          \"K-Tool đã tắt. Vui lòng bật trong extension settings.\",\r\n          \"warning\"\r\n        );\r\n      }\r\n    });\r\n\r\n    return bubble;\r\n  }\r\n\r\n  createModal() {\r\n    const overlay = document.createElement(\"div\");\r\n    overlay.className = \"ktool-modal-overlay\";\r\n\r\n    overlay.innerHTML = `\r\n      <div class=\"ktool-modal\">\r\n        <div class=\"ktool-modal-header\">\r\n          <h2 class=\"ktool-modal-title\">K-Tool Document Generator</h2>\r\n          <button class=\"ktool-modal-close\" type=\"button\">&times;</button>\r\n        </div>\r\n        <div class=\"ktool-modal-body\">\r\n          <div class=\"ktool-tabs\">\r\n            <button class=\"ktool-tab active\" data-tab=\"generate\">📄 Sinh tài liệu</button>\r\n            <button class=\"ktool-tab\" data-tab=\"preview\">👁️ Preview</button>\r\n            <button class=\"ktool-tab\" data-tab=\"settings\">⚙️ Settings</button>\r\n          </div>\r\n          \r\n          <!-- Generate Tab -->\r\n          <div class=\"ktool-tab-content active\" data-tab=\"generate\">\r\n            ${this.createGenerateTab()}\r\n          </div>\r\n          \r\n          <!-- Preview Tab -->\r\n          <div class=\"ktool-tab-content\" data-tab=\"preview\" id=\"previewTab\">\r\n            ${this.createPreviewTab()}\r\n          </div>\r\n          \r\n          <!-- Settings Tab -->\r\n          <div class=\"ktool-tab-content\" data-tab=\"settings\">\r\n            ${this.createSettingsTab()}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    return overlay;\r\n  }\r\n\r\n  createGenerateTab() {\r\n    return `\r\n      <div class=\"ktool-form\">\r\n        <div class=\"ktool-form-group\">\r\n          <label class=\"ktool-form-label\">URL tài liệu BA *</label>\r\n          <input \r\n            type=\"url\" \r\n            class=\"ktool-form-input\" \r\n            id=\"baDocUrl\" \r\n            placeholder=\"https://confluence.com/pages/123456\"\r\n            value=\"${window.location.href}\"\r\n          >\r\n        </div>\r\n        \r\n        <div class=\"ktool-form-group\">\r\n          <label class=\"ktool-form-label\">Ghi chú thêm (tùy chọn)</label>\r\n          <textarea \r\n            class=\"ktool-form-textarea\" \r\n            id=\"additionalNotes\" \r\n            placeholder=\"Thêm ghi chú hoặc yêu cầu đặc biệt...\"\r\n            rows=\"3\"\r\n          ></textarea>\r\n        </div>\r\n        \r\n        <div style=\"display: flex; gap: 12px; margin-top: 20px;\">\r\n          <button class=\"ktool-btn ktool-btn-primary\" id=\"generateBtn\">\r\n            🔧 Tạo tài liệu\r\n          </button>\r\n          <button class=\"ktool-btn ktool-btn-secondary\" id=\"resetBtn\">\r\n            🔄 Reset\r\n          </button>\r\n        </div>\r\n      </div>\r\n      \r\n      <!-- Progress Section -->\r\n      <div class=\"ktool-progress\" id=\"progressSection\" style=\"display: none;\">\r\n        <h3 style=\"margin: 0 0 16px 0; font-size: 16px;\">Tiến trình sinh tài liệu:</h3>\r\n        <div id=\"progressSteps\"></div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  createPreviewTab() {\r\n    return `\r\n      <div class=\"ktool-form\">\r\n        <div style=\"text-align: center; padding: 40px; color: #6c757d;\">\r\n          <div style=\"font-size: 48px; margin-bottom: 16px;\">📄</div>\r\n          <h3 style=\"margin: 0 0 8px 0;\">Chưa có nội dung để preview</h3>\r\n          <p style=\"margin: 0;\">Vui lòng sinh tài liệu trước khi preview.</p>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  createSettingsTab() {\r\n    return `\r\n      <div class=\"ktool-form\">\r\n        <div style=\"text-align: center; padding: 40px; color: #6c757d;\">\r\n          <div style=\"font-size: 48px; margin-bottom: 16px;\">⚙️</div>\r\n          <h3 style=\"margin: 0 0 8px 0;\">Cài đặt Extension</h3>\r\n          <p style=\"margin: 0 0 16px 0;\">Click vào icon extension trên toolbar để cài đặt.</p>\r\n          <button class=\"ktool-btn ktool-btn-primary\" onclick=\"chrome.runtime.openOptionsPage?.() || alert('Vui lòng click vào icon K-Tool trên toolbar để cài đặt')\">\r\n            🔧 Mở Settings\r\n          </button>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  bindEvents() {\r\n    const modal = document.querySelector(\".ktool-modal-overlay\");\r\n\r\n    // Close modal events\r\n    modal.querySelector(\".ktool-modal-close\").addEventListener(\"click\", () => {\r\n      this.closeModal();\r\n    });\r\n\r\n    modal.addEventListener(\"click\", (e) => {\r\n      if (e.target === modal) {\r\n        this.closeModal();\r\n      }\r\n    });\r\n\r\n    // Tab switching\r\n    const tabs = modal.querySelectorAll(\".ktool-tab\");\r\n    tabs.forEach((tab) => {\r\n      tab.addEventListener(\"click\", () => {\r\n        this.switchTab(tab.dataset.tab);\r\n      });\r\n    });\r\n\r\n    // Generate button\r\n    const generateBtn = modal.querySelector(\"#generateBtn\");\r\n    generateBtn.addEventListener(\"click\", () => {\r\n      this.handleGenerate();\r\n    });\r\n\r\n    // Reset button\r\n    const resetBtn = modal.querySelector(\"#resetBtn\");\r\n    resetBtn.addEventListener(\"click\", () => {\r\n      this.handleReset();\r\n    });\r\n\r\n    // Listen for settings changes from background\r\n    chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {\r\n      if (request.action === \"settingsChanged\") {\r\n        this.settings = request.settings;\r\n        this.updateBubbleState();\r\n      }\r\n    });\r\n\r\n    // Keyboard shortcuts\r\n    document.addEventListener(\"keydown\", (e) => {\r\n      // Escape to close modal\r\n      if (e.key === \"Escape\" && this.isModalOpen) {\r\n        this.closeModal();\r\n      }\r\n\r\n      // Ctrl/Cmd + K to open modal\r\n      if ((e.ctrlKey || e.metaKey) && e.key === \"k\" && !this.isModalOpen) {\r\n        e.preventDefault();\r\n        if (this.settings.isEnabled) {\r\n          this.openModal();\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  openModal() {\r\n    const modal = document.querySelector(\".ktool-modal-overlay\");\r\n    modal.classList.add(\"show\");\r\n    this.isModalOpen = true;\r\n\r\n    // Focus first input\r\n    setTimeout(() => {\r\n      const firstInput = modal.querySelector(\".ktool-form-input\");\r\n      if (firstInput) firstInput.focus();\r\n    }, 300);\r\n  }\r\n\r\n  closeModal() {\r\n    const modal = document.querySelector(\".ktool-modal-overlay\");\r\n    modal.classList.remove(\"show\");\r\n    this.isModalOpen = false;\r\n  }\r\n\r\n  switchTab(tabName) {\r\n    // Update tab buttons\r\n    const tabs = document.querySelectorAll(\".ktool-tab\");\r\n    tabs.forEach((tab) => {\r\n      tab.classList.toggle(\"active\", tab.dataset.tab === tabName);\r\n    });\r\n\r\n    // Update tab content\r\n    const contents = document.querySelectorAll(\".ktool-tab-content\");\r\n    contents.forEach((content) => {\r\n      content.classList.toggle(\"active\", content.dataset.tab === tabName);\r\n    });\r\n\r\n    this.currentTab = tabName;\r\n  }\r\n\r\n  updateBubbleState() {\r\n    const bubble = document.querySelector(\".ktool-bubble\");\r\n    const tooltip = bubble.querySelector(\".ktool-tooltip\");\r\n\r\n    if (this.settings.isEnabled) {\r\n      bubble.classList.remove(\"disabled\");\r\n      tooltip.innerHTML =\r\n        \"🚀 K-Tool Document Generator<br/>Click để mở công cụ sinh tài liệu\";\r\n    } else {\r\n      bubble.classList.add(\"disabled\");\r\n      tooltip.innerHTML = \"⚠️ K-Tool đã tắt<br/>Vui lòng bật trong settings\";\r\n    }\r\n  }\r\n\r\n  async handleGenerate() {\r\n    const baDocUrl = document.getElementById(\"baDocUrl\").value.trim();\r\n    const additionalNotes = document\r\n      .getElementById(\"additionalNotes\")\r\n      .value.trim();\r\n\r\n    if (!baDocUrl) {\r\n      this.showNotification(\"Vui lòng nhập URL tài liệu BA!\", \"error\");\r\n      return;\r\n    }\r\n\r\n    // Validate settings\r\n    const validation = StorageManager.validateSettings(this.settings);\r\n    if (!validation.isValid) {\r\n      this.showNotification(\r\n        \"Vui lòng cấu hình đầy đủ settings trước khi sinh tài liệu!\",\r\n        \"error\"\r\n      );\r\n      this.switchTab(\"settings\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Show progress\r\n      this.showProgress();\r\n      this.updateProgress(0, \"active\");\r\n\r\n      // Step 1: Extract page ID and fetch BA content\r\n      const pageId = ConfluenceApi.extractPageId(baDocUrl);\r\n      if (!pageId) {\r\n        throw new Error(\r\n          \"❌ URL không hợp lệ! Vui lòng kiểm tra lại URL Confluence page.\"\r\n        );\r\n      }\r\n\r\n      console.log(\"🔍 Fetching content for pageId:\", pageId);\r\n      const baDocument = await ConfluenceApi.fetchPageContent(pageId);\r\n      if (!baDocument) {\r\n        throw new Error(\"❌ Không thể lấy nội dung tài liệu BA!\");\r\n      }\r\n\r\n      // Extract images from BA content (HTML) and convert all to base64\r\n      const images = await ConfluenceApi.extractImagesFromHtml(\r\n        baDocument.content\r\n      );\r\n      console.log(\"🖼️ Extracted images (all base64):\", images);\r\n\r\n      this.updateProgress(0, \"completed\");\r\n      this.updateProgress(1, \"active\");\r\n\r\n      // Step 2: Clone template structure\r\n      if (!this.settings.urlTemplate) {\r\n        throw new Error(\"⚠️ Vui lòng setting template của tài liệu!\");\r\n      }\r\n\r\n      console.log(\"🔄 Cloning template from:\", this.settings.urlTemplate);\r\n      const clonedTemplate = await ConfluenceApi.cloneTemplateForGeneration(\r\n        this.settings.urlTemplate\r\n      );\r\n\r\n      if (!clonedTemplate) {\r\n        throw new Error(\r\n          \"❌ Không thể clone template! Vui lòng kiểm tra URL template trong Settings.\"\r\n        );\r\n      }\r\n\r\n      console.log(\"✅ Template cloned successfully:\", clonedTemplate.title);\r\n      this.updateProgress(1, \"completed\");\r\n      this.updateProgress(2, \"active\");\r\n\r\n      // Step 3: Analyze placeholders with << >>\r\n      const placeholders = ConfluenceApi.extractPlaceholders(\r\n        clonedTemplate.originalStorageFormat\r\n      );\r\n      console.log(\"🔍 Found placeholders <<>>:\", placeholders);\r\n\r\n      if (placeholders.length === 0) {\r\n        throw new Error(\r\n          \"⚠️ Không tìm thấy placeholder nào có dạng <<Tên>>. Vui lòng kiểm tra template!\"\r\n        );\r\n      }\r\n\r\n      this.updateProgress(2, \"completed\");\r\n      this.updateProgress(3, \"active\");\r\n\r\n      // Get instructions if available\r\n      let instructions = \"\";\r\n      if (this.settings.instructionUrl) {\r\n        const instructionPageId = ConfluenceApi.extractPageId(\r\n          this.settings.instructionUrl\r\n        );\r\n        if (instructionPageId) {\r\n          console.log(\r\n            \"🔍 Fetching instruction content for pageId:\",\r\n            instructionPageId\r\n          );\r\n          const instructionDoc = await ConfluenceApi.fetchPageContent(\r\n            instructionPageId\r\n          );\r\n          instructions = instructionDoc?.content || \"\";\r\n        } else {\r\n          console.warn(\r\n            \"⚠️ Invalid instruction URL:\",\r\n            this.settings.instructionUrl\r\n          );\r\n        }\r\n      }\r\n\r\n      // Step 4: AI Fill Placeholders (Send request and get job_id)\r\n      const payload = {\r\n        ba_content: baDocument.content,\r\n        template_structure: clonedTemplate.templateStructure,\r\n        original_storage_format: clonedTemplate.originalStorageFormat,\r\n        instructions: instructions,\r\n        additional_prompt: this.settings.customPrompt || \"\",\r\n        placeholders: placeholders,\r\n        selectedModel: this.settings.selectedModel,\r\n        images,\r\n        additional_notes: additionalNotes,\r\n      };\r\n\r\n      console.log(\"📤 Sending payload for placeholder filling:\", {\r\n        ba_content_length: payload.ba_content.length,\r\n        template_structure_length: payload.template_structure.length,\r\n        original_format_length: payload.original_storage_format.length,\r\n        placeholders_found: placeholders.length,\r\n        placeholders_list: placeholders,\r\n      });\r\n\r\n      // Send request and get job_id\r\n      const jobResponse = await ApiClient.generateDocument(payload);\r\n      const jobId = jobResponse.data.job_id;\r\n      if (!jobId) {\r\n        throw new Error(\r\n          jobResponse.error || \"Không nhận được job_id từ server!\"\r\n        );\r\n      }\r\n\r\n      this.currentJobId = jobId;\r\n\r\n      // Start polling for result\r\n      await this.pollGenerationResult(jobId, payload);\r\n    } catch (error) {\r\n      console.error(\"❌ Generation error:\", error);\r\n      this.showNotification(`Lỗi sinh tài liệu: ${error.message}`, \"error\");\r\n      this.hideProgress();\r\n    }\r\n  }\r\n\r\n  // These methods are now handled by ConfluenceApi class\r\n  // Keeping them for backward compatibility if needed\r\n\r\n  async pollGenerationResult(jobId, payload) {\r\n    const maxAttempts = 20; // 10 minutes max (60 * 10 seconds)\r\n    let attempts = 0;\r\n\r\n    const poll = async () => {\r\n      attempts++;\r\n\r\n      try {\r\n        console.log(\r\n          `🔄 Polling attempt ${attempts}/${maxAttempts} for job ${jobId}`\r\n        );\r\n\r\n        const statusResult = await ApiClient.checkStatus(jobId);\r\n        console.log(`statusResult: ${statusResult}`);\r\n\r\n        if (!statusResult.success) {\r\n          throw new Error(\"Lỗi kiểm tra trạng thái job\");\r\n        }\r\n\r\n        const status = statusResult.data.status;\r\n\r\n        if (status === \"done\") {\r\n          console.log(\"✅ Generation completed!\");\r\n\r\n          const result = await ApiClient.getResult(jobId);\r\n          const resultString = JSON.stringify(result, null, 2);\r\n\r\n          console.log(`Document generate:\\n${resultString}`);\r\n          if (result.success) {\r\n            this.handleGenerationComplete(result.data.result);\r\n            return;\r\n          } else {\r\n            throw new Error(\"Lỗi lấy kết quả sinh tài liệu\");\r\n          }\r\n        } else if (status === \"error\") {\r\n          throw new Error(\"Job sinh tài liệu thất bại trên server\");\r\n        } else if (attempts >= maxAttempts) {\r\n          throw new Error(\r\n            \"⏰ Timeout: Quá trình sinh tài liệu mất quá nhiều thời gian. Vui lòng thử lại.\"\r\n          );\r\n        } else {\r\n          // Update progress message if available\r\n          if (statusResult.data.progress_message) {\r\n            console.log(`📝 Progress: ${statusResult.data.progress_message}`);\r\n          }\r\n\r\n          // Continue polling\r\n          setTimeout(poll, 10000); // Poll every 10 seconds\r\n        }\r\n      } catch (error) {\r\n        console.error(\"❌ Polling error:\", error);\r\n        this.showNotification(\r\n          `Lỗi trong quá trình sinh tài liệu: ${error.message}`,\r\n          \"error\"\r\n        );\r\n        this.hideProgress();\r\n        this.currentJobId = null;\r\n        throw error;\r\n      }\r\n    };\r\n\r\n    await poll();\r\n  }\r\n\r\n  handleGenerationComplete(result) {\r\n    this.updateProgress(3, \"completed\");\r\n    this.updateProgress(4, \"completed\");\r\n\r\n    // Store result for preview\r\n    this.generatedContent = result;\r\n    console.log(\"✅ Generated content:\", result);\r\n    // Switch to preview tab\r\n    this.switchTab(\"preview\");\r\n    this.updatePreviewTab(result);\r\n\r\n    this.showNotification(\"Sinh tài liệu thành công!\", \"success\");\r\n    this.hideProgress();\r\n  }\r\n\r\n  updatePreviewTab(content) {\r\n    const previewTab = document.getElementById(\"previewTab\");\r\n    previewTab.innerHTML = `\r\n      <div class=\"ktool-form\">\r\n        <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;\">\r\n          <h3 style=\"margin: 0;\">Preview Tài liệu</h3>\r\n          <div style=\"display: flex; gap: 12px;\">\r\n            <button class=\"ktool-btn ktool-btn-secondary\" id=\"editContentBtn\">\r\n              ✏️ Chỉnh sửa nội dung\r\n            </button>\r\n            <button class=\"ktool-btn ktool-btn-primary\" id=\"createPageBtn\">\r\n              📄 Tạo trang Confluence\r\n            </button>\r\n            <button class=\"ktool-btn ktool-btn-secondary\" id=\"downloadBtn\">\r\n              💾 Tải xuống\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        <div id=\"documentPreview\" style=\"border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; background: #f8f9fa; max-height: 400px; overflow-y: auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6;\">\r\n          ${content.full_storage_format || \"<p>Không có nội dung</p>\"}\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    // Bind preview buttons\r\n    const editContentBtn = previewTab.querySelector(\"#editContentBtn\");\r\n    const createPageBtn = previewTab.querySelector(\"#createPageBtn\");\r\n    const downloadBtn = previewTab.querySelector(\"#downloadBtn\");\r\n\r\n    editContentBtn.addEventListener(\"click\", () =>\r\n      this.handleEditContent(content)\r\n    );\r\n    createPageBtn.addEventListener(\"click\", () => this.handleCreatePage());\r\n    downloadBtn.addEventListener(\"click\", () => this.handleDownload());\r\n\r\n    // Initialize Mermaid diagrams after content is loaded\r\n    setTimeout(() => {\r\n      this.initializeMermaid();\r\n    }, 100);\r\n  }\r\n\r\n  async handleCreatePage() {\r\n    try {\r\n      const spaceKey = ConfluenceApi.getCurrentSpaceKey();\r\n      if (!spaceKey) {\r\n        throw new Error(\"Không thể xác định space key của trang hiện tại\");\r\n      }\r\n\r\n      const title = `K-Tool Generated Document - ${new Date().toLocaleDateString()}`;\r\n      const content =\r\n        this.generatedContent.full_storage_format ||\r\n        this.generatedContent.content;\r\n\r\n      // Extract parent page ID from settings if available\r\n      let parentId = null;\r\n      if (this.settings.documentUrl) {\r\n        parentId = ConfluenceApi.extractPageId(this.settings.documentUrl);\r\n      }\r\n\r\n      const result = await ConfluenceApi.createPage(\r\n        title,\r\n        content,\r\n        spaceKey,\r\n        parentId\r\n      );\r\n\r\n      this.showNotification(\"Tạo trang Confluence thành công!\", \"success\");\r\n\r\n      // Optionally redirect to new page\r\n      if (result.id) {\r\n        const newPageUrl = `${window.location.origin}/pages/${result.id}`;\r\n        if (confirm(\"Bạn có muốn chuyển đến trang vừa tạo không?\")) {\r\n          window.open(newPageUrl, \"_blank\");\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"❌ Create page error:\", error);\r\n      this.showNotification(`Lỗi tạo trang: ${error.message}`, \"error\");\r\n    }\r\n  }\r\n\r\n  handleDownload() {\r\n    const content =\r\n      this.generatedContent.full_storage_format ||\r\n      this.generatedContent.content;\r\n    const blob = new Blob([content], { type: \"text/html\" });\r\n    const url = URL.createObjectURL(blob);\r\n\r\n    const a = document.createElement(\"a\");\r\n    a.href = url;\r\n    a.download = `ktool-document-${Date.now()}.html`;\r\n    document.body.appendChild(a);\r\n    a.click();\r\n    document.body.removeChild(a);\r\n    URL.revokeObjectURL(url);\r\n\r\n    this.showNotification(\"Tải xuống thành công!\", \"success\");\r\n  }\r\n\r\n  handleEditContent(content) {\r\n    console.log(\"✏️ Opening content editor...\");\r\n    console.log(\"🔍 Content to edit:\", content);\r\n    console.log(\"🔍 ConfluenceEditor instance:\", this.confluenceEditor);\r\n\r\n    if (!this.confluenceEditor) {\r\n      console.error(\"❌ ConfluenceEditor is null or undefined\");\r\n      this.showNotification(\"Confluence Editor chưa được khởi tạo!\", \"error\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Set up save callback to update the generated content\r\n      this.confluenceEditor.setSaveCallback((updatedContent) => {\r\n        console.log(\"💾 Content updated:\", updatedContent);\r\n\r\n        // Update the stored generated content\r\n        this.generatedContent = updatedContent;\r\n\r\n        // Refresh the preview tab with updated content\r\n        this.updatePreviewTab(updatedContent);\r\n\r\n        this.showNotification(\"Nội dung đã được cập nhật!\", \"success\");\r\n      });\r\n\r\n      // Open the editor with current content\r\n      console.log(\"🚀 Opening ConfluenceEditor...\");\r\n      this.confluenceEditor.openEditor(content, {\r\n        title: \"Chỉnh sửa tài liệu đã sinh\",\r\n        showMermaidTools: true,\r\n      });\r\n      console.log(\"✅ ConfluenceEditor opened successfully\");\r\n    } catch (error) {\r\n      console.error(\"❌ Error opening ConfluenceEditor:\", error);\r\n      this.showNotification(`Lỗi mở editor: ${error.message}`, \"error\");\r\n    }\r\n  }\r\n\r\n  handleReset() {\r\n    if (confirm(\"Bạn có chắc muốn reset form?\")) {\r\n      document.getElementById(\"baDocUrl\").value = window.location.href;\r\n      document.getElementById(\"additionalNotes\").value = \"\";\r\n      this.hideProgress();\r\n      this.switchTab(\"generate\");\r\n    }\r\n  }\r\n\r\n  showProgress() {\r\n    const progressSection = document.getElementById(\"progressSection\");\r\n    const progressSteps = document.getElementById(\"progressSteps\");\r\n\r\n    progressSteps.innerHTML = this.progressSteps\r\n      .map(\r\n        (step, index) => `\r\n      <div class=\"ktool-progress-step ${step.status}\" data-step=\"${index}\">\r\n        <div class=\"ktool-progress-icon\">${index + 1}</div>\r\n        <span>${step.label}</span>\r\n      </div>\r\n    `\r\n      )\r\n      .join(\"\");\r\n\r\n    progressSection.style.display = \"block\";\r\n  }\r\n\r\n  hideProgress() {\r\n    const progressSection = document.getElementById(\"progressSection\");\r\n    progressSection.style.display = \"none\";\r\n\r\n    // Reset progress steps\r\n    this.progressSteps = this.progressSteps.map((step) => ({\r\n      ...step,\r\n      status: \"pending\",\r\n    }));\r\n  }\r\n\r\n  updateProgress(stepIndex, status) {\r\n    this.progressSteps[stepIndex].status = status;\r\n\r\n    const stepElement = document.querySelector(`[data-step=\"${stepIndex}\"]`);\r\n    if (stepElement) {\r\n      stepElement.className = `ktool-progress-step ${status}`;\r\n\r\n      const icon = stepElement.querySelector(\".ktool-progress-icon\");\r\n      if (status === \"completed\") {\r\n        icon.textContent = \"✓\";\r\n      } else if (status === \"error\") {\r\n        icon.textContent = \"✗\";\r\n      } else if (status === \"active\") {\r\n        icon.innerHTML = '<div class=\"ktool-spinning\">⏳</div>';\r\n      }\r\n    }\r\n  }\r\n\r\n  showNotification(message, type = \"info\") {\r\n    // Create notification element\r\n    const notification = document.createElement(\"div\");\r\n    notification.style.cssText = `\r\n      position: fixed;\r\n      top: 20px;\r\n      right: 20px;\r\n      background: ${\r\n        type === \"success\"\r\n          ? \"#28a745\"\r\n          : type === \"error\"\r\n          ? \"#dc3545\"\r\n          : \"#007bff\"\r\n      };\r\n      color: white;\r\n      padding: 12px 20px;\r\n      border-radius: 8px;\r\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);\r\n      z-index: 1000002;\r\n      font-size: 14px;\r\n      max-width: 300px;\r\n      word-wrap: break-word;\r\n      opacity: 0;\r\n      transform: translateX(100%);\r\n      transition: all 0.3s;\r\n    `;\r\n\r\n    notification.textContent = message;\r\n    document.body.appendChild(notification);\r\n\r\n    // Animate in\r\n    setTimeout(() => {\r\n      notification.style.opacity = \"1\";\r\n      notification.style.transform = \"translateX(0)\";\r\n    }, 100);\r\n\r\n    // Auto remove\r\n    setTimeout(() => {\r\n      notification.style.opacity = \"0\";\r\n      notification.style.transform = \"translateX(100%)\";\r\n      setTimeout(() => {\r\n        if (notification.parentNode) {\r\n          notification.parentNode.removeChild(notification);\r\n        }\r\n      }, 300);\r\n    }, 5000);\r\n  }\r\n\r\n  async loadMermaidScript() {\r\n    if (window.mermaid) {\r\n      console.log(\"⚡ Mermaid already loaded\");\r\n      return window.mermaid;\r\n    }\r\n\r\n    const res = await fetch(chrome.runtime.getURL(\"lib/mermaid.min.js\"));\r\n    const text = await res.text();\r\n    eval(text); // UMD sẽ gắn mermaid vào window\r\n    console.log(\"✅ Mermaid loaded dynamically\");\r\n    return window.mermaid;\r\n  }\r\n\r\n  // Initialize Mermaid diagrams\r\n  async initializeMermaid() {\r\n    try {\r\n      // Load Mermaid if not already loaded\r\n      await this.loadMermaidScript();\r\n\r\n      console.log(\"🎨 Initializing Mermaid diagrams...\");\r\n\r\n      // Configure Mermaid with proper DOM context\r\n      window.mermaid.initialize({\r\n        startOnLoad: false,\r\n        theme: \"default\",\r\n        securityLevel: \"loose\",\r\n        fontFamily: \"Arial, sans-serif\",\r\n        // Ensure proper DOM context\r\n        htmlLabels: true,\r\n        flowchart: {\r\n          htmlLabels: true,\r\n        },\r\n        // Set the document context explicitly\r\n        deterministicIds: true,\r\n        deterministicIDSeed: \"mermaid-diagram\",\r\n      });\r\n\r\n      // Ensure mermaid has access to document\r\n      if (window.mermaid.setConfig) {\r\n        window.mermaid.setConfig({\r\n          securityLevel: \"loose\",\r\n          theme: \"default\",\r\n        });\r\n      }\r\n\r\n      // Find all mermaid code blocks in the preview\r\n      const previewDiv = document.getElementById(\"documentPreview\");\r\n      if (!previewDiv) return;\r\n\r\n      // Look for Confluence Mermaid structured macros\r\n      const mermaidElements = previewDiv.querySelectorAll(\r\n        'ac\\\\:structured-macro[ac\\\\:name=\"mermaid\"]'\r\n      );\r\n\r\n      mermaidElements.forEach((element, index) => {\r\n        // Get the code parameter from Confluence structured macro\r\n        const codeParam = element.querySelector(\r\n          'ac\\\\:parameter[ac\\\\:name=\"code\"]'\r\n        );\r\n        if (!codeParam) {\r\n          console.warn(\"⚠️ Mermaid macro found but no code parameter\");\r\n          return;\r\n        }\r\n\r\n        const mermaidCode = (\r\n          codeParam.textContent || codeParam.innerText\r\n        ).trim();\r\n        console.log(\r\n          \"🔍 Found Confluence Mermaid diagram:\",\r\n          mermaidCode.substring(0, 50) + \"...\"\r\n        );\r\n\r\n        // Always process Confluence mermaid macros (no need to check syntax)\r\n        if (mermaidCode) {\r\n          // Create a new div for the mermaid diagram\r\n          const mermaidDiv = document.createElement(\"div\");\r\n          mermaidDiv.className = \"mermaid-diagram\";\r\n          mermaidDiv.id = `mermaid-${index}`;\r\n          mermaidDiv.style.cssText =\r\n            \"margin: 20px 0; text-align: center; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;\";\r\n\r\n          // Replace the original element\r\n          element.parentNode.replaceChild(mermaidDiv, element);\r\n\r\n          // Render the diagram with proper DOM context\r\n          try {\r\n            const diagramId = `mermaid-svg-${index}`;\r\n\r\n            // Create a temporary container in the document to ensure proper DOM context\r\n            const tempContainer = document.createElement(\"div\");\r\n            tempContainer.style.position = \"absolute\";\r\n            tempContainer.style.left = \"-9999px\";\r\n            tempContainer.style.top = \"-9999px\";\r\n            document.body.appendChild(tempContainer);\r\n\r\n            // Modern mermaid.render returns a promise\r\n            if (\r\n              window.mermaid.render &&\r\n              typeof window.mermaid.render === \"function\"\r\n            ) {\r\n              try {\r\n                // Try modern API first\r\n                const renderResult = window.mermaid.render(\r\n                  diagramId,\r\n                  mermaidCode\r\n                );\r\n\r\n                if (renderResult && typeof renderResult.then === \"function\") {\r\n                  // Promise-based API\r\n                  renderResult\r\n                    .then((result) => {\r\n                      // Clean up temp container\r\n                      if (document.body.contains(tempContainer)) {\r\n                        document.body.removeChild(tempContainer);\r\n                      }\r\n\r\n                      // Handle different return formats\r\n                      let svgCode;\r\n                      if (typeof result === \"string\") {\r\n                        svgCode = result;\r\n                      } else if (result && result.svg) {\r\n                        svgCode = result.svg;\r\n                      } else {\r\n                        svgCode = String(result);\r\n                      }\r\n\r\n                      mermaidDiv.innerHTML = svgCode;\r\n                      console.log(\r\n                        \"✅ Mermaid diagram rendered successfully (promise API)\"\r\n                      );\r\n                    })\r\n                    .catch((error) => {\r\n                      // Clean up temp container\r\n                      if (document.body.contains(tempContainer)) {\r\n                        document.body.removeChild(tempContainer);\r\n                      }\r\n                      console.error(\r\n                        \"❌ Mermaid render error (promise API):\",\r\n                        error\r\n                      );\r\n                      this.showMermaidError(mermaidDiv, mermaidCode, error);\r\n                    });\r\n                } else {\r\n                  // Synchronous return or callback-based API\r\n                  if (typeof renderResult === \"string\") {\r\n                    // Clean up temp container\r\n                    if (document.body.contains(tempContainer)) {\r\n                      document.body.removeChild(tempContainer);\r\n                    }\r\n                    mermaidDiv.innerHTML = renderResult;\r\n                    console.log(\r\n                      \"✅ Mermaid diagram rendered successfully (sync API)\"\r\n                    );\r\n                  } else {\r\n                    // Try callback-based API\r\n                    window.mermaid.render(diagramId, mermaidCode, (svgCode) => {\r\n                      // Clean up temp container\r\n                      if (document.body.contains(tempContainer)) {\r\n                        document.body.removeChild(tempContainer);\r\n                      }\r\n                      mermaidDiv.innerHTML = svgCode;\r\n                      console.log(\r\n                        \"✅ Mermaid diagram rendered successfully (callback API)\"\r\n                      );\r\n                    });\r\n                  }\r\n                }\r\n              } catch (renderError) {\r\n                // Clean up temp container\r\n                if (document.body.contains(tempContainer)) {\r\n                  document.body.removeChild(tempContainer);\r\n                }\r\n                throw renderError;\r\n              }\r\n            } else {\r\n              throw new Error(\"Mermaid render function not available\");\r\n            }\r\n          } catch (error) {\r\n            console.error(\"❌ Mermaid render error:\", error);\r\n            this.showMermaidError(mermaidDiv, mermaidCode, error);\r\n          }\r\n        }\r\n      });\r\n    } catch (error) {\r\n      console.error(\"❌ Failed to initialize Mermaid:\", error);\r\n    }\r\n  }\r\n\r\n  // Show Mermaid error in a nice format\r\n  showMermaidError(container, text, error) {\r\n    container.innerHTML = `\r\n      <div style=\"color: #dc3545; padding: 15px; background: #f8d7da; border-radius: 8px; border: 1px solid #f5c6cb; font-family: Arial, sans-serif;\">\r\n        <div style=\"font-weight: bold; margin-bottom: 8px; display: flex; align-items: center;\">\r\n          <span style=\"margin-right: 8px;\">⚠️</span>\r\n          Mermaid Render Error\r\n        </div>\r\n        <div style=\"font-size: 12px; color: #721c24; margin-bottom: 10px;\">\r\n          ${error.message || \"Unknown error occurred\"}\r\n        </div>\r\n        <details style=\"margin-top: 10px;\">\r\n          <summary style=\"cursor: pointer; font-size: 12px; color: #495057;\">Show diagram code</summary>\r\n          <pre style=\"margin: 8px 0 0 0; padding: 8px; background: #fff; border: 1px solid #dee2e6; border-radius: 4px; font-size: 11px; overflow-x: auto; white-space: pre-wrap;\">${text}</pre>\r\n        </details>\r\n      </div>\r\n    `;\r\n  }\r\n}\r\n\r\n// Initialize when DOM is ready\r\nif (document.readyState === \"loading\") {\r\n  document.addEventListener(\"DOMContentLoaded\", () => {\r\n    new KToolContent();\r\n  });\r\n} else {\r\n  new KToolContent();\r\n}\r\n"],"names":["ApiClient","request","url","options","response","fetch","headers","ok","Error","status","statusText","success","data","json","error","console","message","generateDocument","payload","this","API_URLS","GEN_DOC","method","body","JSON","stringify","checkStatus","jobId","GEN_DOC_STATUS","getResult","GEN_DOC_RESULT","editText","EDIT_TEXT","ConfluenceApi","extractPageId","patterns","pattern","match","getCurrentSpaceKey","spaceKeyMeta","document","querySelector","content","spaceKeyElement","dataset","spaceKey","urlMatch","window","location","pathname","fetchPageContent","pageId","_data$body","_data$body2","_data$body3","_data$body4","log","apiUrl","Accept","errorText","text","id","title","hasStorage","storage","value","hasView","view","storageFormat","cloneTemplateForGeneration","_data$body5","_data$body6","trim","extractPageIdFromUrl","originalStorageFormat","length","templateStructure","analysisInfo","extractTemplateStructure","result","originalLength","structureLength","analysis","emptyParagraphs","emptyTableCells","placeholders","structure","forEach","regex","index","matches","matchAll","totalLength","extractPlaceholders","substring","decodedContent","replace","allMatches","testContent","contentIndex","patternIndex","map","m","push","uniquePlaceholders","Set","extractImagesFromHtml","html","images","imgTags","DOMParser","parseFromString","querySelectorAll","img","Array","from","src","getAttribute","filename","base64src","startsWith","Date","now","base64","fname","urlToBase64","alt","undefined","e","warn","getFilenameFromUrl","blob","Promise","resolve","reject","reader","FileReader","onloadend","onerror","readAsDataURL","URL","lastIndexOf","createPage","parentId","type","space","key","representation","ancestors","ConfluenceEditor","constructor","isEditorOpen","currentContent","originalContent","mermaidDiagrams","editorContainer","textEditor","previewContainer","isPreviewMode","autoSaveTimer","openEditor","closeEditor","parse","extractMermaidDiagrams","createEditorUI","initializeContentTab","overlay","createElement","className","innerHTML","appendChild","bindEditorEvents","addEventListener","saveChanges","contentTab","mermaidTab","switchTab","rawEditor","updateContentPreview","mermaidSelector","mermaidCodeEditor","aiSendBtn","aiPromptInput","selectMermaidDiagram","target","updateMermaidPreview","sendAIPrompt","handleEsc","removeEventListener","tabName","tab","classList","remove","activeTab","add","activeContent","initializeMermaidTab","rawContent","full_storage_format","formatXHTML","populateMermaidSelector","xmlString","indent","rootTag","wrappedXml","doc","getElementsByTagName","output","rootElement","documentElement","processNode","node","level","nodeType","Node","ELEMENT_NODE","nodeName","startTag","attributes","attr","name","childNodes","some","child","TEXT_NODE","textContent","nextLevel","COMMENT_NODE","CDATA_SECTION_NODE","isSelfClosingTag","tag","t","preview","renderContentPreview","previewElement","processedContent","renderMermaidDiagramsInPreview","loadMermaidScript","mermaid","res","chrome","runtime","getURL","eval","initializeMermaidInPreview","initialize","startOnLoad","theme","securityLevel","fontFamily","htmlLabels","flowchart","deterministicIds","deterministicIDSeed","setConfig","previewDiv","element","codeParam","mermaidCode","innerText","mermaidDiv","style","cssText","parentNode","replaceChild","diagramId","tempContainer","position","left","top","render","renderResult","then","svgCode","contains","removeChild","svg","String","catch","showMermaidError","renderError","container","setTimeout","_this$mermaidDiagrams","selector","mermaidDiagramsMap","size","diagramData","option","handleMermaidSelectorChange","selectedId","clearMermaidEditor","get","diagram","find","d","codeEditor","currentSelectedDiagram","currentSelectedDiagramId","handleMermaidCodeChange","code","isModified","init","promptInput","messagesContainer","prompt","addAIMessage","messageDiv","avatar","bgColor","scrollTop","scrollHeight","_this$currentContent","Map","macroRegex","exec","macroName","macroContent","codeMatch","langMatch","detectMermaidType","diagramRecord","originalCode","originalMatch","charAt","toUpperCase","slice","set","firstLine","split","toLowerCase","includes","editMermaidDiagram","newCode","updateStatus","_this$editorContainer","syncContentFromRawEditor","syncMermaidChangesToContent","onSave","oldPattern","RegExp","escapeRegex","string","setSaveCallback","callback","isOpen","getCurrentContent","editorContent","getValue","StorageManager","getSettings","sync","EXTENSION_SETTINGS_KEY","DEFAULT_SETTINGS","saveSettings","settings","updateSetting","field","updatedSettings","resetSettings","validateSettings","_settings$apiKey","_settings$urlTemplate","_settings$documentUrl","_settings$databaseUrl","errors","apiKey","urlTemplate","validationResult","validateConfluencePageLink","valid","documentUrl","isValidUrl","databaseUrl","isValid","Object","keys","link","out","u","pageIdParam","searchParams","test","pathParts","pagesIndex","indexOf","candidate","rootUrl","EDIT_DIAGRAM","customPrompt","instructionUrl","isEnabled","selectedModel","PROGRESS_STEPS","label","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","exports","module","__webpack_modules__","definition","o","defineProperty","enumerable","obj","prop","prototype","hasOwnProperty","call","KToolContent","isModalOpen","currentTab","generationJob","progressSteps","confluenceEditor","getElementById","loadSettings","injectUI","bindEvents","ktoolContent","root","bubble","createBubble","modal","createModal","openModal","showNotification","createGenerateTab","createPreviewTab","createSettingsTab","href","closeModal","handleGenerate","handleReset","onMessage","addListener","sender","sendResponse","action","updateBubbleState","ctrlKey","metaKey","preventDefault","firstInput","focus","toggle","tooltip","baDocUrl","additionalNotes","showProgress","updateProgress","baDocument","clonedTemplate","instructions","instructionPageId","instructionDoc","ba_content","template_structure","original_storage_format","additional_prompt","additional_notes","ba_content_length","template_structure_length","original_format_length","placeholders_found","placeholders_list","jobResponse","job_id","currentJobId","pollGenerationResult","hideProgress","attempts","poll","async","statusResult","resultString","handleGenerationComplete","progress_message","generatedContent","updatePreviewTab","previewTab","editContentBtn","createPageBtn","downloadBtn","handleEditContent","handleCreatePage","handleDownload","initializeMermaid","toLocaleDateString","newPageUrl","origin","confirm","open","Blob","createObjectURL","a","download","click","revokeObjectURL","updatedContent","showMermaidTools","progressSection","step","join","display","stepIndex","stepElement","icon","notification","opacity","transform","readyState"],"sourceRoot":""}