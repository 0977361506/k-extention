{"version":3,"file":"content.js","mappings":"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","sources":["webpack://k-tool-extension-clean/./src/content/utils/xmlFormatter.js","webpack://k-tool-extension-clean/./src/content/utils/contentSynchronizer.js","webpack://k-tool-extension-clean/./src/content/utils/domHelpers.js","webpack://k-tool-extension-clean/./src/content/utils/htmlTemplates.js","webpack://k-tool-extension-clean/./src/content/utils/storageManager.js","webpack://k-tool-extension-clean/./src/content/confluenceEditor.js","webpack://k-tool-extension-clean/./src/content/mermaidAI/MermaidPreview.js","webpack://k-tool-extension-clean/./src/content/mermaidAI/MermaidAIService.js","webpack://k-tool-extension-clean/./src/content/mermaidAI/MermaidApiClient.js","webpack://k-tool-extension-clean/./src/content/mermaidAI/mermaidAIChat.js","webpack://k-tool-extension-clean/./src/shared/storage.js","webpack://k-tool-extension-clean/./src/content/utils/mermaidRenderer.js","webpack://k-tool-extension-clean/./src/shared/diagramUtils.js","webpack://k-tool-extension-clean/./src/shared/api.js","webpack://k-tool-extension-clean/./src/shared/constants.js","webpack://k-tool-extension-clean/webpack/bootstrap","webpack://k-tool-extension-clean/webpack/runtime/define property getters","webpack://k-tool-extension-clean/webpack/runtime/hasOwnProperty shorthand","webpack://k-tool-extension-clean/./src/content/content.js"],"sourcesContent":["// XML/XHTML Formatting Utilities\n// Handles XML parsing, formatting and validation\n\nexport class XMLFormatter {\n  /**\n   * Format XHTML for better readability with proper alignment\n   * @param {string} xmlString - Raw XML/XHTML string\n   * @param {string} indent - Indentation string (default: 4 spaces)\n   * @returns {string} Formatted XML/XHTML string\n   */\n  static formatXHTML(xmlString, indent = \"    \") {\n    // 1. Parse string into DOM tree\n    const parser = new DOMParser();\n\n    // Wrap content with temporary root tag if it's just a fragment\n    const rootTag = \"xml-root-fragment\";\n    const wrappedXml = `<${rootTag}>${xmlString}</${rootTag}>`;\n\n    const doc = parser.parseFromString(wrappedXml, \"text/xml\");\n\n    // Check for parsing errors\n    const parseErrors = doc.getElementsByTagName(\"parsererror\");\n    if (parseErrors.length > 0) {\n      console.warn(\"XML/XHTML parsing error. Returning original string.\", {\n        error: parseErrors[0]?.textContent || \"Unknown parsing error\",\n        originalLength: xmlString.length,\n        sample: xmlString.substring(0, 100) + \"...\",\n      });\n      return xmlString;\n    }\n\n    let output = \"\";\n    let currentIndent = \"\";\n\n    // Get wrapped root element (only process its children)\n    const rootElement = doc.documentElement;\n\n    /**\n     * Recursive function to traverse and rebuild string\n     * @param {Node} node - Current node\n     * @param {string} level - Current indentation level\n     */\n    function processNode(node, level) {\n      switch (node.nodeType) {\n        case Node.ELEMENT_NODE: // 1: HTML/XML tags (e.g., <p>, <ac:structured-macro>)\n          const nodeName = node.nodeName;\n\n          // Start tag (e.g., <p data=\"...\">)\n          let startTag = `<${nodeName}`;\n\n          // Add attributes\n          if (node.attributes && node.attributes.length > 0) {\n            for (let attr of node.attributes) {\n              startTag += ` ${attr.name}=\"${attr.value}\"`;\n            }\n          }\n          startTag += \">\";\n\n          // Check if tag has children (excluding empty TextNodes)\n          const hasSignificantChildren = Array.from(node.childNodes).some(\n            (child) =>\n              child.nodeType !== Node.TEXT_NODE ||\n              child.textContent.trim().length > 0\n          );\n\n          if (!hasSignificantChildren) {\n            // Handle self-closing or empty tags (e.g., <br />)\n            // Note: In XHTML, <tag></tag> is more common than <tag />\n            // Here we use common logic: Open tag, close tag on same line\n            output += `${level}${startTag.replace(\">\", \"/>\")}\\n`;\n          } else {\n            // Open tag on new line\n            output += `${level}${startTag}\\n`;\n\n            // Increase indentation level and process children\n            const nextLevel = level + indent;\n            Array.from(node.childNodes).forEach((child) =>\n              processNode(child, nextLevel)\n            );\n\n            // Close tag on new line with old indentation level\n            output += `${level}</${nodeName}>\\n`;\n          }\n          break;\n\n        case Node.TEXT_NODE: // 3: Text content\n          const text = node.textContent.trim();\n          if (text.length > 0) {\n            // Handle plain text (e.g., content inside <p>)\n            // If it's plain text, add it to current line or new line\n            output += `${level}${text}\\n`;\n          }\n          break;\n\n        case Node.COMMENT_NODE: // 8: Comment (e.g., <!-- comment -->)\n          output += `${level}<!--${node.textContent}-->\\n`;\n          break;\n\n        case Node.CDATA_SECTION_NODE: // 4: CDATA Section (Safe for code in <ac:parameter>)\n          // This is the most important case for Mermaid content\n          output += `${level}<![CDATA[${node.textContent}]]>\\n`;\n          break;\n\n        // You can add other cases like DOCUMENT_TYPE_NODE, PROCESSING_INSTRUCTION_NODE if needed\n      }\n    }\n\n    // Start processing from children of temporary root tag\n    Array.from(rootElement.childNodes).forEach((node) =>\n      processNode(node, currentIndent)\n    );\n\n    return output.trim();\n  }\n\n  /**\n   * Check if a tag is self-closing\n   * @param {string} tag - HTML tag string\n   * @returns {boolean} True if self-closing\n   */\n  static isSelfClosingTag(tag) {\n    const selfClosing = [\n      \"br\",\n      \"hr\",\n      \"img\",\n      \"input\",\n      \"meta\",\n      \"link\",\n      \"source\",\n      \"track\",\n      \"wbr\",\n    ];\n    return selfClosing.some((t) => tag.startsWith(`<${t}`));\n  }\n\n  /**\n   * Clean up XML markers from content\n   * @param {string} content - Content with XML markers\n   * @returns {string} Cleaned content\n   */\n  static cleanXMLMarkers(content) {\n    if (!content) return \"\";\n\n    // Remove ```xml and ``` markers\n    let cleaned = content.replace(/^```xml\\s*\\n?/gm, \"\");\n    cleaned = cleaned.replace(/\\n?```\\s*$/gm, \"\");\n\n    return cleaned;\n  }\n\n  /**\n   * Escape regex special characters\n   * @param {string} string - String to escape\n   * @returns {string} Escaped string\n   */\n  static escapeRegex(string) {\n    return string.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\n  }\n}\n","/**\n * Content Synchronizer - Handles synchronization between different content sources\n * (Raw editor, Mermaid diagrams, etc.)\n */\nimport { XMLFormatter } from \"./xmlFormatter.js\";\n\nexport class ContentSynchronizer {\n  constructor() {\n    // Simplified - no change tracking needed\n    this.diagramChanges = new Map(); // Track diagram changes\n  }\n\n  /**\n   * Track diagram changes for synchronization\n   * @param {string} diagramId - Diagram ID\n   * @param {string} newCode - New diagram code\n   */\n  trackDiagramChange(diagramId, newCode) {\n    console.log(`📝 Tracking diagram change for ${diagramId}`);\n    this.diagramChanges.set(diagramId, {\n      code: newCode,\n      timestamp: Date.now(),\n    });\n  }\n\n  /**\n   * Get tracked diagram changes\n   * @returns {Map} Map of diagram changes\n   */\n  getTrackedChanges() {\n    return this.diagramChanges;\n  }\n\n  /**\n   * Clear tracked changes\n   */\n  clearTrackedChanges() {\n    this.diagramChanges.clear();\n  }\n\n  /**\n   * Sync all content sources to main content object\n   * @param {Object} currentContent - Main content object\n   * @param {HTMLElement} editorContainer - Editor container element\n   * @param {Array} mermaidDiagrams - Array of Mermaid diagrams\n   * @returns {Object} Updated content object\n   */\n  syncAllContent(currentContent, editorContainer, mermaidDiagrams = []) {\n    if (!currentContent) {\n      throw new Error(\"Current content is required\");\n    }\n\n    // 1. Sync from raw editor\n    const rawContent = this.syncFromRawEditor(currentContent, editorContainer);\n\n    // 2. Sync Mermaid changes\n    const finalContent = this.syncMermaidChanges(rawContent, mermaidDiagrams);\n\n    console.log(\"🔄 All content synchronized\");\n    return finalContent;\n  }\n\n  /**\n   * Sync content from raw editor\n   * @param {Object} currentContent - Current content object\n   * @param {HTMLElement} editorContainer - Editor container\n   * @returns {Object} Updated content object\n   */\n  syncFromRawEditor(currentContent, editorContainer) {\n    if (!editorContainer) return currentContent;\n\n    const rawEditor = editorContainer.querySelector(\"#raw-content-editor\");\n    if (!rawEditor || !rawEditor.value) return currentContent;\n\n    const updatedContent = { ...currentContent };\n    updatedContent.full_storage_format = rawEditor.value.trim();\n\n    // Also update content field if it exists\n    if (updatedContent.content !== undefined) {\n      updatedContent.content = rawEditor.value.trim();\n    }\n\n    console.log(\"📝 Synced content from raw editor\");\n    return updatedContent;\n  }\n\n  /**\n   * Sync Mermaid diagram changes back to content\n   * @param {Object} currentContent - Current content object\n   * @param {Array} mermaidDiagrams - Array of Mermaid diagrams\n   * @returns {Object} Updated content object\n   */\n  syncMermaidChanges(currentContent, mermaidDiagrams = []) {\n    console.log(\"🔄 Starting Mermaid sync...\", {\n      diagramsCount: mermaidDiagrams.length,\n      hasContent: !!currentContent,\n    });\n\n    if (!mermaidDiagrams || mermaidDiagrams.length === 0) {\n      console.log(\"⚠️ No Mermaid diagrams to sync\");\n      return currentContent;\n    }\n\n    let content =\n      currentContent.full_storage_format || currentContent.content || \"\";\n    console.log(\"📊 Processing all diagrams (no change check)...\");\n\n    // Process each diagram - always replace originalCode with code\n    mermaidDiagrams.forEach((diagram, index) => {\n      console.log(`� Processing diagram ${index}:`, {\n        id: diagram.id,\n        hasOriginalCode: !!diagram.originalCode,\n        hasCode: !!diagram.code,\n        originalLength: diagram.originalCode?.length || 0,\n        codeLength: diagram.code?.length || 0,\n      });\n\n      if (diagram.originalCode && diagram.code) {\n        console.log(`📝 Replacing code for diagram ${diagram.id || index}...`);\n        console.log(\n          `📋 Original code preview: \"${diagram.originalCode.substring(\n            0,\n            100\n          )}...\"`\n        );\n        console.log(\n          `📋 New code preview: \"${diagram.code.substring(0, 100)}...\"`\n        );\n\n        const updatedContent = this.updateDiagramInContent(\n          content,\n          diagram,\n          index\n        );\n        if (updatedContent !== content) {\n          content = updatedContent;\n          console.log(\n            `✅ Successfully replaced code for diagram ${diagram.id || index}`\n          );\n        } else {\n          console.warn(\n            `⚠️ Failed to replace code for diagram ${\n              diagram.id || index\n            } - no pattern matched`\n          );\n        }\n      } else {\n        console.log(\n          `⚠️ Skipping diagram ${\n            diagram.id || index\n          } - missing originalCode or code`\n        );\n      }\n    });\n\n    // Always return updated content\n    const updatedContent = { ...currentContent };\n    updatedContent.full_storage_format = content;\n\n    if (updatedContent.content !== undefined) {\n      updatedContent.content = content;\n    }\n\n    console.log(\"✅ Mermaid sync completed - all diagrams processed\");\n    return updatedContent;\n  }\n\n  /**\n   * Update a specific diagram in content string\n   * @param {string} content - Full content string\n   * @param {Object} diagram - Diagram object\n   * @param {number} index - Diagram index\n   * @returns {string} Updated content string\n   */\n  updateDiagramInContent(content, diagram, index) {\n    if (!content || !diagram) {\n      console.log(\"⚠️ updateDiagramInContent: Missing content or diagram\");\n      return content;\n    }\n\n    const originalCode = diagram.originalCode;\n    const newCode = diagram.code;\n\n    console.log(\"🔄 Updating diagram in content:\", {\n      index,\n      diagramId: diagram.id,\n      hasOriginalCode: !!originalCode,\n      hasNewCode: !!newCode,\n      originalLength: originalCode?.length || 0,\n      newLength: newCode?.length || 0,\n    });\n\n    if (!originalCode || !newCode) {\n      console.log(\"⚠️ Missing originalCode or newCode - skipping update\");\n      return content;\n    }\n\n    console.log(\"📋 Replacing originalCode with newCode (no equality check)\");\n    console.log(`📋 Original: \"${originalCode.substring(0, 50)}...\"`);\n    console.log(`📋 New: \"${newCode.substring(0, 50)}...\"`);\n\n    // Try multiple patterns to find and replace the diagram\n    const patterns = [\n      // Pattern 1: CDATA section in ac:parameter\n      {\n        pattern: new RegExp(\n          `(<ac:parameter[^>]*ac:name=\"code\"[^>]*>\\\\s*<\\\\!\\\\[CDATA\\\\[\\\\s*)(${XMLFormatter.escapeRegex(\n            originalCode\n          )})(\\\\s*\\\\]\\\\]>\\\\s*</ac:parameter>)`,\n          \"gs\"\n        ),\n        replacement: `$1${newCode}$3`,\n      },\n      // Pattern 2: Plain text in ac:parameter\n      {\n        pattern: new RegExp(\n          `(<ac:parameter[^>]*ac:name=\"code\"[^>]*>\\\\s*)(${XMLFormatter.escapeRegex(\n            originalCode\n          )})(\\\\s*</ac:parameter>)`,\n          \"gs\"\n        ),\n        replacement: `$1${newCode}$3`,\n      },\n      // Pattern 3: ac:plain-text-body with CDATA\n      {\n        pattern: new RegExp(\n          `(<ac:plain-text-body>\\\\s*<\\\\!\\\\[CDATA\\\\[\\\\s*)(${XMLFormatter.escapeRegex(\n            originalCode\n          )})(\\\\s*\\\\]\\\\]>\\\\s*</ac:plain-text-body>)`,\n          \"gs\"\n        ),\n        replacement: `$1${newCode}$3`,\n      },\n    ];\n\n    let updatedContent = content;\n    let patternMatched = false;\n\n    console.log(\"🔍 Trying patterns to match and replace...\");\n\n    for (let i = 0; i < patterns.length; i++) {\n      const { pattern, replacement } = patterns[i];\n\n      console.log(`🔍 Testing pattern ${i + 1}...`);\n\n      // Reset regex lastIndex to avoid issues with global flag\n      pattern.lastIndex = 0;\n\n      if (pattern.test(content)) {\n        console.log(`✅ Pattern ${i + 1} matched! Applying replacement...`);\n\n        // Reset again before replace\n        pattern.lastIndex = 0;\n        updatedContent = content.replace(pattern, replacement);\n        patternMatched = true;\n\n        console.log(`✅ Successfully updated diagram using pattern ${i + 1}`);\n        break;\n      } else {\n        console.log(`❌ Pattern ${i + 1} did not match`);\n      }\n    }\n\n    if (!patternMatched) {\n      console.warn(\n        `⚠️ Could not find pattern to update diagram ${diagram.id || index}`\n      );\n      console.log(\"🔍 Debug info:\");\n      console.log(\n        \"Original code preview:\",\n        originalCode.substring(0, 100) + \"...\"\n      );\n      console.log(\"New code preview:\", newCode.substring(0, 100) + \"...\");\n      console.log(\"Content sample:\", content.substring(0, 500) + \"...\");\n\n      // Try to find the original code manually for debugging\n      const simpleSearch = content.includes(originalCode.trim());\n      console.log(\"Simple string search found original code:\", simpleSearch);\n    } else {\n      console.log(\"✅ Pattern matching successful, content updated\");\n    }\n\n    return updatedContent;\n  }\n\n  /**\n   * Validate content structure\n   * @param {Object} content - Content to validate\n   * @returns {Object} Validation result\n   */\n  validateContent(content) {\n    const result = {\n      isValid: true,\n      errors: [],\n      warnings: [],\n    };\n\n    if (!content) {\n      result.isValid = false;\n      result.errors.push(\"Content is null or undefined\");\n      return result;\n    }\n\n    // Check required fields\n    if (!content.full_storage_format && !content.content) {\n      result.isValid = false;\n      result.errors.push(\"Missing full_storage_format or content field\");\n    }\n\n    // Check for XML validity\n    const xmlContent = content.full_storage_format || content.content;\n    if (xmlContent) {\n      try {\n        const parser = new DOMParser();\n        const doc = parser.parseFromString(\n          `<root>${xmlContent}</root>`,\n          \"text/xml\"\n        );\n        const errors = doc.getElementsByTagName(\"parsererror\");\n\n        if (errors.length > 0) {\n          result.warnings.push(\"Content may contain XML parsing issues\");\n        }\n      } catch (error) {\n        result.warnings.push(`XML validation warning: ${error.message}`);\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * Create content backup\n   * @param {Object} content - Content to backup\n   * @returns {Object} Content backup\n   */\n  createBackup(content) {\n    return {\n      content: JSON.parse(JSON.stringify(content)),\n      timestamp: Date.now(),\n    };\n  }\n\n  /**\n   * Restore from backup\n   * @param {Object} backup - Backup to restore\n   * @returns {Object} Restored content\n   */\n  restoreFromBackup(backup) {\n    if (!backup || !backup.content) {\n      throw new Error(\"Invalid backup data\");\n    }\n\n    console.log(\"🔄 Restored content from backup\");\n    return backup.content;\n  }\n}\n","// DOM Manipulation Helpers\n// Utility functions for DOM operations and event handling\n\nexport class DOMHelpers {\n  /**\n   * Safely query selector with error handling\n   * @param {HTMLElement} container - Container element\n   * @param {string} selector - CSS selector\n   * @returns {HTMLElement|null} Found element or null\n   */\n  static querySelector(container, selector) {\n    try {\n      return container.querySelector(selector);\n    } catch (error) {\n      console.error(`Error querying selector \"${selector}\":`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Safely query all selectors with error handling\n   * @param {HTMLElement} container - Container element\n   * @param {string} selector - CSS selector\n   * @returns {NodeList} Found elements\n   */\n  static querySelectorAll(container, selector) {\n    try {\n      return container.querySelectorAll(selector);\n    } catch (error) {\n      console.error(`Error querying selector \"${selector}\":`, error);\n      return [];\n    }\n  }\n\n  /**\n   * Add event listener with error handling\n   * @param {HTMLElement} element - Target element\n   * @param {string} event - Event type\n   * @param {Function} handler - Event handler\n   * @param {object} options - Event options\n   */\n  static addEventListener(element, event, handler, options = {}) {\n    if (!element) {\n      console.warn(`Cannot add event listener: element is null`);\n      return;\n    }\n\n    try {\n      element.addEventListener(event, handler, options);\n    } catch (error) {\n      console.error(`Error adding event listener for \"${event}\":`, error);\n    }\n  }\n\n  /**\n   * Remove event listener with error handling\n   * @param {HTMLElement} element - Target element\n   * @param {string} event - Event type\n   * @param {Function} handler - Event handler\n   */\n  static removeEventListener(element, event, handler) {\n    if (!element) {\n      console.warn(`Cannot remove event listener: element is null`);\n      return;\n    }\n\n    try {\n      element.removeEventListener(event, handler);\n    } catch (error) {\n      console.error(`Error removing event listener for \"${event}\":`, error);\n    }\n  }\n\n  /**\n   * Toggle class on element\n   * @param {HTMLElement} element - Target element\n   * @param {string} className - Class name to toggle\n   * @param {boolean} force - Force add/remove\n   */\n  static toggleClass(element, className, force = undefined) {\n    if (!element) {\n      console.warn(`Cannot toggle class: element is null`);\n      return;\n    }\n\n    try {\n      if (force !== undefined) {\n        element.classList.toggle(className, force);\n      } else {\n        element.classList.toggle(className);\n      }\n    } catch (error) {\n      console.error(`Error toggling class \"${className}\":`, error);\n    }\n  }\n\n  /**\n   * Add class to element\n   * @param {HTMLElement} element - Target element\n   * @param {string} className - Class name to add\n   */\n  static addClass(element, className) {\n    if (!element) {\n      console.warn(`Cannot add class: element is null`);\n      return;\n    }\n\n    try {\n      element.classList.add(className);\n    } catch (error) {\n      console.error(`Error adding class \"${className}\":`, error);\n    }\n  }\n\n  /**\n   * Remove class from element\n   * @param {HTMLElement} element - Target element\n   * @param {string} className - Class name to remove\n   */\n  static removeClass(element, className) {\n    if (!element) {\n      console.warn(`Cannot remove class: element is null`);\n      return;\n    }\n\n    try {\n      element.classList.remove(className);\n    } catch (error) {\n      console.error(`Error removing class \"${className}\":`, error);\n    }\n  }\n\n  /**\n   * Set element content safely\n   * @param {HTMLElement} element - Target element\n   * @param {string} content - Content to set\n   * @param {boolean} isHTML - Whether content is HTML (default: false)\n   */\n  static setContent(element, content, isHTML = false) {\n    if (!element) {\n      console.warn(`Cannot set content: element is null`);\n      return;\n    }\n\n    try {\n      // Handle form elements specially\n      if (\n        element.tagName === \"INPUT\" ||\n        element.tagName === \"TEXTAREA\" ||\n        element.tagName === \"SELECT\"\n      ) {\n        element.value = content || \"\";\n        return;\n      }\n\n      if (isHTML) {\n        element.innerHTML = content;\n      } else {\n        element.textContent = content;\n      }\n    } catch (error) {\n      console.error(`Error setting content:`, error);\n    }\n  }\n\n  /**\n   * Get element content safely\n   * @param {HTMLElement} element - Target element\n   * @param {boolean} isHTML - Whether to get HTML content (default: false)\n   * @returns {string} Element content\n   */\n  static getContent(element, isHTML = false) {\n    if (!element) {\n      console.warn(`Cannot get content: element is null`);\n      return \"\";\n    }\n\n    try {\n      // Handle form elements specially\n      if (\n        element.tagName === \"INPUT\" ||\n        element.tagName === \"TEXTAREA\" ||\n        element.tagName === \"SELECT\"\n      ) {\n        return element.value || \"\";\n      }\n\n      return isHTML ? element.innerHTML : element.textContent;\n    } catch (error) {\n      console.error(`Error getting content:`, error);\n      return \"\";\n    }\n  }\n\n  /**\n   * Create element with attributes and content\n   * @param {string} tagName - HTML tag name\n   * @param {object} attributes - Element attributes\n   * @param {string} content - Element content\n   * @param {boolean} isHTML - Whether content is HTML\n   * @returns {HTMLElement} Created element\n   */\n  static createElement(tagName, attributes = {}, content = \"\", isHTML = false) {\n    try {\n      const element = document.createElement(tagName);\n\n      // Set attributes\n      Object.entries(attributes).forEach(([key, value]) => {\n        if (key === \"className\") {\n          element.className = value;\n        } else if (key === \"style\" && typeof value === \"object\") {\n          Object.assign(element.style, value);\n        } else {\n          element.setAttribute(key, value);\n        }\n      });\n\n      // Set content\n      if (content) {\n        this.setContent(element, content, isHTML);\n      }\n\n      return element;\n    } catch (error) {\n      console.error(`Error creating element \"${tagName}\":`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Remove element safely\n   * @param {HTMLElement} element - Element to remove\n   */\n  static removeElement(element) {\n    if (!element) {\n      console.warn(`Cannot remove element: element is null`);\n      return;\n    }\n\n    try {\n      if (element.parentNode) {\n        element.parentNode.removeChild(element);\n      } else {\n        element.remove();\n      }\n    } catch (error) {\n      console.error(`Error removing element:`, error);\n    }\n  }\n\n  /**\n   * Check if element exists in DOM\n   * @param {HTMLElement} element - Element to check\n   * @returns {boolean} True if element exists in DOM\n   */\n  static isInDOM(element) {\n    if (!element) return false;\n    return document.body.contains(element);\n  }\n\n  /**\n   * Scroll element into view smoothly\n   * @param {HTMLElement} element - Element to scroll to\n   * @param {object} options - Scroll options\n   */\n  static scrollIntoView(\n    element,\n    options = { behavior: \"smooth\", block: \"center\" }\n  ) {\n    if (!element) {\n      console.warn(`Cannot scroll: element is null`);\n      return;\n    }\n\n    try {\n      element.scrollIntoView(options);\n    } catch (error) {\n      console.error(`Error scrolling element into view:`, error);\n    }\n  }\n\n  /**\n   * Get element dimensions\n   * @param {HTMLElement} element - Target element\n   * @returns {object} Element dimensions\n   */\n  static getDimensions(element) {\n    if (!element) {\n      console.warn(`Cannot get dimensions: element is null`);\n      return { width: 0, height: 0, top: 0, left: 0 };\n    }\n\n    try {\n      const rect = element.getBoundingClientRect();\n      return {\n        width: rect.width,\n        height: rect.height,\n        top: rect.top,\n        left: rect.left,\n        right: rect.right,\n        bottom: rect.bottom,\n      };\n    } catch (error) {\n      console.error(`Error getting element dimensions:`, error);\n      return { width: 0, height: 0, top: 0, left: 0 };\n    }\n  }\n\n  /**\n   * Deep clone element\n   * @param {HTMLElement} element - Element to clone\n   * @param {boolean} deep - Whether to deep clone (default: true)\n   * @returns {HTMLElement} Cloned element\n   */\n  static cloneElement(element, deep = true) {\n    if (!element) {\n      console.warn(`Cannot clone element: element is null`);\n      return null;\n    }\n\n    try {\n      return element.cloneNode(deep);\n    } catch (error) {\n      console.error(`Error cloning element:`, error);\n      return null;\n    }\n  }\n}\n","// HTML Templates for Confluence Editor\n// Contains all HTML template strings and styling utilities\n\nexport class HTMLTemplates {\n  /**\n   * Get the main editor HTML template\n   * @returns {string} HTML template string\n   */\n  static getEditorTemplate() {\n    return `\n      <div class=\"confluence-editor-container\">\n        <div class=\"confluence-editor-header\">\n          <h2 class=\"confluence-editor-title\">\n            📝 Edit Confluence Content\n          </h2>\n          <div class=\"confluence-editor-actions\">\n            <button class=\"editor-btn editor-btn-primary\" id=\"editor-save-btn\">\n              💾 Save\n            </button>\n            <button class=\"editor-btn editor-btn-secondary\" id=\"editor-close-btn\">\n              ✕ Close\n            </button>\n          </div>\n        </div>\n\n        <div class=\"confluence-editor-tabs\">\n          <button class=\"confluence-editor-tab active\" id=\"content-tab\">\n            📝 Edit Content\n          </button>\n          <button class=\"confluence-editor-tab\" id=\"mermaid-tab\">\n            📊 Edit Mermaid Code\n          </button>\n        </div>\n\n        <div class=\"confluence-editor-body\">\n          ${this.getContentTabTemplate()}\n          ${this.getMermaidTabTemplate()}\n        </div>\n      </div>\n    `;\n  }\n\n  /**\n   * Get content tab template\n   * @returns {string} Content tab HTML\n   */\n  static getContentTabTemplate() {\n    return `\n      <!-- Content Tab -->\n      <div class=\"tab-content active\" id=\"content-tab-content\">\n        <div class=\"content-editor-layout\">\n          <!-- Raw XHTML Editor (Left) -->\n          <div class=\"content-editor-pane\">\n            <div class=\"content-editor-header\">\n              📝 Raw XHTML Content\n            </div>\n            <div class=\"content-editor-body\">\n              <textarea class=\"raw-content-editor\" id=\"raw-content-editor\" placeholder=\"Raw XHTML content will appear here...\"></textarea>\n            </div>\n          </div>\n\n          <!-- Preview Pane (Right) -->\n          <div class=\"content-preview-pane\">\n            <div class=\"content-editor-header\">\n              👁️ Live Preview\n            </div>\n            <div class=\"content-editor-body\">\n              <div class=\"content-preview\" id=\"content-preview\">\n                <!-- Preview content will be rendered here -->\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n  }\n\n  /**\n   * Get mermaid tab template\n   * @returns {string} Mermaid tab HTML\n   */\n  static getMermaidTabTemplate() {\n    return `\n      <!-- Mermaid Tab -->\n      <div class=\"tab-content\" id=\"mermaid-tab-content\">\n        <div class=\"mermaid-editor-layout\">\n          <!-- Mermaid Code Editor (Left) -->\n          <div class=\"mermaid-code-pane\">\n            <div class=\"mermaid-editor-header\">\n              📊 Mermaid Code\n              <select id=\"mermaid-selector\" class=\"mermaid-selector\">\n                <option value=\"\">Select diagram...</option>\n              </select>\n            </div>\n            <div class=\"mermaid-editor-body\">\n              <textarea class=\"mermaid-code-editor\" id=\"mermaid-code-editor\" placeholder=\"Select a Mermaid diagram to edit...\"></textarea>\n            </div>\n          </div>\n\n          <!-- Mermaid Preview (Center) -->\n          <div class=\"mermaid-preview-pane\">\n            <div class=\"mermaid-editor-header\">\n              <span class=\"preview-title\">📊 Diagram Preview</span>\n              ${this.getZoomControlsTemplate()}\n            </div>\n            <div class=\"mermaid-editor-body\">\n              <div class=\"mermaid-preview\" id=\"mermaid-preview\">\n                <div class=\"mermaid-placeholder\">\n                  Select a diagram to preview\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <!-- AI Chat (Right) -->\n          <div class=\"mermaid-ai-pane\">\n            <div class=\"mermaid-editor-header\">\n              🤖 AI Assistant\n            </div>\n            <div class=\"mermaid-editor-body\">\n              ${this.getAIChatTemplate()}\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n  }\n\n  /**\n   * Get zoom controls template\n   * @returns {string} Zoom controls HTML\n   */\n  static getZoomControlsTemplate() {\n    return `\n      <div class=\"mermaid-zoom-controls\">\n        <button class=\"zoom-btn\" id=\"zoom-out\" title=\"Zoom Out\">−</button>\n        <div class=\"zoom-level\" id=\"zoom-level\">100%</div>\n        <button class=\"zoom-btn\" id=\"zoom-in\" title=\"Zoom In\">+</button>\n        <button class=\"zoom-btn\" id=\"zoom-reset\" title=\"Reset Zoom\">⌂</button>\n      </div>\n    `;\n  }\n\n  /**\n   * Get AI chat template - Enhanced version similar to extension\n   * @returns {string} AI chat HTML\n   */\n  static getAIChatTemplate() {\n    return `\n      <div class=\"ai-chat-container\">\n        <div class=\"ai-chat-header\">\n          <div class=\"ai-header-title\">\n            <span class=\"ai-icon\">🤖</span>\n            <span>AI Diagram Assistant</span>\n          </div>\n          <div class=\"ai-header-status\">Ready</div>\n        </div>\n        <div class=\"ai-chat-messages\" id=\"ai-chat-messages\">\n          <div class=\"ai-message\">\n            <div class=\"ai-avatar\">🤖</div>\n            <div class=\"ai-text\">\n              <strong>Hi! I'm your AI Diagram Assistant.</strong><br/><br/>\n              I can help you modify Mermaid diagrams with natural language commands:<br/>\n              • \"Add a new node called 'Database'\"<br/>\n              • \"Change the color of node A to blue\"<br/>\n              • \"Add an arrow from A to B\"<br/>\n              • \"Make this flowchart more detailed\"<br/><br/>\n              <em>Select a diagram above and describe what you want to change!</em>\n            </div>\n          </div>\n        </div>\n        <div class=\"ai-chat-input\">\n          <div class=\"ai-input-container\">\n            <textarea\n              id=\"ai-prompt-input\"\n              placeholder=\"Describe how you want to modify the diagram...\"\n              rows=\"2\"\n            ></textarea>\n            <button id=\"ai-send-btn\" class=\"ai-send-btn\" title=\"Send message (Enter)\">\n              <span class=\"send-icon\">📤</span>\n            </button>\n          </div>\n          <div class=\"ai-input-tips\">\n            💡 <strong>Tips:</strong> Be specific about changes you want. Press Enter to send.\n          </div>\n        </div>\n      </div>\n    `;\n  }\n\n  /**\n   * Apply inline styles to HTML content for preview\n   * @param {string} content - Raw HTML content\n   * @returns {string} Styled HTML content\n   */\n  static applyPreviewStyles(content) {\n    return content\n      .replace(\n        /<h1>/g,\n        \"<h1 style='color: #333; margin: 24px 0 16px 0; font-size: 1.8rem; border-bottom: 2px solid #e1e5e9; padding-bottom: 8px;'>\"\n      )\n      .replace(\n        /<h2>/g,\n        \"<h2 style='color: #555; margin: 20px 0 12px 0; font-size: 1.4rem;'>\"\n      )\n      .replace(\n        /<h3>/g,\n        \"<h3 style='color: #666; margin: 16px 0 8px 0; font-size: 1.2rem;'>\"\n      )\n      .replace(\n        /<p>/g,\n        \"<p style='margin: 12px 0; line-height: 1.6; color: #333;'>\"\n      )\n      .replace(/<ul>/g, \"<ul style='margin: 12px 0; padding-left: 24px;'>\")\n      .replace(/<li>/g, \"<li style='margin: 4px 0; line-height: 1.5;'>\")\n      .replace(\n        /<table>/g,\n        \"<table style='border-collapse: collapse; width: 100%; margin: 20px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1);'>\"\n      )\n      .replace(\n        /<th>/g,\n        \"<th style='border: 1px solid #ddd; padding: 12px; background: #f8f9fa; font-weight: 600; text-align: left;'>\"\n      )\n      .replace(\n        /<td>/g,\n        \"<td style='border: 1px solid #ddd; padding: 12px; vertical-align: top;'>\"\n      )\n      .replace(/<strong>/g, \"<strong style='color: #2c3e50;'>\")\n      .replace(\n        /<code>/g,\n        \"<code style='background: #f1f3f4; padding: 2px 4px; border-radius: 3px; font-family: monospace; font-size: 0.9em;'>\"\n      );\n  }\n\n  /**\n   * Create AI message HTML\n   * @param {string} type - Message type ('user' or 'ai')\n   * @param {string} text - Message text\n   * @returns {string} AI message HTML\n   */\n  static createAIMessage(type, text) {\n    const avatar = type === \"user\" ? \"👤\" : \"🤖\";\n    const bgColor = type === \"user\" ? \"#e5e7eb\" : \"#3b82f6\";\n\n    return `\n      <div class=\"ai-message\">\n        <div class=\"ai-avatar\" style=\"background: ${bgColor};\">${avatar}</div>\n        <div class=\"ai-text\">${text}</div>\n      </div>\n    `;\n  }\n\n  /**\n   * Create mermaid diagram container with styling\n   * @param {number} index - Diagram index\n   * @returns {HTMLElement} Mermaid container element\n   */\n  static createMermaidContainer(index) {\n    const mermaidDiv = document.createElement(\"div\");\n    mermaidDiv.className = \"mermaid-diagram\";\n    mermaidDiv.id = `preview-mermaid-${index}`;\n    mermaidDiv.style.cssText =\n      \"margin: 20px 0; text-align: center; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;\";\n    return mermaidDiv;\n  }\n}\n","/**\n * Storage Manager - Handles saving and loading content changes\n * Supports both callback-based saving and localStorage backup\n */\nexport class StorageManager {\n  constructor() {\n    this.STORAGE_KEY = 'confluence_editor_backup';\n    this.AUTO_SAVE_INTERVAL = 30000; // 30 seconds\n    this.autoSaveTimer = null;\n  }\n\n  /**\n   * Save content with multiple strategies\n   * @param {Object} content - Content to save\n   * @param {Function} saveCallback - Optional callback for external save\n   * @param {Object} options - Save options\n   */\n  async saveContent(content, saveCallback = null, options = {}) {\n    const { \n      enableLocalStorage = true, \n      enableCallback = true,\n      showNotification = true \n    } = options;\n\n    const results = {\n      localStorage: false,\n      callback: false,\n      errors: []\n    };\n\n    // 1. Save to localStorage as backup\n    if (enableLocalStorage) {\n      try {\n        this.saveToLocalStorage(content);\n        results.localStorage = true;\n        console.log('✅ Content saved to localStorage');\n      } catch (error) {\n        console.error('❌ Failed to save to localStorage:', error);\n        results.errors.push(`localStorage: ${error.message}`);\n      }\n    }\n\n    // 2. Call external save callback\n    if (enableCallback && saveCallback) {\n      try {\n        await this.callSaveCallback(saveCallback, content);\n        results.callback = true;\n        console.log('✅ Content saved via callback');\n      } catch (error) {\n        console.error('❌ Failed to save via callback:', error);\n        results.errors.push(`callback: ${error.message}`);\n      }\n    }\n\n    // 3. Show notification\n    if (showNotification) {\n      this.showSaveNotification(results);\n    }\n\n    return results;\n  }\n\n  /**\n   * Save content to localStorage\n   * @param {Object} content - Content to save\n   */\n  saveToLocalStorage(content) {\n    const backupData = {\n      content: content,\n      timestamp: Date.now(),\n      version: '1.0'\n    };\n\n    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(backupData));\n  }\n\n  /**\n   * Load content from localStorage\n   * @returns {Object|null} Saved content or null\n   */\n  loadFromLocalStorage() {\n    try {\n      const saved = localStorage.getItem(this.STORAGE_KEY);\n      if (!saved) return null;\n\n      const backupData = JSON.parse(saved);\n      \n      // Check if backup is recent (within 24 hours)\n      const age = Date.now() - backupData.timestamp;\n      const maxAge = 24 * 60 * 60 * 1000; // 24 hours\n      \n      if (age > maxAge) {\n        console.log('🗑️ Removing old localStorage backup');\n        localStorage.removeItem(this.STORAGE_KEY);\n        return null;\n      }\n\n      console.log('📦 Loaded content from localStorage backup');\n      return backupData.content;\n    } catch (error) {\n      console.error('❌ Failed to load from localStorage:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Clear localStorage backup\n   */\n  clearLocalStorage() {\n    localStorage.removeItem(this.STORAGE_KEY);\n    console.log('🗑️ Cleared localStorage backup');\n  }\n\n  /**\n   * Call external save callback\n   * @param {Function} callback - Save callback function\n   * @param {Object} content - Content to save\n   */\n  async callSaveCallback(callback, content) {\n    if (typeof callback !== 'function') {\n      throw new Error('Save callback is not a function');\n    }\n\n    // Handle both sync and async callbacks\n    const result = callback(content);\n    if (result && typeof result.then === 'function') {\n      await result;\n    }\n  }\n\n  /**\n   * Show save notification\n   * @param {Object} results - Save results\n   */\n  showSaveNotification(results) {\n    const { localStorage, callback, errors } = results;\n    \n    if (localStorage && callback) {\n      this.showNotification('✅ Đã lưu thay đổi thành công', 'success');\n    } else if (localStorage || callback) {\n      const method = localStorage ? 'localStorage' : 'callback';\n      this.showNotification(`⚠️ Đã lưu qua ${method} (một phần)`, 'warning');\n    } else {\n      this.showNotification('❌ Không thể lưu thay đổi', 'error');\n    }\n\n    if (errors.length > 0) {\n      console.warn('Save errors:', errors);\n    }\n  }\n\n  /**\n   * Show notification to user\n   * @param {string} message - Notification message\n   * @param {string} type - Notification type (success, warning, error)\n   */\n  showNotification(message, type = 'info') {\n    // Create notification element\n    const notification = document.createElement('div');\n    notification.className = `confluence-editor-notification ${type}`;\n    notification.style.cssText = `\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      padding: 12px 20px;\n      border-radius: 6px;\n      color: white;\n      font-family: Arial, sans-serif;\n      font-size: 14px;\n      z-index: 10001;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n      transition: all 0.3s ease;\n      max-width: 300px;\n    `;\n\n    // Set background color based on type\n    const colors = {\n      success: '#28a745',\n      warning: '#ffc107',\n      error: '#dc3545',\n      info: '#17a2b8'\n    };\n    notification.style.background = colors[type] || colors.info;\n\n    notification.textContent = message;\n    document.body.appendChild(notification);\n\n    // Auto remove after 3 seconds\n    setTimeout(() => {\n      if (notification.parentNode) {\n        notification.style.opacity = '0';\n        notification.style.transform = 'translateX(100%)';\n        setTimeout(() => {\n          notification.remove();\n        }, 300);\n      }\n    }, 3000);\n  }\n\n  /**\n   * Start auto-save timer\n   * @param {Function} saveFunction - Function to call for auto-save\n   */\n  startAutoSave(saveFunction) {\n    this.stopAutoSave();\n    \n    this.autoSaveTimer = setInterval(() => {\n      try {\n        saveFunction();\n        console.log('🔄 Auto-save completed');\n      } catch (error) {\n        console.error('❌ Auto-save failed:', error);\n      }\n    }, this.AUTO_SAVE_INTERVAL);\n\n    console.log('⏰ Auto-save started (every 30 seconds)');\n  }\n\n  /**\n   * Stop auto-save timer\n   */\n  stopAutoSave() {\n    if (this.autoSaveTimer) {\n      clearInterval(this.autoSaveTimer);\n      this.autoSaveTimer = null;\n      console.log('⏹️ Auto-save stopped');\n    }\n  }\n\n  /**\n   * Check if there are unsaved changes in localStorage\n   * @param {Object} currentContent - Current content to compare\n   * @returns {boolean} True if there are unsaved changes\n   */\n  hasUnsavedChanges(currentContent) {\n    const saved = this.loadFromLocalStorage();\n    if (!saved) return false;\n\n    try {\n      const currentStr = JSON.stringify(currentContent);\n      const savedStr = JSON.stringify(saved);\n      return currentStr !== savedStr;\n    } catch (error) {\n      console.error('❌ Error comparing content:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Get backup info\n   * @returns {Object|null} Backup information\n   */\n  getBackupInfo() {\n    try {\n      const saved = localStorage.getItem(this.STORAGE_KEY);\n      if (!saved) return null;\n\n      const backupData = JSON.parse(saved);\n      return {\n        timestamp: backupData.timestamp,\n        age: Date.now() - backupData.timestamp,\n        version: backupData.version\n      };\n    } catch (error) {\n      return null;\n    }\n  }\n}\n","// Confluence Content Editor with Rich Text Editing\r\n// Handles editing interface when Confluence content is returned from API\r\n\r\nimport { API_URLS } from \"../shared/constants.js\";\r\nimport { StorageManager as ChromeStorageManager } from \"../shared/storage.js\";\r\nimport { ContentSynchronizer } from \"./utils/contentSynchronizer.js\";\r\nimport { DOMHelpers } from \"./utils/domHelpers.js\";\r\nimport { HTMLTemplates } from \"./utils/htmlTemplates.js\";\r\nimport { MermaidRenderer } from \"./utils/mermaidRenderer.js\";\r\nimport { StorageManager } from \"./utils/storageManager.js\";\r\nimport { XMLFormatter } from \"./utils/xmlFormatter.js\";\r\n\r\nclass ConfluenceEditor {\r\n  constructor() {\r\n    this.isEditorOpen = false;\r\n    this.currentContent = null;\r\n    this.originalContent = null;\r\n    this.onSave = null;\r\n    this.mermaidDiagrams = [];\r\n    this.mermaidDiagramsMap = new Map();\r\n    this.currentSelectedDiagram = null;\r\n    this.currentSelectedDiagramId = null;\r\n    this.editorContainer = null;\r\n    this.textEditor = null; // CodeMirror instance\r\n    this.previewContainer = null;\r\n    this.isPreviewMode = false;\r\n    this.autoSaveTimer = null;\r\n    this.isModified = false;\r\n\r\n    // Zoom controls\r\n    this.currentZoom = 1;\r\n    this.dragOffset = { x: 0, y: 0 };\r\n\r\n    // ✅ Anti-flicker properties\r\n    this.isZooming = false;\r\n    this.zoomStep = 0.25;\r\n    this.minZoom = 0.25;\r\n    this.maxZoom = 3.0;\r\n\r\n    // ✅ Debouncing for preview updates\r\n    this.previewUpdateTimeout = null;\r\n    this.isUpdatingPreview = false; // Prevent concurrent updates\r\n\r\n    // Initialize utility classes\r\n    this.storageManager = new StorageManager();\r\n    this.contentSynchronizer = new ContentSynchronizer();\r\n  }\r\n\r\n  openEditor(content, options = {}) {\r\n    if (this.isEditorOpen) {\r\n      this.closeEditor();\r\n    }\r\n\r\n    console.log(\"📝 Opening Confluence Editor with content:\", content);\r\n\r\n    // Auto-restore from localStorage backup if available (no confirm)\r\n    const backup = this.storageManager.loadFromLocalStorage();\r\n    if (backup && options.allowBackupRestore !== false) {\r\n      const backupInfo = this.storageManager.getBackupInfo();\r\n      const ageMinutes = Math.floor(backupInfo.age / (1000 * 60));\r\n\r\n      // Auto-restore if backup is recent (less than 30 minutes)\r\n      if (ageMinutes < 30) {\r\n        this.currentContent = backup;\r\n        console.log(\r\n          `📦 Auto-restored content from backup (${ageMinutes} minutes old)`\r\n        );\r\n      } else {\r\n        this.currentContent = content;\r\n        this.storageManager.clearLocalStorage();\r\n        console.log(\r\n          `📦 Backup too old (${ageMinutes} minutes), using original content`\r\n        );\r\n      }\r\n    } else {\r\n      this.currentContent = content;\r\n    }\r\n\r\n    this.originalContent = JSON.parse(JSON.stringify(content)); // Deep copy of original\r\n    this.isEditorOpen = true;\r\n\r\n    // Extract Mermaid diagrams from content\r\n    this.extractMermaidDiagrams();\r\n\r\n    // Create editor UI\r\n    this.createEditorUI(options);\r\n\r\n    // Initialize content tab (default)\r\n    this.initializeContentTab();\r\n  }\r\n\r\n  createEditorUI() {\r\n    const overlay = DOMHelpers.createElement(\"div\", {\r\n      className: \"confluence-editor-overlay\",\r\n    });\r\n\r\n    DOMHelpers.setContent(overlay, HTMLTemplates.getEditorTemplate(), true);\r\n    document.body.appendChild(overlay);\r\n    this.editorContainer = overlay;\r\n\r\n    // Bind events\r\n    this.bindEditorEvents();\r\n  }\r\n\r\n  bindEditorEvents() {\r\n    if (!this.editorContainer) return;\r\n\r\n    // Close button\r\n    const closeBtn = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#editor-close-btn\"\r\n    );\r\n    console.log(\"🔍 Close button found:\", !!closeBtn);\r\n    if (closeBtn) {\r\n      DOMHelpers.addEventListener(closeBtn, \"click\", () => {\r\n        console.log(\"🔄 Close button clicked\");\r\n        this.closeEditor();\r\n      });\r\n    } else {\r\n      console.error(\"❌ Close button not found!\");\r\n    }\r\n\r\n    // Save button\r\n    const saveBtn = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#editor-save-btn\"\r\n    );\r\n    console.log(\"🔍 Save button found:\", !!saveBtn);\r\n    if (saveBtn) {\r\n      DOMHelpers.addEventListener(saveBtn, \"click\", () => {\r\n        console.log(\"💾 Save button clicked\");\r\n        this.saveChanges();\r\n      });\r\n    } else {\r\n      console.error(\"❌ Save button not found!\");\r\n    }\r\n\r\n    // Tab buttons\r\n    const contentTab = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#content-tab\"\r\n    );\r\n    const mermaidTab = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#mermaid-tab\"\r\n    );\r\n\r\n    DOMHelpers.addEventListener(contentTab, \"click\", () =>\r\n      this.switchTab(\"content\")\r\n    );\r\n    DOMHelpers.addEventListener(mermaidTab, \"click\", () =>\r\n      this.switchTab(\"mermaid\")\r\n    );\r\n\r\n    // Content tab elements\r\n    const rawEditor = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#raw-content-editor\"\r\n    );\r\n    DOMHelpers.addEventListener(rawEditor, \"input\", () =>\r\n      this.updateContentPreview()\r\n    );\r\n\r\n    // Mermaid tab elements\r\n    const mermaidSelector = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#mermaid-selector\"\r\n    );\r\n    const mermaidCodeEditor = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#mermaid-code-editor\"\r\n    );\r\n    const aiSendBtn = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#ai-send-btn\"\r\n    );\r\n    const aiPromptInput = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#ai-prompt-input\"\r\n    );\r\n\r\n    DOMHelpers.addEventListener(mermaidSelector, \"change\", (e) =>\r\n      this.selectMermaidDiagram(e.target.value)\r\n    );\r\n\r\n    DOMHelpers.addEventListener(mermaidCodeEditor, \"input\", () => {\r\n      this.debouncedUpdateMermaidPreview();\r\n    });\r\n\r\n    DOMHelpers.addEventListener(aiSendBtn, \"click\", () => this.sendAIPrompt());\r\n\r\n    DOMHelpers.addEventListener(aiPromptInput, \"keypress\", (e) => {\r\n      if (e.key === \"Enter\" && !e.shiftKey) {\r\n        e.preventDefault();\r\n        this.sendAIPrompt();\r\n      }\r\n    });\r\n\r\n    // Zoom controls\r\n    const zoomInBtn = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#zoom-in\"\r\n    );\r\n    const zoomOutBtn = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#zoom-out\"\r\n    );\r\n    const zoomResetBtn = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#zoom-reset\"\r\n    );\r\n\r\n    DOMHelpers.addEventListener(zoomInBtn, \"click\", () => this.zoomIn());\r\n    DOMHelpers.addEventListener(zoomOutBtn, \"click\", () => this.zoomOut());\r\n    DOMHelpers.addEventListener(zoomResetBtn, \"click\", () => this.resetZoom());\r\n\r\n    // Add wheel zoom to mermaid preview\r\n    const mermaidPreview = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#mermaid-preview\"\r\n    );\r\n    DOMHelpers.addEventListener(mermaidPreview, \"wheel\", (e) =>\r\n      this.handleWheel(e)\r\n    );\r\n\r\n    // Close on overlay click\r\n    DOMHelpers.addEventListener(this.editorContainer, \"click\", (e) => {\r\n      if (e.target === this.editorContainer) {\r\n        this.closeEditor();\r\n      }\r\n    });\r\n\r\n    // ESC key to close\r\n    const handleEsc = (e) => {\r\n      if (e.key === \"Escape\") {\r\n        this.closeEditor();\r\n        DOMHelpers.removeEventListener(document, \"keydown\", handleEsc);\r\n      }\r\n    };\r\n    DOMHelpers.addEventListener(document, \"keydown\", handleEsc);\r\n  }\r\n\r\n  // Switch between tabs\r\n  switchTab(tabName) {\r\n    // Update tab buttons\r\n    const tabs = DOMHelpers.querySelectorAll(\r\n      this.editorContainer,\r\n      \".confluence-editor-tab\"\r\n    );\r\n    tabs.forEach((tab) => DOMHelpers.removeClass(tab, \"active\"));\r\n\r\n    const activeTab = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      `#${tabName}-tab`\r\n    );\r\n    DOMHelpers.addClass(activeTab, \"active\");\r\n\r\n    // Update tab content\r\n    const tabContents = DOMHelpers.querySelectorAll(\r\n      this.editorContainer,\r\n      \".tab-content\"\r\n    );\r\n    tabContents.forEach((content) => DOMHelpers.removeClass(content, \"active\"));\r\n\r\n    const activeContent = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      `#${tabName}-tab-content`\r\n    );\r\n    DOMHelpers.addClass(activeContent, \"active\");\r\n\r\n    // Initialize tab-specific content\r\n    if (tabName === \"content\") {\r\n      this.initializeContentTab();\r\n    } else if (tabName === \"mermaid\") {\r\n      this.initializeMermaidTab();\r\n    }\r\n\r\n    console.log(`Switched to ${tabName} tab`);\r\n  }\r\n\r\n  // Initialize content tab\r\n  initializeContentTab() {\r\n    const rawEditor = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#raw-content-editor\"\r\n    );\r\n\r\n    console.log(\"🔍 Initializing content tab...\");\r\n    console.log(\"Raw editor found:\", !!rawEditor);\r\n    console.log(\"Current content exists:\", !!this.currentContent);\r\n\r\n    if (rawEditor && this.currentContent) {\r\n      // Get raw content and clean up ```xml markers\r\n      let rawContent =\r\n        this.currentContent.full_storage_format ||\r\n        this.currentContent.content ||\r\n        \"\";\r\n\r\n      console.log(\"Raw content length:\", rawContent.length);\r\n\r\n      // Clean XML markers and format for better readability\r\n      rawContent = XMLFormatter.cleanXMLMarkers(rawContent);\r\n      rawContent = XMLFormatter.formatXHTML(rawContent);\r\n\r\n      console.log(\"Formatted content length:\", rawContent.length);\r\n\r\n      // Set content using direct assignment and DOMHelpers\r\n      rawEditor.value = rawContent;\r\n      DOMHelpers.setContent(rawEditor, rawContent);\r\n\r\n      console.log(\"✅ Content set to raw editor\");\r\n      this.updateContentPreview();\r\n    } else {\r\n      console.warn(\r\n        \"⚠️ Cannot initialize content tab - missing rawEditor or currentContent\"\r\n      );\r\n    }\r\n  }\r\n\r\n  // Initialize mermaid tab\r\n  initializeMermaidTab() {\r\n    console.log(\"🔍 Initializing mermaid tab...\");\r\n\r\n    // Always extract diagrams to ensure sync with current content\r\n    console.log(\"📊 Extracting diagrams from current content...\");\r\n    this.extractMermaidDiagrams();\r\n\r\n    console.log(\"Diagrams available:\", this.mermaidDiagrams.length);\r\n    console.log(\"DiagramsMap size:\", this.mermaidDiagramsMap.size);\r\n    this.populateMermaidSelector();\r\n  }\r\n\r\n  // Update content preview\r\n  updateContentPreview() {\r\n    const rawEditor = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#raw-content-editor\"\r\n    );\r\n    const preview = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#content-preview\"\r\n    );\r\n\r\n    if (!rawEditor || !preview) return;\r\n\r\n    const content = DOMHelpers.getContent(rawEditor);\r\n\r\n    // Update current content\r\n    if (this.currentContent) {\r\n      this.currentContent.full_storage_format = content;\r\n      // Mark as modified if content changed\r\n      if (\r\n        this.originalContent &&\r\n        content !== this.originalContent.full_storage_format\r\n      ) {\r\n        this.isModified = true;\r\n        this.updateSaveButtonState();\r\n      }\r\n    }\r\n\r\n    // Render preview\r\n    this.renderContentPreview(content, preview);\r\n  }\r\n\r\n  // Render content preview\r\n  renderContentPreview(content, previewElement) {\r\n    // Apply inline styles for preview\r\n    const processedContent = HTMLTemplates.applyPreviewStyles(content);\r\n\r\n    // Set the processed content to preview element\r\n    DOMHelpers.setContent(previewElement, processedContent, true);\r\n\r\n    // Render Mermaid diagrams\r\n    this.renderMermaidDiagramsInPreview();\r\n  }\r\n\r\n  // Render Mermaid diagrams in preview\r\n  renderMermaidDiagramsInPreview() {\r\n    // Use the new comprehensive Mermaid initialization\r\n    setTimeout(() => {\r\n      this.initializeMermaidInPreview();\r\n    }, 100);\r\n  }\r\n\r\n  // Initialize Mermaid diagrams in preview\r\n  async initializeMermaidInPreview() {\r\n    try {\r\n      // Initialize Mermaid\r\n      await MermaidRenderer.initializeMermaid();\r\n\r\n      console.log(\"🎨 Initializing Mermaid diagrams in preview...\");\r\n\r\n      // Find all mermaid code blocks in the preview\r\n      const previewDiv = DOMHelpers.querySelector(\r\n        this.editorContainer,\r\n        \"#content-preview\"\r\n      );\r\n      if (!previewDiv) return;\r\n\r\n      // Look for Confluence Mermaid structured macros\r\n      const mermaidElements = DOMHelpers.querySelectorAll(\r\n        previewDiv,\r\n        'ac\\\\:structured-macro[ac\\\\:name=\"mermaid\"]'\r\n      );\r\n\r\n      mermaidElements.forEach(async (element, index) => {\r\n        // Get the code parameter from Confluence structured macro\r\n        const codeParam = DOMHelpers.querySelector(\r\n          element,\r\n          'ac\\\\:parameter[ac\\\\:name=\"code\"]'\r\n        );\r\n        if (!codeParam) {\r\n          console.warn(\"⚠️ Mermaid macro found but no code parameter\");\r\n          return;\r\n        }\r\n\r\n        const mermaidCode = DOMHelpers.getContent(codeParam).trim();\r\n        console.log(\r\n          \"🔍 Found Confluence Mermaid diagram:\",\r\n          mermaidCode.substring(0, 50) + \"...\"\r\n        );\r\n\r\n        // Always process Confluence mermaid macros\r\n        if (mermaidCode) {\r\n          // Create a new div for the mermaid diagram\r\n          const mermaidDiv = HTMLTemplates.createMermaidContainer(index);\r\n\r\n          // Validate parent node before replacing\r\n          if (!element.parentNode) {\r\n            console.error(\r\n              \"❌ Cannot replace Mermaid element in preview: no parent node\"\r\n            );\r\n            console.error(\r\n              \"❌ Mermaid code:\",\r\n              mermaidCode.substring(0, 100) + \"...\"\r\n            );\r\n            return;\r\n          }\r\n\r\n          // Replace the original element\r\n          try {\r\n            element.parentNode.replaceChild(mermaidDiv, element);\r\n          } catch (replaceError) {\r\n            console.error(\r\n              \"❌ Failed to replace Mermaid element in preview:\",\r\n              replaceError\r\n            );\r\n            console.error(\r\n              \"❌ Mermaid code:\",\r\n              mermaidCode.substring(0, 100) + \"...\"\r\n            );\r\n            return;\r\n          }\r\n\r\n          // Render the diagram\r\n          const diagramId = `preview-mermaid-svg-${index}`;\r\n          await MermaidRenderer.renderDiagram(\r\n            diagramId,\r\n            mermaidCode,\r\n            mermaidDiv\r\n          );\r\n        }\r\n      });\r\n    } catch (error) {\r\n      console.error(\"❌ Failed to initialize Mermaid in preview:\", error);\r\n    }\r\n  }\r\n\r\n  // Populate mermaid selector using Map\r\n  populateMermaidSelector() {\r\n    const selector = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#mermaid-selector\"\r\n    );\r\n    if (!selector) {\r\n      console.error(\"❌ Mermaid selector not found\");\r\n      return;\r\n    }\r\n\r\n    console.log(\"🔄 Populating Mermaid selector...\");\r\n    console.log(`📊 DiagramsMap size: ${this.mermaidDiagramsMap?.size || 0}`);\r\n    console.log(`📊 Current options count: ${selector.options.length}`);\r\n\r\n    // Clear ALL existing options completely\r\n    selector.innerHTML = \"\";\r\n\r\n    // Add default option\r\n    const defaultOption = document.createElement(\"option\");\r\n    defaultOption.value = \"\";\r\n    defaultOption.textContent = \"📊 Select diagram to edit...\";\r\n    selector.appendChild(defaultOption);\r\n\r\n    console.log(`📊 After clear, options count: ${selector.options.length}`);\r\n\r\n    // Only add diagrams that actually exist in current content\r\n    if (this.mermaidDiagramsMap && this.mermaidDiagramsMap.size > 0) {\r\n      let addedCount = 0;\r\n\r\n      // Create a Set to track added diagram IDs to prevent duplicates\r\n      const addedDiagrams = new Set();\r\n\r\n      this.mermaidDiagramsMap.forEach((diagramData, diagramId) => {\r\n        // Only add if not already added and has valid content\r\n        if (\r\n          !addedDiagrams.has(diagramId) &&\r\n          diagramData.content &&\r\n          diagramData.content.trim()\r\n        ) {\r\n          const option = document.createElement(\"option\");\r\n          option.value = diagramId;\r\n          option.textContent = `${diagramData.title} (${diagramData.type})`;\r\n          selector.appendChild(option);\r\n          addedDiagrams.add(diagramId);\r\n          addedCount++;\r\n          console.log(\r\n            `📊 Added option ${addedCount}: ${diagramData.title} (${diagramData.type})`\r\n          );\r\n        }\r\n      });\r\n\r\n      console.log(\r\n        `✅ Added ${addedCount} unique diagrams to selector (total options: ${selector.options.length})`\r\n      );\r\n    } else {\r\n      console.warn(\"⚠️ No Mermaid diagrams found to populate selector\");\r\n    }\r\n\r\n    // Remove existing event listener to prevent duplicates\r\n    if (this.handleMermaidSelectorChange) {\r\n      selector.removeEventListener(\"change\", this.handleMermaidSelectorChange);\r\n    }\r\n\r\n    // Add fresh event listener\r\n    this.handleMermaidSelectorChange = (e) => {\r\n      const selectedId = e.target.value;\r\n      console.log(`🎯 Selected diagram: ${selectedId}`);\r\n      this.selectMermaidDiagram(selectedId);\r\n    };\r\n    selector.addEventListener(\"change\", this.handleMermaidSelectorChange);\r\n\r\n    console.log(\r\n      `✅ Populated ${this.mermaidDiagramsMap?.size || 0} diagrams in selector`\r\n    );\r\n  }\r\n\r\n  // Select mermaid diagram\r\n  selectMermaidDiagram(diagramId) {\r\n    if (!diagramId) {\r\n      this.clearMermaidEditor();\r\n      return;\r\n    }\r\n\r\n    // Get diagram from Map\r\n    const diagramData = this.mermaidDiagramsMap.get(diagramId);\r\n    if (!diagramData) {\r\n      console.error(`❌ Diagram not found in map: ${diagramId}`);\r\n      return;\r\n    }\r\n\r\n    // Find full diagram record from array\r\n    const diagram = this.mermaidDiagrams.find((d) => d.id === diagramId);\r\n    if (!diagram) {\r\n      console.error(`❌ Diagram not found in array: ${diagramId}`);\r\n      return;\r\n    }\r\n\r\n    // Update code editor\r\n    const codeEditor = this.editorContainer.querySelector(\r\n      \"#mermaid-code-editor\"\r\n    );\r\n    if (codeEditor) {\r\n      codeEditor.value = diagramData.content;\r\n      this.currentSelectedDiagram = diagram;\r\n      this.currentSelectedDiagramId = diagramId;\r\n      this.updateMermaidPreview().catch((error) => {\r\n        console.error(\"❌ Error updating Mermaid preview:\", error);\r\n      });\r\n\r\n      // Add event listener for code changes\r\n      codeEditor.removeEventListener(\"input\", this.handleMermaidCodeChange);\r\n      this.handleMermaidCodeChange = () => {\r\n        if (this.currentSelectedDiagram && this.currentSelectedDiagramId) {\r\n          const newCode = codeEditor.value;\r\n          console.log(\"new code\", newCode);\r\n          // Update diagram code in memory (both array and map)\r\n          this.currentSelectedDiagram.code = newCode;\r\n          this.mermaidDiagramsMap.get(this.currentSelectedDiagramId).content =\r\n            newCode;\r\n\r\n          // Track the change for synchronization\r\n          this.contentSynchronizer.trackDiagramChange(\r\n            this.currentSelectedDiagramId,\r\n            newCode\r\n          );\r\n\r\n          // Update preview with debouncing\r\n          this.debouncedUpdateMermaidPreview();\r\n\r\n          // Mark as modified\r\n          this.isModified = true;\r\n          this.updateSaveButtonState();\r\n\r\n          console.log(`📝 Updated diagram ${this.currentSelectedDiagramId}`);\r\n        }\r\n      };\r\n      codeEditor.addEventListener(\"input\", this.handleMermaidCodeChange);\r\n    }\r\n\r\n    console.log(`✅ Selected diagram: ${diagramId} (${diagramData.type})`);\r\n  }\r\n\r\n  // Clear mermaid editor\r\n  clearMermaidEditor() {\r\n    const codeEditor = this.editorContainer.querySelector(\r\n      \"#mermaid-code-editor\"\r\n    );\r\n    const preview = this.editorContainer.querySelector(\"#mermaid-preview\");\r\n\r\n    if (codeEditor) codeEditor.value = \"\";\r\n    if (preview) {\r\n      preview.innerHTML =\r\n        '<div class=\"mermaid-placeholder\">Select a diagram to preview</div>';\r\n    }\r\n\r\n    this.currentSelectedDiagram = null;\r\n  }\r\n\r\n  // ✅ Simple debounced update - no anti-flicker interference\r\n  debouncedUpdateMermaidPreview() {\r\n    // Only skip if actively zooming (not if just updated recently)\r\n    if (this.isZooming) {\r\n      return;\r\n    }\r\n\r\n    // Clear existing timeout\r\n    if (this.previewUpdateTimeout) {\r\n      clearTimeout(this.previewUpdateTimeout);\r\n    }\r\n\r\n    // Set new timeout\r\n    this.previewUpdateTimeout = setTimeout(() => {\r\n      if (!this.isZooming && !this.isUpdatingPreview) {\r\n        this.updateMermaidPreview().catch((error) => {\r\n          console.error(\"❌ Error updating Mermaid preview:\", error);\r\n        });\r\n      }\r\n    }, 300); // Increased debounce for stability\r\n  }\r\n\r\n  // Update mermaid preview\r\n  async updateMermaidPreview() {\r\n    // ✅ Skip update if currently zooming to prevent flicker\r\n    if (this.isZooming) {\r\n      return;\r\n    }\r\n\r\n    // ✅ Skip if already updating to prevent concurrent updates\r\n    if (this.isUpdatingPreview) {\r\n      return;\r\n    }\r\n\r\n    // ✅ Set updating flag\r\n    this.isUpdatingPreview = true;\r\n\r\n    const codeEditor = this.editorContainer.querySelector(\r\n      \"#mermaid-code-editor\"\r\n    );\r\n    const preview = this.editorContainer.querySelector(\"#mermaid-preview\");\r\n\r\n    if (!codeEditor || !preview) return;\r\n\r\n    const code = codeEditor.value.trim();\r\n    if (!code) {\r\n      preview.innerHTML =\r\n        '<div class=\"mermaid-placeholder\">Enter Mermaid code to preview</div>';\r\n      return;\r\n    }\r\n\r\n    // ✅ Store current zoom level\r\n    const currentZoom = this.currentZoom;\r\n\r\n    // Update current diagram\r\n    if (this.currentSelectedDiagram) {\r\n      this.currentSelectedDiagram.code = code;\r\n    }\r\n\r\n    // Render mermaid using MermaidRenderer to avoid SVG error appending\r\n    try {\r\n      // Clear preview first\r\n      preview.innerHTML =\r\n        '<div class=\"mermaid-placeholder\">Rendering diagram...</div>';\r\n\r\n      // Create unique diagram ID\r\n      const diagramId = `mermaid-editor-preview-${Date.now()}`;\r\n\r\n      // Use MermaidRenderer to safely render the diagram\r\n      await MermaidRenderer.renderDiagram(diagramId, code, preview);\r\n\r\n      // ✅ Reapply zoom after rendering to maintain zoom level\r\n      setTimeout(() => {\r\n        if (currentZoom !== 1) {\r\n          this.currentZoom = currentZoom;\r\n        }\r\n        this.updateZoom();\r\n      }, 100);\r\n    } catch (error) {\r\n      console.error(\"❌ Error rendering Mermaid in editor preview:\", error);\r\n      preview.innerHTML = `\r\n        <div class=\"mermaid-placeholder\" style=\"color: #dc3545;\">\r\n          ❌ Error rendering diagram:<br>\r\n          <small>${error.message}</small>\r\n        </div>\r\n      `;\r\n    } finally {\r\n      // ✅ Always reset updating flag\r\n      this.isUpdatingPreview = false;\r\n    }\r\n  }\r\n\r\n  // Send AI prompt - EXACT copy from extension logic\r\n  async sendAIPrompt() {\r\n    const promptInput = this.editorContainer.querySelector(\"#ai-prompt-input\");\r\n    const messagesContainer =\r\n      this.editorContainer.querySelector(\"#ai-chat-messages\");\r\n\r\n    if (!promptInput || !messagesContainer) return;\r\n\r\n    const prompt = promptInput.value.trim();\r\n    if (!prompt) return;\r\n\r\n    // Check if a diagram is selected and validate it\r\n    if (!this.currentSelectedDiagram || !this.currentSelectedDiagramId) {\r\n      this.addAIMessage(\r\n        \"ai\",\r\n        \"⚠️ Please select a Mermaid diagram first to edit it.\"\r\n      );\r\n      return;\r\n    }\r\n\r\n    // Double-check the selected diagram exists in the map\r\n    const diagramInMap = this.mermaidDiagramsMap.get(\r\n      this.currentSelectedDiagramId\r\n    );\r\n    if (!diagramInMap) {\r\n      this.addAIMessage(\r\n        \"ai\",\r\n        \"❌ Selected diagram not found. Please select a valid diagram.\"\r\n      );\r\n      return;\r\n    }\r\n\r\n    console.log(`🎯 AI editing diagram: ${this.currentSelectedDiagramId}`, {\r\n      title: diagramInMap.title,\r\n      type: diagramInMap.type,\r\n      currentCode: this.currentSelectedDiagram.code?.substring(0, 50) + \"...\",\r\n    });\r\n\r\n    // Add user message\r\n    this.addAIMessage(\"user\", prompt);\r\n\r\n    // Clear input and show loading\r\n    promptInput.value = \"\";\r\n    this.addAIMessage(\"ai\", \"🤖 Processing your request...\");\r\n\r\n    try {\r\n      // Get current settings for AI model\r\n      const settings = await ChromeStorageManager.getSettings();\r\n\r\n      // Prepare request payload similar to extension\r\n      const requestBody = {\r\n        content: this.currentContent?.full_storage_format || \"\",\r\n        diagram_code: this.currentSelectedDiagram.code,\r\n        user_request: prompt,\r\n        selectedModel: settings.selectedModel || \"sonar-pro\",\r\n      };\r\n\r\n      console.log(\"🤖 Sending AI request:\", requestBody);\r\n\r\n      // Call AI API (same endpoint as extension)\r\n      const response = await fetch(API_URLS.EDIT_DIAGRAM, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify(requestBody),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorData = await response.json();\r\n        throw new Error(\r\n          errorData.error || `HTTP ${response.status}: ${response.statusText}`\r\n        );\r\n      }\r\n\r\n      const data = await response.json();\r\n\r\n      if (data.success && data.edited_diagram) {\r\n        // Clean and validate the AI response\r\n        const cleanedDiagram = this.cleanAIResponse(data.edited_diagram);\r\n\r\n        if (cleanedDiagram && cleanedDiagram.trim()) {\r\n          // Validate we're still editing the same diagram\r\n          const currentDiagramInMap = this.mermaidDiagramsMap.get(\r\n            this.currentSelectedDiagramId\r\n          );\r\n          if (!currentDiagramInMap) {\r\n            throw new Error(\"Selected diagram no longer exists\");\r\n          }\r\n\r\n          console.log(`🔄 Updating diagram ${this.currentSelectedDiagramId}:`, {\r\n            oldCode: this.currentSelectedDiagram.code?.substring(0, 30) + \"...\",\r\n            newCode: cleanedDiagram.substring(0, 30) + \"...\",\r\n          });\r\n\r\n          // Update ONLY the selected diagram\r\n          this.currentSelectedDiagram.code = cleanedDiagram;\r\n          currentDiagramInMap.content = cleanedDiagram;\r\n\r\n          // Update the code editor to reflect the change\r\n          const codeEditor = this.editorContainer.querySelector(\r\n            \"#mermaid-code-editor\"\r\n          );\r\n          if (codeEditor) {\r\n            codeEditor.value = cleanedDiagram;\r\n            console.log(\"✅ Code editor updated with AI response\");\r\n          }\r\n\r\n          // Update preview for this specific diagram\r\n          this.updateMermaidPreview().catch((error) => {\r\n            console.error(\"❌ Error updating Mermaid preview:\", error);\r\n          });\r\n\r\n          // Mark content as modified for synchronization\r\n          console.log(\r\n            `🔄 Diagram ${this.currentSelectedDiagramId} updated by AI`\r\n          );\r\n\r\n          // Update the content will be handled by syncAllContent when saving\r\n\r\n          // Remove loading message and add success message\r\n          this.removeLastAIMessage();\r\n          this.addAIMessage(\"ai\", `✅ Updated diagram: ${prompt}`);\r\n\r\n          // Show success notification\r\n          if (\r\n            typeof window !== \"undefined\" &&\r\n            window[\"KToolNotificationUtils\"]\r\n          ) {\r\n            window[\"KToolNotificationUtils\"].success(\r\n              \"AI Assistant\",\r\n              \"Diagram updated successfully!\"\r\n            );\r\n          }\r\n        } else {\r\n          throw new Error(\"Invalid Mermaid syntax in AI response\");\r\n        }\r\n      } else {\r\n        throw new Error(\"Invalid response format or missing edited_diagram\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"❌ AI API Error:\", error);\r\n\r\n      // Remove loading message and add error message\r\n      this.removeLastAIMessage();\r\n      this.addAIMessage(\r\n        \"ai\",\r\n        `❌ Error: ${error.message}\\n\\n🔄 Please try again or adjust your request.`\r\n      );\r\n\r\n      // Show error notification\r\n      if (typeof window !== \"undefined\" && window[\"KToolNotificationUtils\"]) {\r\n        window[\"KToolNotificationUtils\"].error(\r\n          \"AI Assistant\",\r\n          `Error: ${error.message}`\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  // Clean AI response - enhanced validation\r\n  cleanAIResponse(response) {\r\n    if (!response) return \"\";\r\n\r\n    console.log(\"🧹 Cleaning AI response:\", response.substring(0, 100) + \"...\");\r\n\r\n    // Remove markdown code blocks and common AI response patterns\r\n    let cleaned = response\r\n      .replace(/```mermaid\\n?/gi, \"\")\r\n      .replace(/```\\n?/g, \"\")\r\n      .replace(/^Here's the updated.*?:\\s*/i, \"\")\r\n      .replace(/^Updated diagram.*?:\\s*/i, \"\")\r\n      .replace(/^The modified.*?:\\s*/i, \"\");\r\n\r\n    // Remove extra whitespace and newlines at start/end\r\n    cleaned = cleaned.trim();\r\n\r\n    // Split by lines and remove empty lines at start/end\r\n    const lines = cleaned.split(\"\\n\");\r\n    const nonEmptyStart = lines.findIndex((line) => line.trim() !== \"\");\r\n    const nonEmptyEnd = lines\r\n      .slice()\r\n      .reverse()\r\n      .findIndex((line) => line.trim() !== \"\");\r\n\r\n    if (nonEmptyStart !== -1 && nonEmptyEnd !== -1) {\r\n      cleaned = lines\r\n        .slice(nonEmptyStart, lines.length - nonEmptyEnd)\r\n        .join(\"\\n\");\r\n    }\r\n\r\n    // Basic validation - should start with a mermaid diagram type\r\n    const validStarts = [\r\n      \"graph\",\r\n      \"flowchart\",\r\n      \"sequenceDiagram\",\r\n      \"classDiagram\",\r\n      \"stateDiagram\",\r\n      \"erDiagram\",\r\n      \"journey\",\r\n      \"gantt\",\r\n      \"pie\",\r\n      \"gitgraph\",\r\n      \"mindmap\",\r\n      \"timeline\",\r\n    ];\r\n\r\n    const firstLine = cleaned.split(\"\\n\")[0].trim().toLowerCase();\r\n    const hasValidStart = validStarts.some((start) =>\r\n      firstLine.startsWith(start.toLowerCase())\r\n    );\r\n\r\n    if (!hasValidStart) {\r\n      console.warn(\r\n        \"⚠️ AI response may not be valid Mermaid syntax:\",\r\n        firstLine\r\n      );\r\n      console.warn(\"Expected to start with one of:\", validStarts.join(\", \"));\r\n    }\r\n\r\n    console.log(\"✅ Cleaned AI response:\", cleaned.substring(0, 100) + \"...\");\r\n    return cleaned;\r\n  }\r\n\r\n  // Remove last AI message (for loading states)\r\n  removeLastAIMessage() {\r\n    const messagesContainer =\r\n      this.editorContainer.querySelector(\"#ai-chat-messages\");\r\n    if (!messagesContainer) return;\r\n\r\n    const messages = messagesContainer.querySelectorAll(\".ai-message\");\r\n    if (messages.length > 0) {\r\n      const lastMessage = messages[messages.length - 1];\r\n      if (\r\n        lastMessage.querySelector(\".ai-text\").textContent.includes(\"Processing\")\r\n      ) {\r\n        lastMessage.remove();\r\n      }\r\n    }\r\n  }\r\n\r\n  // Add AI message\r\n  addAIMessage(type, text) {\r\n    const messagesContainer = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#ai-chat-messages\"\r\n    );\r\n    if (!messagesContainer) return;\r\n\r\n    const messageHTML = HTMLTemplates.createAIMessage(type, text);\r\n    DOMHelpers.setContent(\r\n      messagesContainer,\r\n      DOMHelpers.getContent(messagesContainer) + messageHTML,\r\n      true\r\n    );\r\n    messagesContainer.scrollTop = messagesContainer.scrollHeight;\r\n  }\r\n\r\n  extractMermaidDiagrams() {\r\n    if (!this.currentContent?.full_storage_format) {\r\n      this.mermaidDiagrams = [];\r\n      this.mermaidDiagramsMap = new Map();\r\n      return;\r\n    }\r\n\r\n    const { diagrams, diagramsMap } = MermaidRenderer.extractMermaidDiagrams(\r\n      this.currentContent.full_storage_format\r\n    );\r\n\r\n    this.mermaidDiagrams = diagrams;\r\n    this.mermaidDiagramsMap = diagramsMap;\r\n  }\r\n\r\n  updateStatus(message) {\r\n    const status = this.editorContainer?.querySelector(\"#editor-status\");\r\n    if (status) {\r\n      status.textContent = message;\r\n      setTimeout(() => {\r\n        status.textContent = \"Sẵn sàng\";\r\n      }, 3000);\r\n    }\r\n  }\r\n\r\n  async saveChanges() {\r\n    console.log(\"💾 Saving changes...\");\r\n\r\n    try {\r\n      // Sync all content sources\r\n      this.currentContent = this.contentSynchronizer.syncAllContent(\r\n        this.currentContent,\r\n        this.editorContainer,\r\n        this.mermaidDiagrams\r\n      );\r\n\r\n      // Validate content before saving\r\n      const validation = this.contentSynchronizer.validateContent(\r\n        this.currentContent\r\n      );\r\n      if (!validation.isValid) {\r\n        throw new Error(\r\n          `Content validation failed: ${validation.errors.join(\", \")}`\r\n        );\r\n      }\r\n\r\n      // Save using storage manager (supports both callback and localStorage)\r\n      const saveResults = await this.storageManager.saveContent(\r\n        this.currentContent,\r\n        this.onSave,\r\n        {\r\n          enableLocalStorage: true,\r\n          enableCallback: true,\r\n          showNotification: true,\r\n        }\r\n      );\r\n\r\n      // Reset modified state and update button\r\n      this.isModified = false;\r\n      this.updateSaveButtonState();\r\n\r\n      // Update original content to new saved state\r\n      this.originalContent = JSON.parse(JSON.stringify(this.currentContent));\r\n\r\n      // Don't re-extract diagrams after save to avoid duplicates\r\n      console.log(\"✅ Skipping diagram re-extraction to prevent duplicates\");\r\n\r\n      console.log(\"✅ Changes saved successfully\", saveResults);\r\n\r\n      // Save completed - auto close editor immediately\r\n      console.log(\"💾 Save completed - closing editor...\");\r\n      this.closeEditor();\r\n    } catch (error) {\r\n      console.error(\"❌ Error saving changes:\", error);\r\n      this.storageManager.showNotification(\r\n        `❌ Lỗi khi lưu: ${error.message}`,\r\n        \"error\"\r\n      );\r\n    }\r\n  }\r\n\r\n  // Update save button state based on modifications\r\n  updateSaveButtonState() {\r\n    const saveBtn = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#editor-save-btn\"\r\n    );\r\n    if (!saveBtn) return;\r\n\r\n    if (this.isModified) {\r\n      DOMHelpers.setContent(saveBtn, \"💾 Save *\");\r\n      saveBtn.style.background = \"#28a745\";\r\n      saveBtn.title = \"Có thay đổi chưa lưu\";\r\n    } else {\r\n      DOMHelpers.setContent(saveBtn, \"💾 Save\");\r\n      saveBtn.style.background = \"#007bff\";\r\n      saveBtn.title = \"Save\";\r\n    }\r\n  }\r\n\r\n  // ✅ Stop all preview updates for zoom\r\n  stopAllPreviewUpdates() {\r\n    // Clear timeout\r\n    if (this.previewUpdateTimeout) {\r\n      clearTimeout(this.previewUpdateTimeout);\r\n      this.previewUpdateTimeout = null;\r\n    }\r\n\r\n    // Set flags\r\n    this.isZooming = true;\r\n    this.isUpdatingPreview = false;\r\n  }\r\n\r\n  // Zoom controls methods\r\n  zoomIn() {\r\n    if (this.currentZoom < this.maxZoom) {\r\n      this.stopAllPreviewUpdates(); // ✅ Stop updates first\r\n      this.currentZoom = Math.min(\r\n        this.currentZoom + this.zoomStep,\r\n        this.maxZoom\r\n      );\r\n      this.applyZoom();\r\n    }\r\n  }\r\n\r\n  zoomOut() {\r\n    if (this.currentZoom > this.minZoom) {\r\n      this.stopAllPreviewUpdates(); // ✅ Stop updates first\r\n      this.currentZoom = Math.max(\r\n        this.currentZoom - this.zoomStep,\r\n        this.minZoom\r\n      );\r\n      this.applyZoom();\r\n    }\r\n  }\r\n\r\n  resetZoom() {\r\n    this.stopAllPreviewUpdates(); // ✅ Stop updates first\r\n    this.currentZoom = 1;\r\n    this.dragOffset = { x: 0, y: 0 };\r\n    this.applyZoom();\r\n  }\r\n\r\n  // ✅ Apply zoom with anti-flicker\r\n  applyZoom() {\r\n    // Set zoom flag to prevent flicker\r\n    this.isZooming = true;\r\n\r\n    // Clear any pending preview updates\r\n    if (this.previewUpdateTimeout) {\r\n      clearTimeout(this.previewUpdateTimeout);\r\n      this.previewUpdateTimeout = null;\r\n    }\r\n\r\n    // Apply zoom\r\n    this.updateZoom();\r\n\r\n    // Reset zoom flag\r\n    setTimeout(() => {\r\n      this.isZooming = false;\r\n    }, 100);\r\n  }\r\n\r\n  updateZoom() {\r\n    const preview = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#mermaid-preview\"\r\n    );\r\n    const zoomLevel = DOMHelpers.querySelector(\r\n      this.editorContainer,\r\n      \"#zoom-level\"\r\n    );\r\n\r\n    if (preview) {\r\n      const mermaidContent = DOMHelpers.querySelector(preview, \".mermaid, svg\");\r\n      if (mermaidContent) {\r\n        mermaidContent.style.transform = `scale(${this.currentZoom}) translate(${this.dragOffset.x}px, ${this.dragOffset.y}px)`;\r\n        mermaidContent.style.transformOrigin = \"center center\";\r\n        mermaidContent.style.transition = \"transform 0.2s ease\";\r\n      }\r\n    }\r\n\r\n    if (zoomLevel) {\r\n      DOMHelpers.setContent(\r\n        zoomLevel,\r\n        `${Math.round(this.currentZoom * 100)}%`\r\n      );\r\n    }\r\n  }\r\n\r\n  handleWheel(e) {\r\n    e.preventDefault();\r\n    if (e.deltaY < 0) {\r\n      this.zoomIn();\r\n    } else {\r\n      this.zoomOut();\r\n    }\r\n  }\r\n\r\n  closeEditor() {\r\n    console.log(\"🔄 Closing editor...\");\r\n\r\n    // Stop auto-save\r\n    this.storageManager.stopAutoSave();\r\n\r\n    if (this.editorContainer) {\r\n      DOMHelpers.removeElement(this.editorContainer);\r\n      this.editorContainer = null;\r\n    }\r\n\r\n    this.isEditorOpen = false;\r\n    this.currentContent = null;\r\n    this.originalContent = null;\r\n    this.mermaidDiagrams = [];\r\n    this.mermaidDiagramsMap = new Map();\r\n    this.currentSelectedDiagram = null;\r\n    this.currentSelectedDiagramId = null;\r\n    this.isModified = false;\r\n\r\n    // Reset zoom state\r\n    this.currentZoom = 1;\r\n    this.dragOffset = { x: 0, y: 0 };\r\n\r\n    console.log(\"✅ Editor closed\");\r\n  }\r\n\r\n  // Public method to set save callback\r\n  setSaveCallback(callback) {\r\n    this.onSave = callback;\r\n  }\r\n\r\n  // Check if editor is currently open\r\n  isOpen() {\r\n    return this.isEditorOpen;\r\n  }\r\n\r\n  // Get current content\r\n  getCurrentContent() {\r\n    if (this.textEditor) {\r\n      // Update content from editor\r\n      const editorContent = this.textEditor.getValue();\r\n      if (this.currentContent) {\r\n        this.currentContent.full_storage_format = editorContent;\r\n      }\r\n    }\r\n    return this.currentContent;\r\n  }\r\n}\r\n\r\n// Export for use in content.js\r\nexport { ConfluenceEditor };\r\n","/**\n * Mermaid Preview Handler\n * Handles rendering and updating of Mermaid diagram previews\n */\nimport { MermaidRenderer } from \"../utils/mermaidRenderer.js\";\n\nexport class MermaidPreview {\n  constructor() {\n    this.previewContainer = null;\n  }\n\n  /**\n   * Initialize preview container\n   */\n  initialize() {\n    this.previewContainer = document.getElementById(\n      \"mermaid-preview-container\"\n    );\n    if (!this.previewContainer) {\n      console.error(\"❌ Preview container not found\");\n      return false;\n    }\n    return true;\n  }\n\n  /**\n   * Update Mermaid preview from code\n   * @param {string} code - Mermaid diagram code\n   */\n  async updatePreview(code) {\n    if (!this.previewContainer) {\n      console.error(\"❌ Preview container not initialized\");\n      return;\n    }\n\n    if (!code || !code.trim()) {\n      this.showPlaceholder(\"Enter Mermaid code to preview\");\n      return;\n    }\n\n    try {\n      // Clean and validate code\n      const cleanCode = this.cleanMermaidCode(code);\n      console.log(\"🧹 Cleaned Mermaid code:\", cleanCode);\n\n      // Validate code\n      const validation = this.validateMermaidCode(cleanCode);\n      if (!validation.isValid) {\n        this.showError(`Invalid Mermaid syntax: ${validation.error}`);\n        return;\n      }\n\n      // Initialize Mermaid if needed\n      await MermaidRenderer.initializeMermaid();\n\n      // Create unique diagram ID\n      const diagramId = `mermaid-ai-chat-preview-${Date.now()}`;\n\n      // Show loading\n      this.showPlaceholder(\"Rendering diagram...\");\n\n      // Render diagram\n      await MermaidRenderer.renderDiagram(\n        diagramId,\n        cleanCode,\n        this.previewContainer\n      );\n\n      console.log(\"✅ Mermaid preview updated successfully\");\n    } catch (error) {\n      console.error(\"❌ Error updating Mermaid preview:\", error);\n      this.showError(error.message);\n    }\n  }\n\n  /**\n   * Show placeholder message\n   * @param {string} message - Placeholder message\n   */\n  showPlaceholder(message) {\n    if (\n      this.previewContainer &&\n      this.previewContainer.nodeType === Node.ELEMENT_NODE &&\n      document.contains(this.previewContainer)\n    ) {\n      this.previewContainer.innerHTML = `\n        <div class=\"mermaid-preview-placeholder\">\n          ${message}\n        </div>\n      `;\n    } else {\n      console.error(\"❌ Invalid or detached preview container for placeholder\");\n    }\n  }\n\n  /**\n   * Show error message\n   * @param {string} errorMessage - Error message to display\n   */\n  showError(errorMessage) {\n    if (\n      this.previewContainer &&\n      this.previewContainer.nodeType === Node.ELEMENT_NODE &&\n      document.contains(this.previewContainer)\n    ) {\n      this.previewContainer.innerHTML = `\n        <div class=\"mermaid-preview-placeholder\" style=\"color: #dc3545;\">\n          ❌ Error rendering diagram:<br>\n          <small>${errorMessage}</small>\n        </div>\n      `;\n    } else {\n      console.error(\n        \"❌ Invalid or detached preview container for error display\"\n      );\n      console.error(\"❌ Error message:\", errorMessage);\n    }\n  }\n\n  /**\n   * Clear preview\n   */\n  clear() {\n    this.showPlaceholder(\"Click on a Mermaid diagram to start editing\");\n  }\n\n  /**\n   * Get current preview content\n   * @returns {string} Current preview HTML content\n   */\n  getCurrentContent() {\n    return this.previewContainer ? this.previewContainer.innerHTML : \"\";\n  }\n\n  /**\n   * Clean Mermaid code - remove unwanted characters and normalize\n   * @param {string} code - Raw Mermaid code\n   * @returns {string} Cleaned code\n   */\n  cleanMermaidCode(code) {\n    if (!code) return \"\";\n\n    // Remove HTML entities\n    let cleaned = code\n      .replace(/&lt;/g, \"<\")\n      .replace(/&gt;/g, \">\")\n      .replace(/&amp;/g, \"&\")\n      .replace(/&quot;/g, '\"')\n      .replace(/&#39;/g, \"'\");\n\n    // Remove CDATA sections\n    cleaned = cleaned.replace(/<!\\[CDATA\\[(.*?)\\]\\]>/gs, \"$1\");\n\n    // Remove HTML tags\n    cleaned = cleaned.replace(/<[^>]*>/g, \"\");\n\n    // Normalize whitespace\n    cleaned = cleaned.replace(/\\r\\n/g, \"\\n\").replace(/\\r/g, \"\\n\");\n\n    // Remove excessive whitespace but preserve structure\n    cleaned = cleaned.replace(/\\n\\s*\\n\\s*\\n/g, \"\\n\\n\");\n\n    // Trim\n    cleaned = cleaned.trim();\n\n    return cleaned;\n  }\n\n  /**\n   * Validate Mermaid code syntax\n   * @param {string} code - Mermaid code to validate\n   * @returns {Object} Validation result\n   */\n  validateMermaidCode(code) {\n    if (!code || !code.trim()) {\n      return {\n        isValid: false,\n        error: \"Code is empty\",\n      };\n    }\n\n    const trimmed = code.trim();\n\n    // Check for valid Mermaid diagram types\n    const validStarters = [\n      \"graph\",\n      \"flowchart\",\n      \"sequenceDiagram\",\n      \"classDiagram\",\n      \"stateDiagram\",\n      \"erDiagram\",\n      \"journey\",\n      \"gantt\",\n      \"pie\",\n      \"gitgraph\",\n      \"mindmap\",\n      \"timeline\",\n      \"sankey\",\n      \"requirement\",\n    ];\n\n    const hasValidStarter = validStarters.some((starter) =>\n      trimmed.toLowerCase().startsWith(starter.toLowerCase())\n    );\n\n    if (!hasValidStarter) {\n      return {\n        isValid: false,\n        error: `Must start with a valid diagram type: ${validStarters.join(\n          \", \"\n        )}`,\n      };\n    }\n\n    // Check for common syntax issues\n    if (trimmed.includes(\"undefined\") || trimmed.includes(\"null\")) {\n      return {\n        isValid: false,\n        error: \"Contains undefined or null values\",\n      };\n    }\n\n    // Check for unbalanced brackets\n    const openBrackets = (trimmed.match(/\\[/g) || []).length;\n    const closeBrackets = (trimmed.match(/\\]/g) || []).length;\n    if (openBrackets !== closeBrackets) {\n      return {\n        isValid: false,\n        error: \"Unbalanced square brackets\",\n      };\n    }\n\n    return {\n      isValid: true,\n      error: null,\n    };\n  }\n}\n","/**\n * Mermaid AI Service\n * Handles AI API calls for Mermaid diagram modifications\n */\nimport { ApiClient } from \"../../shared/api.js\";\nimport { API_URLS } from \"../../shared/constants.js\";\n\nexport class MermaidAIService {\n  constructor() {\n    this.apiClient = new ApiClient();\n  }\n\n  /**\n   * Send prompt to AI for diagram modification\n   * @param {string} diagramContent - Current Mermaid diagram code\n   * @param {string} userPrompt - User's modification request\n   * @returns {Promise<Object>} AI response with modified diagram\n   */\n  async modifyDiagram(diagramContent, userPrompt) {\n    console.log(\"🤖 Sending AI request for diagram modification...\");\n\n    // Validate inputs\n    const promptValidation = this.validateUserPrompt(userPrompt);\n    if (!promptValidation.isValid) {\n      throw new Error(promptValidation.error);\n    }\n\n    const diagramValidation = this.validateDiagramContent(diagramContent);\n    if (!diagramValidation.isValid) {\n      throw new Error(diagramValidation.error);\n    }\n\n    // Prepare payload for new API\n    const payload = {\n      diagram_code: diagramContent,\n      prompt: userPrompt,\n    };\n\n    console.log(\"📤 Sending AI request:\", payload);\n\n    try {\n      // Call new AI API using constants\n      const response = await fetch(API_URLS.EDIT_MERMAID, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(payload),\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        throw new Error(\n          errorText || `HTTP ${response.status}: ${response.statusText}`\n        );\n      }\n\n      // API returns plain text mermaid code\n      const newMermaidCode = await response.text();\n\n      if (!newMermaidCode || !newMermaidCode.trim()) {\n        throw new Error(\"Empty response from AI API\");\n      }\n\n      console.log(\"✅ AI response received successfully\");\n\n      // Return in expected format for compatibility\n      return {\n        success: true,\n        edited_diagram: newMermaidCode.trim(),\n      };\n    } catch (error) {\n      console.error(\"❌ AI API error:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * Call AI API\n   * @param {Object} payload - Request payload\n   * @returns {Promise<Object>} AI response\n   */\n  async callAI(payload) {\n    try {\n      const response = await fetch(\"/api/ai/mermaid-edit\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(payload),\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(\n          errorData.error || `HTTP ${response.status}: ${response.statusText}`\n        );\n      }\n\n      const data = await response.json();\n      console.log(\"📥 AI API response:\", data);\n\n      return data;\n    } catch (error) {\n      console.error(\"❌ AI API call failed:\", error);\n\n      // Return mock response for development/testing\n      if (error.message.includes(\"fetch\")) {\n        console.log(\"🔧 Using mock AI response for development\");\n        return this.getMockResponse(payload);\n      }\n\n      throw error;\n    }\n  }\n\n  /**\n   * Get mock AI response for development\n   * @param {Object} payload - Original request payload\n   * @returns {Object} Mock response\n   */\n  getMockResponse(payload) {\n    // Simple mock: add a comment to the diagram\n    const originalDiagram = payload.diagram_content;\n    const modifiedDiagram = `%% Modified by AI: ${payload.user_prompt}\\n${originalDiagram}`;\n\n    return {\n      success: true,\n      edited_diagram: modifiedDiagram,\n      explanation: `I've added a comment to your diagram based on your request: \"${payload.user_prompt}\"`,\n    };\n  }\n\n  /**\n   * Validate user prompt\n   * @param {string} prompt - User prompt to validate\n   * @returns {Object} Validation result\n   */\n  validateUserPrompt(prompt) {\n    if (!prompt || !prompt.trim()) {\n      return {\n        isValid: false,\n        error:\n          \"Please enter a prompt describing how you want to modify the diagram\",\n      };\n    }\n\n    if (prompt.trim().length < 3) {\n      return {\n        isValid: false,\n        error: \"Prompt is too short. Please provide more details.\",\n      };\n    }\n\n    if (prompt.length > 1000) {\n      return {\n        isValid: false,\n        error: \"Prompt is too long. Please keep it under 1000 characters.\",\n      };\n    }\n\n    return {\n      isValid: true,\n      error: null,\n    };\n  }\n\n  /**\n   * Validate diagram content\n   * @param {string} content - Diagram content to validate\n   * @returns {Object} Validation result\n   */\n  validateDiagramContent(content) {\n    if (!content || !content.trim()) {\n      return {\n        isValid: false,\n        error:\n          \"No diagram content found. Please select a Mermaid diagram first.\",\n      };\n    }\n\n    // Basic Mermaid syntax validation\n    const trimmed = content.trim();\n    const validStarters = [\n      \"graph\",\n      \"flowchart\",\n      \"sequenceDiagram\",\n      \"classDiagram\",\n      \"stateDiagram\",\n      \"erDiagram\",\n      \"journey\",\n      \"gantt\",\n      \"pie\",\n    ];\n\n    const hasValidStarter = validStarters.some((starter) =>\n      trimmed.toLowerCase().startsWith(starter.toLowerCase())\n    );\n\n    if (!hasValidStarter) {\n      return {\n        isValid: false,\n        error:\n          \"Invalid Mermaid diagram format. Please ensure it starts with a valid diagram type.\",\n      };\n    }\n\n    return {\n      isValid: true,\n      error: null,\n    };\n  }\n\n  /**\n   * Get user-friendly error message\n   * @param {Error} error - Error object\n   * @returns {string} User-friendly error message\n   */\n  getErrorMessage(error) {\n    if (error.message.includes(\"fetch\")) {\n      return \"Unable to connect to AI service. Please check your internet connection.\";\n    }\n\n    if (error.message.includes(\"HTTP 429\")) {\n      return \"Too many requests. Please wait a moment and try again.\";\n    }\n\n    if (error.message.includes(\"HTTP 500\")) {\n      return \"AI service is temporarily unavailable. Please try again later.\";\n    }\n\n    return error.message || \"An unexpected error occurred. Please try again.\";\n  }\n}\n","/**\n * Mermaid API Client\n * Handles API calls to fetch Mermaid diagram code from Confluence\n */\nimport { CONFLUENCE_API_URLS } from \"../../shared/constants.js\";\nexport class MermaidApiClient {\n  /**\n   * Extract page ID from current URL\n   * @returns {string|null} Page ID or null if not found\n   */\n  static extractPageId() {\n    try {\n      console.log(\"🔍 Extracting page ID from current page...\");\n      console.log(\"🔍 Current URL:\", window.location.href);\n      console.log(\"🔍 Current pathname:\", window.location.pathname);\n      console.log(\"🔍 Current search:\", window.location.search);\n\n      // Method 1: From URL params like /pages/viewpage.action?pageId=1933328\n      const urlParams = new URLSearchParams(window.location.search);\n      const pageId = urlParams.get(\"pageId\");\n      if (pageId) {\n        console.log(\"📄 Page ID extracted from URL params:\", pageId);\n        return pageId;\n      }\n\n      // Method 2: From URL path like /pages/(\\d+) or /display/SPACE/(\\d+)\n      const pathMatches = [\n        window.location.pathname.match(/\\/pages\\/(\\d+)/),\n        window.location.pathname.match(/\\/display\\/[^\\/]+\\/(\\d+)/),\n        window.location.href.match(/pageId=(\\d+)/),\n        window.location.href.match(/\\/(\\d+)(?:[?#]|$)/),\n      ];\n\n      for (const match of pathMatches) {\n        if (match && match[1]) {\n          console.log(\"📄 Page ID extracted from path/URL:\", match[1]);\n          return match[1];\n        }\n      }\n\n      // Method 3: From meta tags\n      const metaSelectors = [\n        'meta[name=\"ajs-page-id\"]',\n        'meta[name=\"confluence-page-id\"]',\n        'meta[property=\"confluence:page-id\"]',\n      ];\n\n      for (const selector of metaSelectors) {\n        const metaTag = document.querySelector(selector);\n        if (metaTag && metaTag.content) {\n          console.log(\n            `📄 Page ID extracted from meta tag (${selector}):`,\n            metaTag.content\n          );\n          return metaTag.content;\n        }\n      }\n\n      // Method 4: From AJS context if available\n      if (window.AJS && window.AJS.params && window.AJS.params.pageId) {\n        console.log(\"📄 Page ID extracted from AJS:\", window.AJS.params.pageId);\n        return window.AJS.params.pageId;\n      }\n\n      // Method 5: From Confluence context\n      if (window.Confluence && window.Confluence.getContentId) {\n        const contentId = window.Confluence.getContentId();\n        if (contentId) {\n          console.log(\n            \"📄 Page ID extracted from Confluence context:\",\n            contentId\n          );\n          return contentId;\n        }\n      }\n\n      // Method 6: From data attributes on body or html\n      const bodyPageId =\n        document.body.getAttribute(\"data-page-id\") ||\n        document.documentElement.getAttribute(\"data-page-id\");\n      if (bodyPageId) {\n        console.log(\n          \"📄 Page ID extracted from body data attribute:\",\n          bodyPageId\n        );\n        return bodyPageId;\n      }\n\n      console.warn(\"⚠️ Could not extract page ID from current page\");\n      console.warn(\n        \"⚠️ Available methods tried: URL params, path patterns, meta tags, AJS context, Confluence context, data attributes\"\n      );\n      return null;\n    } catch (error) {\n      console.error(\"❌ Error extracting page ID:\", error);\n      return null;\n    }\n  }\n\n  /**\n   * Extract filename from image src URL\n   * @param {string} src - Image src URL\n   * @returns {string|null} Filename without extension or null if not found\n   */\n  static extractFilename(src) {\n    try {\n      if (!src) return null;\n\n      console.log(\"🔍 Extracting filename from src:\", src);\n\n      // Parse URL to get pathname\n      const url = new URL(src, window.location.origin);\n      const pathname = url.pathname;\n\n      // Extract filename from path like /download/attachments/1933328/Diagram.png\n      const pathParts = pathname.split(\"/\");\n      const filenameWithExt = pathParts[pathParts.length - 1];\n\n      if (!filenameWithExt) return null;\n\n      // Remove extension (.png, .jpg, .svg, etc.)\n      const filename = filenameWithExt.split(\".\")[0];\n\n      console.log(\"✅ Extracted filename:\", filename);\n      return filename;\n    } catch (error) {\n      console.error(\"❌ Error extracting filename:\", error);\n      return null;\n    }\n  }\n\n  /**\n   * Save filename to localStorage for later use\n   * @param {string} filename - Filename to save\n   */\n  static saveFilename(filename) {\n    try {\n      if (!filename) return;\n\n      localStorage.setItem(\"mermaid-ai-filename\", filename);\n      console.log(\"💾 Filename saved to localStorage:\", filename);\n    } catch (error) {\n      console.error(\"❌ Error saving filename to localStorage:\", error);\n    }\n  }\n\n  /**\n   * Get saved filename from localStorage\n   * @returns {string|null} Saved filename or null if not found\n   */\n  static getSavedFilename() {\n    try {\n      const filename = localStorage.getItem(\"mermaid-ai-filename\");\n      console.log(\"📂 Retrieved filename from localStorage:\", filename);\n      return filename;\n    } catch (error) {\n      console.error(\"❌ Error retrieving filename from localStorage:\", error);\n      return null;\n    }\n  }\n\n  /**\n   * Fetch Mermaid diagram code from Confluence API\n   * @param {string} pageId - Confluence page ID (ceoId)\n   * @param {string} filename - Diagram filename\n   * @returns {Promise<string>} Mermaid diagram code\n   */\n  static async fetchMermaidCode(pageId, filename) {\n    try {\n      console.log(\"🌐 Fetching Mermaid code from API...\", { pageId, filename });\n\n      const apiUrl = `${CONFLUENCE_API_URLS.MERMAID_DIAGRAM}?ceoId=${pageId}&filename=${filename}`;\n\n      console.log(\"📡 API URL:\", apiUrl);\n\n      const response = await fetch(apiUrl, {\n        method: \"GET\",\n        headers: {\n          Accept: \"*/*\",\n          \"Accept-Language\": \"en-US,en;q=0.9,vi;q=0.8\",\n          \"Cache-Control\": \"no-cache\",\n          Connection: \"keep-alive\",\n          \"Content-Type\": \"application/json; charset=utf-8\",\n          Pragma: \"no-cache\",\n          Referer: CONFLUENCE_API_URLS.MERMAID_EDIT_REFERER,\n          \"Sec-Fetch-Dest\": \"empty\",\n          \"Sec-Fetch-Mode\": \"cors\",\n          \"Sec-Fetch-Site\": \"same-origin\",\n          \"User-Agent\": navigator.userAgent,\n          \"X-Requested-With\": \"XMLHttpRequest\",\n          \"sec-ch-ua\":\n            '\"Chromium\";v=\"140\", \"Not=A?Brand\";v=\"24\", \"Google Chrome\";v=\"140\"',\n          \"sec-ch-ua-mobile\": \"?0\",\n          \"sec-ch-ua-platform\": '\"Windows\"',\n        },\n        credentials: \"include\", // Include cookies for authentication\n      });\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const data = await response.json(); // Assuming API returns plain text Mermaid code\n\n      return data;\n    } catch (error) {\n      console.error(\"❌ Error fetching Mermaid code:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * Fetch Mermaid code using saved filename and current page ID\n   * @returns {Promise<string>} Mermaid diagram code\n   */\n  static async fetchMermaidCodeFromSaved() {\n    const pageId = this.extractPageId();\n    const filename = this.getSavedFilename();\n\n    if (!pageId) {\n      throw new Error(\"Could not extract page ID from current page\");\n    }\n\n    if (!filename) {\n      throw new Error(\n        \"No filename found in localStorage. Please click on a Mermaid diagram first.\"\n      );\n    }\n\n    return await this.fetchMermaidCode(pageId, filename);\n  }\n}\n","// Mermaid AI Chat Service for K-Tool Extension\nimport { MermaidExtractor } from \"./MermaidExtractor.js\";\nimport { MermaidPreview } from \"./MermaidPreview.js\";\nimport { MermaidAIService } from \"./MermaidAIService.js\";\nimport { MermaidApiClient } from \"./MermaidApiClient.js\";\nimport { CONFLUENCE_API_URLS } from \"../../shared/constants.js\";\n\nexport class MermaidAIChat {\n  constructor($) {\n    this.$ = $ || window.jQuery || window.$; // jQuery instance từ AJS hoặc fallback\n    this.isPopupOpen = false;\n    this.currentMermaidContent = \"\";\n\n    // Initialize components\n    this.preview = new MermaidPreview();\n    this.aiService = new MermaidAIService();\n\n    // ✅ Replace MermaidDetector with internal properties\n    this.lastClickedElement = null;\n    this.lastClickPosition = { x: 0, y: 0 };\n\n    // ✅ Zoom functionality\n    this.currentZoom = 1.0; // 100%\n    this.minZoom = 0.25; // 25%\n    this.maxZoom = 3.0; // 300%\n    this.zoomStep = 0.25; // 25% per step\n    this.isZooming = false; // Flag to prevent flicker during zoom\n\n    console.log(\"🚀 Mermaid AI Chat initializing with AJS/jQuery:\", !!this.$);\n    this.init();\n  }\n\n  async init() {\n    console.log(\"🚀 AJS: Mermaid AI Chat initializing...\");\n\n    // Check if already injected\n    if (document.getElementById(\"mermaid-ai-chat-root\")) {\n      console.log(\"🔍 AJS: Mermaid AI Chat already injected, skipping...\");\n      return;\n    }\n\n    // Create popup UI first\n    this.createPopupUI();\n\n    // Initialize preview component\n    this.preview.initialize();\n\n    // ✅ Setup detection without MermaidDetector\n    this.setupMermaidDetection();\n    this.setupConfluencePageChangeDetection();\n\n    // Setup ConfluenceEditor monitoring to avoid conflicts\n    this.setupConfluenceEditorMonitoring();\n\n    console.log(\"✅ AJS: Mermaid AI Chat ready\");\n  }\n\n  /**\n   * Handle Mermaid diagram click\n   * @param {HTMLElement} element - Clicked element\n   * @param {Object} position - Click position {x, y}\n   */\n  handleMermaidClick(element, position) {\n    console.log(\"🎯 Mermaid diagram clicked:\", element, position);\n\n    // Extract content from clicked element\n    // this.currentMermaidContent = MermaidExtractor.extractFromElement(element);\n\n    // Show popup at click position\n    this.showChatPopup(position.x, position.y);\n  }\n\n  setupMermaidDetection() {\n    console.log(\"🔍 SIMPLE: Setting up iframe click detection...\");\n\n    // ✅ Sử dụng lại logic từ MermaidDetector thay vì duplicate code\n    // Chỉ setup iframe event listeners với logic đơn giản\n    this.setupIframeEventListeners();\n\n    // Setup MutationObserver để detect iframe mới (chỉ observe DOM cha)\n    this.setupMutationObserver();\n\n    console.log(\"✅ SIMPLE: Setup completed\");\n  }\n\n  setupIframeEventListeners() {\n    console.log(\"🔍 IFRAME: Setting up iframe event listeners...\");\n    this.refreshIframeListeners();\n  }\n\n  refreshIframeListeners() {\n    // Tìm tất cả iframes hiện tại\n    const iframes = document.querySelectorAll(\"iframe\");\n    console.log(\"🔍 IFRAME REFRESH: Found\", iframes.length, \"iframes\");\n\n    if (iframes.length === 0) {\n      console.log(\"⚠️ IFRAME REFRESH: No iframes found on page\");\n      console.log(\n        \"⚠️ IFRAME REFRESH: Document ready state:\",\n        document.readyState\n      );\n\n      // Try again after a delay\n      setTimeout(() => {\n        console.log(\"🔍 IFRAME REFRESH: Retrying iframe search after delay...\");\n        const retryIframes = document.querySelectorAll(\"iframe\");\n        console.log(\n          \"🔍 IFRAME REFRESH: Retry found\",\n          retryIframes.length,\n          \"iframes\"\n        );\n        if (retryIframes.length > 0) {\n          retryIframes.forEach((iframe, index) => {\n            console.log(\n              `🔍 IFRAME REFRESH RETRY ${index}: Processing iframe:`,\n              iframe.src || iframe.id || \"no-src\"\n            );\n            this.attachIframeListeners(iframe, `refresh-retry-${index}`);\n          });\n        }\n      }, 1000);\n    } else {\n      iframes.forEach((iframe, index) => {\n        console.log(\n          `🔍 IFRAME REFRESH ${index}: Processing iframe:`,\n          iframe.src || iframe.id || \"no-src\"\n        );\n        this.attachIframeListeners(iframe, `refresh-${index}`);\n      });\n    }\n  }\n\n  attachIframeListeners(iframe, index) {\n    try {\n      // Kiểm tra nếu iframe đã có listener để tránh duplicate\n      if (iframe.dataset.mermaidListenerAttached === \"true\") {\n        console.log(\n          `⚠️ IFRAME ${index}: Listener already attached, skipping...`\n        );\n        return;\n      }\n\n      // Đánh dấu iframe đã có listener\n      iframe.dataset.mermaidListenerAttached = \"true\";\n\n      // Đợi iframe load xong\n      const loadHandler = () => {\n        console.log(\n          `🔍 IFRAME ${index}: Iframe loaded, attaching listeners...`\n        );\n        try {\n          const iframeDoc =\n            iframe.contentDocument || iframe.contentWindow.document;\n\n          if (!iframeDoc) {\n            console.log(\n              `⚠️ IFRAME ${index}: Cannot access iframe document (cross-origin?)`\n            );\n            return;\n          }\n\n          console.log(\n            `✅ IFRAME ${index}: Iframe document accessible, adding click listeners...`\n          );\n\n          // Click handler: Lưu element và tọa độ nếu là ảnh\n          const clickHandler = (event) => {\n            console.log(`🖱️ IFRAME ${index} CLICK: Element clicked:`, {\n              tag: event.target.tagName,\n              classes: event.target.className,\n              id: event.target.id,\n              src: event.target.src || \"N/A\",\n              alt: event.target.alt || \"N/A\",\n              element: event.target,\n            });\n\n            console.log(\n              `🔍 IFRAME ${index} CLICK: Checking if Mermaid element...`\n            );\n            console.log(\n              `🔍 IFRAME ${index} CLICK: isMermaidElement result:`,\n              this.isMermaidElement(event.target)\n            );\n\n            // ✅ Handle click directly without MermaidDetector\n            if (this.isMermaidElement(event.target)) {\n              console.log(\"🎯 Mermaid element clicked:\", event.target);\n\n              // Extract and save comprehensive diagram info\n              if (event.target.src) {\n                const filename = MermaidApiClient.extractFilename(\n                  event.target.src\n                );\n\n                // Extract macro parameters from data attribute\n                const macroParams = event.target.getAttribute(\n                  \"data-macro-parameters\"\n                );\n\n                // Save comprehensive diagram info\n                const diagramInfo = {\n                  filename: filename,\n                  src: event.target.src,\n                  macroParameters: macroParams,\n                  element: {\n                    tagName: event.target.tagName,\n                    className: event.target.className,\n                    id: event.target.id,\n                  },\n                };\n\n                // Parse macro parameters if available\n                if (macroParams) {\n                  try {\n                    const params = this.parseMacroParameters(macroParams);\n                    diagramInfo.parsedParams = params;\n                    console.log(`📋 Parsed macro parameters:`, params);\n                  } catch (error) {\n                    console.warn(\n                      \"⚠️ Could not parse macro parameters:\",\n                      macroParams\n                    );\n                  }\n                }\n\n                if (filename) {\n                  MermaidApiClient.saveFilename(filename);\n                  // Save full diagram info\n                  localStorage.setItem(\n                    \"mermaid_diagram_info\",\n                    JSON.stringify(diagramInfo)\n                  );\n                  console.log(`💾 Diagram info saved:`, diagramInfo);\n                } else {\n                  console.warn(\n                    \"⚠️ Could not extract filename from src:\",\n                    event.target.src\n                  );\n                }\n              }\n\n              // Save click info\n              this.lastClickedElement = event.target;\n              this.lastClickPosition = {\n                x: event.clientX + iframe.offsetLeft,\n                y: event.clientY + iframe.offsetTop,\n              };\n\n              // Trigger callback\n              this.handleMermaidClick(event.target, this.lastClickPosition);\n            }\n          };\n\n          // Remove existing listener nếu có\n          if (iframeDoc.mermaidClickHandler) {\n            iframeDoc.removeEventListener(\n              \"click\",\n              iframeDoc.mermaidClickHandler,\n              true\n            );\n          }\n\n          // Add new listener\n          const boundClickHandler = clickHandler.bind(this);\n          iframeDoc.addEventListener(\"click\", boundClickHandler, true);\n\n          // Store reference để có thể remove sau này\n          iframeDoc.mermaidClickHandler = boundClickHandler;\n        } catch (e) {\n          console.log(\n            `❌ IFRAME ${index}: Error accessing iframe content:`,\n            e.message\n          );\n        }\n      };\n\n      // Remove existing load listener nếu có\n      if (iframe.mermaidLoadHandler) {\n        iframe.removeEventListener(\"load\", iframe.mermaidLoadHandler);\n      }\n\n      // Add load listener\n      iframe.addEventListener(\"load\", loadHandler);\n      iframe.mermaidLoadHandler = loadHandler;\n\n      // Nếu iframe đã load rồi thì gọi handler ngay\n      if (\n        iframe.contentDocument &&\n        iframe.contentDocument.readyState === \"complete\"\n      ) {\n        loadHandler();\n      }\n    } catch (e) {\n      console.log(\n        `❌ IFRAME ${index}: Error setting up iframe listener:`,\n        e.message\n      );\n    }\n  }\n\n  setupMutationObserver() {\n    console.log(\n      \"🔍 MUTATION: Setting up observer to track ALL DOM changes in parent...\"\n    );\n\n    const observer = new MutationObserver((mutations) => {\n      mutations.forEach((mutation, mutationIndex) => {\n        console.log(`🔍 MUTATION ${mutationIndex}: Type: ${mutation.type}`);\n        if (mutation.type === \"childList\") {\n          // Log ADDED nodes\n          if (mutation.addedNodes.length > 0) {\n            console.log(\n              `➕ MUTATION ${mutationIndex}: ${mutation.addedNodes.length} nodes ADDED:`\n            );\n            mutation.addedNodes.forEach((node, nodeIndex) => {\n              if (node.nodeType === Node.ELEMENT_NODE) {\n                console.log(`➕ Added ${nodeIndex}: ${node.tagName}`, {\n                  tag: node.tagName,\n                  classes: node.className || \"N/A\",\n                  id: node.id || \"N/A\",\n                  textContent: node.textContent?.substring(0, 50) || \"N/A\",\n                  element: node,\n                });\n\n                // Nếu là iframe thì attach listeners\n                if (node.tagName === \"IFRAME\") {\n                  console.log(\n                    \"🎯 MUTATION: IFRAME detected, attaching listeners...\"\n                  );\n                  this.attachIframeListeners(node, \"new\");\n                }\n\n                this.injectAIButton();\n              } else if (node.nodeType === Node.TEXT_NODE) {\n                console.log(`➕ Added ${nodeIndex}: TEXT_NODE`, {\n                  content: node.textContent?.substring(0, 50) || \"N/A\",\n                });\n              }\n            });\n          }\n        }\n      });\n    });\n\n    // Observe DOM cha với tất cả types\n    observer.observe(document.body, {\n      childList: true,\n      subtree: false,\n    });\n  }\n\n  setupConfluencePageChangeDetection() {\n    console.log(\n      \"🔍 PAGE CHANGE: Setting up Confluence page change detection...\"\n    );\n\n    // Method 1: Listen for Confluence-specific events\n    if (window.AJS && AJS.bind) {\n      // Editor events\n      AJS.bind(\"init.rte\", () => {\n        console.log(\n          \"🔄 PAGE CHANGE: Confluence RTE initialized - re-setting up iframe listeners\"\n        );\n        setTimeout(() => this.setupIframeEventListeners(), 1000);\n      });\n\n      AJS.bind(\"rte-ready\", () => {\n        console.log(\n          \"🔄 PAGE CHANGE: Confluence RTE ready - re-setting up iframe listeners\"\n        );\n        setTimeout(() => this.setupIframeEventListeners(), 1000);\n      });\n\n      // Page events\n      AJS.bind(\"page.edit.ready\", () => {\n        console.log(\n          \"🔄 PAGE CHANGE: Page edit ready - re-setting up iframe listeners\"\n        );\n        setTimeout(() => this.setupIframeEventListeners(), 1500);\n      });\n\n      AJS.bind(\"page.view.ready\", () => {\n        console.log(\n          \"🔄 PAGE CHANGE: Page view ready - re-setting up iframe listeners\"\n        );\n        setTimeout(() => this.setupIframeEventListeners(), 1000);\n      });\n    }\n\n    // Method 2: Watch for URL changes (SPA navigation)\n    let currentUrl = window.location.href;\n    const checkUrlChange = () => {\n      if (window.location.href !== currentUrl) {\n        console.log(\n          \"🔄 PAGE CHANGE: URL changed from\",\n          currentUrl,\n          \"to\",\n          window.location.href\n        );\n        currentUrl = window.location.href;\n\n        // Re-setup after URL change\n        setTimeout(() => {\n          console.log(\n            \"🔄 PAGE CHANGE: Re-setting up iframe listeners after URL change\"\n          );\n          this.setupIframeEventListeners();\n        }, 2000);\n      }\n    };\n\n    setInterval(checkUrlChange, 1000);\n\n    console.log(\n      \"✅ PAGE CHANGE: Confluence page change detection setup completed\"\n    );\n  }\n\n  injectAIButton() {\n    // ✅ Skip if ConfluenceEditor popup is open to avoid conflict\n    if (document.querySelector(\".confluence-editor-overlay\")) {\n      console.log(\n        \"🚫 ConfluenceEditor popup is open, skipping AI button injection\"\n      );\n      return;\n    }\n\n    var panel = document.getElementById(\"property-panel\");\n    if (!panel) return;\n\n    var buttonContainer = panel.querySelector(\".panel-buttons\");\n    if (!buttonContainer) return;\n\n    // Kiểm tra nếu nút AI đã có\n    if (\n      buttonContainer.querySelector(\n        \".macro-placeholder-property-panel-ai-button\"\n      )\n    )\n      return;\n\n    console.log(\"✨ Thêm nút AI vào property panel...\");\n\n    // Tạo thẻ <a> mới\n    var aiButton = document.createElement(\"a\");\n    aiButton.href = \"#\";\n    aiButton.className =\n      \"aui-button macro-placeholder-property-panel-ai-button\";\n    aiButton.setAttribute(\"tabindex\", \"0\");\n    aiButton.setAttribute(\"role\", \"button\");\n    aiButton.setAttribute(\"aria-label\", \"AI\");\n    aiButton.style.marginRight = \"4px\";\n\n    // Icon + Text\n    aiButton.innerHTML = `<span class=\"icon\"></span><span class=\"panel-button-text\">AI</span>`;\n\n    // Thêm sự kiện click\n    aiButton.addEventListener(\"click\", async (e) => {\n      e.preventDefault();\n\n      // ✅ Skip if ConfluenceEditor popup is open to avoid conflict\n      if (document.querySelector(\".confluence-editor-overlay\")) {\n        console.log(\n          \"🚫 ConfluenceEditor popup is open, ignoring AI button click\"\n        );\n        return;\n      }\n\n      console.log(\"🤖 AI Button clicked - fetching Mermaid code...\");\n\n      // Get last clicked element and position\n      const lastClickedElement = this.lastClickedElement;\n      const lastClickPosition = this.lastClickPosition;\n\n      console.log(\n        \"🔍 DEBUG AI BUTTON: this.lastClickedElement:\",\n        this.lastClickedElement\n      );\n      console.log(\n        \"🔍 DEBUG AI BUTTON: this.lastClickPosition:\",\n        this.lastClickPosition\n      );\n      console.log(\n        \"🔍 DEBUG AI BUTTON: lastClickedElement:\",\n        lastClickedElement\n      );\n      console.log(\"🔍 DEBUG AI BUTTON: lastClickPosition:\", lastClickPosition);\n      console.log(\n        \"🔍 DEBUG AI BUTTON: Position check:\",\n        lastClickPosition &&\n          (lastClickPosition.x !== 0 || lastClickPosition.y !== 0)\n      );\n\n      if (\n        lastClickedElement &&\n        lastClickPosition &&\n        (lastClickPosition.x !== 0 || lastClickPosition.y !== 0)\n      ) {\n        console.log(\n          \"🤖 Found saved element - fetching Mermaid code from API...\"\n        );\n\n        try {\n          // Show loading state\n          const loadingMessage = \"🔄 Fetching Mermaid diagram code...\";\n          console.log(loadingMessage);\n\n          // Fetch Mermaid code from API using saved filename and page ID\n          const mermaidCodeResponse =\n            await MermaidApiClient.fetchMermaidCodeFromSaved();\n          const mermaidCode = mermaidCodeResponse.data;\n          console.log(\"✅ Mermaid code fetched successfully:\", mermaidCode);\n\n          // Update current content with fetched code\n          this.currentMermaidContent = mermaidCode;\n\n          // Show chat popup with fetched content\n          this.showChatPopup(lastClickPosition.x, lastClickPosition.y);\n        } catch (error) {\n          console.error(\"❌ Error fetching Mermaid code:\", error);\n          alert(`❌ Error fetching Mermaid code: ${error.message}`);\n        }\n      } else {\n        console.log(\n          \"⚠️ No saved element found - please click on an image first\"\n        );\n        alert(\"⚠️ Vui lòng click vào một hình ảnh trước khi sử dụng AI Chat!\");\n      }\n    });\n\n    // Chèn vào trước nút Remove\n    var removeButton = buttonContainer.querySelector(\n      \".macro-placeholder-property-panel-remove-button\"\n    );\n    if (removeButton) {\n      buttonContainer.insertBefore(aiButton, removeButton);\n    } else {\n      buttonContainer.appendChild(aiButton);\n    }\n\n    console.log(\"✅ Đã chèn nút AI thành công.\");\n  }\n\n  /**\n   * Remove AI button when ConfluenceEditor is open\n   */\n  removeAIButton() {\n    const aiButton = document.querySelector(\n      \".macro-placeholder-property-panel-ai-button\"\n    );\n    if (aiButton) {\n      aiButton.remove();\n      console.log(\"🗑️ AI button removed due to ConfluenceEditor popup\");\n    }\n  }\n\n  /**\n   * Monitor ConfluenceEditor popup state and manage AI button accordingly\n   */\n  setupConfluenceEditorMonitoring() {\n    // Monitor for ConfluenceEditor popup open/close\n    const observer = new MutationObserver((mutations) => {\n      mutations.forEach((mutation) => {\n        if (mutation.type === \"childList\") {\n          mutation.addedNodes.forEach((node) => {\n            if (\n              node.nodeType === Node.ELEMENT_NODE &&\n              node.classList &&\n              node.classList.contains(\"confluence-editor-overlay\")\n            ) {\n              console.log(\n                \"🔍 ConfluenceEditor popup opened, removing AI button\"\n              );\n              this.removeAIButton();\n            }\n          });\n\n          mutation.removedNodes.forEach((node) => {\n            if (\n              node.nodeType === Node.ELEMENT_NODE &&\n              node.classList &&\n              node.classList.contains(\"confluence-editor-overlay\")\n            ) {\n              console.log(\n                \"🔍 ConfluenceEditor popup closed, re-injecting AI button\"\n              );\n              // Delay to ensure DOM is ready\n              setTimeout(() => {\n                this.injectAIButton();\n              }, 100);\n            }\n          });\n        }\n      });\n    });\n\n    observer.observe(document.body, {\n      childList: true,\n      subtree: false, // Only observe direct children of body\n    });\n\n    console.log(\"✅ ConfluenceEditor monitoring setup completed\");\n  }\n\n  /**\n   * Parse macro parameters string\n   * @param {string} macroParams - Macro parameters string like \"filename=e3e32|format=svg|revision=5\"\n   * @returns {Object} Parsed parameters object\n   */\n  parseMacroParameters(macroParams) {\n    const params = {};\n    if (!macroParams) return params;\n\n    const pairs = macroParams.split(\"|\");\n    pairs.forEach((pair) => {\n      const [key, value] = pair.split(\"=\");\n      if (key && value) {\n        params[key.trim()] = value.trim();\n      }\n    });\n\n    return params;\n  }\n\n  /**\n   * Check if element is a Mermaid diagram\n   * @param {HTMLElement} element - Element to check\n   * @returns {boolean} True if element is Mermaid-related\n   */\n  isMermaidElement(element) {\n    if (\n      !element ||\n      !element.nodeType ||\n      element.nodeType !== Node.ELEMENT_NODE\n    ) {\n      return false;\n    }\n\n    console.log(\"🔍 isMermaidElement: Checking element:\", {\n      tag: element.tagName,\n      src: element.src || \"N/A\",\n      className: element.className || \"N/A\",\n      id: element.id || \"N/A\",\n    });\n\n    // Check for various Mermaid indicators\n    const checks = [\n      // Image with mermaid in src\n      element.tagName === \"IMG\" &&\n        element.src &&\n        element.src.includes(\"mermaid\"),\n      // SVG with mermaid in id\n      element.tagName === \"SVG\" && element.id && element.id.includes(\"mermaid\"),\n      // Element with mermaid class\n      element.classList && element.classList.contains(\"mermaid\"),\n      // Element with mermaid data attribute\n      element.getAttribute &&\n        element.getAttribute(\"data-macro-name\") === \"mermaid\",\n      // Confluence structured macro\n      element.tagName === \"AC:STRUCTURED-MACRO\" &&\n        element.getAttribute(\"ac:name\") === \"mermaid\",\n      // Any image (for broader detection)\n      element.tagName === \"IMG\" && element.src,\n      // Any SVG\n      element.tagName === \"SVG\",\n    ];\n\n    const result = checks.some((check) => check);\n    console.log(\"🔍 isMermaidElement: Result:\", result);\n\n    return result;\n  }\n\n  /**\n   * Bind zoom control events\n   */\n  bindZoomControls() {\n    const zoomInBtn = document.getElementById(\"zoom-in-btn\");\n    const zoomOutBtn = document.getElementById(\"zoom-out-btn\");\n    const zoomResetBtn = document.getElementById(\"zoom-reset-btn\");\n    const previewContainer = document.getElementById(\n      \"mermaid-preview-container\"\n    );\n\n    if (!zoomInBtn || !zoomOutBtn || !zoomResetBtn || !previewContainer) {\n      console.warn(\"⚠️ Zoom controls not found\");\n      return;\n    }\n\n    // Zoom In\n    zoomInBtn.addEventListener(\"click\", () => {\n      this.zoomIn();\n    });\n\n    // Zoom Out\n    zoomOutBtn.addEventListener(\"click\", () => {\n      this.zoomOut();\n    });\n\n    // Reset Zoom\n    zoomResetBtn.addEventListener(\"click\", () => {\n      this.resetZoom();\n    });\n\n    // Keyboard shortcuts\n    document.addEventListener(\"keydown\", (e) => {\n      // Only work when popup is open and not typing in input fields\n      if (\n        !this.isPopupOpen ||\n        e.target.tagName === \"INPUT\" ||\n        e.target.tagName === \"TEXTAREA\"\n      ) {\n        return;\n      }\n\n      if (e.key === \"+\" || e.key === \"=\") {\n        e.preventDefault();\n        this.zoomIn();\n      } else if (e.key === \"-\") {\n        e.preventDefault();\n        this.zoomOut();\n      } else if (e.key === \"0\") {\n        e.preventDefault();\n        this.resetZoom();\n      }\n    });\n\n    // Mouse wheel zoom (Ctrl + wheel)\n    previewContainer.addEventListener(\"wheel\", (e) => {\n      if (e.ctrlKey) {\n        e.preventDefault();\n        if (e.deltaY < 0) {\n          this.zoomIn();\n        } else {\n          this.zoomOut();\n        }\n      }\n    });\n\n    console.log(\"✅ Zoom controls bound successfully\");\n  }\n\n  /**\n   * Zoom in\n   */\n  zoomIn() {\n    if (this.currentZoom < this.maxZoom) {\n      this.currentZoom = Math.min(\n        this.currentZoom + this.zoomStep,\n        this.maxZoom\n      );\n      this.applyZoom();\n    }\n  }\n\n  /**\n   * Zoom out\n   */\n  zoomOut() {\n    if (this.currentZoom > this.minZoom) {\n      this.currentZoom = Math.max(\n        this.currentZoom - this.zoomStep,\n        this.minZoom\n      );\n      this.applyZoom();\n    }\n  }\n\n  /**\n   * Reset zoom to 100%\n   */\n  resetZoom() {\n    this.currentZoom = 1.0;\n    this.applyZoom();\n  }\n\n  /**\n   * Apply zoom to preview container\n   */\n  applyZoom() {\n    const previewContainer = document.getElementById(\n      \"mermaid-preview-container\"\n    );\n    const zoomDisplay = document.getElementById(\"zoom-level-display\");\n\n    if (!previewContainer) return;\n\n    // Set zoom flag to prevent flicker\n    this.isZooming = true;\n\n    // Apply transform\n    previewContainer.style.transform = `scale(${this.currentZoom})`;\n    previewContainer.style.transformOrigin = \"center center\";\n\n    // Update zoom display\n    if (zoomDisplay) {\n      zoomDisplay.textContent = `${Math.round(this.currentZoom * 100)}%`;\n    }\n\n    // Update button states\n    this.updateZoomButtonStates();\n\n    console.log(`🔍 Zoom applied: ${Math.round(this.currentZoom * 100)}%`);\n\n    // Reset zoom flag after a short delay\n    setTimeout(() => {\n      this.isZooming = false;\n    }, 100);\n  }\n\n  /**\n   * Update zoom button states (enable/disable)\n   */\n  updateZoomButtonStates() {\n    const zoomInBtn = document.getElementById(\"zoom-in-btn\");\n    const zoomOutBtn = document.getElementById(\"zoom-out-btn\");\n\n    if (zoomInBtn) {\n      zoomInBtn.disabled = this.currentZoom >= this.maxZoom;\n      zoomInBtn.style.opacity = this.currentZoom >= this.maxZoom ? \"0.5\" : \"1\";\n    }\n\n    if (zoomOutBtn) {\n      zoomOutBtn.disabled = this.currentZoom <= this.minZoom;\n      zoomOutBtn.style.opacity = this.currentZoom <= this.minZoom ? \"0.5\" : \"1\";\n    }\n  }\n\n  createPopupUI() {\n    const root = document.createElement(\"div\");\n    root.id = \"mermaid-ai-chat-root\";\n    root.innerHTML = `\n      <style>\n        .mermaid-preview-header {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          padding: 8px 12px;\n          background: #f5f5f5;\n          border-bottom: 1px solid #ddd;\n          font-weight: bold;\n        }\n\n        .zoom-controls {\n          display: flex;\n          align-items: center;\n          gap: 8px;\n        }\n\n        .zoom-btn {\n          background: #fff;\n          border: 1px solid #ccc;\n          border-radius: 4px;\n          padding: 4px 8px;\n          cursor: pointer;\n          font-size: 12px;\n          transition: all 0.2s;\n        }\n\n        .zoom-btn:hover:not(:disabled) {\n          background: #e6f3ff;\n          border-color: #0066cc;\n        }\n\n        .zoom-btn:disabled {\n          cursor: not-allowed;\n          opacity: 0.5;\n        }\n\n        .zoom-level {\n          font-size: 12px;\n          font-weight: bold;\n          color: #666;\n          min-width: 40px;\n          text-align: center;\n        }\n\n        .zoom-icon {\n          font-size: 10px;\n        }\n\n        #mermaid-preview-container {\n          transition: transform 0.2s ease;\n          overflow: auto;\n        }\n\n        .mermaid-chat-buttons {\n          display: flex;\n          gap: 8px;\n          align-items: center;\n        }\n\n        .mermaid-chat-save {\n          background: #28a745;\n          color: white;\n          border: none;\n          border-radius: 4px;\n          padding: 8px 16px;\n          cursor: pointer;\n          font-size: 14px;\n          transition: background-color 0.2s;\n        }\n\n        .mermaid-chat-save:hover:not(:disabled) {\n          background: #218838;\n        }\n\n        .mermaid-chat-save:disabled {\n          background: #6c757d;\n          cursor: not-allowed;\n        }\n      </style>\n      <div id=\"mermaid-ai-chat-popup\" class=\"mermaid-ai-chat-popup\" style=\"display: none;\">\n        <div class=\"mermaid-ai-chat-header\">\n          <h3>🤖 Mermaid AI Chat Editor</h3>\n          <button class=\"mermaid-ai-chat-close\">&times;</button>\n        </div>\n        <div class=\"mermaid-ai-chat-body\">\n          <!-- Left Pane: Code Editor + Chat Input -->\n          <div class=\"mermaid-ai-chat-left-pane\">\n            <!-- Code Editor Section -->\n            <div class=\"mermaid-code-section\">\n              <div class=\"mermaid-code-header\">\n                📝 Mermaid Code\n              </div>\n              <textarea\n                id=\"mermaid-code-editor\"\n                class=\"mermaid-code-editor\"\n                placeholder=\"Mermaid diagram code will appear here...\"\n              ></textarea>\n            </div>\n\n            <!-- Chat Input Section -->\n            <div class=\"mermaid-chat-section\">\n              <div class=\"mermaid-chat-input-area\">\n                <textarea\n                  id=\"mermaid-ai-chat-input\"\n                  class=\"mermaid-chat-input\"\n                  placeholder=\"💬 Describe how you want to modify the diagram...\"\n                  rows=\"2\"\n                ></textarea>\n                <div class=\"mermaid-chat-buttons\">\n                  <button id=\"mermaid-ai-chat-save\" class=\"mermaid-chat-save\">\n                    💾 Save\n                  </button>\n                  <button id=\"mermaid-ai-chat-send\" class=\"mermaid-chat-send\">\n                    Send\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <!-- Right Pane: Mermaid Preview -->\n          <div class=\"mermaid-ai-chat-right-pane\">\n            <div class=\"mermaid-preview-section\">\n              <div class=\"mermaid-preview-header\">\n                <span class=\"preview-title\">📊 Diagram Preview</span>\n                <div class=\"zoom-controls\">\n                  <button id=\"zoom-out-btn\" class=\"zoom-btn\" title=\"Zoom Out (-)\">\n                    <span class=\"zoom-icon\">➖</span>\n                  </button>\n                  <span id=\"zoom-level-display\" class=\"zoom-level\">100%</span>\n                  <button id=\"zoom-in-btn\" class=\"zoom-btn\" title=\"Zoom In (+)\">\n                    <span class=\"zoom-icon\">➕</span>\n                  </button>\n                  <button id=\"zoom-reset-btn\" class=\"zoom-btn\" title=\"Reset Zoom (0)\">\n                    <span class=\"zoom-icon\">🔄</span>\n                  </button>\n                </div>\n              </div>\n              <div class=\"mermaid-preview-body\">\n                <div id=\"mermaid-preview-container\" class=\"mermaid-preview-container\">\n                  <div class=\"mermaid-preview-placeholder\">\n                    Click on a Mermaid diagram to start editing\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n\n    document.body.appendChild(root);\n    this.bindPopupEvents();\n  }\n\n  bindPopupEvents() {\n    const popup = document.getElementById(\"mermaid-ai-chat-popup\");\n    const header = popup.querySelector(\".mermaid-ai-chat-header\");\n    const closeBtn = popup.querySelector(\".mermaid-ai-chat-close\");\n    const sendBtn = document.getElementById(\"mermaid-ai-chat-send\");\n    const saveBtn = document.getElementById(\"mermaid-ai-chat-save\");\n    const input = document.getElementById(\"mermaid-ai-chat-input\");\n    const codeEditor = document.getElementById(\"mermaid-code-editor\");\n\n    // Make popup draggable\n    this.makeDraggable(popup, header);\n\n    // Close popup\n    closeBtn.addEventListener(\"click\", () => {\n      this.hideChatPopup();\n    });\n\n    // Send message\n    sendBtn.addEventListener(\"click\", () => {\n      this.sendMessage();\n    });\n\n    // Save diagram\n    saveBtn.addEventListener(\"click\", () => {\n      this.saveDiagram();\n    });\n\n    // Send on Enter (Ctrl+Enter for new line)\n    input.addEventListener(\"keydown\", (e) => {\n      if (e.key === \"Enter\" && !e.ctrlKey && !e.shiftKey) {\n        e.preventDefault();\n        this.sendMessage();\n      }\n    });\n\n    // Code editor change event - update preview\n    codeEditor.addEventListener(\"input\", () => {\n      this.updateMermaidPreview();\n    });\n\n    // ✅ Zoom controls\n    this.bindZoomControls();\n\n    // Click outside to close - with proper event handling\n    setTimeout(() => {\n      const handleClickOutside = (e) => {\n        // Skip if popup is not open\n        if (!this.isPopupOpen) return;\n\n        // Skip if clicking on AI button (to prevent immediate close)\n        if (e.target.closest(\".macro-placeholder-property-panel-ai-button\")) {\n          return;\n        }\n\n        // ✅ Skip if clicking on AI button in ConfluenceEditor popup\n        if (\n          e.target.closest(\"#ai-send-btn\") &&\n          document.querySelector(\".confluence-editor-overlay\")\n        ) {\n          return;\n        }\n\n        // Skip if clicking inside popup\n        if (popup.contains(e.target)) {\n          return;\n        }\n\n        console.log(\"🖱️ Click outside popup detected, closing...\");\n        this.hideChatPopup();\n      };\n\n      document.addEventListener(\"click\", handleClickOutside, true);\n    }, 300); // Delay to prevent immediate close after opening\n  }\n\n  makeDraggable(popup, dragHandle) {\n    let isDragging = false;\n    let dragStartX = 0;\n    let dragStartY = 0;\n    let popupStartX = 0;\n    let popupStartY = 0;\n\n    console.log(\"🎯 DRAG: Setting up draggable popup...\");\n\n    // Style the drag handle\n    dragHandle.style.cursor = \"move\";\n    dragHandle.style.userSelect = \"none\";\n\n    const startDrag = (e) => {\n      // Don't drag if clicking on close button\n      if (e.target.classList.contains(\"mermaid-ai-chat-close\")) {\n        return;\n      }\n\n      e.preventDefault();\n      e.stopPropagation(); // Prevent event bubbling\n\n      isDragging = true;\n\n      // Get mouse position\n      dragStartX = e.clientX;\n      dragStartY = e.clientY;\n\n      // Get popup current position (from style, not getBoundingClientRect)\n      popupStartX = parseInt(popup.style.left) || 0;\n      popupStartY = parseInt(popup.style.top) || 0;\n\n      console.log(\"🎯 DRAG: Started\", {\n        mouseX: dragStartX,\n        mouseY: dragStartY,\n        popupX: popupStartX,\n        popupY: popupStartY,\n      });\n\n      // Add global event listeners\n      document.addEventListener(\"mousemove\", onDrag, true);\n      document.addEventListener(\"mouseup\", stopDrag, true);\n\n      // Prevent text selection during drag\n      document.body.style.userSelect = \"none\";\n    };\n\n    const onDrag = (e) => {\n      if (!isDragging) return;\n\n      e.preventDefault();\n      e.stopPropagation();\n\n      // Calculate mouse movement\n      const deltaX = e.clientX - dragStartX;\n      const deltaY = e.clientY - dragStartY;\n\n      // Calculate new popup position\n      let newX = popupStartX + deltaX;\n      let newY = popupStartY + deltaY;\n\n      // Constrain to viewport (with some padding)\n      const padding = 10;\n      const maxX = window.innerWidth - 400 - padding; // 400 is popup width\n      const maxY = window.innerHeight - 300 - padding; // estimated popup height\n\n      newX = Math.max(padding, Math.min(newX, maxX));\n      newY = Math.max(padding, Math.min(newY, maxY));\n\n      // Apply position\n      popup.style.left = newX + \"px\";\n      popup.style.top = newY + \"px\";\n    };\n\n    const stopDrag = (e) => {\n      if (!isDragging) return;\n\n      console.log(\"🎯 DRAG: Stopped\");\n      isDragging = false;\n\n      // Remove global event listeners\n      document.removeEventListener(\"mousemove\", onDrag, true);\n      document.removeEventListener(\"mouseup\", stopDrag, true);\n\n      // Restore text selection\n      document.body.style.userSelect = \"\";\n\n      e.stopPropagation(); // Prevent click outside from firing\n    };\n\n    // Attach drag to header\n    dragHandle.addEventListener(\"mousedown\", startDrag);\n\n    console.log(\"✅ DRAG: Setup completed\");\n  }\n\n  showChatPopup(x, y) {\n    console.log(\"🎉 STEP 8: showChatPopup called with coordinates:\", { x, y });\n    const popup = document.getElementById(\"mermaid-ai-chat-popup\");\n    console.log(\"🎉 STEP 8.1: Found popup element:\", popup);\n\n    if (!popup) {\n      console.error(\"❌ STEP 8.1: Popup element not found!\");\n      return;\n    }\n\n    // Populate code editor with current content\n    const codeEditor = document.getElementById(\"mermaid-code-editor\");\n    if (codeEditor && this.currentMermaidContent) {\n      codeEditor.value = this.currentMermaidContent;\n      // Trigger preview update\n      this.updateMermaidPreview();\n    }\n\n    const leftPos = Math.min(x, window.innerWidth - 400);\n    const topPos = Math.min(y, window.innerHeight - 300);\n\n    console.log(\"🎉 STEP 8.2: Setting popup position:\", { leftPos, topPos });\n    console.log(\"🎉 STEP 8.2: Window dimensions:\", {\n      width: window.innerWidth,\n      height: window.innerHeight,\n    });\n\n    popup.style.display = \"block\";\n    popup.style.left = leftPos + \"px\";\n    popup.style.top = topPos + \"px\";\n\n    console.log(\"🎉 STEP 8.3: Popup styles applied:\", {\n      display: popup.style.display,\n      left: popup.style.left,\n      top: popup.style.top,\n    });\n\n    this.isPopupOpen = true;\n    console.log(\"🎉 STEP 8.4: isPopupOpen set to:\", this.isPopupOpen);\n\n    // Focus input\n    setTimeout(() => {\n      const input = document.getElementById(\"mermaid-ai-chat-input\");\n      console.log(\"🎉 STEP 8.5: Focusing input element:\", input);\n      if (input) {\n        input.focus();\n        console.log(\"✅ STEP 8.5: Input focused successfully\");\n      } else {\n        console.error(\"❌ STEP 8.5: Input element not found!\");\n      }\n    }, 100);\n\n    console.log(\"✅ STEP 8: showChatPopup completed\");\n  }\n\n  /**\n   * Update Mermaid preview from code editor\n   */\n  async updateMermaidPreview() {\n    const codeEditor = document.getElementById(\"mermaid-code-editor\");\n    if (!codeEditor) return;\n\n    // ✅ Skip update if currently zooming to prevent flicker\n    if (this.isZooming) {\n      console.log(\"🔍 Skipping preview update during zoom to prevent flicker\");\n      return;\n    }\n\n    const code = codeEditor.value.trim();\n\n    // Update current content\n    this.currentMermaidContent = code;\n\n    // Store current zoom level\n    const currentZoom = this.currentZoom;\n\n    // Use preview component to update\n    await this.preview.updatePreview(code);\n\n    // ✅ Reapply zoom after preview update to maintain zoom level\n    if (currentZoom !== 1.0) {\n      setTimeout(() => {\n        this.currentZoom = currentZoom;\n        this.applyZoom();\n      }, 50); // Small delay to ensure DOM is updated\n    }\n  }\n\n  hideChatPopup() {\n    const popup = document.getElementById(\"mermaid-ai-chat-popup\");\n    const messagesContainer = document.getElementById(\n      \"mermaid-ai-chat-messages\"\n    );\n    const input = document.getElementById(\"mermaid-ai-chat-input\");\n\n    // 🧱 Kiểm tra popup tồn tại trước khi ẩn\n    if (popup) {\n      popup.style.display = \"none\";\n      this.isPopupOpen = false;\n    } else {\n      console.warn(\"⚠️ Không tìm thấy phần tử popup (mermaid-ai-chat-popup)\");\n    }\n\n    // 🧹 Xóa tin nhắn, giữ lại system message\n    if (messagesContainer) {\n      const systemMessage = messagesContainer.querySelector(\".system\");\n\n      // Chỉ reset khi container tồn tại\n      messagesContainer.innerHTML = \"\";\n      if (systemMessage) {\n        messagesContainer.appendChild(systemMessage);\n      } else {\n        console.warn(\"⚠️ Không tìm thấy system message trong chat container\");\n      }\n    } else {\n      console.warn(\n        \"⚠️ Không tìm thấy phần tử messages container (mermaid-ai-chat-messages)\"\n      );\n    }\n\n    // 🧽 Xóa input nếu có\n    if (input) {\n      input.value = \"\";\n    } else {\n      console.warn(\"⚠️ Không tìm thấy input (mermaid-ai-chat-input)\");\n    }\n\n    console.log(\"✅ Chat popup closed (đã kiểm tra đầy đủ phần tử)\");\n  }\n\n  async sendMessage() {\n    const input = document.getElementById(\"mermaid-ai-chat-input\");\n    const codeEditor = document.getElementById(\"mermaid-code-editor\");\n    const sendBtn = document.getElementById(\"mermaid-ai-chat-send\");\n    const message = input.value.trim();\n\n    if (!message) return;\n\n    // Get current code from editor\n    const currentCode = codeEditor.value.trim();\n    if (!currentCode) {\n      alert(\"⚠️ Please enter some Mermaid code first\");\n      return;\n    }\n\n    // Update current content\n    this.currentMermaidContent = currentCode;\n\n    // Disable send button and show loading\n    sendBtn.disabled = true;\n    sendBtn.textContent = \"🤔 Thinking...\";\n    input.disabled = true;\n\n    try {\n      // Call AI service\n      const response = await this.aiService.modifyDiagram(\n        this.currentMermaidContent,\n        message\n      );\n\n      // Update code editor with new diagram\n      codeEditor.value = response.edited_diagram;\n      this.currentMermaidContent = response.edited_diagram;\n\n      // Update preview\n      await this.updateMermaidPreview();\n\n      // Clear input\n      input.value = \"\";\n\n      console.log(\"✅ Diagram updated successfully by AI\");\n    } catch (error) {\n      console.error(\"❌ AI API error:\", error);\n\n      // Get user-friendly error message\n      const errorMessage = this.aiService.getErrorMessage(error);\n      alert(`❌ ${errorMessage}`);\n    } finally {\n      // Re-enable controls\n      sendBtn.disabled = false;\n      sendBtn.textContent = \"Send\";\n      input.disabled = false;\n      input.focus();\n    }\n  }\n\n  /**\n   * Save the current diagram back to Confluence\n   */\n  async saveDiagram() {\n    const codeEditor = document.getElementById(\"mermaid-code-editor\");\n    const saveBtn = document.getElementById(\"mermaid-ai-chat-save\");\n\n    if (!codeEditor) {\n      alert(\"❌ Code editor not found\");\n      return;\n    }\n\n    const currentCode = codeEditor.value.trim();\n    if (!currentCode) {\n      alert(\"⚠️ Please enter some Mermaid code first\");\n      return;\n    }\n\n    // Update current content\n    this.currentMermaidContent = currentCode;\n\n    // Disable save button and show loading\n    saveBtn.disabled = true;\n    saveBtn.textContent = \"💾 Saving...\";\n\n    try {\n      // Get saved diagram info from localStorage\n      const diagramInfoStr = localStorage.getItem(\"mermaid_diagram_info\");\n      if (!diagramInfoStr) {\n        throw new Error(\n          \"No diagram info found. Please click on a Mermaid image first.\"\n        );\n      }\n\n      const diagramInfo = JSON.parse(diagramInfoStr);\n      const pageId = MermaidApiClient.extractPageId();\n\n      if (!pageId) {\n        throw new Error(\"Could not extract page ID from current page.\");\n      }\n\n      console.log(`💾 Saving diagram with info:`, diagramInfo);\n\n      // Step 1: Update the Mermaid diagram with full data\n      const updateData = await this.updateMermaidDiagram(\n        diagramInfo.filename,\n        pageId,\n        currentCode,\n        diagramInfo.parsedParams\n      );\n      const reversionNew = updateData?.revision ? updateData.revision : 1;\n      // Step 2: Generate new placeholder image\n      const newImageHtml = await this.generatePlaceholderImage(\n        pageId,\n        diagramInfo.parsedParams,\n        reversionNew\n      );\n\n      // Step 3: Replace old image with new image in DOM\n      await this.replaceImageInDOM(\n        diagramInfo.parsedParams?.filename,\n        newImageHtml\n      );\n\n      // Show success message\n      alert(\"✅ Diagram saved and updated successfully!\");\n\n      // Close the popup after successful save\n      this.hideChatPopup();\n    } catch (error) {\n      console.error(\"❌ Error saving diagram:\", error);\n      alert(`❌ Error saving diagram: ${error.message}`);\n    } finally {\n      // Re-enable save button\n      saveBtn.disabled = false;\n      saveBtn.textContent = \"💾 Save\";\n    }\n  }\n\n  /**\n   * Update Mermaid diagram with full data (filename, data, svg, png)\n   */\n  async updateMermaidDiagram(filename, pageId, mermaidCode, parsedParams) {\n    console.log(`🔄 Updating Mermaid diagram: ${filename} on page ${pageId}`);\n\n    // Generate SVG and PNG from Mermaid code\n    const { svg, png } = await this.generateMermaidAssets(mermaidCode);\n\n    // Get current revision and increment it\n    const currentRevision = parseInt(parsedParams?.revision || \"1\");\n\n    const updateData = {\n      filename: filename,\n      data: mermaidCode,\n      revision: currentRevision + 1,\n      svg: svg,\n      png: png,\n    };\n\n    console.log(\"📤 Sending diagram update:\", {\n      filename,\n      revision: currentRevision + 1,\n      dataLength: mermaidCode.length,\n      svgLength: svg.length,\n      pngLength: png.length,\n    });\n\n    const response = await fetch(\n      `${CONFLUENCE_API_URLS.MERMAID_UPDATE}/${pageId}`,\n      {\n        method: \"PUT\",\n        headers: {\n          Accept: \"*/*\",\n          \"Accept-Language\": \"en-US,en;q=0.9,vi;q=0.8\",\n          \"Cache-Control\": \"no-cache\",\n          Connection: \"keep-alive\",\n          \"Content-Type\": \"application/json; charset=utf-8\",\n          Pragma: \"no-cache\",\n          Referer: CONFLUENCE_API_URLS.MERMAID_EDIT_REFERER,\n          \"Sec-Fetch-Dest\": \"empty\",\n          \"Sec-Fetch-Mode\": \"cors\",\n          \"Sec-Fetch-Site\": \"same-origin\",\n          \"User-Agent\": navigator.userAgent,\n          \"X-Requested-With\": \"XMLHttpRequest\",\n          \"X-Atlassian-Token\": \"no-check\",\n          \"sec-ch-ua\":\n            '\"Chromium\";v=\"140\", \"Not=A?Brand\";v=\"24\", \"Google Chrome\";v=\"140\"',\n          \"sec-ch-ua-mobile\": \"?0\",\n          \"sec-ch-ua-platform\": '\"Windows\"',\n        },\n        body: JSON.stringify(updateData),\n      }\n    );\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(\n        `Mermaid Update API Error: ${response.status} - ${errorText}`\n      );\n    }\n\n    const result = await response.json();\n    console.log(\"✅ Mermaid diagram updated successfully:\", result);\n    return result;\n  }\n\n  /**\n   * Generate SVG and PNG assets from Mermaid code\n   */\n  async generateMermaidAssets(mermaidCode) {\n    try {\n      // Import Mermaid dynamically if not already available\n      if (!window.mermaid) {\n        console.log(\"📦 Loading Mermaid library...\");\n        // Try to use existing Mermaid from page or load it\n        const script = document.createElement(\"script\");\n        script.src =\n          \"https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js\";\n        document.head.appendChild(script);\n\n        await new Promise((resolve, reject) => {\n          script.onload = resolve;\n          script.onerror = reject;\n        });\n      }\n\n      // Initialize Mermaid if needed\n      if (!window.mermaid.mermaidAPI) {\n        window.mermaid.initialize({ startOnLoad: false });\n      }\n\n      console.log(\"🎨 Generating SVG from Mermaid code...\");\n\n      // Generate SVG\n      const { svg } = await window.mermaid.render(\"temp-diagram\", mermaidCode);\n\n      console.log(\"✅ SVG generated successfully\", svg);\n\n      // Generate PNG from SVG using new method\n      const pngDataUrl = await this.convertSvgToPngDataUrl(svg);\n\n      if (!pngDataUrl) {\n        throw new Error(\"Failed to convert SVG to PNG\");\n      }\n\n      // Extract base64 part from data URL (remove \"data:image/png;base64,\" prefix)\n      const pngBase64 = pngDataUrl.split(\",\")[1];\n\n      console.log(\"✅ PNG generated successfully\");\n\n      return {\n        svg: svg,\n        png: pngBase64,\n      };\n    } catch (error) {\n      console.error(\"❌ Error generating Mermaid assets:\", error);\n      throw new Error(`Failed to generate Mermaid assets: ${error.message}`);\n    }\n  }\n\n  /**\n   * Encode SVG for API\n   */\n  encodeSvg(svg) {\n    // Encode SVG to base64\n    return btoa(\n      new TextEncoder()\n        .encode(svg)\n        .reduce((data, byte) => data + String.fromCharCode(byte), \"\")\n    );\n  }\n\n  /**\n   * Chuyển đổi chuỗi SVG thành chuỗi Data URL của định dạng PNG.\n   * @param {string} svgString Chuỗi XML của SVG (ví dụ: <svg>...</svg>).\n   * @param {number} scale Hệ số phóng đại (ví dụ: 2 để tăng gấp đôi độ phân giải).\n   * @returns {Promise<string|null>} Promise trả về chuỗi Data URL (data:image/png;base64,...)\n   */\n  async convertSvgToPngDataUrl(svgString, scale = 2) {\n    return new Promise((resolve) => {\n      if (!svgString) {\n        console.error(\"Lỗi: Chuỗi SVG đầu vào rỗng.\");\n        return resolve(null);\n      }\n\n      // 1. Mã hóa chuỗi SVG thành Data URL\n      // Cần đảm bảo chuỗi không có ký tự đặc biệt gây lỗi.\n      const svgUrl =\n        \"data:image/svg+xml;base64,\" +\n        btoa(\n          new TextEncoder()\n            .encode(svgString)\n            .reduce((data, byte) => data + String.fromCharCode(byte), \"\")\n        );\n\n      const canvas = document.createElement(\"canvas\");\n      const ctx = canvas.getContext(\"2d\");\n      const img = new Image();\n\n      img.onload = function () {\n        // Lấy kích thước gốc của SVG\n        const originalWidth = img.width;\n        const originalHeight = img.height;\n\n        // Đặt kích thước Canvas (Áp dụng Scale để có độ phân giải cao hơn)\n        canvas.width = originalWidth * scale;\n        canvas.height = originalHeight * scale;\n\n        // Quan trọng: Tối ưu hóa chất lượng hình ảnh\n        ctx.scale(scale, scale);\n        ctx.fillStyle = \"white\"; // Đặt nền trắng (PNG mặc định trong suốt nếu không set)\n        ctx.fillRect(0, 0, originalWidth, originalHeight); // Phủ nền trắng\n\n        // Vẽ ảnh SVG lên Canvas\n        ctx.drawImage(img, 0, 0);\n\n        // 3. Xuất ra chuỗi Data URL định dạng PNG\n        const pngDataUrl = canvas.toDataURL(\"image/png\");\n\n        // Dọn dẹp\n        canvas.remove();\n\n        resolve(pngDataUrl);\n      };\n\n      img.onerror = function (err) {\n        console.error(\"Lỗi khi tải SVG vào Image object:\", err);\n        // Dọn dẹp\n        canvas.remove();\n        resolve(null);\n      };\n\n      // Bắt đầu tải ảnh SVG đã mã hóa\n      img.src = svgUrl;\n    });\n  }\n\n  /**\n   * Convert SVG to PNG base64 (legacy method)\n   */\n  async svgToPng(svg) {\n    return new Promise((resolve, reject) => {\n      const canvas = document.createElement(\"canvas\");\n      const ctx = canvas.getContext(\"2d\");\n      const img = new Image();\n\n      img.onload = () => {\n        canvas.width = img.width;\n        canvas.height = img.height;\n        ctx.drawImage(img, 0, 0);\n\n        // Get base64 PNG (remove data:image/png;base64, prefix)\n        const pngBase64 = canvas.toDataURL(\"image/png\").split(\",\")[1];\n        resolve(pngBase64);\n      };\n\n      img.onerror = (error) => {\n        reject(new Error(`Failed to convert SVG to PNG: ${error}`));\n      };\n\n      // Create blob URL for SVG\n      const svgBlob = new Blob([svg], { type: \"image/svg+xml\" });\n      const url = URL.createObjectURL(svgBlob);\n      img.src = url;\n    });\n  }\n\n  /**\n   * Save Mermaid code to Confluence (legacy method - kept for compatibility)\n   */\n  async saveMermaidCode(filename, pageId, mermaidCode) {\n    const response = await fetch(CONFLUENCE_API_URLS.MERMAID_SAVE, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Accept: \"application/json\",\n        \"X-Atlassian-Token\": \"no-check\",\n      },\n      body: JSON.stringify({\n        pageId: pageId,\n        filename: filename,\n        mermaidCode: mermaidCode,\n      }),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(\n        `Mermaid Save API Error: ${response.status} - ${errorText}`\n      );\n    }\n\n    const result = await response.json();\n    console.log(\"✅ Mermaid code saved successfully:\", result);\n    return result;\n  }\n\n  /**\n   * Generate new placeholder image using TinyMCE API\n   */\n  async generatePlaceholderImage(pageId, parsedParams, reversionNew) {\n    const macroData = {\n      contentId: pageId,\n      macro: {\n        name: \"mermaid-cloud\",\n        params: {\n          filename: parsedParams?.filename || \"Diagram\",\n          revision: reversionNew, // Increment revision\n          zoom: parsedParams?.zoom || \"fit\",\n          toolbar: parsedParams?.toolbar || \"bottom\",\n          format: parsedParams?.format || \"svg\",\n        },\n      },\n    };\n\n    console.log(\"🖼️ Generating placeholder with data:\", macroData);\n\n    const response = await fetch(CONFLUENCE_API_URLS.TINYMCE_PLACEHOLDER, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json; charset=UTF-8\",\n        Accept: \"text/plain, */*; q=0.01\",\n        \"X-Requested-With\": \"XMLHttpRequest\",\n        \"X-Atlassian-Token\": \"no-check\",\n      },\n      body: JSON.stringify(macroData),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(\n        `TinyMCE Placeholder API Error: ${response.status} - ${errorText}`\n      );\n    }\n\n    const newImageHtml = await response.text();\n    console.log(\"✅ New placeholder image generated:\", newImageHtml);\n\n    return newImageHtml;\n  }\n\n  /**\n   * Replace old image with new image in DOM by filename\n   */\n  async replaceImageInDOM(filename, newImageHtml) {\n    if (!filename || !newImageHtml) {\n      console.error(\"❌ Missing filename or newImageHtml\");\n      return;\n    }\n\n    console.log(`🔄 Looking for images with filename: ${filename}`);\n\n    // Create temporary element to parse new image HTML\n    const tempDiv = document.createElement(\"div\");\n    tempDiv.innerHTML = newImageHtml;\n    const newImg = tempDiv.querySelector(\"img\");\n\n    if (!newImg) {\n      throw new Error(\"Could not parse new image from HTML\");\n    }\n\n    console.log(\"🆕 New image element:\", newImg);\n\n    // Find images by filename in data-macro-parameters\n    const foundImages = this.findImagesByFilename(filename);\n\n    console.log(`🔍 Found ${foundImages.length} images to replace`);\n\n    foundImages.forEach((oldImg, index) => {\n      console.log(`🔄 Replacing image ${index + 1}:`, oldImg);\n\n      // Replace all attributes from new image to old image\n      this.replaceImageAttributes(oldImg, newImg);\n\n      console.log(\"✅ Image replaced successfully:\", oldImg);\n    });\n  }\n\n  /**\n   * Find images by filename in data-macro-parameters\n   */\n  findImagesByFilename(filename) {\n    const foundImages = [];\n\n    // Search in main document\n    const mainImages = document.querySelectorAll(\"img[data-macro-parameters]\");\n    mainImages.forEach((img) => {\n      const macroParams = img.getAttribute(\"data-macro-parameters\");\n      if (macroParams && macroParams.includes(`filename=${filename}`)) {\n        foundImages.push(img);\n      }\n    });\n\n    // Search in iframes (Confluence editor)\n    const iframes = document.querySelectorAll(\"iframe\");\n    iframes.forEach((iframe) => {\n      try {\n        const iframeDoc =\n          iframe.contentDocument || iframe.contentWindow.document;\n        const iframeImages = iframeDoc.querySelectorAll(\n          \"img[data-macro-parameters]\"\n        );\n\n        iframeImages.forEach((img) => {\n          const macroParams = img.getAttribute(\"data-macro-parameters\");\n          if (macroParams && macroParams.includes(`filename=${filename}`)) {\n            foundImages.push(img);\n          }\n        });\n      } catch (error) {\n        console.warn(\"Could not access iframe content:\", error);\n      }\n    });\n\n    return foundImages;\n  }\n\n  /**\n   * Replace all attributes from new image to old image\n   */\n  replaceImageAttributes(oldImg, newImg) {\n    // Get all attributes from new image\n    const newAttributes = newImg.attributes;\n\n    // Remove all old attributes except those we want to keep\n    const attributesToKeep = [\"id\", \"class\"]; // Keep these if you want\n    const oldAttributes = Array.from(oldImg.attributes);\n\n    oldAttributes.forEach((attr) => {\n      if (!attributesToKeep.includes(attr.name)) {\n        oldImg.removeAttribute(attr.name);\n      }\n    });\n\n    // Copy all attributes from new image\n    Array.from(newAttributes).forEach((attr) => {\n      oldImg.setAttribute(attr.name, attr.value);\n    });\n\n    console.log(\"🔄 Attributes replaced:\", {\n      old: oldAttributes.map((a) => `${a.name}=\"${a.value}\"`),\n      new: Array.from(newAttributes).map((a) => `${a.name}=\"${a.value}\"`),\n    });\n  }\n\n  addMessage(type, content) {\n    const messagesContainer = document.getElementById(\n      \"mermaid-ai-chat-messages\"\n    );\n    const messageId = \"msg-\" + Date.now();\n\n    const messageDiv = document.createElement(\"div\");\n    messageDiv.className = `mermaid-ai-chat-message ${type}`;\n    messageDiv.id = messageId;\n    messageDiv.innerHTML = `\n      <div class=\"message-content\">\n        <p>${content}</p>\n      </div>\n    `;\n\n    messagesContainer.appendChild(messageDiv);\n    messagesContainer.scrollTop = messagesContainer.scrollHeight;\n\n    return messageId;\n  }\n\n  removeMessage(messageId) {\n    const message = document.getElementById(messageId);\n    if (message) {\n      message.remove();\n    }\n  }\n}\n\n// Export for use as service in K-Tool Extension\n// Initialization will be handled by the main content.js\n","// Chrome Storage Management\nimport { DEFAULT_SETTINGS, EXTENSION_SETTINGS_KEY } from \"./constants.js\";\n\nexport class StorageManager {\n  /**\n   * Load settings from Chrome storage\n   * @returns {Promise<Object>} Settings object\n   */\n  static async getSettings() {\n    try {\n      const result = await chrome.storage.sync.get([EXTENSION_SETTINGS_KEY]);\n      return result[EXTENSION_SETTINGS_KEY] || DEFAULT_SETTINGS;\n    } catch (error) {\n      console.error(\"Error loading settings:\", error);\n      return DEFAULT_SETTINGS;\n    }\n  }\n\n  /**\n   * Save settings to Chrome storage\n   * @param {Object} settings - Settings object to save\n   * @returns {Promise<boolean>} Success status\n   */\n  static async saveSettings(settings) {\n    try {\n      await chrome.storage.sync.set({ [EXTENSION_SETTINGS_KEY]: settings });\n      return true;\n    } catch (error) {\n      console.error(\"Error saving settings:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Update specific setting field\n   * @param {string} field - Field name to update\n   * @param {any} value - New value\n   * @returns {Promise<boolean>} Success status\n   */\n  static async updateSetting(field, value) {\n    try {\n      const currentSettings = await this.getSettings();\n      const updatedSettings = { ...currentSettings, [field]: value };\n      return await this.saveSettings(updatedSettings);\n    } catch (error) {\n      console.error(\"Error updating setting:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Reset settings to default\n   * @returns {Promise<boolean>} Success status\n   */\n  static async resetSettings() {\n    try {\n      await chrome.storage.sync.remove([EXTENSION_SETTINGS_KEY]);\n      return true;\n    } catch (error) {\n      console.error(\"Error resetting settings:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Validate settings object\n   * @param {Object} settings - Settings to validate\n   * @returns {Object} Validation result with errors\n   */\n  static validateSettings(settings) {\n    const errors = {};\n\n    if (!settings.apiKey?.trim()) {\n      errors.apiKey = \"API Key là bắt buộc\";\n    }\n\n    if (!settings.urlTemplate?.trim()) {\n      errors.urlTemplate = \"URL Template là bắt buộc\";\n    } else {\n      const validationResult = this.validateConfluencePageLink(\n        settings.urlTemplate\n      );\n\n      if (!validationResult.valid) {\n        errors.urlTemplate =\n          validationResult.error || \"URL Template không hợp lệ.\";\n      }\n    }\n    if (!settings.documentUrl?.trim()) {\n      errors.documentUrl = \"URL thư mục lưu tài liệu là bắt buộc\";\n    } else if (!this.isValidUrl(settings.documentUrl)) {\n      errors.documentUrl = \"URL không hợp lệ\";\n    }\n\n    if (!settings.databaseUrl?.trim()) {\n      errors.databaseUrl = \"URL thư mục database là bắt buộc\";\n    } else if (!this.isValidUrl(settings.databaseUrl)) {\n      errors.databaseUrl = \"URL không hợp lệ\";\n    }\n\n    // if (!settings.customPrompt?.trim()) {\n    //   errors.customPrompt = \"Custom Prompt là bắt buộc\";\n    // } else if (settings.customPrompt.trim().length < 10) {\n    //   errors.customPrompt = \"Custom Prompt phải có ít nhất 10 ký tự\";\n    // }\n\n    return {\n      isValid: Object.keys(errors).length === 0,\n      errors,\n    };\n  }\n\n  /**\n   * Check if URL is valid\n   * @param {string} url - URL to validate\n   * @returns {boolean} Is valid URL\n   */\n  static isValidUrl(url) {\n    try {\n      new URL(url);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * Validate Confluence page link (có pageId)\n   * @param {string} link - Link Confluence để kiểm tra\n   * @returns {Object} { valid: boolean, error?: string, pageId?: string }\n   */\n  static validateConfluencePageLink(link) {\n    const out = { valid: false, error: null, pageId: null };\n\n    if (!link || typeof link !== \"string\" || !link.trim()) {\n      out.error = \"URL là bắt buộc\";\n      return out;\n    }\n\n    let u;\n    try {\n      u = new URL(link.trim());\n    } catch {\n      out.error = \"URL không hợp lệ\";\n      return out;\n    }\n\n    // check pageId in query param\n    const pageIdParam = u.searchParams.get(\"pageId\");\n    if (pageIdParam && /^\\d+$/.test(pageIdParam)) {\n      out.valid = true;\n      out.pageId = pageIdParam;\n      return out;\n    }\n\n    // check pageId in path (/pages/{id})\n    const pathParts = u.pathname.split(\"/\");\n    const pagesIndex = pathParts.indexOf(\"pages\");\n    if (pagesIndex >= 0 && pathParts.length > pagesIndex + 1) {\n      const candidate = pathParts[pagesIndex + 1];\n      if (/^\\d+$/.test(candidate)) {\n        out.valid = true;\n        out.pageId = candidate;\n        return out;\n      }\n    }\n\n    out.error = \"Không tìm thấy pageId trong URL\";\n    return out;\n  }\n}\n","// Mermaid Rendering Utilities\n// Handles Mermaid diagram loading, rendering and error handling\n\nexport class MermaidRenderer {\n  /**\n   * Load Mermaid script dynamically\n   * @returns {Promise<object>} Mermaid instance\n   */\n  static async loadMermaidScript() {\n    if (window.mermaid) {\n      console.log(\"⚡ Mermaid already loaded\");\n      return window.mermaid;\n    }\n\n    const res = await fetch(chrome.runtime.getURL(\"lib/mermaid.min.js\"));\n    const text = await res.text();\n    eval(text); // UMD will attach mermaid to window\n    console.log(\"✅ Mermaid loaded dynamically\");\n    return window.mermaid;\n  }\n\n  /**\n   * Initialize Mermaid with proper configuration\n   * @returns {Promise<void>}\n   */\n  static async initializeMermaid() {\n    await this.loadMermaidScript();\n\n    // Configure Mermaid with proper DOM context\n    window.mermaid.initialize({\n      startOnLoad: false,\n      theme: \"default\",\n      securityLevel: \"loose\",\n      fontFamily: \"Arial, sans-serif\",\n      // Ensure proper DOM context\n      htmlLabels: true,\n      flowchart: {\n        htmlLabels: true,\n      },\n      // Set the document context explicitly\n      deterministicIds: true,\n      deterministicIDSeed: \"mermaid-diagram-preview\",\n    });\n\n    // Ensure mermaid has access to document\n    if (window.mermaid.setConfig) {\n      window.mermaid.setConfig({\n        securityLevel: \"loose\",\n        theme: \"default\",\n      });\n    }\n  }\n\n  /**\n   * Render a single Mermaid diagram\n   * @param {string} diagramId - Unique ID for the diagram\n   * @param {string} mermaidCode - Mermaid diagram code\n   * @param {HTMLElement} container - Container element\n   * @returns {Promise<void>}\n   */\n  static async renderDiagram(diagramId, mermaidCode, container) {\n    try {\n      // 🧹 Làm sạch code trước\n      const cleanCode = this.cleanMermaidCode(mermaidCode);\n      console.log(\"🧹 Cleaned Mermaid code for rendering:\", cleanCode);\n\n      // 🧩 Kiểm tra hợp lệ\n      if (!this.validateMermaidCode(cleanCode)) {\n        throw new Error(\"Invalid Mermaid syntax after cleaning\");\n      }\n      if (!container || container.nodeType !== Node.ELEMENT_NODE) {\n        throw new Error(\"Invalid container for Mermaid diagram\");\n      }\n\n      // ⚙️ Đảm bảo Mermaid đã sẵn sàng\n      if (!window.mermaid || typeof window.mermaid.render !== \"function\") {\n        throw new Error(\"Mermaid render function not available\");\n      }\n\n      // 🚫 Ngăn chèn SVG lỗi vào body bằng container ảo\n      const tempContainer = document.createElement(\"div\");\n      tempContainer.style.position = \"absolute\";\n      tempContainer.style.left = \"-9999px\";\n      tempContainer.style.top = \"-9999px\";\n      tempContainer.style.visibility = \"hidden\";\n      document.body.appendChild(tempContainer);\n\n      try {\n        let svgCode;\n\n        // ⚡ API hiện đại (Promise-based)\n        const renderResult = await window.mermaid.render(\n          diagramId,\n          cleanCode,\n          tempContainer\n        );\n\n        // Xử lý các kiểu trả về khác nhau\n        if (typeof renderResult === \"string\") {\n          svgCode = renderResult;\n        } else if (renderResult && renderResult.svg) {\n          svgCode = renderResult.svg;\n        } else {\n          svgCode = tempContainer.innerHTML;\n        }\n\n        // ✅ Gán SVG vào container thực tế\n        container.innerHTML = svgCode;\n        console.log(\"✅ Mermaid diagram rendered successfully!\");\n      } catch (renderError) {\n        console.error(\"❌ Mermaid render error:\", renderError);\n        this.showMermaidError(container, mermaidCode, renderError);\n      } finally {\n        // 🧹 Dọn container ảo để tránh chèn SVG rác\n        if (tempContainer && tempContainer.parentNode) {\n          tempContainer.remove();\n        }\n      }\n    } catch (error) {\n      console.error(\"❌ Mermaid render error (outer):\", error);\n      this.showMermaidError(container, mermaidCode, error);\n    }\n  }\n\n  /**\n   * Show Mermaid error in a nice format\n   * @param {HTMLElement} container - Container element\n   * @param {string} text - Mermaid code that failed\n   * @param {Error} error - Error object\n   */\n  static showMermaidError(container, text, error) {\n    // Validate container before attempting to set innerHTML\n    if (\n      !container ||\n      !container.nodeType ||\n      container.nodeType !== Node.ELEMENT_NODE\n    ) {\n      console.error(\n        \"❌ Invalid container for Mermaid error display:\",\n        container\n      );\n      console.error(\"❌ Mermaid error details:\", {\n        message: error.message || \"Unknown error occurred\",\n        code: text ? text.substring(0, 100) + \"...\" : \"No code provided\",\n      });\n      return;\n    }\n\n    // Check if container is still in the DOM\n    if (!document.contains(container)) {\n      console.error(\"❌ Container is not in DOM, cannot display Mermaid error\");\n      console.error(\"❌ Mermaid error details:\", {\n        message: error.message || \"Unknown error occurred\",\n        code: text ? text.substring(0, 100) + \"...\" : \"No code provided\",\n      });\n      return;\n    }\n\n    try {\n      container.innerHTML = `\n        <div style=\"color: #dc3545; padding: 15px; background: #f8d7da; border-radius: 8px; border: 1px solid #f5c6cb; font-family: Arial, sans-serif;\">\n          <div style=\"font-weight: bold; margin-bottom: 8px; display: flex; align-items: center;\">\n            <span style=\"margin-right: 8px;\">⚠️</span>\n            Mermaid Render Error\n          </div>\n          <div style=\"font-size: 12px; color: #721c24; margin-bottom: 10px;\">\n            ${error.message || \"Unknown error occurred\"}\n          </div>\n          <details style=\"margin-top: 10px;\">\n            <summary style=\"cursor: pointer; font-size: 12px; color: #495057;\">Show diagram code</summary>\n            <pre style=\"margin: 8px 0 0 0; padding: 8px; background: #fff; border: 1px solid #dee2e6; border-radius: 4px; font-size: 11px; overflow-x: auto; white-space: pre-wrap;\">${\n              text || \"No code provided\"\n            }</pre>\n          </details>\n        </div>\n      `;\n    } catch (setInnerHTMLError) {\n      console.error(\n        \"❌ Failed to set error HTML in container:\",\n        setInnerHTMLError\n      );\n      console.error(\"❌ Original Mermaid error:\", {\n        message: error.message || \"Unknown error occurred\",\n        code: text ? text.substring(0, 100) + \"...\" : \"No code provided\",\n      });\n    }\n  }\n\n  /**\n   * Detect Mermaid diagram type from code\n   * @param {string} code - Mermaid diagram code\n   * @returns {string} Diagram type\n   */\n  static detectMermaidType(code) {\n    const firstLine = code.trim().split(\"\\n\")[0].toLowerCase();\n    if (firstLine.includes(\"graph\")) return \"graph\";\n    if (firstLine.includes(\"flowchart\")) return \"flowchart\";\n    if (firstLine.includes(\"sequencediagram\")) return \"sequence\";\n    if (firstLine.includes(\"classDiagram\")) return \"class\";\n    if (firstLine.includes(\"stateDiagram\")) return \"state\";\n    if (firstLine.includes(\"erDiagram\")) return \"er\";\n    if (firstLine.includes(\"gantt\")) return \"gantt\";\n    if (firstLine.includes(\"pie\")) return \"pie\";\n    return \"graph\";\n  }\n\n  /**\n   * Extract Mermaid diagrams from Confluence content\n   * @param {string} content - Confluence storage format content\n   * @returns {Array} Array of diagram objects\n   */\n  static extractMermaidDiagrams(content) {\n    const diagrams = [];\n    const diagramsMap = new Map();\n\n    if (!content) return { diagrams, diagramsMap };\n\n    // Regex to find all <ac:structured-macro ...> ... </ac:structured-macro>\n    const macroRegex =\n      /<ac:structured-macro[^>]*ac:name=\"(mermaid|code)\"[^>]*>([\\s\\S]*?)<\\/ac:structured-macro>/gi;\n\n    let match;\n    let index = 0;\n\n    while ((match = macroRegex.exec(content)) !== null) {\n      const macroName = match[1];\n      const macroContent = match[2];\n\n      // Check code parameter\n      const codeMatch = macroContent.match(\n        /<ac:parameter[^>]*ac:name=\"code\">([\\s\\S]*?)<\\/ac:parameter>/\n      );\n      if (!codeMatch) continue;\n\n      const code = codeMatch[1].trim();\n      if (!code) continue;\n\n      // If it's code macro, check language\n      if (macroName === \"code\") {\n        const langMatch = macroContent.match(\n          /<ac:parameter[^>]*ac:name=\"language\">([\\s\\S]*?)<\\/ac:parameter>/\n        );\n        if (!langMatch || langMatch[1].trim() !== \"mermaid\") continue;\n      }\n\n      const type = this.detectMermaidType(code);\n      const diagramId = `mermaid-diagram-${index}`;\n\n      const diagramRecord = {\n        id: diagramId,\n        code: code,\n        originalCode: code,\n        originalMatch: match[0],\n        index: index,\n        type: type,\n        title: `${type.charAt(0).toUpperCase() + type.slice(1)} Diagram ${\n          index + 1\n        }`,\n      };\n\n      diagrams.push(diagramRecord);\n      diagramsMap.set(diagramId, {\n        content: code,\n        type: type,\n        index: index,\n        title: diagramRecord.title,\n      });\n\n      console.log(`✅ Extracted diagram ${index}:`, {\n        type,\n        code: code.substring(0, 50) + \"...\",\n      });\n\n      index++;\n    }\n\n    console.log(\"🎨 Extracted Mermaid diagrams:\", diagrams);\n    return { diagrams, diagramsMap };\n  }\n\n  /**\n   * Clean Mermaid code - remove unwanted characters and normalize\n   * @param {string} code - Raw Mermaid code\n   * @returns {string} Cleaned code\n   */\n  static cleanMermaidCode(code) {\n    if (!code) return \"\";\n\n    // Remove HTML entities\n    let cleaned = code\n      .replace(/&lt;/g, \"<\")\n      .replace(/&gt;/g, \">\")\n      .replace(/&amp;/g, \"&\")\n      .replace(/&quot;/g, '\"')\n      .replace(/&#39;/g, \"'\");\n\n    // Remove CDATA sections\n    cleaned = cleaned.replace(/<!\\[CDATA\\[(.*?)\\]\\]>/gs, \"$1\");\n\n    // Remove HTML tags\n    cleaned = cleaned.replace(/<[^>]*>/g, \"\");\n\n    // Normalize whitespace\n    cleaned = cleaned.replace(/\\r\\n/g, \"\\n\").replace(/\\r/g, \"\\n\");\n\n    // Remove excessive whitespace but preserve structure\n    cleaned = cleaned.replace(/\\n\\s*\\n\\s*\\n/g, \"\\n\\n\");\n\n    // Trim\n    cleaned = cleaned.trim();\n\n    return cleaned;\n  }\n\n  /**\n   * Validate Mermaid code syntax\n   * @param {string} code - Mermaid code to validate\n   * @returns {boolean} True if valid\n   */\n  static validateMermaidCode(code) {\n    if (!code || !code.trim()) {\n      return false;\n    }\n\n    const trimmed = code.trim();\n\n    // Check for valid Mermaid diagram types\n    const validStarters = [\n      \"graph\",\n      \"flowchart\",\n      \"sequenceDiagram\",\n      \"classDiagram\",\n      \"stateDiagram\",\n      \"erDiagram\",\n      \"journey\",\n      \"gantt\",\n      \"pie\",\n      \"gitgraph\",\n      \"mindmap\",\n      \"timeline\",\n      \"sankey\",\n      \"requirement\",\n    ];\n\n    const hasValidStarter = validStarters.some((starter) =>\n      trimmed.toLowerCase().startsWith(starter.toLowerCase())\n    );\n\n    if (!hasValidStarter) {\n      return false;\n    }\n\n    // Check for common syntax issues\n    if (trimmed.includes(\"undefined\") || trimmed.includes(\"null\")) {\n      return false;\n    }\n\n    return true;\n  }\n}\n","/**\n * Diagram processing utilities for Confluence page creation\n * Ported from extension/src/api/api.ts and extension/src/utils/mermaidExporter.ts\n */\n\n/**\n * DiagramData interface equivalent for JavaScript\n * @typedef {Object} DiagramData\n * @property {string} filename - The filename for the diagram\n * @property {string} macroId - The macro ID\n * @property {string} diagramCode - The mermaid diagram code\n * @property {string} [svg] - The SVG content\n * @property {string} [png] - The PNG base64 content\n */\n\n/**\n * Extract diagrams from Confluence storage format - EXACT copy from extension\n * @param {string} storage - The storage format content\n * @returns {DiagramData[]} Array of extracted diagrams\n */\nexport function getDiagramConfluenceStyles(storage) {\n  let macroCounter = 1;\n  const extractedDiagrams = [];\n  \n  // Find all mermaid macros in storage content\n  const mermaidRegex = /<ac:structured-macro[^>]*ac:name=\"mermaid\"[^>]*>[\\s\\S]*?<ac:parameter[^>]*ac:name=\"code\"[^>]*>(?:<!\\[CDATA\\[([\\s\\S]*?)\\]\\]>|([\\s\\S]*?))<\\/ac:parameter>[\\s\\S]*?<\\/ac:structured-macro>/g;\n  \n  let match;\n  while ((match = mermaidRegex.exec(storage)) !== null) {\n    const code = (match[1] || match[2] || '').trim();\n    \n    if (code) {\n      extractedDiagrams.push({\n        filename: `k-tool-diagram-${macroCounter}`,\n        macroId: (110 + macroCounter).toString(),\n        diagramCode: code\n      });\n      macroCounter++;\n    }\n  }\n\n  return extractedDiagrams;\n}\n\n/**\n * Load mermaid script dynamically if not already loaded\n * @returns {Promise<void>}\n */\nasync function loadMermaidScript() {\n  if (typeof window !== 'undefined' && window.mermaid) {\n    return; // Already loaded\n  }\n\n  return new Promise((resolve, reject) => {\n    const script = document.createElement('script');\n    script.src = 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js';\n    script.onload = () => {\n      // Initialize mermaid\n      if (window.mermaid) {\n        window.mermaid.initialize({ \n          startOnLoad: false, \n          securityLevel: 'loose',\n          theme: 'default'\n        });\n      }\n      resolve();\n    };\n    script.onerror = reject;\n    document.head.appendChild(script);\n  });\n}\n\n/**\n * Convert diagram code to SVG and PNG using mermaid - EXACT copy from extension\n * @param {DiagramData} diagram - The diagram data\n * @returns {Promise<DiagramData>} The diagram with SVG and PNG data\n */\nexport async function convertDiagramToSvgPng(diagram) {\n  try {\n    console.log(`🎨 Converting diagram to SVG/PNG: ${diagram.filename}`);\n    console.log(`🎨 Converting diagram to SVG/PNG: ${diagram.diagramCode}`);\n\n    // Ensure mermaid is loaded\n    await loadMermaidScript();\n\n    // Use mermaid to render SVG\n    const svgResult = await window.mermaid.render(`diagram-${diagram.macroId}`, diagram.diagramCode);\n    \n    // Handle different return types from mermaid.render\n    let svgContent;\n    if (typeof svgResult === 'string') {\n      svgContent = svgResult;\n    } else if (svgResult && typeof svgResult === 'object' && svgResult.svg) {\n      svgContent = svgResult.svg;\n    } else {\n      throw new Error('Invalid SVG result from mermaid.render');\n    }\n    \n    diagram.svg = svgContent;\n    \n    // Convert SVG to PNG using canvas\n    const canvas = document.createElement('canvas');\n    const ctx = canvas.getContext('2d');\n    const img = new Image();\n    \n    await new Promise((resolve, reject) => {\n      img.onload = () => {\n        canvas.width = img.width || 800;\n        canvas.height = img.height || 600;\n        \n        if (ctx) {\n          ctx.fillStyle = 'white';\n          ctx.fillRect(0, 0, canvas.width, canvas.height);\n          ctx.drawImage(img, 0, 0);\n          diagram.png = canvas.toDataURL('image/png').split(',')[1]; // Remove data:image/png;base64,\n        }\n        resolve(true);\n      };\n      \n      img.onerror = reject;\n      img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgContent)));\n    });\n    \n    console.log(`✅ Successfully converted ${diagram.filename} to SVG/PNG`);\n    return diagram;\n    \n  } catch (error) {\n    console.error(`❌ Failed to convert diagram ${diagram.filename}:`, error);\n    \n    // Create fallback PNG data\n    diagram.png = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';\n    return diagram;\n  }\n}\n\n/**\n * Save diagram to mermaid-cloud API - EXACT copy from extension\n * @param {DiagramData} diagram - The diagram data\n * @param {string} pageId - The page ID\n * @returns {Promise<boolean>} Success status\n */\nexport async function saveDiagramToAPI(diagram, pageId) {\n  try {\n    console.log(`💾 Saving diagram ${diagram.filename} to API for page ${pageId}`);\n    \n    const payload = {\n      filename: diagram.filename,\n      data: diagram.diagramCode,\n      svg: diagram.svg || '',\n      png: diagram.png || ''\n    };\n    \n    const response = await fetch(`/rest/mermaidrest/1.0/mermaid/${pageId}`, {\n      method: 'POST',\n      headers: {\n        'Accept': 'application/json, text/javascript, */*; q=0.01',\n        'Content-Type': 'application/json; charset=UTF-8',\n        'X-Requested-With': 'XMLHttpRequest'\n      },\n      body: JSON.stringify(payload)\n    });\n    \n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error(`❌ Failed to save diagram ${diagram.filename}:`, response.status, errorText);\n      return false;\n    }\n    \n    console.log(`✅ Successfully saved diagram ${diagram.filename} to API`);\n    return true;\n    \n  } catch (error) {\n    console.error(`❌ Error saving diagram ${diagram.filename}:`, error);\n    return false;\n  }\n}\n\n/**\n * Process all extracted diagrams and save them to API sequentially - EXACT copy from extension\n * @param {string} pageId - The page ID\n * @param {DiagramData[]} extractedDiagrams - Array of diagrams to process\n * @returns {Promise<{success: number, total: number, errors: string[]}>} Processing result\n */\nexport async function processAndSaveDiagrams(pageId, extractedDiagrams) {\n  if (extractedDiagrams.length === 0) {\n    console.log('ℹ️ No diagrams to process');\n    return { success: 0, total: 0, errors: [] };\n  }\n  \n  console.log(`🔄 Processing ${extractedDiagrams.length} diagrams for page ${pageId}`);\n  \n  let successCount = 0;\n  const errors = [];\n  const totalDiagrams = extractedDiagrams.length;\n  \n  try {\n    // Convert all diagrams to SVG/PNG first\n    console.log('🎨 Converting diagrams to SVG/PNG...');\n    const processedDiagrams = await Promise.all(\n      extractedDiagrams.map(diagram => convertDiagramToSvgPng(diagram))\n    );\n    \n    // Save diagrams sequentially (one by one)\n    console.log('💾 Saving diagrams sequentially...');\n    for (let i = 0; i < processedDiagrams.length; i++) {\n      const diagram = processedDiagrams[i];\n      console.log(`📊 Saving diagram ${i + 1}/${processedDiagrams.length}: ${diagram.filename}`);\n      \n      try {\n        const success = await saveDiagramToAPI(diagram, pageId);\n        if (success) {\n          successCount++;\n          console.log(`✅ Diagram ${i + 1}/${processedDiagrams.length} saved successfully`);\n        } else {\n          errors.push(`Failed to save diagram: ${diagram.filename}`);\n          console.error(`❌ Diagram ${i + 1}/${processedDiagrams.length} failed to save`);\n        }\n      } catch (error) {\n        const errorMsg = `Error saving diagram ${diagram.filename}: ${error instanceof Error ? error.message : 'Unknown error'}`;\n        errors.push(errorMsg);\n        console.error(`❌ Diagram ${i + 1}/${processedDiagrams.length} error:`, error);\n      }\n      \n      // Add small delay between saves to avoid overwhelming the API\n      if (i < processedDiagrams.length - 1) {\n        await new Promise(resolve => setTimeout(resolve, 500));\n      }\n    }\n    \n  } catch (error) {\n    console.error('❌ Error during diagram processing:', error);\n    errors.push(`Processing error: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n  \n  const result = {\n    success: successCount,\n    total: totalDiagrams,\n    errors\n  };\n  \n  console.log(`📊 Diagram processing complete: ${successCount}/${totalDiagrams} successful`);\n  if (errors.length > 0) {\n    console.warn('⚠️ Diagram processing errors:', errors);\n  }\n  \n  return result;\n}\n","// API utilities for K-Tool Extension\nimport { API_URLS } from \"./constants.js\";\nimport {\n  getDiagramConfluenceStyles,\n  processAndSaveDiagrams,\n} from \"./diagramUtils.js\";\n\nexport class ApiClient {\n  /**\n   * Make HTTP request with error handling\n   * @param {string} url - Request URL\n   * @param {Object} options - Fetch options\n   * @returns {Promise<Object>} Response data\n   */\n  static async request(url, options = {}) {\n    try {\n      const response = await fetch(url, {\n        headers: {\n          \"Content-Type\": \"application/json\",\n          ...options.headers,\n        },\n        ...options,\n      });\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      return { success: true, data };\n    } catch (error) {\n      console.error(\"API request failed:\", error);\n      return { success: false, error: error.message };\n    }\n  }\n\n  /**\n   * Generate document from BA content\n   * @param {Object} payload - Generation payload\n   * @returns {Promise<Object>} Job response\n   */\n  static async generateDocument(payload) {\n    return await this.request(API_URLS.GEN_DOC, {\n      method: \"POST\",\n      body: JSON.stringify(payload),\n    });\n  }\n\n  /**\n   * Check generation status\n   * @param {string} jobId - Job ID to check\n   * @returns {Promise<Object>} Status response\n   */\n  static async checkStatus(jobId) {\n    return await this.request(`${API_URLS.GEN_DOC_STATUS}?job_id=${jobId}`);\n  }\n\n  /**\n   * Get generation result\n   * @param {string} jobId - Job ID to get result\n   * @returns {Promise<Object>} Result response\n   */\n  static async getResult(jobId) {\n    return await this.request(`${API_URLS.GEN_DOC_RESULT}?job_id=${jobId}`);\n  }\n\n  /**\n   * Edit text using AI\n   * @param {Object} payload - Edit payload\n   * @returns {Promise<Object>} Edit response\n   */\n  static async editText(payload) {\n    return await this.request(API_URLS.EDIT_TEXT, {\n      method: \"POST\",\n      body: JSON.stringify(payload),\n    });\n  }\n}\n\n/**\n * Confluence API utilities\n */\nexport class ConfluenceApi {\n  /**\n   * Extract page ID from Confluence URL\n   * @param {string} url - Confluence page URL\n   * @returns {string|null} Page ID or null\n   */\n  static extractPageId(url) {\n    const patterns = [/\\/pages\\/(\\d+)/, /pageId=(\\d+)/, /\\/(\\d+)$/];\n\n    for (const pattern of patterns) {\n      const match = url.match(pattern);\n      if (match) return match[1];\n    }\n\n    return null;\n  }\n\n  /**\n   * Get current space key from page\n   * @returns {string|null} Space key or null\n   */\n  static getCurrentSpaceKey() {\n    // Try to get space key from various sources\n    const spaceKeyMeta = document.querySelector('meta[name=\"ajs-space-key\"]');\n    if (spaceKeyMeta) return spaceKeyMeta.content;\n\n    const spaceKeyElement = document.querySelector(\"[data-space-key]\");\n    if (spaceKeyElement) return spaceKeyElement.dataset.spaceKey;\n\n    // Try to extract from URL\n    const urlMatch = window.location.pathname.match(/\\/spaces\\/([^\\/]+)/);\n    if (urlMatch) return urlMatch[1];\n\n    return null;\n  }\n\n  /**\n   * Fetch page content from Confluence\n   * @param {string} pageId - Page ID to fetch\n   * @returns {Promise<Object>} Page content with title, content (view), and storageFormat\n   */\n  static async fetchPageContent(pageId) {\n    try {\n      console.log(\"🔍 Fetching Confluence content for pageId:\", pageId);\n\n      const apiUrl = `/rest/api/content/${pageId}?expand=body.storage,body.view`;\n\n      const response = await fetch(apiUrl, {\n        method: \"GET\",\n        headers: {\n          Accept: \"application/json\",\n          \"Content-Type\": \"application/json\",\n        },\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(\"❌ API Error:\", response.status, errorText);\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      console.log(\"📄 Content data received:\", {\n        id: data.id,\n        title: data.title,\n        hasStorage: !!data.body?.storage?.value,\n        hasView: !!data.body?.view?.value,\n      });\n\n      return {\n        title: data.title,\n        content: data.body?.view?.value || \"\",\n        storageFormat: data.body?.storage?.value || \"\",\n      };\n    } catch (error) {\n      console.error(\"❌ Error fetching Confluence content:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * Clone template from URL for document generation\n   * @param {string} url - Template URL\n   * @returns {Promise<Object>} Cloned template data\n   */\n  static async cloneTemplateForGeneration(url) {\n    try {\n      console.log(\"🔍 Cloning template from URL:\", url);\n\n      if (!url || !url.trim()) {\n        console.error(\"❌ Empty URL provided\");\n        throw new Error(\"URL template không được để trống\");\n      }\n\n      // Extract pageId from URL\n      const pageId = this.extractPageIdFromUrl(url);\n      if (!pageId) {\n        console.error(\"❌ No pageId found in URL\");\n        throw new Error(\n          \"URL không chứa pageId hợp lệ. Vui lòng kiểm tra lại URL template.\"\n        );\n      }\n\n      console.log(\"📋 Fetching template pageId:\", pageId);\n      const apiUrl = `/rest/api/content/${pageId}?expand=body.storage`;\n\n      const response = await fetch(apiUrl, {\n        method: \"GET\",\n        headers: {\n          Accept: \"application/json\",\n          \"Content-Type\": \"application/json\",\n        },\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(\"❌ API Error:\", response.status, errorText);\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      console.log(\"📄 Template data received:\", {\n        id: data.id,\n        title: data.title,\n        hasStorage: !!data.body?.storage?.value,\n      });\n\n      if (!data.body?.storage?.value) {\n        console.error(\"❌ No storage content found in response\");\n        throw new Error(\"Template không có nội dung storage format\");\n      }\n\n      const originalStorageFormat = data.body.storage.value;\n      console.log(\n        \"📄 Original storage format length:\",\n        originalStorageFormat.length\n      );\n\n      const { templateStructure, analysisInfo } = this.extractTemplateStructure(\n        originalStorageFormat\n      );\n\n      const result = {\n        title: data.title,\n        originalStorageFormat,\n        templateStructure,\n        analysisInfo,\n      };\n\n      console.log(\"✅ Template cloned successfully:\", {\n        title: result.title,\n        originalLength: originalStorageFormat.length,\n        structureLength: templateStructure.length,\n        analysis: analysisInfo,\n      });\n\n      return result;\n    } catch (error) {\n      console.error(\"❌ Error cloning template:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * Extract template structure and analyze placeholders\n   * @param {string} storageFormat - Original storage format\n   * @returns {Object} Template structure and analysis info\n   */\n  static extractTemplateStructure(storageFormat) {\n    let emptyParagraphs = 0;\n    let emptyTableCells = 0;\n    let placeholders = 0;\n\n    console.log(\"🔍 Extracting template structure...\");\n\n    const placeholderPatterns = [\n      /(<<.*?>>)/g,\n      /(\\{\\{.*?\\}\\})/g,\n      /(&lt;&lt;.*?&gt;&gt;)/g,\n      /(\\u003c\\u003c.*?\\u003e\\u003e)/g,\n    ];\n\n    let structure = storageFormat;\n\n    placeholderPatterns.forEach((regex, index) => {\n      const matches = [...structure.matchAll(regex)];\n      console.log(\n        `🎯 Placeholder pattern ${index + 1} found ${matches.length} matches`\n      );\n      placeholders += matches.length;\n    });\n\n    // Count empty paragraphs and table cells\n    emptyParagraphs = (storageFormat.match(/<p[^>]*>\\s*<\\/p>/g) || []).length;\n    emptyTableCells = (storageFormat.match(/<td[^>]*>\\s*<\\/td>/g) || []).length;\n\n    const analysisInfo = {\n      emptyParagraphs,\n      emptyTableCells,\n      placeholders,\n      totalLength: storageFormat.length,\n    };\n\n    return {\n      templateStructure: structure,\n      analysisInfo,\n    };\n  }\n\n  /**\n   * Extract pageId from various URL formats\n   * @param {string} url - URL to extract pageId from\n   * @returns {string|null} Page ID or null\n   */\n  static extractPageIdFromUrl(url) {\n    const patterns = [\n      /\\/pages\\/(\\d+)/,\n      /pageId=(\\d+)/,\n      /\\/(\\d+)$/,\n      /viewpage\\.action\\?pageId=(\\d+)/,\n    ];\n\n    for (const pattern of patterns) {\n      const match = url.match(pattern);\n      if (match) return match[1];\n    }\n\n    return null;\n  }\n\n  /**\n   * Extract placeholders from content (<<placeholder>> format)\n   * @param {string} content - Content to analyze\n   * @returns {Array} Array of placeholder strings\n   */\n  static extractPlaceholders(content) {\n    console.log(\"🔍 Analyzing content for placeholders...\");\n    console.log(\"📄 Content length:\", content.length);\n    console.log(\n      \"📄 Content preview (first 500 chars):\",\n      content.substring(0, 500)\n    );\n\n    // Helper function to decode HTML entities\n    const decodeHtmlEntities = (str) => {\n      return str\n        .replace(/&lt;/g, \"<\")\n        .replace(/&gt;/g, \">\")\n        .replace(/&amp;/g, \"&\")\n        .replace(/&quot;/g, '\"')\n        .replace(/&#39;/g, \"'\");\n    };\n\n    const decodedContent = decodeHtmlEntities(content);\n\n    // Patterns to find placeholders\n    const patterns = [\n      /<<([^>]+)>>/g, // Normal <<placeholder>>\n      /&lt;&lt;([^&]+)&gt;&gt;/g, // HTML encoded &lt;&lt;placeholder&gt;&gt;\n    ];\n\n    let allMatches = [];\n\n    // Test patterns on both original and decoded content\n    [content, decodedContent].forEach((testContent, contentIndex) => {\n      console.log(\n        `🔍 Testing on ${\n          contentIndex === 0 ? \"original\" : \"decoded\"\n        } content...`\n      );\n\n      patterns.forEach((regex, patternIndex) => {\n        const matches = [...testContent.matchAll(regex)];\n        console.log(\n          `🎯 Pattern ${patternIndex + 1} found ${matches.length} matches:`,\n          matches.map((m) => m[0])\n        );\n\n        if (patternIndex === 1) {\n          // For HTML encoded, decode back to normal format\n          allMatches.push(...matches.map((match) => `<<${match[1]}>>`));\n        } else {\n          allMatches.push(...matches.map((match) => match[0]));\n        }\n      });\n    });\n\n    // Remove duplicates\n    const uniquePlaceholders = [...new Set(allMatches)];\n    console.log(\"🎯 Unique placeholders found:\", uniquePlaceholders);\n\n    return uniquePlaceholders;\n  }\n\n  /**\n   * Extract images from HTML content and convert to base64\n   * @param {string} html - HTML content\n   * @returns {Promise<Array>} Array of image objects with base64 data\n   */\n  static async extractImagesFromHtml(html) {\n    const images = [];\n    try {\n      const parser = new DOMParser();\n      const doc = parser.parseFromString(html, \"text/html\");\n      const imgTags = doc.querySelectorAll(\"img\");\n\n      for (const img of Array.from(imgTags)) {\n        const src = img.getAttribute(\"src\");\n        let filename = undefined;\n\n        if (src) {\n          let base64src = src;\n\n          if (!src.startsWith(\"data:image\")) {\n            // Convert URL to base64 and get filename\n            const { base64, filename: fname } = await this.urlToBase64(src);\n            if (base64) {\n              base64src = base64;\n              filename = fname;\n            } else continue; // skip if failed\n          } else {\n            // If already base64, get name from alt or set default\n            filename = img.getAttribute(\"alt\")\n              ? img.getAttribute(\"alt\") + \".png\"\n              : `image_${Date.now()}.png`;\n          }\n\n          images.push({\n            src: base64src,\n            alt: img.getAttribute(\"alt\") || undefined,\n            filename,\n          });\n        }\n      }\n    } catch (e) {\n      console.warn(\"extractImagesFromHtml error:\", e);\n    }\n    return images;\n  }\n\n  /**\n   * Convert image URL to base64\n   * @param {string} url - Image URL\n   * @returns {Promise<Object>} Object with base64 data and filename\n   */\n  static async urlToBase64(url) {\n    try {\n      const response = await fetch(url);\n      if (!response.ok)\n        return { base64: null, filename: this.getFilenameFromUrl(url) };\n\n      const blob = await response.blob();\n      const filename = this.getFilenameFromUrl(url);\n\n      return await new Promise((resolve, reject) => {\n        const reader = new FileReader();\n        reader.onloadend = () => resolve({ base64: reader.result, filename });\n        reader.onerror = reject;\n        reader.readAsDataURL(blob);\n      });\n    } catch (e) {\n      console.warn(\"urlToBase64 error:\", e);\n      return { base64: null, filename: this.getFilenameFromUrl(url) };\n    }\n  }\n\n  /**\n   * Get filename from URL\n   * @param {string} url - URL to extract filename from\n   * @returns {string} Filename\n   */\n  static getFilenameFromUrl(url) {\n    try {\n      const urlObj = new URL(url);\n      const pathname = urlObj.pathname;\n      return (\n        pathname.substring(pathname.lastIndexOf(\"/\") + 1) ||\n        `image_${Date.now()}`\n      );\n    } catch {\n      return `image_${Date.now()}`;\n    }\n  }\n\n  /**\n   * Validate and clean page title to prevent font/encoding issues\n   */\n  static validateAndCleanTitle(title) {\n    return (\n      title\n        // Remove control characters and invalid XML characters\n        .replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, \"\")\n        // Fix common encoding issues\n        .replace(/â€™/g, \"'\")\n        .replace(/â€œ/g, '\"')\n        .replace(/â€/g, '\"')\n        .replace(/â€¦/g, \"...\")\n        // Clean up whitespace\n        .replace(/\\s+/g, \" \")\n        .trim() ||\n      // Ensure title is not empty and has reasonable length\n      `Generated Document - ${new Date().toLocaleDateString()}`\n    );\n  }\n\n  /**\n   * Ensure UTF-8 encoding for content\n   */\n  static ensureUtf8Encoding(content) {\n    try {\n      // Try to encode and decode to ensure proper UTF-8\n      const encoder = new TextEncoder();\n      const decoder = new TextDecoder(\"utf-8\", { fatal: false });\n      const encoded = encoder.encode(content);\n      return decoder.decode(encoded);\n    } catch (error) {\n      console.warn(\"UTF-8 encoding issue, using original content:\", error);\n      return content;\n    }\n  }\n\n  /**\n   * Basic content cleanup - EXACT copy from extension/src/api/api.ts\n   */\n  static basicContentCleanup(content) {\n    return (\n      content\n        // Remove code block prefixes\n        .replace(/^```\\w*\\s*/g, \"\")\n        .replace(/```\\s*$/g, \"\")\n        .trim()\n\n        // Enhanced character cleanup for Vietnamese and UTF-8\n        .replace(/^\\uFEFF/, \"\") // Remove BOM\n        .replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, \"\") // Remove control characters\n\n        // Fix common encoding issues\n        .replace(/â€™/g, \"'\") // Smart apostrophe\n        .replace(/â€œ/g, '\"') // Smart quote open\n        .replace(/â€/g, '\"') // Smart quote close\n        .replace(/â€¦/g, \"...\") // Ellipsis\n        .replace(/â€\"/g, \"–\") // En dash\n        .replace(/â€\"/g, \"—\") // Em dash\n\n        // Clean up line breaks and whitespace\n        .replace(/\\r\\n/g, \"\\n\")\n        .replace(/\\r/g, \"\\n\")\n        .replace(/\\n{3,}/g, \"\\n\\n\") // Max 2 consecutive line breaks\n        .replace(/[ \\t]+$/gm, \"\") // Remove trailing whitespace from lines\n        .replace(/^[ \\t]+/gm, \"\") // Remove leading whitespace from lines (but preserve structure)\n        .trim()\n    );\n  }\n\n  /**\n   * Advanced HTML sanitization - EXACT copy from extension/src/api/api.ts\n   */\n  static advancedHTMLSanitization(content) {\n    console.log(\"🔬 Starting advanced HTML sanitization...\");\n\n    // Step 1: Preprocess content to fix obvious issues\n    let processedContent = content\n      // Fix unclosed self-closing tags first\n      .replace(\n        /<(br|hr|img|input|meta|link|area|base|col|embed|source|track|wbr)([^>]*?)(?<!\\/)\\s*>/gi,\n        \"<$1$2/>\"\n      )\n      // Ensure proper quotes around attributes\n      .replace(/(\\w+)=([^\"\\s>]+)(\\s|>)/g, '$1=\"$2\"$3')\n      // Fix common encoding issues before processing\n      .replace(/&(?![a-zA-Z0-9#]+;)/g, \"&amp;\")\n      // Remove any null bytes or control characters\n      .replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, \"\")\n      // Fix common Vietnamese encoding issues\n      .replace(/â€™/g, \"'\")\n      .replace(/â€œ/g, '\"')\n      .replace(/â€/g, '\"');\n\n    // Step 2: Basic structure validation and cleanup\n    let finalHTML = processedContent\n      // Remove empty tags that could cause issues (but keep non-breaking spaces)\n      .replace(/<(\\w+)([^>]*?)>\\s*<\\/\\1>/g, (match, tagName) => {\n        // Keep paragraph and cell tags with nbsp\n        if ([\"p\", \"td\", \"th\", \"li\"].includes(tagName.toLowerCase())) {\n          return `<${tagName}>&nbsp;</${tagName}>`;\n        }\n        return \"\"; // Remove other empty tags\n      })\n      .replace(/>\\s+</g, \"><\") // Remove spaces between tags\n      .replace(/\\s+/g, \" \") // Normalize whitespace\n      .trim();\n\n    console.log(\"✅ Advanced HTML sanitization complete\");\n    console.log(\n      `📊 Original length: ${content.length}, Final length: ${finalHTML.length}`\n    );\n\n    return finalHTML;\n  }\n\n  /**\n   * Convert all macros to mermaid-cloud macros - EXACT copy from extension/src/api/api.ts\n   */\n  static convertToMermaidCloudMacros(content) {\n    console.log(\"🔄 Converting all macros to mermaid-cloud macros...\");\n    let macroCounter = 1;\n    let macroId = 111;\n\n    // Replace all structured macros (mermaid, code, etc.) with mermaid-cloud macros\n    const convertedContent = content.replace(\n      /<ac:structured-macro[^>]*>[\\s\\S]*?<\\/ac:structured-macro>/g,\n      (match) => {\n        const filename = `k-tool-diagram-${macroCounter}`;\n        const currentId = macroId.toString();\n        macroCounter++;\n        macroId++;\n\n        console.log(\n          `🔧 Converting macro ${\n            macroCounter - 1\n          } to mermaid-cloud: ${filename}`\n        );\n\n        return `<ac:structured-macro ac:name=\"mermaid-cloud\" ac:schema-version=\"1\" ac:macro-id=\"${currentId}\">\n<ac:parameter ac:name=\"toolbar\">bottom</ac:parameter>\n<ac:parameter ac:name=\"filename\">${filename}</ac:parameter>\n<ac:parameter ac:name=\"format\">svg</ac:parameter>\n<ac:parameter ac:name=\"zoom\">fit</ac:parameter>\n<ac:parameter ac:name=\"revision\">1</ac:parameter>\n</ac:structured-macro>`;\n      }\n    );\n\n    console.log(`✅ Converted ${macroCounter - 1} macros to mermaid-cloud`);\n    return convertedContent;\n  }\n\n  /**\n   * Validate and fix XML content specifically for Confluence storage format\n   */\n  static validateAndFixXML(content) {\n    let fixed = content;\n\n    console.log(\"🔍 Validating and fixing XML content...\");\n\n    // Fix the specific issue mentioned in error: spaces in tag names\n    fixed = fixed\n      // Remove spaces at the beginning of tag names\n      .replace(/<\\s+([a-zA-Z])/g, \"<$1\")\n      // Remove spaces at the end of tag names (before attributes or closing >)\n      .replace(/([a-zA-Z])\\s+([^>]*>)/g, \"$1 $2\")\n      // Fix spaces in closing tags\n      .replace(/<\\/\\s+([a-zA-Z][^>]*?)>/g, \"</$1>\")\n      // Fix malformed attributes with spaces\n      .replace(/([a-zA-Z-]+)\\s*=\\s*\"([^\"]*)\"/g, '$1=\"$2\"')\n      // Remove multiple consecutive spaces in content\n      .replace(/\\s{2,}/g, \" \")\n      // Fix line breaks that might cause parsing issues\n      .replace(/\\r\\n/g, \"\\n\")\n      .replace(/\\r/g, \"\\n\");\n\n    // Validate specific Confluence storage format requirements\n    fixed = fixed\n      // Ensure proper ac: namespace usage\n      .replace(/<ac:([^>]+)>/g, (match, content) => {\n        return `<ac:${content.trim()}>`;\n      })\n      // Fix structured macro formatting\n      .replace(/<ac:structured-macro\\s+([^>]+)>/g, (match, attrs) => {\n        const cleanAttrs = attrs.trim().replace(/\\s+/g, \" \");\n        return `<ac:structured-macro ${cleanAttrs}>`;\n      })\n      // Ensure CDATA sections are properly formatted\n      .replace(/<!\\[CDATA\\[\\s*([\\s\\S]*?)\\s*\\]\\]>/g, \"<![CDATA[$1]]>\");\n\n    console.log(\"✅ XML validation and fixing complete\");\n    return fixed;\n  }\n\n  /**\n   * Create new Confluence page - EXACT copy logic from createPageFromGeneratedContent\n   * @param {string} title - Page title\n   * @param {string} fullStorageFormat - Page content (storage format)\n   * @param {string} spaceKey - Space key\n   * @param {string} parentPageId - Parent page ID (optional)\n   * @returns {Promise<void>} No return value, same as createPageFromGeneratedContent\n   */\n  static async createPage(\n    title,\n    fullStorageFormat,\n    spaceKey,\n    parentPageId = null\n  ) {\n    try {\n      console.log(\"🔄 Creating page from generated content...\");\n\n      // Step 0: Validate and clean title\n      const cleanTitle = this.validateAndCleanTitle(title);\n      console.log(\"📋 Original title:\", title);\n      console.log(\"📋 Clean title:\", cleanTitle);\n      console.log(\"📋 Space:\", spaceKey);\n      console.log(\"📋 Content length:\", fullStorageFormat.length);\n\n      // Step 0.5: Ensure UTF-8 encoding\n      const utf8Content = this.ensureUtf8Encoding(fullStorageFormat);\n      console.log(\"🔤 UTF-8 validation complete\");\n\n      // Show content preview for debugging\n      console.log(\"📄 Content preview (first 200 chars):\");\n      console.log(utf8Content.substring(0, 200));\n\n      // Step 1: Enhanced content cleanup with Vietnamese support\n      console.log(\"🧹 Starting enhanced content cleanup...\");\n      let processedContent = this.basicContentCleanup(utf8Content);\n\n      // Step 2: Advanced HTML sanitization and validation\n      console.log(\"🔬 Performing advanced HTML sanitization...\");\n      processedContent = this.advancedHTMLSanitization(processedContent);\n\n      // Step 3: Convert all macros to mermaid-cloud macros\n      console.log(\"🔄 Converting macros to mermaid-cloud...\");\n      processedContent = this.convertToMermaidCloudMacros(processedContent);\n\n      const finalContent = processedContent;\n      console.log(\"✅ Content processing complete\");\n      console.log(\"📄 Final content length:\", finalContent.length);\n      console.log(\"📄 Final content preview (first 200 chars):\");\n      console.log(finalContent.substring(0, 200));\n\n      // Create the page payload with clean title\n      const createPayload = {\n        type: \"page\",\n        title: cleanTitle.trim() + \"-\" + Date.now(), // Use clean title with timestamp\n        space: { key: spaceKey },\n        body: {\n          storage: {\n            value: finalContent,\n            representation: \"storage\",\n          },\n        },\n      };\n\n      // Add parent page if specified\n      if (parentPageId) {\n        createPayload.ancestors = [{ id: parentPageId }];\n        console.log(\"📁 Setting parent page ID:\", parentPageId);\n      }\n\n      console.log(\"📤 Sending page creation request...\");\n      const response = await fetch(\"/rest/api/content\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json; charset=utf-8\",\n          Accept: \"application/json\",\n          \"X-Atlassian-Token\": \"no-check\",\n        },\n        body: JSON.stringify(createPayload),\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(\"❌ Page creation failed:\", errorText);\n\n        let errorMessage = `HTTP ${response.status}: ${response.statusText}`;\n\n        try {\n          const errorJson = JSON.parse(errorText);\n          if (errorJson.message) {\n            errorMessage = errorJson.message;\n          }\n\n          if (errorJson.errors && Array.isArray(errorJson.errors)) {\n            const detailedErrors = errorJson.errors\n              .map(\n                (err) =>\n                  `${err.field || \"Unknown field\"}: ${err.message || err}`\n              )\n              .join(\"\\n\");\n            errorMessage += `\\n\\nDetailed errors:\\n${detailedErrors}`;\n          }\n        } catch (parseError) {\n          console.warn(\"Could not parse error response as JSON\");\n          errorMessage += `\\n\\nRaw error: ${errorText}`;\n        }\n\n        throw new Error(errorMessage);\n      }\n\n      const result = await response.json();\n      console.log(\"✅ Page created successfully!\");\n      console.log(\"📄 Page ID:\", result.id);\n      console.log(\"🔗 Page URL:\", result._links?.webui);\n\n      let finalMessage = `✅ Tạo tài liệu thành công!\\n\\nTiêu đề: ${result.title}\\nPage ID: ${result.id}`;\n      const extractedDiagrams = getDiagramConfluenceStyles(fullStorageFormat);\n      console.log(\n        `📊 Extracted ${extractedDiagrams.length} diagrams from content`\n      );\n      // Process and save diagrams after page creation\n      if (extractedDiagrams.length > 0) {\n        console.log(\"🎨 Processing extracted diagrams...\");\n        const diagramResult = await processAndSaveDiagrams(\n          result.id,\n          extractedDiagrams\n        );\n\n        // Add diagram processing result to message\n        if (diagramResult.total > 0) {\n          finalMessage += `\\n\\n📊 Diagrams: ${diagramResult.success}/${diagramResult.total} saved successfully`;\n\n          if (diagramResult.errors.length > 0) {\n            finalMessage += `\\n⚠️ Diagram errors:\\n${diagramResult.errors.join(\n              \"\\n\"\n            )}`;\n          }\n        }\n      }\n\n      // Show final result after everything is complete\n      if (typeof window !== \"undefined\" && window[\"KToolNotificationUtils\"]) {\n        window[\"KToolNotificationUtils\"].success(\n          \"Trang đã được tạo thành công!\",\n          finalMessage.replace(/^✅\\s*/, \"\")\n        );\n      }\n\n      if (result._links?.webui) {\n        const fullUrl = `${window.location.origin}${result._links.webui}`;\n        window.open(fullUrl, \"_blank\");\n      }\n    } catch (error) {\n      console.error(\"❌ Error creating page:\", error);\n\n      let userMessage = \"Lỗi khi tạo trang Confluence.\";\n\n      if (error instanceof Error) {\n        if (error.message.includes(\"validation failed\")) {\n          userMessage = `❌ Nội dung không hợp lệ:\\n\\n${error.message}`;\n        } else if (error.message.includes(\"HTTP 400\")) {\n          userMessage =\n            \"❌ Dữ liệu không hợp lệ. Vui lòng kiểm tra lại nội dung.\";\n        } else if (error.message.includes(\"HTTP 401\")) {\n          userMessage = \"❌ Không có quyền truy cập. Vui lòng đăng nhập lại.\";\n        } else if (error.message.includes(\"HTTP 403\")) {\n          userMessage = \"❌ Không có quyền tạo trang trong space này.\";\n        } else {\n          userMessage = `❌ ${error.message}`;\n        }\n      }\n\n      if (typeof window !== \"undefined\" && window[\"KToolNotificationUtils\"]) {\n        window[\"KToolNotificationUtils\"].error(\n          \"Lỗi tạo trang\",\n          userMessage.replace(/^❌\\s*/, \"\")\n        );\n      }\n      throw error;\n    }\n  }\n}\n","// K-Tool Extension Constants\nexport const EXTENSION_SETTINGS_KEY = \"extensionSettings\";\n\n// API URLs\nconst isLocal =\n  window.location.hostname === \"localhost\" ||\n  window.location.hostname === \"127.0.0.1\" ||\n  window.location.hostname.includes(\"localhost\");\nconst rootUrl = isLocal\n  ? \"http://localhost:5001\"\n  : \"https://gendoc.thangnotes.dev\";\n\n// Confluence API URLs (always localhost:8090 for Confluence)\nconst confluenceBaseUrl = \"http://localhost:8090\";\n\nexport const API_URLS = {\n  GEN_DOC: `${rootUrl}/api/generate-full-confluence-doc`,\n  GEN_DOC_STATUS: `${rootUrl}/api/generate-status`,\n  GEN_DOC_RESULT: `${rootUrl}/api/generate-result`,\n  EDIT_DIAGRAM: `${rootUrl}/api/edit-diagram`,\n  EDIT_MERMAID: `${rootUrl}/api/edit-mermaid`,\n  EDIT_TEXT: `${rootUrl}/api/edit-text`,\n};\n\nexport const CONFLUENCE_API_URLS = {\n  MERMAID_DIAGRAM: `${confluenceBaseUrl}/rest/mermaidrest/1.0/mermaid/diagram`,\n  MERMAID_SAVE: `${confluenceBaseUrl}/rest/mermaidrest/1.0/mermaid/save`,\n  MERMAID_UPDATE: `${confluenceBaseUrl}/rest/mermaidrest/1.0/mermaid`, // /{pageId}\n  MERMAID_EDIT_REFERER: `${confluenceBaseUrl}/plugins/mermaid-cloud/editMermaidDiagram.action`,\n  TINYMCE_PLACEHOLDER: `${confluenceBaseUrl}/rest/tinymce/1/macro/placeholder`,\n};\n\n// Default settings\nexport const DEFAULT_SETTINGS = {\n  apiKey: \"\",\n  urlTemplate: \"\",\n  customPrompt: \"\",\n  documentUrl: \"\",\n  databaseUrl: \"\",\n  instructionUrl: \"\",\n  isEnabled: true,\n  selectedModel: \"sonar-pro\",\n};\n\n// AI Models\nexport const AI_MODELS = {\n  \"sonar-pro\": {\n    name: \"Sonar Pro\",\n    provider: \"Perplexity\",\n    description: \"Perplexity AI Sonar Pro model\",\n  },\n  gemini: {\n    name: \"Gemini 2.0 Flash\",\n    provider: \"Google\",\n    description: \"Google Gemini 2.0 Flash model\",\n  },\n};\n\n// Progress steps for document generation\nexport const PROGRESS_STEPS = [\n  { id: \"fetch\", label: \"Fetch BA Content\", status: \"pending\" },\n  { id: \"clone\", label: \"Clone Template\", status: \"pending\" },\n  { id: \"analyze\", label: \"Analyze Placeholders\", status: \"pending\" },\n  { id: \"generate\", label: \"AI Generate Document\", status: \"pending\" },\n  { id: \"complete\", label: \"Complete\", status: \"pending\" },\n];\n\n// Validation patterns\nexport const VALIDATION = {\n  URL_PATTERN: /^https?:\\/\\/.+/,\n  PLACEHOLDER_PATTERN: /<<([^>]+)>>/g,\n  MIN_PROMPT_LENGTH: 10,\n};\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// K-Tool Extension Content Script\r\nimport { ApiClient, ConfluenceApi } from \"../shared/api.js\";\r\nimport { PROGRESS_STEPS } from \"../shared/constants.js\";\r\nimport { StorageManager } from \"../shared/storage.js\";\r\nimport { ConfluenceEditor } from \"./confluenceEditor.js\";\r\nimport { MermaidAIChat } from \"./mermaidAI/mermaidAIChat.js\";\r\nimport { MermaidRenderer } from \"./utils/mermaidRenderer.js\";\r\n\r\nclass KToolContent {\r\n  constructor() {\r\n    this.settings = {};\r\n    this.isModalOpen = false;\r\n    this.currentTab = \"generate\";\r\n    this.generationJob = null;\r\n    this.progressSteps = [...PROGRESS_STEPS];\r\n    this.confluenceEditor = null;\r\n    this.mermaidAIChat = null;\r\n    this.init();\r\n  }\r\n\r\n  async init() {\r\n    console.log(\"🚀 K-Tool Content Script initializing...\");\r\n\r\n    // Check if already injected\r\n    if (document.getElementById(\"ktool-root\")) {\r\n      console.log(\"🔍 K-Tool already injected, skipping...\");\r\n      return;\r\n    }\r\n\r\n    // Load settings\r\n    await this.loadSettings();\r\n\r\n    // Inject UI\r\n    this.injectUI();\r\n\r\n    // Bind events\r\n    this.bindEvents();\r\n\r\n    // Initialize Confluence Editor\r\n    try {\r\n      console.log(\"🔧 Initializing ConfluenceEditor...\");\r\n      this.confluenceEditor = new ConfluenceEditor();\r\n      console.log(\"✅ ConfluenceEditor initialized:\", this.confluenceEditor);\r\n    } catch (error) {\r\n      console.error(\"❌ Error initializing ConfluenceEditor:\", error);\r\n      this.confluenceEditor = null;\r\n    }\r\n\r\n    // Initialize Mermaid AI Chat\r\n    try {\r\n      console.log(\"🎨 Initializing MermaidAIChat...\");\r\n      const $ = window.jQuery || window.$ || null;\r\n      this.mermaidAIChat = new MermaidAIChat($);\r\n      console.log(\"✅ MermaidAIChat initialized:\", this.mermaidAIChat);\r\n    } catch (error) {\r\n      console.error(\"❌ Error initializing MermaidAIChat:\", error);\r\n      this.mermaidAIChat = null;\r\n    }\r\n\r\n    // Make available globally for debugging\r\n    window.ktoolContent = this;\r\n\r\n    console.log(\"✅ K-Tool Content Script ready\");\r\n  }\r\n\r\n  async loadSettings() {\r\n    try {\r\n      this.settings = await StorageManager.getSettings();\r\n      console.log(\"⚙️ Settings loaded:\", this.settings);\r\n    } catch (error) {\r\n      console.error(\"❌ Error loading settings:\", error);\r\n    }\r\n  }\r\n\r\n  injectUI() {\r\n    // Create root container\r\n    const root = document.createElement(\"div\");\r\n    root.id = \"ktool-root\";\r\n    document.body.appendChild(root);\r\n\r\n    // Create bubble button\r\n    const bubble = this.createBubble();\r\n    root.appendChild(bubble);\r\n\r\n    // Create modal (initially hidden)\r\n    const modal = this.createModal();\r\n    root.appendChild(modal);\r\n  }\r\n\r\n  createBubble() {\r\n    const bubble = document.createElement(\"div\");\r\n    bubble.className = `ktool-bubble ${\r\n      !this.settings.isEnabled ? \"disabled\" : \"\"\r\n    }`;\r\n\r\n    bubble.innerHTML = `\r\n      <div class=\"ktool-bubble-icon\">K</div>\r\n      <div class=\"ktool-tooltip\">\r\n        ${\r\n          this.settings.isEnabled\r\n            ? \"🚀 K-Tool Document Generator<br/>Click to open document generation tool\"\r\n            : \"⚠️ K-Tool is disabled<br/>Please enable in settings\"\r\n        }\r\n      </div>\r\n    `;\r\n\r\n    bubble.addEventListener(\"click\", () => {\r\n      if (this.settings.isEnabled) {\r\n        this.openModal();\r\n      } else {\r\n        this.showNotification(\r\n          \"K-Tool is disabled. Please enable in extension settings.\",\r\n          \"warning\"\r\n        );\r\n      }\r\n    });\r\n\r\n    return bubble;\r\n  }\r\n\r\n  createModal() {\r\n    const overlay = document.createElement(\"div\");\r\n    overlay.className = \"ktool-modal-overlay\";\r\n\r\n    overlay.innerHTML = `\r\n      <div class=\"ktool-modal\">\r\n        <div class=\"ktool-modal-header\">\r\n          <h2 class=\"ktool-modal-title\">K-Tool Document Generator</h2>\r\n          <button class=\"ktool-modal-close\" type=\"button\">&times;</button>\r\n        </div>\r\n        <div class=\"ktool-modal-body\">\r\n          <div class=\"ktool-tabs\">\r\n            <button class=\"ktool-tab active\" data-tab=\"generate\">📄 Generate Document</button>\r\n            <button class=\"ktool-tab\" data-tab=\"preview\">👁️ Preview</button>\r\n            <button class=\"ktool-tab\" data-tab=\"settings\">⚙️ Settings</button>\r\n          </div>\r\n          \r\n          <!-- Generate Tab -->\r\n          <div class=\"ktool-tab-content active\" data-tab=\"generate\">\r\n            ${this.createGenerateTab()}\r\n          </div>\r\n          \r\n          <!-- Preview Tab -->\r\n          <div class=\"ktool-tab-content\" data-tab=\"preview\" id=\"previewTab\">\r\n            ${this.createPreviewTab()}\r\n          </div>\r\n          \r\n          <!-- Settings Tab -->\r\n          <div class=\"ktool-tab-content\" data-tab=\"settings\">\r\n            ${this.createSettingsTab()}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    return overlay;\r\n  }\r\n\r\n  createGenerateTab() {\r\n    return `\r\n      <div class=\"ktool-form\">\r\n        <div class=\"ktool-form-group\">\r\n          <label class=\"ktool-form-label\">BA Document URL *</label>\r\n          <input\r\n            type=\"url\"\r\n            class=\"ktool-form-input\"\r\n            id=\"baDocUrl\"\r\n            placeholder=\"https://confluence.com/pages/123456\"\r\n            value=\"${window.location.href}\"\r\n          >\r\n        </div>\r\n\r\n        <div class=\"ktool-form-group\">\r\n          <label class=\"ktool-form-label\">Additional Notes (Optional)</label>\r\n          <textarea\r\n            class=\"ktool-form-textarea\"\r\n            id=\"additionalNotes\"\r\n            placeholder=\"Add notes or special requirements...\"\r\n            rows=\"3\"\r\n          ></textarea>\r\n        </div>\r\n\r\n        <div style=\"display: flex; gap: 12px; margin-top: 20px;\">\r\n          <button class=\"ktool-btn ktool-btn-primary\" id=\"generateBtn\">\r\n            🔧 Generate Document\r\n          </button>\r\n          <button class=\"ktool-btn ktool-btn-secondary\" id=\"resetBtn\">\r\n            🔄 Reset\r\n          </button>\r\n        </div>\r\n      </div>\r\n      \r\n      <!-- Progress Section -->\r\n      <div class=\"ktool-progress\" id=\"progressSection\" style=\"display: none;\">\r\n        <h3 style=\"margin: 0 0 16px 0; font-size: 16px;\">Document Generation Progress:</h3>\r\n        <div id=\"progressSteps\"></div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  createPreviewTab() {\r\n    return `\r\n      <div class=\"ktool-form\">\r\n        <div style=\"text-align: center; padding: 40px; color: #6c757d;\">\r\n          <div style=\"font-size: 48px; margin-bottom: 16px;\">📄</div>\r\n          <h3 style=\"margin: 0 0 8px 0;\">No content available for preview</h3>\r\n          <p style=\"margin: 0;\">Please generate document first to preview.</p>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  createSettingsTab() {\r\n    return `\r\n      <div class=\"ktool-form\">\r\n        <div style=\"text-align: center; padding: 40px; color: #6c757d;\">\r\n          <div style=\"font-size: 48px; margin-bottom: 16px;\">⚙️</div>\r\n          <h3 style=\"margin: 0 0 8px 0;\">Extension Settings</h3>\r\n          <p style=\"margin: 0 0 16px 0;\">Click the button below to open settings popup.</p>\r\n          <button class=\"ktool-btn ktool-btn-primary\" id=\"openSettingsBtn\">\r\n            🔧 Open Settings\r\n          </button>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  bindEvents() {\r\n    const modal = document.querySelector(\".ktool-modal-overlay\");\r\n\r\n    // Close modal events\r\n    modal.querySelector(\".ktool-modal-close\").addEventListener(\"click\", () => {\r\n      this.closeModal();\r\n    });\r\n\r\n    modal.addEventListener(\"click\", (e) => {\r\n      if (e.target === modal) {\r\n        this.closeModal();\r\n      }\r\n    });\r\n\r\n    // Tab switching\r\n    const tabs = modal.querySelectorAll(\".ktool-tab\");\r\n    tabs.forEach((tab) => {\r\n      tab.addEventListener(\"click\", () => {\r\n        this.switchTab(tab.dataset.tab);\r\n      });\r\n    });\r\n\r\n    // Generate button\r\n    const generateBtn = modal.querySelector(\"#generateBtn\");\r\n    generateBtn.addEventListener(\"click\", () => {\r\n      this.handleGenerate();\r\n    });\r\n\r\n    // Reset button\r\n    const resetBtn = modal.querySelector(\"#resetBtn\");\r\n    resetBtn.addEventListener(\"click\", () => {\r\n      this.handleReset();\r\n    });\r\n\r\n    // Add settings button listener\r\n    this.addSettingsButtonListener();\r\n\r\n    // Listen for settings changes from background\r\n    chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {\r\n      if (request.action === \"settingsChanged\") {\r\n        this.settings = request.settings;\r\n        this.updateBubbleState();\r\n      }\r\n    });\r\n\r\n    // Keyboard shortcuts\r\n    document.addEventListener(\"keydown\", (e) => {\r\n      // Escape to close modal\r\n      if (e.key === \"Escape\" && this.isModalOpen) {\r\n        this.closeModal();\r\n      }\r\n\r\n      // Ctrl/Cmd + K to open modal\r\n      if ((e.ctrlKey || e.metaKey) && e.key === \"k\" && !this.isModalOpen) {\r\n        e.preventDefault();\r\n        if (this.settings.isEnabled) {\r\n          this.openModal();\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  openModal() {\r\n    const modal = document.querySelector(\".ktool-modal-overlay\");\r\n    modal.classList.add(\"show\");\r\n    this.isModalOpen = true;\r\n\r\n    // Focus first input\r\n    setTimeout(() => {\r\n      const firstInput = modal.querySelector(\".ktool-form-input\");\r\n      if (firstInput) firstInput.focus();\r\n    }, 300);\r\n  }\r\n\r\n  closeModal() {\r\n    const modal = document.querySelector(\".ktool-modal-overlay\");\r\n    modal.classList.remove(\"show\");\r\n    this.isModalOpen = false;\r\n  }\r\n\r\n  addSettingsButtonListener() {\r\n    // Add listener for settings button after modal is created\r\n    setTimeout(() => {\r\n      const settingsBtn = document.querySelector(\"#openSettingsBtn\");\r\n      if (settingsBtn) {\r\n        settingsBtn.addEventListener(\"click\", () => {\r\n          this.openSettingsPopup();\r\n        });\r\n      }\r\n    }, 100);\r\n  }\r\n\r\n  openSettingsPopup() {\r\n    // Open extension popup in navbar\r\n    if (chrome.runtime && chrome.runtime.openOptionsPage) {\r\n      chrome.runtime.openOptionsPage();\r\n    } else {\r\n      // Fallback: try to open popup\r\n      chrome.action?.openPopup?.() ||\r\n        chrome.browserAction?.openPopup?.() ||\r\n        alert(\r\n          \"Please click the K-Tool icon in the browser toolbar to open settings.\"\r\n        );\r\n    }\r\n  }\r\n\r\n  switchTab(tabName) {\r\n    // Update tab buttons\r\n    const tabs = document.querySelectorAll(\".ktool-tab\");\r\n    tabs.forEach((tab) => {\r\n      tab.classList.toggle(\"active\", tab.dataset.tab === tabName);\r\n    });\r\n\r\n    // Update tab content\r\n    const contents = document.querySelectorAll(\".ktool-tab-content\");\r\n    contents.forEach((content) => {\r\n      content.classList.toggle(\"active\", content.dataset.tab === tabName);\r\n    });\r\n\r\n    this.currentTab = tabName;\r\n  }\r\n\r\n  updateBubbleState() {\r\n    const bubble = document.querySelector(\".ktool-bubble\");\r\n    const tooltip = bubble.querySelector(\".ktool-tooltip\");\r\n\r\n    if (this.settings.isEnabled) {\r\n      bubble.classList.remove(\"disabled\");\r\n      tooltip.innerHTML =\r\n        \"🚀 K-Tool Document Generator<br/>Click to open document generation tool\";\r\n    } else {\r\n      bubble.classList.add(\"disabled\");\r\n      tooltip.innerHTML = \"⚠️ K-Tool is disabled<br/>Please enable in settings\";\r\n    }\r\n  }\r\n\r\n  async handleGenerate() {\r\n    const baDocUrl = document.getElementById(\"baDocUrl\").value.trim();\r\n    const additionalNotes = document\r\n      .getElementById(\"additionalNotes\")\r\n      .value.trim();\r\n\r\n    if (!baDocUrl) {\r\n      this.showNotification(\"Please enter BA document URL!\", \"error\");\r\n      return;\r\n    }\r\n\r\n    // Validate settings\r\n    const validation = StorageManager.validateSettings(this.settings);\r\n    if (!validation.isValid) {\r\n      this.showNotification(\r\n        \"Please configure all settings before generating document!\",\r\n        \"error\"\r\n      );\r\n      this.switchTab(\"settings\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Show progress\r\n      this.showProgress();\r\n      this.updateProgress(0, \"active\");\r\n\r\n      // Step 1: Extract page ID and fetch BA content\r\n      const pageId = ConfluenceApi.extractPageId(baDocUrl);\r\n      if (!pageId) {\r\n        throw new Error(\r\n          \"❌ Invalid URL! Please check the Confluence page URL.\"\r\n        );\r\n      }\r\n\r\n      console.log(\"🔍 Fetching content for pageId:\", pageId);\r\n      const baDocument = await ConfluenceApi.fetchPageContent(pageId);\r\n      if (!baDocument) {\r\n        throw new Error(\"❌ Cannot fetch BA document content!\");\r\n      }\r\n\r\n      // Extract images from BA content (HTML) and convert all to base64\r\n      const images = await ConfluenceApi.extractImagesFromHtml(\r\n        baDocument.content\r\n      );\r\n      console.log(\"🖼️ Extracted images (all base64):\", images);\r\n\r\n      this.updateProgress(0, \"completed\");\r\n      this.updateProgress(1, \"active\");\r\n\r\n      // Step 2: Clone template structure\r\n      if (!this.settings.urlTemplate) {\r\n        throw new Error(\"⚠️ Please configure document template in settings!\");\r\n      }\r\n\r\n      console.log(\"🔄 Cloning template from:\", this.settings.urlTemplate);\r\n      const clonedTemplate = await ConfluenceApi.cloneTemplateForGeneration(\r\n        this.settings.urlTemplate\r\n      );\r\n\r\n      if (!clonedTemplate) {\r\n        throw new Error(\r\n          \"❌ Cannot clone template! Please check template URL in Settings.\"\r\n        );\r\n      }\r\n\r\n      console.log(\"✅ Template cloned successfully:\", clonedTemplate.title);\r\n      this.updateProgress(1, \"completed\");\r\n      this.updateProgress(2, \"active\");\r\n\r\n      // Step 3: Analyze placeholders with << >>\r\n      const placeholders = ConfluenceApi.extractPlaceholders(\r\n        clonedTemplate.originalStorageFormat\r\n      );\r\n      console.log(\"🔍 Found placeholders <<>>:\", placeholders);\r\n\r\n      if (placeholders.length === 0) {\r\n        throw new Error(\r\n          \"⚠️ No placeholders found in format <<Name>>. Please check template!\"\r\n        );\r\n      }\r\n\r\n      this.updateProgress(2, \"completed\");\r\n      this.updateProgress(3, \"active\");\r\n\r\n      // Get instructions if available\r\n      let instructions = \"\";\r\n      if (this.settings.instructionUrl) {\r\n        const instructionPageId = ConfluenceApi.extractPageId(\r\n          this.settings.instructionUrl\r\n        );\r\n        if (instructionPageId) {\r\n          console.log(\r\n            \"🔍 Fetching instruction content for pageId:\",\r\n            instructionPageId\r\n          );\r\n          const instructionDoc = await ConfluenceApi.fetchPageContent(\r\n            instructionPageId\r\n          );\r\n          instructions = instructionDoc?.content || \"\";\r\n        } else {\r\n          console.warn(\r\n            \"⚠️ Invalid instruction URL:\",\r\n            this.settings.instructionUrl\r\n          );\r\n        }\r\n      }\r\n\r\n      // Step 4: AI Fill Placeholders (Send request and get job_id)\r\n      const payload = {\r\n        ba_content: baDocument.content,\r\n        template_structure: clonedTemplate.templateStructure,\r\n        original_storage_format: clonedTemplate.originalStorageFormat,\r\n        instructions: instructions,\r\n        additional_prompt: this.settings.customPrompt || \"\",\r\n        placeholders: placeholders,\r\n        selectedModel: this.settings.selectedModel,\r\n        images,\r\n        additional_notes: additionalNotes,\r\n      };\r\n\r\n      console.log(\"📤 Sending payload for placeholder filling:\", {\r\n        ba_content_length: payload.ba_content.length,\r\n        template_structure_length: payload.template_structure.length,\r\n        original_format_length: payload.original_storage_format.length,\r\n        placeholders_found: placeholders.length,\r\n        placeholders_list: placeholders,\r\n      });\r\n\r\n      // Send request and get job_id\r\n      const jobResponse = await ApiClient.generateDocument(payload);\r\n      const jobId = jobResponse.data.job_id;\r\n      if (!jobId) {\r\n        throw new Error(jobResponse.error || \"No job_id received from server!\");\r\n      }\r\n\r\n      this.currentJobId = jobId;\r\n\r\n      // Start polling for result\r\n      await this.pollGenerationResult(jobId, payload);\r\n    } catch (error) {\r\n      console.error(\"❌ Generation error:\", error);\r\n      this.showNotification(\r\n        `Document generation error: ${error.message}`,\r\n        \"error\"\r\n      );\r\n      this.hideProgress();\r\n    }\r\n  }\r\n\r\n  // These methods are now handled by ConfluenceApi class\r\n  // Keeping them for backward compatibility if needed\r\n\r\n  async pollGenerationResult(jobId, payload) {\r\n    const maxAttempts = 20; // 10 minutes max (60 * 10 seconds)\r\n    let attempts = 0;\r\n\r\n    const poll = async () => {\r\n      attempts++;\r\n\r\n      try {\r\n        console.log(\r\n          `🔄 Polling attempt ${attempts}/${maxAttempts} for job ${jobId}`\r\n        );\r\n\r\n        const statusResult = await ApiClient.checkStatus(jobId);\r\n        console.log(`statusResult: ${statusResult}`);\r\n\r\n        if (!statusResult.success) {\r\n          throw new Error(\"Error checking job status\");\r\n        }\r\n\r\n        const status = statusResult.data.status;\r\n\r\n        if (status === \"done\") {\r\n          console.log(\"✅ Generation completed!\");\r\n\r\n          const result = await ApiClient.getResult(jobId);\r\n          const resultString = JSON.stringify(result, null, 2);\r\n\r\n          console.log(`Document generate:\\n${resultString}`);\r\n          if (result.success) {\r\n            this.handleGenerationComplete(result.data.result);\r\n            return;\r\n          } else {\r\n            throw new Error(\"Error getting document generation result\");\r\n          }\r\n        } else if (status === \"error\") {\r\n          throw new Error(\"Document generation job failed on server\");\r\n        } else if (attempts >= maxAttempts) {\r\n          throw new Error(\r\n            \"⏰ Timeout: Document generation is taking too long. Please try again.\"\r\n          );\r\n        } else {\r\n          // Update progress message if available\r\n          if (statusResult.data.progress_message) {\r\n            console.log(`📝 Progress: ${statusResult.data.progress_message}`);\r\n          }\r\n\r\n          // Continue polling\r\n          setTimeout(poll, 10000); // Poll every 10 seconds\r\n        }\r\n      } catch (error) {\r\n        console.error(\"❌ Polling error:\", error);\r\n        this.showNotification(\r\n          `Error during document generation: ${error.message}`,\r\n          \"error\"\r\n        );\r\n        this.hideProgress();\r\n        this.currentJobId = null;\r\n        throw error;\r\n      }\r\n    };\r\n\r\n    await poll();\r\n  }\r\n\r\n  handleGenerationComplete(result) {\r\n    this.updateProgress(3, \"completed\");\r\n    this.updateProgress(4, \"completed\");\r\n\r\n    // Store result for preview\r\n    this.generatedContent = result;\r\n    console.log(\"✅ Generated content:\", result);\r\n    // Switch to preview tab\r\n    this.switchTab(\"preview\");\r\n    this.updatePreviewTab(result);\r\n\r\n    this.showNotification(\"Document generated successfully!\", \"success\");\r\n    this.hideProgress();\r\n  }\r\n\r\n  updatePreviewTab(content) {\r\n    const previewTab = document.getElementById(\"previewTab\");\r\n    previewTab.innerHTML = `\r\n      <div class=\"ktool-form\">\r\n        <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;\">\r\n          <h3 style=\"margin: 0;\">Document Preview</h3>\r\n          <div style=\"display: flex; gap: 12px;\">\r\n            <button class=\"ktool-btn ktool-btn-secondary\" id=\"editContentBtn\">\r\n              ✏️ Edit Content\r\n            </button>\r\n            <button class=\"ktool-btn ktool-btn-primary\" id=\"createPageBtn\">\r\n              📄 Create Confluence Page\r\n            </button>\r\n            <button class=\"ktool-btn ktool-btn-secondary\" id=\"downloadBtn\">\r\n              💾 Download\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        <div id=\"documentPreview\" style=\"border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; background: #f8f9fa; max-height: 400px; overflow-y: auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6;\">\r\n          ${content.full_storage_format || \"<p>No content available</p>\"}\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    // Bind preview buttons\r\n    const editContentBtn = previewTab.querySelector(\"#editContentBtn\");\r\n    const createPageBtn = previewTab.querySelector(\"#createPageBtn\");\r\n    const downloadBtn = previewTab.querySelector(\"#downloadBtn\");\r\n\r\n    editContentBtn.addEventListener(\"click\", () =>\r\n      this.handleEditContent(content)\r\n    );\r\n    createPageBtn.addEventListener(\"click\", () => this.handleCreatePage());\r\n    downloadBtn.addEventListener(\"click\", () => this.handleDownload());\r\n\r\n    // Initialize Mermaid diagrams after content is loaded\r\n    setTimeout(() => {\r\n      this.initializeMermaid();\r\n    }, 100);\r\n  }\r\n\r\n  async handleCreatePage() {\r\n    const createBtn = document.querySelector(\"#createPageBtn\");\r\n    if (!createBtn) return;\r\n\r\n    // Save original button state\r\n    const originalText = createBtn.innerHTML;\r\n    const originalDisabled = createBtn.disabled;\r\n\r\n    try {\r\n      // Set loading state\r\n      createBtn.innerHTML = \"⏳ Creating Page...\";\r\n      createBtn.disabled = true;\r\n      createBtn.style.opacity = \"0.7\";\r\n\r\n      const spaceKey = ConfluenceApi.getCurrentSpaceKey();\r\n      if (!spaceKey) {\r\n        throw new Error(\"Cannot determine space key of current page\");\r\n      }\r\n\r\n      const title = `K-Tool Generated Document - ${new Date().toLocaleDateString()}`;\r\n      const content =\r\n        this.generatedContent.full_storage_format ||\r\n        this.generatedContent.content;\r\n\r\n      // Extract parent page ID from settings if available\r\n      let parentId = null;\r\n      if (this.settings.documentUrl) {\r\n        parentId = ConfluenceApi.extractPageId(this.settings.documentUrl);\r\n      }\r\n\r\n      await ConfluenceApi.createPage(title, content, spaceKey, parentId);\r\n\r\n      // Success state\r\n      createBtn.innerHTML = \"✅ Page Created Successfully!\";\r\n      createBtn.style.background = \"#28a745\";\r\n\r\n      this.showNotification(\"Confluence page created successfully!\", \"success\");\r\n\r\n      // Delay 1s before restore button\r\n      setTimeout(() => {\r\n        // Restore button state\r\n        createBtn.innerHTML = originalText;\r\n        createBtn.disabled = originalDisabled;\r\n        createBtn.style.opacity = \"1\";\r\n        createBtn.style.background = \"\";\r\n      }, 1000);\r\n    } catch (error) {\r\n      console.error(\"❌ Create page error:\", error);\r\n\r\n      // Error state\r\n      createBtn.innerHTML = \"❌ Creation Failed\";\r\n      createBtn.style.background = \"#dc3545\";\r\n\r\n      this.showNotification(`Error creating page: ${error.message}`, \"error\");\r\n\r\n      // Restore button after 2s\r\n      setTimeout(() => {\r\n        createBtn.innerHTML = originalText;\r\n        createBtn.disabled = originalDisabled;\r\n        createBtn.style.opacity = \"1\";\r\n        createBtn.style.background = \"\";\r\n      }, 2000);\r\n    }\r\n  }\r\n\r\n  handleDownload() {\r\n    if (!this.generatedContent) {\r\n      this.showNotification(\"No content available to download!\", \"error\");\r\n      return;\r\n    }\r\n\r\n    const downloadBtn = document.querySelector(\"#downloadBtn\");\r\n    if (!downloadBtn) return;\r\n\r\n    // Save original button state\r\n    const originalText = downloadBtn.innerHTML;\r\n    const originalDisabled = downloadBtn.disabled;\r\n\r\n    try {\r\n      // Set loading state\r\n      downloadBtn.innerHTML = \"⏳ Preparing Download...\";\r\n      downloadBtn.disabled = true;\r\n      downloadBtn.style.opacity = \"0.7\";\r\n\r\n      const content =\r\n        this.generatedContent.full_storage_format ||\r\n        this.generatedContent.content;\r\n\r\n      // Create filename with title if available\r\n      const title = this.generatedContent.title || \"K-Tool Generated Document\";\r\n      const sanitizedTitle = title.replace(/[^a-z0-9]/gi, \"_\").toLowerCase();\r\n      const timestamp = new Date()\r\n        .toISOString()\r\n        .slice(0, 19)\r\n        .replace(/:/g, \"-\");\r\n      const filename = `${sanitizedTitle}_${timestamp}.html`;\r\n\r\n      const blob = new Blob([content], { type: \"text/html;charset=utf-8\" });\r\n      const url = URL.createObjectURL(blob);\r\n\r\n      const a = document.createElement(\"a\");\r\n      a.href = url;\r\n      a.download = filename;\r\n      a.style.display = \"none\";\r\n      document.body.appendChild(a);\r\n      a.click();\r\n      document.body.removeChild(a);\r\n      URL.revokeObjectURL(url);\r\n\r\n      // Success state\r\n      downloadBtn.innerHTML = \"✅ Downloaded Successfully!\";\r\n      downloadBtn.style.background = \"#28a745\";\r\n\r\n      this.showNotification(\"Document downloaded successfully!\", \"success\");\r\n\r\n      // Restore button after 1s\r\n      setTimeout(() => {\r\n        downloadBtn.innerHTML = originalText;\r\n        downloadBtn.disabled = originalDisabled;\r\n        downloadBtn.style.opacity = \"1\";\r\n        downloadBtn.style.background = \"\";\r\n      }, 1000);\r\n    } catch (error) {\r\n      console.error(\"❌ Download error:\", error);\r\n\r\n      // Error state\r\n      downloadBtn.innerHTML = \"❌ Download Failed\";\r\n      downloadBtn.style.background = \"#dc3545\";\r\n\r\n      this.showNotification(`Download failed: ${error.message}`, \"error\");\r\n\r\n      // Restore button after 2s\r\n      setTimeout(() => {\r\n        downloadBtn.innerHTML = originalText;\r\n        downloadBtn.disabled = originalDisabled;\r\n        downloadBtn.style.opacity = \"1\";\r\n        downloadBtn.style.background = \"\";\r\n      }, 2000);\r\n    }\r\n  }\r\n\r\n  handleEditContent(content) {\r\n    console.log(\"✏️ Opening content editor...\");\r\n    console.log(\"🔍 Content to edit:\", content);\r\n    console.log(\"🔍 ConfluenceEditor instance:\", this.confluenceEditor);\r\n\r\n    if (!this.confluenceEditor) {\r\n      console.error(\"❌ ConfluenceEditor is null or undefined\");\r\n      this.showNotification(\"Confluence Editor not initialized!\", \"error\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Set up save callback to update the generated content\r\n      this.confluenceEditor.setSaveCallback((updatedContent) => {\r\n        console.log(\"💾 Content updated:\", updatedContent);\r\n\r\n        // Update the stored generated content\r\n        this.generatedContent = updatedContent;\r\n\r\n        // Refresh the preview tab with updated content\r\n        this.updatePreviewTab(updatedContent);\r\n\r\n        this.showNotification(\"Content has been updated!\", \"success\");\r\n      });\r\n\r\n      // Open the editor with current content\r\n      console.log(\"🚀 Opening ConfluenceEditor...\");\r\n      this.confluenceEditor.openEditor(content, {\r\n        title: \"Edit Generated Document\",\r\n        showMermaidTools: true,\r\n      });\r\n      console.log(\"✅ ConfluenceEditor opened successfully\");\r\n    } catch (error) {\r\n      console.error(\"❌ Error opening ConfluenceEditor:\", error);\r\n      this.showNotification(`Error opening editor: ${error.message}`, \"error\");\r\n    }\r\n  }\r\n\r\n  handleReset() {\r\n    // Auto reset form without confirm\r\n    console.log(\"🔄 Auto-resetting form...\");\r\n    document.getElementById(\"baDocUrl\").value = window.location.href;\r\n    document.getElementById(\"additionalNotes\").value = \"\";\r\n    this.hideProgress();\r\n    this.switchTab(\"generate\");\r\n  }\r\n\r\n  showProgress() {\r\n    const progressSection = document.getElementById(\"progressSection\");\r\n    const progressSteps = document.getElementById(\"progressSteps\");\r\n\r\n    progressSteps.innerHTML = this.progressSteps\r\n      .map(\r\n        (step, index) => `\r\n      <div class=\"ktool-progress-step ${step.status}\" data-step=\"${index}\">\r\n        <div class=\"ktool-progress-icon\">${index + 1}</div>\r\n        <span>${step.label}</span>\r\n      </div>\r\n    `\r\n      )\r\n      .join(\"\");\r\n\r\n    progressSection.style.display = \"block\";\r\n  }\r\n\r\n  hideProgress() {\r\n    const progressSection = document.getElementById(\"progressSection\");\r\n    progressSection.style.display = \"none\";\r\n\r\n    // Reset progress steps\r\n    this.progressSteps = this.progressSteps.map((step) => ({\r\n      ...step,\r\n      status: \"pending\",\r\n    }));\r\n  }\r\n\r\n  updateProgress(stepIndex, status) {\r\n    this.progressSteps[stepIndex].status = status;\r\n\r\n    const stepElement = document.querySelector(`[data-step=\"${stepIndex}\"]`);\r\n    if (stepElement) {\r\n      stepElement.className = `ktool-progress-step ${status}`;\r\n\r\n      const icon = stepElement.querySelector(\".ktool-progress-icon\");\r\n      if (status === \"completed\") {\r\n        icon.textContent = \"✓\";\r\n      } else if (status === \"error\") {\r\n        icon.textContent = \"✗\";\r\n      } else if (status === \"active\") {\r\n        icon.innerHTML = '<div class=\"ktool-spinning\">⏳</div>';\r\n      }\r\n    }\r\n  }\r\n\r\n  showNotification(message, type = \"info\") {\r\n    // Create notification element\r\n    const notification = document.createElement(\"div\");\r\n    notification.style.cssText = `\r\n      position: fixed;\r\n      top: 20px;\r\n      right: 20px;\r\n      background: ${\r\n        type === \"success\"\r\n          ? \"#28a745\"\r\n          : type === \"error\"\r\n          ? \"#dc3545\"\r\n          : \"#007bff\"\r\n      };\r\n      color: white;\r\n      padding: 12px 20px;\r\n      border-radius: 8px;\r\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);\r\n      z-index: 1000002;\r\n      font-size: 14px;\r\n      max-width: 300px;\r\n      word-wrap: break-word;\r\n      opacity: 0;\r\n      transform: translateX(100%);\r\n      transition: all 0.3s;\r\n    `;\r\n\r\n    notification.textContent = message;\r\n    document.body.appendChild(notification);\r\n\r\n    // Animate in\r\n    setTimeout(() => {\r\n      notification.style.opacity = \"1\";\r\n      notification.style.transform = \"translateX(0)\";\r\n    }, 100);\r\n\r\n    // Auto remove\r\n    setTimeout(() => {\r\n      notification.style.opacity = \"0\";\r\n      notification.style.transform = \"translateX(100%)\";\r\n      setTimeout(() => {\r\n        if (notification.parentNode) {\r\n          notification.parentNode.removeChild(notification);\r\n        }\r\n      }, 300);\r\n    }, 5000);\r\n  }\r\n\r\n  async loadMermaidScript() {\r\n    if (window.mermaid) {\r\n      console.log(\"⚡ Mermaid already loaded\");\r\n      return window.mermaid;\r\n    }\r\n\r\n    const res = await fetch(chrome.runtime.getURL(\"lib/mermaid.min.js\"));\r\n    const text = await res.text();\r\n    eval(text); // UMD will attach mermaid to window\r\n    console.log(\"✅ Mermaid loaded dynamically\");\r\n    return window.mermaid;\r\n  }\r\n\r\n  // Initialize Mermaid diagrams\r\n  async initializeMermaid() {\r\n    try {\r\n      console.log(\"🎨 Initializing Mermaid diagrams...\");\r\n\r\n      // Find all mermaid code blocks in the preview\r\n      const previewDiv = document.getElementById(\"documentPreview\");\r\n      if (!previewDiv) return;\r\n\r\n      // Look for Confluence Mermaid structured macros\r\n      const mermaidElements = previewDiv.querySelectorAll(\r\n        'ac\\\\:structured-macro[ac\\\\:name=\"mermaid\"]'\r\n      );\r\n\r\n      for (let index = 0; index < mermaidElements.length; index++) {\r\n        const element = mermaidElements[index];\r\n        // Get the code parameter from Confluence structured macro\r\n        const codeParam = element.querySelector(\r\n          'ac\\\\:parameter[ac\\\\:name=\"code\"]'\r\n        );\r\n        if (!codeParam) {\r\n          console.warn(\"⚠️ Mermaid macro found but no code parameter\");\r\n          return;\r\n        }\r\n\r\n        const mermaidCode = (\r\n          codeParam.textContent || codeParam.innerText\r\n        ).trim();\r\n        console.log(\r\n          \"🔍 Found Confluence Mermaid diagram:\",\r\n          mermaidCode.substring(0, 50) + \"...\"\r\n        );\r\n\r\n        // Always process Confluence mermaid macros (no need to check syntax)\r\n        if (mermaidCode) {\r\n          // Create a new div for the mermaid diagram\r\n          const mermaidDiv = document.createElement(\"div\");\r\n          mermaidDiv.className = \"mermaid-diagram\";\r\n          mermaidDiv.id = `mermaid-${index}`;\r\n          mermaidDiv.style.cssText =\r\n            \"margin: 20px 0; text-align: center; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;\";\r\n\r\n          // Validate parent node before replacing\r\n          if (!element.parentNode) {\r\n            console.error(\"❌ Cannot replace Mermaid element: no parent node\");\r\n            console.error(\r\n              \"❌ Mermaid code:\",\r\n              mermaidCode.substring(0, 100) + \"...\"\r\n            );\r\n            return;\r\n          }\r\n\r\n          // Replace the original element\r\n          try {\r\n            element.parentNode.replaceChild(mermaidDiv, element);\r\n          } catch (replaceError) {\r\n            console.error(\r\n              \"❌ Failed to replace Mermaid element:\",\r\n              replaceError\r\n            );\r\n            console.error(\r\n              \"❌ Mermaid code:\",\r\n              mermaidCode.substring(0, 100) + \"...\"\r\n            );\r\n            return;\r\n          }\r\n\r\n          // Initialize Mermaid and render the diagram using MermaidRenderer\r\n          await MermaidRenderer.initializeMermaid();\r\n          const diagramId = `mermaid-svg-${index}`;\r\n          await MermaidRenderer.renderDiagram(\r\n            diagramId,\r\n            mermaidCode,\r\n            mermaidDiv\r\n          );\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"❌ Failed to initialize Mermaid:\", error);\r\n    }\r\n  }\r\n\r\n  // Show Mermaid error in a nice format\r\n  showMermaidError(container, text, error) {\r\n    // Validate container before attempting to set innerHTML\r\n    if (\r\n      !container ||\r\n      !container.nodeType ||\r\n      container.nodeType !== Node.ELEMENT_NODE\r\n    ) {\r\n      console.error(\r\n        \"❌ Invalid container for Mermaid error display:\",\r\n        container\r\n      );\r\n      console.error(\"❌ Mermaid error details:\", {\r\n        message: error.message || \"Unknown error occurred\",\r\n        code: text ? text.substring(0, 100) + \"...\" : \"No code provided\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Check if container is still in the DOM\r\n    if (!document.contains(container)) {\r\n      console.error(\"❌ Container is not in DOM, cannot display Mermaid error\");\r\n      console.error(\"❌ Mermaid error details:\", {\r\n        message: error.message || \"Unknown error occurred\",\r\n        code: text ? text.substring(0, 100) + \"...\" : \"No code provided\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    try {\r\n      container.innerHTML = `\r\n        <div style=\"color: #dc3545; padding: 15px; background: #f8d7da; border-radius: 8px; border: 1px solid #f5c6cb; font-family: Arial, sans-serif;\">\r\n          <div style=\"font-weight: bold; margin-bottom: 8px; display: flex; align-items: center;\">\r\n            <span style=\"margin-right: 8px;\">⚠️</span>\r\n            Mermaid Render Error\r\n          </div>\r\n          <div style=\"font-size: 12px; color: #721c24; margin-bottom: 10px;\">\r\n            ${error.message || \"Unknown error occurred\"}\r\n          </div>\r\n          <details style=\"margin-top: 10px;\">\r\n            <summary style=\"cursor: pointer; font-size: 12px; color: #495057;\">Show diagram code</summary>\r\n            <pre style=\"margin: 8px 0 0 0; padding: 8px; background: #fff; border: 1px solid #dee2e6; border-radius: 4px; font-size: 11px; overflow-x: auto; white-space: pre-wrap;\">${\r\n              text || \"No code provided\"\r\n            }</pre>\r\n          </details>\r\n        </div>\r\n      `;\r\n    } catch (setInnerHTMLError) {\r\n      console.error(\r\n        \"❌ Failed to set error HTML in container:\",\r\n        setInnerHTMLError\r\n      );\r\n      console.error(\"❌ Original Mermaid error:\", {\r\n        message: error.message || \"Unknown error occurred\",\r\n        code: text ? text.substring(0, 100) + \"...\" : \"No code provided\",\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\n// Initialize when DOM is ready\r\nif (document.readyState === \"loading\") {\r\n  document.addEventListener(\"DOMContentLoaded\", () => {\r\n    new KToolContent();\r\n  });\r\n} else {\r\n  new KToolContent();\r\n}\r\n"],"names":["XMLFormatter","formatXHTML","xmlString","indent","rootTag","wrappedXml","doc","DOMParser","parseFromString","parseErrors","getElementsByTagName","_parseErrors$","length","console","warn","error","textContent","originalLength","sample","substring","output","rootElement","documentElement","processNode","node","level","nodeType","Node","ELEMENT_NODE","nodeName","startTag","attributes","attr","name","value","Array","from","childNodes","some","child","TEXT_NODE","trim","nextLevel","forEach","replace","text","COMMENT_NODE","CDATA_SECTION_NODE","isSelfClosingTag","tag","t","startsWith","cleanXMLMarkers","content","cleaned","escapeRegex","string","ContentSynchronizer","constructor","this","diagramChanges","Map","trackDiagramChange","diagramId","newCode","log","set","code","timestamp","Date","now","getTrackedChanges","clearTrackedChanges","clear","syncAllContent","currentContent","editorContainer","mermaidDiagrams","Error","rawContent","syncFromRawEditor","finalContent","syncMermaidChanges","rawEditor","querySelector","updatedContent","full_storage_format","undefined","diagramsCount","hasContent","diagram","index","_diagram$originalCode","_diagram$code","id","hasOriginalCode","originalCode","hasCode","codeLength","updateDiagramInContent","hasNewCode","newLength","patterns","pattern","RegExp","replacement","patternMatched","i","lastIndex","test","simpleSearch","includes","validateContent","result","isValid","errors","warnings","push","xmlContent","message","createBackup","JSON","parse","stringify","restoreFromBackup","backup","DOMHelpers","container","selector","querySelectorAll","addEventListener","element","event","handler","options","removeEventListener","toggleClass","className","force","classList","toggle","addClass","add","removeClass","remove","setContent","isHTML","tagName","innerHTML","getContent","createElement","document","Object","entries","key","assign","style","setAttribute","removeElement","parentNode","removeChild","isInDOM","body","contains","scrollIntoView","behavior","block","getDimensions","width","height","top","left","rect","getBoundingClientRect","right","bottom","cloneElement","deep","cloneNode","HTMLTemplates","getEditorTemplate","getContentTabTemplate","getMermaidTabTemplate","getZoomControlsTemplate","getAIChatTemplate","applyPreviewStyles","createAIMessage","type","createMermaidContainer","mermaidDiv","cssText","StorageManager","STORAGE_KEY","AUTO_SAVE_INTERVAL","autoSaveTimer","saveContent","saveCallback","enableLocalStorage","enableCallback","showNotification","results","localStorage","callback","saveToLocalStorage","callSaveCallback","showSaveNotification","backupData","version","setItem","loadFromLocalStorage","saved","getItem","removeItem","clearLocalStorage","then","method","notification","colors","success","warning","info","background","appendChild","setTimeout","opacity","transform","startAutoSave","saveFunction","stopAutoSave","setInterval","clearInterval","hasUnsavedChanges","getBackupInfo","age","ConfluenceEditor","isEditorOpen","originalContent","onSave","mermaidDiagramsMap","currentSelectedDiagram","currentSelectedDiagramId","textEditor","previewContainer","isPreviewMode","isModified","currentZoom","dragOffset","x","y","isZooming","zoomStep","minZoom","maxZoom","previewUpdateTimeout","isUpdatingPreview","storageManager","contentSynchronizer","openEditor","closeEditor","allowBackupRestore","backupInfo","ageMinutes","Math","floor","extractMermaidDiagrams","createEditorUI","initializeContentTab","overlay","bindEditorEvents","closeBtn","saveBtn","saveChanges","contentTab","mermaidTab","switchTab","updateContentPreview","mermaidSelector","mermaidCodeEditor","aiSendBtn","aiPromptInput","e","selectMermaidDiagram","target","debouncedUpdateMermaidPreview","sendAIPrompt","shiftKey","preventDefault","zoomInBtn","zoomOutBtn","zoomResetBtn","zoomIn","zoomOut","resetZoom","mermaidPreview","handleWheel","handleEsc","tabName","tab","activeTab","activeContent","initializeMermaidTab","size","populateMermaidSelector","preview","updateSaveButtonState","renderContentPreview","previewElement","processedContent","renderMermaidDiagramsInPreview","initializeMermaidInPreview","MermaidRenderer","initializeMermaid","previewDiv","async","codeParam","mermaidCode","replaceChild","replaceError","renderDiagram","_this$mermaidDiagrams","_this$mermaidDiagrams2","defaultOption","addedCount","addedDiagrams","Set","diagramData","has","option","title","handleMermaidSelectorChange","selectedId","clearMermaidEditor","get","find","d","codeEditor","updateMermaidPreview","catch","handleMermaidCodeChange","clearTimeout","updateZoom","_this$currentSelected","promptInput","messagesContainer","prompt","addAIMessage","diagramInMap","currentCode","_this$currentContent","settings","ChromeStorageManager","getSettings","requestBody","diagram_code","user_request","selectedModel","response","fetch","API_URLS","EDIT_DIAGRAM","headers","ok","errorData","json","status","statusText","data","edited_diagram","cleanedDiagram","cleanAIResponse","_this$currentSelected2","currentDiagramInMap","oldCode","removeLastAIMessage","window","lines","split","nonEmptyStart","findIndex","line","nonEmptyEnd","slice","reverse","join","validStarts","firstLine","toLowerCase","start","messages","lastMessage","messageHTML","scrollTop","scrollHeight","_this$currentContent2","diagrams","diagramsMap","updateStatus","_this$editorContainer","validation","saveResults","stopAllPreviewUpdates","min","applyZoom","max","zoomLevel","mermaidContent","transformOrigin","transition","round","deltaY","setSaveCallback","isOpen","getCurrentContent","editorContent","getValue","MermaidPreview","initialize","getElementById","updatePreview","cleanCode","cleanMermaidCode","validateMermaidCode","showError","showPlaceholder","errorMessage","trimmed","validStarters","starter","match","MermaidAIService","apiClient","ApiClient","modifyDiagram","diagramContent","userPrompt","promptValidation","validateUserPrompt","diagramValidation","validateDiagramContent","payload","EDIT_MERMAID","errorText","newMermaidCode","callAI","getMockResponse","originalDiagram","diagram_content","user_prompt","explanation","getErrorMessage","MermaidApiClient","extractPageId","location","href","pathname","search","pageId","URLSearchParams","pathMatches","metaSelectors","metaTag","AJS","params","Confluence","getContentId","contentId","bodyPageId","getAttribute","extractFilename","src","pathParts","URL","origin","filenameWithExt","filename","saveFilename","getSavedFilename","fetchMermaidCode","apiUrl","CONFLUENCE_API_URLS","MERMAID_DIAGRAM","Accept","Connection","Pragma","Referer","MERMAID_EDIT_REFERER","navigator","userAgent","credentials","fetchMermaidCodeFromSaved","MermaidAIChat","$","jQuery","isPopupOpen","currentMermaidContent","aiService","lastClickedElement","lastClickPosition","init","createPopupUI","setupMermaidDetection","setupConfluencePageChangeDetection","setupConfluenceEditorMonitoring","handleMermaidClick","position","showChatPopup","setupIframeEventListeners","setupMutationObserver","refreshIframeListeners","iframes","readyState","retryIframes","iframe","attachIframeListeners","dataset","mermaidListenerAttached","loadHandler","iframeDoc","contentDocument","contentWindow","clickHandler","classes","alt","isMermaidElement","macroParams","diagramInfo","macroParameters","parseMacroParameters","parsedParams","clientX","offsetLeft","clientY","offsetTop","mermaidClickHandler","boundClickHandler","bind","mermaidLoadHandler","MutationObserver","mutations","mutation","mutationIndex","addedNodes","nodeIndex","_node$textContent","injectAIButton","_node$textContent2","observe","childList","subtree","currentUrl","checkUrlChange","panel","buttonContainer","aiButton","marginRight","loadingMessage","alert","removeButton","insertBefore","removeAIButton","removedNodes","pair","check","bindZoomControls","ctrlKey","zoomDisplay","updateZoomButtonStates","disabled","root","bindPopupEvents","popup","header","sendBtn","input","makeDraggable","hideChatPopup","sendMessage","saveDiagram","closest","dragHandle","isDragging","dragStartX","dragStartY","popupStartX","popupStartY","cursor","userSelect","onDrag","stopPropagation","deltaX","newX","newY","maxX","innerWidth","maxY","innerHeight","stopDrag","parseInt","mouseX","mouseY","popupX","popupY","leftPos","topPos","display","focus","systemMessage","_diagramInfo$parsedPa","diagramInfoStr","updateData","updateMermaidDiagram","reversionNew","revision","newImageHtml","generatePlaceholderImage","replaceImageInDOM","svg","png","generateMermaidAssets","currentRevision","dataLength","svgLength","pngLength","MERMAID_UPDATE","mermaid","script","head","Promise","resolve","reject","onload","onerror","mermaidAPI","startOnLoad","render","pngDataUrl","convertSvgToPngDataUrl","pngBase64","encodeSvg","btoa","TextEncoder","encode","reduce","byte","String","fromCharCode","svgString","scale","svgUrl","canvas","ctx","getContext","img","Image","originalWidth","originalHeight","fillStyle","fillRect","drawImage","toDataURL","err","svgToPng","svgBlob","Blob","url","createObjectURL","saveMermaidCode","MERMAID_SAVE","macroData","macro","zoom","toolbar","format","TINYMCE_PLACEHOLDER","tempDiv","newImg","foundImages","findImagesByFilename","oldImg","replaceImageAttributes","newAttributes","attributesToKeep","oldAttributes","removeAttribute","old","map","a","new","addMessage","messageId","messageDiv","removeMessage","chrome","storage","sync","EXTENSION_SETTINGS_KEY","DEFAULT_SETTINGS","saveSettings","updateSetting","field","updatedSettings","resetSettings","validateSettings","_settings$apiKey","_settings$urlTemplate","_settings$documentUrl","_settings$databaseUrl","apiKey","urlTemplate","validationResult","validateConfluencePageLink","valid","documentUrl","isValidUrl","databaseUrl","keys","link","out","u","pageIdParam","searchParams","pagesIndex","indexOf","candidate","loadMermaidScript","res","runtime","getURL","eval","theme","securityLevel","fontFamily","htmlLabels","flowchart","deterministicIds","deterministicIDSeed","setConfig","tempContainer","visibility","svgCode","renderResult","renderError","showMermaidError","setInnerHTMLError","detectMermaidType","macroRegex","exec","macroName","macroContent","codeMatch","langMatch","diagramRecord","originalMatch","charAt","toUpperCase","saveDiagramToAPI","diagramCode","request","generateDocument","GEN_DOC","checkStatus","jobId","GEN_DOC_STATUS","getResult","GEN_DOC_RESULT","editText","EDIT_TEXT","ConfluenceApi","getCurrentSpaceKey","spaceKeyMeta","spaceKeyElement","spaceKey","urlMatch","fetchPageContent","_data$body","_data$body2","_data$body3","_data$body4","hasStorage","hasView","view","storageFormat","cloneTemplateForGeneration","_data$body5","_data$body6","extractPageIdFromUrl","originalStorageFormat","templateStructure","analysisInfo","extractTemplateStructure","structureLength","analysis","emptyParagraphs","emptyTableCells","placeholders","structure","regex","matches","matchAll","totalLength","extractPlaceholders","decodedContent","allMatches","testContent","contentIndex","patternIndex","m","uniquePlaceholders","extractImagesFromHtml","html","images","imgTags","base64src","base64","fname","urlToBase64","getFilenameFromUrl","blob","reader","FileReader","onloadend","readAsDataURL","lastIndexOf","validateAndCleanTitle","toLocaleDateString","ensureUtf8Encoding","encoder","decoder","TextDecoder","fatal","encoded","decode","basicContentCleanup","advancedHTMLSanitization","finalHTML","convertToMermaidCloudMacros","macroCounter","macroId","convertedContent","currentId","toString","validateAndFixXML","fixed","attrs","createPage","fullStorageFormat","parentPageId","_result$_links","_result$_links2","cleanTitle","utf8Content","createPayload","space","representation","ancestors","errorJson","isArray","parseError","_links","webui","finalMessage","extractedDiagrams","mermaidRegex","getDiagramConfluenceStyles","diagramResult","total","successCount","totalDiagrams","processedDiagrams","all","svgResult","svgContent","unescape","encodeURIComponent","convertDiagramToSvgPng","errorMsg","processAndSaveDiagrams","fullUrl","open","userMessage","rootUrl","hostname","confluenceBaseUrl","customPrompt","instructionUrl","isEnabled","PROGRESS_STEPS","label","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","exports","module","__webpack_modules__","definition","o","defineProperty","enumerable","obj","prop","prototype","hasOwnProperty","call","KToolContent","isModalOpen","currentTab","generationJob","progressSteps","confluenceEditor","mermaidAIChat","loadSettings","injectUI","bindEvents","ktoolContent","bubble","createBubble","modal","createModal","openModal","createGenerateTab","createPreviewTab","createSettingsTab","closeModal","handleGenerate","handleReset","addSettingsButtonListener","onMessage","addListener","sender","sendResponse","action","updateBubbleState","metaKey","firstInput","settingsBtn","openSettingsPopup","_chrome$action","_chrome$action$openPo","_chrome$browserAction","_chrome$browserAction2","openOptionsPage","openPopup","browserAction","tooltip","baDocUrl","additionalNotes","showProgress","updateProgress","baDocument","clonedTemplate","instructions","instructionPageId","instructionDoc","ba_content","template_structure","original_storage_format","additional_prompt","additional_notes","ba_content_length","template_structure_length","original_format_length","placeholders_found","placeholders_list","jobResponse","job_id","currentJobId","pollGenerationResult","hideProgress","attempts","poll","statusResult","resultString","handleGenerationComplete","progress_message","generatedContent","updatePreviewTab","previewTab","editContentBtn","createPageBtn","downloadBtn","handleEditContent","handleCreatePage","handleDownload","createBtn","originalText","originalDisabled","parentId","toISOString","download","click","revokeObjectURL","showMermaidTools","progressSection","step","stepIndex","stepElement","icon","mermaidElements","innerText"],"sourceRoot":""}