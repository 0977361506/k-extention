var __webpack_modules__={378:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Z:()=>MermaidRenderer});class MermaidRenderer{static async loadMermaidScript(){if(window.mermaid)return console.log("‚ö° Mermaid already loaded"),window.mermaid;const res=await fetch(chrome.runtime.getURL("lib/mermaid.min.js")),text=await res.text();return eval(text),window.mermaid}static async initializeMermaid(){await this.loadMermaidScript(),window.mermaid.initialize({startOnLoad:!1,theme:"default",securityLevel:"loose",fontFamily:"Arial, sans-serif",htmlLabels:!0,flowchart:{htmlLabels:!0},deterministicIds:!0,deterministicIDSeed:"mermaid-diagram-preview"}),window.mermaid.setConfig&&window.mermaid.setConfig({securityLevel:"loose",theme:"default"})}static async renderDiagram(e,t,o){try{const n=this.cleanMermaidCode(t);if(!this.validateMermaidCode(n))throw new Error("Invalid Mermaid syntax after cleaning");if(!o||o.nodeType!==Node.ELEMENT_NODE)throw new Error("Invalid container for Mermaid diagram");if(!window.mermaid||"function"!=typeof window.mermaid.render)throw new Error("Mermaid render function not available");const r=document.createElement("div");r.style.position="absolute",r.style.left="-9999px",r.style.top="-9999px",r.style.visibility="hidden",document.body.appendChild(r);try{let t;const a=await window.mermaid.render(e,n,r);t="string"==typeof a?a:a&&a.svg?a.svg:r.innerHTML,o.innerHTML=t}catch(e){console.error("‚ùå Mermaid render error:",e),this.showMermaidError(o,t,e)}finally{r&&r.parentNode&&r.remove()}}catch(e){console.error("‚ùå Mermaid render error (outer):",e),this.showMermaidError(o,t,e)}}static showMermaidError(e,t,o){if(!e||!e.nodeType||e.nodeType!==Node.ELEMENT_NODE)return console.error("‚ùå Invalid container for Mermaid error display:",e),void console.error("‚ùå Mermaid error details:",{message:o.message||"Unknown error occurred",code:t?t.substring(0,100)+"...":"No code provided"});if(!document.contains(e))return console.error("‚ùå Container is not in DOM, cannot display Mermaid error"),void console.error("‚ùå Mermaid error details:",{message:o.message||"Unknown error occurred",code:t?t.substring(0,100)+"...":"No code provided"});try{e.innerHTML=`\n        <div style="color: #dc3545; padding: 15px; background: #f8d7da; border-radius: 8px; border: 1px solid #f5c6cb; font-family: Arial, sans-serif;">\n          <div style="font-weight: bold; margin-bottom: 8px; display: flex; align-items: center;">\n            <span style="margin-right: 8px;">‚ö†Ô∏è</span>\n            Mermaid Render Error\n          </div>\n          <div style="font-size: 12px; color: #721c24; margin-bottom: 10px;">\n            ${o.message||"Unknown error occurred"}\n          </div>\n          <details style="margin-top: 10px;">\n            <summary style="cursor: pointer; font-size: 12px; color: #495057;">Show diagram code</summary>\n            <pre style="margin: 8px 0 0 0; padding: 8px; background: #fff; border: 1px solid #dee2e6; border-radius: 4px; font-size: 11px; overflow-x: auto; white-space: pre-wrap;">${t||"No code provided"}</pre>\n          </details>\n        </div>\n      `}catch(e){console.error("‚ùå Failed to set error HTML in container:",e),console.error("‚ùå Original Mermaid error:",{message:o.message||"Unknown error occurred",code:t?t.substring(0,100)+"...":"No code provided"})}}static detectMermaidType(e){const t=e.trim().split("\n")[0].toLowerCase();return t.includes("graph")?"graph":t.includes("flowchart")?"flowchart":t.includes("sequencediagram")?"sequence":t.includes("classDiagram")?"class":t.includes("stateDiagram")?"state":t.includes("erDiagram")?"er":t.includes("gantt")?"gantt":t.includes("pie")?"pie":"graph"}static extractMermaidDiagrams(e){const t=[],o=new Map;if(!e)return{diagrams:t,diagramsMap:o};const n=/<ac:structured-macro[^>]*ac:name="(mermaid|code)"[^>]*>([\s\S]*?)<\/ac:structured-macro>/gi;let r,a=0;for(;null!==(r=n.exec(e));){const e=r[1],n=r[2],i=n.match(/<ac:parameter[^>]*ac:name="code">([\s\S]*?)<\/ac:parameter>/);if(!i)continue;const s=i[1].trim();if(!s)continue;if("code"===e){const e=n.match(/<ac:parameter[^>]*ac:name="language">([\s\S]*?)<\/ac:parameter>/);if(!e||"mermaid"!==e[1].trim())continue}const l=this.detectMermaidType(s),c=`mermaid-diagram-${a}`,d={id:c,code:s,originalCode:s,originalMatch:r[0],index:a,type:l,title:`${l.charAt(0).toUpperCase()+l.slice(1)} Diagram ${a+1}`};t.push(d),o.set(c,{content:s,originCode:r[0],type:l,index:a,title:d.title}),console.log(`‚úÖ match[0] for diagram ${a}:`,r[0]),a++}return{diagrams:t,diagramsMap:o}}static cleanMermaidCode(e){if(!e)return"";let t=e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#39;/g,"'");return t=t.replace(/<!\[CDATA\[(.*?)\]\]>/gs,"$1"),t=t.replace(/<[^>]*>/g,""),t=t.replace(/\r\n/g,"\n").replace(/\r/g,"\n"),t=t.replace(/\n\s*\n\s*\n/g,"\n\n"),t=t.trim(),t}static validateMermaidCode(e){if(!e||!e.trim())return!1;const t=e.trim();return!!["graph","flowchart","sequenceDiagram","classDiagram","stateDiagram","erDiagram","journey","gantt","pie","gitgraph","mindmap","timeline","sankey","requirement"].some(e=>t.toLowerCase().startsWith(e.toLowerCase()))&&!t.includes("undefined")&&!t.includes("null")}}}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var o=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](o,o.exports,__webpack_require__),o.exports}__webpack_require__.d=(e,t)=>{for(var o in t)__webpack_require__.o(t,o)&&!__webpack_require__.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var __webpack_exports__={};const EXTENSION_SETTINGS_KEY="extensionSettings",isLocal="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||window.location.hostname.includes("localhost"),rootUrl=isLocal?"http://localhost:5001":"https://gendoc.thangnotes.dev",confluenceBaseUrl="http://localhost:8090",API_URLS={GEN_DOC:`${rootUrl}/api/generate-full-confluence-doc`,GEN_DOC_STATUS:`${rootUrl}/api/generate-status`,GEN_DOC_RESULT:`${rootUrl}/api/generate-result`,EDIT_DIAGRAM:`${rootUrl}/api/edit-diagram`,EDIT_MERMAID:`${rootUrl}/api/edit-mermaid`,EDIT_TEXT:`${rootUrl}/api/edit-text`,EDIT_HTML_CONTENT:`${rootUrl}/api/edit-html-content`,CONVERT_HTML_TO_XHTML:`${rootUrl}/api/html-to-xhtml`},CONFLUENCE_API_URLS={MERMAID_DIAGRAM:`${confluenceBaseUrl}/rest/mermaidrest/1.0/mermaid/diagram`,MERMAID_SAVE:`${confluenceBaseUrl}/rest/mermaidrest/1.0/mermaid/save`,MERMAID_UPDATE:`${confluenceBaseUrl}/rest/mermaidrest/1.0/mermaid`,MERMAID_EDIT_REFERER:`${confluenceBaseUrl}/plugins/mermaid-cloud/editMermaidDiagram.action`,TINYMCE_PLACEHOLDER:`${confluenceBaseUrl}/rest/tinymce/1/macro/placeholder`},DEFAULT_SETTINGS={apiKey:"",urlTemplate:"",customPrompt:"",documentUrl:"",databaseUrl:"",instructionUrl:"",isEnabled:!0,selectedModel:"sonar-pro"},AI_MODELS={"sonar-pro":{name:"Sonar Pro",provider:"Perplexity",description:"Perplexity AI Sonar Pro model"},gemini:{name:"Gemini 2.0 Flash",provider:"Google",description:"Google Gemini 2.0 Flash model"}},PROGRESS_STEPS=[{id:"fetch",label:"Fetch BA Content",status:"pending"},{id:"clone",label:"Clone Template",status:"pending"},{id:"analyze",label:"Analyze Placeholders",status:"pending"},{id:"generate",label:"AI Generate Document",status:"pending"},{id:"complete",label:"Complete",status:"pending"}],VALIDATION={URL_PATTERN:/^https?:\/\/.+/,PLACEHOLDER_PATTERN:/<<([^>]+)>>/g,MIN_PROMPT_LENGTH:10};var mermaidRenderer=__webpack_require__(378);function getDiagramConfluenceStyles(e){let t=1;const o=[],n=/<ac:structured-macro[^>]*ac:name="mermaid"[^>]*>[\s\S]*?<ac:parameter[^>]*ac:name="code"[^>]*>(?:<!\[CDATA\[([\s\S]*?)\]\]>|([\s\S]*?))<\/ac:parameter>[\s\S]*?<\/ac:structured-macro>/g;let r;for(;null!==(r=n.exec(e));){const e=(r[1]||r[2]||"").trim();e&&(o.push({filename:`k-tool-diagram-${t}`,macroId:(110+t).toString(),diagramCode:e}),t++)}return o}async function loadMermaidScript(){"undefined"!=typeof window&&window.mermaid||(window.mermaid||(console.log("üì¶ Loading Mermaid library..."),await mermaidRenderer.Z.loadMermaidScript()),window.mermaid&&!window.mermaid.mermaidAPI&&window.mermaid.initialize({startOnLoad:!1,securityLevel:"loose",theme:"default"}))}async function convertDiagramToSvgPng(e){try{console.log(`üé® Converting diagram to SVG/PNG: ${e.filename}`),console.log(`üé® Converting diagram to SVG/PNG: ${e.diagramCode}`),await loadMermaidScript();const t=await window.mermaid.render(`diagram-${e.macroId}`,e.diagramCode);let o;if("string"==typeof t)o=t;else{if(!t||"object"!=typeof t||!t.svg)throw new Error("Invalid SVG result from mermaid.render");o=t.svg}e.svg=o;const n=document.createElement("canvas"),r=n.getContext("2d"),a=new Image;return await new Promise((t,i)=>{a.onload=()=>{n.width=a.width||800,n.height=a.height||600,r&&(r.fillStyle="white",r.fillRect(0,0,n.width,n.height),r.drawImage(a,0,0),e.png=n.toDataURL("image/png").split(",")[1]),t(!0)},a.onerror=i,a.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(o)))}),console.log(`‚úÖ Successfully converted ${e.filename} to SVG/PNG`),e}catch(t){return console.error(`‚ùå Failed to convert diagram ${e.filename}:`,t),e.png="iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==",e}}async function saveDiagramToAPI(e,t){try{console.log(`üíæ Saving diagram ${e.filename} to API for page ${t}`);const o={filename:e.filename,data:e.diagramCode,svg:e.svg||"",png:e.png||""},n=await fetch(`/rest/mermaidrest/1.0/mermaid/${t}`,{method:"POST",headers:{Accept:"application/json, text/javascript, */*; q=0.01","Content-Type":"application/json; charset=UTF-8","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(o)});if(!n.ok){const t=await n.text();return console.error(`‚ùå Failed to save diagram ${e.filename}:`,n.status,t),!1}return console.log(`‚úÖ Successfully saved diagram ${e.filename} to API`),!0}catch(t){return console.error(`‚ùå Error saving diagram ${e.filename}:`,t),!1}}async function processAndSaveDiagrams(e,t){if(0===t.length)return console.log("‚ÑπÔ∏è No diagrams to process"),{success:0,total:0,errors:[]};console.log(`üîÑ Processing ${t.length} diagrams for page ${e}`);let o=0;const n=[],r=t.length;try{console.log("üé® Converting diagrams to SVG/PNG...");const r=await Promise.all(t.map(e=>convertDiagramToSvgPng(e)));console.log("üíæ Saving diagrams sequentially...");for(let t=0;t<r.length;t++){const a=r[t];console.log(`üìä Saving diagram ${t+1}/${r.length}: ${a.filename}`);try{await saveDiagramToAPI(a,e)?(o++,console.log(`‚úÖ Diagram ${t+1}/${r.length} saved successfully`)):(n.push(`Failed to save diagram: ${a.filename}`),console.error(`‚ùå Diagram ${t+1}/${r.length} failed to save`))}catch(e){const o=`Error saving diagram ${a.filename}: ${e instanceof Error?e.message:"Unknown error"}`;n.push(o),console.error(`‚ùå Diagram ${t+1}/${r.length} error:`,e)}t<r.length-1&&await new Promise(e=>setTimeout(e,500))}}catch(e){console.error("‚ùå Error during diagram processing:",e),n.push(`Processing error: ${e instanceof Error?e.message:"Unknown error"}`)}const a={success:o,total:r,errors:n};return console.log(`üìä Diagram processing complete: ${o}/${r} successful`),n.length>0&&console.warn("‚ö†Ô∏è Diagram processing errors:",n),a}class ApiClient{static async request(e,t={}){try{const o=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers},...t});if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);return{success:!0,data:await o.json()}}catch(e){return console.error("API request failed:",e),{success:!1,error:e.message}}}static async generateDocument(e){return await this.request(API_URLS.GEN_DOC,{method:"POST",body:JSON.stringify(e)})}static async checkStatus(e){return await this.request(`${API_URLS.GEN_DOC_STATUS}?job_id=${e}`)}static async getResult(e){return await this.request(`${API_URLS.GEN_DOC_RESULT}?job_id=${e}`)}static async editText(e){return await this.request(API_URLS.EDIT_TEXT,{method:"POST",body:JSON.stringify(e)})}static async convertHtmlToXhtml(e){console.log("üîÑ Converting HTML to XHTML..."),console.log("üìÑ HTML content length:",(null==e?void 0:e.length)||0),console.log("üîó API URL:",API_URLS.CONVERT_HTML_TO_XHTML);try{const t=await this.request(API_URLS.CONVERT_HTML_TO_XHTML,{method:"POST",body:JSON.stringify({content:e})});return console.log("‚úÖ HTML to XHTML conversion result:",t),t}catch(e){return console.error("‚ùå HTML to XHTML conversion error:",e),console.error("‚ùå Error details:",{name:e.name,message:e.message,stack:e.stack}),{success:!1,error:e.message}}}}class ConfluenceApi{static extractPageId(e){const t=[/\/pages\/(\d+)/,/pageId=(\d+)/,/\/(\d+)$/];for(const o of t){const t=e.match(o);if(t)return t[1]}return null}static getCurrentSpaceKey(){const e=document.querySelector('meta[name="ajs-space-key"]');if(e)return e.content;const t=document.querySelector("[data-space-key]");if(t)return t.dataset.spaceKey;const o=window.location.pathname.match(/\/spaces\/([^\/]+)/);return o?o[1]:null}static async fetchPageContent(e){try{var t,o,n,r;console.log("üîç Fetching Confluence content for pageId:",e);const a=`/rest/api/content/${e}?expand=body.storage,body.view`,i=await fetch(a,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!i.ok){const e=await i.text();throw console.error("‚ùå API Error:",i.status,e),new Error(`HTTP ${i.status}: ${i.statusText}`)}const s=await i.json();return console.log("üìÑ Content data received:",{id:s.id,title:s.title,hasStorage:!(null===(t=s.body)||void 0===t||null===(t=t.storage)||void 0===t||!t.value),hasView:!(null===(o=s.body)||void 0===o||null===(o=o.view)||void 0===o||!o.value)}),{title:s.title,content:(null===(n=s.body)||void 0===n||null===(n=n.view)||void 0===n?void 0:n.value)||"",storageFormat:(null===(r=s.body)||void 0===r||null===(r=r.storage)||void 0===r?void 0:r.value)||""}}catch(e){throw console.error("‚ùå Error fetching Confluence content:",e),e}}static async cloneTemplateForGeneration(e){try{var t,o;if(console.log("üîç Cloning template from URL:",e),!e||!e.trim())throw console.error("‚ùå Empty URL provided"),new Error("URL template kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng");const n=this.extractPageIdFromUrl(e);if(!n)throw console.error("‚ùå No pageId found in URL"),new Error("URL kh√¥ng ch·ª©a pageId h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i URL template.");console.log("üìã Fetching template pageId:",n);const r=`/rest/api/content/${n}?expand=body.storage`,a=await fetch(r,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!a.ok){const e=await a.text();throw console.error("‚ùå API Error:",a.status,e),new Error(`HTTP ${a.status}: ${a.statusText}`)}const i=await a.json();if(console.log("üìÑ Template data received:",{id:i.id,title:i.title,hasStorage:!(null===(t=i.body)||void 0===t||null===(t=t.storage)||void 0===t||!t.value)}),null===(o=i.body)||void 0===o||null===(o=o.storage)||void 0===o||!o.value)throw console.error("‚ùå No storage content found in response"),new Error("Template kh√¥ng c√≥ n·ªôi dung storage format");const s=i.body.storage.value;console.log("üìÑ Original storage format length:",s.length);const{templateStructure:l,analysisInfo:c}=this.extractTemplateStructure(s),d={title:i.title,originalStorageFormat:s,templateStructure:l,analysisInfo:c};return console.log("‚úÖ Template cloned successfully:",{title:d.title,originalLength:s.length,structureLength:l.length,analysis:c}),d}catch(e){throw console.error("‚ùå Error cloning template:",e),e}}static extractTemplateStructure(e){let t=0,o=0,n=0;console.log("üîç Extracting template structure...");let r=e;[/(<<.*?>>)/g,/(\{\{.*?\}\})/g,/(&lt;&lt;.*?&gt;&gt;)/g,/(\u003c\u003c.*?\u003e\u003e)/g].forEach((e,t)=>{const o=[...r.matchAll(e)];console.log(`üéØ Placeholder pattern ${t+1} found ${o.length} matches`),n+=o.length}),t=(e.match(/<p[^>]*>\s*<\/p>/g)||[]).length,o=(e.match(/<td[^>]*>\s*<\/td>/g)||[]).length;const a={emptyParagraphs:t,emptyTableCells:o,placeholders:n,totalLength:e.length};return{templateStructure:r,analysisInfo:a}}static extractPageIdFromUrl(e){const t=[/\/pages\/(\d+)/,/pageId=(\d+)/,/\/(\d+)$/,/viewpage\.action\?pageId=(\d+)/];for(const o of t){const t=e.match(o);if(t)return t[1]}return null}static extractPlaceholders(e){console.log("üîç Analyzing content for placeholders..."),console.log("üìÑ Content length:",e.length),console.log("üìÑ Content preview (first 500 chars):",e.substring(0,500));const t=e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#39;/g,"'"),o=[/<<([^>]+)>>/g,/&lt;&lt;([^&]+)&gt;&gt;/g];let n=[];[e,t].forEach((e,t)=>{console.log(`üîç Testing on ${0===t?"original":"decoded"} content...`),o.forEach((t,o)=>{const r=[...e.matchAll(t)];console.log(`üéØ Pattern ${o+1} found ${r.length} matches:`,r.map(e=>e[0])),1===o?n.push(...r.map(e=>`<<${e[1]}>>`)):n.push(...r.map(e=>e[0]))})});const r=[...new Set(n)];return console.log("üéØ Unique placeholders found:",r),r}static async extractImagesFromHtml(e){const t=[];try{const o=(new DOMParser).parseFromString(e,"text/html").querySelectorAll("img");for(const e of Array.from(o)){const o=e.getAttribute("src");let n;if(o){let r=o;if(o.startsWith("data:image"))n=e.getAttribute("alt")?e.getAttribute("alt")+".png":`image_${Date.now()}.png`;else{const{base64:e,filename:t}=await this.urlToBase64(o);if(!e)continue;r=e,n=t}t.push({src:r,alt:e.getAttribute("alt")||void 0,filename:n})}}}catch(e){console.warn("extractImagesFromHtml error:",e)}return t}static async urlToBase64(e){try{const t=await fetch(e);if(!t.ok)return{base64:null,filename:this.getFilenameFromUrl(e)};const o=await t.blob(),n=this.getFilenameFromUrl(e);return await new Promise((e,t)=>{const r=new FileReader;r.onloadend=()=>e({base64:r.result,filename:n}),r.onerror=t,r.readAsDataURL(o)})}catch(t){return console.warn("urlToBase64 error:",t),{base64:null,filename:this.getFilenameFromUrl(e)}}}static getFilenameFromUrl(e){try{const t=new URL(e).pathname;return t.substring(t.lastIndexOf("/")+1)||`image_${Date.now()}`}catch{return`image_${Date.now()}`}}static validateAndCleanTitle(e){return e.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"").replace(/√¢‚Ç¨‚Ñ¢/g,"'").replace(/√¢‚Ç¨≈ì/g,'"').replace(/√¢‚Ç¨/g,'"').replace(/√¢‚Ç¨¬¶/g,"...").replace(/\s+/g," ").trim()||`Generated Document - ${(new Date).toLocaleDateString()}`}static ensureUtf8Encoding(e){try{const t=new TextEncoder,o=new TextDecoder("utf-8",{fatal:!1}),n=t.encode(e);return o.decode(n)}catch(t){return console.warn("UTF-8 encoding issue, using original content:",t),e}}static basicContentCleanup(e){return e.replace(/^```\w*\s*/g,"").replace(/```\s*$/g,"").trim().replace(/^\uFEFF/,"").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"").replace(/√¢‚Ç¨‚Ñ¢/g,"'").replace(/√¢‚Ç¨≈ì/g,'"').replace(/√¢‚Ç¨/g,'"').replace(/√¢‚Ç¨¬¶/g,"...").replace(/√¢‚Ç¨"/g,"‚Äì").replace(/√¢‚Ç¨"/g,"‚Äî").replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\n{3,}/g,"\n\n").replace(/[ \t]+$/gm,"").replace(/^[ \t]+/gm,"").trim()}static advancedHTMLSanitization(e){console.log("üî¨ Starting advanced HTML sanitization...");let t=e.replace(/<(br|hr|img|input|meta|link|area|base|col|embed|source|track|wbr)([^>]*?)(?<!\/)\s*>/gi,"<$1$2/>").replace(/(\w+)=([^"\s>]+)(\s|>)/g,'$1="$2"$3').replace(/&(?![a-zA-Z0-9#]+;)/g,"&amp;").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"").replace(/√¢‚Ç¨‚Ñ¢/g,"'").replace(/√¢‚Ç¨≈ì/g,'"').replace(/√¢‚Ç¨/g,'"').replace(/<(\w+)([^>]*?)>\s*<\/\1>/g,(e,t)=>["p","td","th","li"].includes(t.toLowerCase())?`<${t}>&nbsp;</${t}>`:"").replace(/>\s+</g,"><").replace(/\s+/g," ").trim();return console.log("‚úÖ Advanced HTML sanitization complete"),console.log(`üìä Original length: ${e.length}, Final length: ${t.length}`),t}static convertToMermaidCloudMacros(e){console.log("üîÑ Converting all macros to mermaid-cloud macros...");let t=1,o=111;const n=e.replace(/<ac:structured-macro[^>]*>[\s\S]*?<\/ac:structured-macro>/g,e=>{const n=`k-tool-diagram-${t}`,r=o.toString();return t++,o++,console.log(`üîß Converting macro ${t-1} to mermaid-cloud: ${n}`),`<ac:structured-macro ac:name="mermaid-cloud" ac:schema-version="1" ac:macro-id="${r}">\n<ac:parameter ac:name="toolbar">bottom</ac:parameter>\n<ac:parameter ac:name="filename">${n}</ac:parameter>\n<ac:parameter ac:name="format">svg</ac:parameter>\n<ac:parameter ac:name="zoom">fit</ac:parameter>\n<ac:parameter ac:name="revision">1</ac:parameter>\n</ac:structured-macro>`});return console.log(`‚úÖ Converted ${t-1} macros to mermaid-cloud`),n}static validateAndFixXML(e){let t=e;return console.log("üîç Validating and fixing XML content..."),t=t.replace(/<\s+([a-zA-Z])/g,"<$1").replace(/([a-zA-Z])\s+([^>]*>)/g,"$1 $2").replace(/<\/\s+([a-zA-Z][^>]*?)>/g,"</$1>").replace(/([a-zA-Z-]+)\s*=\s*"([^"]*)"/g,'$1="$2"').replace(/\s{2,}/g," ").replace(/\r\n/g,"\n").replace(/\r/g,"\n"),t=t.replace(/<ac:([^>]+)>/g,(e,t)=>`<ac:${t.trim()}>`).replace(/<ac:structured-macro\s+([^>]+)>/g,(e,t)=>`<ac:structured-macro ${t.trim().replace(/\s+/g," ")}>`).replace(/<!\[CDATA\[\s*([\s\S]*?)\s*\]\]>/g,"<![CDATA[$1]]>"),console.log("‚úÖ XML validation and fixing complete"),t}static async createPage(e,t,o,n=null){try{var r,a;console.log("üîÑ Creating page from generated content...");const i=this.validateAndCleanTitle(e);console.log("üìã Original title:",e),console.log("üìã Clean title:",i),console.log("üìã Space:",o),console.log("üìã Content length:",t.length);const s=this.ensureUtf8Encoding(t);console.log("üî§ UTF-8 validation complete"),console.log("üìÑ Content preview (first 200 chars):"),console.log(s.substring(0,200)),console.log("üßπ Starting enhanced content cleanup...");let l=this.basicContentCleanup(s);console.log("üî¨ Performing advanced HTML sanitization..."),l=this.advancedHTMLSanitization(l),console.log("üîÑ Converting macros to mermaid-cloud..."),l=this.convertToMermaidCloudMacros(l);const c=l;console.log("‚úÖ Content processing complete"),console.log("üìÑ Final content length:",c.length),console.log("üìÑ Final content preview (first 200 chars):"),console.log(c.substring(0,200));const d={type:"page",title:i.trim()+"-"+Date.now(),space:{key:o},body:{storage:{value:c,representation:"storage"}}};n&&(d.ancestors=[{id:n}],console.log("üìÅ Setting parent page ID:",n)),console.log("üì§ Sending page creation request...");const m=await fetch("/rest/api/content",{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8",Accept:"application/json","X-Atlassian-Token":"no-check"},body:JSON.stringify(d)});if(!m.ok){const e=await m.text();console.error("‚ùå Page creation failed:",e);let t=`HTTP ${m.status}: ${m.statusText}`;try{const o=JSON.parse(e);o.message&&(t=o.message),o.errors&&Array.isArray(o.errors)&&(t+=`\n\nDetailed errors:\n${o.errors.map(e=>`${e.field||"Unknown field"}: ${e.message||e}`).join("\n")}`)}catch(o){console.warn("Could not parse error response as JSON"),t+=`\n\nRaw error: ${e}`}throw new Error(t)}const g=await m.json();console.log("‚úÖ Page created successfully!"),console.log("üìÑ Page ID:",g.id),console.log("üîó Page URL:",null===(r=g._links)||void 0===r?void 0:r.webui);let u=`‚úÖ T·∫°o t√†i li·ªáu th√†nh c√¥ng!\n\nTi√™u ƒë·ªÅ: ${g.title}\nPage ID: ${g.id}`;const p=getDiagramConfluenceStyles(t);if(console.log(`üìä Extracted ${p.length} diagrams from content`),p.length>0){console.log("üé® Processing extracted diagrams...");const e=await processAndSaveDiagrams(g.id,p);e.total>0&&(u+=`\n\nüìä Diagrams: ${e.success}/${e.total} saved successfully`,e.errors.length>0&&(u+=`\n‚ö†Ô∏è Diagram errors:\n${e.errors.join("\n")}`))}if("undefined"!=typeof window&&window.KToolNotificationUtils&&window.KToolNotificationUtils.success("Trang ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!",u.replace(/^‚úÖ\s*/,"")),null!==(a=g._links)&&void 0!==a&&a.webui){const e=`${window.location.origin}${g._links.webui}`;window.open(e,"_blank")}}catch(e){console.error("‚ùå Error creating page:",e);let t="L·ªói khi t·∫°o trang Confluence.";throw e instanceof Error&&(t=e.message.includes("validation failed")?`‚ùå N·ªôi dung kh√¥ng h·ª£p l·ªá:\n\n${e.message}`:e.message.includes("HTTP 400")?"‚ùå D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i n·ªôi dung.":e.message.includes("HTTP 401")?"‚ùå Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.":e.message.includes("HTTP 403")?"‚ùå Kh√¥ng c√≥ quy·ªÅn t·∫°o trang trong space n√†y.":`‚ùå ${e.message}`),"undefined"!=typeof window&&window.KToolNotificationUtils&&window.KToolNotificationUtils.error("L·ªói t·∫°o trang",t.replace(/^‚ùå\s*/,"")),e}}}class XMLFormatter{static formatXHTML(e,t="    "){const o="xml-root-fragment",n=`<${o}>${e}</${o}>`,r=(new DOMParser).parseFromString(n,"text/xml"),a=r.getElementsByTagName("parsererror");var i;if(a.length>0)return console.warn("XML/XHTML parsing error. Returning original string.",{error:(null===(i=a[0])||void 0===i?void 0:i.textContent)||"Unknown parsing error",originalLength:e.length,sample:e.substring(0,100)+"..."}),e;let s="";const l=r.documentElement;function c(e,o){switch(e.nodeType){case Node.ELEMENT_NODE:const n=e.nodeName;let r=`<${n}`;if(e.attributes&&e.attributes.length>0)for(let t of e.attributes)r+=` ${t.name}="${t.value}"`;if(r+=">",Array.from(e.childNodes).some(e=>e.nodeType!==Node.TEXT_NODE||e.textContent.trim().length>0)){s+=`${o}${r}\n`;const a=o+t;Array.from(e.childNodes).forEach(e=>c(e,a)),s+=`${o}</${n}>\n`}else s+=`${o}${r.replace(">","/>")}\n`;break;case Node.TEXT_NODE:const a=e.textContent.trim();a.length>0&&(s+=`${o}${a}\n`);break;case Node.COMMENT_NODE:s+=`${o}\x3c!--${e.textContent}--\x3e\n`;break;case Node.CDATA_SECTION_NODE:s+=`${o}<![CDATA[${e.textContent}]]>\n`}}return Array.from(l.childNodes).forEach(e=>c(e,"")),s.trim()}static isSelfClosingTag(e){return["br","hr","img","input","meta","link","source","track","wbr"].some(t=>e.startsWith(`<${t}`))}static cleanXMLMarkers(e){if(!e)return"";let t=e.replace(/^```xml\s*\n?/gm,"");return t=t.replace(/\n?```\s*$/gm,""),t}static convertXHTMLToHTML(e){if(!e)return"";console.log("üîÑ Converting XHTML to HTML:",{originalLength:e.length,hasUL:e.includes("<ul"),hasOL:e.includes("<ol"),hasLI:e.includes("<li"),preview:e.substring(0,300)});let t=e;return t=this.cleanDataAttributes(t),t=t.replace(/<br\s*\/>/g,"<br>").replace(/<hr\s*\/>/g,"<hr>").replace(/<img([^>]*)\s*\/>/g,"<img$1>").replace(/\s+xmlns[^=]*="[^"]*"/g,"").replace(/&nbsp;/g," ").replace(/\s+/g," ").replace(/>\s+</g,"><").trim(),console.log("üîÑ XHTML to HTML conversion result:",{length:t.length,hasUL:t.includes("<ul"),hasOL:t.includes("<ol"),hasLI:t.includes("<li"),preview:t.substring(0,300),cleanedDataAttrs:!t.includes("data-start")}),t}static cleanDataAttributes(e){return e?e.replace(/\s+data-start="[^"]*"/g,"").replace(/\s+data-end="[^"]*"/g,"").replace(/\s+data-uuid="[^"]*"/g,"").replace(/\s+data-id="[^"]*"/g,"").replace(/\s+data-type="[^"]*"/g,""):""}static escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}}class ContentSynchronizer{constructor(){this.diagramChanges=new Map}trackDiagramChange(e,t){console.log(`üìù Tracking diagram change for ${e}`),this.diagramChanges.set(e,{code:t,timestamp:Date.now()})}getTrackedChanges(){return this.diagramChanges}clearTrackedChanges(){this.diagramChanges.clear()}syncAllContent(e,t,o=[]){if(!e)throw new Error("Current content is required");const n=this.syncFromRawEditor(e,t);return this.syncMermaidChanges(n,o)}syncFromRawEditor(e,t){if(!t)return e;const o=t.querySelector("#raw-content-editor");if(!o||!o.value)return e;const n={...e};return n.full_storage_format=o.value.trim(),void 0!==n.content&&(n.content=o.value.trim()),n}syncMermaidChanges(e,t=[]){if(!t||0===t.length)return console.log("‚ö†Ô∏è No Mermaid diagrams to sync"),e;let o=e.full_storage_format||e.content||"";t.forEach((e,t)=>{var n,r;if(console.log(`ÔøΩ Processing diagram ${t}:`,{id:e.id,hasOriginalCode:!!e.originalCode,hasCode:!!e.code,originalLength:(null===(n=e.originalCode)||void 0===n?void 0:n.length)||0,codeLength:(null===(r=e.code)||void 0===r?void 0:r.length)||0}),e.originalCode&&e.code){console.log(`üìù Replacing code for diagram ${e.id||t}...`),console.log(`üìã Original code preview: "${e.originalCode.substring(0,100)}..."`),console.log(`üìã New code preview: "${e.code.substring(0,100)}..."`);const n=this.updateDiagramInContent(o,e,t);n!==o?(o=n,console.log(`‚úÖ Successfully replaced code for diagram ${e.id||t}`)):console.warn(`‚ö†Ô∏è Failed to replace code for diagram ${e.id||t} - no pattern matched`)}else console.log(`‚ö†Ô∏è Skipping diagram ${e.id||t} - missing originalCode or code`)});const n={...e};return n.full_storage_format=o,void 0!==n.content&&(n.content=o),n}updateDiagramInContent(e,t,o){if(!e||!t)return console.log("‚ö†Ô∏è updateDiagramInContent: Missing content or diagram"),e;const n=t.originalCode,r=t.code;if(!n||!r)return console.log("‚ö†Ô∏è Missing originalCode or newCode - skipping update"),e;console.log("üìã Replacing originalCode with newCode (no equality check)"),console.log(`üìã Original: "${n.substring(0,50)}..."`),console.log(`üìã New: "${r.substring(0,50)}..."`);const a=[{pattern:new RegExp(`(<ac:parameter[^>]*ac:name="code"[^>]*>\\s*<\\!\\[CDATA\\[\\s*)(${XMLFormatter.escapeRegex(n)})(\\s*\\]\\]>\\s*</ac:parameter>)`,"gs"),replacement:`$1${r}$3`},{pattern:new RegExp(`(<ac:parameter[^>]*ac:name="code"[^>]*>\\s*)(${XMLFormatter.escapeRegex(n)})(\\s*</ac:parameter>)`,"gs"),replacement:`$1${r}$3`},{pattern:new RegExp(`(<ac:plain-text-body>\\s*<\\!\\[CDATA\\[\\s*)(${XMLFormatter.escapeRegex(n)})(\\s*\\]\\]>\\s*</ac:plain-text-body>)`,"gs"),replacement:`$1${r}$3`}];let i=e,s=!1;for(let t=0;t<a.length;t++){const{pattern:o,replacement:n}=a[t];if(console.log(`üîç Testing pattern ${t+1}...`),o.lastIndex=0,o.test(e)){console.log(`‚úÖ Pattern ${t+1} matched! Applying replacement...`),o.lastIndex=0,i=e.replace(o,n),s=!0,console.log(`‚úÖ Successfully updated diagram using pattern ${t+1}`);break}console.log(`‚ùå Pattern ${t+1} did not match`)}if(!s){console.warn(`‚ö†Ô∏è Could not find pattern to update diagram ${t.id||o}`),console.log("Original code preview:",n.substring(0,100)+"..."),console.log("New code preview:",r.substring(0,100)+"..."),console.log("Content sample:",e.substring(0,500)+"...");const a=e.includes(n.trim());console.log("Simple string search found original code:",a)}return i}validateContent(e){const t={isValid:!0,errors:[],warnings:[]};if(!e)return t.isValid=!1,t.errors.push("Content is null or undefined"),t;e.full_storage_format||e.content||(t.isValid=!1,t.errors.push("Missing full_storage_format or content field"));const o=e.full_storage_format||e.content;if(o)try{(new DOMParser).parseFromString(`<root>${o}</root>`,"text/xml").getElementsByTagName("parsererror").length>0&&t.warnings.push("Content may contain XML parsing issues")}catch(e){t.warnings.push(`XML validation warning: ${e.message}`)}return t}createBackup(e){return{content:JSON.parse(JSON.stringify(e)),timestamp:Date.now()}}restoreFromBackup(e){if(!e||!e.content)throw new Error("Invalid backup data");return e.content}}class DOMHelpers{static querySelector(e,t){try{return e.querySelector(t)}catch(e){return console.error(`Error querying selector "${t}":`,e),null}}static querySelectorAll(e,t){try{return e.querySelectorAll(t)}catch(e){return console.error(`Error querying selector "${t}":`,e),[]}}static addEventListener(e,t,o,n={}){if(e)try{e.addEventListener(t,o,n)}catch(e){console.error(`Error adding event listener for "${t}":`,e)}else console.warn("Cannot add event listener: element is null")}static removeEventListener(e,t,o){if(e)try{e.removeEventListener(t,o)}catch(e){console.error(`Error removing event listener for "${t}":`,e)}else console.warn("Cannot remove event listener: element is null")}static toggleClass(e,t,o=void 0){if(e)try{void 0!==o?e.classList.toggle(t,o):e.classList.toggle(t)}catch(e){console.error(`Error toggling class "${t}":`,e)}else console.warn("Cannot toggle class: element is null")}static addClass(e,t){if(e)try{e.classList.add(t)}catch(e){console.error(`Error adding class "${t}":`,e)}else console.warn("Cannot add class: element is null")}static removeClass(e,t){if(e)try{e.classList.remove(t)}catch(e){console.error(`Error removing class "${t}":`,e)}else console.warn("Cannot remove class: element is null")}static setContent(e,t,o=!1){if(e)try{if("INPUT"===e.tagName||"TEXTAREA"===e.tagName||"SELECT"===e.tagName)return void(e.value=t||"");o?e.innerHTML=t:e.textContent=t}catch(e){console.error("Error setting content:",e)}else console.warn("Cannot set content: element is null")}static getContent(e,t=!1){if(!e)return console.warn("Cannot get content: element is null"),"";try{return"INPUT"===e.tagName||"TEXTAREA"===e.tagName||"SELECT"===e.tagName?e.value||"":t?e.innerHTML:e.textContent}catch(e){return console.error("Error getting content:",e),""}}static createElement(e,t={},o="",n=!1){try{const r=document.createElement(e);return Object.entries(t).forEach(([e,t])=>{"className"===e?r.className=t:"style"===e&&"object"==typeof t?Object.assign(r.style,t):r.setAttribute(e,t)}),o&&this.setContent(r,o,n),r}catch(t){return console.error(`Error creating element "${e}":`,t),null}}static removeElement(e){if(e)try{e.parentNode?e.parentNode.removeChild(e):e.remove()}catch(e){console.error("Error removing element:",e)}else console.warn("Cannot remove element: element is null")}static isInDOM(e){return!!e&&document.body.contains(e)}static scrollIntoView(e,t={behavior:"smooth",block:"center"}){if(e)try{e.scrollIntoView(t)}catch(e){console.error("Error scrolling element into view:",e)}else console.warn("Cannot scroll: element is null")}static getDimensions(e){if(!e)return console.warn("Cannot get dimensions: element is null"),{width:0,height:0,top:0,left:0};try{const t=e.getBoundingClientRect();return{width:t.width,height:t.height,top:t.top,left:t.left,right:t.right,bottom:t.bottom}}catch(e){return console.error("Error getting element dimensions:",e),{width:0,height:0,top:0,left:0}}}static cloneElement(e,t=!0){if(!e)return console.warn("Cannot clone element: element is null"),null;try{return e.cloneNode(t)}catch(e){return console.error("Error cloning element:",e),null}}}class HTMLTemplates{static getEditorTemplate(){return`\n      <div class="confluence-editor-container">\n        <div class="confluence-editor-header">\n          <h2 class="confluence-editor-title">\n            üìù Edit Confluence Content\n          </h2>\n          <div class="confluence-editor-actions">\n            <button class="editor-btn editor-btn-primary" id="editor-save-btn">\n              üíæ Save\n            </button>\n            <button class="editor-btn editor-btn-secondary" id="editor-close-btn">\n              ‚úï Close\n            </button>\n          </div>\n        </div>\n\n        <div class="confluence-editor-tabs">\n          <button class="confluence-editor-tab active" id="rich-text-tab">\n            üé® Rich Text\n          </button>\n          <button class="confluence-editor-tab" id="mermaid-tab">\n            üìä Edit Mermaid Code\n          </button>\n        </div>\n\n        <div class="confluence-editor-body">\n          ${this.getRichTextTabTemplate()}\n          ${this.getMermaidTabTemplate()}\n        </div>\n      </div>\n    `}static getRichTextTabTemplate(){return'\n      \x3c!-- Rich Text Tab --\x3e\n      <div class="tab-content active" id="rich-text-tab-content">\n        <div class="tiptap-layout-full">\n          \x3c!-- Full Width TipTap Rich Text Editor --\x3e\n          <div class="tiptap-editor-pane-full">\n            <div class="tiptap-editor-header">\n              <span>üé® TipTap Rich Text Editor</span>\n            </div>\n            <div class="tiptap-editor-body">\n              <div class="tiptap-editor-container" id="tiptap-editor-container"></div>\n            </div>\n          </div>\n        </div>\n      </div>\n    '}static getMermaidTabTemplate(){return`\n      \x3c!-- Mermaid Tab --\x3e\n      <div class="tab-content" id="mermaid-tab-content">\n        <div class="mermaid-editor-layout">\n          \x3c!-- Mermaid Code Editor (Left) --\x3e\n          <div class="mermaid-code-pane">\n            <div class="mermaid-editor-header">\n              üìä Mermaid Code\n              <select id="mermaid-selector" class="mermaid-selector">\n                <option value="">Select diagram...</option>\n              </select>\n            </div>\n            <div class="mermaid-editor-body">\n              <textarea class="mermaid-code-editor" id="mermaid-code-editor" placeholder="Select a Mermaid diagram to edit..."></textarea>\n            </div>\n          </div>\n\n          \x3c!-- Mermaid Preview (Center) --\x3e\n          <div class="mermaid-preview-pane">\n            <div class="mermaid-editor-header">\n              <span class="preview-title">üìä Diagram Preview</span>\n              ${this.getZoomControlsTemplate()}\n            </div>\n            <div class="mermaid-editor-body">\n              <div class="mermaid-preview" id="mermaid-preview">\n                <div class="mermaid-placeholder">\n                  Select a diagram to preview\n                </div>\n              </div>\n            </div>\n          </div>\n\n          \x3c!-- AI Chat (Right) --\x3e\n          <div class="mermaid-ai-pane">\n            <div class="mermaid-editor-header">\n              ü§ñ AI Assistant\n            </div>\n            <div class="mermaid-editor-body">\n              ${this.getAIChatTemplate()}\n            </div>\n          </div>\n        </div>\n      </div>\n    `}static getZoomControlsTemplate(){return'\n      <div class="mermaid-zoom-controls">\n        <button class="zoom-btn" id="zoom-out" title="Zoom Out">‚àí</button>\n        <div class="zoom-level" id="zoom-level">100%</div>\n        <button class="zoom-btn" id="zoom-in" title="Zoom In">+</button>\n        <button class="zoom-btn" id="zoom-reset" title="Reset Zoom">‚åÇ</button>\n      </div>\n    '}static getAIChatTemplate(){return'\n      <div class="ai-chat-container">\n        <div class="ai-chat-header">\n          <div class="ai-header-title">\n            <span class="ai-icon">ü§ñ</span>\n            <span>AI Diagram Assistant</span>\n          </div>\n          <div class="ai-header-status">Ready</div>\n        </div>\n        <div class="ai-chat-messages" id="ai-chat-messages">\n          <div class="ai-message">\n            <div class="ai-avatar">ü§ñ</div>\n            <div class="ai-text">\n              <strong>Hi! I\'m your AI Diagram Assistant.</strong><br/><br/>\n              I can help you modify Mermaid diagrams with natural language commands:<br/>\n              ‚Ä¢ "Add a new node called \'Database\'"<br/>\n              ‚Ä¢ "Change the color of node A to blue"<br/>\n              ‚Ä¢ "Add an arrow from A to B"<br/>\n              ‚Ä¢ "Make this flowchart more detailed"<br/><br/>\n              <em>Select a diagram above and describe what you want to change!</em>\n            </div>\n          </div>\n        </div>\n        <div class="ai-chat-input">\n          <div class="ai-input-container">\n            <textarea\n              id="ai-prompt-input"\n              placeholder="Describe how you want to modify the diagram..."\n              rows="2"\n            ></textarea>\n            <button id="ai-send-btn" class="ai-send-btn" title="Send message (Enter)">\n              <span class="send-icon">üì§</span>\n            </button>\n          </div>\n          <div class="ai-input-tips">\n            üí° <strong>Tips:</strong> Be specific about changes you want. Press Enter to send.\n          </div>\n        </div>\n      </div>\n    '}static applyPreviewStyles(e){return e.replace(/<h1>/g,"<h1 style='color: #333; margin: 24px 0 16px 0; font-size: 1.8rem; border-bottom: 2px solid #e1e5e9; padding-bottom: 8px;'>").replace(/<h2>/g,"<h2 style='color: #555; margin: 20px 0 12px 0; font-size: 1.4rem;'>").replace(/<h3>/g,"<h3 style='color: #666; margin: 16px 0 8px 0; font-size: 1.2rem;'>").replace(/<p>/g,"<p style='margin: 12px 0; line-height: 1.6; color: #333;'>").replace(/<ul>/g,"<ul style='margin: 12px 0; padding-left: 24px;'>").replace(/<li>/g,"<li style='margin: 4px 0; line-height: 1.5;'>").replace(/<table>/g,"<table style='border-collapse: collapse; width: 100%; margin: 20px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1);'>").replace(/<th>/g,"<th style='border: 1px solid #ddd; padding: 12px; background: #f8f9fa; font-weight: 600; text-align: left;'>").replace(/<td>/g,"<td style='border: 1px solid #ddd; padding: 12px; vertical-align: top;'>").replace(/<strong>/g,"<strong style='color: #2c3e50;'>").replace(/<code>/g,"<code style='background: #f1f3f4; padding: 2px 4px; border-radius: 3px; font-family: monospace; font-size: 0.9em;'>")}static createAIMessage(e,t){return`\n      <div class="ai-message">\n        <div class="ai-avatar" style="background: ${"user"===e?"#e5e7eb":"#3b82f6"};">${"user"===e?"üë§":"ü§ñ"}</div>\n        <div class="ai-text">${t}</div>\n      </div>\n    `}static createMermaidContainer(e){const t=document.createElement("div");return t.className="mermaid-diagram",t.id=`preview-mermaid-${e}`,t.style.cssText="margin: 20px 0; text-align: center; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;",t}}class StorageManager{static STORAGE_KEYS={CONFLUENCE_CONTENT_BACKUP:"confluence_content_backup",CONFLUENCE_CONTENT_DRAFT:"confluence_content_draft",MERMAID_DIAGRAM_MAPPINGS:"mermaid_diagram_mappings",MERMAID_DIAGRAM_MAPPINGS_DRAFT:"mermaid_diagram_mappings_draft",MERMAID_AI_FILENAME:"mermaid-ai-filename",MERMAID_DIAGRAM_INFO:"mermaid_diagram_info",CONFLUENCE_EDITOR_BACKUP:"confluence_editor_backup"};constructor(){this.STORAGE_KEY=StorageManager.STORAGE_KEYS.CONFLUENCE_CONTENT_BACKUP,this.AUTO_SAVE_INTERVAL=3e4,this.autoSaveTimer=null}static async getSettings(){try{return(await chrome.storage.sync.get([EXTENSION_SETTINGS_KEY]))[EXTENSION_SETTINGS_KEY]||DEFAULT_SETTINGS}catch(e){return console.error("Error loading settings:",e),DEFAULT_SETTINGS}}static async saveSettings(e){try{return await chrome.storage.sync.set({[EXTENSION_SETTINGS_KEY]:e}),!0}catch(e){return console.error("Error saving settings:",e),!1}}static async updateSetting(e,t){try{const o={...await this.getSettings(),[e]:t};return await this.saveSettings(o)}catch(e){return console.error("Error updating setting:",e),!1}}static async resetSettings(){try{return await chrome.storage.sync.remove([EXTENSION_SETTINGS_KEY]),!0}catch(e){return console.error("Error resetting settings:",e),!1}}static validateSettings(e){var t,o,n,r;const a={};if(null!==(t=e.apiKey)&&void 0!==t&&t.trim()||(a.apiKey="API Key l√† b·∫Øt bu·ªôc"),null!==(o=e.urlTemplate)&&void 0!==o&&o.trim()){const t=this.validateConfluencePageLink(e.urlTemplate);t.valid||(a.urlTemplate=t.error||"URL Template kh√¥ng h·ª£p l·ªá.")}else a.urlTemplate="URL Template l√† b·∫Øt bu·ªôc";return null!==(n=e.documentUrl)&&void 0!==n&&n.trim()?this.isValidUrl(e.documentUrl)||(a.documentUrl="URL kh√¥ng h·ª£p l·ªá"):a.documentUrl="URL th∆∞ m·ª•c l∆∞u t√†i li·ªáu l√† b·∫Øt bu·ªôc",null!==(r=e.databaseUrl)&&void 0!==r&&r.trim()?this.isValidUrl(e.databaseUrl)||(a.databaseUrl="URL kh√¥ng h·ª£p l·ªá"):a.databaseUrl="URL th∆∞ m·ª•c database l√† b·∫Øt bu·ªôc",{isValid:0===Object.keys(a).length,errors:a}}static getSettingKeys(){return Object.keys(DEFAULT_SETTINGS)}static async hasSettings(){try{return!!(await chrome.storage.sync.get([EXTENSION_SETTINGS_KEY]))[EXTENSION_SETTINGS_KEY]}catch(e){return console.error("Error checking settings existence:",e),!1}}static async getSetting(e){try{const t=await this.getSettings();return void 0!==t[e]?t[e]:DEFAULT_SETTINGS[e]}catch(t){return console.error(`Error getting setting ${e}:`,t),DEFAULT_SETTINGS[e]}}static async exportSettings(){try{const e=await this.getSettings();return JSON.stringify(e,null,2)}catch(e){throw console.error("Error exporting settings:",e),e}}static async importSettings(e){try{const t=JSON.parse(e),o=this.validateSettings(t);if(!o.isValid)throw new Error(o.message);return await this.saveSettings(t)}catch(e){return console.error("Error importing settings:",e),!1}}static async clearAllChromeStorage(){try{return await chrome.storage.sync.clear(),await chrome.storage.local.clear(),!0}catch(e){return console.error("Error clearing Chrome storage:",e),!1}}static isValidUrl(e){try{return new URL(e),!0}catch{return!1}}static validateConfluencePageLink(e){const t={valid:!1,error:null,pageId:null};if(!e||"string"!=typeof e||!e.trim())return t.error="URL l√† b·∫Øt bu·ªôc",t;let o;try{o=new URL(e.trim())}catch{return t.error="URL kh√¥ng h·ª£p l·ªá",t}const n=o.searchParams.get("pageId");if(n&&/^\d+$/.test(n))return t.valid=!0,t.pageId=n,t;const r=o.pathname.split("/"),a=r.indexOf("pages");if(a>=0&&r.length>a+1){const e=r[a+1];if(/^\d+$/.test(e))return t.valid=!0,t.pageId=e,t}return t.error="Kh√¥ng t√¨m th·∫•y pageId trong URL",t}async saveContent(e,t=null,o={}){const{enableLocalStorage:n=!0,enableCallback:r=!0,showNotification:a=!0}=o,i={localStorage:!1,callback:!1,errors:[]};if(n)try{this.saveToLocalStorage(e),i.localStorage=!0}catch(e){console.error("‚ùå Failed to save to localStorage:",e),i.errors.push(`localStorage: ${e.message}`)}if(r&&t)try{await this.callSaveCallback(t,e),i.callback=!0}catch(e){console.error("‚ùå Failed to save via callback:",e),i.errors.push(`callback: ${e.message}`)}return a&&this.showSaveNotification(i),i}saveToLocalStorage(e){const t={content:e,timestamp:Date.now(),version:"1.0"};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t))}loadFromLocalStorage(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(!e)return null;const t=JSON.parse(e);return Date.now()-t.timestamp>864e5?(console.log("üóëÔ∏è Removing old localStorage backup"),localStorage.removeItem(this.STORAGE_KEY),null):(console.log("üì¶ Loaded content from localStorage backup"),t.content)}catch(e){return console.error("‚ùå Failed to load from localStorage:",e),null}}clearLocalStorage(){localStorage.removeItem(this.STORAGE_KEY),console.log("üóëÔ∏è Cleared localStorage backup")}createDraftFromBackup(){try{const e=this.loadFromLocalStorage();if(!e)return console.warn("‚ö†Ô∏è No backup content found to create draft from"),null;const t={content:JSON.parse(JSON.stringify(e)),timestamp:Date.now(),version:"1.0",isDraft:!0};return localStorage.setItem(StorageManager.STORAGE_KEYS.CONFLUENCE_CONTENT_DRAFT,JSON.stringify(t)),console.log("‚úÖ Draft created from backup content:",{hasContent:!!t.content,timestamp:new Date(t.timestamp).toLocaleString()}),t.content}catch(e){return console.error("‚ùå Failed to create draft from backup:",e),null}}saveToDraft(e){try{const t={content:e,timestamp:Date.now(),version:"1.0",isDraft:!0};localStorage.setItem(StorageManager.STORAGE_KEYS.CONFLUENCE_CONTENT_DRAFT,JSON.stringify(t)),console.log("üíæ Content saved to draft:",{hasContent:!!e,timestamp:new Date(t.timestamp).toLocaleString()})}catch(e){console.error("‚ùå Failed to save to draft:",e)}}loadFromDraft(){try{const e=localStorage.getItem(StorageManager.STORAGE_KEYS.CONFLUENCE_CONTENT_DRAFT);if(!e)return null;const t=JSON.parse(e);return console.log("üìñ Loaded content from draft:",{hasContent:!!t.content,timestamp:new Date(t.timestamp).toLocaleString(),isDraft:t.isDraft}),t.content}catch(e){return console.error("‚ùå Failed to load from draft:",e),null}}commitDraftToBackup(){try{const e=this.loadFromDraft();return e?(this.saveToLocalStorage(e),this.clearDraft(),!0):(console.warn("‚ö†Ô∏è No draft content found to commit"),!1)}catch(e){return console.error("‚ùå Failed to commit draft to backup:",e),!1}}clearDraft(){try{localStorage.removeItem(StorageManager.STORAGE_KEYS.CONFLUENCE_CONTENT_DRAFT),console.log("üóëÔ∏è Draft cleared")}catch(e){console.error("‚ùå Failed to clear draft:",e)}}hasDraft(){try{return!!localStorage.getItem(StorageManager.STORAGE_KEYS.CONFLUENCE_CONTENT_DRAFT)}catch(e){return console.error("‚ùå Failed to check draft existence:",e),!1}}createMermaidDiagramMappingsDraft(){try{const e=this.getMermaidDiagramMappings(),t={mappings:Array.from(e.entries()),timestamp:Date.now(),version:"1.0",isDraft:!0};return localStorage.setItem(StorageManager.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS_DRAFT,JSON.stringify(t)),e}catch(e){return console.error("‚ùå Error creating Mermaid diagram mappings draft:",e),new Map}}saveMermaidDiagramMappingsToDraft(e){try{const t={mappings:Array.from(e.entries()),timestamp:Date.now(),version:"1.0",isDraft:!0};localStorage.setItem(StorageManager.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS_DRAFT,JSON.stringify(t))}catch(e){console.error("‚ùå Error saving Mermaid diagram mappings to draft:",e)}}loadMermaidDiagramMappingsFromDraft(){try{const e=localStorage.getItem(StorageManager.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS_DRAFT);if(!e)return null;const t=JSON.parse(e),o=new Map(t.mappings);return console.log("üîç DEBUG: Draft mappings keys:",Array.from(o.keys())),o}catch(e){return console.error("‚ùå Error loading Mermaid diagram mappings from draft:",e),null}}commitMermaidDiagramMappingsDraftToMain(){try{const e=this.loadMermaidDiagramMappingsFromDraft();return e?(this.getMermaidDiagramMappings(),console.log("üóëÔ∏è Clearing old main Mermaid diagram mappings..."),localStorage.removeItem(StorageManager.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS),localStorage.getItem(StorageManager.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS),console.log(`üìù Saving ${e.size} draft mappings as main mappings...`),this.saveMermaidDiagramMappings(e),this.getMermaidDiagramMappings(),this.clearMermaidDiagramMappingsDraft(),!0):(console.warn("‚ö†Ô∏è No draft mappings to commit"),!1)}catch(e){return console.error("‚ùå Error committing Mermaid diagram mappings draft:",e),!1}}clearMermaidDiagramMappingsDraft(){try{localStorage.removeItem(StorageManager.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS_DRAFT),console.log("üóëÔ∏è Cleared Mermaid diagram mappings draft")}catch(e){console.error("‚ùå Error clearing Mermaid diagram mappings draft:",e)}}hasMermaidDiagramMappingsDraft(){return!!localStorage.getItem(StorageManager.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS_DRAFT)}getMermaidDiagramMappingsWithDraft(){return this.loadMermaidDiagramMappingsFromDraft()||this.getMermaidDiagramMappings()}async callSaveCallback(e,t){if("function"!=typeof e)throw new Error("Save callback is not a function");const o=e(t);o&&"function"==typeof o.then&&await o}showSaveNotification(e){const{localStorage:t,callback:o,errors:n}=e;if(t&&o)this.showNotification("‚úÖ ƒê√£ l∆∞u thay ƒë·ªïi th√†nh c√¥ng","success");else if(t||o){const e=t?"localStorage":"callback";this.showNotification(`‚ö†Ô∏è ƒê√£ l∆∞u qua ${e} (m·ªôt ph·∫ßn)`,"warning")}else this.showNotification("‚ùå Kh√¥ng th·ªÉ l∆∞u thay ƒë·ªïi","error");n.length>0&&console.warn("Save errors:",n)}showNotification(e,t="info"){const o=document.createElement("div");o.className=`confluence-editor-notification ${t}`,o.style.cssText="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      padding: 12px 20px;\n      border-radius: 6px;\n      color: white;\n      font-family: Arial, sans-serif;\n      font-size: 14px;\n      z-index: 10001;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n      transition: all 0.3s ease;\n      max-width: 300px;\n    ";const n={success:"#28a745",warning:"#ffc107",error:"#dc3545",info:"#17a2b8"};o.style.background=n[t]||n.info,o.textContent=e,document.body.appendChild(o),setTimeout(()=>{o.parentNode&&(o.style.opacity="0",o.style.transform="translateX(100%)",setTimeout(()=>{o.remove()},300))},3e3)}startAutoSave(e){this.stopAutoSave(),this.autoSaveTimer=setInterval(()=>{try{e()}catch(e){console.error("‚ùå Auto-save failed:",e)}},this.AUTO_SAVE_INTERVAL),console.log("‚è∞ Auto-save started (every 30 seconds)")}stopAutoSave(){this.autoSaveTimer&&(clearInterval(this.autoSaveTimer),this.autoSaveTimer=null,console.log("‚èπÔ∏è Auto-save stopped"))}hasUnsavedChanges(e){const t=this.loadFromLocalStorage();if(!t)return!1;try{return JSON.stringify(e)!==JSON.stringify(t)}catch(e){return console.error("‚ùå Error comparing content:",e),!1}}getBackupInfo(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(!e)return null;const t=JSON.parse(e);return{timestamp:t.timestamp,age:Date.now()-t.timestamp,version:t.version}}catch(e){return null}}async getItem(e){try{const t=localStorage.getItem(e);return t?JSON.parse(t):null}catch(t){return console.error(`‚ùå Error getting item from localStorage (${e}):`,t),null}}async setItem(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(t){throw console.error(`‚ùå Error setting item to localStorage (${e}):`,t),t}}async removeItem(e){try{localStorage.removeItem(e)}catch(t){throw console.error(`‚ùå Error removing item from localStorage (${e}):`,t),t}}saveMermaidDiagramMappings(e){try{if(!e||0===e.size)return console.log("üóÇÔ∏è No diagrams to save, clearing mappings"),localStorage.removeItem(StorageManager.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS),!0;const t={};return e.forEach((e,o)=>{t[o]={title:e.title,type:e.type,content:e.content,originCode:e.originCode,timestamp:Date.now()}}),localStorage.setItem(StorageManager.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS,JSON.stringify(t)),console.log(`‚úÖ Saved ${e.size} Mermaid diagram mappings to localStorage`),!0}catch(e){return console.error("‚ùå Error saving Mermaid diagram mappings:",e),!1}}getMermaidDiagramMappings(){try{const e=localStorage.getItem(StorageManager.STORAGE_KEYS.MERMAID_DIAGRAM_MAPPINGS);if(!e)return new Map;const t=JSON.parse(e),o=new Map;return Object.entries(t).forEach(([e,t])=>{o.set(e,t)}),console.log(`üìä Loaded ${o.size} Mermaid diagram mappings from localStorage`),o}catch(e){return console.error("‚ùå Error loading Mermaid diagram mappings:",e),new Map}}async clearAllKToolData(){const e=Object.values(StorageManager.STORAGE_KEYS),t=[],o=[];for(const n of e)try{await this.removeItem(n),t.push(n)}catch(e){o.push({key:n,error:e.message})}return o.length>0&&console.warn("‚ö†Ô∏è Failed to clear some keys:",o),{clearedKeys:t,failedKeys:o}}}class ConfluenceEditor{constructor(){this.isEditorOpen=!1,this.currentContent=null,this.originalContent=null,this.onSave=null,this.mermaidDiagrams=[],this.currentSelectedDiagram=null,this.currentSelectedDiagramId=null,this.editorContainer=null,this.textEditor=null,this.richTextEditor=null,this.tipTapEditor=null,this.previewContainer=null,this.isPreviewMode=!1,this.autoSaveTimer=null,this.isModified=!1,this.richTextNeedsRefresh=!1,this.currentZoom=1,this.dragOffset={x:0,y:0},this.isZooming=!1,this.zoomStep=.25,this.minZoom=.25,this.maxZoom=3,this.previewUpdateTimeout=null,this.isUpdatingPreview=!1,this.storageManager=new StorageManager,this.contentSynchronizer=new ContentSynchronizer}openEditor(e,t={}){this.isEditorOpen&&this.closeEditor();const o=this.storageManager.loadFromDraft();if(o&&!1!==t.allowBackupRestore)this.currentContent=o;else{const o=this.storageManager.loadFromLocalStorage();o&&!1!==t.allowBackupRestore?this.currentContent=o:(this.currentContent=e,e&&(this.storageManager.saveToLocalStorage(e),console.log("ÔøΩ Initial content saved to localStorage backup")))}this.originalContent=JSON.parse(JSON.stringify(e)),this.isEditorOpen=!0,this.storageManager.hasDraft()||this.storageManager.createDraftFromBackup()||console.warn("‚ö†Ô∏è Failed to create draft - using backup content directly"),this.storageManager.hasMermaidDiagramMappingsDraft()||this.storageManager.createMermaidDiagramMappingsDraft()||console.warn("‚ö†Ô∏è Failed to create Mermaid diagram mappings draft"),this.extractMermaidDiagrams(),this.createEditorUI(t),this.initializeRichTextTab()}createEditorUI(){const e=DOMHelpers.createElement("div",{className:"confluence-editor-overlay"});DOMHelpers.setContent(e,HTMLTemplates.getEditorTemplate(),!0),document.body.appendChild(e),this.editorContainer=e,this.bindEditorEvents()}bindEditorEvents(){if(!this.editorContainer)return;const e=DOMHelpers.querySelector(this.editorContainer,"#editor-close-btn");e?DOMHelpers.addEventListener(e,"click",()=>{this.closeEditor()}):console.error("‚ùå Close button not found!");const t=DOMHelpers.querySelector(this.editorContainer,"#editor-save-btn");t?DOMHelpers.addEventListener(t,"click",()=>{this.saveChanges()}):console.error("‚ùå Save button not found!");const o=DOMHelpers.querySelector(this.editorContainer,"#rich-text-tab"),n=DOMHelpers.querySelector(this.editorContainer,"#mermaid-tab");DOMHelpers.addEventListener(o,"click",()=>this.switchTab("rich-text")),DOMHelpers.addEventListener(n,"click",()=>this.switchTab("mermaid"));const r=DOMHelpers.querySelector(this.editorContainer,"#mermaid-selector"),a=DOMHelpers.querySelector(this.editorContainer,"#mermaid-code-editor"),i=DOMHelpers.querySelector(this.editorContainer,"#ai-send-btn"),s=DOMHelpers.querySelector(this.editorContainer,"#ai-prompt-input");DOMHelpers.addEventListener(r,"change",e=>this.selectMermaidDiagram(e.target.value)),DOMHelpers.addEventListener(a,"input",()=>{this.debouncedUpdateMermaidPreview()}),DOMHelpers.addEventListener(i,"click",()=>this.sendAIPrompt()),DOMHelpers.addEventListener(s,"keypress",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendAIPrompt())});const l=DOMHelpers.querySelector(this.editorContainer,"#zoom-in"),c=DOMHelpers.querySelector(this.editorContainer,"#zoom-out"),d=DOMHelpers.querySelector(this.editorContainer,"#zoom-reset");DOMHelpers.addEventListener(l,"click",()=>this.zoomIn()),DOMHelpers.addEventListener(c,"click",()=>this.zoomOut()),DOMHelpers.addEventListener(d,"click",()=>this.resetZoom());const m=DOMHelpers.querySelector(this.editorContainer,"#mermaid-preview");DOMHelpers.addEventListener(m,"wheel",e=>this.handleWheel(e)),DOMHelpers.addEventListener(this.editorContainer,"click",e=>{e.target===this.editorContainer&&this.closeEditor()});const g=e=>{"Escape"===e.key&&(this.closeEditor(),DOMHelpers.removeEventListener(document,"keydown",g))};DOMHelpers.addEventListener(document,"keydown",g)}switchTab(e){DOMHelpers.querySelectorAll(this.editorContainer,".confluence-editor-tab").forEach(e=>DOMHelpers.removeClass(e,"active"));const t=DOMHelpers.querySelector(this.editorContainer,`#${e}-tab`);DOMHelpers.addClass(t,"active"),DOMHelpers.querySelectorAll(this.editorContainer,".tab-content").forEach(e=>DOMHelpers.removeClass(e,"active"));const o=DOMHelpers.querySelector(this.editorContainer,`#${e}-tab-content`);DOMHelpers.addClass(o,"active"),"rich-text"===e?(this.initializeRichTextTab(),this.initializeMermaidTab(),this.richTextNeedsRefresh?(console.log("üîÑ Rich Text tab needs refresh due to Mermaid changes, refreshing..."),setTimeout(()=>{console.log("üîÑ Executing delayed refresh for Rich Text tab..."),this.forceRefreshRichTextTab(),this.richTextNeedsRefresh=!1},100)):console.log("‚ÑπÔ∏è Rich Text tab does not need refresh")):"mermaid"===e&&this.initializeMermaidTab(),console.log(`Switched to ${e} tab`)}getCurrentEditorContent(){if(this.tipTapEditor&&this.tipTapEditor.isReady()){const e=this.tipTapEditor.getHTML()||"";return console.log("üé® Got content from TipTap editor:",{length:e.length,preview:e.substring(0,200),hasContent:e.length>0}),e}return console.warn("‚ö†Ô∏è TipTap editor not ready or not found"),""}async initializeRichTextTab(){const e=DOMHelpers.querySelector(this.editorContainer,"#tiptap-editor-container");if(!e)return void console.warn("‚ö†Ô∏è Rich Text editor container not found");e.style.display="block";const t=DOMHelpers.querySelector(this.editorContainer,"#raw-content-editor");t&&t.classList.add("hidden");try{if(!window.TipTapEditor)throw new Error("TipTapEditor not found in global scope. Make sure tiptap.js is loaded.");this.tipTapEditor&&this.tipTapEditor.isReady()||(this.tipTapEditor=new window.TipTapEditor(e,{placeholder:"Start writing your rich content..."}),await this.waitForTipTapEditor()),console.log("ÔøΩ Loading content from draft or backup...");let t=this.storageManager.loadFromDraft(),o="draft";if(t||(t=this.storageManager.loadFromLocalStorage(),o="backup"),t){console.log(`ÔøΩ Found ${o} content, loading into Rich Text editor`);let e=t.full_storage_format||t.content||"";e=XMLFormatter.cleanXMLMarkers(e),e=await this.processMermaidInContentSync(e),await this.tipTapEditor.setHTML(e),console.log(`‚úÖ Rich Text content loaded from ${o}`),this.currentContent=t}else console.log("üîç Editor already has content, preserving existing content:",currentEditorContent.substring(0,100));this.setupRichTextEventListeners()}catch(t){console.error("‚ùå Failed to initialize Rich Text tab:",t),this.createFallbackRichTextEditor(e)}}async waitForTipTapEditor(){let e=0;for(;!this.tipTapEditor.isReady()&&e<5e3;)await new Promise(e=>setTimeout(e,100)),e+=100;if(!this.tipTapEditor.isReady())throw new Error("TipTap Editor failed to initialize within timeout")}createFallbackRichTextEditor(e){e.innerHTML='\n      <div class="rich-text-fallback">\n        <div class="fallback-notice">\n          ‚ö†Ô∏è TipTap editor failed to load. Using fallback editor.\n        </div>\n        <textarea\n          class="rich-text-editor-fallback"\n          id="rich-text-editor-fallback"\n          placeholder="Enter your rich content here... (HTML supported)"\n        ></textarea>\n      </div>\n    ';const t=e.querySelector("#rich-text-editor-fallback");if(this.currentContent){let e=this.currentContent.full_storage_format||this.currentContent.content||"";e=XMLFormatter.cleanXMLMarkers(e),t.value=e}this.setupRichTextFallbackEventListeners(t)}setupRichTextEventListeners(){this.tipTapEditor&&this.tipTapEditor.isReady()?(console.log("üîó Setting up Rich Text event listeners..."),this.tipTapEditor.container.addEventListener("tipTapTextChange",()=>{this.isModified=!0,this.storageManager.startAutoSave(()=>this.saveToLocalStorage())})):console.warn("‚ö†Ô∏è Cannot setup Rich Text event listeners - editor not ready")}setupRichTextFallbackEventListeners(e){e.addEventListener("input",()=>{this.isModified=!0,this.storageManager.startAutoSave(()=>this.saveToLocalStorage())})}initializeMermaidTab(){const e=this.getCurrentEditorContent();this.currentContent&&e&&(this.currentContent.full_storage_format=e,this.storageManager.saveToDraft(this.currentContent)),this.extractMermaidDiagrams(),console.log("Diagrams available:",this.mermaidDiagrams.length),this.populateMermaidSelector()}isMermaidDiagram(e){const t=e.split("\n")[0].trim().toLowerCase();return["graph","flowchart","sequenceDiagram","classDiagram","stateDiagram","erDiagram","journey","gantt","pie","gitgraph","mindmap","timeline"].some(e=>t.includes(e))}debounce(e,t){let o;return function(...n){clearTimeout(o),o=setTimeout(()=>{clearTimeout(o),e(...n)},t)}}updateContentPreview(){const e=DOMHelpers.querySelector(this.editorContainer,"#content-preview");if(!e)return;const t=this.getCurrentEditorContent();this.currentContent&&(this.currentContent.full_storage_format=t,this.originalContent&&t!==this.originalContent.full_storage_format&&(this.isModified=!0,this.updateSaveButtonState())),this.renderContentPreview(t,e)}renderContentPreview(e,t){const o=HTMLTemplates.applyPreviewStyles(e);DOMHelpers.setContent(t,o,!0),this.renderMermaidDiagramsInPreview()}renderMermaidDiagramsInPreview(){setTimeout(()=>{this.initializeMermaidInPreview()},100)}async initializeMermaidInPreview(){try{await mermaidRenderer.Z.initializeMermaid();const e=DOMHelpers.querySelector(this.editorContainer,"#content-preview");if(!e)return;DOMHelpers.querySelectorAll(e,'ac\\:structured-macro[ac\\:name="mermaid"]').forEach(async(e,t)=>{const o=DOMHelpers.querySelector(e,'ac\\:parameter[ac\\:name="code"]');if(!o)return void console.warn("‚ö†Ô∏è Mermaid macro found but no code parameter");const n=DOMHelpers.getContent(o).trim();if(console.log("üîç Found Confluence Mermaid diagram:",n.substring(0,50)+"..."),n){const o=HTMLTemplates.createMermaidContainer(t);if(!e.parentNode)return console.error("‚ùå Cannot replace Mermaid element in preview: no parent node"),void console.error("‚ùå Mermaid code:",n.substring(0,100)+"...");try{e.parentNode.replaceChild(o,e)}catch(e){return console.error("‚ùå Failed to replace Mermaid element in preview:",e),void console.error("‚ùå Mermaid code:",n.substring(0,100)+"...")}const r=`preview-mermaid-svg-${t}`;await mermaidRenderer.Z.renderDiagram(r,n,o)}})}catch(e){console.error("‚ùå Failed to initialize Mermaid in preview:",e)}}populateMermaidSelector(){const e=DOMHelpers.querySelector(this.editorContainer,"#mermaid-selector");if(!e)return void console.error("‚ùå Mermaid selector not found");e.innerHTML="";const t=document.createElement("option");t.value="",t.textContent="üìä Select diagram to edit...",e.appendChild(t);const o=this.storageManager.getMermaidDiagramMappingsWithDraft();if(console.log(`üìä Found ${(null==o?void 0:o.size)||0} diagrams in Mermaid diagram mappings (draft or main)`),o&&o.size>0){let t=0;o.forEach((o,n)=>{if(o.content&&o.content.trim()){const r=document.createElement("option");r.value=n,r.textContent=`${o.title} (${o.type})`,e.appendChild(r),t++,console.log(`üìä Added option ${t}: ${o.title} (${o.type})`)}}),console.log(`‚úÖ Added ${t} diagrams to selector (total options: ${e.options.length})`)}else console.warn("‚ö†Ô∏è No Mermaid diagrams found in MERMAID_DIAGRAM_MAPPINGS");this.handleMermaidSelectorChange&&e.removeEventListener("change",this.handleMermaidSelectorChange),this.handleMermaidSelectorChange=e=>{const t=e.target.value;console.log(`üéØ Selected diagram: ${t}`),this.selectMermaidDiagram(t)},e.addEventListener("change",this.handleMermaidSelectorChange),console.log(`‚úÖ Populated ${(null==o?void 0:o.size)||0} diagrams in selector`)}selectMermaidDiagram(e){if(console.log(`üéØ selectMermaidDiagram called with ID: ${e}`),!e)return void this.clearMermaidEditor();console.log(`üìä Loading diagram ${e} from Mermaid diagram mappings...`);const t=this.storageManager.getMermaidDiagramMappingsWithDraft(),o=null==t?void 0:t.get(e);if(!o)return void console.error(`‚ùå Diagram not found in Mermaid diagram mappings: ${e}`);console.log(`üìä Found diagram ${e} in Mermaid diagram mappings`);const n={id:e,title:o.title,type:o.type,code:o.content,originCode:o.originCode},r=this.editorContainer.querySelector("#mermaid-code-editor");var a;r&&(r.value=o.content,this.currentSelectedDiagram=n,this.currentSelectedDiagramId=e,console.log("‚úÖ Diagram selected successfully:",{diagramId:this.currentSelectedDiagramId,diagramTitle:null==n?void 0:n.title,diagramType:null==n?void 0:n.type,hasContent:!!o.content,contentLength:(null===(a=o.content)||void 0===a?void 0:a.length)||0}),this.updateMermaidPreview().catch(e=>{console.error("‚ùå Error updating Mermaid preview:",e)}),r.removeEventListener("input",this.handleMermaidCodeChange),this.handleMermaidCodeChange=()=>{if(this.currentSelectedDiagram&&this.currentSelectedDiagramId){const e=r.value;console.log("new code",e),this.currentSelectedDiagram.code=e;const t=this.storageManager.getMermaidDiagramMappingsWithDraft(),o=t.get(this.currentSelectedDiagramId);o?(o.content=e,o.originCode=`<ac:structured-macro ac:name="mermaid" ac:schema-version="1">\n  <ac:parameter ac:name="code">\n${e}\n  </ac:parameter>\n</ac:structured-macro>`,t.set(this.currentSelectedDiagramId,o),console.log(`üìù Updated diagram ${this.currentSelectedDiagramId} in draft mappings with new originCode`)):(t.set(this.currentSelectedDiagramId,{title:this.currentSelectedDiagram.title,type:this.currentSelectedDiagram.type,content:e,originCode:this.currentSelectedDiagram.originCode}),console.log(`üìù Added new diagram ${this.currentSelectedDiagramId} to draft mappings`)),this.storageManager.saveMermaidDiagramMappingsToDraft(t),this.contentSynchronizer.trackDiagramChange(this.currentSelectedDiagramId,e),this.debouncedUpdateMermaidPreview(),this.isModified=!0,this.updateSaveButtonState(),this.syncDiagramWithDraftContent(this.currentSelectedDiagramId,e),console.log(`üìù Updated diagram ${this.currentSelectedDiagramId} in draft mappings and synced with draft content`)}},r.addEventListener("input",this.handleMermaidCodeChange)),console.log(`‚úÖ Selected diagram: ${e} (${o.type})`)}clearMermaidEditor(){const e=this.editorContainer.querySelector("#mermaid-code-editor"),t=this.editorContainer.querySelector("#mermaid-preview");e&&(e.value=""),t&&(t.innerHTML='<div class="mermaid-placeholder">Select a diagram to preview</div>'),this.currentSelectedDiagram=null}debouncedUpdateMermaidPreview(){this.isZooming||(this.previewUpdateTimeout&&clearTimeout(this.previewUpdateTimeout),this.previewUpdateTimeout=setTimeout(()=>{this.isZooming||this.isUpdatingPreview||this.updateMermaidPreview().catch(e=>{console.error("‚ùå Error updating Mermaid preview:",e)})},300))}async updateMermaidPreview(){if(this.isZooming)return;if(this.isUpdatingPreview)return;this.isUpdatingPreview=!0;const e=this.editorContainer.querySelector("#mermaid-code-editor"),t=this.editorContainer.querySelector("#mermaid-preview");if(!e||!t)return;const o=e.value.trim();if(!o)return void(t.innerHTML='<div class="mermaid-placeholder">Enter Mermaid code to preview</div>');const n=this.currentZoom;this.currentSelectedDiagram&&(this.currentSelectedDiagram.code=o);try{t.innerHTML='<div class="mermaid-placeholder">Rendering diagram...</div>';const e=`mermaid-editor-preview-${Date.now()}`;await mermaidRenderer.Z.renderDiagram(e,o,t),setTimeout(()=>{1!==n&&(this.currentZoom=n),this.updateZoom()},100)}catch(e){console.error("‚ùå Error rendering Mermaid in editor preview:",e),t.innerHTML=`\n        <div class="mermaid-placeholder" style="color: #dc3545;">\n          ‚ùå Error rendering diagram:<br>\n          <small>${e.message}</small>\n        </div>\n      `}finally{this.isUpdatingPreview=!1}}async sendAIPrompt(){var e;const t=this.editorContainer.querySelector("#ai-prompt-input"),o=this.editorContainer.querySelector("#ai-chat-messages");if(!t||!o)return;const n=t.value.trim();if(!n)return;const r=this.editorContainer.querySelector("#mermaid-diagram-selector"),a=this.editorContainer.querySelector("#mermaid-code-editor"),i=null==r?void 0:r.value,s=null==a||null===(e=a.value)||void 0===e?void 0:e.trim(),l=this.storageManager.getMermaidDiagramMappings();if((!this.currentSelectedDiagram||!this.currentSelectedDiagramId)&&i&&s){const e=null==l?void 0:l.get(i);e?(this.currentSelectedDiagramId=i,this.currentSelectedDiagram={id:i,title:e.title,type:e.type,code:s,originCode:e.originCode}):i&&s&&(this.currentSelectedDiagramId=i,this.currentSelectedDiagram={id:i,title:`Diagram ${i}`,type:"unknown",code:s,originCode:s})}if(!this.currentSelectedDiagram||!this.currentSelectedDiagramId)return console.warn("‚ùå No diagram selected for AI editing"),void this.addAIMessage("ai","‚ö†Ô∏è Please select a Mermaid diagram first to edit it.");if(null==l?void 0:l.get(this.currentSelectedDiagramId)){this.addAIMessage("user",n),t.value="",this.addAIMessage("ai","ü§ñ Processing your request...");try{var c;const e=await StorageManager.getSettings(),t={content:(null===(c=this.currentContent)||void 0===c?void 0:c.full_storage_format)||"",diagram_code:this.currentSelectedDiagram.code,user_request:n,selectedModel:e.selectedModel||"sonar-pro"};console.log("ü§ñ Sending AI request:",t);const o=await fetch(API_URLS.EDIT_DIAGRAM,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!o.ok){const e=await o.json();throw new Error(e.error||`HTTP ${o.status}: ${o.statusText}`)}const r=await o.json();if(!r.success||!r.edited_diagram)throw new Error("Invalid response format or missing edited_diagram");{const e=this.cleanAIResponse(r.edited_diagram);if(!e||!e.trim())throw new Error("Invalid Mermaid syntax in AI response");{var d;const t=this.storageManager.getMermaidDiagramMappingsWithDraft(),o=t.get(this.currentSelectedDiagramId);if(!o)throw new Error("Selected diagram no longer exists");console.log(`üîÑ Updating diagram ${this.currentSelectedDiagramId}:`,{oldCode:(null===(d=this.currentSelectedDiagram.code)||void 0===d?void 0:d.substring(0,30))+"...",newCode:e.substring(0,30)+"..."}),this.currentSelectedDiagram.code=e,o.content=e,o.originCode=`<ac:structured-macro ac:name="mermaid" ac:schema-version="1">\n  <ac:parameter ac:name="code">\n${e}\n  </ac:parameter>\n</ac:structured-macro>`,t.set(this.currentSelectedDiagramId,o),this.storageManager.saveMermaidDiagramMappingsToDraft(t),console.log("‚úÖ AI updated diagram saved to draft mappings with new originCode");const r=this.editorContainer.querySelector("#mermaid-code-editor");r&&(r.value=e),this.updateMermaidPreview().catch(e=>{console.error("‚ùå Error updating Mermaid preview:",e)}),await this.syncDiagramWithDraftContent(this.currentSelectedDiagramId,e),console.log(`üîÑ Diagram ${this.currentSelectedDiagramId} updated by AI and synced with backup content`),this.removeLastAIMessage(),this.addAIMessage("ai",`‚úÖ Updated diagram: ${n}`),"undefined"!=typeof window&&window.KToolNotificationUtils&&window.KToolNotificationUtils.success("AI Assistant","Diagram updated successfully!")}}}catch(e){console.error("‚ùå AI API Error:",e),this.removeLastAIMessage(),this.addAIMessage("ai",`‚ùå Error: ${e.message}\n\nüîÑ Please try again or adjust your request.`),"undefined"!=typeof window&&window.KToolNotificationUtils&&window.KToolNotificationUtils.error("AI Assistant",`Error: ${e.message}`)}}else this.addAIMessage("ai","‚ùå Selected diagram not found. Please select a valid diagram.")}cleanAIResponse(e){if(!e)return"";console.log("üßπ Cleaning AI response:",e.substring(0,100)+"...");let t=e.replace(/```mermaid\n?/gi,"").replace(/```\n?/g,"").replace(/^Here's the updated.*?:\s*/i,"").replace(/^Updated diagram.*?:\s*/i,"").replace(/^The modified.*?:\s*/i,"");t=t.trim();const o=t.split("\n"),n=o.findIndex(e=>""!==e.trim()),r=o.slice().reverse().findIndex(e=>""!==e.trim());-1!==n&&-1!==r&&(t=o.slice(n,o.length-r).join("\n"));const a=["graph","flowchart","sequenceDiagram","classDiagram","stateDiagram","erDiagram","journey","gantt","pie","gitgraph","mindmap","timeline"],i=t.split("\n")[0].trim().toLowerCase();return a.some(e=>i.startsWith(e.toLowerCase()))||(console.warn("‚ö†Ô∏è AI response may not be valid Mermaid syntax:",i),console.warn("Expected to start with one of:",a.join(", "))),console.log("‚úÖ Cleaned AI response:",t.substring(0,100)+"..."),t}removeLastAIMessage(){const e=this.editorContainer.querySelector("#ai-chat-messages");if(!e)return;const t=e.querySelectorAll(".ai-message");if(t.length>0){const e=t[t.length-1];e.querySelector(".ai-text").textContent.includes("Processing")&&e.remove()}}addAIMessage(e,t){const o=DOMHelpers.querySelector(this.editorContainer,"#ai-chat-messages");if(!o)return;const n=HTMLTemplates.createAIMessage(e,t);DOMHelpers.setContent(o,DOMHelpers.getContent(o)+n,!0),o.scrollTop=o.scrollHeight}async syncDiagramWithDraftContent(e,t){try{console.log(`üîÑ Syncing diagram ${e} with draft content...`);if(!this.storageManager.getMermaidDiagramMappingsWithDraft().get(e))return void console.error(`‚ùå Diagram ${e} not found in draft mappings`);console.log(`üñºÔ∏è Generating new image for diagram ${e}...`);const o=await this.generateMermaidImage(t);if(!o)return void console.error(`‚ùå Failed to generate image for diagram ${e}`);let n=this.storageManager.loadFromDraft();if(n||(n=this.storageManager.loadFromLocalStorage()),!n||!n.full_storage_format)return void console.error("‚ùå No content found to sync with");let r=n.full_storage_format;const a=new RegExp(`<img[^>]*id="${e}"[^>]*>`,"g"),i=`<img id="${e}" src="${o}" alt="Mermaid Diagram" style="max-width: 100%; height: auto;" data-mermaid-id="${e}" />`;console.log(`üé® Generated new image HTML for diagram ${e}:`,i),r=r.replace(a,i),console.log(`‚úÖ Replaced image for diagram ${e} in draft content`),n.full_storage_format=r,this.storageManager.saveToDraft(n),this.currentContent&&(this.currentContent.full_storage_format=r),console.log(`‚úÖ Successfully synced diagram ${e} with draft content`),this.refreshRichTextTabIfActive(),this.richTextNeedsRefresh=!0}catch(t){console.error(`‚ùå Error syncing diagram ${e} with draft content:`,t)}}async refreshRichTextTabIfActive(){try{const e=this.editorContainer.querySelector("#rich-text-tab"),t=this.editorContainer.querySelector("#rich-text-tab-content");e&&t&&e.classList.contains("active")&&t.classList.contains("active")&&await this.forceRefreshRichTextTab()}catch(e){console.error("‚ùå Error refreshing Rich Text tab:",e)}}async forceRefreshRichTextTab(){try{var e;console.log("üîÑ Force refreshing Rich Text tab with latest draft content...");const t=this.storageManager.loadFromDraft();if(console.log("üîç DEBUG: Draft content for refresh:",{exists:!!t,hasFullFormat:!(null==t||!t.full_storage_format),contentLength:(null==t||null===(e=t.full_storage_format)||void 0===e?void 0:e.length)||0}),t&&this.tipTapEditor&&this.tipTapEditor.isReady()){let e=t.full_storage_format||t.content||"";e=XMLFormatter.cleanXMLMarkers(e),e=await this.processMermaidInContentSync(e),await this.tipTapEditor.setHTML(e),console.log("‚úÖ Rich Text tab force refreshed with updated content")}else console.warn("‚ö†Ô∏è Cannot force refresh Rich Text tab - missing draft content or editor not ready")}catch(e){console.error("‚ùå Error force refreshing Rich Text tab:",e)}}async syncDiagramWithBackupContent(e,t){try{console.log(`üîÑ Syncing diagram ${e} with backup content...`);if(!this.storageManager.getMermaidDiagramMappings().get(e))return void console.error(`‚ùå Diagram ${e} not found in mappings`);console.log(`üñºÔ∏è Generating new image for diagram ${e}...`);const o=await this.generateMermaidImage(t);if(!o)return void console.error(`‚ùå Failed to generate image for diagram ${e}`);let n=this.storageManager.loadFromDraft();if(n||(n=this.storageManager.loadFromLocalStorage()),!n||!n.full_storage_format)return void console.error("‚ùå No content found to sync with");let r=n.full_storage_format;const a=new RegExp(`<img[^>]*id="${e}"[^>]*>`,"g"),i=`<img id="${e}" src="${o}" alt="Mermaid Diagram" style="max-width: 100%; height: auto;" data-mermaid-id="${e}" />`;console.log(`üé® Generated new image HTML for diagram ${e}:`,i),r=r.replace(a,i),console.log(`‚úÖ Replaced image for diagram ${e} in content`),n.full_storage_format=r,this.storageManager.saveToDraft(n),this.currentContent&&(this.currentContent.full_storage_format=r),console.log(`‚úÖ Successfully synced diagram ${e} with draft content`)}catch(t){console.error(`‚ùå Error syncing diagram ${e} with backup content:`,t)}}extractMermaidDiagrams(){var e,t,o;if(null===(e=this.currentContent)||void 0===e||!e.full_storage_format)return console.warn("‚ö†Ô∏è No content to extract diagrams from:",{hasCurrentContent:!!this.currentContent,hasFullStorageFormat:!(null===(t=this.currentContent)||void 0===t||!t.full_storage_format),contentLength:(null===(o=this.currentContent)||void 0===o||null===(o=o.full_storage_format)||void 0===o?void 0:o.length)||0}),void(this.mermaidDiagrams=[]);const{diagrams:n,diagramsMap:r}=mermaidRenderer.Z.extractMermaidDiagrams(this.currentContent.full_storage_format);this.mermaidDiagrams=n;const a=this.storageManager.getMermaidDiagramMappings();r.forEach((e,t)=>{a.has(t)?console.log(`üìä Preserving existing diagram: ${e.title}`):(console.log(`üìä Adding new diagram to mappings: ${e.title}`),a.set(t,e))}),this.storageManager.saveMermaidDiagramMappings(a)}updateStatus(e){var t;const o=null===(t=this.editorContainer)||void 0===t?void 0:t.querySelector("#editor-status");o&&(o.textContent=e,setTimeout(()=>{o.textContent="S·∫µn s√†ng"},3e3))}saveToLocalStorage(){try{var e;let t=this.storageManager.loadFromDraft();const o=this.getCurrentEditorContent();if(t){const e=document.querySelector(".confluence-editor-tab.active");e&&"rich-text-tab"===e.id&&o?(t.full_storage_format=o,t.content=o,console.log("üìù Updated draft with Rich Text editor content")):console.log("üìù Using existing draft content (contains Mermaid changes)")}else{if(!o)return void console.warn("‚ö†Ô∏è No content available to save");t=this.storageManager.loadFromLocalStorage()||this.currentContent||{},t.full_storage_format=o,t.content=o,console.log("üìù Created new draft from Rich Text editor content")}this.storageManager.saveToDraft(t),this.currentContent=t,console.log("‚úÖ Content auto-saved to draft:",{contentLength:(null===(e=t.full_storage_format)||void 0===e?void 0:e.length)||0,timestamp:(new Date).toLocaleTimeString()})}catch(e){console.error("‚ùå Failed to auto-save to draft:",e)}}async saveChanges(){try{var e,t;if(this.saveToLocalStorage(),!this.storageManager.commitDraftToBackup())return void console.warn("‚ö†Ô∏è Failed to commit draft to backup");this.currentContent=this.storageManager.loadFromLocalStorage(),this.storageManager.commitMermaidDiagramMappingsDraftToMain()?console.log("‚úÖ Committed Mermaid diagram mappings draft to main successfully"):console.warn("‚ö†Ô∏è Failed to commit Mermaid diagram mappings draft"),this.currentContent=this.contentSynchronizer.syncAllContent(this.currentContent,this.editorContainer,this.mermaidDiagrams);const o=this.contentSynchronizer.validateContent(this.currentContent);if(!o.isValid)throw new Error(`Content validation failed: ${o.errors.join(", ")}`);console.log("üíæ Final content being saved:",{length:(null===(e=this.currentContent.full_storage_format)||void 0===e?void 0:e.length)||0,preview:(null===(t=this.currentContent.full_storage_format)||void 0===t?void 0:t.substring(0,200))||"empty"}),await this.storageManager.saveContent(this.currentContent,this.onSave,{enableLocalStorage:!0,enableCallback:!0,showNotification:!0}),this.isModified=!1,this.updateSaveButtonState(),this.originalContent=JSON.parse(JSON.stringify(this.currentContent)),this.closeEditor()}catch(e){console.error("‚ùå Error saving changes:",e),this.storageManager.showNotification(`‚ùå L·ªói khi l∆∞u: ${e.message}`,"error")}}updateSaveButtonState(){const e=DOMHelpers.querySelector(this.editorContainer,"#editor-save-btn");e&&(DOMHelpers.setContent(e,"üíæ Save"),e.style.background="#007bff",this.isModified?e.title="C√≥ thay ƒë·ªïi ch∆∞a l∆∞u - Click ƒë·ªÉ l∆∞u":e.title="Save")}stopAllPreviewUpdates(){this.previewUpdateTimeout&&(clearTimeout(this.previewUpdateTimeout),this.previewUpdateTimeout=null),this.isZooming=!0,this.isUpdatingPreview=!1}zoomIn(){this.currentZoom<this.maxZoom&&(this.stopAllPreviewUpdates(),this.currentZoom=Math.min(this.currentZoom+this.zoomStep,this.maxZoom),this.applyZoom())}zoomOut(){this.currentZoom>this.minZoom&&(this.stopAllPreviewUpdates(),this.currentZoom=Math.max(this.currentZoom-this.zoomStep,this.minZoom),this.applyZoom())}resetZoom(){this.stopAllPreviewUpdates(),this.currentZoom=1,this.dragOffset={x:0,y:0},this.applyZoom()}applyZoom(){this.isZooming=!0,this.previewUpdateTimeout&&(clearTimeout(this.previewUpdateTimeout),this.previewUpdateTimeout=null),this.updateZoom(),setTimeout(()=>{this.isZooming=!1},100)}updateZoom(){const e=DOMHelpers.querySelector(this.editorContainer,"#mermaid-preview"),t=DOMHelpers.querySelector(this.editorContainer,"#zoom-level");if(e){const t=DOMHelpers.querySelector(e,".mermaid, svg");t&&(t.style.transform=`scale(${this.currentZoom}) translate(${this.dragOffset.x}px, ${this.dragOffset.y}px)`,t.style.transformOrigin="center center",t.style.transition="transform 0.2s ease")}t&&DOMHelpers.setContent(t,`${Math.round(100*this.currentZoom)}%`)}handleWheel(e){e.preventDefault(),e.deltaY<0?this.zoomIn():this.zoomOut()}closeEditor(){this.storageManager.stopAutoSave(),this.tipTapEditor&&(console.log("üóëÔ∏è Destroying TipTap Rich Text Editor..."),this.tipTapEditor.destroy&&this.tipTapEditor.destroy(),this.tipTapEditor=null),this.richTextEditor&&(console.log("üóëÔ∏è Destroying Legacy Rich Text Editor..."),this.richTextEditor.destroy(),this.richTextEditor=null),this.editorContainer&&(DOMHelpers.removeElement(this.editorContainer),this.editorContainer=null),this.isEditorOpen=!1,this.mermaidDiagrams=[],this.currentSelectedDiagram=null,this.currentSelectedDiagramId=null,this.isModified=!1,this.currentZoom=1,this.dragOffset={x:0,y:0}}setSaveCallback(e){this.onSave=e}isOpen(){return this.isEditorOpen}async processMermaidInContentSync(e){try{console.log("üîç DEBUG: Processing Mermaid diagrams in content...");const t=this.storageManager.getMermaidDiagramMappingsWithDraft();if(console.log("üîç DEBUG: Existing mappings found:",{count:t.size,keys:Array.from(t.keys())}),t.size>0){console.log(`üé® Using ${t.size} existing diagram mappings as source of truth`);let o=e;for(const[e,n]of t.entries()){console.log(`üé® Processing existing diagram ${e}:`,n.content.substring(0,50)+"...");try{let t=n.imageBase64;if(t?console.log(`üîÑ Using existing image for diagram ${e}`):(console.log(`üÜï Generating new image for diagram ${e}...`),t=await this.generateMermaidImage(n.content)),t){const r=`<img id="${e}" src="${t}" alt="Mermaid Diagram" style="max-width: 100%; height: auto;" data-mermaid-id="${e}" />`,a=new RegExp(`<img[^>]*id="${e}"[^>]*>`,"g"),i=o.match(a);if(i&&i.length>0)o=o.replace(a,r),console.log(`‚úÖ Replaced existing image for diagram ${e} with updated image`);else{const t=n.originCode||n.originalCode||n.content;o.includes(t)?(o=o.replace(t,r),console.log(`‚úÖ Replaced original code for diagram ${e} with new image`)):console.warn(`‚ö†Ô∏è Could not find existing image or original code to replace for diagram ${e}`)}}else console.warn(`‚ö†Ô∏è Failed to get image for diagram ${e}`)}catch(t){console.warn(`‚ö†Ô∏è Failed to process existing diagram ${e}:`,t)}}return console.log(`üé® Processed ${t.size} existing diagram mappings`),o}console.log("‚ÑπÔ∏è No existing mappings found, extracting diagrams from content...");const{diagrams:o}=mermaidRenderer.Z.extractMermaidDiagrams(e);if(0===o.length)return console.log("‚ÑπÔ∏è No Mermaid diagrams found in content"),e;let n=e;console.log(`üé® Found ${o.length} new Mermaid diagrams to process`);for(let e=0;e<o.length;e++){const r=o[e];console.log(`üé® Processing Mermaid diagram ${e+1}/${o.length}: ${r.id}`,r.code.substring(0,50)+"...");try{let e=null;const o=t.get(r.id);if(o&&o.content===r.code?(console.log(`üîÑ Using existing image for diagram ${r.id} (code unchanged)`),e=o.imageBase64):o&&o.content!==r.code?(console.log(`üîÑ Code changed for diagram ${r.id}, generating new image...`),e=await this.generateMermaidImage(r.code)):(console.log(`üÜï New diagram ${r.id}, generating image...`),e=await this.generateMermaidImage(r.code)),e){const t=`<img id="${r.id}" src="${e}" alt="Mermaid Diagram" style="max-width: 100%; height: auto;" data-mermaid-id="${r.id}" />`;n=n.replace(r.originalMatch,t),console.log(`‚úÖ Mermaid diagram ${r.id} converted to image`)}else{console.warn(`‚ö†Ô∏è Failed to generate image for diagram ${r.id}, using placeholder`);const e=`<img id="${r.id}" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzMzMyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk1lcm1haWQgRGlhZ3JhbTwvdGV4dD48L3N2Zz4=" alt="Mermaid Diagram (Placeholder)" style="max-width: 100%; height: auto; border: 1px dashed #ccc;" data-mermaid-id="${r.id}" />`;n=n.replace(r.originalMatch,e),console.log(`‚ö†Ô∏è Mermaid diagram ${r.id} replaced with placeholder`)}}catch(t){console.warn(`‚ö†Ô∏è Failed to process Mermaid diagram ${e+1}:`,t)}}return console.log(`üé® Processed ${o.length} Mermaid diagrams in content`,n),n}catch(t){return console.error("‚ùå Error processing Mermaid in content:",t),e}}async generateMermaidImage(e){try{if(!window.mermaid)return console.warn("‚ö†Ô∏è Mermaid not available"),null;const t=document.createElement("div");t.style.position="absolute",t.style.left="-9999px",t.style.top="-9999px",t.style.width="800px",t.style.height="600px",document.body.appendChild(t);try{const t=`mermaid-temp-${Date.now()}`,{svg:o}=await window.mermaid.render(t,e);return"data:image/svg+xml;base64,"+btoa(encodeURIComponent(o).replace(/%([0-9A-F]{2})/g,(e,t)=>String.fromCharCode(parseInt(t,16))))}finally{document.body.removeChild(t)}}catch(e){return console.error("‚ùå Failed to generate Mermaid image:",e),null}}getCurrentContent(){if(this.textEditor){const e=this.textEditor.getValue();this.currentContent&&(this.currentContent.full_storage_format=e)}return this.currentContent}}class MermaidPreview{constructor(){this.previewContainer=null}initialize(){return this.previewContainer=document.getElementById("mermaid-preview-container"),!!this.previewContainer||(console.error("‚ùå Preview container not found"),!1)}async updatePreview(e){if(this.previewContainer)if(e&&e.trim())try{const t=this.cleanMermaidCode(e);console.log("üßπ Cleaned Mermaid code:",t);const o=this.validateMermaidCode(t);if(!o.isValid)return void this.showError(`Invalid Mermaid syntax: ${o.error}`);await mermaidRenderer.Z.initializeMermaid();const n=`mermaid-ai-chat-preview-${Date.now()}`;this.showPlaceholder("Rendering diagram..."),await mermaidRenderer.Z.renderDiagram(n,t,this.previewContainer),console.log("‚úÖ Mermaid preview updated successfully")}catch(e){console.error("‚ùå Error updating Mermaid preview:",e),this.showError(e.message)}else this.showPlaceholder("Enter Mermaid code to preview");else console.error("‚ùå Preview container not initialized")}showPlaceholder(e){this.previewContainer&&this.previewContainer.nodeType===Node.ELEMENT_NODE&&document.contains(this.previewContainer)?this.previewContainer.innerHTML=`\n        <div class="mermaid-preview-placeholder">\n          ${e}\n        </div>\n      `:console.error("‚ùå Invalid or detached preview container for placeholder")}showError(e){this.previewContainer&&this.previewContainer.nodeType===Node.ELEMENT_NODE&&document.contains(this.previewContainer)?this.previewContainer.innerHTML=`\n        <div class="mermaid-preview-placeholder" style="color: #dc3545;">\n          ‚ùå Error rendering diagram:<br>\n          <small>${e}</small>\n        </div>\n      `:(console.error("‚ùå Invalid or detached preview container for error display"),console.error("‚ùå Error message:",e))}clear(){this.showPlaceholder("Click on a Mermaid diagram to start editing")}getCurrentContent(){return this.previewContainer?this.previewContainer.innerHTML:""}cleanMermaidCode(e){if(!e)return"";let t=e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#39;/g,"'");return t=t.replace(/<!\[CDATA\[(.*?)\]\]>/gs,"$1"),t=t.replace(/<[^>]*>/g,""),t=t.replace(/\r\n/g,"\n").replace(/\r/g,"\n"),t=t.replace(/\n\s*\n\s*\n/g,"\n\n"),t=t.trim(),t}validateMermaidCode(e){if(!e||!e.trim())return{isValid:!1,error:"Code is empty"};const t=e.trim(),o=["graph","flowchart","sequenceDiagram","classDiagram","stateDiagram","erDiagram","journey","gantt","pie","gitgraph","mindmap","timeline","sankey","requirement"];return o.some(e=>t.toLowerCase().startsWith(e.toLowerCase()))?t.includes("undefined")||t.includes("null")?{isValid:!1,error:"Contains undefined or null values"}:(t.match(/\[/g)||[]).length!==(t.match(/\]/g)||[]).length?{isValid:!1,error:"Unbalanced square brackets"}:{isValid:!0,error:null}:{isValid:!1,error:`Must start with a valid diagram type: ${o.join(", ")}`}}}class MermaidAIService{constructor(){this.apiClient=new ApiClient}async modifyDiagram(e,t){console.log("ü§ñ Sending AI request for diagram modification...");const o=this.validateUserPrompt(t);if(!o.isValid)throw new Error(o.error);const n=this.validateDiagramContent(e);if(!n.isValid)throw new Error(n.error);const r={diagram_code:e,prompt:t,content:await this.getCurrentPageContent()};console.log("üì§ Sending AI request:",r);try{const e=await fetch(API_URLS.EDIT_MERMAID,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!e.ok){const t=await e.text();throw new Error(t||`HTTP ${e.status}: ${e.statusText}`)}const t=await e.text();if(!t||!t.trim())throw new Error("Empty response from AI API");return console.log("‚úÖ AI response received successfully"),{success:!0,edited_diagram:t.trim()}}catch(e){throw console.error("‚ùå AI API error:",e),e}}async getCurrentPageContent(){try{const e=this.extractPageId();if(!e)return console.warn("‚ö†Ô∏è Could not extract page ID, falling back to DOM content"),this.getFallbackContent();console.log("üîç Fetching page content from API for pageId:",e);const t=await ConfluenceApi.fetchPageContent(e);return t&&t.content?(console.log("üìÑ Page content fetched from API:",t.content.substring(0,100)+"..."),t.content):t&&t.storageFormat?(console.log("üìÑ Using storage format as fallback:",t.storageFormat.substring(0,100)+"..."),t.storageFormat):(console.warn("‚ö†Ô∏è No content found from API, falling back to DOM"),this.getFallbackContent())}catch(e){return console.error("‚ùå Error fetching page content from API:",e),console.log("üîÑ Falling back to DOM content extraction"),this.getFallbackContent()}}extractPageId(){try{const e=new URLSearchParams(window.location.search).get("pageId");if(e)return e;const t=[window.location.pathname.match(/\/pages\/(\d+)/),window.location.pathname.match(/\/display\/[^\/]+\/(\d+)/),window.location.href.match(/pageId=(\d+)/),window.location.href.match(/\/(\d+)(?:[?#]|$)/)];for(const e of t)if(e&&e[1])return e[1];const o=['meta[name="ajs-page-id"]','meta[name="confluence-page-id"]','meta[property="confluence:page-id"]'];for(const e of o){const t=document.querySelector(e);if(t&&t.content)return t.content}return window.AJS&&window.AJS.params&&window.AJS.params.pageId?window.AJS.params.pageId:null}catch(e){return console.error("‚ùå Error extracting page ID:",e),null}}getFallbackContent(){try{const e=["#main-content .wiki-content",".wiki-content","#content .page-content",".page-content","#main-content",".main-content"];for(const t of e){const e=document.querySelector(t);if(e){const o=e.innerHTML;if(o&&o.trim().length>0)return console.log(`üìÑ Found fallback content from selector "${t}"`),o}}return document.body.innerHTML}catch(e){return console.error("‚ùå Error getting fallback content:",e),""}}async callAI(e){try{const t=await fetch("/api/ai/mermaid-edit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){const e=await t.json().catch(()=>({}));throw new Error(e.error||`HTTP ${t.status}: ${t.statusText}`)}const o=await t.json();return console.log("üì• AI API response:",o),o}catch(t){if(console.error("‚ùå AI API call failed:",t),t.message.includes("fetch"))return console.log("üîß Using mock AI response for development"),this.getMockResponse(e);throw t}}getMockResponse(e){const t=e.diagram_content;return{success:!0,edited_diagram:`%% Modified by AI: ${e.user_prompt}\n${t}`,explanation:`I've added a comment to your diagram based on your request: "${e.user_prompt}"`}}validateUserPrompt(e){return e&&e.trim()?e.trim().length<3?{isValid:!1,error:"Prompt is too short. Please provide more details."}:e.length>1e3?{isValid:!1,error:"Prompt is too long. Please keep it under 1000 characters."}:{isValid:!0,error:null}:{isValid:!1,error:"Please enter a prompt describing how you want to modify the diagram"}}validateDiagramContent(e){if(!e||!e.trim())return{isValid:!1,error:"No diagram content found. Please select a Mermaid diagram first."};const t=e.trim();return["graph","flowchart","sequenceDiagram","classDiagram","stateDiagram","erDiagram","journey","gantt","pie"].some(e=>t.toLowerCase().startsWith(e.toLowerCase()))?{isValid:!0,error:null}:{isValid:!1,error:"Invalid Mermaid diagram format. Please ensure it starts with a valid diagram type."}}getErrorMessage(e){return e.message.includes("fetch")?"Unable to connect to AI service. Please check your internet connection.":e.message.includes("HTTP 429")?"Too many requests. Please wait a moment and try again.":e.message.includes("HTTP 500")?"AI service is temporarily unavailable. Please try again later.":e.message||"An unexpected error occurred. Please try again."}}class MermaidApiClient{static extractPageId(){try{console.log("üîç Extracting page ID from current page..."),console.log("üîç Current URL:",window.location.href),console.log("üîç Current pathname:",window.location.pathname),console.log("üîç Current search:",window.location.search);const e=new URLSearchParams(window.location.search).get("pageId");if(e)return console.log("üìÑ Page ID extracted from URL params:",e),e;const t=[window.location.pathname.match(/\/pages\/(\d+)/),window.location.pathname.match(/\/display\/[^\/]+\/(\d+)/),window.location.href.match(/pageId=(\d+)/),window.location.href.match(/\/(\d+)(?:[?#]|$)/)];for(const e of t)if(e&&e[1])return console.log("üìÑ Page ID extracted from path/URL:",e[1]),e[1];const o=['meta[name="ajs-page-id"]','meta[name="confluence-page-id"]','meta[property="confluence:page-id"]'];for(const e of o){const t=document.querySelector(e);if(t&&t.content)return console.log(`üìÑ Page ID extracted from meta tag (${e}):`,t.content),t.content}if(window.AJS&&window.AJS.params&&window.AJS.params.pageId)return console.log("üìÑ Page ID extracted from AJS:",window.AJS.params.pageId),window.AJS.params.pageId;if(window.Confluence&&window.Confluence.getContentId){const e=window.Confluence.getContentId();if(e)return console.log("üìÑ Page ID extracted from Confluence context:",e),e}const n=document.body.getAttribute("data-page-id")||document.documentElement.getAttribute("data-page-id");return n?(console.log("üìÑ Page ID extracted from body data attribute:",n),n):(console.warn("‚ö†Ô∏è Could not extract page ID from current page"),console.warn("‚ö†Ô∏è Available methods tried: URL params, path patterns, meta tags, AJS context, Confluence context, data attributes"),null)}catch(e){return console.error("‚ùå Error extracting page ID:",e),null}}static extractFilename(e){try{if(!e)return null;console.log("üîç Extracting filename from src:",e);const t=new URL(e,window.location.origin).pathname.split("/"),o=t[t.length-1];if(!o)return null;const n=o.split(".")[0];return console.log("‚úÖ Extracted filename:",n),n}catch(e){return console.error("‚ùå Error extracting filename:",e),null}}static saveFilename(e){try{if(!e)return;localStorage.setItem("mermaid-ai-filename",e),console.log("üíæ Filename saved to localStorage:",e)}catch(e){console.error("‚ùå Error saving filename to localStorage:",e)}}static getSavedFilename(){try{const e=localStorage.getItem("mermaid-ai-filename");return console.log("üìÇ Retrieved filename from localStorage:",e),e}catch(e){return console.error("‚ùå Error retrieving filename from localStorage:",e),null}}static async fetchMermaidCode(e,t){try{console.log("üåê Fetching Mermaid code from API...",{pageId:e,filename:t});const o=`${CONFLUENCE_API_URLS.MERMAID_DIAGRAM}?ceoId=${e}&filename=${t}`;console.log("üì° API URL:",o);const n=await fetch(o,{method:"GET",headers:{Accept:"*/*","Accept-Language":"en-US,en;q=0.9,vi;q=0.8","Cache-Control":"no-cache",Connection:"keep-alive","Content-Type":"application/json; charset=utf-8",Pragma:"no-cache",Referer:CONFLUENCE_API_URLS.MERMAID_EDIT_REFERER,"Sec-Fetch-Dest":"empty","Sec-Fetch-Mode":"cors","Sec-Fetch-Site":"same-origin","User-Agent":navigator.userAgent,"X-Requested-With":"XMLHttpRequest","sec-ch-ua":'"Chromium";v="140", "Not=A?Brand";v="24", "Google Chrome";v="140"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"Windows"'},credentials:"include"});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);return await n.json()}catch(e){throw console.error("‚ùå Error fetching Mermaid code:",e),e}}static async fetchMermaidCodeFromSaved(){const e=this.extractPageId(),t=this.getSavedFilename();if(!e)throw new Error("Could not extract page ID from current page");if(!t)throw new Error("No filename found in localStorage. Please click on a Mermaid diagram first.");return await this.fetchMermaidCode(e,t)}}class MermaidAIChat{constructor(e){this.$=e||window.jQuery||window.$,this.isPopupOpen=!1,this.currentMermaidContent="",this.preview=new MermaidPreview,this.aiService=new MermaidAIService,this.lastClickedElement=null,this.lastClickPosition={x:0,y:0},this.currentZoom=1,this.minZoom=.25,this.maxZoom=3,this.zoomStep=.25,this.isZooming=!1,console.log("üöÄ Mermaid AI Chat initializing with AJS/jQuery:",!!this.$),this.init()}async init(){console.log("üöÄ AJS: Mermaid AI Chat initializing..."),document.getElementById("mermaid-ai-chat-root")?console.log("üîç AJS: Mermaid AI Chat already injected, skipping..."):(this.createPopupUI(),this.preview.initialize(),this.setupMermaidDetection(),this.setupConfluencePageChangeDetection(),this.setupConfluenceEditorMonitoring(),console.log("‚úÖ AJS: Mermaid AI Chat ready"))}handleMermaidClick(e,t){console.log("üéØ Mermaid diagram clicked:",e,t),this.showChatPopup(t.x,t.y)}setupMermaidDetection(){console.log("üîç SIMPLE: Setting up iframe click detection..."),this.setupIframeEventListeners(),this.setupMutationObserver(),console.log("‚úÖ SIMPLE: Setup completed")}setupIframeEventListeners(){console.log("üîç IFRAME: Setting up iframe event listeners..."),this.refreshIframeListeners()}refreshIframeListeners(){const e=document.querySelectorAll("iframe");console.log("üîç IFRAME REFRESH: Found",e.length,"iframes"),0===e.length?(console.log("‚ö†Ô∏è IFRAME REFRESH: No iframes found on page"),console.log("‚ö†Ô∏è IFRAME REFRESH: Document ready state:",document.readyState),setTimeout(()=>{console.log("üîç IFRAME REFRESH: Retrying iframe search after delay...");const e=document.querySelectorAll("iframe");console.log("üîç IFRAME REFRESH: Retry found",e.length,"iframes"),e.length>0&&e.forEach((e,t)=>{console.log(`üîç IFRAME REFRESH RETRY ${t}: Processing iframe:`,e.src||e.id||"no-src"),this.attachIframeListeners(e,`refresh-retry-${t}`)})},1e3)):e.forEach((e,t)=>{console.log(`üîç IFRAME REFRESH ${t}: Processing iframe:`,e.src||e.id||"no-src"),this.attachIframeListeners(e,`refresh-${t}`)})}attachIframeListeners(e,t){try{if("true"===e.dataset.mermaidListenerAttached)return void console.log(`‚ö†Ô∏è IFRAME ${t}: Listener already attached, skipping...`);e.dataset.mermaidListenerAttached="true";const o=()=>{console.log(`üîç IFRAME ${t}: Iframe loaded, attaching listeners...`);try{const o=e.contentDocument||e.contentWindow.document;if(!o)return void console.log(`‚ö†Ô∏è IFRAME ${t}: Cannot access iframe document (cross-origin?)`);console.log(`‚úÖ IFRAME ${t}: Iframe document accessible, adding click listeners...`);const n=o=>{if(console.log(`üñ±Ô∏è IFRAME ${t} CLICK: Element clicked:`,{tag:o.target.tagName,classes:o.target.className,id:o.target.id,src:o.target.src||"N/A",alt:o.target.alt||"N/A",element:o.target}),console.log(`üîç IFRAME ${t} CLICK: Checking if Mermaid element...`),console.log(`üîç IFRAME ${t} CLICK: isMermaidElement result:`,this.isMermaidElement(o.target)),this.isMermaidElement(o.target)){if(console.log("üéØ Mermaid element clicked:",o.target),o.target.src){const e=MermaidApiClient.extractFilename(o.target.src),t=o.target.getAttribute("data-macro-parameters"),n={filename:e,src:o.target.src,macroParameters:t,element:{tagName:o.target.tagName,className:o.target.className,id:o.target.id}};if(t)try{const e=this.parseMacroParameters(t);n.parsedParams=e,console.log("üìã Parsed macro parameters:",e)}catch(e){console.warn("‚ö†Ô∏è Could not parse macro parameters:",t)}e?(MermaidApiClient.saveFilename(e),localStorage.setItem("mermaid_diagram_info",JSON.stringify(n)),console.log("üíæ Diagram info saved:",n)):console.warn("‚ö†Ô∏è Could not extract filename from src:",o.target.src)}this.lastClickedElement=o.target,this.lastClickPosition={x:o.clientX+e.offsetLeft,y:o.clientY+e.offsetTop},this.handleMermaidClick(o.target,this.lastClickPosition)}};o.mermaidClickHandler&&o.removeEventListener("click",o.mermaidClickHandler,!0);const r=n.bind(this);o.addEventListener("click",r,!0),o.mermaidClickHandler=r}catch(e){console.log(`‚ùå IFRAME ${t}: Error accessing iframe content:`,e.message)}};e.mermaidLoadHandler&&e.removeEventListener("load",e.mermaidLoadHandler),e.addEventListener("load",o),e.mermaidLoadHandler=o,e.contentDocument&&"complete"===e.contentDocument.readyState&&o()}catch(e){console.log(`‚ùå IFRAME ${t}: Error setting up iframe listener:`,e.message)}}setupMutationObserver(){console.log("üîç MUTATION: Setting up observer to track ALL DOM changes in parent..."),new MutationObserver(e=>{e.forEach((e,t)=>{console.log(`üîç MUTATION ${t}: Type: ${e.type}`),"childList"===e.type&&e.addedNodes.length>0&&(console.log(`‚ûï MUTATION ${t}: ${e.addedNodes.length} nodes ADDED:`),e.addedNodes.forEach((e,t)=>{var o;if(e.nodeType===Node.ELEMENT_NODE)console.log(`‚ûï Added ${t}: ${e.tagName}`,{tag:e.tagName,classes:e.className||"N/A",id:e.id||"N/A",textContent:(null===(o=e.textContent)||void 0===o?void 0:o.substring(0,50))||"N/A",element:e}),"IFRAME"===e.tagName&&(console.log("üéØ MUTATION: IFRAME detected, attaching listeners..."),this.attachIframeListeners(e,"new")),this.injectAIButton();else if(e.nodeType===Node.TEXT_NODE){var n;console.log(`‚ûï Added ${t}: TEXT_NODE`,{content:(null===(n=e.textContent)||void 0===n?void 0:n.substring(0,50))||"N/A"})}}))})}).observe(document.body,{childList:!0,subtree:!1})}setupConfluencePageChangeDetection(){console.log("üîç PAGE CHANGE: Setting up Confluence page change detection..."),window.AJS&&AJS.bind&&(AJS.bind("init.rte",()=>{console.log("üîÑ PAGE CHANGE: Confluence RTE initialized - re-setting up iframe listeners"),setTimeout(()=>this.setupIframeEventListeners(),1e3)}),AJS.bind("rte-ready",()=>{console.log("üîÑ PAGE CHANGE: Confluence RTE ready - re-setting up iframe listeners"),setTimeout(()=>this.setupIframeEventListeners(),1e3)}),AJS.bind("page.edit.ready",()=>{console.log("üîÑ PAGE CHANGE: Page edit ready - re-setting up iframe listeners"),setTimeout(()=>this.setupIframeEventListeners(),1500)}),AJS.bind("page.view.ready",()=>{console.log("üîÑ PAGE CHANGE: Page view ready - re-setting up iframe listeners"),setTimeout(()=>this.setupIframeEventListeners(),1e3)}));let e=window.location.href;setInterval(()=>{window.location.href!==e&&(console.log("üîÑ PAGE CHANGE: URL changed from",e,"to",window.location.href),e=window.location.href,setTimeout(()=>{console.log("üîÑ PAGE CHANGE: Re-setting up iframe listeners after URL change"),this.setupIframeEventListeners()},2e3))},1e3),console.log("‚úÖ PAGE CHANGE: Confluence page change detection setup completed")}injectAIButton(){if(document.querySelector(".confluence-editor-overlay"))console.log("üö´ ConfluenceEditor popup is open, skipping AI button injection");else{var e=document.getElementById("property-panel");if(e){var t=e.querySelector(".panel-buttons");if(t&&!t.querySelector(".macro-placeholder-property-panel-ai-button")){console.log("‚ú® Th√™m n√∫t AI v√†o property panel...");var o=document.createElement("a");o.href="#",o.className="aui-button macro-placeholder-property-panel-ai-button",o.setAttribute("tabindex","0"),o.setAttribute("role","button"),o.setAttribute("aria-label","AI"),o.style.marginRight="4px",o.innerHTML='<span class="icon"></span><span class="panel-button-text">AI</span>',o.addEventListener("click",async e=>{if(e.preventDefault(),document.querySelector(".confluence-editor-overlay"))return void console.log("üö´ ConfluenceEditor popup is open, ignoring AI button click");console.log("ü§ñ AI Button clicked - fetching Mermaid code...");const t=this.lastClickedElement,o=this.lastClickPosition;if(console.log("üîç DEBUG AI BUTTON: this.lastClickedElement:",this.lastClickedElement),console.log("üîç DEBUG AI BUTTON: this.lastClickPosition:",this.lastClickPosition),console.log("üîç DEBUG AI BUTTON: lastClickedElement:",t),console.log("üîç DEBUG AI BUTTON: lastClickPosition:",o),console.log("üîç DEBUG AI BUTTON: Position check:",o&&(0!==o.x||0!==o.y)),t&&o&&(0!==o.x||0!==o.y)){console.log("ü§ñ Found saved element - fetching Mermaid code from API...");try{const e="üîÑ Fetching Mermaid diagram code...";console.log(e);const t=(await MermaidApiClient.fetchMermaidCodeFromSaved()).data;console.log("‚úÖ Mermaid code fetched successfully:",t),this.currentMermaidContent=t,this.showChatPopup(o.x,o.y)}catch(e){console.error("‚ùå Error fetching Mermaid code:",e),alert(`‚ùå Error fetching Mermaid code: ${e.message}`)}}else console.log("‚ö†Ô∏è No saved element found - please click on an image first"),alert("‚ö†Ô∏è Vui l√≤ng click v√†o m·ªôt h√¨nh ·∫£nh tr∆∞·ªõc khi s·ª≠ d·ª•ng AI Chat!")});var n=t.querySelector(".macro-placeholder-property-panel-remove-button");n?t.insertBefore(o,n):t.appendChild(o),console.log("‚úÖ ƒê√£ ch√®n n√∫t AI th√†nh c√¥ng.")}}}}removeAIButton(){const e=document.querySelector(".macro-placeholder-property-panel-ai-button");e&&(e.remove(),console.log("üóëÔ∏è AI button removed due to ConfluenceEditor popup"))}setupConfluenceEditorMonitoring(){new MutationObserver(e=>{e.forEach(e=>{"childList"===e.type&&(e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&e.classList&&e.classList.contains("confluence-editor-overlay")&&(console.log("üîç ConfluenceEditor popup opened, removing AI button"),this.removeAIButton())}),e.removedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&e.classList&&e.classList.contains("confluence-editor-overlay")&&(console.log("üîç ConfluenceEditor popup closed, re-injecting AI button"),setTimeout(()=>{this.injectAIButton()},100))}))})}).observe(document.body,{childList:!0,subtree:!1}),console.log("‚úÖ ConfluenceEditor monitoring setup completed")}parseMacroParameters(e){const t={};return e?(e.split("|").forEach(e=>{const[o,n]=e.split("=");o&&n&&(t[o.trim()]=n.trim())}),t):t}isMermaidElement(e){if(!e||!e.nodeType||e.nodeType!==Node.ELEMENT_NODE)return!1;console.log("üîç isMermaidElement: Checking element:",{tag:e.tagName,src:e.src||"N/A",className:e.className||"N/A",id:e.id||"N/A"});const t=["IMG"===e.tagName&&e.src&&e.src.includes("mermaid"),"SVG"===e.tagName&&e.id&&e.id.includes("mermaid"),e.classList&&e.classList.contains("mermaid"),e.getAttribute&&"mermaid"===e.getAttribute("data-macro-name"),"AC:STRUCTURED-MACRO"===e.tagName&&"mermaid"===e.getAttribute("ac:name"),"IMG"===e.tagName&&e.src,"SVG"===e.tagName].some(e=>e);return console.log("üîç isMermaidElement: Result:",t),t}bindZoomControls(){const e=document.getElementById("zoom-in-btn"),t=document.getElementById("zoom-out-btn"),o=document.getElementById("zoom-reset-btn"),n=document.getElementById("mermaid-preview-container");e&&t&&o&&n?(e.addEventListener("click",()=>{this.zoomIn()}),t.addEventListener("click",()=>{this.zoomOut()}),o.addEventListener("click",()=>{this.resetZoom()}),document.addEventListener("keydown",e=>{this.isPopupOpen&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&("+"===e.key||"="===e.key?(e.preventDefault(),this.zoomIn()):"-"===e.key?(e.preventDefault(),this.zoomOut()):"0"===e.key&&(e.preventDefault(),this.resetZoom()))}),n.addEventListener("wheel",e=>{e.ctrlKey&&(e.preventDefault(),e.deltaY<0?this.zoomIn():this.zoomOut())}),console.log("‚úÖ Zoom controls bound successfully")):console.warn("‚ö†Ô∏è Zoom controls not found")}zoomIn(){this.currentZoom<this.maxZoom&&(this.currentZoom=Math.min(this.currentZoom+this.zoomStep,this.maxZoom),this.applyZoom())}zoomOut(){this.currentZoom>this.minZoom&&(this.currentZoom=Math.max(this.currentZoom-this.zoomStep,this.minZoom),this.applyZoom())}resetZoom(){this.currentZoom=1,this.applyZoom()}applyZoom(){const e=document.getElementById("mermaid-preview-container"),t=document.getElementById("zoom-level-display");e&&(this.isZooming=!0,e.style.transform=`scale(${this.currentZoom})`,e.style.transformOrigin="center center",t&&(t.textContent=`${Math.round(100*this.currentZoom)}%`),this.updateZoomButtonStates(),console.log(`üîç Zoom applied: ${Math.round(100*this.currentZoom)}%`),setTimeout(()=>{this.isZooming=!1},100))}updateZoomButtonStates(){const e=document.getElementById("zoom-in-btn"),t=document.getElementById("zoom-out-btn");e&&(e.disabled=this.currentZoom>=this.maxZoom,e.style.opacity=this.currentZoom>=this.maxZoom?"0.5":"1"),t&&(t.disabled=this.currentZoom<=this.minZoom,t.style.opacity=this.currentZoom<=this.minZoom?"0.5":"1")}createPopupUI(){const e=document.createElement("div");e.id="mermaid-ai-chat-root",e.innerHTML='\n      <style>\n        .mermaid-preview-header {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          padding: 8px 12px;\n          background: #f5f5f5;\n          border-bottom: 1px solid #ddd;\n          font-weight: bold;\n        }\n\n        .zoom-controls {\n          display: flex;\n          align-items: center;\n          gap: 8px;\n        }\n\n        .zoom-btn {\n          background: #fff;\n          border: 1px solid #ccc;\n          border-radius: 4px;\n          padding: 4px 8px;\n          cursor: pointer;\n          font-size: 12px;\n          transition: all 0.2s;\n        }\n\n        .zoom-btn:hover:not(:disabled) {\n          background: #e6f3ff;\n          border-color: #0066cc;\n        }\n\n        .zoom-btn:disabled {\n          cursor: not-allowed;\n          opacity: 0.5;\n        }\n\n        .zoom-level {\n          font-size: 12px;\n          font-weight: bold;\n          color: #666;\n          min-width: 40px;\n          text-align: center;\n        }\n\n        .zoom-icon {\n          font-size: 10px;\n        }\n\n        #mermaid-preview-container {\n          transition: transform 0.2s ease;\n          overflow: auto;\n        }\n\n        .mermaid-chat-buttons {\n          display: flex;\n          gap: 8px;\n          align-items: center;\n        }\n\n        .mermaid-chat-save {\n          background: #28a745;\n          color: white;\n          border: none;\n          border-radius: 4px;\n          padding: 8px 16px;\n          cursor: pointer;\n          font-size: 14px;\n          transition: background-color 0.2s;\n        }\n\n        .mermaid-chat-save:hover:not(:disabled) {\n          background: #218838;\n        }\n\n        .mermaid-chat-save:disabled {\n          background: #6c757d;\n          cursor: not-allowed;\n        }\n      </style>\n      <div id="mermaid-ai-chat-popup" class="mermaid-ai-chat-popup" style="display: none;">\n        <div class="mermaid-ai-chat-header">\n          <h3>ü§ñ Mermaid AI Chat Editor</h3>\n          <button class="mermaid-ai-chat-close">&times;</button>\n        </div>\n        <div class="mermaid-ai-chat-body">\n          \x3c!-- Left Pane: Code Editor + Chat Input --\x3e\n          <div class="mermaid-ai-chat-left-pane">\n            \x3c!-- Code Editor Section --\x3e\n            <div class="mermaid-code-section">\n              <div class="mermaid-code-header">\n                üìù Mermaid Code\n              </div>\n              <textarea\n                id="mermaid-code-editor"\n                class="mermaid-code-editor"\n                placeholder="Mermaid diagram code will appear here..."\n              ></textarea>\n            </div>\n\n            \x3c!-- Chat Input Section --\x3e\n            <div class="mermaid-chat-section">\n              <div class="mermaid-chat-input-area">\n                <textarea\n                  id="mermaid-ai-chat-input"\n                  class="mermaid-chat-input"\n                  placeholder="üí¨ Describe how you want to modify the diagram..."\n                  rows="2"\n                ></textarea>\n                <div class="mermaid-chat-buttons">\n                  <button id="mermaid-ai-chat-save" class="mermaid-chat-save">\n                    üíæ Save\n                  </button>\n                  <button id="mermaid-ai-chat-send" class="mermaid-chat-send">\n                    Send\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          \x3c!-- Right Pane: Mermaid Preview --\x3e\n          <div class="mermaid-ai-chat-right-pane">\n            <div class="mermaid-preview-section">\n              <div class="mermaid-preview-header">\n                <span class="preview-title">üìä Diagram Preview</span>\n                <div class="zoom-controls">\n                  <button id="zoom-out-btn" class="zoom-btn" title="Zoom Out (-)">\n                    <span class="zoom-icon">‚ûñ</span>\n                  </button>\n                  <span id="zoom-level-display" class="zoom-level">100%</span>\n                  <button id="zoom-in-btn" class="zoom-btn" title="Zoom In (+)">\n                    <span class="zoom-icon">‚ûï</span>\n                  </button>\n                  <button id="zoom-reset-btn" class="zoom-btn" title="Reset Zoom (0)">\n                    <span class="zoom-icon">üîÑ</span>\n                  </button>\n                </div>\n              </div>\n              <div class="mermaid-preview-body">\n                <div id="mermaid-preview-container" class="mermaid-preview-container">\n                  <div class="mermaid-preview-placeholder">\n                    Click on a Mermaid diagram to start editing\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    ',document.body.appendChild(e),this.bindPopupEvents()}bindPopupEvents(){const e=document.getElementById("mermaid-ai-chat-popup"),t=e.querySelector(".mermaid-ai-chat-header"),o=e.querySelector(".mermaid-ai-chat-close"),n=document.getElementById("mermaid-ai-chat-send"),r=document.getElementById("mermaid-ai-chat-save"),a=document.getElementById("mermaid-ai-chat-input"),i=document.getElementById("mermaid-code-editor");this.makeDraggable(e,t),o.addEventListener("click",()=>{this.hideChatPopup()}),n.addEventListener("click",()=>{this.sendMessage()}),r.addEventListener("click",()=>{this.saveDiagram()}),a.addEventListener("keydown",e=>{"Enter"!==e.key||e.ctrlKey||e.shiftKey||(e.preventDefault(),this.sendMessage())}),i.addEventListener("input",()=>{this.updateMermaidPreview()}),this.bindZoomControls(),setTimeout(()=>{document.addEventListener("click",t=>{this.isPopupOpen&&(t.target.closest(".macro-placeholder-property-panel-ai-button")||t.target.closest("#ai-send-btn")&&document.querySelector(".confluence-editor-overlay")||e.contains(t.target)||(console.log("üñ±Ô∏è Click outside popup detected, closing..."),this.hideChatPopup()))},!0)},300)}makeDraggable(e,t){let o=!1,n=0,r=0,a=0,i=0;console.log("üéØ DRAG: Setting up draggable popup..."),t.style.cursor="move",t.style.userSelect="none";const s=t=>{if(!o)return;t.preventDefault(),t.stopPropagation();const s=t.clientX-n,l=t.clientY-r;let c=a+s,d=i+l;const m=window.innerWidth-400-10,g=window.innerHeight-300-10;c=Math.max(10,Math.min(c,m)),d=Math.max(10,Math.min(d,g)),e.style.left=c+"px",e.style.top=d+"px"},l=e=>{o&&(console.log("üéØ DRAG: Stopped"),o=!1,document.removeEventListener("mousemove",s,!0),document.removeEventListener("mouseup",l,!0),document.body.style.userSelect="",e.stopPropagation())};t.addEventListener("mousedown",t=>{t.target.classList.contains("mermaid-ai-chat-close")||(t.preventDefault(),t.stopPropagation(),o=!0,n=t.clientX,r=t.clientY,a=parseInt(e.style.left)||0,i=parseInt(e.style.top)||0,console.log("üéØ DRAG: Started",{mouseX:n,mouseY:r,popupX:a,popupY:i}),document.addEventListener("mousemove",s,!0),document.addEventListener("mouseup",l,!0),document.body.style.userSelect="none")}),console.log("‚úÖ DRAG: Setup completed")}showChatPopup(e,t){console.log("üéâ STEP 8: showChatPopup called with coordinates:",{x:e,y:t});const o=document.getElementById("mermaid-ai-chat-popup");if(console.log("üéâ STEP 8.1: Found popup element:",o),!o)return void console.error("‚ùå STEP 8.1: Popup element not found!");const n=document.getElementById("mermaid-code-editor");n&&this.currentMermaidContent&&(n.value=this.currentMermaidContent,this.updateMermaidPreview());const r=Math.min(e,window.innerWidth-400),a=Math.min(t,window.innerHeight-300);console.log("üéâ STEP 8.2: Setting popup position:",{leftPos:r,topPos:a}),console.log("üéâ STEP 8.2: Window dimensions:",{width:window.innerWidth,height:window.innerHeight}),o.style.display="block",o.style.left=r+"px",o.style.top=a+"px",console.log("üéâ STEP 8.3: Popup styles applied:",{display:o.style.display,left:o.style.left,top:o.style.top}),this.isPopupOpen=!0,console.log("üéâ STEP 8.4: isPopupOpen set to:",this.isPopupOpen),setTimeout(()=>{const e=document.getElementById("mermaid-ai-chat-input");console.log("üéâ STEP 8.5: Focusing input element:",e),e?(e.focus(),console.log("‚úÖ STEP 8.5: Input focused successfully")):console.error("‚ùå STEP 8.5: Input element not found!")},100),console.log("‚úÖ STEP 8: showChatPopup completed")}async updateMermaidPreview(){const e=document.getElementById("mermaid-code-editor");if(!e)return;if(this.isZooming)return void console.log("üîç Skipping preview update during zoom to prevent flicker");const t=e.value.trim();this.currentMermaidContent=t;const o=this.currentZoom;await this.preview.updatePreview(t),1!==o&&setTimeout(()=>{this.currentZoom=o,this.applyZoom()},50)}hideChatPopup(){const e=document.getElementById("mermaid-ai-chat-popup"),t=document.getElementById("mermaid-ai-chat-messages"),o=document.getElementById("mermaid-ai-chat-input");if(e?(e.style.display="none",this.isPopupOpen=!1):console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ popup (mermaid-ai-chat-popup)"),t){const e=t.querySelector(".system");t.innerHTML="",e?t.appendChild(e):console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y system message trong chat container")}else console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ messages container (mermaid-ai-chat-messages)");o?o.value="":console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y input (mermaid-ai-chat-input)"),console.log("‚úÖ Chat popup closed (ƒë√£ ki·ªÉm tra ƒë·∫ßy ƒë·ªß ph·∫ßn t·ª≠)")}async sendMessage(){const e=document.getElementById("mermaid-ai-chat-input"),t=document.getElementById("mermaid-code-editor"),o=document.getElementById("mermaid-ai-chat-send"),n=e.value.trim();if(!n)return;const r=t.value.trim();if(r){this.currentMermaidContent=r,o.disabled=!0,o.textContent="ü§î Thinking...",e.disabled=!0;try{const o=await this.aiService.modifyDiagram(this.currentMermaidContent,n);t.value=o.edited_diagram,this.currentMermaidContent=o.edited_diagram,await this.updateMermaidPreview(),e.value="",console.log("‚úÖ Diagram updated successfully by AI")}catch(e){console.error("‚ùå AI API error:",e);const t=this.aiService.getErrorMessage(e);alert(`‚ùå ${t}`)}finally{o.disabled=!1,o.textContent="Send",e.disabled=!1,e.focus()}}else alert("‚ö†Ô∏è Please enter some Mermaid code first")}async saveDiagram(){const e=document.getElementById("mermaid-code-editor"),t=document.getElementById("mermaid-ai-chat-save");if(!e)return void alert("‚ùå Code editor not found");const o=e.value.trim();if(o){this.currentMermaidContent=o,t.disabled=!0,t.textContent="üíæ Saving...";try{var n;const e=localStorage.getItem("mermaid_diagram_info");if(!e)throw new Error("No diagram info found. Please click on a Mermaid image first.");const t=JSON.parse(e),r=MermaidApiClient.extractPageId();if(!r)throw new Error("Could not extract page ID from current page.");console.log("üíæ Saving diagram with info:",t);const a=await this.updateMermaidDiagram(t.filename,r,o,t.parsedParams),i=null!=a&&a.revision?a.revision:1,s=await this.generatePlaceholderImage(r,t.parsedParams,i);await this.replaceImageInDOM(null===(n=t.parsedParams)||void 0===n?void 0:n.filename,s),alert("‚úÖ Diagram saved and updated successfully!"),this.hideChatPopup()}catch(e){console.error("‚ùå Error saving diagram:",e),alert(`‚ùå Error saving diagram: ${e.message}`)}finally{t.disabled=!1,t.textContent="üíæ Save"}}else alert("‚ö†Ô∏è Please enter some Mermaid code first")}async updateMermaidDiagram(e,t,o,n){console.log(`üîÑ Updating Mermaid diagram: ${e} on page ${t}`);const{svg:r,png:a}=await this.generateMermaidAssets(o),i=parseInt((null==n?void 0:n.revision)||"1"),s={filename:e,data:o,revision:i+1,svg:r,png:a};console.log("üì§ Sending diagram update:",{filename:e,revision:i+1,dataLength:o.length,svgLength:r.length,pngLength:a.length});const l=await fetch(`${CONFLUENCE_API_URLS.MERMAID_UPDATE}/${t}`,{method:"PUT",headers:{Accept:"*/*","Accept-Language":"en-US,en;q=0.9,vi;q=0.8","Cache-Control":"no-cache",Connection:"keep-alive","Content-Type":"application/json; charset=utf-8",Pragma:"no-cache",Referer:CONFLUENCE_API_URLS.MERMAID_EDIT_REFERER,"Sec-Fetch-Dest":"empty","Sec-Fetch-Mode":"cors","Sec-Fetch-Site":"same-origin","User-Agent":navigator.userAgent,"X-Requested-With":"XMLHttpRequest","X-Atlassian-Token":"no-check","sec-ch-ua":'"Chromium";v="140", "Not=A?Brand";v="24", "Google Chrome";v="140"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"Windows"'},body:JSON.stringify(s)});if(!l.ok){const e=await l.text();throw new Error(`Mermaid Update API Error: ${l.status} - ${e}`)}const c=await l.json();return console.log("‚úÖ Mermaid diagram updated successfully:",c),c}async generateMermaidAssets(e){try{window.mermaid||(console.log("üì¶ Loading Mermaid library..."),await mermaidRenderer.Z.loadMermaidScript()),window.mermaid.mermaidAPI||window.mermaid.initialize({startOnLoad:!1}),console.log("üé® Generating SVG from Mermaid code...");const{svg:t}=await window.mermaid.render("temp-diagram",e);console.log("‚úÖ SVG generated successfully",t);const o=await this.convertSvgToPngDataUrl(t);if(!o)throw new Error("Failed to convert SVG to PNG");const n=o.split(",")[1];return console.log("‚úÖ PNG generated successfully"),{svg:t,png:n}}catch(e){throw console.error("‚ùå Error generating Mermaid assets:",e),new Error(`Failed to generate Mermaid assets: ${e.message}`)}}encodeSvg(e){return btoa((new TextEncoder).encode(e).reduce((e,t)=>e+String.fromCharCode(t),""))}async convertSvgToPngDataUrl(e,t=2){return new Promise(o=>{if(!e)return console.error("L·ªói: Chu·ªói SVG ƒë·∫ßu v√†o r·ªóng."),o(null);const n="data:image/svg+xml;base64,"+btoa((new TextEncoder).encode(e).reduce((e,t)=>e+String.fromCharCode(t),"")),r=document.createElement("canvas"),a=r.getContext("2d"),i=new Image;i.onload=function(){const e=i.width,n=i.height;console.log(`üñºÔ∏è SVG original size: ${e}x${n}`);const s=e*t,l=n*t;r.width=s,r.height=l,console.log(`üñºÔ∏è Canvas size: ${s}x${l} (scale: ${t})`),a.fillStyle="white",a.fillRect(0,0,s,l),a.drawImage(i,0,0,s,l),console.log("‚úÖ SVG drawn to canvas successfully");const c=r.toDataURL("image/png");r.remove(),o(c)},i.onerror=function(e){console.error("L·ªói khi t·∫£i SVG v√†o Image object:",e),r.remove(),o(null)},i.src=n})}async svgToPng(e){return new Promise((t,o)=>{const n=document.createElement("canvas"),r=n.getContext("2d"),a=new Image;a.onload=()=>{n.width=a.width,n.height=a.height,r.drawImage(a,0,0);const e=n.toDataURL("image/png").split(",")[1];t(e)},a.onerror=e=>{o(new Error(`Failed to convert SVG to PNG: ${e}`))};const i=new Blob([e],{type:"image/svg+xml"}),s=URL.createObjectURL(i);a.src=s})}async saveMermaidCode(e,t,o){const n=await fetch(CONFLUENCE_API_URLS.MERMAID_SAVE,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Atlassian-Token":"no-check"},body:JSON.stringify({pageId:t,filename:e,mermaidCode:o})});if(!n.ok){const e=await n.text();throw new Error(`Mermaid Save API Error: ${n.status} - ${e}`)}const r=await n.json();return console.log("‚úÖ Mermaid code saved successfully:",r),r}async generatePlaceholderImage(e,t,o){const n={contentId:e,macro:{name:"mermaid-cloud",params:{filename:(null==t?void 0:t.filename)||"Diagram",revision:o,zoom:(null==t?void 0:t.zoom)||"fit",toolbar:(null==t?void 0:t.toolbar)||"bottom",format:(null==t?void 0:t.format)||"svg"}}};console.log("üñºÔ∏è Generating placeholder with data:",n);const r=await fetch(CONFLUENCE_API_URLS.TINYMCE_PLACEHOLDER,{method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8",Accept:"text/plain, */*; q=0.01","X-Requested-With":"XMLHttpRequest","X-Atlassian-Token":"no-check"},body:JSON.stringify(n)});if(!r.ok){const e=await r.text();throw new Error(`TinyMCE Placeholder API Error: ${r.status} - ${e}`)}const a=await r.text();return console.log("‚úÖ New placeholder image generated:",a),a}async replaceImageInDOM(e,t){if(!e||!t)return void console.error("‚ùå Missing filename or newImageHtml");console.log(`üîÑ Looking for images with filename: ${e}`);const o=document.createElement("div");o.innerHTML=t;const n=o.querySelector("img");if(!n)throw new Error("Could not parse new image from HTML");console.log("üÜï New image element:",n);const r=this.findImagesByFilename(e);console.log(`üîç Found ${r.length} images to replace`),r.forEach((e,t)=>{console.log(`üîÑ Replacing image ${t+1}:`,e),this.replaceImageAttributes(e,n),console.log("‚úÖ Image replaced successfully:",e)})}findImagesByFilename(e){const t=[];return document.querySelectorAll("img[data-macro-parameters]").forEach(o=>{const n=o.getAttribute("data-macro-parameters");n&&n.includes(`filename=${e}`)&&t.push(o)}),document.querySelectorAll("iframe").forEach(o=>{try{(o.contentDocument||o.contentWindow.document).querySelectorAll("img[data-macro-parameters]").forEach(o=>{const n=o.getAttribute("data-macro-parameters");n&&n.includes(`filename=${e}`)&&t.push(o)})}catch(e){console.warn("Could not access iframe content:",e)}}),t}replaceImageAttributes(e,t){const o=t.attributes,n=["id","class"],r=Array.from(e.attributes);r.forEach(t=>{n.includes(t.name)||e.removeAttribute(t.name)}),Array.from(o).forEach(t=>{e.setAttribute(t.name,t.value)}),console.log("üîÑ Attributes replaced:",{old:r.map(e=>`${e.name}="${e.value}"`),new:Array.from(o).map(e=>`${e.name}="${e.value}"`)})}addMessage(e,t){const o=document.getElementById("mermaid-ai-chat-messages"),n="msg-"+Date.now(),r=document.createElement("div");return r.className=`mermaid-ai-chat-message ${e}`,r.id=n,r.innerHTML=`\n      <div class="message-content">\n        <p>${t}</p>\n      </div>\n    `,o.appendChild(r),o.scrollTop=o.scrollHeight,n}removeMessage(e){const t=document.getElementById(e);t&&t.remove()}}class TextEditAI{constructor(){this.isPopupOpen=!1,this.selectedText="",this.selectedElement=null,this.selectedDocument=document,this.editButton=null,console.log("üöÄ TextEditAI initializing..."),this.init()}async init(){console.log("üöÄ TextEditAI initializing..."),document.getElementById("text-edit-ai-root")?console.log("üîç TextEditAI already injected, skipping..."):(this.loadCSS(),this.createPopupUI(),this.setupTextSelectionDetection(),console.log("‚úÖ TextEditAI ready"))}loadCSS(){console.log("üìÑ CSS: Using inline CSS instead of external file")}setupTextSelectionDetection(){console.log("üîç Setting up text selection detection..."),this.attachSelectionListeners(document),this.setupIframeSelectionListeners(),document.addEventListener("click",e=>{e.target.closest(".text-edit-button")||e.target.closest("#text-edit-ai-popup")||this.hideEditButton()})}attachSelectionListeners(e){const t=e===document?"main document":"iframe document";if(console.log(`üéØ LISTENERS: Attaching selection listeners to ${t}`),console.log("üéØ LISTENERS: Document title:",e.title||"no title"),console.log("üéØ LISTENERS: Document URL:",e.URL||"no URL"),e._textEditListenersAttached)return void console.log(`‚ö†Ô∏è LISTENERS: ${t} already has listeners, skipping`);const o=o=>{console.log(`üñ±Ô∏è MOUSEUP: Event fired in ${t}`),this.handleTextSelection(o,e)},n=o=>{(o.shiftKey||o.ctrlKey)&&(console.log(`‚å®Ô∏è KEYUP: Selection event fired in ${t}`,o.key),this.handleTextSelection(o,e))};e.addEventListener("mouseup",o,!0),e.addEventListener("keyup",n,!0),e._textEditListenersAttached=!0,e._textEditMouseupHandler=o,e._textEditKeyupHandler=n,console.log(`‚úÖ LISTENERS: Selection listeners attached to ${t}`)}setupIframeSelectionListeners(){console.log("üîç Setting up iframe selection listeners..."),this.refreshIframeListeners(),this.setupConfluencePageChangeDetection(),new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){"IFRAME"===e.tagName&&this.attachToIframe(e);const t=e.querySelectorAll&&e.querySelectorAll("iframe");t&&t.forEach(e=>this.attachToIframe(e))}})})}).observe(document.body,{childList:!0,subtree:!0})}setupConfluencePageChangeDetection(){console.log("üîç PAGE CHANGE: Setting up Confluence page change detection..."),window.AJS&&AJS.bind&&(AJS.bind("init.rte",()=>{console.log("üîÑ PAGE CHANGE: Confluence RTE initialized - re-setting up iframe listeners"),setTimeout(()=>this.refreshIframeListeners(),1e3)}),AJS.bind("rte-ready",()=>{console.log("üîÑ PAGE CHANGE: Confluence RTE ready - re-setting up iframe listeners"),setTimeout(()=>this.refreshIframeListeners(),1e3)}),AJS.bind("page.edit.ready",()=>{console.log("üîÑ PAGE CHANGE: Page edit ready - re-setting up iframe listeners"),setTimeout(()=>this.refreshIframeListeners(),1500)}),AJS.bind("page.view.ready",()=>{console.log("üîÑ PAGE CHANGE: Page view ready - re-setting up iframe listeners"),setTimeout(()=>this.refreshIframeListeners(),1e3)}));let e=window.location.href;setInterval(()=>{window.location.href!==e&&(console.log("üîÑ PAGE CHANGE: URL changed from",e,"to",window.location.href),e=window.location.href,setTimeout(()=>{console.log("üîÑ PAGE CHANGE: Re-setting up iframe listeners after URL change"),this.refreshIframeListeners()},2e3))},1e3),console.log("‚úÖ PAGE CHANGE: Confluence page change detection setup completed")}refreshIframeListeners(){const e=document.querySelectorAll("iframe");console.log("üîç IFRAME REFRESH: Found",e.length,"iframes"),0===e.length?(console.log("‚ö†Ô∏è IFRAME REFRESH: No iframes found on page"),console.log("‚ö†Ô∏è IFRAME REFRESH: Document ready state:",document.readyState),setTimeout(()=>{console.log("üîç IFRAME REFRESH: Retrying iframe search after delay...");const e=document.querySelectorAll("iframe");console.log("üîç IFRAME REFRESH: Retry found",e.length,"iframes"),e.length>0&&e.forEach((e,t)=>{console.log(`üîç IFRAME REFRESH RETRY ${t}: Processing iframe:`,e.src||e.id||"no-src"),this.attachToIframe(e,`refresh-retry-${t}`)})},1e3)):e.forEach((e,t)=>{console.log(`üîç IFRAME REFRESH ${t}: Processing iframe:`,e.src||e.id||"no-src"),this.attachToIframe(e,`refresh-${t}`)})}attachToExistingIframes(){this.refreshIframeListeners()}attachToIframe(e,t="new"){try{if("true"===e.dataset.textEditListenerAttached)return void console.log(`‚è≠Ô∏è Iframe ${t} already has listeners attached`);console.log(`üîç IFRAME ${t}: Attaching to iframe:`,e.src||e.id||e.className||"no-identifier");const o=()=>{try{var n;const r=e.contentDocument||(null===(n=e.contentWindow)||void 0===n?void 0:n.document);if(!r)return console.log(`‚ö†Ô∏è IFRAME ${t}: Cannot access iframe document (cross-origin or not loaded)`),!1;if(console.log(`‚úÖ IFRAME ${t}: Document accessible, ready state:`,r.readyState),console.log(`‚úÖ IFRAME ${t}: Document URL:`,r.URL),console.log(`‚úÖ IFRAME ${t}: Document body:`,!!r.body),!r.body)return console.log(`‚è≥ IFRAME ${t}: Body not ready, waiting...`),setTimeout(()=>o(),100),!1;console.log(`üéØ IFRAME ${t}: Attaching selection listeners to iframe document`);const a=e=>{console.log(`üñ±Ô∏è IFRAME ${t} MOUSEUP: Event fired in iframe`),this.handleTextSelection(e,r)},i=e=>{(e.shiftKey||e.ctrlKey)&&(console.log(`‚å®Ô∏è IFRAME ${t} KEYUP: Selection event fired in iframe`,e.key),this.handleTextSelection(e,r))};return r.textEditMouseupHandler&&r.removeEventListener("mouseup",r.textEditMouseupHandler,!0),r.textEditKeyupHandler&&r.removeEventListener("keyup",r.textEditKeyupHandler,!0),r.addEventListener("mouseup",a,!0),r.addEventListener("keyup",i,!0),r.textEditMouseupHandler=a,r.textEditKeyupHandler=i,r._textEditListenersAttached=!0,e.dataset.textEditListenerAttached="true",console.log(`‚úÖ IFRAME ${t}: Selection listeners attached successfully`),!0}catch(e){return console.log(`‚ùå IFRAME ${t}: Error accessing iframe content:`,e.message),!1}};e.textEditLoadHandler&&e.removeEventListener("load",e.textEditLoadHandler);const n=()=>{console.log(`üîç IFRAME ${t}: Iframe loaded, attaching listeners...`),setTimeout(o,100)};e.addEventListener("load",n),e.textEditLoadHandler=n,e.contentDocument&&"complete"===e.contentDocument.readyState?(console.log(`ÔøΩ IFRAME ${t}: Already loaded, attaching immediately`),n()):console.log(`‚è≥ IFRAME ${t}: Waiting for iframe to load...`)}catch(e){console.log(`‚ùå IFRAME ${t}: Error setting up iframe listener:`,e.message)}}handleTextSelection(e,t=document){const o=t===document?"main document":"iframe document";console.log(`üîç SELECTION: Handling text selection in ${o}`),setTimeout(()=>{try{const e=t===document?window.getSelection():t.getSelection();if(!e)return void console.log(`‚ö†Ô∏è SELECTION: No selection API available in ${o}`);const n=e.toString().trim();if(console.log(`üìù SELECTION: Selected text length: ${n.length} in ${o}`),n.length>0){console.log(`üìù SELECTION: Text selected: "${n.substring(0,50)}${n.length>50?"...":""}"`);const r=this.isInConfluenceEditMode();console.log("üìù SELECTION: Edit mode check result:",r),r?(console.log(`‚úÖ SELECTION: In edit mode, showing button for ${o} selection`),this.selectedText=n,this.selectedElement=e.getRangeAt(0),this.selectedDocument=t,this.showEditButton()):(console.log("‚ùå SELECTION: Not in edit mode, hiding button"),this.hideEditButton())}else console.log(`üìù SELECTION: No text selected in ${o}, hiding button`),this.hideEditButton()}catch(e){console.error(`‚ùå SELECTION: Error handling selection in ${o}:`,e)}},100)}isInConfluenceEditMode(){const e=[document.querySelector('iframe[id*="editor"]'),document.body.classList.contains("edit-mode"),document.querySelector(".confluence-editor-toolbar"),window.location.href.includes("/pages/editpage.action"),window.location.href.includes("/pages/resumedraft.action"),window.location.href.includes("mode=edit"),document.querySelector(".mce-tinymce"),document.querySelector('[data-testid="editor"]'),document.querySelector('[contenteditable="true"]'),document.querySelector(".ak-editor-content-area"),document.querySelector("#wysiwygTextarea_ifr"),window.parent!==window&&window.frameElement&&(window.frameElement.id.includes("editor")||window.frameElement.src.includes("editor"))].some(e=>e);return console.log("üîç Confluence edit mode check:",e),e}showEditButton(){this.hideEditButton(),this.editButton=document.createElement("button"),this.editButton.className="text-edit-button",this.editButton.innerHTML="‚úèÔ∏è Edit with AI",this.editButton.style.cssText="\n      position: absolute;\n      background: #0066cc;\n      color: white;\n      border: none;\n      border-radius: 4px;\n      padding: 6px 12px;\n      font-size: 12px;\n      cursor: pointer;\n      z-index: 10000;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n      transition: all 0.2s;\n    ";try{const e=this.selectedDocument||document,t=e===document?window.getSelection():e.getSelection();if(t.rangeCount>0){const e=t.getRangeAt(0).getBoundingClientRect();let o=e.left+e.width/2-60,n=e.bottom+5;const r=120,a=32;o+r>window.innerWidth&&(o=window.innerWidth-r-10),o<10&&(o=10),n+a>window.innerHeight&&(n=e.top-a-5),this.editButton.style.left=o+"px",this.editButton.style.top=n+"px",console.log("üìç Button positioned at:",{left:o,top:n,rect:e})}}catch(e){console.error("‚ùå Error positioning button:",e),this.editButton.style.left="50px",this.editButton.style.top="50px"}this.editButton.addEventListener("mouseenter",()=>{this.editButton.style.background="#0052a3",this.editButton.style.transform="scale(1.05)"}),this.editButton.addEventListener("mouseleave",()=>{this.editButton.style.background="#0066cc",this.editButton.style.transform="scale(1)"}),this.editButton.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.showEditPopup()}),document.body.appendChild(this.editButton)}hideEditButton(){this.editButton&&(this.editButton.remove(),this.editButton=null)}showEditPopup(){console.log("üîì SHOW: Attempting to show popup...");let e=document.getElementById("text-edit-ai-popup");if(!e&&(console.log("üîß SHOW: Popup not found, creating..."),this.createPopupUI(),e=document.getElementById("text-edit-ai-popup"),!e))return void console.error("‚ùå SHOW: Failed to create popup!");const t=document.getElementById("selected-text-display");t&&(t.textContent=this.selectedText);const o=document.getElementById("edit-prompt-input");o&&(o.value=""),e.style.display="flex",e.style.visibility="visible",e.style.left="50%",e.style.top="50%",e.style.transform="translate(-50%, -50%)",this.isPopupOpen=!0,console.log("‚úÖ SHOW: Popup shown successfully"),console.log("üîç SHOW: isPopupOpen =",this.isPopupOpen),setTimeout(()=>{o&&o.focus()},100),this.hideEditButton()}hideEditPopup(){console.log("üîí HIDE: Attempting to hide popup...");const e=document.getElementById("text-edit-ai-popup");e?(e.style.display="none",this.isPopupOpen=!1,console.log("‚úÖ HIDE: Popup hidden successfully")):console.error("‚ùå HIDE: Popup element not found!"),console.log("üîç HIDE: isPopupOpen =",this.isPopupOpen)}forceClosePopup(){console.log("üö® FORCE CLOSE: Emergency popup close...");const e=document.getElementById("text-edit-ai-root");e&&(e.remove(),console.log("üóëÔ∏è FORCE CLOSE: Root element removed")),this.isPopupOpen=!1,console.log("‚úÖ FORCE CLOSE: Popup force closed")}createPopupUI(){if(document.getElementById("text-edit-ai-root"))return void console.log("‚úÖ Popup already exists, skipping creation");console.log("üîß Creating popup UI...");const e=document.createElement("div");e.id="text-edit-ai-root",e.innerHTML='\n      <style>\n        .text-edit-ai-popup {\n          position: fixed;\n          top: 50%;\n          left: 50%;\n          transform: translate(-50%, -50%);\n          width: 600px;\n          max-width: 90vw;\n          background: white;\n          border-radius: 12px;\n          box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);\n          z-index: 10000;\n          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n          overflow: hidden;\n          border: none;\n          display: flex;\n          flex-direction: column;\n        }\n\n        .text-edit-ai-header {\n          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n          color: white;\n          padding: 16px 20px;\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          cursor: move;\n          user-select: none;\n        }\n\n        .text-edit-ai-header h3 {\n          margin: 0;\n          font-size: 16px;\n          font-weight: 600;\n          color: white;\n        }\n\n        .text-edit-ai-close {\n          background: none;\n          border: none;\n          color: white;\n          font-size: 24px;\n          cursor: pointer;\n          padding: 0;\n          width: 30px;\n          height: 30px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          border-radius: 50%;\n          transition: background-color 0.2s;\n        }\n\n        .text-edit-ai-close:hover {\n          background-color: rgba(255, 255, 255, 0.2);\n        }\n        .text-edit-ai-body {\n          flex: 1;\n          padding: 20px;\n          overflow-y: auto;\n          max-height: 70vh;\n        }\n\n        .selected-text-section {\n          margin-bottom: 20px;\n        }\n\n        .selected-text-display {\n          background: #f8f9fa;\n          border: 1px solid #e9ecef;\n          border-radius: 8px;\n          padding: 12px;\n          font-size: 14px;\n          line-height: 1.5;\n          color: #495057;\n          max-height: 120px;\n          overflow-y: auto;\n          white-space: pre-wrap;\n        }\n\n        .prompt-section {\n          margin-bottom: 20px;\n        }\n\n        .prompt-section label {\n          display: block;\n          margin-bottom: 8px;\n          font-weight: 600;\n          color: #495057;\n          font-size: 14px;\n        }\n        .edit-prompt-input {\n          width: 100%;\n          padding: 12px;\n          border: 2px solid #e9ecef;\n          border-radius: 8px;\n          font-size: 14px;\n          font-family: inherit;\n          resize: vertical;\n          min-height: 80px;\n          transition: border-color 0.2s;\n          box-sizing: border-box;\n        }\n\n        .edit-prompt-input:focus {\n          outline: none;\n          border-color: #667eea;\n          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);\n        }\n\n        .quick-actions {\n          display: flex;\n          flex-wrap: wrap;\n          gap: 8px;\n          margin-bottom: 20px;\n        }\n\n        .quick-action-btn {\n          background: #f8f9fa;\n          border: 1px solid #e9ecef;\n          border-radius: 6px;\n          padding: 6px 12px;\n          font-size: 12px;\n          cursor: pointer;\n          transition: all 0.2s;\n          color: #495057;\n        }\n\n        .quick-action-btn:hover {\n          background: #e9ecef;\n          border-color: #667eea;\n          color: #667eea;\n        }\n\n        .edit-actions {\n          display: flex;\n          justify-content: flex-end;\n          gap: 12px;\n          padding-top: 20px;\n          border-top: 1px solid #e9ecef;\n        }\n\n        .edit-cancel-btn {\n          background: #6c757d;\n          color: white;\n          border: none;\n          border-radius: 6px;\n          padding: 10px 20px;\n          cursor: pointer;\n          font-size: 14px;\n          transition: background-color 0.2s;\n        }\n\n        .edit-cancel-btn:hover {\n          background: #5a6268;\n        }\n\n        .edit-send-btn {\n          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n          color: white;\n          border: none;\n          border-radius: 6px;\n          padding: 10px 20px;\n          cursor: pointer;\n          font-size: 14px;\n          font-weight: 600;\n          transition: all 0.2s;\n        }\n\n        .edit-send-btn:hover:not(:disabled) {\n          transform: translateY(-1px);\n          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);\n        }\n\n        .edit-send-btn:disabled {\n          background: #6c757d;\n          cursor: not-allowed;\n          transform: none;\n        }\n      </style>\n\n      <div id="text-edit-ai-popup" class="text-edit-ai-popup" style="display: none;">\n        <div class="text-edit-ai-header">\n          <h3>‚úèÔ∏è Edit Text with AI</h3>\n          <button class="text-edit-ai-close">&times;</button>\n        </div>\n        <div class="text-edit-ai-body">\n          <div class="selected-text-section">\n            <div id="selected-text-display" class="selected-text-display"></div>\n          </div>\n\n          <div class="prompt-section">\n            <label for="edit-prompt-input">How would you like to edit this text?</label>\n            <textarea\n              id="edit-prompt-input"\n              class="edit-prompt-input"\n              placeholder="Enter your editing instructions..."\n              rows="3"\n            ></textarea>\n          </div>\n\n          <div class="edit-actions">\n            <button id="edit-cancel-btn" class="edit-cancel-btn">Cancel</button>\n            <button id="edit-send-btn" class="edit-send-btn">Send</button>\n          </div>\n        </div>\n      </div>\n    ',document.body.appendChild(e),this.bindPopupEvents()}bindPopupEvents(){const e=document.getElementById("text-edit-ai-popup"),t=e.querySelector(".text-edit-ai-header"),o=e.querySelector(".text-edit-ai-close"),n=document.getElementById("edit-cancel-btn"),r=document.getElementById("edit-send-btn"),a=document.getElementById("edit-prompt-input");e._textEditEventsBound?console.log("üîó BIND: Events already bound, skipping..."):(console.log("üîó BIND: Binding popup events..."),console.log("üîó BIND: Elements found:",{popup:!!e,header:!!t,closeBtn:!!o,cancelBtn:!!n,sendBtn:!!r,promptInput:!!a}),this.makeDraggable(e,t),o.addEventListener("click",e=>{console.log("‚ùå CLOSE: Close button clicked"),e.preventDefault(),e.stopPropagation(),this.hideEditPopup()}),n.addEventListener("click",e=>{console.log("‚ùå CANCEL: Cancel button clicked"),e.preventDefault(),e.stopPropagation(),this.hideEditPopup()}),r.addEventListener("click",()=>{this.handleSendEdit()}),a.addEventListener("keydown",e=>{"Enter"!==e.key||e.ctrlKey||e.shiftKey||(e.preventDefault(),this.handleSendEdit())}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isPopupOpen&&(console.log("‚å®Ô∏è ESC: Escape key pressed, closing popup"),e.preventDefault(),e.stopPropagation(),this.hideEditPopup())}),setTimeout(()=>{document.addEventListener("click",t=>{this.isPopupOpen&&(t.target.closest(".text-edit-button")||e.contains(t.target)||(console.log("üñ±Ô∏è Click outside popup detected, closing..."),this.hideEditPopup()))},!0)},300),e._textEditEventsBound=!0,console.log("‚úÖ BIND: All events bound successfully"))}async handleSendEdit(){const e=document.getElementById("edit-prompt-input"),t=document.getElementById("edit-send-btn"),o=e.value.trim();if(o){t.disabled=!0,t.textContent="ü§î Processing...";try{const e=this.getSelectedHtmlContent(),t=await this.callEditAPI(e,this.selectedText,o);this.replaceSelectedHtmlContent(t),this.showNotification("Text edited successfully!","success"),this.hideEditPopup()}catch(e){console.error("‚ùå Edit API error:",e),alert(`‚ùå Error editing text: ${e.message}`)}finally{t.disabled=!1,t.textContent="Send"}}else alert("Please enter your editing instructions!")}async callEditAPI(e,t,o){console.log("ü§ñ Calling Text Edit API...",{htmlContent:e,selectedText:t,prompt:o});try{const n=await fetch(API_URLS.EDIT_HTML_CONTENT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({html_content:e,selected_text:t,prompt:o})});if(!n.ok){const e=await n.json().catch(()=>({}));throw new Error(e.error||`HTTP ${n.status}: ${n.statusText}`)}return await n.text()}catch(e){throw console.error("‚ùå Text Edit API error:",e),new Error(`Failed to process text edit request: ${e.message}`)}}getSelectedHtmlContent(){try{const e=this.selectedDocument||document,t=e===document?window.getSelection():e.getSelection();if(t.rangeCount>0){const e=t.getRangeAt(0),o=e.commonAncestorContainer;let n=o.nodeType===Node.TEXT_NODE?o.parentElement:o;for(;n&&("BODY"===n.tagName||"HTML"===n.tagName||"DIV"===n.tagName&&!n.className)&&1===n.children.length;)n=n.children[0];const r=n?n.outerHTML:e.toString();return console.log("üìÑ Selected HTML content:",r),r}return this.selectedText}catch(e){return console.error("‚ùå Error getting HTML content:",e),this.selectedText}}replaceSelectedHtmlContent(e){try{const t=this.selectedDocument||document,o=t===document?window.getSelection():t.getSelection();if(console.log("üîÑ Replacing HTML content in:",t===document?"main document":"iframe document"),console.log("üîÑ New HTML content:",e),!(o.rangeCount>0))throw new Error("No selection range found");{const n=o.getRangeAt(0).commonAncestorContainer;let r=n.nodeType===Node.TEXT_NODE?n.parentElement:n;for(;r&&("BODY"===r.tagName||"HTML"===r.tagName||"DIV"===r.tagName&&!r.className)&&1===r.children.length;)r=r.children[0];if(!r||r===t.body)return void this.replaceSelectedText(e);{const o=t.createElement("div");if(o.innerHTML=e,1===o.children.length)r.parentNode.replaceChild(o.firstElementChild,r);else{const e=t.createDocumentFragment();for(;o.firstChild;)e.appendChild(o.firstChild);r.parentNode.replaceChild(e,r)}}o.removeAllRanges(),console.log("‚úÖ HTML content replaced successfully")}}catch(t){console.error("‚ùå Error replacing HTML content:",t),this.replaceSelectedText(e)}}replaceSelectedText(e){try{const t=this.selectedDocument||document,o=t===document?window.getSelection():t.getSelection();if(console.log("üîÑ Replacing content in:",t===document?"main document":"iframe document"),console.log("üîÑ New content type:",this.isHTML(e)?"HTML":"Text"),!(o.rangeCount>0))throw new Error("No selection range found");{const n=o.getRangeAt(0);if(n.deleteContents(),this.isHTML(e)){console.log("üìù Inserting HTML content");const o=t.createElement("div");o.innerHTML=e;const r=t.createDocumentFragment();for(;o.firstChild;)r.appendChild(o.firstChild);n.insertNode(r)}else console.log("üìù Inserting plain text content"),n.insertNode(t.createTextNode(e));o.removeAllRanges(),console.log("‚úÖ Content replaced successfully")}}catch(t){console.error("‚ùå Error replacing content:",t),navigator.clipboard.writeText(e).then(()=>{alert("Could not replace content directly. The edited content has been copied to clipboard.")}).catch(()=>{alert(`Could not replace content or copy to clipboard. Here's the edited content:\n\n${e}`)})}}isHTML(e){return/<[^>]*>/.test(e)}showNotification(e,t="info"){const o=document.createElement("div");o.style.cssText=`\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: ${"success"===t?"#28a745":"error"===t?"#dc3545":"#007bff"};\n      color: white;\n      padding: 12px 20px;\n      border-radius: 8px;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);\n      z-index: 10002;\n      font-size: 14px;\n      max-width: 300px;\n      opacity: 0;\n      transform: translateX(100%);\n      transition: all 0.3s;\n    `,o.textContent=e,document.body.appendChild(o),setTimeout(()=>{o.style.opacity="1",o.style.transform="translateX(0)"},100),setTimeout(()=>{o.style.opacity="0",o.style.transform="translateX(100%)",setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},300)},3e3)}makeDraggable(e,t){let o=!1,n=0,r=0,a=0,i=0;console.log("üéØ DRAG: Setting up draggable element..."),t.style.cursor="move",t.style.userSelect="none";const s=t=>{if(!o)return;t.preventDefault(),t.stopPropagation();const s=t.clientX-n,l=t.clientY-r,c=a+s,d=i+l,m=e.getBoundingClientRect(),g=window.innerWidth-m.width,u=window.innerHeight-m.height,p=Math.max(0,Math.min(c,g)),h=Math.max(0,Math.min(d,u));e.style.left=p+"px",e.style.top=h+"px",e.style.transform="none"},l=e=>{o&&(e.preventDefault(),e.stopPropagation(),o=!1,console.log("üéØ DRAG: Stopped"),document.removeEventListener("mousemove",s,!0),document.removeEventListener("mouseup",l,!0),document.body.style.userSelect="",e.stopPropagation())};t.addEventListener("mousedown",t=>{t.target.classList.contains("text-edit-ai-close")||(t.preventDefault(),t.stopPropagation(),o=!0,n=t.clientX,r=t.clientY,a=parseInt(e.style.left)||0,i=parseInt(e.style.top)||0,console.log("üéØ DRAG: Started",{mouseX:n,mouseY:r,elementX:a,elementY:i}),document.addEventListener("mousemove",s,!0),document.addEventListener("mouseup",l,!0),document.body.style.userSelect="none")}),console.log("‚úÖ DRAG: Setup completed")}}class KToolContent{constructor(){this.settings={},this.isModalOpen=!1,this.currentTab="generate",this.generationJob=null,this.progressSteps=[...PROGRESS_STEPS],this.confluenceEditor=null,this.mermaidAIChat=null,this.textEditAI=null,this.storageManager=new StorageManager,this.init()}async init(){if(!document.getElementById("ktool-root")){await this.loadSettings(),this.injectUI(),this.bindEvents();try{this.confluenceEditor=new ConfluenceEditor}catch(e){console.error("‚ùå Error initializing ConfluenceEditor:",e),this.confluenceEditor=null}try{const e=window.jQuery||window.$||null;this.mermaidAIChat=new MermaidAIChat(e)}catch(e){console.error("‚ùå Error initializing MermaidAIChat:",e),this.mermaidAIChat=null}try{this.textEditAI=new TextEditAI}catch(e){console.error("‚ùå Error initializing TextEditAI:",e),this.textEditAI=null}}}async loadSettings(){try{this.settings=await StorageManager.getSettings()}catch(e){console.error("‚ùå Error loading settings:",e)}}injectUI(){const e=document.createElement("div");e.id="ktool-root",document.body.appendChild(e);const t=this.createBubble();e.appendChild(t);const o=this.createModal();e.appendChild(o)}createBubble(){const e=document.createElement("div");return e.className="ktool-bubble "+(this.settings.isEnabled?"":"disabled"),e.innerHTML=`\n      <div class="ktool-bubble-icon">K</div>\n      <div class="ktool-tooltip">\n        ${this.settings.isEnabled?"üöÄ K-Tool Document Generator<br/>Click to open document generation tool":"‚ö†Ô∏è K-Tool is disabled<br/>Please enable in settings"}\n      </div>\n    `,e.addEventListener("click",()=>{this.settings.isEnabled?this.openModal():this.showNotification("K-Tool is disabled. Please enable in extension settings.","warning")}),e}createModal(){const e=document.createElement("div");return e.className="ktool-modal-overlay",e.innerHTML=`\n      <div class="ktool-modal">\n        <div class="ktool-modal-header">\n          <h2 class="ktool-modal-title">K-Tool Document Generator</h2>\n          <button class="ktool-modal-close" type="button">&times;</button>\n        </div>\n        <div class="ktool-modal-body">\n          <div class="ktool-tabs">\n            <button class="ktool-tab active" data-tab="generate">üìÑ Generate Document</button>\n            <button class="ktool-tab" data-tab="preview">üëÅÔ∏è Preview</button>\n            <button class="ktool-tab" data-tab="settings">‚öôÔ∏è Settings</button>\n          </div>\n\n          \x3c!-- Generate Tab --\x3e\n          <div class="ktool-tab-content active" data-tab="generate">\n            ${this.createGenerateTab()}\n          </div>\n\n          \x3c!-- Preview Tab --\x3e\n          <div class="ktool-tab-content" data-tab="preview" id="previewTab">\n            ${this.createPreviewTab()}\n          </div>\n\n          \x3c!-- Settings Tab --\x3e\n          <div class="ktool-tab-content" data-tab="settings">\n            ${this.createSettingsTab()}\n          </div>\n        </div>\n      </div>\n    `,e}createGenerateTab(){return`\n      <div class="ktool-form">\n        <div class="ktool-form-group">\n          <label class="ktool-form-label">BA Document URL *</label>\n          <input\n            type="url"\n            class="ktool-form-input"\n            id="baDocUrl"\n            placeholder="https://confluence.com/pages/123456"\n            value="${window.location.href}"\n          >\n        </div>\n\n        <div class="ktool-form-group">\n          <label class="ktool-form-label">Additional Notes (Optional)</label>\n          <textarea\n            class="ktool-form-textarea"\n            id="additionalNotes"\n            placeholder="Add notes or special requirements..."\n            rows="3"\n          ></textarea>\n        </div>\n\n        <div style="display: flex; gap: 12px; margin-top: 20px;">\n          <button class="ktool-btn ktool-btn-primary" id="generateBtn">\n            üîß Generate Document\n          </button>\n          <button class="ktool-btn ktool-btn-secondary" id="resetBtn">\n            üîÑ Reset\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Progress Section --\x3e\n      <div class="ktool-progress" id="progressSection" style="display: none;">\n        <h3 style="margin: 0 0 16px 0; font-size: 16px;">Document Generation Progress:</h3>\n        <div id="progressSteps"></div>\n      </div>\n    `}createPreviewTab(){return'\n      <div class="ktool-form">\n        <div style="text-align: center; padding: 40px; color: #6c757d;">\n          <div style="font-size: 48px; margin-bottom: 16px;">üìÑ</div>\n          <h3 style="margin: 0 0 8px 0;">No content available for preview</h3>\n          <p style="margin: 0;">Please generate document first to preview.</p>\n        </div>\n      </div>\n    '}createSettingsTab(){return'\n      <div class="ktool-form">\n        <div style="text-align: center; padding: 40px; color: #6c757d;">\n          <div style="font-size: 48px; margin-bottom: 16px;">‚öôÔ∏è</div>\n          <h3 style="margin: 0 0 8px 0;">Extension Settings</h3>\n          <p style="margin: 0 0 16px 0;">Click the button below to open settings popup.</p>\n          <button class="ktool-btn ktool-btn-primary" id="openSettingsBtn">\n            üîß Open Settings\n          </button>\n        </div>\n      </div>\n    '}bindEvents(){const e=document.querySelector(".ktool-modal-overlay");e.querySelector(".ktool-modal-close").addEventListener("click",()=>{this.closeModal()}),e.addEventListener("click",t=>{t.target===e&&this.closeModal()}),e.querySelectorAll(".ktool-tab").forEach(e=>{e.addEventListener("click",()=>{this.switchTab(e.dataset.tab)})}),e.querySelector("#generateBtn").addEventListener("click",()=>{this.handleGenerate()}),e.querySelector("#resetBtn").addEventListener("click",()=>{this.handleReset()}),this.addSettingsButtonListener(),chrome.runtime.onMessage.addListener(e=>{"settingsChanged"===e.action&&(this.settings=e.settings,this.updateBubbleState())}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isModalOpen&&this.closeModal(),!e.ctrlKey&&!e.metaKey||"k"!==e.key||this.isModalOpen||(e.preventDefault(),this.settings.isEnabled&&this.openModal())})}openModal(){const e=document.querySelector(".ktool-modal-overlay");e.classList.add("show"),this.isModalOpen=!0,setTimeout(()=>{const t=e.querySelector(".ktool-form-input");t&&t.focus()},300)}closeModal(){document.querySelector(".ktool-modal-overlay").classList.remove("show"),this.isModalOpen=!1}addSettingsButtonListener(){setTimeout(()=>{const e=document.querySelector("#openSettingsBtn");e&&e.addEventListener("click",()=>{this.openSettingsPopup()})},100)}openSettingsPopup(){var e,t,o,n;chrome.runtime&&chrome.runtime.openOptionsPage?chrome.runtime.openOptionsPage():(null===(e=chrome.action)||void 0===e||null===(t=e.openPopup)||void 0===t?void 0:t.call(e))||(null===(o=chrome.browserAction)||void 0===o||null===(n=o.openPopup)||void 0===n?void 0:n.call(o))||alert("Please click the K-Tool icon in the browser toolbar to open settings.")}switchTab(e){document.querySelectorAll(".ktool-tab").forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)}),document.querySelectorAll(".ktool-tab-content").forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)}),this.currentTab=e}updateBubbleState(){const e=document.querySelector(".ktool-bubble"),t=e.querySelector(".ktool-tooltip");this.settings.isEnabled?(e.classList.remove("disabled"),t.innerHTML="üöÄ K-Tool Document Generator<br/>Click to open document generation tool"):(e.classList.add("disabled"),t.innerHTML="‚ö†Ô∏è K-Tool is disabled<br/>Please enable in settings")}async handleGenerate(){try{await this.storageManager.clearAllKToolData()}catch(e){console.warn("‚ö†Ô∏è Failed to clear previous localStorage data:",e)}const e=document.getElementById("baDocUrl").value.trim(),t=document.getElementById("additionalNotes").value.trim();if(e){if(!StorageManager.validateSettings(this.settings).isValid)return this.showNotification("Please configure all settings before generating document!","error"),void this.switchTab("settings");try{this.showProgress(),this.updateProgress(0,"active");const o=ConfluenceApi.extractPageId(e);if(!o)throw new Error("‚ùå Invalid URL! Please check the Confluence page URL.");const n=await ConfluenceApi.fetchPageContent(o);if(!n)throw new Error("‚ùå Cannot fetch BA document content!");const r=await ConfluenceApi.extractImagesFromHtml(n.content);if(this.updateProgress(0,"completed"),this.updateProgress(1,"active"),!this.settings.urlTemplate)throw new Error("‚ö†Ô∏è Please configure document template in settings!");const a=await ConfluenceApi.cloneTemplateForGeneration(this.settings.urlTemplate);if(!a)throw new Error("‚ùå Cannot clone template! Please check template URL in Settings.");this.updateProgress(1,"completed"),this.updateProgress(2,"active");const i=ConfluenceApi.extractPlaceholders(a.originalStorageFormat);if(0===i.length)throw new Error("‚ö†Ô∏è No placeholders found in format <<Name>>. Please check template!");this.updateProgress(2,"completed"),this.updateProgress(3,"active");let s="";if(this.settings.instructionUrl){const e=ConfluenceApi.extractPageId(this.settings.instructionUrl);if(e){const t=await ConfluenceApi.fetchPageContent(e);s=(null==t?void 0:t.content)||""}else console.warn("‚ö†Ô∏è Invalid instruction URL:",this.settings.instructionUrl)}const l={ba_content:n.content,template_structure:a.templateStructure,original_storage_format:a.originalStorageFormat,instructions:s,additional_prompt:this.settings.customPrompt||"",placeholders:i,selectedModel:this.settings.selectedModel,images:r,additional_notes:t};console.log("üì§ Sending payload for placeholder filling:",{ba_content_length:l.ba_content.length,template_structure_length:l.template_structure.length,original_format_length:l.original_storage_format.length,placeholders_found:i.length,placeholders_list:i});const c=await ApiClient.generateDocument(l),d=c.data.job_id;if(!d)throw new Error(c.error||"No job_id received from server!");this.currentJobId=d,await this.pollGenerationResult(d,l)}catch(e){console.error("‚ùå Generation error:",e),this.showNotification(`Document generation error: ${e.message}`,"error"),this.hideProgress()}}else this.showNotification("Please enter BA document URL!","error")}async pollGenerationResult(e){let t=0;const o=async()=>{t++;try{console.log(`üîÑ Polling attempt ${t}/40 for job ${e}`);const n=await ApiClient.checkStatus(e);if(console.log(`statusResult: ${n}`),!n.success)throw new Error("Error checking job status");const r=n.data.status;if("done"===r){const t=await ApiClient.getResult(e),o=JSON.stringify(t,null,2);if(console.log(`Document generate:\n${o}`),t.success)return void this.handleGenerationComplete(t.data.result);throw new Error("Error getting document generation result")}if("error"===r)throw new Error("Document generation job failed on server");if(t>=40)throw new Error("‚è∞ Timeout: Document generation is taking too long. Please try again.");n.data.progress_message&&console.log(`üìù Progress: ${n.data.progress_message}`),setTimeout(o,1e4)}catch(e){throw console.error("‚ùå Polling error:",e),this.showNotification(`Error during document generation: ${e.message}`,"error"),this.hideProgress(),this.currentJobId=null,e}};await o()}async handleGenerationComplete(e){this.updateProgress(3,"completed"),this.updateProgress(4,"completed"),this.generatedContent=e;try{this.storageManager.saveToLocalStorage(e)}catch(e){console.error("‚ùå Failed to save generated content to backup:",e)}try{await this.initializeMermaidDiagramMappings(e)}catch(e){console.error("‚ùå Failed to process Mermaid diagrams:",e)}this.switchTab("preview"),this.updatePreviewTab(e),this.showNotification("Document generated successfully!","success"),this.hideProgress()}updatePreviewTab(e){const t=document.getElementById("previewTab");let o=e.full_storage_format||"<p>No content available</p>";"<p>No content available</p>"!==o&&(o=XMLFormatter.cleanXMLMarkers(o)),t.innerHTML=`\n      <div class="ktool-form">\n        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">\n          <h3 style="margin: 0;">Document Preview</h3>\n          <div style="display: flex; gap: 12px;">\n            <button class="ktool-btn ktool-btn-secondary" id="editContentBtn">\n              ‚úèÔ∏è Edit Content\n            </button>\n            <button class="ktool-btn ktool-btn-primary" id="createPageBtn">\n              üìÑ Create Confluence Page\n            </button>\n          </div>\n        </div>\n\n        <div id="documentPreview" style="border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; background: #f8f9fa; max-height: 400px; overflow-y: auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6;">\n          ${o}\n        </div>\n      </div>\n    `,t.querySelector("#editContentBtn").addEventListener("click",()=>this.handleEditContent(e)),createPageBtn.addEventListener("click",()=>this.handleCreatePage()),setTimeout(()=>{this.initializeMermaid()},100)}normalizeConfluenceHtml(e){if(!e||"string"!=typeof e)return"";let t=e;return t=t.replace(/<colgroup[^>]*>[\s\S]*?<\/colgroup>/gi,""),t=t.replace(/<colgroup[^>]*\/>/gi,""),t=t.replace(/<col[^>]*\/>/gi,""),t.trim()}async handleCreatePage(){const e=document.querySelector("#createPageBtn");if(!e)return;const t=e.innerHTML,o=e.disabled;try{var n;e.innerHTML="‚è≥ Creating Page...",e.disabled=!0,e.style.opacity="0.7";const r=ConfluenceApi.getCurrentSpaceKey();if(!r)throw new Error("Cannot determine space key of current page");const a=`K-Tool Generated Document - ${(new Date).toLocaleDateString()}`,i=this.storageManager.loadFromLocalStorage();let s=(null==i?void 0:i.full_storage_format)||(null==i?void 0:i.content);s||(s=this.generatedContent.full_storage_format||this.generatedContent.content,console.warn("‚ö†Ô∏è No backup content found, using generated content")),s=await this.replaceMermaidImagesWithOriginalCode(s),console.warn("Content after replace:",null===(n=s)||void 0===n?void 0:n.substring(0,500)),e.innerHTML="üîÑ Converting to XHTML...",s=this.normalizeConfluenceHtml(s);let l=null;this.settings.documentUrl&&(l=ConfluenceApi.extractPageId(this.settings.documentUrl)),e.innerHTML="üìÑ Creating Confluence Page...",await ConfluenceApi.createPage(a,s,r,l),e.innerHTML="‚úÖ Page Created Successfully!",e.style.background="#28a745",this.showNotification("Confluence page created successfully!","success"),setTimeout(()=>{e.innerHTML=t,e.disabled=o,e.style.opacity="1",e.style.background=""},1e3)}catch(n){console.error("‚ùå Create page error:",n),e.innerHTML="‚ùå Creation Failed",e.style.background="#dc3545",this.showNotification(`Error creating page: ${n.message}`,"error"),setTimeout(()=>{e.innerHTML=t,e.disabled=o,e.style.opacity="1",e.style.background=""},2e3)}}async initializeMermaidDiagramMappings(e){try{const t=e.full_storage_format||e.content||"";if(!t)return;t.length>1e3&&console.log("üîç Extended content preview:",t.substring(0,2e3));const{diagrams:o}=mermaidRenderer.Z.extractMermaidDiagrams(t);if(console.warn("üîç Extracted diagrams:",o),0===o.length)return void this.storageManager.saveMermaidDiagramMappings(new Map);console.log(`üìä Found ${o.length} Mermaid diagrams in generated content`);const n=new Map;for(const e of o)n.set(e.id,{title:`Diagram ${e.id}`,type:e.type,content:e.code,originCode:e.originalMatch,timestamp:Date.now()}),console.log(`üìã Created mapping for diagram ${e.id}:`,{codeLength:e.code.length,originalLength:e.originalMatch.length});this.storageManager.saveMermaidDiagramMappings(n)?console.log(`üíæ Successfully saved ${n.size} diagram mappings`):console.warn("‚ö†Ô∏è Failed to save diagram mappings")}catch(e){console.error("‚ùå Error initializing Mermaid diagram mappings:",e)}}async replaceMermaidImagesWithOriginalCode(e){try{const t=this.storageManager.getMermaidDiagramMappings();if(!t||0===t.size)return e;console.log(`üìä Found ${t.size} committed diagram mappings in storage`);let o=e,n=0;for(const[e,r]of t.entries()){console.log(`üîÑ Processing diagram ${e}`);const t=r.originCode||r.originalCode||r.content;console.log(`üîÑ Processing diagram ${e}:`,{hasOriginCode:!!r.originCode,hasOriginalCode:!!r.originalCode,hasContent:!!r.content,usingOriginCode:!!r.originCode,replacementCodePreview:(null==t?void 0:t.substring(0,100))+"..."});const a=[new RegExp(`<img[^>]*\\sid="${e}"[^>]*>`,"gi"),new RegExp(`<img[^>]*\\sdata-mermaid-id="${e}"[^>]*>`,"gi"),new RegExp(`<img[^>]*(?:id="${e}"|data-mermaid-id="${e}")[^>]*>`,"gi")];let i=!1;for(const r of a){const a=o.match(r);if(a&&a.length>0){console.log(`üîç Found ${a.length} image(s) for diagram ${e} with pattern`),o=o.replace(r,t),n+=a.length,i=!0,console.log(`‚úÖ Replaced ${a.length} image(s) for diagram ${e} with original Mermaid code`);break}}i||console.log(`‚ÑπÔ∏è No images found for diagram ${e}`)}return console.log(`üé® Completed Mermaid image replacement: ${n} images replaced`),o}catch(t){return console.error("‚ùå Error replacing Mermaid images:",t),e}}handleEditContent(e){if(!this.confluenceEditor)return console.error("‚ùå ConfluenceEditor is null or undefined"),void this.showNotification("Confluence Editor not initialized!","error");try{this.confluenceEditor.setSaveCallback(e=>{var t,o,n,r;console.log("üíæ Save callback received content:",{length:(null==e||null===(t=e.full_storage_format)||void 0===t?void 0:t.length)||0,preview:(null==e||null===(o=e.full_storage_format)||void 0===o?void 0:o.substring(0,200))||"empty",hasContent:!(null==e||!e.full_storage_format)}),this.generatedContent=e,console.log("üíæ Updated this.generatedContent:",{length:(null===(n=this.generatedContent)||void 0===n||null===(n=n.full_storage_format)||void 0===n?void 0:n.length)||0,preview:(null===(r=this.generatedContent)||void 0===r||null===(r=r.full_storage_format)||void 0===r?void 0:r.substring(0,200))||"empty"}),this.updatePreviewTab(e),this.showNotification("Content has been updated!","success")}),this.confluenceEditor.openEditor(e,{title:"Edit Generated Document",showMermaidTools:!0})}catch(e){console.error("‚ùå Error opening ConfluenceEditor:",e),this.showNotification(`Error opening editor: ${e.message}`,"error")}}handleReset(){document.getElementById("baDocUrl").value=window.location.href,document.getElementById("additionalNotes").value="",this.hideProgress(),this.switchTab("generate")}showProgress(){const e=document.getElementById("progressSection");document.getElementById("progressSteps").innerHTML=this.progressSteps.map((e,t)=>`\n      <div class="ktool-progress-step ${e.status}" data-step="${t}">\n        <div class="ktool-progress-icon">${t+1}</div>\n        <span>${e.label}</span>\n      </div>\n    `).join(""),e.style.display="block"}hideProgress(){document.getElementById("progressSection").style.display="none",this.progressSteps=this.progressSteps.map(e=>({...e,status:"pending"}))}updateProgress(e,t){this.progressSteps[e].status=t;const o=document.querySelector(`[data-step="${e}"]`);if(o){o.className=`ktool-progress-step ${t}`;const e=o.querySelector(".ktool-progress-icon");"completed"===t?e.textContent="‚úì":"error"===t?e.textContent="‚úó":"active"===t&&(e.innerHTML='<div class="ktool-spinning">‚è≥</div>')}}showNotification(e,t="info"){const o=document.createElement("div");o.style.cssText=`\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: ${"success"===t?"#28a745":"error"===t?"#dc3545":"#007bff"};\n      color: white;\n      padding: 12px 20px;\n      border-radius: 8px;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);\n      z-index: 1000002;\n      font-size: 14px;\n      max-width: 300px;\n      word-wrap: break-word;\n      opacity: 0;\n      transform: translateX(100%);\n      transition: all 0.3s;\n    `,o.textContent=e,document.body.appendChild(o),setTimeout(()=>{o.style.opacity="1",o.style.transform="translateX(0)"},100),setTimeout(()=>{o.style.opacity="0",o.style.transform="translateX(100%)",setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},300)},5e3)}async initializeMermaid(){try{const e=document.getElementById("documentPreview");if(!e)return;const t=e.querySelectorAll('ac\\:structured-macro[ac\\:name="mermaid"]');for(let e=0;e<t.length;e++){const o=t[e],n=o.querySelector('ac\\:parameter[ac\\:name="code"]');if(!n)return void console.warn("‚ö†Ô∏è Mermaid macro found but no code parameter");const r=(n.textContent||n.innerText).trim();if(console.log("üîç Found Confluence Mermaid diagram:",r.substring(0,50)+"..."),r){const t=document.createElement("div");if(t.className="mermaid-diagram",t.id=`mermaid-${e}`,t.style.cssText="margin: 20px 0; text-align: center; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;",!o.parentNode)return console.error("‚ùå Cannot replace Mermaid element: no parent node"),void console.error("‚ùå Mermaid code:",r.substring(0,100)+"...");try{o.parentNode.replaceChild(t,o)}catch(e){return console.error("‚ùå Failed to replace Mermaid element:",e),void console.error("‚ùå Mermaid code:",r.substring(0,100)+"...")}await mermaidRenderer.Z.initializeMermaid();const n=`mermaid-svg-${e}`;await mermaidRenderer.Z.renderDiagram(n,r,t)}}}catch(e){console.error("‚ùå Failed to initialize Mermaid:",e)}}showMermaidError(e,t,o){if(!e||!e.nodeType||e.nodeType!==Node.ELEMENT_NODE)return console.error("‚ùå Invalid container for Mermaid error display:",e),void console.error("‚ùå Mermaid error details:",{message:o.message||"Unknown error occurred",code:t?t.substring(0,100)+"...":"No code provided"});if(!document.contains(e))return console.error("‚ùå Container is not in DOM, cannot display Mermaid error"),void console.error("‚ùå Mermaid error details:",{message:o.message||"Unknown error occurred",code:t?t.substring(0,100)+"...":"No code provided"});try{e.innerHTML=`\n        <div style="color: #dc3545; padding: 15px; background: #f8d7da; border-radius: 8px; border: 1px solid #f5c6cb; font-family: Arial, sans-serif;">\n          <div style="font-weight: bold; margin-bottom: 8px; display: flex; align-items: center;">\n            <span style="margin-right: 8px;">‚ö†Ô∏è</span>\n            Mermaid Render Error\n          </div>\n          <div style="font-size: 12px; color: #721c24; margin-bottom: 10px;">\n            ${o.message||"Unknown error occurred"}\n          </div>\n          <details style="margin-top: 10px;">\n            <summary style="cursor: pointer; font-size: 12px; color: #495057;">Show diagram code</summary>\n            <pre style="margin: 8px 0 0 0; padding: 8px; background: #fff; border: 1px solid #dee2e6; border-radius: 4px; font-size: 11px; overflow-x: auto; white-space: pre-wrap;">${t||"No code provided"}</pre>\n          </details>\n        </div>\n      `}catch(e){console.error("‚ùå Failed to set error HTML in container:",e),console.error("‚ùå Original Mermaid error:",{message:o.message||"Unknown error occurred",code:t?t.substring(0,100)+"...":"No code provided"})}}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new KToolContent}):new KToolContent;
//# sourceMappingURL=content.js.map